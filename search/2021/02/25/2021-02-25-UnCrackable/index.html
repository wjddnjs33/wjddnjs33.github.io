<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="UnCrackable Level 1 앱을 실행하면 루팅 탐지가 되었다는 팝업이 뜨는 것을 볼 수 있습니다. 123456789101112131415161718public class MainActivity extends Activity &amp;#123;    private void a(String str) &amp;#123;        AlertDialog create">
<meta property="og:type" content="article">
<meta property="og:title" content="UnCrackable Wrtie Up">
<meta property="og:url" content="http://example.com/2021/02/25/2021-02-25-UnCrackable/index.html">
<meta property="og:site_name" content="Home">
<meta property="og:description" content="UnCrackable Level 1 앱을 실행하면 루팅 탐지가 되었다는 팝업이 뜨는 것을 볼 수 있습니다. 123456789101112131415161718public class MainActivity extends Activity &amp;#123;    private void a(String str) &amp;#123;        AlertDialog create">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://github.com/wjddnjs33/image/blob/main/UnCrackable/Level1/1.png?raw=true">
<meta property="og:image" content="https://github.com/wjddnjs33/image/blob/main/UnCrackable/Level1/2.png?raw=true">
<meta property="og:image" content="https://github.com/wjddnjs33/image/blob/main/UnCrackable/Level1/3.png?raw=true">
<meta property="og:image" content="https://github.com/wjddnjs33/image/blob/main/UnCrackable/Level1/4.png?raw=true">
<meta property="og:image" content="https://github.com/wjddnjs33/image/blob/main/UnCrackable/Level2/1.png?raw=true">
<meta property="og:image" content="https://github.com/wjddnjs33/image/blob/main/UnCrackable/Level2/2.png?raw=true">
<meta property="og:image" content="https://github.com/wjddnjs33/image/blob/main/UnCrackable/Level2/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202021-03-02%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%209.08.49.png?raw=true">
<meta property="og:image" content="https://github.com/wjddnjs33/image/blob/main/UnCrackable/Level2/ida-1.png?raw=true">
<meta property="og:image" content="https://github.com/wjddnjs33/image/blob/main/UnCrackable/Level2/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202021-03-02%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%209.32.58.png?raw=true">
<meta property="article:published_time" content="2021-02-25T00:00:10.000Z">
<meta property="article:modified_time" content="2021-03-02T12:38:21.985Z">
<meta property="article:author" content="Jeongwon Jo">
<meta property="article:tag" content="Android">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://github.com/wjddnjs33/image/blob/main/UnCrackable/Level1/1.png?raw=true">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>UnCrackable Wrtie Up</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 5.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/categories/">Category</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2021/02/28/2021-02-27-Trust-CTF-2021/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2021/02/23/2021-02-22-FridaLab/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2021/02/25/2021-02-25-UnCrackable/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2021/02/25/2021-02-25-UnCrackable/&text=UnCrackable Wrtie Up"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2021/02/25/2021-02-25-UnCrackable/&title=UnCrackable Wrtie Up"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2021/02/25/2021-02-25-UnCrackable/&is_video=false&description=UnCrackable Wrtie Up"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=UnCrackable Wrtie Up&body=Check out this article: http://example.com/2021/02/25/2021-02-25-UnCrackable/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2021/02/25/2021-02-25-UnCrackable/&title=UnCrackable Wrtie Up"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2021/02/25/2021-02-25-UnCrackable/&title=UnCrackable Wrtie Up"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2021/02/25/2021-02-25-UnCrackable/&title=UnCrackable Wrtie Up"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2021/02/25/2021-02-25-UnCrackable/&title=UnCrackable Wrtie Up"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2021/02/25/2021-02-25-UnCrackable/&name=UnCrackable Wrtie Up&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2021/02/25/2021-02-25-UnCrackable/&t=UnCrackable Wrtie Up"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#UnCrackable-Level-1"><span class="toc-number">1.</span> <span class="toc-text"> UnCrackable Level 1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#UnCrackable-Level-2"><span class="toc-number">2.</span> <span class="toc-text"> UnCrackable Level 2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#UnCrackable-Level-3"><span class="toc-number">3.</span> <span class="toc-text"> UnCrackable Level 3</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        UnCrackable Wrtie Up
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Jeongwon Jo</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2021-02-25T00:00:10.000Z" itemprop="datePublished">2021-02-25</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/CTF/">CTF</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/Android/" rel="tag">Android</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="UnCrackable-Level-1"><a href="#UnCrackable-Level-1" class="headerlink" title=" UnCrackable Level 1"></a><span style="color:#21C587"></span> UnCrackable Level 1</h2><p><img src="https://github.com/wjddnjs33/image/blob/main/UnCrackable/Level1/1.png?raw=true"></p>
<p>앱을 실행하면 루팅 탐지가 되었다는 팝업이 뜨는 것을 볼 수 있습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">a</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">        AlertDialog create = <span class="keyword">new</span> AlertDialog.Builder(<span class="keyword">this</span>).create();</span><br><span class="line">        create.setTitle(str);</span><br><span class="line">        create.setMessage(<span class="string">&quot;This is unacceptable. The app is now going to exit.&quot;</span>);</span><br><span class="line">        create.setButton(-<span class="number">3</span>, <span class="string">&quot;OK&quot;</span>, <span class="keyword">new</span> DialogInterface.OnClickListener() &#123;</span><br><span class="line">            <span class="comment">/* class sg.vantagepoint.uncrackable1.MainActivity.AnonymousClass1 */</span></span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span> <span class="comment">// android.content.DialogInterface.OnClickListener</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface dialogInterface, <span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">                System.exit(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        create.setCancelable(<span class="keyword">false</span>);</span><br><span class="line">        create.show();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    (생략)</span><br></pre></td></tr></table></figure>
<p>루팅 탐지 로직의 코드를 확인해보니 <code>MainActivity</code>에 있는 것을 볼 수 있고, <code>onClick()</code> 메서드를 이용해서 버튼을 클릭하면 <code>exit()</code> 메서드를 호출하는 것을 볼 수 있습니다. 그렇기 때문에 <code>OK</code> 버튼을 누르면 <code>exit()</code> 메서드에 의해서 프로그램이 종료가 되는 것 입니다. 일단 <code>onClick()</code> 메서드를 후킹해서 우회를 해보겠습니다.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">setImmediate(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        Java.choose(<span class="string">&quot;sg.vantagepoint.uncrackable1.MainActivity$1&quot;</span>,&#123;</span><br><span class="line">            onMatch:<span class="function"><span class="keyword">function</span>(<span class="params">a</span>)</span>&#123;</span><br><span class="line">                a.onClick.implementation = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">&quot;\n[*] Root Detected Bypass&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            onComplete:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;\n[*] Stage 1, Success&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>자바스크립트를 이용해서 위와 같이 익스 코드를 작성해주었습니다. <code>Java.choose()</code> 메서드를 이용해서 클래스를 불러와서 <code>onClick()</code> 메서드를 후킹해서 버튼을 클릭할 때 <code>exit()</code> 메서드가 아닌 <code>console.log()</code>가 실행이 되게 해주었습니다. 그리고 클래스를 불러올 때 <code>$1</code>를 붙혀주지 않으면 <code>onClick()</code> 메서드 후킹이 되지 않았습니다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> py@py  ~&#x2F;app&#x2F;UnCrackable&#x2F;Level1  frida -U -l exploit.js owasp.mstg.uncrackable1</span><br><span class="line">     ____</span><br><span class="line">    &#x2F; _  |   Frida 12.11.7 - A world-class dynamic instrumentation toolkit</span><br><span class="line">   | (_| |</span><br><span class="line">    &gt; _  |   Commands:</span><br><span class="line">   &#x2F;_&#x2F; |_|       help      -&gt; Displays the help system</span><br><span class="line">   . . . .       object?   -&gt; Display information about &#39;object&#39;</span><br><span class="line">   . . . .       exit&#x2F;quit -&gt; Exit</span><br><span class="line">   . . . .</span><br><span class="line">   . . . .   More info at https:&#x2F;&#x2F;www.frida.re&#x2F;docs&#x2F;home&#x2F;</span><br><span class="line">Attaching...                                                            </span><br><span class="line"></span><br><span class="line">[*] Stage 1, Success</span><br><span class="line">[SM-G965N::owasp.mstg.uncrackable1]-&gt;  </span><br><span class="line">[*] Root Detected Bypass</span><br></pre></td></tr></table></figure>
<p><img src="https://github.com/wjddnjs33/image/blob/main/UnCrackable/Level1/2.png?raw=true"></p>
<p>함수 후킹을 해주고 버튼을 클릭해주니 루팅 탐지가 잘 우회된 것을 볼 수 있습니다. 이제 특정한 값을 입력해주면 문제가 풀리게 됩니다.</p>
<p><img src="https://github.com/wjddnjs33/image/blob/main/UnCrackable/Level1/3.png?raw=true"></p>
<p>아무 값이나 입력하고 보내주니 값이 틀렸다고, 다시 입력해주라는 팝업이 뜨는 것을 볼 수 있습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">    (생략)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">verify</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">        String str;</span><br><span class="line">        String obj = ((EditText) findViewById(R.id.edit_text)).getText().toString();</span><br><span class="line">        AlertDialog create = <span class="keyword">new</span> AlertDialog.Builder(<span class="keyword">this</span>).create();</span><br><span class="line">        <span class="keyword">if</span> (a.a(obj)) &#123;</span><br><span class="line">            create.setTitle(<span class="string">&quot;Success!&quot;</span>);</span><br><span class="line">            str = <span class="string">&quot;This is the correct secret.&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            create.setTitle(<span class="string">&quot;Nope...&quot;</span>);</span><br><span class="line">            str = <span class="string">&quot;That&#x27;s not it. Try again.&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        create.setMessage(str);</span><br><span class="line">        create.setButton(-<span class="number">3</span>, <span class="string">&quot;OK&quot;</span>, <span class="keyword">new</span> DialogInterface.OnClickListener() &#123;</span><br><span class="line">            <span class="comment">/* class sg.vantagepoint.uncrackable1.MainActivity.AnonymousClass2 */</span></span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span> <span class="comment">// android.content.DialogInterface.OnClickListener</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface dialogInterface, <span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">                dialogInterface.dismiss();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        create.show();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>검증하는 함수를 찾아보니 <code>MainActivity</code> 제일 밑에 있었습니다. 코드를 보면 입력값을 <code>obj</code> 변수에 넣고, a 클래스의 <code>a()</code> 메서드의 인자값으로 <code>obj</code> 변수를 넘겨주고 있고, <code>a()</code>의 값이 참이면 문제가 풀리고, 거짓이면 아까와 같이 틀렸다고 팝업이 뜨는 로직인 것을 볼 수 있습니다.<br></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">a</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">a</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] bArr;</span><br><span class="line">        <span class="keyword">byte</span>[] bArr2 = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            bArr = sg.vantagepoint.a.a.a(b(<span class="string">&quot;8d127684cbc37c17616d806cf50473cc&quot;</span>), Base64.decode(<span class="string">&quot;5UJiFctbmgbDoLXmpL12mkno8HT4Lv8dlat8FxR2GOc=&quot;</span>, <span class="number">0</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            Log.d(<span class="string">&quot;CodeCheck&quot;</span>, <span class="string">&quot;AES error:&quot;</span> + e.getMessage());</span><br><span class="line">            bArr = bArr2;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> str.equals(<span class="keyword">new</span> String(bArr));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>그리고 위 코드가 a 클래스의 <code>a()</code> 메서드의 코드입니다. 코드를 보면 <code>sg.vantagepoint.a.a.a()</code> 메서드를 이용해서 특정한 값을 만들고, 만들어진 <code>bArr</code> 값과 우리가 입력한 값을 비교하는 것을 볼 수 있습니다. 이때 우리가 입력한 값과 위에서 만들어진 값이 동일하면 <code>true</code>를 반환해 문제가 풀리는 구조입니다.<br></p>
<p>이제 생각해 볼 수 있는 건 <code>a()</code> 메서드를 후킹해서 반환값을 항상 참을 만들거나, <code>a()</code> 메서드에서 <code>bArr</code>의 값을 만들 때 사용되는 <code>sg.vantagepoint.a.a.a()</code>의 값을 뽑는 방법이 있겠습니다. 일단 2가지 익스를 모두 해보겠습니다.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">setImmediate(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        Java.choose(<span class="string">&quot;sg.vantagepoint.uncrackable1.MainActivity$1&quot;</span>,&#123;</span><br><span class="line">            onMatch:<span class="function"><span class="keyword">function</span>(<span class="params">a</span>)</span>&#123;</span><br><span class="line">                a.onClick.implementation = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">&quot;\n[*] Root Detected Bypass&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            onComplete:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;\n[*] Stage 1, Success&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Sollution 1</span></span><br><span class="line">        <span class="keyword">const</span> cls = Java.use(<span class="string">&quot;sg.vantagepoint.a.a&quot;</span>);</span><br><span class="line">        cls.a.implementation = <span class="function"><span class="keyword">function</span>(<span class="params">a, b</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">const</span> bytes = cls.a(a, b);</span><br><span class="line">            <span class="keyword">const</span> secret = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; bytes.length; ++i)&#123;</span><br><span class="line">                secret += (<span class="built_in">String</span>.fromCharCode(bytes[i] &amp; <span class="number">0xff</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;\n[*] Find Secret : &quot;</span> + secret);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;\n[*] Stage 2, Success&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> bytes;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Sollution 2</span></span><br><span class="line">        <span class="keyword">const</span> cls2 = Java.use(<span class="string">&quot;sg.vantagepoint.uncrackable1.a&quot;</span>);</span><br><span class="line">        cls2.a.implementation = <span class="function"><span class="keyword">function</span>(<span class="params">a</span>)</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;\n[*] Stage 2, Success&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>자바스크립트를 이용해서 위와 같이 <code>Sollution 1/2</code>를 모두 작성해주었습니다. <code>Sollution 1</code>은 <code>bArr</code>의 값을 만드는 <code>sg.vantagepoint.a.a.a()</code> 메서드를 후킹해서 여기서 만들어지는 값을 그대로 뽑아오는 것 익스입니다. 뽑아 오는 데이터는 바이트 객체이므로 <code>new Buffer</code>를 이용해서 문자열로 변환해주려 했지만 잘 되지 않아서 <code>String.fromCharCode()</code> 메서드를 이용해서 바이트 값을 문자열로 변환시켜주었습니다.<br></p>
<p><code>Sollution 2</code>는 a 클래스의 <code>a()</code> 메서드를 후킹해서 어떤 값을 입력해도 항상 <code>true</code>를 반환하게 만들어주었습니다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> py@py  ~&#x2F;app&#x2F;UnCrackable&#x2F;Level1  frida -U -l exploit.js owasp.mstg.uncrackable1</span><br><span class="line">     ____</span><br><span class="line">    &#x2F; _  |   Frida 12.11.7 - A world-class dynamic instrumentation toolkit</span><br><span class="line">   | (_| |</span><br><span class="line">    &gt; _  |   Commands:</span><br><span class="line">   &#x2F;_&#x2F; |_|       help      -&gt; Displays the help system</span><br><span class="line">   . . . .       object?   -&gt; Display information about &#39;object&#39;</span><br><span class="line">   . . . .       exit&#x2F;quit -&gt; Exit</span><br><span class="line">   . . . .</span><br><span class="line">   . . . .   More info at https:&#x2F;&#x2F;www.frida.re&#x2F;docs&#x2F;home&#x2F;</span><br><span class="line">Attaching...                                                            </span><br><span class="line"></span><br><span class="line">[*] Stage 1, Success</span><br><span class="line">[SM-G965N::owasp.mstg.uncrackable1]-&gt;  </span><br><span class="line">[*] Find Secret : I want to believe</span><br><span class="line"></span><br><span class="line">[*] Stage 2, Success</span><br></pre></td></tr></table></figure>
<p><code>Sollution 1</code>을 이용해 후킹 해주니 Secret 값을 잘 뽑는 것을 볼 수 있습니다. Secret 값은 <code>&quot;I want to believe&quot;</code>입니다.</p>
<p><img src="https://github.com/wjddnjs33/image/blob/main/UnCrackable/Level1/4.png?raw=true"></p>
<p><code>Sollution 2</code>를 이용해 함수를 후킹하고, 아무 값이나 입력해줘도 잘 풀리는 것을 볼 수 있습니다.</p>
<hr>
<h2 id="UnCrackable-Level-2"><a href="#UnCrackable-Level-2" class="headerlink" title=" UnCrackable Level 2"></a><span style="color:#21C587"></span> UnCrackable Level 2</h2><p><img src="https://github.com/wjddnjs33/image/blob/main/UnCrackable/Level2/1.png?raw=true"></p>
<p>앱을 실행하면 Level1과 마찬가지로 루팅 탐지가 되었다는 팝업이 뜨는 것을 볼 수 있습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">c</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> CodeCheck m;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;foo&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* access modifiers changed from: private */</span></span><br><span class="line">    <span class="comment">/* access modifiers changed from: public */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">a</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">        AlertDialog create = <span class="keyword">new</span> AlertDialog.Builder(<span class="keyword">this</span>).create();</span><br><span class="line">        create.setTitle(str);</span><br><span class="line">        create.setMessage(<span class="string">&quot;This is unacceptable. The app is now going to exit.&quot;</span>);</span><br><span class="line">        create.setButton(-<span class="number">3</span>, <span class="string">&quot;OK&quot;</span>, <span class="keyword">new</span> DialogInterface.OnClickListener() &#123;</span><br><span class="line">            <span class="comment">/* class sg.vantagepoint.uncrackable2.MainActivity.AnonymousClass1 */</span></span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span> <span class="comment">// android.content.DialogInterface.OnClickListener</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface dialogInterface, <span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">                System.exit(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        create.setCancelable(<span class="keyword">false</span>);</span><br><span class="line">        create.show();</span><br><span class="line">    &#125;</span><br><span class="line">(생략)</span><br></pre></td></tr></table></figure>
<p>코드를 보면 일단 <code>System.loadLibrary()</code> 메서드를 이용해서 어떤 라이브러리를 불러오는 것을 볼 수 있습니다. 그리고 밑에서는 <code>onClick()</code> 메서드를 이용해서 버튼을 누르면 <code>System.exit()</code> 메서드를 호출하는 것을 볼 수 있습니다. 해당 로직도 Level1과 같이 <code>onClick()</code> 메서드를 후킹해주면 됩니다.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">setImmediate(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">const</span> cls = Java.use(<span class="string">&quot;sg.vantagepoint.uncrackable2.MainActivity$1&quot;</span>);</span><br><span class="line">        cls.onClick.implementation = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;\n[*] Root Detected Bypass&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> py@py  ~&#x2F;app&#x2F;UnCrackable&#x2F;Level2  frida -U -l exploit.js owasp.mstg.uncrackable2</span><br><span class="line">     ____</span><br><span class="line">    &#x2F; _  |   Frida 12.11.7 - A world-class dynamic instrumentation toolkit</span><br><span class="line">   | (_| |</span><br><span class="line">    &gt; _  |   Commands:</span><br><span class="line">   &#x2F;_&#x2F; |_|       help      -&gt; Displays the help system</span><br><span class="line">   . . . .       object?   -&gt; Display information about &#39;object&#39;</span><br><span class="line">   . . . .       exit&#x2F;quit -&gt; Exit</span><br><span class="line">   . . . .</span><br><span class="line">   . . . .   More info at https:&#x2F;&#x2F;www.frida.re&#x2F;docs&#x2F;home&#x2F;</span><br><span class="line">                                                                                </span><br><span class="line">[SM-G965N::owasp.mstg.uncrackable2]-&gt;  </span><br><span class="line">[*] Root Detected Bypass</span><br></pre></td></tr></table></figure>
<p><img src="https://github.com/wjddnjs33/image/blob/main/UnCrackable/Level2/2.png?raw=true"></p>
<p>자바스크립트를 이용해서 위와 같이 루팅 탐지를 우회하는 익스 코드를 작성해서 후킹을 해주니 루팅 탐지를 잘 우회하는 것을 볼 수 있습니다. 이제 해야 할 건 Level1처럼 시크릿 키를 획득해서 입력해주면 되는 거 같습니다. 일단 verify 로직의 코드를 분석해보겠습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">(생략)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">verify</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">        String str;</span><br><span class="line">        String obj = ((EditText) findViewById(R.id.edit_text)).getText().toString();</span><br><span class="line">        AlertDialog create = <span class="keyword">new</span> AlertDialog.Builder(<span class="keyword">this</span>).create();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.m.a(obj)) &#123;</span><br><span class="line">            create.setTitle(<span class="string">&quot;Success!&quot;</span>);</span><br><span class="line">            str = <span class="string">&quot;This is the correct secret.&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            create.setTitle(<span class="string">&quot;Nope...&quot;</span>);</span><br><span class="line">            str = <span class="string">&quot;That&#x27;s not it. Try again.&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        create.setMessage(str);</span><br><span class="line">        create.setButton(-<span class="number">3</span>, <span class="string">&quot;OK&quot;</span>, <span class="keyword">new</span> DialogInterface.OnClickListener() &#123;</span><br><span class="line">            <span class="comment">/* class sg.vantagepoint.uncrackable2.MainActivity.AnonymousClass3 */</span></span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span> <span class="comment">// android.content.DialogInterface.OnClickListener</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface dialogInterface, <span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">                dialogInterface.dismiss();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        create.show();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>위 코드 바로 위에 디버깅을 탐지하는 코드가 있는데 해당 부분은 문제 풀 때 필요가 없는 거 같아서 분석하지 않겠습니다. <code>verify()</code> 함수를 보면 입력값을 받아 와서 <code>obj</code> 변수에 넣어주고, <code>this.m.a()</code> 메서드에 <code>obj</code> 변수를 넘겨주고 있는 것을 볼 수 있습니다. 여기서 <code>this</code>는 현재 객체인 <code>MainActivity</code>를 가르키고, <code>m</code>은 아까 맨 위에서 <code>private CodeCheck m;</code>와 같이 <code>m</code>을 선언했기 때문에 <code>CodeCheck</code> 클래스를 가르키게 됩니다. 그럼 <code>CodeCheck</code> 클래스 내부에 있는 <code>a()</code> 메서드를 분석해보겠습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> sg.vantagepoint.uncrackable2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CodeCheck</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">boolean</span> <span class="title">bar</span><span class="params">(<span class="keyword">byte</span>[] bArr)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">a</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> bar(str.getBytes());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>CodeCheck</code> 메서드를 확인해보니 복잡한 로직은 없습니다. 그냥 입력값을 받아와서 <code>getBytes()</code> 메서드를 이용해 문자열을 바이트로 변환해주고, 변환된 값을 네이티브 함수인 <code>bar()</code>에 인자로 넘겨주고 있는 것을 볼 수 있습니다. 네이티브 함수는 C/C++로 구현된 함수인데 이는 라이브러리 파일을 통해 분석할 수 있습니다. 라이브러리 파일은 아까 <code>System.loadLibrary(&quot;foo&quot;);</code>에 의해서 로드가 되었습니다. 이제 ida를 이용해 라이브러리 파일을 확인해보겠습니다.<br></p>
<p>라이브러리 파일은 apk 파일을 unzip 하게 되면 <code>/lib/x86</code>에 존재합니다.</p>
<p><img src="https://github.com/wjddnjs33/image/blob/main/UnCrackable/Level2/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202021-03-02%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%209.08.49.png?raw=true"></p>
<p>일단 ida로 라이브러리 파일을 열어서 search 기능을 이용해 <code>bar</code>라고 검색을 해보니 위와 같이 <code>Java_sg_vantagepoint_uncrackable2_CodeCheck_bar()</code> 함수가 존재하는 것을 볼 수 있었습니다.</p>
<p><img src="https://github.com/wjddnjs33/image/blob/main/UnCrackable/Level2/ida-1.png?raw=true"></p>
<p><code>Java_sg_vantagepoint_uncrackable2_CodeCheck_bar()</code> 함수를 분석해보면 제일 하단에 <code>strncmp()</code> 함수를 이용해서 <code>v3</code>와 <code>(const char *)&amp;s2</code>의 값을 23 바이트만큼 비교하는 것을 볼 수 있습니다. 이때 비교를 해서 비교한 값이 23 바이트 모두 일치하면 1을 반환하고, 그렇지 않으면 0을 반환하는 구조입니다. 그리고 바로 위에 if문이 하나 존재하는데 특정 값이 23이 아니면 goto 문을 이용해서 0을 반환하는 곳으로 이동하게 되는데 아마 해당 로직이 우리가 입력한 값의 길이를 검증하는 거 같습니다. 이유는 바로 밑에서 비교하는 길이가 23바이트이니 23바이트보다 크거나 작은 값은 검증할 필요도 없기 때문인 거 같습니다.<br></p>
<p>그럼 이렇게 분석을 해본 결과 <code>strncmp()</code> 함수의 첫 번째 값이 우리가 입력한 값이고, 두 번째 값이 시크릿 값을 거라는 추측을 할 수 있습니다. 그럼 우리는 <code>strncmp()</code> 함수를 후킹해서 그냥 두 번째 인자 값을 긁어오면 시크릿 값을 알 수 있습니다.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">setImmediate(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">const</span> cls = Java.use(<span class="string">&quot;sg.vantagepoint.uncrackable2.MainActivity$1&quot;</span>);</span><br><span class="line">        cls.onClick.implementation = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;\n[*] Root Detected Bypass&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// native method hooking</span></span><br><span class="line">        <span class="comment">// strncmp addr leak</span></span><br><span class="line">        <span class="keyword">const</span> strncmp_addr = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">const</span> so = Module.enumerateImportsSync(<span class="string">&quot;libfoo.so&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; so.length; i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(so[i].name == <span class="string">&#x27;strncmp&#x27;</span>)&#123;strncmp_addr = so[i].address;<span class="built_in">console</span>.log(<span class="string">&quot;[*] strncmp addr : &quot;</span> + strncmp_addr)&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// strncmp hooking</span></span><br><span class="line">        Interceptor.attach(strncmp_addr, &#123;</span><br><span class="line">            <span class="comment">// strncmp(args[0], args[1], args[2]);</span></span><br><span class="line">            onEnter: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>)</span>&#123;              </span><br><span class="line">                <span class="keyword">if</span>(args[<span class="number">2</span>] == <span class="number">23</span>)&#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">&quot;[*] Secret Key : &quot;</span> + Memory.readCString(args[<span class="number">1</span>]));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>자바스크립트를 이용해서 위와 같이 익스 코드를 작성해주었습니다. 제일 먼저 <code>Module.enumerateImportsSync()</code> 메서드를 이용해서 라이브러리 파일 내에 있는 함수들을 모두 긁어와서 for문을 이용해 이름이 <code>strncmp</code>인 함수의 주소를 릭을 해주었습니다.<br></p>
<p>그리고 라이브러리 내에 있는 함수를 조작하려면 <code>Interceptor.attach()</code> 메서드를 이용해야 합니다. 그래서 해당 메서드를 이용해서 <code>strncmp()</code> 함수에서 3번 째 인자, 즉 23 바이트만큼 비교하는 <code>strncmp()</code> 함수에 2번째 인자값을 모두 출력하게 해주었습니다. 2번째 인자값에는 우리가 입력한 값과 비교하는 값이 들어있기 때문에 해당 값을 뽑아주면 시크릿 키를 뽑을 수 있습니다. 그리고 문제를 다 풀고 알게 된 것인데 <code>strncmp()</code> 함수의 주소를 직접 릭을 하지 않아도 <code>Module.getExportByname(&quot;libaryName&quot;, &quot;functionName&quot;)</code>를 이용해서 주소를 바로 긁어 올 수 있습니다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> py@py  ~&#x2F;app&#x2F;UnCrackable&#x2F;Level2  frida -U -l exploit.js owasp.mstg.uncrackable2</span><br><span class="line">     ____</span><br><span class="line">    &#x2F; _  |   Frida 12.11.7 - A world-class dynamic instrumentation toolkit</span><br><span class="line">   | (_| |</span><br><span class="line">    &gt; _  |   Commands:</span><br><span class="line">   &#x2F;_&#x2F; |_|       help      -&gt; Displays the help system</span><br><span class="line">   . . . .       object?   -&gt; Display information about &#39;object&#39;</span><br><span class="line">   . . . .       exit&#x2F;quit -&gt; Exit</span><br><span class="line">   . . . .</span><br><span class="line">   . . . .   More info at https:&#x2F;&#x2F;www.frida.re&#x2F;docs&#x2F;home&#x2F;</span><br><span class="line">Attaching...                                                            </span><br><span class="line">[*] strncmp addr : 0xd3d1bfc0</span><br><span class="line">[SM-G965N::owasp.mstg.uncrackable2]-&gt; [*] Secret Key : persist.sys.ui.hw</span><br><span class="line">[*] Secret Key : Thanks for all the fish</span><br><span class="line">[*] Secret Key : debug.layout</span><br><span class="line">(생략)</span><br></pre></td></tr></table></figure>
<p>익스 코드를 이용해서 함수를 후킹해주니 <code>strncmp()</code> 함수의 주소 릭이 잘 되는 것을 볼 수 있고, 입력폼에 <code>&#39;a&#39;</code>를 23 바이트만큼 입력을 해주니 <code>strncmp()</code> 함수가 실행돼서 두 번째 인자 값이 출력되는 것을 볼 수 있습니다. 아마도 두 번째로 출력된 <code>Thanks for all the fish</code>가 시크릿 값인 거 같습니다. 그리고 <code>&#39;a&#39;</code>를 23 바이트만큼 입력한 이유는 문제 로직에서 입력한 값의 길이가 23이여야 <code>strncmp()</code> 함수가 실행되기 때문입니다.</p>
<p><img src="https://github.com/wjddnjs33/image/blob/main/UnCrackable/Level2/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202021-03-02%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%209.32.58.png?raw=true"></p>
<p><code>Thanks for all the fish</code>를 입력해주니 잘 풀리는 것을 볼 수 있습니다. 이번 문제를 통해서는 네이터브 함수 후킹을 하는 법을 알 수 있었습니다.</p>
<hr>
<h2 id="UnCrackable-Level-3"><a href="#UnCrackable-Level-3" class="headerlink" title=" UnCrackable Level 3"></a><span style="color:#21C587"></span> UnCrackable Level 3</h2><p>너무 어렵다.. ㅋㅋ</p>
<hr>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/categories/">Category</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#UnCrackable-Level-1"><span class="toc-number">1.</span> <span class="toc-text"> UnCrackable Level 1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#UnCrackable-Level-2"><span class="toc-number">2.</span> <span class="toc-text"> UnCrackable Level 2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#UnCrackable-Level-3"><span class="toc-number">3.</span> <span class="toc-text"> UnCrackable Level 3</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2021/02/25/2021-02-25-UnCrackable/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2021/02/25/2021-02-25-UnCrackable/&text=UnCrackable Wrtie Up"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2021/02/25/2021-02-25-UnCrackable/&title=UnCrackable Wrtie Up"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2021/02/25/2021-02-25-UnCrackable/&is_video=false&description=UnCrackable Wrtie Up"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=UnCrackable Wrtie Up&body=Check out this article: http://example.com/2021/02/25/2021-02-25-UnCrackable/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2021/02/25/2021-02-25-UnCrackable/&title=UnCrackable Wrtie Up"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2021/02/25/2021-02-25-UnCrackable/&title=UnCrackable Wrtie Up"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2021/02/25/2021-02-25-UnCrackable/&title=UnCrackable Wrtie Up"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2021/02/25/2021-02-25-UnCrackable/&title=UnCrackable Wrtie Up"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2021/02/25/2021-02-25-UnCrackable/&name=UnCrackable Wrtie Up&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2021/02/25/2021-02-25-UnCrackable/&t=UnCrackable Wrtie Up"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2020-2021
    Jeongwon Jo
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/categories/">Category</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->


</body>
</html>
