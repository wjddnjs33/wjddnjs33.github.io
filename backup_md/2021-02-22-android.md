---
layout: post
date: 2021-02-23 00:00:10
title: "Android Exploit"
categories: CTF
tags: [Android]
author:
  - Jeongwon Jo

---
2020년 중반에 `인프런`이라는 플랫폼에서 강의를 보며 첫 안드로이드 해킹 공부를 시작 했었는데, 오랜만에 다시 안드로이드 공부를 하려고 합니다. 하지만 약 3개월 동안 하지 않아 frida 사용법이나 익스 코드 작성하는 방법을 조금 까먹어 `FridaLab`을 시작으로 여러 문제들을 다시 풀어 볼 계획입니다.

---
## <span style="color:#21C587"></span> FridaLab

> FridaLab 첫 번째 문제는 challenge_01 클래스의 chall01 이라는 변수의 값을 1로 수정해야 합니다.<br>

```java
package uk.rossmarks.fridalab;

public class challenge_01 {
    static int chall01;

    public static int getChall01Int() {
        return chall01;
    }
}
```
코드를 보면 `challenge_01` 클래스는 `uk.rossmarks.fridalab` 안에 있는 것을 볼 수 있고, `challenge_01` 클래스 내부에 `chall01` 변수가 있는 것을 볼 수 있습니다. 해당 값을 1로 바꿔주면 됩니다.

```javascript
setImmediate(function() {
	Java.perform(function() {
		const chall1 = Java.use("uk.rossmarks.fridalab.challenge_01");
		chall1.chall01.value = 1;
		console.log("Success");
	});
});
```
```
 py@py  ~/ApP/FridaLab  frida -U -l chall01.js uk.rossmarks.fridalab
     ____
    / _  |   Frida 12.11.7 - A world-class dynamic instrumentation toolkit
   | (_| |
    > _  |   Commands:
   /_/ |_|       help      -> Displays the help system
   . . . .       object?   -> Display information about 'object'
   . . . .       exit/quit -> Exit
   . . . .
   . . . .   More info at https://www.frida.re/docs/home/
Attaching...
Success
[SM-G965N::uk.rossmarks.fridalab]->
```
![](https://github.com/wjddnjs33/image/blob/main/FridaLab/1.png?raw=true)

자바스크립트를 이용해서 익스 코드를 위와 같이 작성해주었습니다. 모든 익스플로잇 코드는 `setImmediate` -> `Java.perform` 틀로 이루어져 있고, 상황에 맞게 `setTimeout` -> `setImmediate` -> `Java.perform` 틀로 사용할 수도 있습니다. 그리고 추가적으로 하나 더 이야기 하면 `Static` 메서드를 호출할 때는 `Java.use()` 함수로 호출하지만 `Instance`로 호출할 때는 `Java.choose()` 함수로 호출한다는 것을 꼭 기억하고 있어야 합니다.<br>

> FridaLab 두 번째 문제는 Chall2() 메서드를 실행시키켜야 합니다.<br>

```java
public class MainActivity extends AppCompatActivity {
    (생략)
    private void chall02() {
        this.completeArr[1] = 1;
    }
    (생략)
}
```
`chall02()` 메서드를 찾아보면 `MainActivity` 내부에 정의되어 있는 것을 볼 수 있고, 메서드가 `Instance`로 정의되어 있습니다. `Instance`로 정의 되어 있을 시에는 `Java.use()`가 아닌 `Java.choose()`를 이용해서 클래스를 호출해야 합니다.

```javascript
setImmediate(function() {
	Java.perform(function() {
		Java.choose("uk.rossmarks.fridalab.MainActivity", {
			onMatch:function(a){
				a.chall02();
			},
			onComplete:function(){
				console.log("Success");
			}
		});
	});
});
```
```
 py@py  ~/ApP/FridaLab  frida -U -l chall02.js uk.rossmarks.fridalab
     ____
    / _  |   Frida 12.11.7 - A world-class dynamic instrumentation toolkit
   | (_| |
    > _  |   Commands:
   /_/ |_|       help      -> Displays the help system
   . . . .       object?   -> Display information about 'object'
   . . . .       exit/quit -> Exit
   . . . .
   . . . .   More info at https://www.frida.re/docs/home/
Attaching...
Success
[SM-G965N::uk.rossmarks.fridalab]-> q

Thank you for using Frida!
```
![](https://github.com/wjddnjs33/image/blob/main/FridaLab/2.png?raw=true)

자바스크립트를 이용해서 위와 같이 익스 코드를 작성해주었습니다. `Java.choose()`에서 메모리에 `uk.rossmarks.fridalab.MainActivity`와 일치하는 클래스를 찾으면 `onMacth()`가 실행이 되고, 잘 실행이 됐다면 `onComplete()`까지 실행이 됩니다.<br>

> FridaLab 세 번째 문제는 Chall3() 메서드가 실행될 때, 항상 true가 반환이 되게 만들어야 합니다.<br>

```java
public class MainActivity extends AppCompatActivity {
    (생략)
    public boolean chall03() {
        return false;
    }
    (생략)
}
```
`chall03()` 메서드도 MainActivity에 있는 것을 볼 수 있고, `Instance`로 정의하고, 반환값은 `false`인 것을 볼 수 있습니다. 그러니 `implementation`을 이용해서 `chall03()` 메서드를 재정의하면 됩니다. 마찬가지로 인스턴스로 정의 되어 있기 때문에 `Java.choose()`를 사용해야 하지만 메서드를 조작할 때는 `Java.use()`를 이용해서 인스턴스를 가져와서 조작해도 됩니다. 하지만 저는 이번 익스는 `Java.choose()`를 이용해서 작성했습니다.

```javascript
setImmediate(function() {
	Java.perform(function(){
		Java.choose("uk.rossmarks.fridalab.MainActivity", {
			onMatch:function(a){
				a.chall03.implementation = function(){
					return true;
				}
			},
			onComplete:function(){
				console.log("Success");
			}
		});
	});
});
```
```
 py@py  ~/ApP/FridaLab  frida -U -l chall03.js uk.rossmarks.fridalab
     ____
    / _  |   Frida 12.11.7 - A world-class dynamic instrumentation toolkit
   | (_| |
    > _  |   Commands:
   /_/ |_|       help      -> Displays the help system
   . . . .       object?   -> Display information about 'object'
   . . . .       exit/quit -> Exit
   . . . .
   . . . .   More info at https://www.frida.re/docs/home/
Attaching...
Success
[SM-G965N::uk.rossmarks.fridalab]-> q

Thank you for using Frida!
```
![](https://github.com/wjddnjs33/image/blob/main/FridaLab/3.png?raw=true)

자바스크립트를 이용해서 위와 같이 익스 코드를 작성해주었습니다.<br>

> FridaLab 네 번째 문제는 Chall4() 메서드에 인자로 "frida"를 전달해주면 됩니다.<br>

```java
public class MainActivity extends AppCompatActivity {
    (생략)
    public void chall04(String str) {
        if (str.equals("frida")) {
            this.completeArr[3] = 1;
        }
    }
    (생략)
}
```
`chall04()` 메서드를 보면 equals 함수를 이용해서 인자 값이 "frida"인지 비교하고, 참이면 if문 내부로 들어가는 것을 볼 수 있습니다. 즉, `onMacth`에서 `chall04()` 메서드를 호출할 때, 인자로 "firda"라는 문자열을 넣고 호출하면 됩니다.

```javascript
setImmediate(function(){
	Java.perform(function(){
		Java.choose("uk.rossmarks.fridalab.MainActivity", {
			onMatch:function(a){
				a.chall04("frida");
			},
			onComplete:function(){
				console.log("Success");
			}
		});
	});
});
```
```
 py@py  ~/ApP/FridaLab  frida -U -l chall04.js uk.rossmarks.fridalab
     ____
    / _  |   Frida 12.11.7 - A world-class dynamic instrumentation toolkit
   | (_| |
    > _  |   Commands:
   /_/ |_|       help      -> Displays the help system
   . . . .       object?   -> Display information about 'object'
   . . . .       exit/quit -> Exit
   . . . .
   . . . .   More info at https://www.frida.re/docs/home/
Attaching...
Success
[SM-G965N::uk.rossmarks.fridalab]-> q

Thank you for using Frida!
```
![](https://github.com/wjddnjs33/image/blob/main/FridaLab/4.png?raw=true)

자스를 이용해서 위와 같이 익스 코드를 작성해주었습니다. `chall04()` 메서드를 호출할 때, "frida"라는 문자열을 넘겨주도록 하였습니다.

> FridaLab 다섯 번째 문제는 Chall5() 메서드에 인자로 항상 "frida"를 전달해주면 됩니다.<br>

```java
public class MainActivity extends AppCompatActivity {
    (생략)
    public void chall05(String str) {
        if (str.equals("frida")) {
            this.completeArr[4] = 1;
        } else {
            this.completeArr[4] = 0;
        }
    }
    (생략)
}
```
코드를 보면 4번과 거의 동일한 것을 볼 수 있습니다. 추가 된 것은 else 문이 추가되었습니다. 4번 문제에서 작성한 익스 코드는 단 `한 번`만 인자로 "frida"를 전송하기 때문에 위 코드는 사용할 수 없고, 함수를 조건에 맞게 재정의 하면 될 거 같습니다.

```javascript
setImmediate(function(){
	Java.perform(function(){
		const cls = Java.use("uk.rossmarks.fridalab.MainActivity");
		cls.chall05.implementation = function(){
			this.chall05("frida");
			console.log("\nChallenge 5 : Success");
		}
	});
});
```
```
 py@py  ~/ApP/FridaLab  frida -U -l chall05.js uk.rossmarks.fridalab
     ____
    / _  |   Frida 12.11.7 - A world-class dynamic instrumentation toolkit
   | (_| |
    > _  |   Commands:
   /_/ |_|       help      -> Displays the help system
   . . . .       object?   -> Display information about 'object'
   . . . .       exit/quit -> Exit
   . . . .
   . . . .   More info at https://www.frida.re/docs/home/

[SM-G965N::uk.rossmarks.fridalab]->
Challenge 5 : Success
[SM-G965N::uk.rossmarks.fridalab]->
```
![](https://github.com/wjddnjs33/image/blob/main/FridaLab/5.png?raw=true)

자바스크립트를 이용해서 위와 같이 익스 코드를 작성해주었습니다. 이번에는 `Java.use`를 이용해서 클래스를 가져와서 `implementation`을 이용해 함수를 재정의 해주었습니다. 함수 재정의는 `this.함수`를 이용해서 chall05 함수가 호출될 때 항상 `frida`라는 문자열을 인자로 전송하게 해주었습니다. 그리고 저기서 `this`는 현재 호출한 객체를 가리키고 있습니다.<br>

---
