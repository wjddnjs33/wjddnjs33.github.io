---
layout: post
date: 2021-02-23 00:00:10
title: "FridaLab Wrtie Up"
categories: CTF
tags: [Android]
author:
  - Jeongwon Jo

---
2020년 중반에 `인프런`이라는 플랫폼에서 강의를 보며 첫 안드로이드 해킹 공부를 시작 했었는데, 오랜만에 다시 안드로이드 공부를 하려고 합니다. 하지만 약 3개월 동안 하지 않아 frida 사용법이나 익스 코드 작성하는 방법을 조금 까먹어 `FridaLab`을 시작으로 여러 문제들을 다시 풀어 볼 계획입니다.

---
## <span style="color:#21C587"></span> Challenge 1

> FridaLab 첫 번째 문제는 challenge_01 클래스의 chall01 이라는 변수의 값을 1로 수정해야 합니다.<br>

```java
package uk.rossmarks.fridalab;

public class challenge_01 {
    static int chall01;

    public static int getChall01Int() {
        return chall01;
    }
}
```
코드를 보면 `challenge_01` 클래스는 `uk.rossmarks.fridalab` 안에 있는 것을 볼 수 있고, `challenge_01` 클래스 내부에 `chall01` 변수가 있는 것을 볼 수 있습니다. 해당 값을 1로 바꿔주면 됩니다.

```javascript
setImmediate(function() {
	Java.perform(function() {
		const chall1 = Java.use("uk.rossmarks.fridalab.challenge_01");
		chall1.chall01.value = 1;
		console.log("Success");
	});
});
```
```
 py@py  ~/ApP/FridaLab  frida -U -l chall01.js uk.rossmarks.fridalab
     ____
    / _  |   Frida 12.11.7 - A world-class dynamic instrumentation toolkit
   | (_| |
    > _  |   Commands:
   /_/ |_|       help      -> Displays the help system
   . . . .       object?   -> Display information about 'object'
   . . . .       exit/quit -> Exit
   . . . .
   . . . .   More info at https://www.frida.re/docs/home/
Attaching...
Success
[SM-G965N::uk.rossmarks.fridalab]->
```
![](https://github.com/wjddnjs33/image/blob/main/FridaLab/1.png?raw=true)

자바스크립트를 이용해서 익스 코드를 위와 같이 작성해주었습니다. 모든 익스플로잇 코드는 `setImmediate` -> `Java.perform` 틀로 이루어져 있고, 상황에 맞게 `setTimeout` -> `setImmediate` -> `Java.perform` 틀로 사용할 수도 있습니다. 그리고 추가적으로 하나 더 이야기 하면 `Static` 메서드를 호출할 때는 `Java.use()` 함수로 호출하지만 `Instance`로 호출할 때는 `Java.choose()` 함수로 호출한다는 것을 꼭 기억하고 있어야 합니다.<br>

---
## <span style="color:#21C587"></span> Challenge 2

> FridaLab 두 번째 문제는 Chall2() 메서드를 실행시키켜야 합니다.<br>

```java
public class MainActivity extends AppCompatActivity {
    (생략)
    private void chall02() {
        this.completeArr[1] = 1;
    }
    (생략)
}
```
`chall02()` 메서드를 찾아보면 `MainActivity` 내부에 정의되어 있는 것을 볼 수 있고, 메서드가 `Instance`로 정의되어 있습니다. `Instance`로 정의 되어 있을 시에는 `Java.use()`가 아닌 `Java.choose()`를 이용해서 클래스를 호출해야 합니다.

```javascript
setImmediate(function() {
	Java.perform(function() {
		Java.choose("uk.rossmarks.fridalab.MainActivity", {
			onMatch:function(a){
				a.chall02();
			},
			onComplete:function(){
				console.log("Success");
			}
		});
	});
});
```
```
 py@py  ~/ApP/FridaLab  frida -U -l chall02.js uk.rossmarks.fridalab
     ____
    / _  |   Frida 12.11.7 - A world-class dynamic instrumentation toolkit
   | (_| |
    > _  |   Commands:
   /_/ |_|       help      -> Displays the help system
   . . . .       object?   -> Display information about 'object'
   . . . .       exit/quit -> Exit
   . . . .
   . . . .   More info at https://www.frida.re/docs/home/
Attaching...
Success
[SM-G965N::uk.rossmarks.fridalab]-> q

Thank you for using Frida!
```
![](https://github.com/wjddnjs33/image/blob/main/FridaLab/2.png?raw=true)

자바스크립트를 이용해서 위와 같이 익스 코드를 작성해주었습니다. `Java.choose()`에서 메모리에 `uk.rossmarks.fridalab.MainActivity`와 일치하는 클래스를 찾으면 `onMacth()`가 실행이 되고, 잘 실행이 됐다면 `onComplete()`까지 실행이 됩니다.<br>

---
## <span style="color:#21C587"></span> Challenge 3

> FridaLab 세 번째 문제는 Chall3() 메서드가 실행될 때, 항상 true가 반환이 되게 만들어야 합니다.<br>

```java
public class MainActivity extends AppCompatActivity {
    (생략)
    public boolean chall03() {
        return false;
    }
    (생략)
}
```
`chall03()` 메서드도 MainActivity에 있는 것을 볼 수 있고, `Instance`로 정의하고, 반환값은 `false`인 것을 볼 수 있습니다. 그러니 `implementation`을 이용해서 `chall03()` 메서드를 재정의하면 됩니다. 마찬가지로 인스턴스로 정의 되어 있기 때문에 `Java.choose()`를 사용해야 하지만 메서드를 조작할 때는 `Java.use()`를 이용해서 인스턴스를 가져와서 조작해도 됩니다. 하지만 저는 이번 익스는 `Java.choose()`를 이용해서 작성했습니다.

```javascript
setImmediate(function() {
	Java.perform(function(){
		Java.choose("uk.rossmarks.fridalab.MainActivity", {
			onMatch:function(a){
				a.chall03.implementation = function(){
					return true;
				}
			},
			onComplete:function(){
				console.log("Success");
			}
		});
	});
});
```
```
 py@py  ~/ApP/FridaLab  frida -U -l chall03.js uk.rossmarks.fridalab
     ____
    / _  |   Frida 12.11.7 - A world-class dynamic instrumentation toolkit
   | (_| |
    > _  |   Commands:
   /_/ |_|       help      -> Displays the help system
   . . . .       object?   -> Display information about 'object'
   . . . .       exit/quit -> Exit
   . . . .
   . . . .   More info at https://www.frida.re/docs/home/
Attaching...
Success
[SM-G965N::uk.rossmarks.fridalab]-> q

Thank you for using Frida!
```
![](https://github.com/wjddnjs33/image/blob/main/FridaLab/3.png?raw=true)

자바스크립트를 이용해서 위와 같이 익스 코드를 작성해주었습니다.<br>

---
## <span style="color:#21C587"></span> Challenge 4

> FridaLab 네 번째 문제는 Chall4() 메서드에 인자로 "frida"를 전달해주면 됩니다.<br>

```java
public class MainActivity extends AppCompatActivity {
    (생략)
    public void chall04(String str) {
        if (str.equals("frida")) {
            this.completeArr[3] = 1;
        }
    }
    (생략)
}
```
`chall04()` 메서드를 보면 equals 함수를 이용해서 인자 값이 "frida"인지 비교하고, 참이면 if문 내부로 들어가는 것을 볼 수 있습니다. 즉, `onMacth`에서 `chall04()` 메서드를 호출할 때, 인자로 "firda"라는 문자열을 넣고 호출하면 됩니다.

```javascript
setImmediate(function(){
	Java.perform(function(){
		Java.choose("uk.rossmarks.fridalab.MainActivity", {
			onMatch:function(a){
				a.chall04("frida");
			},
			onComplete:function(){
				console.log("Success");
			}
		});
	});
});
```
```
 py@py  ~/ApP/FridaLab  frida -U -l chall04.js uk.rossmarks.fridalab
     ____
    / _  |   Frida 12.11.7 - A world-class dynamic instrumentation toolkit
   | (_| |
    > _  |   Commands:
   /_/ |_|       help      -> Displays the help system
   . . . .       object?   -> Display information about 'object'
   . . . .       exit/quit -> Exit
   . . . .
   . . . .   More info at https://www.frida.re/docs/home/
Attaching...
Success
[SM-G965N::uk.rossmarks.fridalab]-> q

Thank you for using Frida!
```
![](https://github.com/wjddnjs33/image/blob/main/FridaLab/4.png?raw=true)

자스를 이용해서 위와 같이 익스 코드를 작성해주었습니다. `chall04()` 메서드를 호출할 때, "frida"라는 문자열을 넘겨주도록 하였습니다.

---
## <span style="color:#21C587"></span> Challenge 5

> FridaLab 다섯 번째 문제는 Chall5() 메서드에 인자로 항상 "frida"를 전달해주면 됩니다.<br>

```java
public class MainActivity extends AppCompatActivity {
    (생략)
    public void chall05(String str) {
        if (str.equals("frida")) {
            this.completeArr[4] = 1;
        } else {
            this.completeArr[4] = 0;
        }
    }
    (생략)
}
```
코드를 보면 4번과 거의 동일한 것을 볼 수 있습니다. 추가 된 것은 else 문이 추가되었습니다. 4번 문제에서 작성한 익스 코드는 단 `한 번`만 인자로 "frida"를 전송하기 때문에 위 코드는 사용할 수 없고, 함수를 조건에 맞게 재정의 하면 될 거 같습니다.

```javascript
setImmediate(function(){
	Java.perform(function(){
		const cls = Java.use("uk.rossmarks.fridalab.MainActivity");
		cls.chall05.implementation = function(){
			this.chall05("frida");
			console.log("\nChallenge 5 : Success");
		}
	});
});
```
```
 py@py  ~/ApP/FridaLab  frida -U -l chall05.js uk.rossmarks.fridalab
     ____
    / _  |   Frida 12.11.7 - A world-class dynamic instrumentation toolkit
   | (_| |
    > _  |   Commands:
   /_/ |_|       help      -> Displays the help system
   . . . .       object?   -> Display information about 'object'
   . . . .       exit/quit -> Exit
   . . . .
   . . . .   More info at https://www.frida.re/docs/home/

[SM-G965N::uk.rossmarks.fridalab]->
Challenge 5 : Success
[SM-G965N::uk.rossmarks.fridalab]->
```
![](https://github.com/wjddnjs33/image/blob/main/FridaLab/5.png?raw=true)

자바스크립트를 이용해서 위와 같이 익스 코드를 작성해주었습니다. 이번에는 `Java.use`를 이용해서 클래스를 가져와서 `implementation`을 이용해 함수를 재정의 해주었습니다. 함수 재정의는 `this.함수`를 이용해서 chall05 함수가 호출될 때 항상 `frida`라는 문자열을 인자로 전송하게 해주었습니다. 그리고 저기서 `this`는 현재 호출한 객체를 가리키고 있습니다.<br>

---
## <span style="color:#21C587"></span> Challenge 6

> FridaLab 여섯 번째 문제는 Chall6() 메서드를 10초 후에 올바른 값과 함께 실행해주면 됩니다.<br>

```java
public class MainActivity extends AppCompatActivity {
    (생략)
    public void chall06(int i) {
        if (challenge_06.confirmChall06(i)) {
            this.completeArr[5] = 1;
        }
    }
    (생략)
}
```
코드를 보면 정수를 인자로 받고, 받은 인자를 `confirmChall06()` 메서드로 넘겨주는 것을 볼 수 있습니다.

```java
package uk.rossmarks.fridalab;

public class challenge_06 {
    static int chall06;
    static long timeStart;

    public static void startTime() {
        timeStart = System.currentTimeMillis();
    }

    public static boolean confirmChall06(int i) {
        return i == chall06 && System.currentTimeMillis() > timeStart + 10000;
    }

    public static void addChall06(int i) {
        chall06 += i;
        if (chall06 > 9000) {
            chall06 = i;
        }
    }
}
```
`confirmChall06()` 메서드를 확인해보면 인자 값 i와 chall06 값이 같고, 현재 시간이 `timeStart + 10000`보다 크면 참을 반환하게 됩니다. 일단 `10000`은 10 sec이기 때문에 `setTimeout()`를 이용해서 쉽게 처리할 수 있습니다.

이제 남은 건 `i`와 `chall06`의 값이 같아야 하는 조건만 남았습니다. `chall06`의 값은 `addChall06()` 메서드에 의해서 생성이 되는데 이 메서드가 `MainActivity` 어딘가에서 호출이 되고 있을 것 입니다. 하지만 그 부분은 볼 필요가 없는게 그냥 `addChall06()` 메서드에서 초기화된 `chall06`의 값을 `confirmChall06()` 메서드의 인자 값으로 바로 넘겨주게 재정의하면 됩니다. 그럼 `i`와 `chall06`이 같아지므로 풀리게 됩니다.

```javascript
setTimeout(function(){
	console.log("\n After 10 sec");
	setImmediate(function(){
		Java.perform(function(){
			const cls = Java.use("uk.rossmarks.fridalab.challenge_06");
			cls.addChall06.overload("int").implementation = function(arg0){
				Java.choose("uk.rossmarks.fridalab.MainActivity", {
					onMatch:function(b){
						b.chall06(cls.chall06.value);
					},
					onComplete:function(){
						console.log("\nSuccess");
					}
				});
			}
		});
	});
}, 10000);
```
```
 py@py  ~/ApP/FridaLab  frida -U -l chall06.js uk.rossmarks.fridalab
     ____
    / _  |   Frida 12.11.7 - A world-class dynamic instrumentation toolkit
   | (_| |
    > _  |   Commands:
   /_/ |_|       help      -> Displays the help system
   . . . .       object?   -> Display information about 'object'
   . . . .       exit/quit -> Exit
   . . . .
   . . . .   More info at https://www.frida.re/docs/home/

[SM-G965N::uk.rossmarks.fridalab]->
 After 10 sec

Success

Success
```
![](https://github.com/wjddnjs33/image/blob/main/FridaLab/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202021-02-23%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%205.27.34.png?raw=true)

자바스크립트를 이용해서 위와 같이 익스 코드를 작성해주었습니다. 제일 먼저 `setTimeout()` 메서들 이용해서 10초 지연시켜주고, `implementation()`를 이용해서 `addChall06()` 메소드가 실행될 때 마다 `chall06`의 값을 `chall06()`의 인자 값으로 넘겨주게 해주었습니다. 그리고 `implementation()`를 사용하기 전에 `overload()`를 이용해서 인자 값이 타입을 `int`로 지정해주었습니다. 문자열일 때는 오버로드를 안 해줘도 되는데 정수형일 때는 따로 지정을 해줘야 하는 이유는 아마 기본으로 `String`로 설정이 되어 있는 거 같습니다.<br>

---
## <span style="color:#21C587"></span> Challenge 7

> FridaLab 일곱 번째 문제는 Burute Force를 해서 핀 번호를 알아내는 문제입니다.<br>

```java
public class MainActivity extends AppCompatActivity {
    (생략)
    public void chall07(String str) {
        if (challenge_07.check07Pin(str)) {
            this.completeArr[6] = 1;
        } else {
            this.completeArr[6] = 0;
        }
    }
    (생략)
}
```
코드를 보면 `chall07()` 메서드로 인자 값을 하나 넘겨주고, 해당 인자 값이 Pin 번호와 일치하면 풀리게 됩니다.

```java
package uk.rossmarks.fridalab;

public class challenge_07 {
    static String chall07;

    public static void setChall07() {
        chall07 = BuildConfig.FLAVOR + (((int) (Math.random() * 9000.0d)) + 1000);
    }

    public static boolean check07Pin(String str) {
        return str.equals(chall07);
    }
}
```
`check07Pin()` 메서드를 확인해보면 `chall07`의 값과 인자 값을 비교하는 것을 볼 수 있고, 바로 위에 `setChall07()` 메소드에 의해서 `chall07`이 초기화되는 것을 볼 수 있습니다. 랜던 값을 사용하기 때문에 육안상으로 알아내는 것은 힘들어 보이지만 6번에서 풀었던 방식과 비슷하게 `setChall07()` 메서드에서 초기화되는 `chall07`의 값을 바로 `chall07()` 메서드에 인자 값으로 넘겨주면 될 거 같습니다.

```javascript
setImmediate(function(){
	Java.perform(function(){
		const cls = Java.use("uk.rossmarks.fridalab.challenge_07");
		cls.setChall07();
		console.log("Pin : " + cls.chall07.value);
	});
});
```
```
 py@py  ~/ApP/FridaLab  frida -U -l chall07.js uk.rossmarks.fridalab
     ____
    / _  |   Frida 12.11.7 - A world-class dynamic instrumentation toolkit
   | (_| |
    > _  |   Commands:
   /_/ |_|       help      -> Displays the help system
   . . . .       object?   -> Display information about 'object'
   . . . .       exit/quit -> Exit
   . . . .
   . . . .   More info at https://www.frida.re/docs/home/
Attaching...
Pin : 8136
[SM-G965N::uk.rossmarks.fridalab]-> q

Thank you for using Frida!
```
일단 위와 같이 핀을 찾는 코드를 작성하고 후킹을 해주니 `chall07`의 값을 잘 찾는 것을 볼 수 있습니다.

```javascript
setImmediate(function(){
	Java.perform(function(){
		const cls = Java.use("uk.rossmarks.fridalab.challenge_07");
		cls.setChall07();
		const pin = cls.chall07.value
		console.log("Pin : " + pin);

		Java.choose("uk.rossmarks.fridalab.MainActivity", {
			onMatch:function(a){
				a.chall07(pin);
			},
			onComplete:function(){
				console.log("Success");
			}
		});
	});
});
```
```
 py@py  ~/ApP/FridaLab  frida -U -l chall07.js uk.rossmarks.fridalab
     ____
    / _  |   Frida 12.11.7 - A world-class dynamic instrumentation toolkit
   | (_| |
    > _  |   Commands:
   /_/ |_|       help      -> Displays the help system
   . . . .       object?   -> Display information about 'object'
   . . . .       exit/quit -> Exit
   . . . .
   . . . .   More info at https://www.frida.re/docs/home/
Attaching...
Pin : 9265
Success
[SM-G965N::uk.rossmarks.fridalab]->
```
![](https://github.com/wjddnjs33/image/blob/main/FridaLab/7.png?raw=true)

자바스크립트를 이용해서 익스 코드를 위와 같이 작성해주었습니다. 찾은 pin 값을 `chall07()` 메서드의 인자로 바로 념겨주도록 만들었습니다.<br>

## <span style="color:#21C587"></span> Challenge 8

> FridaLab 여덟 번째 문제는 버튼의 이름을 "Confirm"으로 바꿔줘야 합니다.<br>

```java
public class MainActivity extends AppCompatActivity {
    (생략)
    public boolean chall08() {
        return ((String) ((Button) findViewById(R.id.check)).getText()).equals("Confirm");
    }
    (생략)
}
```
`chall08()` 메서드의 코드를 보면 `findViewById`를 이용해서 특정 값을 가져와서 버튼 객체로 만들어주고, `getText()` 메서드를 이용해서 문자열을 가져와 해당 값과 `Confirm`과 비교하는 것을 볼 수 있습니다.
여기서 `getText()` 메서드로 가져온 값이 `Confirm`이면 버튼이 `Confirm`으로 바뀔 거 같습니다.

```
public static final int check = 2131165231;
```
`R.id.check`의 값을 확인해보면 `2131165231`이라는 값을 가져와서 `findViewById()` 메서드의 인자로 넘겨주고 있습니다. 그럼 우린 `(Button) findViewById(R.id.check))`에다가 `setText()` 메서드를 이용해서 `Confirm`이라는 문자열을 넣어주면 `getText()` 메서드로 문자열을 가져 올 때, `Confirm`이라는 문자열을 가져와 비교를 할 것 입니다.

```javascript
setImmediate(function(){
	Java.perform(function(){
		const button = Java.use("android.widget.Button");
		const string = Java.use('java.lang.String');
		Java.choose("uk.rossmarks.fridalab.MainActivity", {
			onMatch:function(a){
				const checkid = a.findViewById(2131165231);
				const checkid_ = Java.cast(checkid, button);
				checkid_.setText(string.$new("Confirm"));
			},
			onComplete:function(){
				console.log("Success");
			}
		});
	});
});
```
``` py@py  ~/APP/FridaLab  frida -U -l chall08.js uk.rossmarks.fridalab
     ____
    / _  |   Frida 12.11.7 - A world-class dynamic instrumentation toolkit
   | (_| |
    > _  |   Commands:
   /_/ |_|       help      -> Displays the help system
   . . . .       object?   -> Display information about 'object'
   . . . .       exit/quit -> Exit
   . . . .
   . . . .   More info at https://www.frida.re/docs/home/

Error: android.view.ViewRootImpl$CalledFromWrongThreadException: Only the original thread that created a view hierarchy can touch its views.
    at frida/node_modules/frida-java-bridge/lib/env.js:126
    at frida/node_modules/frida-java-bridge/lib/class-factory.js:1079
    at /chall08.js:9
    at frida/node_modules/frida-java-bridge/lib/class-factory.js:332
    at frida/node_modules/frida-java-bridge/lib/class-factory.js:264
    at Qe (frida/node_modules/frida-java-bridge/lib/android.js:417)
[SM-G965N::uk.rossmarks.fridalab]-> q

Thank you for using Frida!
```
![](https://github.com/wjddnjs33/image/blob/main/FridaLab/8.png?raw=true)

자바스크립트를 이용해서 위와 같이 익스 코드를 작성해주었습니다. 일단 `Java.choose()`를 이용해 인스턴스를 가져와서 `check` 값을 가져오고, `Java.cast()`를 이용해서 check의 타입을 버튼으로 바꿔줍니다. 그리고 `setText()`를 이용해서 `Confirm`이라는 문자열을 넣어주는데 이때 전송할 때는 `String` 타입으로 전송해주어야 합니다. 이유는 `setText()` 메서드에서 호환되는 타입이 정해져있기 때문입니다.

---
